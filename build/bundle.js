var app=function(){"use strict";function e(){}function t(e,t){for(const r in t)e[r]=t[r];return e}function r(e){return e()}function i(){return Object.create(null)}function n(e){e.forEach(r)}function a(e){return"function"==typeof e}function o(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}function s(t,r,i){t.$$.on_destroy.push(function(t,...r){if(null==t)return e;const i=t.subscribe(...r);return i.unsubscribe?()=>i.unsubscribe():i}(r,i))}function l(e,t,r,i){if(e){const n=c(e,t,r,i);return e[0](n)}}function c(e,r,i,n){return e[1]&&n?t(i.ctx.slice(),e[1](n(r))):i.ctx}function u(e,t,r,i){if(e[2]&&i){const n=e[2](i(r));if(void 0===t.dirty)return n;if("object"==typeof n){const e=[],r=Math.max(t.dirty.length,n.length);for(let i=0;i<r;i+=1)e[i]=t.dirty[i]|n[i];return e}return t.dirty|n}return t.dirty}function h(e,t,r,i,n,a){if(n){const o=c(t,r,i,a);e.p(o,n)}}function p(e){if(e.ctx.length>32){const t=[],r=e.ctx.length/32;for(let e=0;e<r;e++)t[e]=-1;return t}return-1}const d="undefined"!=typeof window?window:"undefined"!=typeof globalThis?globalThis:global;function f(e,t){e.appendChild(t)}function m(e,t,r){e.insertBefore(t,r||null)}function g(e){e.parentNode&&e.parentNode.removeChild(e)}function y(e,t){for(let r=0;r<e.length;r+=1)e[r]&&e[r].d(t)}function _(e){return document.createElement(e)}function x(e){return document.createTextNode(e)}function v(){return x(" ")}function b(){return x("")}function w(e,t,r,i){return e.addEventListener(t,r,i),()=>e.removeEventListener(t,r,i)}function T(e,t,r){null==r?e.removeAttribute(t):e.getAttribute(t)!==r&&e.setAttribute(t,r)}function E(e,t){t=""+t,e.data!==t&&(e.data=t)}function S(e,t,r,i){null==r?e.style.removeProperty(t):e.style.setProperty(t,r,i?"important":"")}function A(e,t,r){e.classList[r?"add":"remove"](t)}let I;function k(e){I=e}function C(){if(!I)throw new Error("Function called outside component initialization");return I}function z(e){C().$$.on_mount.push(e)}function M(e){C().$$.on_destroy.push(e)}function P(){const e=C();return(t,r,{cancelable:i=!1}={})=>{const n=e.$$.callbacks[t];if(n){const a=function(e,t,{bubbles:r=!1,cancelable:i=!1}={}){const n=document.createEvent("CustomEvent");return n.initCustomEvent(e,r,i,t),n}(t,r,{cancelable:i});return n.slice().forEach((t=>{t.call(e,a)})),!a.defaultPrevented}return!0}}function D(e,t){return C().$$.context.set(e,t),t}function L(e){return C().$$.context.get(e)}const B=[],R=[];let F=[];const O=[],U=Promise.resolve();let V=!1;function $(e){F.push(e)}function N(e){O.push(e)}const j=new Set;let q=0;function G(){if(0!==q)return;const e=I;do{try{for(;q<B.length;){const e=B[q];q++,k(e),Z(e.$$)}}catch(e){throw B.length=0,q=0,e}for(k(null),B.length=0,q=0;R.length;)R.pop()();for(let e=0;e<F.length;e+=1){const t=F[e];j.has(t)||(j.add(t),t())}F.length=0}while(B.length);for(;O.length;)O.pop()();V=!1,j.clear(),k(e)}function Z(e){if(null!==e.fragment){e.update(),n(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach($)}}const X=new Set;let W;function H(){W={r:0,c:[],p:W}}function K(){W.r||n(W.c),W=W.p}function Y(e,t){e&&e.i&&(X.delete(e),e.i(t))}function J(e,t,r,i){if(e&&e.o){if(X.has(e))return;X.add(e),W.c.push((()=>{X.delete(e),i&&(r&&e.d(1),i())})),e.o(t)}else i&&i()}function Q(e,t,r){const i=e.$$.props[t];void 0!==i&&(e.$$.bound[i]=r,r(e.$$.ctx[i]))}function ee(e){e&&e.c()}function te(e,t,i,o){const{fragment:s,after_update:l}=e.$$;s&&s.m(t,i),o||$((()=>{const t=e.$$.on_mount.map(r).filter(a);e.$$.on_destroy?e.$$.on_destroy.push(...t):n(t),e.$$.on_mount=[]})),l.forEach($)}function re(e,t){const r=e.$$;null!==r.fragment&&(!function(e){const t=[],r=[];F.forEach((i=>-1===e.indexOf(i)?t.push(i):r.push(i))),r.forEach((e=>e())),F=t}(r.after_update),n(r.on_destroy),r.fragment&&r.fragment.d(t),r.on_destroy=r.fragment=null,r.ctx=[])}function ie(e,t){-1===e.$$.dirty[0]&&(B.push(e),V||(V=!0,U.then(G)),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function ne(t,r,a,o,s,l,c,u=[-1]){const h=I;k(t);const p=t.$$={fragment:null,ctx:[],props:l,update:e,not_equal:s,bound:i(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(r.context||(h?h.$$.context:[])),callbacks:i(),dirty:u,skip_bound:!1,root:r.target||h.$$.root};c&&c(p.root);let d=!1;if(p.ctx=a?a(t,r.props||{},((e,r,...i)=>{const n=i.length?i[0]:r;return p.ctx&&s(p.ctx[e],p.ctx[e]=n)&&(!p.skip_bound&&p.bound[e]&&p.bound[e](n),d&&ie(t,e)),r})):[],p.update(),d=!0,n(p.before_update),p.fragment=!!o&&o(p.ctx),r.target){if(r.hydrate){const e=function(e){return Array.from(e.childNodes)}(r.target);p.fragment&&p.fragment.l(e),e.forEach(g)}else p.fragment&&p.fragment.c();r.intro&&Y(t.$$.fragment),te(t,r.target,r.anchor,r.customElement),G()}k(h)}class ae{$destroy(){re(this,1),this.$destroy=e}$on(t,r){if(!a(r))return e;const i=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return i.push(r),()=>{const e=i.indexOf(r);-1!==e&&i.splice(e,1)}}$set(e){var t;this.$$set&&(t=e,0!==Object.keys(t).length)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function oe(e){var t={exports:{}};return e(t,t.exports),t.exports}var se=oe((function(e,t){e.exports=function(){var e,t,r;function i(i,n){if(e)if(t){var a="var sharedChunk = {}; ("+e+")(sharedChunk); ("+t+")(sharedChunk);",o={};e(o),r=n(o),"undefined"!=typeof window&&(r.workerUrl=window.URL.createObjectURL(new Blob([a],{type:"text/javascript"})))}else t=n;else e=n}return i(["exports"],(function(e){var t=r;function r(e,t,r,i){this.cx=3*e,this.bx=3*(r-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(i-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=t,this.p2x=r,this.p2y=i}function i(e,r,i,n){const a=new t(e,r,i,n);return function(e){return a.solve(e)}}r.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,t){if(void 0===t&&(t=1e-6),e<0)return 0;if(e>1)return 1;for(var r=e,i=0;i<8;i++){var n=this.sampleCurveX(r)-e;if(Math.abs(n)<t)return r;var a=this.sampleCurveDerivativeX(r);if(Math.abs(a)<1e-6)break;r-=n/a}var o=0,s=1;for(r=e,i=0;i<20&&(n=this.sampleCurveX(r),!(Math.abs(n-e)<t));i++)e>n?o=r:s=r,r=.5*(s-o)+o;return r},solve:function(e,t){return this.sampleCurveY(this.solveCurveX(e,t))}};const n=i(.25,.1,.25,1);function a(e,t,r){return Math.min(r,Math.max(t,e))}function o(e,t,r){const i=r-t,n=((e-t)%i+i)%i+t;return n===t?r:n}function s(e,...t){for(const r of t)for(const t in r)e[t]=r[t];return e}let l=1;function c(e,t){e.forEach((e=>{t[e]&&(t[e]=t[e].bind(t))}))}function u(e,t,r){const i={};for(const n in e)i[n]=t.call(r||this,e[n],n,e);return i}function h(e,t,r){const i={};for(const n in e)t.call(r||this,e[n],n,e)&&(i[n]=e[n]);return i}function p(e){return Array.isArray(e)?e.map(p):"object"==typeof e&&e?u(e,p):e}const d={};function f(e){d[e]||("undefined"!=typeof console&&console.warn(e),d[e]=!0)}function m(e,t,r){return(r.y-e.y)*(t.x-e.x)>(t.y-e.y)*(r.x-e.x)}function g(e){let t=0;for(let r,i,n=0,a=e.length,o=a-1;n<a;o=n++)r=e[n],i=e[o],t+=(i.x-r.x)*(r.y+i.y);return t}function y(){return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope}function _(e){const t={};if(e.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((e,r,i,n)=>{const a=i||n;return t[r]=!a||a.toLowerCase(),""})),t["max-age"]){const e=parseInt(t["max-age"],10);isNaN(e)?delete t["max-age"]:t["max-age"]=e}return t}let x,v,b=null;function w(e){if(null==b){const t=e.navigator?e.navigator.userAgent:null;b=!!e.safari||!(!t||!(/\b(iPad|iPhone|iPod)\b/.test(t)||t.match("Safari")&&!t.match("Chrome")))}return b}function T(e){return"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap}const E={now:"undefined"!=typeof performance&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),frame(e){const t=requestAnimationFrame(e);return{cancel:()=>cancelAnimationFrame(t)}},getImageData(e,t=0){const r=window.document.createElement("canvas"),i=r.getContext("2d");if(!i)throw new Error("failed to create canvas 2d context");return r.width=e.width,r.height=e.height,i.drawImage(e,0,0,e.width,e.height),i.getImageData(-t,-t,e.width+2*t,e.height+2*t)},resolveURL:e=>(x||(x=document.createElement("a")),x.href=e,x.href),hardwareConcurrency:"undefined"!=typeof navigator&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return!!matchMedia&&(null==v&&(v=matchMedia("(prefers-reduced-motion: reduce)")),v.matches)}};var S=A;function A(e,t){this.x=e,this.y=t}A.prototype={clone:function(){return new A(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},multByPoint:function(e){return this.clone()._multByPoint(e)},divByPoint:function(e){return this.clone()._divByPoint(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},rotateAround:function(e,t){return this.clone()._rotateAround(e,t)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var t=e.x-this.x,r=e.y-this.y;return t*t+r*r},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},_matMult:function(e){var t=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=t,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var t=Math.cos(e),r=Math.sin(e),i=r*this.x+t*this.y;return this.x=t*this.x-r*this.y,this.y=i,this},_rotateAround:function(e,t){var r=Math.cos(e),i=Math.sin(e),n=t.y+i*(this.x-t.x)+r*(this.y-t.y);return this.x=t.x+r*(this.x-t.x)-i*(this.y-t.y),this.y=n,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},A.convert=function(e){return e instanceof A?e:Array.isArray(e)?new A(e[0],e[1]):e};const I={MAX_PARALLEL_IMAGE_REQUESTS:16,REGISTERED_PROTOCOLS:{}},k="mapbox-tiles";let C,z,M=500,P=50;function D(){"undefined"==typeof caches||C||(C=caches.open(k))}let L=1/0;const B={supported:!1,testSupport:function(e){!O&&F&&(U?V(e):R=e)}};let R,F,O=!1,U=!1;function V(e){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t);try{if(e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,F),e.isContextLost())return;B.supported=!0}catch(e){}e.deleteTexture(t),O=!0}"undefined"!=typeof document&&(F=document.createElement("img"),F.onload=function(){R&&V(R),R=null,U=!0},F.onerror=function(){O=!0,R=null},F.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const $={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image"};"function"==typeof Object.freeze&&Object.freeze($);class N extends Error{constructor(e,t,r,i){super(`AJAXError: ${t} (${e}): ${r}`),this.status=e,this.statusText=t,this.url=r,this.body=i}}const j=y()?()=>self.worker&&self.worker.referrer:()=>("blob:"===window.location.protocol?window.parent:window).location.href;function q(e,t){const r=new AbortController,i=new Request(e.url,{method:e.method||"GET",body:e.body,credentials:e.credentials,headers:e.headers,referrer:j(),signal:r.signal});let n=!1,a=!1;return"json"===e.type&&i.headers.set("Accept","application/json"),((r,o,s)=>{if(a)return;const l=Date.now();fetch(i).then((r=>r.ok?((r,o,s)=>{("arrayBuffer"===e.type?r.arrayBuffer():"json"===e.type?r.json():r.text()).then((e=>{a||(o&&s&&function(e,t,r){if(D(),!C)return;const i={status:t.status,statusText:t.statusText,headers:new Headers};t.headers.forEach(((e,t)=>i.headers.set(t,e)));const n=_(t.headers.get("Cache-Control")||"");n["no-store"]||(n["max-age"]&&i.headers.set("Expires",new Date(r+1e3*n["max-age"]).toUTCString()),new Date(i.headers.get("Expires")).getTime()-r<42e4||function(e,t){if(void 0===z)try{new Response(new ReadableStream),z=!0}catch(e){z=!1}z?t(e.body):e.blob().then(t)}(t,(t=>{const r=new Response(t,i);D(),C&&C.then((t=>t.put(function(e){const t=e.indexOf("?");return t<0?e:e.slice(0,t)}(e.url),r))).catch((e=>f(e.message)))})))}(i,o,s),n=!0,t(null,e,r.headers.get("Cache-Control"),r.headers.get("Expires")))})).catch((e=>{a||t(new Error(e.message))}))})(r,null,l):r.blob().then((i=>t(new N(r.status,r.statusText,e.url,i)))))).catch((e=>{20!==e.code&&t(new Error(e.message))}))})(),{cancel:()=>{a=!0,n||r.abort()}}}const G=function(e,t){if(/:\/\//.test(e.url)&&!/^https?:|^file:/.test(e.url)){if(y()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",e,t);if(!y()){const r=e.url.substring(0,e.url.indexOf("://"));return(I.REGISTERED_PROTOCOLS[r]||q)(e,t)}}if(!(/^file:/.test(r=e.url)||/^file:/.test(j())&&!/^\w+:/.test(r))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return q(e,t);if(y()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",e,t,void 0,!0)}var r;return function(e,t){const r=new XMLHttpRequest;r.open(e.method||"GET",e.url,!0),"arrayBuffer"===e.type&&(r.responseType="arraybuffer");for(const t in e.headers)r.setRequestHeader(t,e.headers[t]);return"json"===e.type&&(r.responseType="text",r.setRequestHeader("Accept","application/json")),r.withCredentials="include"===e.credentials,r.onerror=()=>{t(new Error(r.statusText))},r.onload=()=>{if((r.status>=200&&r.status<300||0===r.status)&&null!==r.response){let i=r.response;if("json"===e.type)try{i=JSON.parse(r.response)}catch(e){return t(e)}t(null,i,r.getResponseHeader("Cache-Control"),r.getResponseHeader("Expires"))}else{const i=new Blob([r.response],{type:r.getResponseHeader("Content-Type")});t(new N(r.status,r.statusText,e.url,i))}},r.send(e.body),{cancel:()=>r.abort()}}(e,t)},Z=function(e,t){return G(s(e,{type:"arrayBuffer"}),t)};function X(e){const t=window.document.createElement("a");return t.href=e,t.protocol===window.document.location.protocol&&t.host===window.document.location.host}const W="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let H,K;H=[],K=0;const Y=function(e,t){if(B.supported&&(e.headers||(e.headers={}),e.headers.accept="image/webp,*/*"),K>=I.MAX_PARALLEL_IMAGE_REQUESTS){const r={requestParameters:e,callback:t,cancelled:!1,cancel(){this.cancelled=!0}};return H.push(r),r}K++;let r=!1;const i=()=>{if(!r)for(r=!0,K--;H.length&&K<I.MAX_PARALLEL_IMAGE_REQUESTS;){const e=H.shift(),{requestParameters:t,callback:r,cancelled:i}=e;i||(e.cancel=Y(t,r).cancel)}},n=Z(e,((e,r,n,a)=>{i(),e?t(e):r&&function(e,t){"function"==typeof createImageBitmap?function(e,t){const r=new Blob([new Uint8Array(e)],{type:"image/png"});createImageBitmap(r).then((e=>{t(null,e)})).catch((e=>{t(new Error(`Could not load image because of ${e.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))}))}(e,t):function(e,t){const r=new Image;r.onload=()=>{t(null,r),URL.revokeObjectURL(r.src),r.onload=null,window.requestAnimationFrame((()=>{r.src=W}))},r.onerror=()=>t(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const i=new Blob([new Uint8Array(e)],{type:"image/png"});r.src=e.byteLength?URL.createObjectURL(i):W}(e,t)}(r,((e,r)=>{null!=e?t(e):null!=r&&t(null,r,{cacheControl:n,expires:a})}))}));return{cancel:()=>{n.cancel(),i()}}};function J(e,t,r){r[e]&&-1!==r[e].indexOf(t)||(r[e]=r[e]||[],r[e].push(t))}function Q(e,t,r){if(r&&r[e]){const i=r[e].indexOf(t);-1!==i&&r[e].splice(i,1)}}class ee{constructor(e,t={}){s(this,t),this.type=e}}class te extends ee{constructor(e,t={}){super("error",s({error:e},t))}}class re{on(e,t){return this._listeners=this._listeners||{},J(e,t,this._listeners),this}off(e,t){return Q(e,t,this._listeners),Q(e,t,this._oneTimeListeners),this}once(e,t){return this._oneTimeListeners=this._oneTimeListeners||{},J(e,t,this._oneTimeListeners),this}fire(e,t){"string"==typeof e&&(e=new ee(e,t||{}));const r=e.type;if(this.listens(r)){e.target=this;const t=this._listeners&&this._listeners[r]?this._listeners[r].slice():[];for(const r of t)r.call(this,e);const i=this._oneTimeListeners&&this._oneTimeListeners[r]?this._oneTimeListeners[r].slice():[];for(const t of i)Q(r,t,this._oneTimeListeners),t.call(this,e);const n=this._eventedParent;n&&(s(e,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),n.fire(e))}else e instanceof te&&console.error(e.error);return this}listens(e){return this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e)}setEventedParent(e,t){return this._eventedParent=e,this._eventedParentData=t,this}}var ie={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},light:{type:"light"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"string"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{}},default:"mapbox"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{},within:{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1},elevationOffset:{type:"number",default:450}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"number",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"color",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};class ne{constructor(e,t,r,i){this.message=(e?`${e}: `:"")+r,i&&(this.identifier=i),null!=t&&t.__line__&&(this.line=t.__line__)}}function ae(e){const t=e.value;return t?[new ne(e.key,t,"constants have been deprecated as of v8")]:[]}function oe(e,...t){for(const r of t)for(const t in r)e[t]=r[t];return e}function se(e){return e instanceof Number||e instanceof String||e instanceof Boolean?e.valueOf():e}function le(e){if(Array.isArray(e))return e.map(le);if(e instanceof Object&&!(e instanceof Number||e instanceof String||e instanceof Boolean)){const t={};for(const r in e)t[r]=le(e[r]);return t}return se(e)}class ce extends Error{constructor(e,t){super(t),this.message=t,this.key=e}}class ue{constructor(e,t=[]){this.parent=e,this.bindings={};for(const[e,r]of t)this.bindings[e]=r}concat(e){return new ue(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const he={kind:"null"},pe={kind:"number"},de={kind:"string"},fe={kind:"boolean"},me={kind:"color"},ge={kind:"object"},ye={kind:"value"},_e={kind:"collator"},xe={kind:"formatted"},ve={kind:"padding"},be={kind:"resolvedImage"};function we(e,t){return{kind:"array",itemType:e,N:t}}function Te(e){if("array"===e.kind){const t=Te(e.itemType);return"number"==typeof e.N?`array<${t}, ${e.N}>`:"value"===e.itemType.kind?"array":`array<${t}>`}return e.kind}const Ee=[he,pe,de,fe,me,xe,ge,we(ye),ve,be];function Se(e,t){if("error"===t.kind)return null;if("array"===e.kind){if("array"===t.kind&&(0===t.N&&"value"===t.itemType.kind||!Se(e.itemType,t.itemType))&&("number"!=typeof e.N||e.N===t.N))return null}else{if(e.kind===t.kind)return null;if("value"===e.kind)for(const e of Ee)if(!Se(e,t))return null}return`Expected ${Te(e)} but found ${Te(t)} instead.`}function Ae(e,t){return t.some((t=>t.kind===e.kind))}function Ie(e,t){return t.some((t=>"null"===t?null===e:"array"===t?Array.isArray(e):"object"===t?e&&!Array.isArray(e)&&"object"==typeof e:t===typeof e))}var ke,Ce={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function ze(e){return(e=Math.round(e))<0?0:e>255?255:e}function Me(e){return ze("%"===e[e.length-1]?parseFloat(e)/100*255:parseInt(e))}function Pe(e){return(t="%"===e[e.length-1]?parseFloat(e)/100:parseFloat(e))<0?0:t>1?1:t;var t}function De(e,t,r){return r<0?r+=1:r>1&&(r-=1),6*r<1?e+(t-e)*r*6:2*r<1?t:3*r<2?e+(t-e)*(2/3-r)*6:e}try{ke={}.parseCSSColor=function(e){var t,r=e.replace(/ /g,"").toLowerCase();if(r in Ce)return Ce[r].slice();if("#"===r[0])return 4===r.length?(t=parseInt(r.substr(1),16))>=0&&t<=4095?[(3840&t)>>4|(3840&t)>>8,240&t|(240&t)>>4,15&t|(15&t)<<4,1]:null:7===r.length&&(t=parseInt(r.substr(1),16))>=0&&t<=16777215?[(16711680&t)>>16,(65280&t)>>8,255&t,1]:null;var i=r.indexOf("("),n=r.indexOf(")");if(-1!==i&&n+1===r.length){var a=r.substr(0,i),o=r.substr(i+1,n-(i+1)).split(","),s=1;switch(a){case"rgba":if(4!==o.length)return null;s=Pe(o.pop());case"rgb":return 3!==o.length?null:[Me(o[0]),Me(o[1]),Me(o[2]),s];case"hsla":if(4!==o.length)return null;s=Pe(o.pop());case"hsl":if(3!==o.length)return null;var l=(parseFloat(o[0])%360+360)%360/360,c=Pe(o[1]),u=Pe(o[2]),h=u<=.5?u*(c+1):u+c-u*c,p=2*u-h;return[ze(255*De(p,h,l+1/3)),ze(255*De(p,h,l)),ze(255*De(p,h,l-1/3)),s];default:return null}}return null}}catch(e){}class Le{constructor(e,t,r,i=1){this.r=e,this.g=t,this.b=r,this.a=i}static parse(e){if(!e)return;if(e instanceof Le)return e;if("string"!=typeof e)return;const t=ke(e);return t?new Le(t[0]/255*t[3],t[1]/255*t[3],t[2]/255*t[3],t[3]):void 0}toString(){const[e,t,r,i]=this.toArray();return`rgba(${Math.round(e)},${Math.round(t)},${Math.round(r)},${i})`}toArray(){const{r:e,g:t,b:r,a:i}=this;return 0===i?[0,0,0,0]:[255*e/i,255*t/i,255*r/i,i]}}Le.black=new Le(0,0,0,1),Le.white=new Le(1,1,1,1),Le.transparent=new Le(0,0,0,0),Le.red=new Le(1,0,0,1);class Be{constructor(e,t,r){this.sensitivity=e?t?"variant":"case":t?"accent":"base",this.locale=r,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,t){return this.collator.compare(e,t)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Re{constructor(e,t,r,i,n){this.text=e,this.image=t,this.scale=r,this.fontStack=i,this.textColor=n}}class Fe{constructor(e){this.sections=e}static fromString(e){return new Fe([new Re(e,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((e=>0!==e.text.length||e.image&&0!==e.image.name.length))}static factory(e){return e instanceof Fe?e:Fe.fromString(e)}toString(){return 0===this.sections.length?"":this.sections.map((e=>e.text)).join("")}}class Oe{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof Oe)return e;if("number"==typeof e)return new Oe([e,e,e,e]);if(Array.isArray(e)&&!(e.length<1||e.length>4)){for(const t of e)if("number"!=typeof t)return;switch(e.length){case 1:e=[e[0],e[0],e[0],e[0]];break;case 2:e=[e[0],e[1],e[0],e[1]];break;case 3:e=[e[0],e[1],e[2],e[1]]}return new Oe(e)}}toString(){return JSON.stringify(this.values)}}class Ue{constructor(e){this.name=e.name,this.available=e.available}toString(){return this.name}static fromString(e){return e?new Ue({name:e,available:!1}):null}}function Ve(e,t,r,i){return"number"==typeof e&&e>=0&&e<=255&&"number"==typeof t&&t>=0&&t<=255&&"number"==typeof r&&r>=0&&r<=255?void 0===i||"number"==typeof i&&i>=0&&i<=1?null:`Invalid rgba value [${[e,t,r,i].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof i?[e,t,r,i]:[e,t,r]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function $e(e){if(null===e)return!0;if("string"==typeof e)return!0;if("boolean"==typeof e)return!0;if("number"==typeof e)return!0;if(e instanceof Le)return!0;if(e instanceof Be)return!0;if(e instanceof Fe)return!0;if(e instanceof Oe)return!0;if(e instanceof Ue)return!0;if(Array.isArray(e)){for(const t of e)if(!$e(t))return!1;return!0}if("object"==typeof e){for(const t in e)if(!$e(e[t]))return!1;return!0}return!1}function Ne(e){if(null===e)return he;if("string"==typeof e)return de;if("boolean"==typeof e)return fe;if("number"==typeof e)return pe;if(e instanceof Le)return me;if(e instanceof Be)return _e;if(e instanceof Fe)return xe;if(e instanceof Oe)return ve;if(e instanceof Ue)return be;if(Array.isArray(e)){const t=e.length;let r;for(const t of e){const e=Ne(t);if(r){if(r===e)continue;r=ye;break}r=e}return we(r||ye,t)}return ge}function je(e){const t=typeof e;return null===e?"":"string"===t||"number"===t||"boolean"===t?String(e):e instanceof Le||e instanceof Fe||e instanceof Oe||e instanceof Ue?e.toString():JSON.stringify(e)}class qe{constructor(e,t){this.type=e,this.value=t}static parse(e,t){if(2!==e.length)return t.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!$e(e[1]))return t.error("invalid value");const r=e[1];let i=Ne(r);const n=t.expectedType;return"array"!==i.kind||0!==i.N||!n||"array"!==n.kind||"number"==typeof n.N&&0!==n.N||(i=n),new qe(i,r)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}class Ge{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const Ze={string:de,number:pe,boolean:fe,object:ge};class Xe{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");let r,i=1;const n=e[0];if("array"===n){let n,a;if(e.length>2){const r=e[1];if("string"!=typeof r||!(r in Ze)||"object"===r)return t.error('The item type argument of "array" must be one of string, number, boolean',1);n=Ze[r],i++}else n=ye;if(e.length>3){if(null!==e[2]&&("number"!=typeof e[2]||e[2]<0||e[2]!==Math.floor(e[2])))return t.error('The length argument to "array" must be a positive integer literal',2);a=e[2],i++}r=we(n,a)}else{if(!Ze[n])throw new Error(`Types doesn't contain name = ${n}`);r=Ze[n]}const a=[];for(;i<e.length;i++){const r=t.parse(e[i],i,ye);if(!r)return null;a.push(r)}return new Xe(r,a)}evaluate(e){for(let t=0;t<this.args.length;t++){const r=this.args[t].evaluate(e);if(!Se(this.type,Ne(r)))return r;if(t===this.args.length-1)throw new Ge(`Expected value to be of type ${Te(this.type)}, but found ${Te(Ne(r))} instead.`)}throw new Error}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}}const We={"to-boolean":fe,"to-color":me,"to-number":pe,"to-string":de};class He{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const r=e[0];if(!We[r])throw new Error(`Can't parse ${r} as it is not part of the known types`);if(("to-boolean"===r||"to-string"===r)&&2!==e.length)return t.error("Expected one argument.");const i=We[r],n=[];for(let r=1;r<e.length;r++){const i=t.parse(e[r],r,ye);if(!i)return null;n.push(i)}return new He(i,n)}evaluate(e){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(e));if("color"===this.type.kind){let t,r;for(const i of this.args){if(t=i.evaluate(e),r=null,t instanceof Le)return t;if("string"==typeof t){const r=e.parseColor(t);if(r)return r}else if(Array.isArray(t)&&(r=t.length<3||t.length>4?`Invalid rbga value ${JSON.stringify(t)}: expected an array containing either three or four numeric values.`:Ve(t[0],t[1],t[2],t[3]),!r))return new Le(t[0]/255,t[1]/255,t[2]/255,t[3])}throw new Ge(r||`Could not parse color from value '${"string"==typeof t?t:JSON.stringify(t)}'`)}if("padding"===this.type.kind){let t;for(const r of this.args){t=r.evaluate(e);const i=Oe.parse(t);if(i)return i}throw new Ge(`Could not parse padding from value '${"string"==typeof t?t:JSON.stringify(t)}'`)}if("number"===this.type.kind){let t=null;for(const r of this.args){if(t=r.evaluate(e),null===t)return 0;const i=Number(t);if(!isNaN(i))return i}throw new Ge(`Could not convert ${JSON.stringify(t)} to number.`)}return"formatted"===this.type.kind?Fe.fromString(je(this.args[0].evaluate(e))):"resolvedImage"===this.type.kind?Ue.fromString(je(this.args[0].evaluate(e))):je(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}}const Ke=["Unknown","Point","LineString","Polygon"];class Ye{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?Ke[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(e){let t=this._parseColorCache[e];return t||(t=this._parseColorCache[e]=Le.parse(e)),t}}class Je{constructor(e,t,r,i){this.name=e,this.type=t,this._evaluate=r,this.args=i}evaluate(e){return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}static parse(e,t){const r=e[0],i=Je.definitions[r];if(!i)return t.error(`Unknown expression "${r}". If you wanted a literal array, use ["literal", [...]].`,0);const n=Array.isArray(i)?i[0]:i.type,a=Array.isArray(i)?[[i[1],i[2]]]:i.overloads,o=a.filter((([t])=>!Array.isArray(t)||t.length===e.length-1));let s=null;for(const[i,a]of o){s=new bt(t.registry,t.path,null,t.scope);const o=[];let l=!1;for(let t=1;t<e.length;t++){const r=e[t],n=Array.isArray(i)?i[t-1]:i.type,a=s.parse(r,1+o.length,n);if(!a){l=!0;break}o.push(a)}if(!l)if(Array.isArray(i)&&i.length!==o.length)s.error(`Expected ${i.length} arguments, but found ${o.length} instead.`);else{for(let e=0;e<o.length;e++){const t=Array.isArray(i)?i[e]:i.type,r=o[e];s.concat(e+1).checkSubtype(t,r.type)}if(0===s.errors.length)return new Je(r,n,a,o)}}if(1===o.length)t.errors.push(...s.errors);else{const r=(o.length?o:a).map((([e])=>{return t=e,Array.isArray(t)?`(${t.map(Te).join(", ")})`:`(${Te(t.type)}...)`;var t})).join(" | "),i=[];for(let r=1;r<e.length;r++){const n=t.parse(e[r],1+i.length);if(!n)return null;i.push(Te(n.type))}t.error(`Expected arguments of type ${r}, but found (${i.join(", ")}) instead.`)}return null}static register(e,t){Je.definitions=t;for(const r in t)e[r]=Je}}class Qe{constructor(e,t,r){this.type=_e,this.locale=r,this.caseSensitive=e,this.diacriticSensitive=t}static parse(e,t){if(2!==e.length)return t.error("Expected one argument.");const r=e[1];if("object"!=typeof r||Array.isArray(r))return t.error("Collator options argument must be an object.");const i=t.parse(void 0!==r["case-sensitive"]&&r["case-sensitive"],1,fe);if(!i)return null;const n=t.parse(void 0!==r["diacritic-sensitive"]&&r["diacritic-sensitive"],1,fe);if(!n)return null;let a=null;return r.locale&&(a=t.parse(r.locale,1,de),!a)?null:new Qe(i,n,a)}evaluate(e){return new Be(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}}const et=8192;function tt(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[0]),e[3]=Math.max(e[3],t[1])}function rt(e,t){return!(e[0]<=t[0]||e[2]>=t[2]||e[1]<=t[1]||e[3]>=t[3])}function it(e,t){const r=(180+e[0])/360,i=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e[1]*Math.PI/360)))/360,n=Math.pow(2,t.z);return[Math.round(r*n*et),Math.round(i*n*et)]}function nt(e,t,r){const i=e[0]-t[0],n=e[1]-t[1],a=e[0]-r[0],o=e[1]-r[1];return i*o-a*n==0&&i*a<=0&&n*o<=0}function at(e,t){let r=!1;for(let o=0,s=t.length;o<s;o++){const s=t[o];for(let t=0,o=s.length;t<o-1;t++){if(nt(e,s[t],s[t+1]))return!1;(n=s[t])[1]>(i=e)[1]!=(a=s[t+1])[1]>i[1]&&i[0]<(a[0]-n[0])*(i[1]-n[1])/(a[1]-n[1])+n[0]&&(r=!r)}}var i,n,a;return r}function ot(e,t){for(let r=0;r<t.length;r++)if(at(e,t[r]))return!0;return!1}function st(e,t,r,i){const n=i[0]-r[0],a=i[1]-r[1],o=(e[0]-r[0])*a-n*(e[1]-r[1]),s=(t[0]-r[0])*a-n*(t[1]-r[1]);return o>0&&s<0||o<0&&s>0}function lt(e,t,r){for(const c of r)for(let r=0;r<c.length-1;++r)if(0!=(s=[(o=c[r+1])[0]-(a=c[r])[0],o[1]-a[1]])[0]*(l=[(n=t)[0]-(i=e)[0],n[1]-i[1]])[1]-s[1]*l[0]&&st(i,n,a,o)&&st(a,o,i,n))return!0;var i,n,a,o,s,l;return!1}function ct(e,t){for(let r=0;r<e.length;++r)if(!at(e[r],t))return!1;for(let r=0;r<e.length-1;++r)if(lt(e[r],e[r+1],t))return!1;return!0}function ut(e,t){for(let r=0;r<t.length;r++)if(ct(e,t[r]))return!0;return!1}function ht(e,t,r){const i=[];for(let n=0;n<e.length;n++){const a=[];for(let i=0;i<e[n].length;i++){const o=it(e[n][i],r);tt(t,o),a.push(o)}i.push(a)}return i}function pt(e,t,r){const i=[];for(let n=0;n<e.length;n++){const a=ht(e[n],t,r);i.push(a)}return i}function dt(e,t,r,i){if(e[0]<r[0]||e[0]>r[2]){const t=.5*i;let n=e[0]-r[0]>t?-i:r[0]-e[0]>t?i:0;0===n&&(n=e[0]-r[2]>t?-i:r[2]-e[0]>t?i:0),e[0]+=n}tt(t,e)}function ft(e,t,r,i){const n=Math.pow(2,i.z)*et,a=[i.x*et,i.y*et],o=[];for(const i of e)for(const e of i){const i=[e.x+a[0],e.y+a[1]];dt(i,t,r,n),o.push(i)}return o}function mt(e,t,r,i){const n=Math.pow(2,i.z)*et,a=[i.x*et,i.y*et],o=[];for(const r of e){const e=[];for(const i of r){const r=[i.x+a[0],i.y+a[1]];tt(t,r),e.push(r)}o.push(e)}if(t[2]-t[0]<=n/2){(s=t)[0]=s[1]=1/0,s[2]=s[3]=-1/0;for(const e of o)for(const i of e)dt(i,t,r,n)}var s;return o}class gt{constructor(e,t){this.type=fe,this.geojson=e,this.geometries=t}static parse(e,t){if(2!==e.length)return t.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if($e(e[1])){const t=e[1];if("FeatureCollection"===t.type)for(let e=0;e<t.features.length;++e){const r=t.features[e].geometry.type;if("Polygon"===r||"MultiPolygon"===r)return new gt(t,t.features[e].geometry)}else if("Feature"===t.type){const e=t.geometry.type;if("Polygon"===e||"MultiPolygon"===e)return new gt(t,t.geometry)}else if("Polygon"===t.type||"MultiPolygon"===t.type)return new gt(t,t)}return t.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(null!=e.geometry()&&null!=e.canonicalID()){if("Point"===e.geometryType())return function(e,t){const r=[1/0,1/0,-1/0,-1/0],i=[1/0,1/0,-1/0,-1/0],n=e.canonicalID();if("Polygon"===t.type){const a=ht(t.coordinates,i,n),o=ft(e.geometry(),r,i,n);if(!rt(r,i))return!1;for(const e of o)if(!at(e,a))return!1}if("MultiPolygon"===t.type){const a=pt(t.coordinates,i,n),o=ft(e.geometry(),r,i,n);if(!rt(r,i))return!1;for(const e of o)if(!ot(e,a))return!1}return!0}(e,this.geometries);if("LineString"===e.geometryType())return function(e,t){const r=[1/0,1/0,-1/0,-1/0],i=[1/0,1/0,-1/0,-1/0],n=e.canonicalID();if("Polygon"===t.type){const a=ht(t.coordinates,i,n),o=mt(e.geometry(),r,i,n);if(!rt(r,i))return!1;for(const e of o)if(!ct(e,a))return!1}if("MultiPolygon"===t.type){const a=pt(t.coordinates,i,n),o=mt(e.geometry(),r,i,n);if(!rt(r,i))return!1;for(const e of o)if(!ut(e,a))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}function yt(e){if(e instanceof Je){if("get"===e.name&&1===e.args.length)return!1;if("feature-state"===e.name)return!1;if("has"===e.name&&1===e.args.length)return!1;if("properties"===e.name||"geometry-type"===e.name||"id"===e.name)return!1;if(/^filter-/.test(e.name))return!1}if(e instanceof gt)return!1;let t=!0;return e.eachChild((e=>{t&&!yt(e)&&(t=!1)})),t}function _t(e){if(e instanceof Je&&"feature-state"===e.name)return!1;let t=!0;return e.eachChild((e=>{t&&!_t(e)&&(t=!1)})),t}function xt(e,t){if(e instanceof Je&&t.indexOf(e.name)>=0)return!1;let r=!0;return e.eachChild((e=>{r&&!xt(e,t)&&(r=!1)})),r}class vt{constructor(e,t){this.type=t.type,this.name=e,this.boundExpression=t}static parse(e,t){if(2!==e.length||"string"!=typeof e[1])return t.error("'var' expression requires exactly one string literal argument.");const r=e[1];return t.scope.has(r)?new vt(r,t.scope.get(r)):t.error(`Unknown variable "${r}". Make sure "${r}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}}class bt{constructor(e,t=[],r,i=new ue,n=[]){this.registry=e,this.path=t,this.key=t.map((e=>`[${e}]`)).join(""),this.scope=i,this.errors=n,this.expectedType=r}parse(e,t,r,i,n={}){return t?this.concat(t,r,i)._parse(e,n):this._parse(e,n)}_parse(e,t){function r(e,t,r){return"assert"===r?new Xe(t,[e]):"coerce"===r?new He(t,[e]):e}if(null!==e&&"string"!=typeof e&&"boolean"!=typeof e&&"number"!=typeof e||(e=["literal",e]),Array.isArray(e)){if(0===e.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const i=e[0];if("string"!=typeof i)return this.error(`Expression name must be a string, but found ${typeof i} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const n=this.registry[i];if(n){let i=n.parse(e,this);if(!i)return null;if(this.expectedType){const e=this.expectedType,n=i.type;if("string"!==e.kind&&"number"!==e.kind&&"boolean"!==e.kind&&"object"!==e.kind&&"array"!==e.kind||"value"!==n.kind)if("color"!==e.kind&&"formatted"!==e.kind&&"resolvedImage"!==e.kind||"value"!==n.kind&&"string"!==n.kind)if("padding"!==e.kind||"value"!==n.kind&&"number"!==n.kind&&"array"!==n.kind){if(this.checkSubtype(e,n))return null}else i=r(i,e,t.typeAnnotation||"coerce");else i=r(i,e,t.typeAnnotation||"coerce");else i=r(i,e,t.typeAnnotation||"assert")}if(!(i instanceof qe)&&"resolvedImage"!==i.type.kind&&wt(i)){const t=new Ye;try{i=new qe(i.type,i.evaluate(t))}catch(e){return this.error(e.message),null}}return i}return this.error(`Unknown expression "${i}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(void 0===e?"'undefined' value invalid. Use null instead.":"object"==typeof e?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,t,r){const i="number"==typeof e?this.path.concat(e):this.path,n=r?this.scope.concat(r):this.scope;return new bt(this.registry,i,t||null,n,this.errors)}error(e,...t){const r=`${this.key}${t.map((e=>`[${e}]`)).join("")}`;this.errors.push(new ce(r,e))}checkSubtype(e,t){const r=Se(e,t);return r&&this.error(r),r}}function wt(e){if(e instanceof vt)return wt(e.boundExpression);if(e instanceof Je&&"error"===e.name)return!1;if(e instanceof Qe)return!1;if(e instanceof gt)return!1;const t=e instanceof He||e instanceof Xe;let r=!0;return e.eachChild((e=>{r=t?r&&wt(e):r&&e instanceof qe})),!!r&&yt(e)&&xt(e,["zoom","heatmap-density","line-progress","accumulated","is-supported-script"])}function Tt(e,t){const r=e.length-1;let i,n,a=0,o=r,s=0;for(;a<=o;)if(s=Math.floor((a+o)/2),i=e[s],n=e[s+1],i<=t){if(s===r||t<n)return s;a=s+1}else{if(!(i>t))throw new Ge("Input is not a number.");o=s-1}return 0}class Et{constructor(e,t,r){this.type=e,this.input=t,this.labels=[],this.outputs=[];for(const[e,t]of r)this.labels.push(e),this.outputs.push(t)}static parse(e,t){if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return t.error("Expected an even number of arguments.");const r=t.parse(e[1],1,pe);if(!r)return null;const i=[];let n=null;t.expectedType&&"value"!==t.expectedType.kind&&(n=t.expectedType);for(let r=1;r<e.length;r+=2){const a=1===r?-1/0:e[r],o=e[r+1],s=r,l=r+1;if("number"!=typeof a)return t.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',s);if(i.length&&i[i.length-1][0]>=a)return t.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',s);const c=t.parse(o,l,n);if(!c)return null;n=n||c.type,i.push([a,c])}return new Et(n,r,i)}evaluate(e){const t=this.labels,r=this.outputs;if(1===t.length)return r[0].evaluate(e);const i=this.input.evaluate(e);if(i<=t[0])return r[0].evaluate(e);const n=t.length;return i>=t[n-1]?r[n-1].evaluate(e):r[Tt(t,i)].evaluate(e)}eachChild(e){e(this.input);for(const t of this.outputs)e(t)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}}function St(e,t,r){return e*(1-r)+t*r}var At=Object.freeze({__proto__:null,number:St,color:function(e,t,r){return new Le(St(e.r,t.r,r),St(e.g,t.g,r),St(e.b,t.b,r),St(e.a,t.a,r))},array:function(e,t,r){return e.map(((e,i)=>St(e,t[i],r)))},padding:function(e,t,r){const i=e.values,n=t.values;return new Oe([St(i[0],n[0],r),St(i[1],n[1],r),St(i[2],n[2],r),St(i[3],n[3],r)])}});const It=.95047,kt=1.08883,Ct=4/29,zt=6/29,Mt=3*zt*zt,Pt=Math.PI/180,Dt=180/Math.PI;function Lt(e){return e>.008856451679035631?Math.pow(e,1/3):e/Mt+Ct}function Bt(e){return e>zt?e*e*e:Mt*(e-Ct)}function Rt(e){return 255*(e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055)}function Ft(e){return(e/=255)<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function Ot(e){const t=Ft(e.r),r=Ft(e.g),i=Ft(e.b),n=Lt((.4124564*t+.3575761*r+.1804375*i)/It),a=Lt((.2126729*t+.7151522*r+.072175*i)/1);return{l:116*a-16,a:500*(n-a),b:200*(a-Lt((.0193339*t+.119192*r+.9503041*i)/kt)),alpha:e.a}}function Ut(e){let t=(e.l+16)/116,r=isNaN(e.a)?t:t+e.a/500,i=isNaN(e.b)?t:t-e.b/200;return t=1*Bt(t),r=It*Bt(r),i=kt*Bt(i),new Le(Rt(3.2404542*r-1.5371385*t-.4985314*i),Rt(-.969266*r+1.8760108*t+.041556*i),Rt(.0556434*r-.2040259*t+1.0572252*i),e.alpha)}function Vt(e,t,r){const i=t-e;return e+r*(i>180||i<-180?i-360*Math.round(i/360):i)}const $t={forward:Ot,reverse:Ut,interpolate:function(e,t,r){return{l:St(e.l,t.l,r),a:St(e.a,t.a,r),b:St(e.b,t.b,r),alpha:St(e.alpha,t.alpha,r)}}},Nt={forward:function(e){const{l:t,a:r,b:i}=Ot(e),n=Math.atan2(i,r)*Dt;return{h:n<0?n+360:n,c:Math.sqrt(r*r+i*i),l:t,alpha:e.a}},reverse:function(e){const t=e.h*Pt,r=e.c;return Ut({l:e.l,a:Math.cos(t)*r,b:Math.sin(t)*r,alpha:e.alpha})},interpolate:function(e,t,r){return{h:Vt(e.h,t.h,r),c:St(e.c,t.c,r),l:St(e.l,t.l,r),alpha:St(e.alpha,t.alpha,r)}}};var jt=Object.freeze({__proto__:null,lab:$t,hcl:Nt});class qt{constructor(e,t,r,i,n){this.type=e,this.operator=t,this.interpolation=r,this.input=i,this.labels=[],this.outputs=[];for(const[e,t]of n)this.labels.push(e),this.outputs.push(t)}static interpolationFactor(e,r,i,n){let a=0;if("exponential"===e.name)a=Gt(r,e.base,i,n);else if("linear"===e.name)a=Gt(r,1,i,n);else if("cubic-bezier"===e.name){const o=e.controlPoints;a=new t(o[0],o[1],o[2],o[3]).solve(Gt(r,1,i,n))}return a}static parse(e,t){let[r,i,n,...a]=e;if(!Array.isArray(i)||0===i.length)return t.error("Expected an interpolation type expression.",1);if("linear"===i[0])i={name:"linear"};else if("exponential"===i[0]){const e=i[1];if("number"!=typeof e)return t.error("Exponential interpolation requires a numeric base.",1,1);i={name:"exponential",base:e}}else{if("cubic-bezier"!==i[0])return t.error(`Unknown interpolation type ${String(i[0])}`,1,0);{const e=i.slice(1);if(4!==e.length||e.some((e=>"number"!=typeof e||e<0||e>1)))return t.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);i={name:"cubic-bezier",controlPoints:e}}}if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return t.error("Expected an even number of arguments.");if(n=t.parse(n,2,pe),!n)return null;const o=[];let s=null;"interpolate-hcl"===r||"interpolate-lab"===r?s=me:t.expectedType&&"value"!==t.expectedType.kind&&(s=t.expectedType);for(let e=0;e<a.length;e+=2){const r=a[e],i=a[e+1],n=e+3,l=e+4;if("number"!=typeof r)return t.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',n);if(o.length&&o[o.length-1][0]>=r)return t.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',n);const c=t.parse(i,l,s);if(!c)return null;s=s||c.type,o.push([r,c])}return"number"===s.kind||"color"===s.kind||"padding"===s.kind||"array"===s.kind&&"number"===s.itemType.kind&&"number"==typeof s.N?new qt(s,r,i,n,o):t.error(`Type ${Te(s)} is not interpolatable.`)}evaluate(e){const t=this.labels,r=this.outputs;if(1===t.length)return r[0].evaluate(e);const i=this.input.evaluate(e);if(i<=t[0])return r[0].evaluate(e);const n=t.length;if(i>=t[n-1])return r[n-1].evaluate(e);const a=Tt(t,i),o=qt.interpolationFactor(this.interpolation,i,t[a],t[a+1]),s=r[a].evaluate(e),l=r[a+1].evaluate(e);return"interpolate"===this.operator?At[this.type.kind.toLowerCase()](s,l,o):"interpolate-hcl"===this.operator?Nt.reverse(Nt.interpolate(Nt.forward(s),Nt.forward(l),o)):$t.reverse($t.interpolate($t.forward(s),$t.forward(l),o))}eachChild(e){e(this.input);for(const t of this.outputs)e(t)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}}function Gt(e,t,r,i){const n=i-r,a=e-r;return 0===n?0:1===t?a/n:(Math.pow(t,a)-1)/(Math.pow(t,n)-1)}class Zt{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expectected at least one argument.");let r=null;const i=t.expectedType;i&&"value"!==i.kind&&(r=i);const n=[];for(const i of e.slice(1)){const e=t.parse(i,1+n.length,r,void 0,{typeAnnotation:"omit"});if(!e)return null;r=r||e.type,n.push(e)}if(!r)throw new Error("No output type");const a=i&&n.some((e=>Se(i,e.type)));return new Zt(a?ye:r,n)}evaluate(e){let t,r=null,i=0;for(const n of this.args)if(i++,r=n.evaluate(e),r&&r instanceof Ue&&!r.available&&(t||(t=r.name),r=null,i===this.args.length&&(r=t)),null!==r)break;return r}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}}class Xt{constructor(e,t){this.type=t.type,this.bindings=[].concat(e),this.result=t}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const t of this.bindings)e(t[1]);e(this.result)}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const r=[];for(let i=1;i<e.length-1;i+=2){const n=e[i];if("string"!=typeof n)return t.error(`Expected string, but found ${typeof n} instead.`,i);if(/[^a-zA-Z0-9_]/.test(n))return t.error("Variable names must contain only alphanumeric characters or '_'.",i);const a=t.parse(e[i+1],i+1);if(!a)return null;r.push([n,a])}const i=t.parse(e[e.length-1],e.length-1,t.expectedType,r);return i?new Xt(r,i):null}outputDefined(){return this.result.outputDefined()}}class Wt{constructor(e,t,r){this.type=e,this.index=t,this.input=r}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const r=t.parse(e[1],1,pe),i=t.parse(e[2],2,we(t.expectedType||ye));return r&&i?new Wt(i.type.itemType,r,i):null}evaluate(e){const t=this.index.evaluate(e),r=this.input.evaluate(e);if(t<0)throw new Ge(`Array index out of bounds: ${t} < 0.`);if(t>=r.length)throw new Ge(`Array index out of bounds: ${t} > ${r.length-1}.`);if(t!==Math.floor(t))throw new Ge(`Array index must be an integer, but found ${t} instead.`);return r[t]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}}class Ht{constructor(e,t){this.type=fe,this.needle=e,this.haystack=t}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const r=t.parse(e[1],1,ye),i=t.parse(e[2],2,ye);return r&&i?Ae(r.type,[fe,de,pe,he,ye])?new Ht(r,i):t.error(`Expected first argument to be of type boolean, string, number or null, but found ${Te(r.type)} instead`):null}evaluate(e){const t=this.needle.evaluate(e),r=this.haystack.evaluate(e);if(!r)return!1;if(!Ie(t,["boolean","string","number","null"]))throw new Ge(`Expected first argument to be of type boolean, string, number or null, but found ${Te(Ne(t))} instead.`);if(!Ie(r,["string","array"]))throw new Ge(`Expected second argument to be of type array or string, but found ${Te(Ne(r))} instead.`);return r.indexOf(t)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}}class Kt{constructor(e,t,r){this.type=pe,this.needle=e,this.haystack=t,this.fromIndex=r}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const r=t.parse(e[1],1,ye),i=t.parse(e[2],2,ye);if(!r||!i)return null;if(!Ae(r.type,[fe,de,pe,he,ye]))return t.error(`Expected first argument to be of type boolean, string, number or null, but found ${Te(r.type)} instead`);if(4===e.length){const n=t.parse(e[3],3,pe);return n?new Kt(r,i,n):null}return new Kt(r,i)}evaluate(e){const t=this.needle.evaluate(e),r=this.haystack.evaluate(e);if(!Ie(t,["boolean","string","number","null"]))throw new Ge(`Expected first argument to be of type boolean, string, number or null, but found ${Te(Ne(t))} instead.`);if(!Ie(r,["string","array"]))throw new Ge(`Expected second argument to be of type array or string, but found ${Te(Ne(r))} instead.`);if(this.fromIndex){const i=this.fromIndex.evaluate(e);return r.indexOf(t,i)}return r.indexOf(t)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}}class Yt{constructor(e,t,r,i,n,a){this.inputType=e,this.type=t,this.input=r,this.cases=i,this.outputs=n,this.otherwise=a}static parse(e,t){if(e.length<5)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return t.error("Expected an even number of arguments.");let r,i;t.expectedType&&"value"!==t.expectedType.kind&&(i=t.expectedType);const n={},a=[];for(let o=2;o<e.length-1;o+=2){let s=e[o];const l=e[o+1];Array.isArray(s)||(s=[s]);const c=t.concat(o);if(0===s.length)return c.error("Expected at least one branch label.");for(const e of s){if("number"!=typeof e&&"string"!=typeof e)return c.error("Branch labels must be numbers or strings.");if("number"==typeof e&&Math.abs(e)>Number.MAX_SAFE_INTEGER)return c.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof e&&Math.floor(e)!==e)return c.error("Numeric branch labels must be integer values.");if(r){if(c.checkSubtype(r,Ne(e)))return null}else r=Ne(e);if(void 0!==n[String(e)])return c.error("Branch labels must be unique.");n[String(e)]=a.length}const u=t.parse(l,o,i);if(!u)return null;i=i||u.type,a.push(u)}const o=t.parse(e[1],1,ye);if(!o)return null;const s=t.parse(e[e.length-1],e.length-1,i);return s?"value"!==o.type.kind&&t.concat(1).checkSubtype(r,o.type)?null:new Yt(r,i,o,n,a,s):null}evaluate(e){const t=this.input.evaluate(e);return(Ne(t)===this.inputType&&this.outputs[this.cases[t]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))&&this.otherwise.outputDefined()}}class Jt{constructor(e,t,r){this.type=e,this.branches=t,this.otherwise=r}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return t.error("Expected an odd number of arguments.");let r;t.expectedType&&"value"!==t.expectedType.kind&&(r=t.expectedType);const i=[];for(let n=1;n<e.length-1;n+=2){const a=t.parse(e[n],n,fe);if(!a)return null;const o=t.parse(e[n+1],n+1,r);if(!o)return null;i.push([a,o]),r=r||o.type}const n=t.parse(e[e.length-1],e.length-1,r);if(!n)return null;if(!r)throw new Error("Can't infer output type");return new Jt(r,i,n)}evaluate(e){for(const[t,r]of this.branches)if(t.evaluate(e))return r.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[t,r]of this.branches)e(t),e(r);e(this.otherwise)}outputDefined(){return this.branches.every((([e,t])=>t.outputDefined()))&&this.otherwise.outputDefined()}}class Qt{constructor(e,t,r,i){this.type=e,this.input=t,this.beginIndex=r,this.endIndex=i}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const r=t.parse(e[1],1,ye),i=t.parse(e[2],2,pe);if(!r||!i)return null;if(!Ae(r.type,[we(ye),de,ye]))return t.error(`Expected first argument to be of type array or string, but found ${Te(r.type)} instead`);if(4===e.length){const n=t.parse(e[3],3,pe);return n?new Qt(r.type,r,i,n):null}return new Qt(r.type,r,i)}evaluate(e){const t=this.input.evaluate(e),r=this.beginIndex.evaluate(e);if(!Ie(t,["string","array"]))throw new Ge(`Expected first argument to be of type array or string, but found ${Te(Ne(t))} instead.`);if(this.endIndex){const i=this.endIndex.evaluate(e);return t.slice(r,i)}return t.slice(r)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}}function er(e,t){return"=="===e||"!="===e?"boolean"===t.kind||"string"===t.kind||"number"===t.kind||"null"===t.kind||"value"===t.kind:"string"===t.kind||"number"===t.kind||"value"===t.kind}function tr(e,t,r,i){return 0===i.compare(t,r)}function rr(e,t,r){const i="=="!==e&&"!="!==e;return class n{constructor(e,t,r){this.type=fe,this.lhs=e,this.rhs=t,this.collator=r,this.hasUntypedArgument="value"===e.type.kind||"value"===t.type.kind}static parse(e,t){if(3!==e.length&&4!==e.length)return t.error("Expected two or three arguments.");const r=e[0];let a=t.parse(e[1],1,ye);if(!a)return null;if(!er(r,a.type))return t.concat(1).error(`"${r}" comparisons are not supported for type '${Te(a.type)}'.`);let o=t.parse(e[2],2,ye);if(!o)return null;if(!er(r,o.type))return t.concat(2).error(`"${r}" comparisons are not supported for type '${Te(o.type)}'.`);if(a.type.kind!==o.type.kind&&"value"!==a.type.kind&&"value"!==o.type.kind)return t.error(`Cannot compare types '${Te(a.type)}' and '${Te(o.type)}'.`);i&&("value"===a.type.kind&&"value"!==o.type.kind?a=new Xe(o.type,[a]):"value"!==a.type.kind&&"value"===o.type.kind&&(o=new Xe(a.type,[o])));let s=null;if(4===e.length){if("string"!==a.type.kind&&"string"!==o.type.kind&&"value"!==a.type.kind&&"value"!==o.type.kind)return t.error("Cannot use collator to compare non-string types.");if(s=t.parse(e[3],3,_e),!s)return null}return new n(a,o,s)}evaluate(n){const a=this.lhs.evaluate(n),o=this.rhs.evaluate(n);if(i&&this.hasUntypedArgument){const t=Ne(a),r=Ne(o);if(t.kind!==r.kind||"string"!==t.kind&&"number"!==t.kind)throw new Ge(`Expected arguments for "${e}" to be (string, string) or (number, number), but found (${t.kind}, ${r.kind}) instead.`)}if(this.collator&&!i&&this.hasUntypedArgument){const e=Ne(a),r=Ne(o);if("string"!==e.kind||"string"!==r.kind)return t(n,a,o)}return this.collator?r(n,a,o,this.collator.evaluate(n)):t(n,a,o)}eachChild(e){e(this.lhs),e(this.rhs),this.collator&&e(this.collator)}outputDefined(){return!0}}}const ir=rr("==",(function(e,t,r){return t===r}),tr),nr=rr("!=",(function(e,t,r){return t!==r}),(function(e,t,r,i){return!tr(0,t,r,i)})),ar=rr("<",(function(e,t,r){return t<r}),(function(e,t,r,i){return i.compare(t,r)<0})),or=rr(">",(function(e,t,r){return t>r}),(function(e,t,r,i){return i.compare(t,r)>0})),sr=rr("<=",(function(e,t,r){return t<=r}),(function(e,t,r,i){return i.compare(t,r)<=0})),lr=rr(">=",(function(e,t,r){return t>=r}),(function(e,t,r,i){return i.compare(t,r)>=0}));class cr{constructor(e,t,r,i,n){this.type=de,this.number=e,this.locale=t,this.currency=r,this.minFractionDigits=i,this.maxFractionDigits=n}static parse(e,t){if(3!==e.length)return t.error("Expected two arguments.");const r=t.parse(e[1],1,pe);if(!r)return null;const i=e[2];if("object"!=typeof i||Array.isArray(i))return t.error("NumberFormat options argument must be an object.");let n=null;if(i.locale&&(n=t.parse(i.locale,1,de),!n))return null;let a=null;if(i.currency&&(a=t.parse(i.currency,1,de),!a))return null;let o=null;if(i["min-fraction-digits"]&&(o=t.parse(i["min-fraction-digits"],1,pe),!o))return null;let s=null;return i["max-fraction-digits"]&&(s=t.parse(i["max-fraction-digits"],1,pe),!s)?null:new cr(r,n,a,o,s)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}}class ur{constructor(e){this.type=xe,this.sections=e}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const r=e[1];if(!Array.isArray(r)&&"object"==typeof r)return t.error("First argument must be an image or text section.");const i=[];let n=!1;for(let r=1;r<=e.length-1;++r){const a=e[r];if(n&&"object"==typeof a&&!Array.isArray(a)){n=!1;let e=null;if(a["font-scale"]&&(e=t.parse(a["font-scale"],1,pe),!e))return null;let r=null;if(a["text-font"]&&(r=t.parse(a["text-font"],1,we(de)),!r))return null;let o=null;if(a["text-color"]&&(o=t.parse(a["text-color"],1,me),!o))return null;const s=i[i.length-1];s.scale=e,s.font=r,s.textColor=o}else{const a=t.parse(e[r],1,ye);if(!a)return null;const o=a.type.kind;if("string"!==o&&"value"!==o&&"null"!==o&&"resolvedImage"!==o)return t.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");n=!0,i.push({content:a,scale:null,font:null,textColor:null})}}return new ur(i)}evaluate(e){return new Fe(this.sections.map((t=>{const r=t.content.evaluate(e);return Ne(r)===be?new Re("",r,null,null,null):new Re(je(r),null,t.scale?t.scale.evaluate(e):null,t.font?t.font.evaluate(e).join(","):null,t.textColor?t.textColor.evaluate(e):null)})))}eachChild(e){for(const t of this.sections)e(t.content),t.scale&&e(t.scale),t.font&&e(t.font),t.textColor&&e(t.textColor)}outputDefined(){return!1}}class hr{constructor(e){this.type=be,this.input=e}static parse(e,t){if(2!==e.length)return t.error("Expected two arguments.");const r=t.parse(e[1],1,de);return r?new hr(r):t.error("No image name provided.")}evaluate(e){const t=this.input.evaluate(e),r=Ue.fromString(t);return r&&e.availableImages&&(r.available=e.availableImages.indexOf(t)>-1),r}eachChild(e){e(this.input)}outputDefined(){return!1}}class pr{constructor(e){this.type=pe,this.input=e}static parse(e,t){if(2!==e.length)return t.error(`Expected 1 argument, but found ${e.length-1} instead.`);const r=t.parse(e[1],1);return r?"array"!==r.type.kind&&"string"!==r.type.kind&&"value"!==r.type.kind?t.error(`Expected argument of type string or array, but found ${Te(r.type)} instead.`):new pr(r):null}evaluate(e){const t=this.input.evaluate(e);if("string"==typeof t)return t.length;if(Array.isArray(t))return t.length;throw new Ge(`Expected value to be of type string or array, but found ${Te(Ne(t))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}}const dr={"==":ir,"!=":nr,">":or,"<":ar,">=":lr,"<=":sr,array:Xe,at:Wt,boolean:Xe,case:Jt,coalesce:Zt,collator:Qe,format:ur,image:hr,in:Ht,"index-of":Kt,interpolate:qt,"interpolate-hcl":qt,"interpolate-lab":qt,length:pr,let:Xt,literal:qe,match:Yt,number:Xe,"number-format":cr,object:Xe,slice:Qt,step:Et,string:Xe,"to-boolean":He,"to-color":He,"to-number":He,"to-string":He,var:vt,within:gt};function fr(e,[t,r,i,n]){t=t.evaluate(e),r=r.evaluate(e),i=i.evaluate(e);const a=n?n.evaluate(e):1,o=Ve(t,r,i,a);if(o)throw new Ge(o);return new Le(t/255*a,r/255*a,i/255*a,a)}function mr(e,t){return e in t}function gr(e,t){const r=t[e];return void 0===r?null:r}function yr(e){return{type:e}}function _r(e){return{result:"success",value:e}}function xr(e){return{result:"error",value:e}}function vr(e){return"data-driven"===e["property-type"]||"cross-faded-data-driven"===e["property-type"]}function br(e){return!!e.expression&&e.expression.parameters.indexOf("zoom")>-1}function wr(e){return!!e.expression&&e.expression.interpolated}function Tr(e){return e instanceof Number?"number":e instanceof String?"string":e instanceof Boolean?"boolean":Array.isArray(e)?"array":null===e?"null":typeof e}function Er(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function Sr(e){return e}function Ar(e,t){const r="color"===t.type,i=e.stops&&"object"==typeof e.stops[0][0],n=i||!(i||void 0!==e.property),a=e.type||(wr(t)?"exponential":"interval");if(r||"padding"===t.type){const i=r?Le.parse:Oe.parse;(e=oe({},e)).stops&&(e.stops=e.stops.map((e=>[e[0],i(e[1])]))),e.default=i(e.default?e.default:t.default)}if(e.colorSpace&&"rgb"!==e.colorSpace&&!jt[e.colorSpace])throw new Error(`Unknown color space: ${e.colorSpace}`);let o,s,l;if("exponential"===a)o=zr;else if("interval"===a)o=Cr;else if("categorical"===a){o=kr,s=Object.create(null);for(const t of e.stops)s[t[0]]=t[1];l=typeof e.stops[0][0]}else{if("identity"!==a)throw new Error(`Unknown function type "${a}"`);o=Mr}if(i){const r={},i=[];for(let t=0;t<e.stops.length;t++){const n=e.stops[t],a=n[0].zoom;void 0===r[a]&&(r[a]={zoom:a,type:e.type,property:e.property,default:e.default,stops:[]},i.push(a)),r[a].stops.push([n[0].value,n[1]])}const n=[];for(const e of i)n.push([r[e].zoom,Ar(r[e],t)]);const a={name:"linear"};return{kind:"composite",interpolationType:a,interpolationFactor:qt.interpolationFactor.bind(void 0,a),zoomStops:n.map((e=>e[0])),evaluate:({zoom:r},i)=>zr({stops:n,base:e.base},t,r).evaluate(r,i)}}if(n){const r="exponential"===a?{name:"exponential",base:void 0!==e.base?e.base:1}:null;return{kind:"camera",interpolationType:r,interpolationFactor:qt.interpolationFactor.bind(void 0,r),zoomStops:e.stops.map((e=>e[0])),evaluate:({zoom:r})=>o(e,t,r,s,l)}}return{kind:"source",evaluate(r,i){const n=i&&i.properties?i.properties[e.property]:void 0;return void 0===n?Ir(e.default,t.default):o(e,t,n,s,l)}}}function Ir(e,t,r){return void 0!==e?e:void 0!==t?t:void 0!==r?r:void 0}function kr(e,t,r,i,n){return Ir(typeof r===n?i[r]:void 0,e.default,t.default)}function Cr(e,t,r){if("number"!==Tr(r))return Ir(e.default,t.default);const i=e.stops.length;if(1===i)return e.stops[0][1];if(r<=e.stops[0][0])return e.stops[0][1];if(r>=e.stops[i-1][0])return e.stops[i-1][1];const n=Tt(e.stops.map((e=>e[0])),r);return e.stops[n][1]}function zr(e,t,r){const i=void 0!==e.base?e.base:1;if("number"!==Tr(r))return Ir(e.default,t.default);const n=e.stops.length;if(1===n)return e.stops[0][1];if(r<=e.stops[0][0])return e.stops[0][1];if(r>=e.stops[n-1][0])return e.stops[n-1][1];const a=Tt(e.stops.map((e=>e[0])),r),o=function(e,t,r,i){const n=i-r,a=e-r;return 0===n?0:1===t?a/n:(Math.pow(t,a)-1)/(Math.pow(t,n)-1)}(r,i,e.stops[a][0],e.stops[a+1][0]),s=e.stops[a][1],l=e.stops[a+1][1];let c=At[t.type]||Sr;if(e.colorSpace&&"rgb"!==e.colorSpace){const t=jt[e.colorSpace];c=(e,r)=>t.reverse(t.interpolate(t.forward(e),t.forward(r),o))}return"function"==typeof s.evaluate?{evaluate(...e){const t=s.evaluate.apply(void 0,e),r=l.evaluate.apply(void 0,e);if(void 0!==t&&void 0!==r)return c(t,r,o)}}:c(s,l,o)}function Mr(e,t,r){switch(t.type){case"color":r=Le.parse(r);break;case"formatted":r=Fe.fromString(r.toString());break;case"resolvedImage":r=Ue.fromString(r.toString());break;case"padding":r=Oe.parse(r);break;default:Tr(r)===t.type||"enum"===t.type&&t.values[r]||(r=void 0)}return Ir(r,e.default,t.default)}Je.register(dr,{error:[{kind:"error"},[de],(e,[t])=>{throw new Ge(t.evaluate(e))}],typeof:[de,[ye],(e,[t])=>Te(Ne(t.evaluate(e)))],"to-rgba":[we(pe,4),[me],(e,[t])=>t.evaluate(e).toArray()],rgb:[me,[pe,pe,pe],fr],rgba:[me,[pe,pe,pe,pe],fr],has:{type:fe,overloads:[[[de],(e,[t])=>mr(t.evaluate(e),e.properties())],[[de,ge],(e,[t,r])=>mr(t.evaluate(e),r.evaluate(e))]]},get:{type:ye,overloads:[[[de],(e,[t])=>gr(t.evaluate(e),e.properties())],[[de,ge],(e,[t,r])=>gr(t.evaluate(e),r.evaluate(e))]]},"feature-state":[ye,[de],(e,[t])=>gr(t.evaluate(e),e.featureState||{})],properties:[ge,[],e=>e.properties()],"geometry-type":[de,[],e=>e.geometryType()],id:[ye,[],e=>e.id()],zoom:[pe,[],e=>e.globals.zoom],"heatmap-density":[pe,[],e=>e.globals.heatmapDensity||0],"line-progress":[pe,[],e=>e.globals.lineProgress||0],accumulated:[ye,[],e=>void 0===e.globals.accumulated?null:e.globals.accumulated],"+":[pe,yr(pe),(e,t)=>{let r=0;for(const i of t)r+=i.evaluate(e);return r}],"*":[pe,yr(pe),(e,t)=>{let r=1;for(const i of t)r*=i.evaluate(e);return r}],"-":{type:pe,overloads:[[[pe,pe],(e,[t,r])=>t.evaluate(e)-r.evaluate(e)],[[pe],(e,[t])=>-t.evaluate(e)]]},"/":[pe,[pe,pe],(e,[t,r])=>t.evaluate(e)/r.evaluate(e)],"%":[pe,[pe,pe],(e,[t,r])=>t.evaluate(e)%r.evaluate(e)],ln2:[pe,[],()=>Math.LN2],pi:[pe,[],()=>Math.PI],e:[pe,[],()=>Math.E],"^":[pe,[pe,pe],(e,[t,r])=>Math.pow(t.evaluate(e),r.evaluate(e))],sqrt:[pe,[pe],(e,[t])=>Math.sqrt(t.evaluate(e))],log10:[pe,[pe],(e,[t])=>Math.log(t.evaluate(e))/Math.LN10],ln:[pe,[pe],(e,[t])=>Math.log(t.evaluate(e))],log2:[pe,[pe],(e,[t])=>Math.log(t.evaluate(e))/Math.LN2],sin:[pe,[pe],(e,[t])=>Math.sin(t.evaluate(e))],cos:[pe,[pe],(e,[t])=>Math.cos(t.evaluate(e))],tan:[pe,[pe],(e,[t])=>Math.tan(t.evaluate(e))],asin:[pe,[pe],(e,[t])=>Math.asin(t.evaluate(e))],acos:[pe,[pe],(e,[t])=>Math.acos(t.evaluate(e))],atan:[pe,[pe],(e,[t])=>Math.atan(t.evaluate(e))],min:[pe,yr(pe),(e,t)=>Math.min(...t.map((t=>t.evaluate(e))))],max:[pe,yr(pe),(e,t)=>Math.max(...t.map((t=>t.evaluate(e))))],abs:[pe,[pe],(e,[t])=>Math.abs(t.evaluate(e))],round:[pe,[pe],(e,[t])=>{const r=t.evaluate(e);return r<0?-Math.round(-r):Math.round(r)}],floor:[pe,[pe],(e,[t])=>Math.floor(t.evaluate(e))],ceil:[pe,[pe],(e,[t])=>Math.ceil(t.evaluate(e))],"filter-==":[fe,[de,ye],(e,[t,r])=>e.properties()[t.value]===r.value],"filter-id-==":[fe,[ye],(e,[t])=>e.id()===t.value],"filter-type-==":[fe,[de],(e,[t])=>e.geometryType()===t.value],"filter-<":[fe,[de,ye],(e,[t,r])=>{const i=e.properties()[t.value],n=r.value;return typeof i==typeof n&&i<n}],"filter-id-<":[fe,[ye],(e,[t])=>{const r=e.id(),i=t.value;return typeof r==typeof i&&r<i}],"filter->":[fe,[de,ye],(e,[t,r])=>{const i=e.properties()[t.value],n=r.value;return typeof i==typeof n&&i>n}],"filter-id->":[fe,[ye],(e,[t])=>{const r=e.id(),i=t.value;return typeof r==typeof i&&r>i}],"filter-<=":[fe,[de,ye],(e,[t,r])=>{const i=e.properties()[t.value],n=r.value;return typeof i==typeof n&&i<=n}],"filter-id-<=":[fe,[ye],(e,[t])=>{const r=e.id(),i=t.value;return typeof r==typeof i&&r<=i}],"filter->=":[fe,[de,ye],(e,[t,r])=>{const i=e.properties()[t.value],n=r.value;return typeof i==typeof n&&i>=n}],"filter-id->=":[fe,[ye],(e,[t])=>{const r=e.id(),i=t.value;return typeof r==typeof i&&r>=i}],"filter-has":[fe,[ye],(e,[t])=>t.value in e.properties()],"filter-has-id":[fe,[],e=>null!==e.id()&&void 0!==e.id()],"filter-type-in":[fe,[we(de)],(e,[t])=>t.value.indexOf(e.geometryType())>=0],"filter-id-in":[fe,[we(ye)],(e,[t])=>t.value.indexOf(e.id())>=0],"filter-in-small":[fe,[de,we(ye)],(e,[t,r])=>r.value.indexOf(e.properties()[t.value])>=0],"filter-in-large":[fe,[de,we(ye)],(e,[t,r])=>function(e,t,r,i){for(;r<=i;){const n=r+i>>1;if(t[n]===e)return!0;t[n]>e?i=n-1:r=n+1}return!1}(e.properties()[t.value],r.value,0,r.value.length-1)],all:{type:fe,overloads:[[[fe,fe],(e,[t,r])=>t.evaluate(e)&&r.evaluate(e)],[yr(fe),(e,t)=>{for(const r of t)if(!r.evaluate(e))return!1;return!0}]]},any:{type:fe,overloads:[[[fe,fe],(e,[t,r])=>t.evaluate(e)||r.evaluate(e)],[yr(fe),(e,t)=>{for(const r of t)if(r.evaluate(e))return!0;return!1}]]},"!":[fe,[fe],(e,[t])=>!t.evaluate(e)],"is-supported-script":[fe,[de],(e,[t])=>{const r=e.globals&&e.globals.isSupportedScript;return!r||r(t.evaluate(e))}],upcase:[de,[de],(e,[t])=>t.evaluate(e).toUpperCase()],downcase:[de,[de],(e,[t])=>t.evaluate(e).toLowerCase()],concat:[de,yr(ye),(e,t)=>t.map((t=>je(t.evaluate(e)))).join("")],"resolved-locale":[de,[_e],(e,[t])=>t.evaluate(e).resolvedLocale()]});class Pr{constructor(e,t){this.expression=e,this._warningHistory={},this._evaluator=new Ye,this._defaultValue=t?function(e){return"color"===e.type&&Er(e.default)?new Le(0,0,0,0):"color"===e.type?Le.parse(e.default)||null:"padding"===e.type?Oe.parse(e.default)||null:void 0===e.default?null:e.default}(t):null,this._enumValues=t&&"enum"===t.type?t.values:null}evaluateWithoutErrorHandling(e,t,r,i,n,a){return this._evaluator.globals=e,this._evaluator.feature=t,this._evaluator.featureState=r,this._evaluator.canonical=i,this._evaluator.availableImages=n||null,this._evaluator.formattedSection=a,this.expression.evaluate(this._evaluator)}evaluate(e,t,r,i,n,a){this._evaluator.globals=e,this._evaluator.feature=t||null,this._evaluator.featureState=r||null,this._evaluator.canonical=i,this._evaluator.availableImages=n||null,this._evaluator.formattedSection=a||null;try{const e=this.expression.evaluate(this._evaluator);if(null==e||"number"==typeof e&&e!=e)return this._defaultValue;if(this._enumValues&&!(e in this._enumValues))throw new Ge(`Expected value to be one of ${Object.keys(this._enumValues).map((e=>JSON.stringify(e))).join(", ")}, but found ${JSON.stringify(e)} instead.`);return e}catch(e){return this._warningHistory[e.message]||(this._warningHistory[e.message]=!0,"undefined"!=typeof console&&console.warn(e.message)),this._defaultValue}}}function Dr(e){return Array.isArray(e)&&e.length>0&&"string"==typeof e[0]&&e[0]in dr}function Lr(e,t){const r=new bt(dr,[],t?function(e){const t={color:me,string:de,number:pe,enum:de,boolean:fe,formatted:xe,padding:ve,resolvedImage:be};return"array"===e.type?we(t[e.value]||ye,e.length):t[e.type]}(t):void 0),i=r.parse(e,void 0,void 0,void 0,t&&"string"===t.type?{typeAnnotation:"coerce"}:void 0);return i?_r(new Pr(i,t)):xr(r.errors)}class Br{constructor(e,t){this.kind=e,this._styleExpression=t,this.isStateDependent="constant"!==e&&!_t(t.expression)}evaluateWithoutErrorHandling(e,t,r,i,n,a){return this._styleExpression.evaluateWithoutErrorHandling(e,t,r,i,n,a)}evaluate(e,t,r,i,n,a){return this._styleExpression.evaluate(e,t,r,i,n,a)}}class Rr{constructor(e,t,r,i){this.kind=e,this.zoomStops=r,this._styleExpression=t,this.isStateDependent="camera"!==e&&!_t(t.expression),this.interpolationType=i}evaluateWithoutErrorHandling(e,t,r,i,n,a){return this._styleExpression.evaluateWithoutErrorHandling(e,t,r,i,n,a)}evaluate(e,t,r,i,n,a){return this._styleExpression.evaluate(e,t,r,i,n,a)}interpolationFactor(e,t,r){return this.interpolationType?qt.interpolationFactor(this.interpolationType,e,t,r):0}}function Fr(e,t){const r=Lr(e,t);if("error"===r.result)return r;const i=r.value.expression,n=yt(i);if(!n&&!vr(t))return xr([new ce("","data expressions not supported")]);const a=xt(i,["zoom"]);if(!a&&!br(t))return xr([new ce("","zoom expressions not supported")]);const o=Ur(i);return o||a?o instanceof ce?xr([o]):o instanceof qt&&!wr(t)?xr([new ce("",'"interpolate" expressions cannot be used with this property')]):_r(o?new Rr(n?"camera":"composite",r.value,o.labels,o instanceof qt?o.interpolation:void 0):new Br(n?"constant":"source",r.value)):xr([new ce("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Or{constructor(e,t){this._parameters=e,this._specification=t,oe(this,Ar(this._parameters,this._specification))}static deserialize(e){return new Or(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Ur(e){let t=null;if(e instanceof Xt)t=Ur(e.result);else if(e instanceof Zt){for(const r of e.args)if(t=Ur(r),t)break}else(e instanceof Et||e instanceof qt)&&e.input instanceof Je&&"zoom"===e.input.name&&(t=e);return t instanceof ce||e.eachChild((e=>{const r=Ur(e);r instanceof ce?t=r:!t&&r?t=new ce("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):t&&r&&t!==r&&(t=new ce("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),t}function Vr(e){const t=e.key,r=e.value,i=e.valueSpec||{},n=e.objectElementValidators||{},a=e.style,o=e.styleSpec;let s=[];const l=Tr(r);if("object"!==l)return[new ne(t,r,`object expected, ${l} found`)];for(const e in r){const l=e.split(".")[0],c=i[l]||i["*"];let u;if(n[l])u=n[l];else if(i[l])u=fi;else if(n["*"])u=n["*"];else{if(!i["*"]){s.push(new ne(t,r[e],`unknown property "${e}"`));continue}u=fi}s=s.concat(u({key:(t?`${t}.`:t)+e,value:r[e],valueSpec:c,style:a,styleSpec:o,object:r,objectKey:e},r))}for(const e in i)n[e]||i[e].required&&void 0===i[e].default&&void 0===r[e]&&s.push(new ne(t,r,`missing required property "${e}"`));return s}function $r(e){const t=e.value,r=e.valueSpec,i=e.style,n=e.styleSpec,a=e.key,o=e.arrayElementValidator||fi;if("array"!==Tr(t))return[new ne(a,t,`array expected, ${Tr(t)} found`)];if(r.length&&t.length!==r.length)return[new ne(a,t,`array length ${r.length} expected, length ${t.length} found`)];if(r["min-length"]&&t.length<r["min-length"])return[new ne(a,t,`array length at least ${r["min-length"]} expected, length ${t.length} found`)];let s={type:r.value,values:r.values};n.$version<7&&(s.function=r.function),"object"===Tr(r.value)&&(s=r.value);let l=[];for(let e=0;e<t.length;e++)l=l.concat(o({array:t,arrayIndex:e,value:t[e],valueSpec:s,style:i,styleSpec:n,key:`${a}[${e}]`}));return l}function Nr(e){const t=e.key,r=e.value,i=e.valueSpec;let n=Tr(r);return"number"===n&&r!=r&&(n="NaN"),"number"!==n?[new ne(t,r,`number expected, ${n} found`)]:"minimum"in i&&r<i.minimum?[new ne(t,r,`${r} is less than the minimum value ${i.minimum}`)]:"maximum"in i&&r>i.maximum?[new ne(t,r,`${r} is greater than the maximum value ${i.maximum}`)]:[]}function jr(e){const t=e.valueSpec,r=se(e.value.type);let i,n,a,o={};const s="categorical"!==r&&void 0===e.value.property,l=!s,c="array"===Tr(e.value.stops)&&"array"===Tr(e.value.stops[0])&&"object"===Tr(e.value.stops[0][0]),u=Vr({key:e.key,value:e.value,valueSpec:e.styleSpec.function,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{stops:function(e){if("identity"===r)return[new ne(e.key,e.value,'identity function may not have a "stops" property')];let t=[];const i=e.value;return t=t.concat($r({key:e.key,value:i,valueSpec:e.valueSpec,style:e.style,styleSpec:e.styleSpec,arrayElementValidator:h})),"array"===Tr(i)&&0===i.length&&t.push(new ne(e.key,i,"array must have at least one stop")),t},default:function(e){return fi({key:e.key,value:e.value,valueSpec:t,style:e.style,styleSpec:e.styleSpec})}}});return"identity"===r&&s&&u.push(new ne(e.key,e.value,'missing required property "property"')),"identity"===r||e.value.stops||u.push(new ne(e.key,e.value,'missing required property "stops"')),"exponential"===r&&e.valueSpec.expression&&!wr(e.valueSpec)&&u.push(new ne(e.key,e.value,"exponential functions not supported")),e.styleSpec.$version>=8&&(l&&!vr(e.valueSpec)?u.push(new ne(e.key,e.value,"property functions not supported")):s&&!br(e.valueSpec)&&u.push(new ne(e.key,e.value,"zoom functions not supported"))),"categorical"!==r&&!c||void 0!==e.value.property||u.push(new ne(e.key,e.value,'"property" property is required')),u;function h(e){let r=[];const i=e.value,s=e.key;if("array"!==Tr(i))return[new ne(s,i,`array expected, ${Tr(i)} found`)];if(2!==i.length)return[new ne(s,i,`array length 2 expected, length ${i.length} found`)];if(c){if("object"!==Tr(i[0]))return[new ne(s,i,`object expected, ${Tr(i[0])} found`)];if(void 0===i[0].zoom)return[new ne(s,i,"object stop key must have zoom")];if(void 0===i[0].value)return[new ne(s,i,"object stop key must have value")];if(a&&a>se(i[0].zoom))return[new ne(s,i[0].zoom,"stop zoom values must appear in ascending order")];se(i[0].zoom)!==a&&(a=se(i[0].zoom),n=void 0,o={}),r=r.concat(Vr({key:`${s}[0]`,value:i[0],valueSpec:{zoom:{}},style:e.style,styleSpec:e.styleSpec,objectElementValidators:{zoom:Nr,value:p}}))}else r=r.concat(p({key:`${s}[0]`,value:i[0],valueSpec:{},style:e.style,styleSpec:e.styleSpec},i));return Dr(le(i[1]))?r.concat([new ne(`${s}[1]`,i[1],"expressions are not allowed in function stops.")]):r.concat(fi({key:`${s}[1]`,value:i[1],valueSpec:t,style:e.style,styleSpec:e.styleSpec}))}function p(e,a){const s=Tr(e.value),l=se(e.value),c=null!==e.value?e.value:a;if(i){if(s!==i)return[new ne(e.key,c,`${s} stop domain type must match previous stop domain type ${i}`)]}else i=s;if("number"!==s&&"string"!==s&&"boolean"!==s)return[new ne(e.key,c,"stop domain value must be a number, string, or boolean")];if("number"!==s&&"categorical"!==r){let i=`number expected, ${s} found`;return vr(t)&&void 0===r&&(i+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new ne(e.key,c,i)]}return"categorical"!==r||"number"!==s||isFinite(l)&&Math.floor(l)===l?"categorical"!==r&&"number"===s&&void 0!==n&&l<n?[new ne(e.key,c,"stop domain values must appear in ascending order")]:(n=l,"categorical"===r&&l in o?[new ne(e.key,c,"stop domain values must be unique")]:(o[l]=!0,[])):[new ne(e.key,c,`integer expected, found ${l}`)]}}function qr(e){const t=("property"===e.expressionContext?Fr:Lr)(le(e.value),e.valueSpec);if("error"===t.result)return t.value.map((t=>new ne(`${e.key}${t.key}`,e.value,t.message)));const r=t.value.expression||t.value._styleExpression.expression;if("property"===e.expressionContext&&"text-font"===e.propertyKey&&!r.outputDefined())return[new ne(e.key,e.value,`Invalid data expression for "${e.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===e.expressionContext&&"layout"===e.propertyType&&!_t(r))return[new ne(e.key,e.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===e.expressionContext&&!_t(r))return[new ne(e.key,e.value,'"feature-state" data expressions are not supported with filters.')];if(e.expressionContext&&0===e.expressionContext.indexOf("cluster")){if(!xt(r,["zoom","feature-state"]))return[new ne(e.key,e.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===e.expressionContext&&!yt(r))return[new ne(e.key,e.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Gr(e){const t=e.key,r=e.value,i=e.valueSpec,n=[];return Array.isArray(i.values)?-1===i.values.indexOf(se(r))&&n.push(new ne(t,r,`expected one of [${i.values.join(", ")}], ${JSON.stringify(r)} found`)):-1===Object.keys(i.values).indexOf(se(r))&&n.push(new ne(t,r,`expected one of [${Object.keys(i.values).join(", ")}], ${JSON.stringify(r)} found`)),n}function Zr(e){if(!0===e||!1===e)return!0;if(!Array.isArray(e)||0===e.length)return!1;switch(e[0]){case"has":return e.length>=2&&"$id"!==e[1]&&"$type"!==e[1];case"in":return e.length>=3&&("string"!=typeof e[1]||Array.isArray(e[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==e.length||Array.isArray(e[1])||Array.isArray(e[2]);case"any":case"all":for(const t of e.slice(1))if(!Zr(t)&&"boolean"!=typeof t)return!1;return!0;default:return!0}}const Xr={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function Wr(e){if(null==e)return{filter:()=>!0,needGeometry:!1};Zr(e)||(e=Yr(e));const t=Lr(e,Xr);if("error"===t.result)throw new Error(t.value.map((e=>`${e.key}: ${e.message}`)).join(", "));return{filter:(e,r,i)=>t.value.evaluate(e,r,{},i),needGeometry:Kr(e)}}function Hr(e,t){return e<t?-1:e>t?1:0}function Kr(e){if(!Array.isArray(e))return!1;if("within"===e[0])return!0;for(let t=1;t<e.length;t++)if(Kr(e[t]))return!0;return!1}function Yr(e){if(!e)return!0;const t=e[0];return e.length<=1?"any"!==t:"=="===t?Jr(e[1],e[2],"=="):"!="===t?ti(Jr(e[1],e[2],"==")):"<"===t||">"===t||"<="===t||">="===t?Jr(e[1],e[2],t):"any"===t?(r=e.slice(1),["any"].concat(r.map(Yr))):"all"===t?["all"].concat(e.slice(1).map(Yr)):"none"===t?["all"].concat(e.slice(1).map(Yr).map(ti)):"in"===t?Qr(e[1],e.slice(2)):"!in"===t?ti(Qr(e[1],e.slice(2))):"has"===t?ei(e[1]):"!has"===t?ti(ei(e[1])):"within"!==t||e;var r}function Jr(e,t,r){switch(e){case"$type":return[`filter-type-${r}`,t];case"$id":return[`filter-id-${r}`,t];default:return[`filter-${r}`,e,t]}}function Qr(e,t){if(0===t.length)return!1;switch(e){case"$type":return["filter-type-in",["literal",t]];case"$id":return["filter-id-in",["literal",t]];default:return t.length>200&&!t.some((e=>typeof e!=typeof t[0]))?["filter-in-large",e,["literal",t.sort(Hr)]]:["filter-in-small",e,["literal",t]]}}function ei(e){switch(e){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",e]}}function ti(e){return["!",e]}function ri(e){return Zr(le(e.value))?qr(oe({},e,{expressionContext:"filter",valueSpec:{value:"boolean"}})):ii(e)}function ii(e){const t=e.value,r=e.key;if("array"!==Tr(t))return[new ne(r,t,`array expected, ${Tr(t)} found`)];const i=e.styleSpec;let n,a=[];if(t.length<1)return[new ne(r,t,"filter array must have at least 1 element")];switch(a=a.concat(Gr({key:`${r}[0]`,value:t[0],valueSpec:i.filter_operator,style:e.style,styleSpec:e.styleSpec})),se(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&"$type"===se(t[1])&&a.push(new ne(r,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":3!==t.length&&a.push(new ne(r,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(n=Tr(t[1]),"string"!==n&&a.push(new ne(`${r}[1]`,t[1],`string expected, ${n} found`)));for(let o=2;o<t.length;o++)n=Tr(t[o]),"$type"===se(t[1])?a=a.concat(Gr({key:`${r}[${o}]`,value:t[o],valueSpec:i.geometry_type,style:e.style,styleSpec:e.styleSpec})):"string"!==n&&"number"!==n&&"boolean"!==n&&a.push(new ne(`${r}[${o}]`,t[o],`string, number, or boolean expected, ${n} found`));break;case"any":case"all":case"none":for(let i=1;i<t.length;i++)a=a.concat(ii({key:`${r}[${i}]`,value:t[i],style:e.style,styleSpec:e.styleSpec}));break;case"has":case"!has":n=Tr(t[1]),2!==t.length?a.push(new ne(r,t,`filter array for "${t[0]}" operator must have 2 elements`)):"string"!==n&&a.push(new ne(`${r}[1]`,t[1],`string expected, ${n} found`));break;case"within":n=Tr(t[1]),2!==t.length?a.push(new ne(r,t,`filter array for "${t[0]}" operator must have 2 elements`)):"object"!==n&&a.push(new ne(`${r}[1]`,t[1],`object expected, ${n} found`))}return a}function ni(e,t){const r=e.key,i=e.style,n=e.styleSpec,a=e.value,o=e.objectKey,s=n[`${t}_${e.layerType}`];if(!s)return[];const l=o.match(/^(.*)-transition$/);if("paint"===t&&l&&s[l[1]]&&s[l[1]].transition)return fi({key:r,value:a,valueSpec:n.transition,style:i,styleSpec:n});const c=e.valueSpec||s[o];if(!c)return[new ne(r,a,`unknown property "${o}"`)];let u;if("string"===Tr(a)&&vr(c)&&!c.tokens&&(u=/^{([^}]+)}$/.exec(a)))return[new ne(r,a,`"${o}" does not support interpolation syntax\nUse an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(u[1])} }\`.`)];const h=[];return"symbol"===e.layerType&&("text-field"===o&&i&&!i.glyphs&&h.push(new ne(r,a,'use of "text-field" requires a style "glyphs" property')),"text-font"===o&&Er(le(a))&&"identity"===se(a.type)&&h.push(new ne(r,a,'"text-font" does not support identity functions'))),h.concat(fi({key:e.key,value:a,valueSpec:c,style:i,styleSpec:n,expressionContext:"property",propertyType:t,propertyKey:o}))}function ai(e){return ni(e,"paint")}function oi(e){return ni(e,"layout")}function si(e){let t=[];const r=e.value,i=e.key,n=e.style,a=e.styleSpec;r.type||r.ref||t.push(new ne(i,r,'either "type" or "ref" is required'));let o=se(r.type);const s=se(r.ref);if(r.id){const a=se(r.id);for(let o=0;o<e.arrayIndex;o++){const e=n.layers[o];se(e.id)===a&&t.push(new ne(i,r.id,`duplicate layer id "${r.id}", previously used at line ${e.id.__line__}`))}}if("ref"in r){let e;["type","source","source-layer","filter","layout"].forEach((e=>{e in r&&t.push(new ne(i,r[e],`"${e}" is prohibited for ref layers`))})),n.layers.forEach((t=>{se(t.id)===s&&(e=t)})),e?e.ref?t.push(new ne(i,r.ref,"ref cannot reference another ref layer")):o=se(e.type):t.push(new ne(i,r.ref,`ref layer "${s}" not found`))}else if("background"!==o)if(r.source){const e=n.sources&&n.sources[r.source],a=e&&se(e.type);e?"vector"===a&&"raster"===o?t.push(new ne(i,r.source,`layer "${r.id}" requires a raster source`)):"raster"===a&&"raster"!==o?t.push(new ne(i,r.source,`layer "${r.id}" requires a vector source`)):"vector"!==a||r["source-layer"]?"raster-dem"===a&&"hillshade"!==o?t.push(new ne(i,r.source,"raster-dem source can only be used with layer type 'hillshade'.")):"line"!==o||!r.paint||!r.paint["line-gradient"]||"geojson"===a&&e.lineMetrics||t.push(new ne(i,r,`layer "${r.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):t.push(new ne(i,r,`layer "${r.id}" must specify a "source-layer"`)):t.push(new ne(i,r.source,`source "${r.source}" not found`))}else t.push(new ne(i,r,'missing required property "source"'));return t=t.concat(Vr({key:i,value:r,valueSpec:a.layer,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{"*":()=>[],type:()=>fi({key:`${i}.type`,value:r.type,valueSpec:a.layer.type,style:e.style,styleSpec:e.styleSpec,object:r,objectKey:"type"}),filter:ri,layout:e=>Vr({layer:r,key:e.key,value:e.value,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{"*":e=>oi(oe({layerType:o},e))}}),paint:e=>Vr({layer:r,key:e.key,value:e.value,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{"*":e=>ai(oe({layerType:o},e))}})}})),t}function li(e){const t=e.value,r=e.key,i=Tr(t);return"string"!==i?[new ne(r,t,`string expected, ${i} found`)]:[]}const ci={promoteId:function({key:e,value:t}){if("string"===Tr(t))return li({key:e,value:t});{const r=[];for(const i in t)r.push(...li({key:`${e}.${i}`,value:t[i]}));return r}}};function ui(e){const t=e.value,r=e.key,i=e.styleSpec,n=e.style;if(!t.type)return[new ne(r,t,'"type" is required')];const a=se(t.type);let o;switch(a){case"vector":case"raster":case"raster-dem":return o=Vr({key:r,value:t,valueSpec:i[`source_${a.replace("-","_")}`],style:e.style,styleSpec:i,objectElementValidators:ci}),o;case"geojson":if(o=Vr({key:r,value:t,valueSpec:i.source_geojson,style:n,styleSpec:i,objectElementValidators:ci}),t.cluster)for(const e in t.clusterProperties){const[i,n]=t.clusterProperties[e],a="string"==typeof i?[i,["accumulated"],["get",e]]:i;o.push(...qr({key:`${r}.${e}.map`,value:n,expressionContext:"cluster-map"})),o.push(...qr({key:`${r}.${e}.reduce`,value:a,expressionContext:"cluster-reduce"}))}return o;case"video":return Vr({key:r,value:t,valueSpec:i.source_video,style:n,styleSpec:i});case"image":return Vr({key:r,value:t,valueSpec:i.source_image,style:n,styleSpec:i});case"canvas":return[new ne(r,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Gr({key:`${r}.type`,value:t.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:n,styleSpec:i})}}function hi(e){const t=e.value,r=e.styleSpec,i=r.light,n=e.style;let a=[];const o=Tr(t);if(void 0===t)return a;if("object"!==o)return a=a.concat([new ne("light",t,`object expected, ${o} found`)]),a;for(const e in t){const o=e.match(/^(.*)-transition$/);a=a.concat(o&&i[o[1]]&&i[o[1]].transition?fi({key:e,value:t[e],valueSpec:r.transition,style:n,styleSpec:r}):i[e]?fi({key:e,value:t[e],valueSpec:i[e],style:n,styleSpec:r}):[new ne(e,t[e],`unknown property "${e}"`)])}return a}function pi(e){const t=e.value,r=e.styleSpec,i=r.terrain,n=e.style;let a=[];const o=Tr(t);if(void 0===t)return a;if("object"!==o)return a=a.concat([new ne("terrain",t,`object expected, ${o} found`)]),a;for(const e in t)a=a.concat(i[e]?fi({key:e,value:t[e],valueSpec:i[e],style:n,styleSpec:r}):[new ne(e,t[e],`unknown property "${e}"`)]);return a}const di={"*":()=>[],array:$r,boolean:function(e){const t=e.value,r=e.key,i=Tr(t);return"boolean"!==i?[new ne(r,t,`boolean expected, ${i} found`)]:[]},number:Nr,color:function(e){const t=e.key,r=e.value,i=Tr(r);return"string"!==i?[new ne(t,r,`color expected, ${i} found`)]:null===ke(r)?[new ne(t,r,`color expected, "${r}" found`)]:[]},constants:ae,enum:Gr,filter:ri,function:jr,layer:si,object:Vr,source:ui,light:hi,terrain:pi,string:li,formatted:function(e){return 0===li(e).length?[]:qr(e)},resolvedImage:function(e){return 0===li(e).length?[]:qr(e)},padding:function(e){const t=e.key,r=e.value;if("array"===Tr(r)){if(r.length<1||r.length>4)return[new ne(t,r,`padding requires 1 to 4 values; ${r.length} values found`)];const e={type:"number"};let i=[];for(let n=0;n<r.length;n++)i=i.concat(fi({key:`${t}[${n}]`,value:r[n],valueSpec:e}));return i}return Nr({key:t,value:r,valueSpec:{}})}};function fi(e){const t=e.value,r=e.valueSpec,i=e.styleSpec;return r.expression&&Er(se(t))?jr(e):r.expression&&Dr(le(t))?qr(e):r.type&&di[r.type]?di[r.type](e):Vr(oe({},e,{valueSpec:r.type?i[r.type]:r}))}function mi(e){const t=e.value,r=e.key,i=li(e);return i.length||(-1===t.indexOf("{fontstack}")&&i.push(new ne(r,t,'"glyphs" url must include a "{fontstack}" token')),-1===t.indexOf("{range}")&&i.push(new ne(r,t,'"glyphs" url must include a "{range}" token'))),i}function gi(e,t=ie){let r=[];return r=r.concat(fi({key:"",value:e,valueSpec:t.$root,styleSpec:t,style:e,objectElementValidators:{glyphs:mi,"*":()=>[]}})),e.constants&&(r=r.concat(ae({key:"constants",value:e.constants,style:e,styleSpec:t}))),yi(r)}function yi(e){return[].concat(e).sort(((e,t)=>e.line-t.line))}function _i(e){return function(...t){return yi(e.apply(this,t))}}gi.source=_i(ui),gi.light=_i(hi),gi.terrain=_i(pi),gi.layer=_i(si),gi.filter=_i(ri),gi.paintProperty=_i(ai),gi.layoutProperty=_i(oi);const xi=gi,vi=xi.light,bi=xi.paintProperty,wi=xi.layoutProperty;function Ti(e,t){let r=!1;if(t&&t.length)for(const i of t)e.fire(new te(new Error(i.message))),r=!0;return r}class Ei{constructor(e,t,r){const i=this.cells=[];if(e instanceof ArrayBuffer){this.arrayBuffer=e;const n=new Int32Array(this.arrayBuffer);e=n[0],this.d=(t=n[1])+2*(r=n[2]);for(let e=0;e<this.d*this.d;e++){const t=n[3+e],r=n[3+e+1];i.push(t===r?null:n.subarray(t,r))}const a=n[3+i.length+1];this.keys=n.subarray(n[3+i.length],a),this.bboxes=n.subarray(a),this.insert=this._insertReadonly}else{this.d=t+2*r;for(let e=0;e<this.d*this.d;e++)i.push([]);this.keys=[],this.bboxes=[]}this.n=t,this.extent=e,this.padding=r,this.scale=t/e,this.uid=0;const n=r/t*e;this.min=-n,this.max=e+n}insert(e,t,r,i,n){this._forEachCell(t,r,i,n,this._insertCell,this.uid++,void 0,void 0),this.keys.push(e),this.bboxes.push(t),this.bboxes.push(r),this.bboxes.push(i),this.bboxes.push(n)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(e,t,r,i,n,a){this.cells[n].push(a)}query(e,t,r,i,n){const a=this.min,o=this.max;if(e<=a&&t<=a&&o<=r&&o<=i&&!n)return Array.prototype.slice.call(this.keys);{const a=[];return this._forEachCell(e,t,r,i,this._queryCell,a,{},n),a}}_queryCell(e,t,r,i,n,a,o,s){const l=this.cells[n];if(null!==l){const n=this.keys,c=this.bboxes;for(let u=0;u<l.length;u++){const h=l[u];if(void 0===o[h]){const l=4*h;(s?s(c[l+0],c[l+1],c[l+2],c[l+3]):e<=c[l+2]&&t<=c[l+3]&&r>=c[l+0]&&i>=c[l+1])?(o[h]=!0,a.push(n[h])):o[h]=!1}}}}_forEachCell(e,t,r,i,n,a,o,s){const l=this._convertToCellCoord(e),c=this._convertToCellCoord(t),u=this._convertToCellCoord(r),h=this._convertToCellCoord(i);for(let p=l;p<=u;p++)for(let l=c;l<=h;l++){const c=this.d*l+p;if((!s||s(this._convertFromCellCoord(p),this._convertFromCellCoord(l),this._convertFromCellCoord(p+1),this._convertFromCellCoord(l+1)))&&n.call(this,e,t,r,i,c,a,o,s))return}}_convertFromCellCoord(e){return(e-this.padding)/this.scale}_convertToCellCoord(e){return Math.max(0,Math.min(this.d-1,Math.floor(e*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const e=this.cells,t=3+this.cells.length+1+1;let r=0;for(let e=0;e<this.cells.length;e++)r+=this.cells[e].length;const i=new Int32Array(t+r+this.keys.length+this.bboxes.length);i[0]=this.extent,i[1]=this.n,i[2]=this.padding;let n=t;for(let t=0;t<e.length;t++){const r=e[t];i[3+t]=n,i.set(r,n),n+=r.length}return i[3+e.length]=n,i.set(this.keys,n),n+=this.keys.length,i[3+e.length+1]=n,i.set(this.bboxes,n),n+=this.bboxes.length,i.buffer}static serialize(e,t){const r=e.toArrayBuffer();return t&&t.push(r),{buffer:r}}static deserialize(e){return new Ei(e.buffer)}}const Si={};function Ai(e,t,r={}){if(Si[e])throw new Error(`${e} is already registered.`);Object.defineProperty(t,"_classRegistryKey",{value:e,writeable:!1}),Si[e]={klass:t,omit:r.omit||[],shallow:r.shallow||[]}}Ai("Object",Object),Ai("TransferableGridIndex",Ei),Ai("Color",Le),Ai("Error",Error),Ai("AJAXError",N),Ai("ResolvedImage",Ue),Ai("StylePropertyFunction",Or),Ai("StyleExpression",Pr,{omit:["_evaluator"]}),Ai("ZoomDependentExpression",Rr),Ai("ZoomConstantExpression",Br),Ai("CompoundExpression",Je,{omit:["_evaluate"]});for(const e in dr)dr[e]._classRegistryKey||Ai(`Expression_${e}`,dr[e]);function Ii(e){return e&&"undefined"!=typeof ArrayBuffer&&(e instanceof ArrayBuffer||e.constructor&&"ArrayBuffer"===e.constructor.name)}function ki(e,t){if(null==e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp||e instanceof Blob)return e;if(Ii(e))return t&&t.push(e),e;if(T(e))return t&&t.push(e),e;if(ArrayBuffer.isView(e)){const r=e;return t&&t.push(r.buffer),r}if(e instanceof ImageData)return t&&t.push(e.data.buffer),e;if(Array.isArray(e)){const r=[];for(const i of e)r.push(ki(i,t));return r}if("object"==typeof e){const r=e.constructor,i=r._classRegistryKey;if(!i)throw new Error("can't serialize object of unregistered class");if(!Si[i])throw new Error(`${i} is not registered.`);const n=r.serialize?r.serialize(e,t):{};if(r.serialize){if(t&&n===t[t.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const r in e){if(!e.hasOwnProperty(r))continue;if(Si[i].omit.indexOf(r)>=0)continue;const a=e[r];n[r]=Si[i].shallow.indexOf(r)>=0?a:ki(a,t)}e instanceof Error&&(n.message=e.message)}if(n.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==i&&(n.$name=i),n}throw new Error("can't serialize object of type "+typeof e)}function Ci(e){if(null==e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp||e instanceof Blob||Ii(e)||T(e)||ArrayBuffer.isView(e)||e instanceof ImageData)return e;if(Array.isArray(e))return e.map(Ci);if("object"==typeof e){const t=e.$name||"Object";if(!Si[t])throw new Error(`can't deserialize unregistered class ${t}`);const{klass:r}=Si[t];if(!r)throw new Error(`can't deserialize unregistered class ${t}`);if(r.deserialize)return r.deserialize(e);const i=Object.create(r.prototype);for(const r of Object.keys(e)){if("$name"===r)continue;const n=e[r];i[r]=Si[t].shallow.indexOf(r)>=0?n:Ci(n)}return i}throw new Error("can't deserialize object of type "+typeof e)}class zi{constructor(){this.first=!0}update(e,t){const r=Math.floor(e);return this.first?(this.first=!1,this.lastIntegerZoom=r,this.lastIntegerZoomTime=0,this.lastZoom=e,this.lastFloorZoom=r,!0):(this.lastFloorZoom>r?(this.lastIntegerZoom=r+1,this.lastIntegerZoomTime=t):this.lastFloorZoom<r&&(this.lastIntegerZoom=r,this.lastIntegerZoomTime=t),e!==this.lastZoom&&(this.lastZoom=e,this.lastFloorZoom=r,!0))}}const Mi={"Latin-1 Supplement":e=>e>=128&&e<=255,Arabic:e=>e>=1536&&e<=1791,"Arabic Supplement":e=>e>=1872&&e<=1919,"Arabic Extended-A":e=>e>=2208&&e<=2303,"Hangul Jamo":e=>e>=4352&&e<=4607,"Unified Canadian Aboriginal Syllabics":e=>e>=5120&&e<=5759,Khmer:e=>e>=6016&&e<=6143,"Unified Canadian Aboriginal Syllabics Extended":e=>e>=6320&&e<=6399,"General Punctuation":e=>e>=8192&&e<=8303,"Letterlike Symbols":e=>e>=8448&&e<=8527,"Number Forms":e=>e>=8528&&e<=8591,"Miscellaneous Technical":e=>e>=8960&&e<=9215,"Control Pictures":e=>e>=9216&&e<=9279,"Optical Character Recognition":e=>e>=9280&&e<=9311,"Enclosed Alphanumerics":e=>e>=9312&&e<=9471,"Geometric Shapes":e=>e>=9632&&e<=9727,"Miscellaneous Symbols":e=>e>=9728&&e<=9983,"Miscellaneous Symbols and Arrows":e=>e>=11008&&e<=11263,"CJK Radicals Supplement":e=>e>=11904&&e<=12031,"Kangxi Radicals":e=>e>=12032&&e<=12255,"Ideographic Description Characters":e=>e>=12272&&e<=12287,"CJK Symbols and Punctuation":e=>e>=12288&&e<=12351,Hiragana:e=>e>=12352&&e<=12447,Katakana:e=>e>=12448&&e<=12543,Bopomofo:e=>e>=12544&&e<=12591,"Hangul Compatibility Jamo":e=>e>=12592&&e<=12687,Kanbun:e=>e>=12688&&e<=12703,"Bopomofo Extended":e=>e>=12704&&e<=12735,"CJK Strokes":e=>e>=12736&&e<=12783,"Katakana Phonetic Extensions":e=>e>=12784&&e<=12799,"Enclosed CJK Letters and Months":e=>e>=12800&&e<=13055,"CJK Compatibility":e=>e>=13056&&e<=13311,"CJK Unified Ideographs Extension A":e=>e>=13312&&e<=19903,"Yijing Hexagram Symbols":e=>e>=19904&&e<=19967,"CJK Unified Ideographs":e=>e>=19968&&e<=40959,"Yi Syllables":e=>e>=40960&&e<=42127,"Yi Radicals":e=>e>=42128&&e<=42191,"Hangul Jamo Extended-A":e=>e>=43360&&e<=43391,"Hangul Syllables":e=>e>=44032&&e<=55215,"Hangul Jamo Extended-B":e=>e>=55216&&e<=55295,"Private Use Area":e=>e>=57344&&e<=63743,"CJK Compatibility Ideographs":e=>e>=63744&&e<=64255,"Arabic Presentation Forms-A":e=>e>=64336&&e<=65023,"Vertical Forms":e=>e>=65040&&e<=65055,"CJK Compatibility Forms":e=>e>=65072&&e<=65103,"Small Form Variants":e=>e>=65104&&e<=65135,"Arabic Presentation Forms-B":e=>e>=65136&&e<=65279,"Halfwidth and Fullwidth Forms":e=>e>=65280&&e<=65519};function Pi(e){for(const t of e)if(Bi(t.charCodeAt(0)))return!0;return!1}function Di(e){for(const t of e)if(!Li(t.charCodeAt(0)))return!1;return!0}function Li(e){return!(Mi.Arabic(e)||Mi["Arabic Supplement"](e)||Mi["Arabic Extended-A"](e)||Mi["Arabic Presentation Forms-A"](e)||Mi["Arabic Presentation Forms-B"](e))}function Bi(e){return!(746!==e&&747!==e&&(e<4352||!(Mi["Bopomofo Extended"](e)||Mi.Bopomofo(e)||Mi["CJK Compatibility Forms"](e)&&!(e>=65097&&e<=65103)||Mi["CJK Compatibility Ideographs"](e)||Mi["CJK Compatibility"](e)||Mi["CJK Radicals Supplement"](e)||Mi["CJK Strokes"](e)||!(!Mi["CJK Symbols and Punctuation"](e)||e>=12296&&e<=12305||e>=12308&&e<=12319||12336===e)||Mi["CJK Unified Ideographs Extension A"](e)||Mi["CJK Unified Ideographs"](e)||Mi["Enclosed CJK Letters and Months"](e)||Mi["Hangul Compatibility Jamo"](e)||Mi["Hangul Jamo Extended-A"](e)||Mi["Hangul Jamo Extended-B"](e)||Mi["Hangul Jamo"](e)||Mi["Hangul Syllables"](e)||Mi.Hiragana(e)||Mi["Ideographic Description Characters"](e)||Mi.Kanbun(e)||Mi["Kangxi Radicals"](e)||Mi["Katakana Phonetic Extensions"](e)||Mi.Katakana(e)&&12540!==e||!(!Mi["Halfwidth and Fullwidth Forms"](e)||65288===e||65289===e||65293===e||e>=65306&&e<=65310||65339===e||65341===e||65343===e||e>=65371&&e<=65503||65507===e||e>=65512&&e<=65519)||!(!Mi["Small Form Variants"](e)||e>=65112&&e<=65118||e>=65123&&e<=65126)||Mi["Unified Canadian Aboriginal Syllabics"](e)||Mi["Unified Canadian Aboriginal Syllabics Extended"](e)||Mi["Vertical Forms"](e)||Mi["Yijing Hexagram Symbols"](e)||Mi["Yi Syllables"](e)||Mi["Yi Radicals"](e))))}function Ri(e){return!(Bi(e)||function(e){return!!(Mi["Latin-1 Supplement"](e)&&(167===e||169===e||174===e||177===e||188===e||189===e||190===e||215===e||247===e)||Mi["General Punctuation"](e)&&(8214===e||8224===e||8225===e||8240===e||8241===e||8251===e||8252===e||8258===e||8263===e||8264===e||8265===e||8273===e)||Mi["Letterlike Symbols"](e)||Mi["Number Forms"](e)||Mi["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||9003===e||e>=9085&&e<=9114||e>=9150&&e<=9165||9167===e||e>=9169&&e<=9179||e>=9186&&e<=9215)||Mi["Control Pictures"](e)&&9251!==e||Mi["Optical Character Recognition"](e)||Mi["Enclosed Alphanumerics"](e)||Mi["Geometric Shapes"](e)||Mi["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Mi["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Mi["CJK Symbols and Punctuation"](e)||Mi.Katakana(e)||Mi["Private Use Area"](e)||Mi["CJK Compatibility Forms"](e)||Mi["Small Form Variants"](e)||Mi["Halfwidth and Fullwidth Forms"](e)||8734===e||8756===e||8757===e||e>=9984&&e<=10087||e>=10102&&e<=10131||65532===e||65533===e)}(e))}function Fi(e){return e>=1424&&e<=2303||Mi["Arabic Presentation Forms-A"](e)||Mi["Arabic Presentation Forms-B"](e)}function Oi(e,t){return!(!t&&Fi(e)||e>=2304&&e<=3583||e>=3840&&e<=4255||Mi.Khmer(e))}function Ui(e){for(const t of e)if(Fi(t.charCodeAt(0)))return!0;return!1}const Vi="deferred",$i="loading",Ni="loaded";let ji=null,qi="unavailable",Gi=null;const Zi=function(e){e&&"string"==typeof e&&e.indexOf("NetworkError")>-1&&(qi="error"),ji&&ji(e)};function Xi(){Wi.fire(new ee("pluginStateChange",{pluginStatus:qi,pluginURL:Gi}))}const Wi=new re,Hi=function(){return qi},Ki=function(){if(qi!==Vi||!Gi)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");qi=$i,Xi(),Gi&&Z({url:Gi},(e=>{e?Zi(e):(qi=Ni,Xi())}))},Yi={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>qi===Ni||null!=Yi.applyArabicShaping,isLoading:()=>qi===$i,setState(e){if(!y())throw new Error("Cannot set the state of the rtl-text-plugin when not in the web-worker context");qi=e.pluginStatus,Gi=e.pluginURL},isParsed(){if(!y())throw new Error("rtl-text-plugin is only parsed on the worker-threads");return null!=Yi.applyArabicShaping&&null!=Yi.processBidirectionalText&&null!=Yi.processStyledBidirectionalText},getPluginURL(){if(!y())throw new Error("rtl-text-plugin url can only be queried from the worker threads");return Gi}};class Ji{constructor(e,t){this.zoom=e,t?(this.now=t.now,this.fadeDuration=t.fadeDuration,this.zoomHistory=t.zoomHistory,this.transition=t.transition):(this.now=0,this.fadeDuration=0,this.zoomHistory=new zi,this.transition={})}isSupportedScript(e){return function(e,t){for(const r of e)if(!Oi(r.charCodeAt(0),t))return!1;return!0}(e,Yi.isLoaded())}crossFadingFactor(){return 0===this.fadeDuration?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const e=this.zoom,t=e-Math.floor(e),r=this.crossFadingFactor();return e>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:t+(1-t)*r}:{fromScale:.5,toScale:1,t:1-(1-r)*t}}}class Qi{constructor(e,t){this.property=e,this.value=t,this.expression=function(e,t){if(Er(e))return new Or(e,t);if(Dr(e)){const r=Fr(e,t);if("error"===r.result)throw new Error(r.value.map((e=>`${e.key}: ${e.message}`)).join(", "));return r.value}{let r=e;return"color"===t.type&&"string"==typeof e?r=Le.parse(e):"padding"!==t.type||"number"!=typeof e&&!Array.isArray(e)||(r=Oe.parse(e)),{kind:"constant",evaluate:()=>r}}}(void 0===t?e.specification.default:t,e.specification)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(e,t,r){return this.property.possiblyEvaluate(this,e,t,r)}}class en{constructor(e){this.property=e,this.value=new Qi(e,void 0)}transitioned(e,t){return new rn(this.property,this.value,t,s({},e.transition,this.transition),e.now)}untransitioned(){return new rn(this.property,this.value,null,{},0)}}class tn{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues)}getValue(e){return p(this._values[e].value.value)}setValue(e,t){Object.prototype.hasOwnProperty.call(this._values,e)||(this._values[e]=new en(this._values[e].property)),this._values[e].value=new Qi(this._values[e].property,null===t?void 0:p(t))}getTransition(e){return p(this._values[e].transition)}setTransition(e,t){Object.prototype.hasOwnProperty.call(this._values,e)||(this._values[e]=new en(this._values[e].property)),this._values[e].transition=p(t)||void 0}serialize(){const e={};for(const t of Object.keys(this._values)){const r=this.getValue(t);void 0!==r&&(e[t]=r);const i=this.getTransition(t);void 0!==i&&(e[`${t}-transition`]=i)}return e}transitioned(e,t){const r=new nn(this._properties);for(const i of Object.keys(this._values))r._values[i]=this._values[i].transitioned(e,t._values[i]);return r}untransitioned(){const e=new nn(this._properties);for(const t of Object.keys(this._values))e._values[t]=this._values[t].untransitioned();return e}}class rn{constructor(e,t,r,i,n){this.property=e,this.value=t,this.begin=n+i.delay||0,this.end=this.begin+i.duration||0,e.specification.transition&&(i.delay||i.duration)&&(this.prior=r)}possiblyEvaluate(e,t,r){const i=e.now||0,n=this.value.possiblyEvaluate(e,t,r),a=this.prior;if(a){if(i>this.end)return this.prior=null,n;if(this.value.isDataDriven())return this.prior=null,n;if(i<this.begin)return a.possiblyEvaluate(e,t,r);{const o=(i-this.begin)/(this.end-this.begin);return this.property.interpolate(a.possiblyEvaluate(e,t,r),n,function(e){if(e<=0)return 0;if(e>=1)return 1;const t=e*e,r=t*e;return 4*(e<.5?r:3*(e-t)+r-.75)}(o))}}return n}}class nn{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,t,r){const i=new sn(this._properties);for(const n of Object.keys(this._values))i._values[n]=this._values[n].possiblyEvaluate(e,t,r);return i}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class an{constructor(e){this._properties=e,this._values=Object.create(e.defaultPropertyValues)}getValue(e){return p(this._values[e].value)}setValue(e,t){this._values[e]=new Qi(this._values[e].property,null===t?void 0:p(t))}serialize(){const e={};for(const t of Object.keys(this._values)){const r=this.getValue(t);void 0!==r&&(e[t]=r)}return e}possiblyEvaluate(e,t,r){const i=new sn(this._properties);for(const n of Object.keys(this._values))i._values[n]=this._values[n].possiblyEvaluate(e,t,r);return i}}class on{constructor(e,t,r){this.property=e,this.value=t,this.parameters=r}isConstant(){return"constant"===this.value.kind}constantOr(e){return"constant"===this.value.kind?this.value.value:e}evaluate(e,t,r,i){return this.property.evaluate(this.value,this.parameters,e,t,r,i)}}class sn{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class ln{constructor(e){this.specification=e}possiblyEvaluate(e,t){if(e.isDataDriven())throw new Error("Value should not be data driven");return e.expression.evaluate(t)}interpolate(e,t,r){const i=At[this.specification.type];return i?i(e,t,r):e}}class cn{constructor(e,t){this.specification=e,this.overrides=t}possiblyEvaluate(e,t,r,i){return new on(this,"constant"===e.expression.kind||"camera"===e.expression.kind?{kind:"constant",value:e.expression.evaluate(t,null,{},r,i)}:e.expression,t)}interpolate(e,t,r){if("constant"!==e.value.kind||"constant"!==t.value.kind)return e;if(void 0===e.value.value||void 0===t.value.value)return new on(this,{kind:"constant",value:void 0},e.parameters);const i=At[this.specification.type];return i?new on(this,{kind:"constant",value:i(e.value.value,t.value.value,r)},e.parameters):e}evaluate(e,t,r,i,n,a){return"constant"===e.kind?e.value:e.evaluate(t,r,i,n,a)}}class un extends cn{possiblyEvaluate(e,t,r,i){if(void 0===e.value)return new on(this,{kind:"constant",value:void 0},t);if("constant"===e.expression.kind){const n=e.expression.evaluate(t,null,{},r,i),a="resolvedImage"===e.property.specification.type&&"string"!=typeof n?n.name:n,o=this._calculate(a,a,a,t);return new on(this,{kind:"constant",value:o},t)}if("camera"===e.expression.kind){const r=this._calculate(e.expression.evaluate({zoom:t.zoom-1}),e.expression.evaluate({zoom:t.zoom}),e.expression.evaluate({zoom:t.zoom+1}),t);return new on(this,{kind:"constant",value:r},t)}return new on(this,e.expression,t)}evaluate(e,t,r,i,n,a){if("source"===e.kind){const o=e.evaluate(t,r,i,n,a);return this._calculate(o,o,o,t)}return"composite"===e.kind?this._calculate(e.evaluate({zoom:Math.floor(t.zoom)-1},r,i),e.evaluate({zoom:Math.floor(t.zoom)},r,i),e.evaluate({zoom:Math.floor(t.zoom)+1},r,i),t):e.value}_calculate(e,t,r,i){return i.zoom>i.zoomHistory.lastIntegerZoom?{from:e,to:t}:{from:r,to:t}}interpolate(e){return e}}class hn{constructor(e){this.specification=e}possiblyEvaluate(e,t,r,i){if(void 0!==e.value){if("constant"===e.expression.kind){const n=e.expression.evaluate(t,null,{},r,i);return this._calculate(n,n,n,t)}return this._calculate(e.expression.evaluate(new Ji(Math.floor(t.zoom-1),t)),e.expression.evaluate(new Ji(Math.floor(t.zoom),t)),e.expression.evaluate(new Ji(Math.floor(t.zoom+1),t)),t)}}_calculate(e,t,r,i){return i.zoom>i.zoomHistory.lastIntegerZoom?{from:e,to:t}:{from:r,to:t}}interpolate(e){return e}}class pn{constructor(e){this.specification=e}possiblyEvaluate(e,t,r,i){return!!e.expression.evaluate(t,null,{},r,i)}interpolate(){return!1}}class dn{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const t in e){const r=e[t];r.specification.overridable&&this.overridableProperties.push(t);const i=this.defaultPropertyValues[t]=new Qi(r,void 0),n=this.defaultTransitionablePropertyValues[t]=new en(r);this.defaultTransitioningPropertyValues[t]=n.untransitioned(),this.defaultPossiblyEvaluatedValues[t]=i.possiblyEvaluate({})}}}Ai("DataDrivenProperty",cn),Ai("DataConstantProperty",ln),Ai("CrossFadedDataDrivenProperty",un),Ai("CrossFadedProperty",hn),Ai("ColorRampProperty",pn);const fn="-transition";class mn extends re{constructor(e,t){if(super(),this.id=e.id,this.type=e.type,this._featureFilter={filter:()=>!0,needGeometry:!1},"custom"!==e.type&&(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,"background"!==e.type&&(this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter),t.layout&&(this._unevaluatedLayout=new an(t.layout)),t.paint)){this._transitionablePaint=new tn(t.paint);for(const t in e.paint)this.setPaintProperty(t,e.paint[t],{validate:!1});for(const t in e.layout)this.setLayoutProperty(t,e.layout[t],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new sn(t.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(e){return"visibility"===e?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,t,r={}){null!=t&&this._validate(wi,`layers.${this.id}.layout.${e}`,e,t,r)||("visibility"!==e?this._unevaluatedLayout.setValue(e,t):this.visibility=t)}getPaintProperty(e){return e.endsWith(fn)?this._transitionablePaint.getTransition(e.slice(0,-fn.length)):this._transitionablePaint.getValue(e)}setPaintProperty(e,t,r={}){if(null!=t&&this._validate(bi,`layers.${this.id}.paint.${e}`,e,t,r))return!1;if(e.endsWith(fn))return this._transitionablePaint.setTransition(e.slice(0,-fn.length),t||void 0),!1;{const r=this._transitionablePaint._values[e],i="cross-faded-data-driven"===r.property.specification["property-type"],n=r.value.isDataDriven(),a=r.value;this._transitionablePaint.setValue(e,t),this._handleSpecialPaintPropertyUpdate(e);const o=this._transitionablePaint._values[e].value;return o.isDataDriven()||n||i||this._handleOverridablePaintPropertyUpdate(e,a,o)}}_handleSpecialPaintPropertyUpdate(e){}_handleOverridablePaintPropertyUpdate(e,t,r){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||"none"===this.visibility}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,t){e.getCrossfadeParameters&&(this._crossfadeParameters=e.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,t)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,t)}serialize(){const e={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(e.layout=e.layout||{},e.layout.visibility=this.visibility),h(e,((e,t)=>!(void 0===e||"layout"===t&&!Object.keys(e).length||"paint"===t&&!Object.keys(e).length)))}_validate(e,t,r,i,n={}){return(!n||!1!==n.validate)&&Ti(this,e.call(xi,{key:t,layerType:this.type,objectKey:r,value:i,styleSpec:ie,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const e in this.paint._values){const t=this.paint.get(e);if(t instanceof on&&vr(t.property.specification)&&("source"===t.value.kind||"composite"===t.value.kind)&&t.value.isStateDependent)return!0}return!1}}const gn={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class yn{constructor(e,t){this._structArray=e,this._pos1=t*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class _n{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,t){return e._trim(),t&&(e.isTransferred=!0,t.push(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const t=Object.create(this.prototype);return t.arrayBuffer=e.arrayBuffer,t.length=e.length,t.capacity=e.arrayBuffer.byteLength/t.bytesPerElement,t._refreshViews(),t}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const t=this.uint8;this._refreshViews(),t&&this.uint8.set(t)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function xn(e,t=1){let r=0,i=0;return{members:e.map((e=>{const n=gn[e.type].BYTES_PER_ELEMENT,a=r=vn(r,Math.max(t,n)),o=e.components||1;return i=Math.max(i,n),r+=n*o,{name:e.name,type:e.type,components:o,offset:a}})),size:vn(r,Math.max(i,t)),alignment:t}}function vn(e,t){return Math.ceil(e/t)*t}class bn extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t){const r=this.length;return this.resize(r+1),this.emplace(r,e,t)}emplace(e,t,r){const i=2*e;return this.int16[i+0]=t,this.int16[i+1]=r,e}}bn.prototype.bytesPerElement=4,Ai("StructArrayLayout2i4",bn);class wn extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,r,i){const n=this.length;return this.resize(n+1),this.emplace(n,e,t,r,i)}emplace(e,t,r,i,n){const a=4*e;return this.int16[a+0]=t,this.int16[a+1]=r,this.int16[a+2]=i,this.int16[a+3]=n,e}}wn.prototype.bytesPerElement=8,Ai("StructArrayLayout4i8",wn);class Tn extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,r,i,n,a){const o=this.length;return this.resize(o+1),this.emplace(o,e,t,r,i,n,a)}emplace(e,t,r,i,n,a,o){const s=6*e;return this.int16[s+0]=t,this.int16[s+1]=r,this.int16[s+2]=i,this.int16[s+3]=n,this.int16[s+4]=a,this.int16[s+5]=o,e}}Tn.prototype.bytesPerElement=12,Ai("StructArrayLayout2i4i12",Tn);class En extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,r,i,n,a){const o=this.length;return this.resize(o+1),this.emplace(o,e,t,r,i,n,a)}emplace(e,t,r,i,n,a,o){const s=4*e,l=8*e;return this.int16[s+0]=t,this.int16[s+1]=r,this.uint8[l+4]=i,this.uint8[l+5]=n,this.uint8[l+6]=a,this.uint8[l+7]=o,e}}En.prototype.bytesPerElement=8,Ai("StructArrayLayout2i4ub8",En);class Sn extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t){const r=this.length;return this.resize(r+1),this.emplace(r,e,t)}emplace(e,t,r){const i=2*e;return this.float32[i+0]=t,this.float32[i+1]=r,e}}Sn.prototype.bytesPerElement=8,Ai("StructArrayLayout2f8",Sn);class An extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t,r,i,n,a,o,s,l,c){const u=this.length;return this.resize(u+1),this.emplace(u,e,t,r,i,n,a,o,s,l,c)}emplace(e,t,r,i,n,a,o,s,l,c,u){const h=10*e;return this.uint16[h+0]=t,this.uint16[h+1]=r,this.uint16[h+2]=i,this.uint16[h+3]=n,this.uint16[h+4]=a,this.uint16[h+5]=o,this.uint16[h+6]=s,this.uint16[h+7]=l,this.uint16[h+8]=c,this.uint16[h+9]=u,e}}An.prototype.bytesPerElement=20,Ai("StructArrayLayout10ui20",An);class In extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t,r,i,n,a,o,s,l,c,u,h){const p=this.length;return this.resize(p+1),this.emplace(p,e,t,r,i,n,a,o,s,l,c,u,h)}emplace(e,t,r,i,n,a,o,s,l,c,u,h,p){const d=12*e;return this.int16[d+0]=t,this.int16[d+1]=r,this.int16[d+2]=i,this.int16[d+3]=n,this.uint16[d+4]=a,this.uint16[d+5]=o,this.uint16[d+6]=s,this.uint16[d+7]=l,this.int16[d+8]=c,this.int16[d+9]=u,this.int16[d+10]=h,this.int16[d+11]=p,e}}In.prototype.bytesPerElement=24,Ai("StructArrayLayout4i4ui4i24",In);class kn extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r){const i=this.length;return this.resize(i+1),this.emplace(i,e,t,r)}emplace(e,t,r,i){const n=3*e;return this.float32[n+0]=t,this.float32[n+1]=r,this.float32[n+2]=i,e}}kn.prototype.bytesPerElement=12,Ai("StructArrayLayout3f12",kn);class Cn extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e)}emplace(e,t){return this.uint32[1*e+0]=t,e}}Cn.prototype.bytesPerElement=4,Ai("StructArrayLayout1ul4",Cn);class zn extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t,r,i,n,a,o,s,l){const c=this.length;return this.resize(c+1),this.emplace(c,e,t,r,i,n,a,o,s,l)}emplace(e,t,r,i,n,a,o,s,l,c){const u=10*e,h=5*e;return this.int16[u+0]=t,this.int16[u+1]=r,this.int16[u+2]=i,this.int16[u+3]=n,this.int16[u+4]=a,this.int16[u+5]=o,this.uint32[h+3]=s,this.uint16[u+8]=l,this.uint16[u+9]=c,e}}zn.prototype.bytesPerElement=20,Ai("StructArrayLayout6i1ul2ui20",zn);class Mn extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,r,i,n,a){const o=this.length;return this.resize(o+1),this.emplace(o,e,t,r,i,n,a)}emplace(e,t,r,i,n,a,o){const s=6*e;return this.int16[s+0]=t,this.int16[s+1]=r,this.int16[s+2]=i,this.int16[s+3]=n,this.int16[s+4]=a,this.int16[s+5]=o,e}}Mn.prototype.bytesPerElement=12,Ai("StructArrayLayout2i2i2i12",Mn);class Pn extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,r,i,n){const a=this.length;return this.resize(a+1),this.emplace(a,e,t,r,i,n)}emplace(e,t,r,i,n,a){const o=4*e,s=8*e;return this.float32[o+0]=t,this.float32[o+1]=r,this.float32[o+2]=i,this.int16[s+6]=n,this.int16[s+7]=a,e}}Pn.prototype.bytesPerElement=16,Ai("StructArrayLayout2f1f2i16",Pn);class Dn extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,i){const n=this.length;return this.resize(n+1),this.emplace(n,e,t,r,i)}emplace(e,t,r,i,n){const a=12*e,o=3*e;return this.uint8[a+0]=t,this.uint8[a+1]=r,this.float32[o+1]=i,this.float32[o+2]=n,e}}Dn.prototype.bytesPerElement=12,Ai("StructArrayLayout2ub2f12",Dn);class Ln extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t,r){const i=this.length;return this.resize(i+1),this.emplace(i,e,t,r)}emplace(e,t,r,i){const n=3*e;return this.uint16[n+0]=t,this.uint16[n+1]=r,this.uint16[n+2]=i,e}}Ln.prototype.bytesPerElement=6,Ai("StructArrayLayout3ui6",Ln);class Bn extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,i,n,a,o,s,l,c,u,h,p,d,f,m,g){const y=this.length;return this.resize(y+1),this.emplace(y,e,t,r,i,n,a,o,s,l,c,u,h,p,d,f,m,g)}emplace(e,t,r,i,n,a,o,s,l,c,u,h,p,d,f,m,g,y){const _=24*e,x=12*e,v=48*e;return this.int16[_+0]=t,this.int16[_+1]=r,this.uint16[_+2]=i,this.uint16[_+3]=n,this.uint32[x+2]=a,this.uint32[x+3]=o,this.uint32[x+4]=s,this.uint16[_+10]=l,this.uint16[_+11]=c,this.uint16[_+12]=u,this.float32[x+7]=h,this.float32[x+8]=p,this.uint8[v+36]=d,this.uint8[v+37]=f,this.uint8[v+38]=m,this.uint32[x+10]=g,this.int16[_+22]=y,e}}Bn.prototype.bytesPerElement=48,Ai("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",Bn);class Rn extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,i,n,a,o,s,l,c,u,h,p,d,f,m,g,y,_,x,v,b,w,T,E,S,A,I){const k=this.length;return this.resize(k+1),this.emplace(k,e,t,r,i,n,a,o,s,l,c,u,h,p,d,f,m,g,y,_,x,v,b,w,T,E,S,A,I)}emplace(e,t,r,i,n,a,o,s,l,c,u,h,p,d,f,m,g,y,_,x,v,b,w,T,E,S,A,I,k){const C=34*e,z=17*e;return this.int16[C+0]=t,this.int16[C+1]=r,this.int16[C+2]=i,this.int16[C+3]=n,this.int16[C+4]=a,this.int16[C+5]=o,this.int16[C+6]=s,this.int16[C+7]=l,this.uint16[C+8]=c,this.uint16[C+9]=u,this.uint16[C+10]=h,this.uint16[C+11]=p,this.uint16[C+12]=d,this.uint16[C+13]=f,this.uint16[C+14]=m,this.uint16[C+15]=g,this.uint16[C+16]=y,this.uint16[C+17]=_,this.uint16[C+18]=x,this.uint16[C+19]=v,this.uint16[C+20]=b,this.uint16[C+21]=w,this.uint16[C+22]=T,this.uint32[z+12]=E,this.float32[z+13]=S,this.float32[z+14]=A,this.float32[z+15]=I,this.float32[z+16]=k,e}}Rn.prototype.bytesPerElement=68,Ai("StructArrayLayout8i15ui1ul4f68",Rn);class Fn extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e)}emplace(e,t){return this.float32[1*e+0]=t,e}}Fn.prototype.bytesPerElement=4,Ai("StructArrayLayout1f4",Fn);class On extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,r){const i=this.length;return this.resize(i+1),this.emplace(i,e,t,r)}emplace(e,t,r,i){const n=3*e;return this.int16[n+0]=t,this.int16[n+1]=r,this.int16[n+2]=i,e}}On.prototype.bytesPerElement=6,Ai("StructArrayLayout3i6",On);class Un extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t,r){const i=this.length;return this.resize(i+1),this.emplace(i,e,t,r)}emplace(e,t,r,i){const n=4*e;return this.uint32[2*e+0]=t,this.uint16[n+2]=r,this.uint16[n+3]=i,e}}Un.prototype.bytesPerElement=8,Ai("StructArrayLayout1ul2ui8",Un);class Vn extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t){const r=this.length;return this.resize(r+1),this.emplace(r,e,t)}emplace(e,t,r){const i=2*e;return this.uint16[i+0]=t,this.uint16[i+1]=r,e}}Vn.prototype.bytesPerElement=4,Ai("StructArrayLayout2ui4",Vn);class $n extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e)}emplace(e,t){return this.uint16[1*e+0]=t,e}}$n.prototype.bytesPerElement=2,Ai("StructArrayLayout1ui2",$n);class Nn extends _n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,i){const n=this.length;return this.resize(n+1),this.emplace(n,e,t,r,i)}emplace(e,t,r,i,n){const a=4*e;return this.float32[a+0]=t,this.float32[a+1]=r,this.float32[a+2]=i,this.float32[a+3]=n,e}}Nn.prototype.bytesPerElement=16,Ai("StructArrayLayout4f16",Nn);class jn extends yn{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new S(this.anchorPointX,this.anchorPointY)}}jn.prototype.size=20;class qn extends zn{get(e){return new jn(this,e)}}Ai("CollisionBoxArray",qn);class Gn extends yn{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(e){this._structArray.uint8[this._pos1+37]=e}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(e){this._structArray.uint8[this._pos1+38]=e}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(e){this._structArray.uint32[this._pos4+10]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}Gn.prototype.size=48;class Zn extends Bn{get(e){return new Gn(this,e)}}Ai("PlacedSymbolArray",Zn);class Xn extends yn{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(e){this._structArray.uint32[this._pos4+12]=e}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get textOffset0(){return this._structArray.float32[this._pos4+14]}get textOffset1(){return this._structArray.float32[this._pos4+15]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+16]}}Xn.prototype.size=68;class Wn extends Rn{get(e){return new Xn(this,e)}}Ai("SymbolInstanceArray",Wn);class Hn extends Fn{getoffsetX(e){return this.float32[1*e+0]}}Ai("GlyphOffsetArray",Hn);class Kn extends On{getx(e){return this.int16[3*e+0]}gety(e){return this.int16[3*e+1]}gettileUnitDistanceFromAnchor(e){return this.int16[3*e+2]}}Ai("SymbolLineVertexArray",Kn);class Yn extends yn{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}Yn.prototype.size=8;class Jn extends Un{get(e){return new Yn(this,e)}}Ai("FeatureIndexArray",Jn);class Qn extends bn{}class ea extends bn{}class ta extends bn{}class ra extends Tn{}class ia extends En{}class na extends Sn{}class aa extends An{}class oa extends In{}class sa extends kn{}class la extends Cn{}class ca extends Mn{}class ua extends Dn{}class ha extends Ln{}class pa extends Vn{}const da=xn([{name:"a_pos",components:2,type:"Int16"}],4),{members:fa}=da;class ma{constructor(e=[]){this.segments=e}prepareSegment(e,t,r,i){let n=this.segments[this.segments.length-1];return e>ma.MAX_VERTEX_ARRAY_LENGTH&&f(`Max vertices per segment is ${ma.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!n||n.vertexLength+e>ma.MAX_VERTEX_ARRAY_LENGTH||n.sortKey!==i)&&(n={vertexOffset:t.length,primitiveOffset:r.length,vertexLength:0,primitiveLength:0},void 0!==i&&(n.sortKey=i),this.segments.push(n)),n}get(){return this.segments}destroy(){for(const e of this.segments)for(const t in e.vaos)e.vaos[t].destroy()}static simpleSegment(e,t,r,i){return new ma([{vertexOffset:e,primitiveOffset:t,vertexLength:r,primitiveLength:i,vaos:{},sortKey:0}])}}function ga(e,t){return 256*(e=a(Math.floor(e),0,255))+a(Math.floor(t),0,255)}ma.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Ai("SegmentVector",ma);const ya=xn([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var _a={exports:{}},xa={exports:{}};xa.exports=function(e,t){var r,i,n,a,o,s,l,c;for(i=e.length-(r=3&e.length),n=t,o=3432918353,s=461845907,c=0;c<i;)l=255&e.charCodeAt(c)|(255&e.charCodeAt(++c))<<8|(255&e.charCodeAt(++c))<<16|(255&e.charCodeAt(++c))<<24,++c,n=27492+(65535&(a=5*(65535&(n=(n^=l=(65535&(l=(l=(65535&l)*o+(((l>>>16)*o&65535)<<16)&4294967295)<<15|l>>>17))*s+(((l>>>16)*s&65535)<<16)&4294967295)<<13|n>>>19))+((5*(n>>>16)&65535)<<16)&4294967295))+((58964+(a>>>16)&65535)<<16);switch(l=0,r){case 3:l^=(255&e.charCodeAt(c+2))<<16;case 2:l^=(255&e.charCodeAt(c+1))<<8;case 1:n^=l=(65535&(l=(l=(65535&(l^=255&e.charCodeAt(c)))*o+(((l>>>16)*o&65535)<<16)&4294967295)<<15|l>>>17))*s+(((l>>>16)*s&65535)<<16)&4294967295}return n^=e.length,n=2246822507*(65535&(n^=n>>>16))+((2246822507*(n>>>16)&65535)<<16)&4294967295,n=3266489909*(65535&(n^=n>>>13))+((3266489909*(n>>>16)&65535)<<16)&4294967295,(n^=n>>>16)>>>0};var va={exports:{}};va.exports=function(e,t){for(var r,i=e.length,n=t^i,a=0;i>=4;)r=1540483477*(65535&(r=255&e.charCodeAt(a)|(255&e.charCodeAt(++a))<<8|(255&e.charCodeAt(++a))<<16|(255&e.charCodeAt(++a))<<24))+((1540483477*(r>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(r=1540483477*(65535&(r^=r>>>24))+((1540483477*(r>>>16)&65535)<<16)),i-=4,++a;switch(i){case 3:n^=(255&e.charCodeAt(a+2))<<16;case 2:n^=(255&e.charCodeAt(a+1))<<8;case 1:n=1540483477*(65535&(n^=255&e.charCodeAt(a)))+((1540483477*(n>>>16)&65535)<<16)}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0};var ba=xa.exports,wa=va.exports;_a.exports=ba,_a.exports.murmur3=ba,_a.exports.murmur2=wa;class Ta{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(e,t,r,i){this.ids.push(Ea(e)),this.positions.push(t,r,i)}getPositions(e){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const t=Ea(e);let r=0,i=this.ids.length-1;for(;r<i;){const e=r+i>>1;this.ids[e]>=t?i=e:r=e+1}const n=[];for(;this.ids[r]===t;)n.push({index:this.positions[3*r],start:this.positions[3*r+1],end:this.positions[3*r+2]}),r++;return n}static serialize(e,t){const r=new Float64Array(e.ids),i=new Uint32Array(e.positions);return Sa(r,i,0,r.length-1),t&&t.push(r.buffer,i.buffer),{ids:r,positions:i}}static deserialize(e){const t=new Ta;return t.ids=e.ids,t.positions=e.positions,t.indexed=!0,t}}function Ea(e){const t=+e;return!isNaN(t)&&t<=Number.MAX_SAFE_INTEGER?t:_a.exports(String(e))}function Sa(e,t,r,i){for(;r<i;){const n=e[r+i>>1];let a=r-1,o=i+1;for(;;){do{a++}while(e[a]<n);do{o--}while(e[o]>n);if(a>=o)break;Aa(e,a,o),Aa(t,3*a,3*o),Aa(t,3*a+1,3*o+1),Aa(t,3*a+2,3*o+2)}o-r<i-o?(Sa(e,t,r,o),r=o+1):(Sa(e,t,o+1,i),i=o)}}function Aa(e,t,r){const i=e[t];e[t]=e[r],e[r]=i}Ai("FeaturePositionMap",Ta);class Ia{constructor(e,t){this.gl=e.gl,this.location=t}}class ka extends Ia{constructor(e,t){super(e,t),this.current=0}set(e){this.current!==e&&(this.current=e,this.gl.uniform1f(this.location,e))}}class Ca extends Ia{constructor(e,t){super(e,t),this.current=[0,0,0,0]}set(e){e[0]===this.current[0]&&e[1]===this.current[1]&&e[2]===this.current[2]&&e[3]===this.current[3]||(this.current=e,this.gl.uniform4f(this.location,e[0],e[1],e[2],e[3]))}}class za extends Ia{constructor(e,t){super(e,t),this.current=Le.transparent}set(e){e.r===this.current.r&&e.g===this.current.g&&e.b===this.current.b&&e.a===this.current.a||(this.current=e,this.gl.uniform4f(this.location,e.r,e.g,e.b,e.a))}}const Ma=new Float32Array(16);function Pa(e){return[ga(255*e.r,255*e.g),ga(255*e.b,255*e.a)]}class Da{constructor(e,t,r){this.value=e,this.uniformNames=t.map((e=>`u_${e}`)),this.type=r}setUniform(e,t,r){e.set(r.constantOr(this.value))}getBinding(e,t,r){return"color"===this.type?new za(e,t):new ka(e,t)}}class La{constructor(e,t){this.uniformNames=t.map((e=>`u_${e}`)),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(e,t){this.pixelRatioFrom=t.pixelRatio,this.pixelRatioTo=e.pixelRatio,this.patternFrom=t.tlbr,this.patternTo=e.tlbr}setUniform(e,t,r,i){const n="u_pattern_to"===i?this.patternTo:"u_pattern_from"===i?this.patternFrom:"u_pixel_ratio_to"===i?this.pixelRatioTo:"u_pixel_ratio_from"===i?this.pixelRatioFrom:null;n&&e.set(n)}getBinding(e,t,r){return"u_pattern"===r.substr(0,9)?new Ca(e,t):new ka(e,t)}}class Ba{constructor(e,t,r,i){this.expression=e,this.type=r,this.maxValue=0,this.paintVertexAttributes=t.map((e=>({name:`a_${e}`,type:"Float32",components:"color"===r?2:1,offset:0}))),this.paintVertexArray=new i}populatePaintArray(e,t,r,i,n){const a=this.paintVertexArray.length,o=this.expression.evaluate(new Ji(0),t,{},i,[],n);this.paintVertexArray.resize(e),this._setPaintValue(a,e,o)}updatePaintArray(e,t,r,i){const n=this.expression.evaluate({zoom:0},r,i);this._setPaintValue(e,t,n)}_setPaintValue(e,t,r){if("color"===this.type){const i=Pa(r);for(let r=e;r<t;r++)this.paintVertexArray.emplace(r,i[0],i[1])}else{for(let i=e;i<t;i++)this.paintVertexArray.emplace(i,r);this.maxValue=Math.max(this.maxValue,Math.abs(r))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ra{constructor(e,t,r,i,n,a){this.expression=e,this.uniformNames=t.map((e=>`u_${e}_t`)),this.type=r,this.useIntegerZoom=i,this.zoom=n,this.maxValue=0,this.paintVertexAttributes=t.map((e=>({name:`a_${e}`,type:"Float32",components:"color"===r?4:2,offset:0}))),this.paintVertexArray=new a}populatePaintArray(e,t,r,i,n){const a=this.expression.evaluate(new Ji(this.zoom),t,{},i,[],n),o=this.expression.evaluate(new Ji(this.zoom+1),t,{},i,[],n),s=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(s,e,a,o)}updatePaintArray(e,t,r,i){const n=this.expression.evaluate({zoom:this.zoom},r,i),a=this.expression.evaluate({zoom:this.zoom+1},r,i);this._setPaintValue(e,t,n,a)}_setPaintValue(e,t,r,i){if("color"===this.type){const n=Pa(r),a=Pa(i);for(let r=e;r<t;r++)this.paintVertexArray.emplace(r,n[0],n[1],a[0],a[1])}else{for(let n=e;n<t;n++)this.paintVertexArray.emplace(n,r,i);this.maxValue=Math.max(this.maxValue,Math.abs(r),Math.abs(i))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,t){const r=this.useIntegerZoom?Math.floor(t.zoom):t.zoom,i=a(this.expression.interpolationFactor(r,this.zoom,this.zoom+1),0,1);e.set(i)}getBinding(e,t,r){return new ka(e,t)}}class Fa{constructor(e,t,r,i,n,a){this.expression=e,this.type=t,this.useIntegerZoom=r,this.zoom=i,this.layerId=a,this.zoomInPaintVertexArray=new n,this.zoomOutPaintVertexArray=new n}populatePaintArray(e,t,r){const i=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(e),this.zoomOutPaintVertexArray.resize(e),this._setPaintValues(i,e,t.patterns&&t.patterns[this.layerId],r)}updatePaintArray(e,t,r,i,n){this._setPaintValues(e,t,r.patterns&&r.patterns[this.layerId],n)}_setPaintValues(e,t,r,i){if(!i||!r)return;const{min:n,mid:a,max:o}=r,s=i[n],l=i[a],c=i[o];if(s&&l&&c)for(let r=e;r<t;r++)this.zoomInPaintVertexArray.emplace(r,l.tl[0],l.tl[1],l.br[0],l.br[1],s.tl[0],s.tl[1],s.br[0],s.br[1],l.pixelRatio,s.pixelRatio),this.zoomOutPaintVertexArray.emplace(r,l.tl[0],l.tl[1],l.br[0],l.br[1],c.tl[0],c.tl[1],c.br[0],c.br[1],l.pixelRatio,c.pixelRatio)}upload(e){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=e.createVertexBuffer(this.zoomInPaintVertexArray,ya.members,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=e.createVertexBuffer(this.zoomOutPaintVertexArray,ya.members,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class Oa{constructor(e,t,r){this.binders={},this._buffers=[];const i=[];for(const n in e.paint._values){if(!r(n))continue;const a=e.paint.get(n);if(!(a instanceof on&&vr(a.property.specification)))continue;const o=Va(n,e.type),s=a.value,l=a.property.specification.type,c=a.property.useIntegerZoom,u=a.property.specification["property-type"],h="cross-faded"===u||"cross-faded-data-driven"===u;if("constant"===s.kind)this.binders[n]=h?new La(s.value,o):new Da(s.value,o,l),i.push(`/u_${n}`);else if("source"===s.kind||h){const r=$a(n,l,"source");this.binders[n]=h?new Fa(s,l,c,t,r,e.id):new Ba(s,o,l,r),i.push(`/a_${n}`)}else{const e=$a(n,l,"composite");this.binders[n]=new Ra(s,o,l,c,t,e),i.push(`/z_${n}`)}}this.cacheKey=i.sort().join("")}getMaxValue(e){const t=this.binders[e];return t instanceof Ba||t instanceof Ra?t.maxValue:0}populatePaintArrays(e,t,r,i,n){for(const a in this.binders){const o=this.binders[a];(o instanceof Ba||o instanceof Ra||o instanceof Fa)&&o.populatePaintArray(e,t,r,i,n)}}setConstantPatternPositions(e,t){for(const r in this.binders){const i=this.binders[r];i instanceof La&&i.setConstantPatternPositions(e,t)}}updatePaintArrays(e,t,r,i,n){let a=!1;for(const o in e){const s=t.getPositions(o);for(const t of s){const s=r.feature(t.index);for(const r in this.binders){const l=this.binders[r];if((l instanceof Ba||l instanceof Ra||l instanceof Fa)&&!0===l.expression.isStateDependent){const c=i.paint.get(r);l.expression=c.value,l.updatePaintArray(t.start,t.end,s,e[o],n),a=!0}}}}return a}defines(){const e=[];for(const t in this.binders){const r=this.binders[t];(r instanceof Da||r instanceof La)&&e.push(...r.uniformNames.map((e=>`#define HAS_UNIFORM_${e}`)))}return e}getBinderAttributes(){const e=[];for(const t in this.binders){const r=this.binders[t];if(r instanceof Ba||r instanceof Ra)for(let t=0;t<r.paintVertexAttributes.length;t++)e.push(r.paintVertexAttributes[t].name);else if(r instanceof Fa)for(let t=0;t<ya.members.length;t++)e.push(ya.members[t].name)}return e}getBinderUniforms(){const e=[];for(const t in this.binders){const r=this.binders[t];if(r instanceof Da||r instanceof La||r instanceof Ra)for(const t of r.uniformNames)e.push(t)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e,t){const r=[];for(const i in this.binders){const n=this.binders[i];if(n instanceof Da||n instanceof La||n instanceof Ra)for(const a of n.uniformNames)if(t[a]){const o=n.getBinding(e,t[a],a);r.push({name:a,property:i,binding:o})}}return r}setUniforms(e,t,r,i){for(const{name:e,property:n,binding:a}of t)this.binders[n].setUniform(a,i,r.get(n),e)}updatePaintBuffers(e){this._buffers=[];for(const t in this.binders){const r=this.binders[t];if(e&&r instanceof Fa){const t=2===e.fromScale?r.zoomInPaintVertexBuffer:r.zoomOutPaintVertexBuffer;t&&this._buffers.push(t)}else(r instanceof Ba||r instanceof Ra)&&r.paintVertexBuffer&&this._buffers.push(r.paintVertexBuffer)}}upload(e){for(const t in this.binders){const r=this.binders[t];(r instanceof Ba||r instanceof Ra||r instanceof Fa)&&r.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const t=this.binders[e];(t instanceof Ba||t instanceof Ra||t instanceof Fa)&&t.destroy()}}}class Ua{constructor(e,t,r=(()=>!0)){this.programConfigurations={};for(const i of e)this.programConfigurations[i.id]=new Oa(i,t,r);this.needsUpload=!1,this._featureMap=new Ta,this._bufferOffset=0}populatePaintArrays(e,t,r,i,n,a){for(const r in this.programConfigurations)this.programConfigurations[r].populatePaintArrays(e,t,i,n,a);void 0!==t.id&&this._featureMap.add(t.id,r,this._bufferOffset,e),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,t,r,i){for(const n of r)this.needsUpload=this.programConfigurations[n.id].updatePaintArrays(e,this._featureMap,t,n,i)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const t in this.programConfigurations)this.programConfigurations[t].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}function Va(e,t){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[e]||[e.replace(`${t}-`,"").replace(/-/g,"_")]}function $a(e,t,r){const i={color:{source:Sn,composite:Nn},number:{source:Fn,composite:Sn}},n=function(e){return{"line-pattern":{source:aa,composite:aa},"fill-pattern":{source:aa,composite:aa},"fill-extrusion-pattern":{source:aa,composite:aa}}[e]}(e);return n&&n[r]||i[t][r]}Ai("ConstantBinder",Da),Ai("CrossFadedConstantBinder",La),Ai("SourceExpressionBinder",Ba),Ai("CrossFadedCompositeBinder",Fa),Ai("CompositeExpressionBinder",Ra),Ai("ProgramConfiguration",Oa,{omit:["_buffers"]}),Ai("ProgramConfigurationSet",Ua);var Na=8192;const ja=Math.pow(2,14)-1,qa=-ja-1;function Ga(e){const t=Na/e.extent,r=e.loadGeometry();for(let e=0;e<r.length;e++){const i=r[e];for(let e=0;e<i.length;e++){const r=i[e],n=Math.round(r.x*t),o=Math.round(r.y*t);r.x=a(n,qa,ja),r.y=a(o,qa,ja),(n<r.x||n>r.x+1||o<r.y||o>r.y+1)&&f("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return r}function Za(e,t){return{type:e.type,id:e.id,properties:e.properties,geometry:t?Ga(e):[]}}function Xa(e,t,r,i,n){e.emplaceBack(2*t+(i+1)/2,2*r+(n+1)/2)}class Wa{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.id)),this.index=e.index,this.hasPattern=!1,this.layoutVertexArray=new ea,this.indexArray=new ha,this.segments=new ma,this.programConfigurations=new Ua(e.layers,e.zoom),this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id))}populate(e,t,r){const i=this.layers[0],n=[];let a=null,o=!1;"circle"===i.type&&(a=i.layout.get("circle-sort-key"),o=!a.isConstant());for(const{feature:t,id:i,index:s,sourceLayerIndex:l}of e){const e=this.layers[0]._featureFilter.needGeometry,c=Za(t,e);if(!this.layers[0]._featureFilter.filter(new Ji(this.zoom),c,r))continue;const u=o?a.evaluate(c,{},r):void 0,h={id:i,properties:t.properties,type:t.type,sourceLayerIndex:l,index:s,geometry:e?c.geometry:Ga(t),patterns:{},sortKey:u};n.push(h)}o&&n.sort(((e,t)=>e.sortKey-t.sortKey));for(const i of n){const{geometry:n,index:a,sourceLayerIndex:o}=i,s=e[a].feature;this.addFeature(i,n,a,r),t.featureIndex.insert(s,n,a,o,this.index)}}update(e,t,r){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,t,this.stateDependentLayers,r)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,fa),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,t,r,i){for(const r of t)for(const t of r){const r=t.x,i=t.y;if(r<0||r>=Na||i<0||i>=Na)continue;const n=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),a=n.vertexLength;Xa(this.layoutVertexArray,r,i,-1,-1),Xa(this.layoutVertexArray,r,i,1,-1),Xa(this.layoutVertexArray,r,i,1,1),Xa(this.layoutVertexArray,r,i,-1,1),this.indexArray.emplaceBack(a,a+1,a+2),this.indexArray.emplaceBack(a,a+3,a+2),n.vertexLength+=4,n.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,r,{},i)}}function Ha(e,t){for(let r=0;r<e.length;r++)if(no(t,e[r]))return!0;for(let r=0;r<t.length;r++)if(no(e,t[r]))return!0;return!!Qa(e,t)}function Ka(e,t,r){return!!no(e,t)||!!to(t,e,r)}function Ya(e,t){if(1===e.length)return io(t,e[0]);for(let r=0;r<t.length;r++){const i=t[r];for(let t=0;t<i.length;t++)if(no(e,i[t]))return!0}for(let r=0;r<e.length;r++)if(io(t,e[r]))return!0;for(let r=0;r<t.length;r++)if(Qa(e,t[r]))return!0;return!1}function Ja(e,t,r){if(e.length>1){if(Qa(e,t))return!0;for(let i=0;i<t.length;i++)if(to(t[i],e,r))return!0}for(let i=0;i<e.length;i++)if(to(e[i],t,r))return!0;return!1}function Qa(e,t){if(0===e.length||0===t.length)return!1;for(let r=0;r<e.length-1;r++){const i=e[r],n=e[r+1];for(let e=0;e<t.length-1;e++)if(eo(i,n,t[e],t[e+1]))return!0}return!1}function eo(e,t,r,i){return m(e,r,i)!==m(t,r,i)&&m(e,t,r)!==m(e,t,i)}function to(e,t,r){const i=r*r;if(1===t.length)return e.distSqr(t[0])<i;for(let r=1;r<t.length;r++)if(ro(e,t[r-1],t[r])<i)return!0;return!1}function ro(e,t,r){const i=t.distSqr(r);if(0===i)return e.distSqr(t);const n=((e.x-t.x)*(r.x-t.x)+(e.y-t.y)*(r.y-t.y))/i;return e.distSqr(n<0?t:n>1?r:r.sub(t)._mult(n)._add(t))}function io(e,t){let r,i,n,a=!1;for(let o=0;o<e.length;o++){r=e[o];for(let e=0,o=r.length-1;e<r.length;o=e++)i=r[e],n=r[o],i.y>t.y!=n.y>t.y&&t.x<(n.x-i.x)*(t.y-i.y)/(n.y-i.y)+i.x&&(a=!a)}return a}function no(e,t){let r=!1;for(let i=0,n=e.length-1;i<e.length;n=i++){const a=e[i],o=e[n];a.y>t.y!=o.y>t.y&&t.x<(o.x-a.x)*(t.y-a.y)/(o.y-a.y)+a.x&&(r=!r)}return r}function ao(e,t,r){const i=r[0],n=r[2];if(e.x<i.x&&t.x<i.x||e.x>n.x&&t.x>n.x||e.y<i.y&&t.y<i.y||e.y>n.y&&t.y>n.y)return!1;const a=m(e,t,r[0]);return a!==m(e,t,r[1])||a!==m(e,t,r[2])||a!==m(e,t,r[3])}function oo(e,t,r){const i=t.paint.get(e).value;return"constant"===i.kind?i.value:r.programConfigurations.get(t.id).getMaxValue(e)}function so(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])}function lo(e,t,r,i,n){if(!t[0]&&!t[1])return e;const a=S.convert(t)._mult(n);"viewport"===r&&a._rotate(-i);const o=[];for(let t=0;t<e.length;t++)o.push(e[t].sub(a));return o}Ai("CircleBucket",Wa,{omit:["layers"]});const co=new dn({"circle-sort-key":new cn(ie.layout_circle["circle-sort-key"])});var uo={paint:new dn({"circle-radius":new cn(ie.paint_circle["circle-radius"]),"circle-color":new cn(ie.paint_circle["circle-color"]),"circle-blur":new cn(ie.paint_circle["circle-blur"]),"circle-opacity":new cn(ie.paint_circle["circle-opacity"]),"circle-translate":new ln(ie.paint_circle["circle-translate"]),"circle-translate-anchor":new ln(ie.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new ln(ie.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new ln(ie.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new cn(ie.paint_circle["circle-stroke-width"]),"circle-stroke-color":new cn(ie.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new cn(ie.paint_circle["circle-stroke-opacity"])}),layout:co},ho=1e-6,po="undefined"!=typeof Float32Array?Float32Array:Array;function fo(){var e=new po(9);return po!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function mo(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function go(e,t,r){var i=t[0],n=t[1],a=t[2],o=t[3],s=t[4],l=t[5],c=t[6],u=t[7],h=t[8],p=t[9],d=t[10],f=t[11],m=t[12],g=t[13],y=t[14],_=t[15],x=r[0],v=r[1],b=r[2],w=r[3];return e[0]=x*i+v*s+b*h+w*m,e[1]=x*n+v*l+b*p+w*g,e[2]=x*a+v*c+b*d+w*y,e[3]=x*o+v*u+b*f+w*_,e[4]=(x=r[4])*i+(v=r[5])*s+(b=r[6])*h+(w=r[7])*m,e[5]=x*n+v*l+b*p+w*g,e[6]=x*a+v*c+b*d+w*y,e[7]=x*o+v*u+b*f+w*_,e[8]=(x=r[8])*i+(v=r[9])*s+(b=r[10])*h+(w=r[11])*m,e[9]=x*n+v*l+b*p+w*g,e[10]=x*a+v*c+b*d+w*y,e[11]=x*o+v*u+b*f+w*_,e[12]=(x=r[12])*i+(v=r[13])*s+(b=r[14])*h+(w=r[15])*m,e[13]=x*n+v*l+b*p+w*g,e[14]=x*a+v*c+b*d+w*y,e[15]=x*o+v*u+b*f+w*_,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var yo,_o=go;function xo(){var e=new po(3);return po!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function vo(e,t,r){var i=new po(3);return i[0]=e,i[1]=t,i[2]=r,i}function bo(e,t,r){var i=t[0],n=t[1],a=t[2],o=t[3];return e[0]=r[0]*i+r[4]*n+r[8]*a+r[12]*o,e[1]=r[1]*i+r[5]*n+r[9]*a+r[13]*o,e[2]=r[2]*i+r[6]*n+r[10]*a+r[14]*o,e[3]=r[3]*i+r[7]*n+r[11]*a+r[15]*o,e}function wo(){var e=new po(4);return po!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function To(e,t){const r=bo([],[e.x,e.y,0,1],t);return new S(r[0]/r[3],r[1]/r[3])}xo(),yo=new po(4),po!=Float32Array&&(yo[0]=0,yo[1]=0,yo[2]=0,yo[3]=0),xo(),vo(1,0,0),vo(0,1,0),wo(),wo(),fo(),function(){var e;e=new po(2),po!=Float32Array&&(e[0]=0,e[1]=0)}();class Eo extends Wa{}Ai("HeatmapBucket",Eo,{omit:["layers"]});var So={paint:new dn({"heatmap-radius":new cn(ie.paint_heatmap["heatmap-radius"]),"heatmap-weight":new cn(ie.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new ln(ie.paint_heatmap["heatmap-intensity"]),"heatmap-color":new pn(ie.paint_heatmap["heatmap-color"]),"heatmap-opacity":new ln(ie.paint_heatmap["heatmap-opacity"])})};function Ao(e,{width:t,height:r},i,n){if(n){if(n instanceof Uint8ClampedArray)n=new Uint8Array(n.buffer);else if(n.length!==t*r*i)throw new RangeError(`mismatched image size. expected: ${n.length} but got: ${t*r*i}`)}else n=new Uint8Array(t*r*i);return e.width=t,e.height=r,e.data=n,e}function Io(e,{width:t,height:r},i){if(t===e.width&&r===e.height)return;const n=Ao({},{width:t,height:r},i);ko(e,n,{x:0,y:0},{x:0,y:0},{width:Math.min(e.width,t),height:Math.min(e.height,r)},i),e.width=t,e.height=r,e.data=n.data}function ko(e,t,r,i,n,a){if(0===n.width||0===n.height)return t;if(n.width>e.width||n.height>e.height||r.x>e.width-n.width||r.y>e.height-n.height)throw new RangeError("out of range source coordinates for image copy");if(n.width>t.width||n.height>t.height||i.x>t.width-n.width||i.y>t.height-n.height)throw new RangeError("out of range destination coordinates for image copy");const o=e.data,s=t.data;if(o===s)throw new Error("srcData equals dstData, so image is already copied");for(let l=0;l<n.height;l++){const c=((r.y+l)*e.width+r.x)*a,u=((i.y+l)*t.width+i.x)*a;for(let e=0;e<n.width*a;e++)s[u+e]=o[c+e]}return t}class Co{constructor(e,t){Ao(this,e,1,t)}resize(e){Io(this,e,1)}clone(){return new Co({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,t,r,i,n){ko(e,t,r,i,n,1)}}class zo{constructor(e,t){Ao(this,e,4,t)}resize(e){Io(this,e,4)}replace(e,t){t?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new zo({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,t,r,i,n){ko(e,t,r,i,n,4)}}function Mo(e){const t={},r=e.resolution||256,i=e.clips?e.clips.length:1,n=e.image||new zo({width:r,height:i});if(Math.log(r)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${r}`);const a=(r,i,a)=>{t[e.evaluationKey]=a;const o=e.expression.evaluate(t);n.data[r+i+0]=Math.floor(255*o.r/o.a),n.data[r+i+1]=Math.floor(255*o.g/o.a),n.data[r+i+2]=Math.floor(255*o.b/o.a),n.data[r+i+3]=Math.floor(255*o.a)};if(e.clips)for(let t=0,n=0;t<i;++t,n+=4*r)for(let i=0,o=0;i<r;i++,o+=4){const s=i/(r-1),{start:l,end:c}=e.clips[t];a(n,o,l*(1-s)+c*s)}else for(let e=0,t=0;e<r;e++,t+=4)a(0,t,e/(r-1));return n}Ai("AlphaImage",Co),Ai("RGBAImage",zo);var Po={paint:new dn({"hillshade-illumination-direction":new ln(ie.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new ln(ie.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new ln(ie.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new ln(ie.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new ln(ie.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new ln(ie.paint_hillshade["hillshade-accent-color"])})};const Do=xn([{name:"a_pos",components:2,type:"Int16"}],4),{members:Lo}=Do;var Bo={exports:{}};function Ro(e,t,r){r=r||2;var i,n,a,o,s,l,c,u=t&&t.length,h=u?t[0]*r:e.length,p=Fo(e,0,h,r,!0),d=[];if(!p||p.next===p.prev)return d;if(u&&(p=function(e,t,r,i){var n,a,o,s=[];for(n=0,a=t.length;n<a;n++)(o=Fo(e,t[n]*i,n<a-1?t[n+1]*i:e.length,i,!1))===o.next&&(o.steiner=!0),s.push(Wo(o));for(s.sort(qo),n=0;n<s.length;n++)r=Go(s[n],r);return r}(e,t,p,r)),e.length>80*r){i=a=e[0],n=o=e[1];for(var f=r;f<h;f+=r)(s=e[f])<i&&(i=s),(l=e[f+1])<n&&(n=l),s>a&&(a=s),l>o&&(o=l);c=0!==(c=Math.max(a-i,o-n))?32767/c:0}return Uo(p,d,r,i,n,c,0),d}function Fo(e,t,r,i,n){var a,o;if(n===ss(e,t,r,i)>0)for(a=t;a<r;a+=i)o=ns(a,e[a],e[a+1],o);else for(a=r-i;a>=t;a-=i)o=ns(a,e[a],e[a+1],o);return o&&Jo(o,o.next)&&(as(o),o=o.next),o}function Oo(e,t){if(!e)return e;t||(t=e);var r,i=e;do{if(r=!1,i.steiner||!Jo(i,i.next)&&0!==Yo(i.prev,i,i.next))i=i.next;else{if(as(i),(i=t=i.prev)===i.next)break;r=!0}}while(r||i!==t);return t}function Uo(e,t,r,i,n,a,o){if(e){!o&&a&&function(e,t,r,i){var n=e;do{0===n.z&&(n.z=Xo(n.x,n.y,t,r,i)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==e);n.prevZ.nextZ=null,n.prevZ=null,function(e){var t,r,i,n,a,o,s,l,c=1;do{for(r=e,e=null,a=null,o=0;r;){for(o++,i=r,s=0,t=0;t<c&&(s++,i=i.nextZ);t++);for(l=c;s>0||l>0&&i;)0!==s&&(0===l||!i||r.z<=i.z)?(n=r,r=r.nextZ,s--):(n=i,i=i.nextZ,l--),a?a.nextZ=n:e=n,n.prevZ=a,a=n;r=i}a.nextZ=null,c*=2}while(o>1)}(n)}(e,i,n,a);for(var s,l,c=e;e.prev!==e.next;)if(s=e.prev,l=e.next,a?$o(e,i,n,a):Vo(e))t.push(s.i/r|0),t.push(e.i/r|0),t.push(l.i/r|0),as(e),e=l.next,c=l.next;else if((e=l)===c){o?1===o?Uo(e=No(Oo(e),t,r),t,r,i,n,a,2):2===o&&jo(e,t,r,i,n,a):Uo(Oo(e),t,r,i,n,a,1);break}}}function Vo(e){var t=e.prev,r=e,i=e.next;if(Yo(t,r,i)>=0)return!1;for(var n=t.x,a=r.x,o=i.x,s=t.y,l=r.y,c=i.y,u=n<a?n<o?n:o:a<o?a:o,h=s<l?s<c?s:c:l<c?l:c,p=n>a?n>o?n:o:a>o?a:o,d=s>l?s>c?s:c:l>c?l:c,f=i.next;f!==t;){if(f.x>=u&&f.x<=p&&f.y>=h&&f.y<=d&&Ho(n,s,a,l,o,c,f.x,f.y)&&Yo(f.prev,f,f.next)>=0)return!1;f=f.next}return!0}function $o(e,t,r,i){var n=e.prev,a=e,o=e.next;if(Yo(n,a,o)>=0)return!1;for(var s=n.x,l=a.x,c=o.x,u=n.y,h=a.y,p=o.y,d=s<l?s<c?s:c:l<c?l:c,f=u<h?u<p?u:p:h<p?h:p,m=s>l?s>c?s:c:l>c?l:c,g=u>h?u>p?u:p:h>p?h:p,y=Xo(d,f,t,r,i),_=Xo(m,g,t,r,i),x=e.prevZ,v=e.nextZ;x&&x.z>=y&&v&&v.z<=_;){if(x.x>=d&&x.x<=m&&x.y>=f&&x.y<=g&&x!==n&&x!==o&&Ho(s,u,l,h,c,p,x.x,x.y)&&Yo(x.prev,x,x.next)>=0)return!1;if(x=x.prevZ,v.x>=d&&v.x<=m&&v.y>=f&&v.y<=g&&v!==n&&v!==o&&Ho(s,u,l,h,c,p,v.x,v.y)&&Yo(v.prev,v,v.next)>=0)return!1;v=v.nextZ}for(;x&&x.z>=y;){if(x.x>=d&&x.x<=m&&x.y>=f&&x.y<=g&&x!==n&&x!==o&&Ho(s,u,l,h,c,p,x.x,x.y)&&Yo(x.prev,x,x.next)>=0)return!1;x=x.prevZ}for(;v&&v.z<=_;){if(v.x>=d&&v.x<=m&&v.y>=f&&v.y<=g&&v!==n&&v!==o&&Ho(s,u,l,h,c,p,v.x,v.y)&&Yo(v.prev,v,v.next)>=0)return!1;v=v.nextZ}return!0}function No(e,t,r){var i=e;do{var n=i.prev,a=i.next.next;!Jo(n,a)&&Qo(n,i,i.next,a)&&rs(n,a)&&rs(a,n)&&(t.push(n.i/r|0),t.push(i.i/r|0),t.push(a.i/r|0),as(i),as(i.next),i=e=a),i=i.next}while(i!==e);return Oo(i)}function jo(e,t,r,i,n,a){var o=e;do{for(var s=o.next.next;s!==o.prev;){if(o.i!==s.i&&Ko(o,s)){var l=is(o,s);return o=Oo(o,o.next),l=Oo(l,l.next),Uo(o,t,r,i,n,a,0),void Uo(l,t,r,i,n,a,0)}s=s.next}o=o.next}while(o!==e)}function qo(e,t){return e.x-t.x}function Go(e,t){var r=function(e,t){var r,i=t,n=e.x,a=e.y,o=-1/0;do{if(a<=i.y&&a>=i.next.y&&i.next.y!==i.y){var s=i.x+(a-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(s<=n&&s>o&&(o=s,r=i.x<i.next.x?i:i.next,s===n))return r}i=i.next}while(i!==t);if(!r)return null;var l,c=r,u=r.x,h=r.y,p=1/0;i=r;do{n>=i.x&&i.x>=u&&n!==i.x&&Ho(a<h?n:o,a,u,h,a<h?o:n,a,i.x,i.y)&&(l=Math.abs(a-i.y)/(n-i.x),rs(i,e)&&(l<p||l===p&&(i.x>r.x||i.x===r.x&&Zo(r,i)))&&(r=i,p=l)),i=i.next}while(i!==c);return r}(e,t);if(!r)return t;var i=is(r,e);return Oo(i,i.next),Oo(r,r.next)}function Zo(e,t){return Yo(e.prev,e,t.prev)<0&&Yo(t.next,e,e.next)<0}function Xo(e,t,r,i,n){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*n|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*n|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Wo(e){var t=e,r=e;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==e);return r}function Ho(e,t,r,i,n,a,o,s){return(n-o)*(t-s)>=(e-o)*(a-s)&&(e-o)*(i-s)>=(r-o)*(t-s)&&(r-o)*(a-s)>=(n-o)*(i-s)}function Ko(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&Qo(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}(e,t)&&(rs(e,t)&&rs(t,e)&&function(e,t){var r=e,i=!1,n=(e.x+t.x)/2,a=(e.y+t.y)/2;do{r.y>a!=r.next.y>a&&r.next.y!==r.y&&n<(r.next.x-r.x)*(a-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==e);return i}(e,t)&&(Yo(e.prev,e,t.prev)||Yo(e,t.prev,t))||Jo(e,t)&&Yo(e.prev,e,e.next)>0&&Yo(t.prev,t,t.next)>0)}function Yo(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function Jo(e,t){return e.x===t.x&&e.y===t.y}function Qo(e,t,r,i){var n=ts(Yo(e,t,r)),a=ts(Yo(e,t,i)),o=ts(Yo(r,i,e)),s=ts(Yo(r,i,t));return n!==a&&o!==s||!(0!==n||!es(e,r,t))||!(0!==a||!es(e,i,t))||!(0!==o||!es(r,e,i))||!(0!==s||!es(r,t,i))}function es(e,t,r){return t.x<=Math.max(e.x,r.x)&&t.x>=Math.min(e.x,r.x)&&t.y<=Math.max(e.y,r.y)&&t.y>=Math.min(e.y,r.y)}function ts(e){return e>0?1:e<0?-1:0}function rs(e,t){return Yo(e.prev,e,e.next)<0?Yo(e,t,e.next)>=0&&Yo(e,e.prev,t)>=0:Yo(e,t,e.prev)<0||Yo(e,e.next,t)<0}function is(e,t){var r=new os(e.i,e.x,e.y),i=new os(t.i,t.x,t.y),n=e.next,a=t.prev;return e.next=t,t.prev=e,r.next=n,n.prev=r,i.next=r,r.prev=i,a.next=i,i.prev=a,i}function ns(e,t,r,i){var n=new os(e,t,r);return i?(n.next=i.next,n.prev=i,i.next.prev=n,i.next=n):(n.prev=n,n.next=n),n}function as(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function os(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function ss(e,t,r,i){for(var n=0,a=t,o=r-i;a<r;a+=i)n+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return n}function ls(e,t,r,i,n){cs(e,t,r||0,i||e.length-1,n||hs)}function cs(e,t,r,i,n){for(;i>r;){if(i-r>600){var a=i-r+1,o=t-r+1,s=Math.log(a),l=.5*Math.exp(2*s/3),c=.5*Math.sqrt(s*l*(a-l)/a)*(o-a/2<0?-1:1);cs(e,t,Math.max(r,Math.floor(t-o*l/a+c)),Math.min(i,Math.floor(t+(a-o)*l/a+c)),n)}var u=e[t],h=r,p=i;for(us(e,r,t),n(e[i],u)>0&&us(e,r,i);h<p;){for(us(e,h,p),h++,p--;n(e[h],u)<0;)h++;for(;n(e[p],u)>0;)p--}0===n(e[r],u)?us(e,r,p):us(e,++p,i),p<=t&&(r=p+1),t<=p&&(i=p-1)}}function us(e,t,r){var i=e[t];e[t]=e[r],e[r]=i}function hs(e,t){return e<t?-1:e>t?1:0}function ps(e,t){const r=e.length;if(r<=1)return[e];const i=[];let n,a;for(let t=0;t<r;t++){const r=g(e[t]);0!==r&&(e[t].area=Math.abs(r),void 0===a&&(a=r<0),a===r<0?(n&&i.push(n),n=[e[t]]):n.push(e[t]))}if(n&&i.push(n),t>1)for(let e=0;e<i.length;e++)i[e].length<=t||(ls(i[e],t,1,i[e].length-1,ds),i[e]=i[e].slice(0,t));return i}function ds(e,t){return t.area-e.area}function fs(e,t,r){const i=r.patternDependencies;let n=!1;for(const r of t){const t=r.paint.get(`${e}-pattern`);t.isConstant()||(n=!0);const a=t.constantOr(null);a&&(n=!0,i[a.to]=!0,i[a.from]=!0)}return n}function ms(e,t,r,i,n){const a=n.patternDependencies;for(const o of t){const t=o.paint.get(`${e}-pattern`).value;if("constant"!==t.kind){let e=t.evaluate({zoom:i-1},r,{},n.availableImages),s=t.evaluate({zoom:i},r,{},n.availableImages),l=t.evaluate({zoom:i+1},r,{},n.availableImages);e=e&&e.name?e.name:e,s=s&&s.name?s.name:s,l=l&&l.name?l.name:l,a[e]=!0,a[s]=!0,a[l]=!0,r.patterns[o.id]={min:e,mid:s,max:l}}}return r}Bo.exports=Ro,Bo.exports.default=Ro,Ro.deviation=function(e,t,r,i){var n=t&&t.length,a=Math.abs(ss(e,0,n?t[0]*r:e.length,r));if(n)for(var o=0,s=t.length;o<s;o++)a-=Math.abs(ss(e,t[o]*r,o<s-1?t[o+1]*r:e.length,r));var l=0;for(o=0;o<i.length;o+=3){var c=i[o]*r,u=i[o+1]*r,h=i[o+2]*r;l+=Math.abs((e[c]-e[h])*(e[u+1]-e[c+1])-(e[c]-e[u])*(e[h+1]-e[c+1]))}return 0===a&&0===l?0:Math.abs((l-a)/a)},Ro.flatten=function(e){for(var t=e[0][0].length,r={vertices:[],holes:[],dimensions:t},i=0,n=0;n<e.length;n++){for(var a=0;a<e[n].length;a++)for(var o=0;o<t;o++)r.vertices.push(e[n][a][o]);n>0&&r.holes.push(i+=e[n-1].length)}return r};class gs{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.id)),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new ta,this.indexArray=new ha,this.indexArray2=new pa,this.programConfigurations=new Ua(e.layers,e.zoom),this.segments=new ma,this.segments2=new ma,this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id))}populate(e,t,r){this.hasPattern=fs("fill",this.layers,t);const i=this.layers[0].layout.get("fill-sort-key"),n=!i.isConstant(),a=[];for(const{feature:o,id:s,index:l,sourceLayerIndex:c}of e){const e=this.layers[0]._featureFilter.needGeometry,u=Za(o,e);if(!this.layers[0]._featureFilter.filter(new Ji(this.zoom),u,r))continue;const h=n?i.evaluate(u,{},r,t.availableImages):void 0,p={id:s,properties:o.properties,type:o.type,sourceLayerIndex:c,index:l,geometry:e?u.geometry:Ga(o),patterns:{},sortKey:h};a.push(p)}n&&a.sort(((e,t)=>e.sortKey-t.sortKey));for(const i of a){const{geometry:n,index:a,sourceLayerIndex:o}=i;if(this.hasPattern){const e=ms("fill",this.layers,i,this.zoom,t);this.patternFeatures.push(e)}else this.addFeature(i,n,a,r,{});t.featureIndex.insert(e[a].feature,n,a,o,this.index)}}update(e,t,r){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,t,this.stateDependentLayers,r)}addFeatures(e,t,r){for(const e of this.patternFeatures)this.addFeature(e,e.geometry,e.index,t,r)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Lo),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.indexBuffer2=e.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(e,t,r,i,n){for(const e of ps(t,500)){let t=0;for(const r of e)t+=r.length;const r=this.segments.prepareSegment(t,this.layoutVertexArray,this.indexArray),i=r.vertexLength,n=[],a=[];for(const t of e){if(0===t.length)continue;t!==e[0]&&a.push(n.length/2);const r=this.segments2.prepareSegment(t.length,this.layoutVertexArray,this.indexArray2),i=r.vertexLength;this.layoutVertexArray.emplaceBack(t[0].x,t[0].y),this.indexArray2.emplaceBack(i+t.length-1,i),n.push(t[0].x),n.push(t[0].y);for(let e=1;e<t.length;e++)this.layoutVertexArray.emplaceBack(t[e].x,t[e].y),this.indexArray2.emplaceBack(i+e-1,i+e),n.push(t[e].x),n.push(t[e].y);r.vertexLength+=t.length,r.primitiveLength+=t.length}const o=Bo.exports(n,a);for(let e=0;e<o.length;e+=3)this.indexArray.emplaceBack(i+o[e],i+o[e+1],i+o[e+2]);r.vertexLength+=t,r.primitiveLength+=o.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,r,n,i)}}Ai("FillBucket",gs,{omit:["layers","patternFeatures"]});const ys=new dn({"fill-sort-key":new cn(ie.layout_fill["fill-sort-key"])});var _s={paint:new dn({"fill-antialias":new ln(ie.paint_fill["fill-antialias"]),"fill-opacity":new cn(ie.paint_fill["fill-opacity"]),"fill-color":new cn(ie.paint_fill["fill-color"]),"fill-outline-color":new cn(ie.paint_fill["fill-outline-color"]),"fill-translate":new ln(ie.paint_fill["fill-translate"]),"fill-translate-anchor":new ln(ie.paint_fill["fill-translate-anchor"]),"fill-pattern":new un(ie.paint_fill["fill-pattern"])}),layout:ys};const xs=xn([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),vs=xn([{name:"a_centroid",components:2,type:"Int16"}],4),{members:bs}=xs;var ws={},Ts=S,Es=Ss;function Ss(e,t,r,i,n){this.properties={},this.extent=r,this.type=0,this._pbf=e,this._geometry=-1,this._keys=i,this._values=n,e.readFields(As,this,t)}function As(e,t,r){1==e?t.id=r.readVarint():2==e?function(e,t){for(var r=e.readVarint()+e.pos;e.pos<r;){var i=t._keys[e.readVarint()],n=t._values[e.readVarint()];t.properties[i]=n}}(r,t):3==e?t.type=r.readVarint():4==e&&(t._geometry=r.pos)}function Is(e){for(var t,r,i=0,n=0,a=e.length,o=a-1;n<a;o=n++)i+=((r=e[o]).x-(t=e[n]).x)*(t.y+r.y);return i}Ss.types=["Unknown","Point","LineString","Polygon"],Ss.prototype.loadGeometry=function(){var e=this._pbf;e.pos=this._geometry;for(var t,r=e.readVarint()+e.pos,i=1,n=0,a=0,o=0,s=[];e.pos<r;){if(n<=0){var l=e.readVarint();i=7&l,n=l>>3}if(n--,1===i||2===i)a+=e.readSVarint(),o+=e.readSVarint(),1===i&&(t&&s.push(t),t=[]),t.push(new Ts(a,o));else{if(7!==i)throw new Error("unknown command "+i);t&&t.push(t[0].clone())}}return t&&s.push(t),s},Ss.prototype.bbox=function(){var e=this._pbf;e.pos=this._geometry;for(var t=e.readVarint()+e.pos,r=1,i=0,n=0,a=0,o=1/0,s=-1/0,l=1/0,c=-1/0;e.pos<t;){if(i<=0){var u=e.readVarint();r=7&u,i=u>>3}if(i--,1===r||2===r)(n+=e.readSVarint())<o&&(o=n),n>s&&(s=n),(a+=e.readSVarint())<l&&(l=a),a>c&&(c=a);else if(7!==r)throw new Error("unknown command "+r)}return[o,l,s,c]},Ss.prototype.toGeoJSON=function(e,t,r){var i,n,a=this.extent*Math.pow(2,r),o=this.extent*e,s=this.extent*t,l=this.loadGeometry(),c=Ss.types[this.type];function u(e){for(var t=0;t<e.length;t++){var r=e[t];e[t]=[360*(r.x+o)/a-180,360/Math.PI*Math.atan(Math.exp((180-360*(r.y+s)/a)*Math.PI/180))-90]}}switch(this.type){case 1:var h=[];for(i=0;i<l.length;i++)h[i]=l[i][0];u(l=h);break;case 2:for(i=0;i<l.length;i++)u(l[i]);break;case 3:for(l=function(e){var t=e.length;if(t<=1)return[e];for(var r,i,n=[],a=0;a<t;a++){var o=Is(e[a]);0!==o&&(void 0===i&&(i=o<0),i===o<0?(r&&n.push(r),r=[e[a]]):r.push(e[a]))}return r&&n.push(r),n}(l),i=0;i<l.length;i++)for(n=0;n<l[i].length;n++)u(l[i][n])}1===l.length?l=l[0]:c="Multi"+c;var p={type:"Feature",geometry:{type:c,coordinates:l},properties:this.properties};return"id"in this&&(p.id=this.id),p};var ks=Es,Cs=zs;function zs(e,t){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(Ms,this,t),this.length=this._features.length}function Ms(e,t,r){15===e?t.version=r.readVarint():1===e?t.name=r.readString():5===e?t.extent=r.readVarint():2===e?t._features.push(r.pos):3===e?t._keys.push(r.readString()):4===e&&t._values.push(function(e){for(var t=null,r=e.readVarint()+e.pos;e.pos<r;){var i=e.readVarint()>>3;t=1===i?e.readString():2===i?e.readFloat():3===i?e.readDouble():4===i?e.readVarint64():5===i?e.readVarint():6===i?e.readSVarint():7===i?e.readBoolean():null}return t}(r))}zs.prototype.feature=function(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];var t=this._pbf.readVarint()+this._pbf.pos;return new ks(this._pbf,t,this.extent,this._keys,this._values)};var Ps=Cs;function Ds(e,t,r){if(3===e){var i=new Ps(r,r.readVarint()+r.pos);i.length&&(t[i.name]=i)}}ws.VectorTile=function(e,t){this.layers=e.readFields(Ds,{},t)},ws.VectorTileFeature=Es,ws.VectorTileLayer=Cs;const Ls=ws.VectorTileFeature.types,Bs=Math.pow(2,13);function Rs(e,t,r,i,n,a,o,s){e.emplaceBack(t,r,2*Math.floor(i*Bs)+o,n*Bs*2,a*Bs*2,Math.round(s))}class Fs{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.id)),this.index=e.index,this.hasPattern=!1,this.layoutVertexArray=new ra,this.centroidVertexArray=new Qn,this.indexArray=new ha,this.programConfigurations=new Ua(e.layers,e.zoom),this.segments=new ma,this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id))}populate(e,t,r){this.features=[],this.hasPattern=fs("fill-extrusion",this.layers,t);for(const{feature:i,id:n,index:a,sourceLayerIndex:o}of e){const e=this.layers[0]._featureFilter.needGeometry,s=Za(i,e);if(!this.layers[0]._featureFilter.filter(new Ji(this.zoom),s,r))continue;const l={id:n,sourceLayerIndex:o,index:a,geometry:e?s.geometry:Ga(i),properties:i.properties,type:i.type,patterns:{}};this.hasPattern?this.features.push(ms("fill-extrusion",this.layers,l,this.zoom,t)):this.addFeature(l,l.geometry,a,r,{}),t.featureIndex.insert(i,l.geometry,a,o,this.index,!0)}}addFeatures(e,t,r){for(const e of this.features){const{geometry:i}=e;this.addFeature(e,i,e.index,t,r)}}update(e,t,r){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,t,this.stateDependentLayers,r)}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.centroidVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,bs),this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,vs.members,!0),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(e,t,r,i,n){const a={x:0,y:0,vertexCount:0};for(const r of ps(t,500)){let t=0;for(const e of r)t+=e.length;let i=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);for(const e of r){if(0===e.length)continue;if(Us(e))continue;let t=0;for(let r=0;r<e.length;r++){const n=e[r];if(r>=1){const o=e[r-1];if(!Os(n,o)){i.vertexLength+4>ma.MAX_VERTEX_ARRAY_LENGTH&&(i=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const e=n.sub(o)._perp()._unit(),r=o.dist(n);t+r>32768&&(t=0),Rs(this.layoutVertexArray,n.x,n.y,e.x,e.y,0,0,t),Rs(this.layoutVertexArray,n.x,n.y,e.x,e.y,0,1,t),a.x+=2*n.x,a.y+=2*n.y,a.vertexCount+=2,t+=r,Rs(this.layoutVertexArray,o.x,o.y,e.x,e.y,0,0,t),Rs(this.layoutVertexArray,o.x,o.y,e.x,e.y,0,1,t),a.x+=2*o.x,a.y+=2*o.y,a.vertexCount+=2;const s=i.vertexLength;this.indexArray.emplaceBack(s,s+2,s+1),this.indexArray.emplaceBack(s+1,s+2,s+3),i.vertexLength+=4,i.primitiveLength+=2}}}}if(i.vertexLength+t>ma.MAX_VERTEX_ARRAY_LENGTH&&(i=this.segments.prepareSegment(t,this.layoutVertexArray,this.indexArray)),"Polygon"!==Ls[e.type])continue;const n=[],o=[],s=i.vertexLength;for(const e of r)if(0!==e.length){e!==r[0]&&o.push(n.length/2);for(let t=0;t<e.length;t++){const r=e[t];Rs(this.layoutVertexArray,r.x,r.y,0,0,1,1,0),a.x+=r.x,a.y+=r.y,a.vertexCount+=1,n.push(r.x),n.push(r.y)}}const l=Bo.exports(n,o);for(let e=0;e<l.length;e+=3)this.indexArray.emplaceBack(s+l[e],s+l[e+2],s+l[e+1]);i.primitiveLength+=l.length/3,i.vertexLength+=t}for(let e=0;e<a.vertexCount;e++)this.centroidVertexArray.emplaceBack(Math.floor(a.x/a.vertexCount),Math.floor(a.y/a.vertexCount));this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,r,n,i)}}function Os(e,t){return e.x===t.x&&(e.x<0||e.x>Na)||e.y===t.y&&(e.y<0||e.y>Na)}function Us(e){return e.every((e=>e.x<0))||e.every((e=>e.x>Na))||e.every((e=>e.y<0))||e.every((e=>e.y>Na))}Ai("FillExtrusionBucket",Fs,{omit:["layers","features"]});var Vs={paint:new dn({"fill-extrusion-opacity":new ln(ie["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new cn(ie["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new ln(ie["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new ln(ie["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new un(ie["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new cn(ie["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new cn(ie["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new ln(ie["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})};function $s(e,t){return e.x*t.x+e.y*t.y}function Ns(e,t){if(1===e.length){let r=0;const i=t[r++];let n;for(;!n||i.equals(n);)if(n=t[r++],!n)return 1/0;for(;r<t.length;r++){const a=t[r],o=e[0],s=n.sub(i),l=a.sub(i),c=o.sub(i),u=$s(s,s),h=$s(s,l),p=$s(l,l),d=$s(c,s),f=$s(c,l),m=u*p-h*h,g=(p*d-h*f)/m,y=(u*f-h*d)/m,_=i.z*(1-g-y)+n.z*g+a.z*y;if(isFinite(_))return _}return 1/0}{let e=1/0;for(const r of t)e=Math.min(e,r.z);return e}}const js=xn([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:qs}=js,Gs=xn([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:Zs}=Gs,Xs=ws.VectorTileFeature.types,Ws=Math.cos(Math.PI/180*37.5),Hs=Math.pow(2,14)/.5;class Ks{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.id)),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((e=>{this.gradients[e.id]={}})),this.layoutVertexArray=new ia,this.layoutVertexArray2=new na,this.indexArray=new ha,this.programConfigurations=new Ua(e.layers,e.zoom),this.segments=new ma,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id))}populate(e,t,r){this.hasPattern=fs("line",this.layers,t);const i=this.layers[0].layout.get("line-sort-key"),n=!i.isConstant(),a=[];for(const{feature:t,id:o,index:s,sourceLayerIndex:l}of e){const e=this.layers[0]._featureFilter.needGeometry,c=Za(t,e);if(!this.layers[0]._featureFilter.filter(new Ji(this.zoom),c,r))continue;const u=n?i.evaluate(c,{},r):void 0,h={id:o,properties:t.properties,type:t.type,sourceLayerIndex:l,index:s,geometry:e?c.geometry:Ga(t),patterns:{},sortKey:u};a.push(h)}n&&a.sort(((e,t)=>e.sortKey-t.sortKey));for(const i of a){const{geometry:n,index:a,sourceLayerIndex:o}=i;if(this.hasPattern){const e=ms("line",this.layers,i,this.zoom,t);this.patternFeatures.push(e)}else this.addFeature(i,n,a,r,{});t.featureIndex.insert(e[a].feature,n,a,o,this.index)}}update(e,t,r){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,t,this.stateDependentLayers,r)}addFeatures(e,t,r){for(const e of this.patternFeatures)this.addFeature(e,e.geometry,e.index,t,r)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,Zs)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,qs),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&Object.prototype.hasOwnProperty.call(e.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(e.properties,"mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,t,r,i,n){const a=this.layers[0].layout,o=a.get("line-join").evaluate(e,{}),s=a.get("line-cap"),l=a.get("line-miter-limit"),c=a.get("line-round-limit");this.lineClips=this.lineFeatureClips(e);for(const r of t)this.addLine(r,e,o,s,l,c);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,r,n,i)}addLine(e,t,r,i,n,a){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let t=0;t<e.length-1;t++)this.totalDistance+=e[t].dist(e[t+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const o="Polygon"===Xs[t.type];let s=e.length;for(;s>=2&&e[s-1].equals(e[s-2]);)s--;let l=0;for(;l<s-1&&e[l].equals(e[l+1]);)l++;if(s<(o?3:2))return;"bevel"===r&&(n=1.05);const c=this.overscaling<=16?122880/(512*this.overscaling):0,u=this.segments.prepareSegment(10*s,this.layoutVertexArray,this.indexArray);let h,p,d,f,m;this.e1=this.e2=-1,o&&(h=e[s-2],m=e[l].sub(h)._unit()._perp());for(let t=l;t<s;t++){if(d=t===s-1?o?e[l+1]:void 0:e[t+1],d&&e[t].equals(d))continue;m&&(f=m),h&&(p=h),h=e[t],m=d?d.sub(h)._unit()._perp():f,f=f||m;let g=f.add(m);0===g.x&&0===g.y||g._unit();const y=f.x*m.x+f.y*m.y,_=g.x*m.x+g.y*m.y,x=0!==_?1/_:1/0,v=2*Math.sqrt(2-2*_),b=_<Ws&&p&&d,w=f.x*m.y-f.y*m.x>0;if(b&&t>l){const e=h.dist(p);if(e>2*c){const t=h.sub(h.sub(p)._mult(c/e)._round());this.updateDistance(p,t),this.addCurrentVertex(t,f,0,0,u),p=t}}const T=p&&d;let E=T?r:o?"butt":i;if(T&&"round"===E&&(x<a?E="miter":x<=2&&(E="fakeround")),"miter"===E&&x>n&&(E="bevel"),"bevel"===E&&(x>2&&(E="flipbevel"),x<n&&(E="miter")),p&&this.updateDistance(p,h),"miter"===E)g._mult(x),this.addCurrentVertex(h,g,0,0,u);else if("flipbevel"===E){if(x>100)g=m.mult(-1);else{const e=x*f.add(m).mag()/f.sub(m).mag();g._perp()._mult(e*(w?-1:1))}this.addCurrentVertex(h,g,0,0,u),this.addCurrentVertex(h,g.mult(-1),0,0,u)}else if("bevel"===E||"fakeround"===E){const e=-Math.sqrt(x*x-1),t=w?e:0,r=w?0:e;if(p&&this.addCurrentVertex(h,f,t,r,u),"fakeround"===E){const e=Math.round(180*v/Math.PI/20);for(let t=1;t<e;t++){let r=t/e;if(.5!==r){const e=r-.5;r+=r*e*(r-1)*((1.0904+y*(y*(3.55645-1.43519*y)-3.2452))*e*e+(.848013+y*(.215638*y-1.06021)))}const i=m.sub(f)._mult(r)._add(f)._unit()._mult(w?-1:1);this.addHalfVertex(h,i.x,i.y,!1,w,0,u)}}d&&this.addCurrentVertex(h,m,-t,-r,u)}else if("butt"===E)this.addCurrentVertex(h,g,0,0,u);else if("square"===E){const e=p?1:-1;this.addCurrentVertex(h,g,e,e,u)}else"round"===E&&(p&&(this.addCurrentVertex(h,f,0,0,u),this.addCurrentVertex(h,f,1,1,u,!0)),d&&(this.addCurrentVertex(h,m,-1,-1,u,!0),this.addCurrentVertex(h,m,0,0,u)));if(b&&t<s-1){const e=h.dist(d);if(e>2*c){const t=h.add(d.sub(h)._mult(c/e)._round());this.updateDistance(h,t),this.addCurrentVertex(t,m,0,0,u),h=t}}}}addCurrentVertex(e,t,r,i,n,a=!1){const o=t.y*i-t.x,s=-t.y-t.x*i;this.addHalfVertex(e,t.x+t.y*r,t.y-t.x*r,a,!1,r,n),this.addHalfVertex(e,o,s,a,!0,-i,n),this.distance>Hs/2&&0===this.totalDistance&&(this.distance=0,this.addCurrentVertex(e,t,r,i,n,a))}addHalfVertex({x:e,y:t},r,i,n,a,o,s){const l=.5*(this.lineClips?this.scaledDistance*(Hs-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((e<<1)+(n?1:0),(t<<1)+(a?1:0),Math.round(63*r)+128,Math.round(63*i)+128,1+(0===o?0:o<0?-1:1)|(63&l)<<2,l>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const c=s.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,c),s.primitiveLength++),a?this.e2=c:this.e1=c}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(e,t){this.distance+=e.dist(t),this.updateScaledDistance()}}Ai("LineBucket",Ks,{omit:["layers","patternFeatures"]});const Ys=new dn({"line-cap":new ln(ie.layout_line["line-cap"]),"line-join":new cn(ie.layout_line["line-join"]),"line-miter-limit":new ln(ie.layout_line["line-miter-limit"]),"line-round-limit":new ln(ie.layout_line["line-round-limit"]),"line-sort-key":new cn(ie.layout_line["line-sort-key"])});var Js={paint:new dn({"line-opacity":new cn(ie.paint_line["line-opacity"]),"line-color":new cn(ie.paint_line["line-color"]),"line-translate":new ln(ie.paint_line["line-translate"]),"line-translate-anchor":new ln(ie.paint_line["line-translate-anchor"]),"line-width":new cn(ie.paint_line["line-width"]),"line-gap-width":new cn(ie.paint_line["line-gap-width"]),"line-offset":new cn(ie.paint_line["line-offset"]),"line-blur":new cn(ie.paint_line["line-blur"]),"line-dasharray":new hn(ie.paint_line["line-dasharray"]),"line-pattern":new un(ie.paint_line["line-pattern"]),"line-gradient":new pn(ie.paint_line["line-gradient"])}),layout:Ys};const Qs=new class extends cn{possiblyEvaluate(e,t){return t=new Ji(Math.floor(t.zoom),{now:t.now,fadeDuration:t.fadeDuration,zoomHistory:t.zoomHistory,transition:t.transition}),super.possiblyEvaluate(e,t)}evaluate(e,t,r,i){return t=s({},t,{zoom:Math.floor(t.zoom)}),super.evaluate(e,t,r,i)}}(Js.paint.properties["line-width"].specification);function el(e,t){return t>0?t+2*e:e}Qs.useIntegerZoom=!0;const tl=xn([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),rl=xn([{name:"a_projected_pos",components:3,type:"Float32"}],4);xn([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const il=xn([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]);xn([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const nl=xn([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),al=xn([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function ol(e,t,r){return e.sections.forEach((e=>{e.text=function(e,t,r){const i=t.layout.get("text-transform").evaluate(r,{});return"uppercase"===i?e=e.toLocaleUpperCase():"lowercase"===i&&(e=e.toLocaleLowerCase()),Yi.applyArabicShaping&&(e=Yi.applyArabicShaping(e)),e}(e.text,t,r)})),e}xn([{name:"triangle",components:3,type:"Uint16"}]),xn([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),xn([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"}]),xn([{type:"Float32",name:"offsetX"}]),xn([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]);const sl={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂"};var ll=24,cl=pl,ul=function(e,t,r,i,n){var a,o,s=8*n-i-1,l=(1<<s)-1,c=l>>1,u=-7,h=r?n-1:0,p=r?-1:1,d=e[t+h];for(h+=p,a=d&(1<<-u)-1,d>>=-u,u+=s;u>0;a=256*a+e[t+h],h+=p,u-=8);for(o=a&(1<<-u)-1,a>>=-u,u+=i;u>0;o=256*o+e[t+h],h+=p,u-=8);if(0===a)a=1-c;else{if(a===l)return o?NaN:1/0*(d?-1:1);o+=Math.pow(2,i),a-=c}return(d?-1:1)*o*Math.pow(2,a-i)},hl=function(e,t,r,i,n,a){var o,s,l,c=8*a-n-1,u=(1<<c)-1,h=u>>1,p=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,d=i?0:a-1,f=i?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(s=isNaN(t)?1:0,o=u):(o=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-o))<1&&(o--,l*=2),(t+=o+h>=1?p/l:p*Math.pow(2,1-h))*l>=2&&(o++,l/=2),o+h>=u?(s=0,o=u):o+h>=1?(s=(t*l-1)*Math.pow(2,n),o+=h):(s=t*Math.pow(2,h-1)*Math.pow(2,n),o=0));n>=8;e[r+d]=255&s,d+=f,s/=256,n-=8);for(o=o<<n|s,c+=n;c>0;e[r+d]=255&o,d+=f,o/=256,c-=8);e[r+d-f]|=128*m};function pl(e){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(e)?e:new Uint8Array(e||0),this.pos=0,this.type=0,this.length=this.buf.length}pl.Varint=0,pl.Fixed64=1,pl.Bytes=2,pl.Fixed32=5;var dl,fl=4294967296,ml=1/fl,gl="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function yl(e){return e.type===pl.Bytes?e.readVarint()+e.pos:e.pos+1}function _l(e,t,r){return r?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0)}function xl(e,t,r){var i=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));r.realloc(i);for(var n=r.pos-1;n>=e;n--)r.buf[n+i]=r.buf[n]}function vl(e,t){for(var r=0;r<e.length;r++)t.writeVarint(e[r])}function bl(e,t){for(var r=0;r<e.length;r++)t.writeSVarint(e[r])}function wl(e,t){for(var r=0;r<e.length;r++)t.writeFloat(e[r])}function Tl(e,t){for(var r=0;r<e.length;r++)t.writeDouble(e[r])}function El(e,t){for(var r=0;r<e.length;r++)t.writeBoolean(e[r])}function Sl(e,t){for(var r=0;r<e.length;r++)t.writeFixed32(e[r])}function Al(e,t){for(var r=0;r<e.length;r++)t.writeSFixed32(e[r])}function Il(e,t){for(var r=0;r<e.length;r++)t.writeFixed64(e[r])}function kl(e,t){for(var r=0;r<e.length;r++)t.writeSFixed64(e[r])}function Cl(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+16777216*e[t+3]}function zl(e,t,r){e[r]=t,e[r+1]=t>>>8,e[r+2]=t>>>16,e[r+3]=t>>>24}function Ml(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+(e[t+3]<<24)}function Pl(e,t,r){1===e&&r.readMessage(Dl,t)}function Dl(e,t,r){if(3===e){const{id:e,bitmap:i,width:n,height:a,left:o,top:s,advance:l}=r.readMessage(Ll,{});t.push({id:e,bitmap:new Co({width:n+6,height:a+6},i),metrics:{width:n,height:a,left:o,top:s,advance:l}})}}function Ll(e,t,r){1===e?t.id=r.readVarint():2===e?t.bitmap=r.readBytes():3===e?t.width=r.readVarint():4===e?t.height=r.readVarint():5===e?t.left=r.readSVarint():6===e?t.top=r.readSVarint():7===e&&(t.advance=r.readVarint())}function Bl(e){let t=0,r=0;for(const i of e)t+=i.w*i.h,r=Math.max(r,i.w);e.sort(((e,t)=>t.h-e.h));const i=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),r),h:1/0}];let n=0,a=0;for(const t of e)for(let e=i.length-1;e>=0;e--){const r=i[e];if(!(t.w>r.w||t.h>r.h)){if(t.x=r.x,t.y=r.y,a=Math.max(a,t.y+t.h),n=Math.max(n,t.x+t.w),t.w===r.w&&t.h===r.h){const t=i.pop();e<i.length&&(i[e]=t)}else t.h===r.h?(r.x+=t.w,r.w-=t.w):t.w===r.w?(r.y+=t.h,r.h-=t.h):(i.push({x:r.x+t.w,y:r.y,w:r.w-t.w,h:t.h}),r.y+=t.h,r.h-=t.h);break}}return{w:n,h:a,fill:t/(n*a)||0}}pl.prototype={destroy:function(){this.buf=null},readFields:function(e,t,r){for(r=r||this.length;this.pos<r;){var i=this.readVarint(),n=i>>3,a=this.pos;this.type=7&i,e(n,t,this),this.pos===a&&this.skip(i)}return t},readMessage:function(e,t){return this.readFields(e,t,this.readVarint()+this.pos)},readFixed32:function(){var e=Cl(this.buf,this.pos);return this.pos+=4,e},readSFixed32:function(){var e=Ml(this.buf,this.pos);return this.pos+=4,e},readFixed64:function(){var e=Cl(this.buf,this.pos)+Cl(this.buf,this.pos+4)*fl;return this.pos+=8,e},readSFixed64:function(){var e=Cl(this.buf,this.pos)+Ml(this.buf,this.pos+4)*fl;return this.pos+=8,e},readFloat:function(){var e=ul(this.buf,this.pos,!0,23,4);return this.pos+=4,e},readDouble:function(){var e=ul(this.buf,this.pos,!0,52,8);return this.pos+=8,e},readVarint:function(e){var t,r,i=this.buf;return t=127&(r=i[this.pos++]),r<128?t:(t|=(127&(r=i[this.pos++]))<<7,r<128?t:(t|=(127&(r=i[this.pos++]))<<14,r<128?t:(t|=(127&(r=i[this.pos++]))<<21,r<128?t:function(e,t,r){var i,n,a=r.buf;if(i=(112&(n=a[r.pos++]))>>4,n<128)return _l(e,i,t);if(i|=(127&(n=a[r.pos++]))<<3,n<128)return _l(e,i,t);if(i|=(127&(n=a[r.pos++]))<<10,n<128)return _l(e,i,t);if(i|=(127&(n=a[r.pos++]))<<17,n<128)return _l(e,i,t);if(i|=(127&(n=a[r.pos++]))<<24,n<128)return _l(e,i,t);if(i|=(1&(n=a[r.pos++]))<<31,n<128)return _l(e,i,t);throw new Error("Expected varint not more than 10 bytes")}(t|=(15&(r=i[this.pos]))<<28,e,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var e=this.readVarint();return e%2==1?(e+1)/-2:e/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=12&&gl?function(e,t,r){return gl.decode(e.subarray(t,r))}(this.buf,t,e):function(e,t,r){for(var i="",n=t;n<r;){var a,o,s,l=e[n],c=null,u=l>239?4:l>223?3:l>191?2:1;if(n+u>r)break;1===u?l<128&&(c=l):2===u?128==(192&(a=e[n+1]))&&(c=(31&l)<<6|63&a)<=127&&(c=null):3===u?(o=e[n+2],128==(192&(a=e[n+1]))&&128==(192&o)&&((c=(15&l)<<12|(63&a)<<6|63&o)<=2047||c>=55296&&c<=57343)&&(c=null)):4===u&&(o=e[n+2],s=e[n+3],128==(192&(a=e[n+1]))&&128==(192&o)&&128==(192&s)&&((c=(15&l)<<18|(63&a)<<12|(63&o)<<6|63&s)<=65535||c>=1114112)&&(c=null)),null===c?(c=65533,u=1):c>65535&&(c-=65536,i+=String.fromCharCode(c>>>10&1023|55296),c=56320|1023&c),i+=String.fromCharCode(c),n+=u}return i}(this.buf,t,e)},readBytes:function(){var e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t},readPackedVarint:function(e,t){if(this.type!==pl.Bytes)return e.push(this.readVarint(t));var r=yl(this);for(e=e||[];this.pos<r;)e.push(this.readVarint(t));return e},readPackedSVarint:function(e){if(this.type!==pl.Bytes)return e.push(this.readSVarint());var t=yl(this);for(e=e||[];this.pos<t;)e.push(this.readSVarint());return e},readPackedBoolean:function(e){if(this.type!==pl.Bytes)return e.push(this.readBoolean());var t=yl(this);for(e=e||[];this.pos<t;)e.push(this.readBoolean());return e},readPackedFloat:function(e){if(this.type!==pl.Bytes)return e.push(this.readFloat());var t=yl(this);for(e=e||[];this.pos<t;)e.push(this.readFloat());return e},readPackedDouble:function(e){if(this.type!==pl.Bytes)return e.push(this.readDouble());var t=yl(this);for(e=e||[];this.pos<t;)e.push(this.readDouble());return e},readPackedFixed32:function(e){if(this.type!==pl.Bytes)return e.push(this.readFixed32());var t=yl(this);for(e=e||[];this.pos<t;)e.push(this.readFixed32());return e},readPackedSFixed32:function(e){if(this.type!==pl.Bytes)return e.push(this.readSFixed32());var t=yl(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed32());return e},readPackedFixed64:function(e){if(this.type!==pl.Bytes)return e.push(this.readFixed64());var t=yl(this);for(e=e||[];this.pos<t;)e.push(this.readFixed64());return e},readPackedSFixed64:function(e){if(this.type!==pl.Bytes)return e.push(this.readSFixed64());var t=yl(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed64());return e},skip:function(e){var t=7&e;if(t===pl.Varint)for(;this.buf[this.pos++]>127;);else if(t===pl.Bytes)this.pos=this.readVarint()+this.pos;else if(t===pl.Fixed32)this.pos+=4;else{if(t!==pl.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8}},writeTag:function(e,t){this.writeVarint(e<<3|t)},realloc:function(e){for(var t=this.length||16;t<this.pos+e;)t*=2;if(t!==this.length){var r=new Uint8Array(t);r.set(this.buf),this.buf=r,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(e){this.realloc(4),zl(this.buf,e,this.pos),this.pos+=4},writeSFixed32:function(e){this.realloc(4),zl(this.buf,e,this.pos),this.pos+=4},writeFixed64:function(e){this.realloc(8),zl(this.buf,-1&e,this.pos),zl(this.buf,Math.floor(e*ml),this.pos+4),this.pos+=8},writeSFixed64:function(e){this.realloc(8),zl(this.buf,-1&e,this.pos),zl(this.buf,Math.floor(e*ml),this.pos+4),this.pos+=8},writeVarint:function(e){(e=+e||0)>268435455||e<0?function(e,t){var r,i;if(e>=0?(r=e%4294967296|0,i=e/4294967296|0):(i=~(-e/4294967296),4294967295^(r=~(-e%4294967296))?r=r+1|0:(r=0,i=i+1|0)),e>=0x10000000000000000||e<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),function(e,t,r){r.buf[r.pos++]=127&e|128,e>>>=7,r.buf[r.pos++]=127&e|128,e>>>=7,r.buf[r.pos++]=127&e|128,e>>>=7,r.buf[r.pos++]=127&e|128,r.buf[r.pos]=127&(e>>>=7)}(r,0,t),function(e,t){var r=(7&e)<<4;t.buf[t.pos++]|=r|((e>>>=3)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e)))))}(i,t)}(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))},writeSVarint:function(e){this.writeVarint(e<0?2*-e-1:2*e)},writeBoolean:function(e){this.writeVarint(Boolean(e))},writeString:function(e){e=String(e),this.realloc(4*e.length),this.pos++;var t=this.pos;this.pos=function(e,t,r){for(var i,n,a=0;a<t.length;a++){if((i=t.charCodeAt(a))>55295&&i<57344){if(!n){i>56319||a+1===t.length?(e[r++]=239,e[r++]=191,e[r++]=189):n=i;continue}if(i<56320){e[r++]=239,e[r++]=191,e[r++]=189,n=i;continue}i=n-55296<<10|i-56320|65536,n=null}else n&&(e[r++]=239,e[r++]=191,e[r++]=189,n=null);i<128?e[r++]=i:(i<2048?e[r++]=i>>6|192:(i<65536?e[r++]=i>>12|224:(e[r++]=i>>18|240,e[r++]=i>>12&63|128),e[r++]=i>>6&63|128),e[r++]=63&i|128)}return r}(this.buf,e,this.pos);var r=this.pos-t;r>=128&&xl(t,r,this),this.pos=t-1,this.writeVarint(r),this.pos+=r},writeFloat:function(e){this.realloc(4),hl(this.buf,e,this.pos,!0,23,4),this.pos+=4},writeDouble:function(e){this.realloc(8),hl(this.buf,e,this.pos,!0,52,8),this.pos+=8},writeBytes:function(e){var t=e.length;this.writeVarint(t),this.realloc(t);for(var r=0;r<t;r++)this.buf[this.pos++]=e[r]},writeRawMessage:function(e,t){this.pos++;var r=this.pos;e(t,this);var i=this.pos-r;i>=128&&xl(r,i,this),this.pos=r-1,this.writeVarint(i),this.pos+=i},writeMessage:function(e,t,r){this.writeTag(e,pl.Bytes),this.writeRawMessage(t,r)},writePackedVarint:function(e,t){t.length&&this.writeMessage(e,vl,t)},writePackedSVarint:function(e,t){t.length&&this.writeMessage(e,bl,t)},writePackedBoolean:function(e,t){t.length&&this.writeMessage(e,El,t)},writePackedFloat:function(e,t){t.length&&this.writeMessage(e,wl,t)},writePackedDouble:function(e,t){t.length&&this.writeMessage(e,Tl,t)},writePackedFixed32:function(e,t){t.length&&this.writeMessage(e,Sl,t)},writePackedSFixed32:function(e,t){t.length&&this.writeMessage(e,Al,t)},writePackedFixed64:function(e,t){t.length&&this.writeMessage(e,Il,t)},writePackedSFixed64:function(e,t){t.length&&this.writeMessage(e,kl,t)},writeBytesField:function(e,t){this.writeTag(e,pl.Bytes),this.writeBytes(t)},writeFixed32Field:function(e,t){this.writeTag(e,pl.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(e,t){this.writeTag(e,pl.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(e,t){this.writeTag(e,pl.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(e,t){this.writeTag(e,pl.Fixed64),this.writeSFixed64(t)},writeVarintField:function(e,t){this.writeTag(e,pl.Varint),this.writeVarint(t)},writeSVarintField:function(e,t){this.writeTag(e,pl.Varint),this.writeSVarint(t)},writeStringField:function(e,t){this.writeTag(e,pl.Bytes),this.writeString(t)},writeFloatField:function(e,t){this.writeTag(e,pl.Fixed32),this.writeFloat(t)},writeDoubleField:function(e,t){this.writeTag(e,pl.Fixed64),this.writeDouble(t)},writeBooleanField:function(e,t){this.writeVarintField(e,Boolean(t))}};class Rl{constructor(e,{pixelRatio:t,version:r,stretchX:i,stretchY:n,content:a}){this.paddedRect=e,this.pixelRatio=t,this.stretchX=i,this.stretchY=n,this.content=a,this.version=r}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class Fl{constructor(e,t){const r={},i={};this.haveRenderCallbacks=[];const n=[];this.addImages(e,r,n),this.addImages(t,i,n);const{w:a,h:o}=Bl(n),s=new zo({width:a||1,height:o||1});for(const t in e){const i=e[t],n=r[t].paddedRect;zo.copy(i.data,s,{x:0,y:0},{x:n.x+1,y:n.y+1},i.data)}for(const e in t){const r=t[e],n=i[e].paddedRect,a=n.x+1,o=n.y+1,l=r.data.width,c=r.data.height;zo.copy(r.data,s,{x:0,y:0},{x:a,y:o},r.data),zo.copy(r.data,s,{x:0,y:c-1},{x:a,y:o-1},{width:l,height:1}),zo.copy(r.data,s,{x:0,y:0},{x:a,y:o+c},{width:l,height:1}),zo.copy(r.data,s,{x:l-1,y:0},{x:a-1,y:o},{width:1,height:c}),zo.copy(r.data,s,{x:0,y:0},{x:a+l,y:o},{width:1,height:c})}this.image=s,this.iconPositions=r,this.patternPositions=i}addImages(e,t,r){for(const i in e){const n=e[i],a={x:0,y:0,w:n.data.width+2,h:n.data.height+2};r.push(a),t[i]=new Rl(a,n),n.hasRenderCallback&&this.haveRenderCallbacks.push(i)}}patchUpdatedImages(e,t){e.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const r in e.updatedImages)this.patchUpdatedImage(this.iconPositions[r],e.getImage(r),t),this.patchUpdatedImage(this.patternPositions[r],e.getImage(r),t)}patchUpdatedImage(e,t,r){if(!e||!t)return;if(e.version===t.version)return;e.version=t.version;const[i,n]=e.tl;r.update(t.data,void 0,{x:i,y:n})}}Ai("ImagePosition",Rl),Ai("ImageAtlas",Fl),e.WritingMode=void 0,(dl=e.WritingMode||(e.WritingMode={}))[dl.none=0]="none",dl[dl.horizontal=1]="horizontal",dl[dl.vertical=2]="vertical",dl[dl.horizontalOnly=3]="horizontalOnly";const Ol=-17;class Ul{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(e,t){const r=new Ul;return r.scale=e||1,r.fontStack=t,r}static forImage(e){const t=new Ul;return t.imageName=e,t}}class Vl{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,t){const r=new Vl;for(let i=0;i<e.sections.length;i++){const n=e.sections[i];n.image?r.addImageSection(n):r.addTextSection(n,t)}return r}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSectionIndex(e){return this.sectionIndex[e]}getCharCode(e){return this.text.charCodeAt(e)}verticalizePunctuation(){this.text=function(e){let t="";for(let r=0;r<e.length;r++){const i=e.charCodeAt(r+1)||null,n=e.charCodeAt(r-1)||null;t+=i&&Ri(i)&&!sl[e[r+1]]||n&&Ri(n)&&!sl[e[r-1]]||!sl[e[r]]?e[r]:sl[e[r]]}return t}(this.text)}trim(){let e=0;for(let t=0;t<this.text.length&&Nl[this.text.charCodeAt(t)];t++)e++;let t=this.text.length;for(let r=this.text.length-1;r>=0&&r>=e&&Nl[this.text.charCodeAt(r)];r--)t--;this.text=this.text.substring(e,t),this.sectionIndex=this.sectionIndex.slice(e,t)}substring(e,t){const r=new Vl;return r.text=this.text.substring(e,t),r.sectionIndex=this.sectionIndex.slice(e,t),r.sections=this.sections,r}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((e,t)=>Math.max(e,this.sections[t].scale)),0)}addTextSection(e,t){this.text+=e.text,this.sections.push(Ul.forText(e.scale,e.fontStack||t));const r=this.sections.length-1;for(let t=0;t<e.text.length;++t)this.sectionIndex.push(r)}addImageSection(e){const t=e.image?e.image.name:"";if(0===t.length)return void f("Can't add FormattedSection with an empty image.");const r=this.getNextImageSectionCharCode();r?(this.text+=String.fromCharCode(r),this.sections.push(Ul.forImage(t)),this.sectionIndex.push(this.sections.length-1)):f("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function $l(t,r,i,n,a,o,s,l,c,u,h,p,d,f,m,g){const y=Vl.fromFeature(t,a);let _;p===e.WritingMode.vertical&&y.verticalizePunctuation();const{processBidirectionalText:x,processStyledBidirectionalText:v}=Yi;if(x&&1===y.sections.length){_=[];const e=x(y.toString(),Hl(y,u,o,r,n,f,m));for(const t of e){const e=new Vl;e.text=t,e.sections=y.sections;for(let r=0;r<t.length;r++)e.sectionIndex.push(0);_.push(e)}}else if(v){_=[];const e=v(y.text,y.sectionIndex,Hl(y,u,o,r,n,f,m));for(const t of e){const e=new Vl;e.text=t[0],e.sectionIndex=t[1],e.sections=y.sections,_.push(e)}}else _=function(e,t){const r=[],i=e.text;let n=0;for(const i of t)r.push(e.substring(n,i)),n=i;return n<i.length&&r.push(e.substring(n,i.length)),r}(y,Hl(y,u,o,r,n,f,m));const b=[],w={positionedLines:b,text:y.toString(),top:h[1],bottom:h[1],left:h[0],right:h[0],writingMode:p,iconsInText:!1,verticalizable:!1};return function(t,r,i,n,a,o,s,l,c,u,h,p){let d=0,f=Ol,m=0,g=0;const y="right"===l?1:"left"===l?0:.5;let _=0;for(const s of a){s.trim();const a=s.getMaxScale(),l=(a-1)*ll,v={positionedGlyphs:[],lineOffset:0};t.positionedLines[_]=v;const b=v.positionedGlyphs;let w=0;if(!s.length()){f+=o,++_;continue}for(let o=0;o<s.length();o++){const m=s.getSection(o),g=s.getSectionIndex(o),y=s.getCharCode(o);let _=0,v=null,T=null,E=null,S=ll;const A=!(c===e.WritingMode.horizontal||!h&&!Bi(y)||h&&(Nl[y]||(x=y,Mi.Arabic(x)||Mi["Arabic Supplement"](x)||Mi["Arabic Extended-A"](x)||Mi["Arabic Presentation Forms-A"](x)||Mi["Arabic Presentation Forms-B"](x))));if(m.imageName){const e=n[m.imageName];if(!e)continue;E=m.imageName,t.iconsInText=t.iconsInText||!0,T=e.paddedRect;const r=e.displaySize;m.scale=m.scale*ll/p,v={width:r[0],height:r[1],left:1,top:-3,advance:A?r[1]:r[0]},_=l+(ll-r[1]*m.scale),S=v.advance;const i=A?r[0]*m.scale-ll*a:r[1]*m.scale-ll*a;i>0&&i>w&&(w=i)}else{const e=i[m.fontStack],t=e&&e[y];if(t&&t.rect)T=t.rect,v=t.metrics;else{const e=r[m.fontStack],t=e&&e[y];if(!t)continue;v=t.metrics}_=(a-m.scale)*ll}A?(t.verticalizable=!0,b.push({glyph:y,imageName:E,x:d,y:f+_,vertical:A,scale:m.scale,fontStack:m.fontStack,sectionIndex:g,metrics:v,rect:T}),d+=S*m.scale+u):(b.push({glyph:y,imageName:E,x:d,y:f+_,vertical:A,scale:m.scale,fontStack:m.fontStack,sectionIndex:g,metrics:v,rect:T}),d+=v.advance*m.scale+u)}0!==b.length&&(m=Math.max(d-u,m),Yl(b,0,b.length-1,y,w)),d=0;const T=o*a+w;v.lineOffset=Math.max(w,l),f+=T,g=Math.max(T,g),++_}var x;const v=f-Ol,{horizontalAlign:b,verticalAlign:w}=Kl(s);(function(e,t,r,i,n,a,o,s,l){const c=(t-r)*n;let u=0;u=a!==o?-s*i-Ol:(-i*l+.5)*o;for(const t of e)for(const e of t.positionedGlyphs)e.x+=c,e.y+=u})(t.positionedLines,y,b,w,m,g,o,v,a.length),t.top+=-w*v,t.bottom=t.top+v,t.left+=-b*m,t.right=t.left+m}(w,r,i,n,_,s,l,c,p,u,d,g),!function(e){for(const t of e)if(0!==t.positionedGlyphs.length)return!1;return!0}(b)&&w}const Nl={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},jl={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function ql(e,t,r,i,n,a){if(t.imageName){const e=i[t.imageName];return e?e.displaySize[0]*t.scale*ll/a+n:0}{const i=r[t.fontStack],a=i&&i[e];return a?a.metrics.advance*t.scale+n:0}}function Gl(e,t,r,i){const n=Math.pow(e-t,2);return i?e<t?n/2:2*n:n+Math.abs(r)*r}function Zl(e,t,r){let i=0;return 10===e&&(i-=1e4),r&&(i+=150),40!==e&&65288!==e||(i+=50),41!==t&&65289!==t||(i+=50),i}function Xl(e,t,r,i,n,a){let o=null,s=Gl(t,r,n,a);for(const e of i){const i=Gl(t-e.x,r,n,a)+e.badness;i<=s&&(o=e,s=i)}return{index:e,x:t,priorBreak:o,badness:s}}function Wl(e){return e?Wl(e.priorBreak).concat(e.index):[]}function Hl(e,t,r,i,n,a,o){if("point"!==a)return[];if(!e)return[];const s=[],l=function(e,t,r,i,n,a){let o=0;for(let r=0;r<e.length();r++){const s=e.getSection(r);o+=ql(e.getCharCode(r),s,i,n,t,a)}return o/Math.max(1,Math.ceil(o/r))}(e,t,r,i,n,o),c=e.text.indexOf("​")>=0;let u=0;for(let r=0;r<e.length();r++){const a=e.getSection(r),p=e.getCharCode(r);if(Nl[p]||(u+=ql(p,a,i,n,t,o)),r<e.length()-1){const t=!((h=p)<11904||!(Mi["Bopomofo Extended"](h)||Mi.Bopomofo(h)||Mi["CJK Compatibility Forms"](h)||Mi["CJK Compatibility Ideographs"](h)||Mi["CJK Compatibility"](h)||Mi["CJK Radicals Supplement"](h)||Mi["CJK Strokes"](h)||Mi["CJK Symbols and Punctuation"](h)||Mi["CJK Unified Ideographs Extension A"](h)||Mi["CJK Unified Ideographs"](h)||Mi["Enclosed CJK Letters and Months"](h)||Mi["Halfwidth and Fullwidth Forms"](h)||Mi.Hiragana(h)||Mi["Ideographic Description Characters"](h)||Mi["Kangxi Radicals"](h)||Mi["Katakana Phonetic Extensions"](h)||Mi.Katakana(h)||Mi["Vertical Forms"](h)||Mi["Yi Radicals"](h)||Mi["Yi Syllables"](h)));(jl[p]||t||a.imageName)&&s.push(Xl(r+1,u,l,s,Zl(p,e.getCharCode(r+1),t&&c),!1))}}var h;return Wl(Xl(e.length(),u,l,s,0,!0))}function Kl(e){let t=.5,r=.5;switch(e){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0}switch(e){case"bottom":case"bottom-right":case"bottom-left":r=1;break;case"top":case"top-right":case"top-left":r=0}return{horizontalAlign:t,verticalAlign:r}}function Yl(e,t,r,i,n){if(!i&&!n)return;const a=e[r],o=(e[r].x+a.metrics.advance*a.scale)*i;for(let i=t;i<=r;i++)e[i].x-=o,e[i].y+=n}function Jl(e,t,r){const{horizontalAlign:i,verticalAlign:n}=Kl(r),a=t[0]-e.displaySize[0]*i,o=t[1]-e.displaySize[1]*n;return{image:e,top:o,bottom:o+e.displaySize[1],left:a,right:a+e.displaySize[0]}}function Ql(e,t,r,i,n,a){const o=e.image;let s;if(o.content){const e=o.content,t=o.pixelRatio||1;s=[e[0]/t,e[1]/t,o.displaySize[0]-e[2]/t,o.displaySize[1]-e[3]/t]}const l=t.left*a,c=t.right*a;let u,h,p,d;"width"===r||"both"===r?(d=n[0]+l-i[3],h=n[0]+c+i[1]):(d=n[0]+(l+c-o.displaySize[0])/2,h=d+o.displaySize[0]);const f=t.top*a,m=t.bottom*a;return"height"===r||"both"===r?(u=n[1]+f-i[0],p=n[1]+m+i[2]):(u=n[1]+(f+m-o.displaySize[1])/2,p=u+o.displaySize[1]),{image:o,top:u,right:h,bottom:p,left:d,collisionPadding:s}}const ec=128;function tc(e,t){const{expression:r}=t;if("constant"===r.kind)return{kind:"constant",layoutSize:r.evaluate(new Ji(e+1))};if("source"===r.kind)return{kind:"source"};{const{zoomStops:t,interpolationType:i}=r;let n=0;for(;n<t.length&&t[n]<=e;)n++;n=Math.max(0,n-1);let a=n;for(;a<t.length&&t[a]<e+1;)a++;a=Math.min(t.length-1,a);const o=t[n],s=t[a];return"composite"===r.kind?{kind:"composite",minZoom:o,maxZoom:s,interpolationType:i}:{kind:"camera",minZoom:o,maxZoom:s,minSize:r.evaluate(new Ji(o)),maxSize:r.evaluate(new Ji(s)),interpolationType:i}}}class rc extends S{constructor(e,t,r,i){super(e,t),this.angle=r,void 0!==i&&(this.segment=i)}clone(){return new rc(this.x,this.y,this.angle,this.segment)}}function ic(e,t,r,i,n){if(void 0===t.segment)return!0;let a=t,o=t.segment+1,s=0;for(;s>-r/2;){if(o--,o<0)return!1;s-=e[o].dist(a),a=e[o]}s+=e[o].dist(e[o+1]),o++;const l=[];let c=0;for(;s<r/2;){const t=e[o],r=e[o+1];if(!r)return!1;let a=e[o-1].angleTo(t)-t.angleTo(r);for(a=Math.abs((a+3*Math.PI)%(2*Math.PI)-Math.PI),l.push({distance:s,angleDelta:a}),c+=a;s-l[0].distance>i;)c-=l.shift().angleDelta;if(c>n)return!1;o++,s+=t.dist(r)}return!0}function nc(e){let t=0;for(let r=0;r<e.length-1;r++)t+=e[r].dist(e[r+1]);return t}function ac(e,t,r){return e?.6*t*r:0}function oc(e,t){return Math.max(e?e.right-e.left:0,t?t.right-t.left:0)}function sc(e,t,r,i,n,a){const o=ac(r,n,a),s=oc(r,i)*a;let l=0;const c=nc(e)/2;for(let r=0;r<e.length-1;r++){const i=e[r],n=e[r+1],a=i.dist(n);if(l+a>c){const u=(c-l)/a,h=St(i.x,n.x,u),p=St(i.y,n.y,u),d=new rc(h,p,n.angleTo(i),r);return d._round(),!o||ic(e,d,s,o,t)?d:void 0}l+=a}}function lc(e,t,r,i,n,a,o,s,l){const c=ac(i,a,o),u=oc(i,n),h=u*o,p=0===e[0].x||e[0].x===l||0===e[0].y||e[0].y===l;return t-h<t/4&&(t=h+t/4),cc(e,p?t/2*s%t:(u/2+2*a)*o*s%t,t,c,r,h,p,!1,l)}function cc(e,t,r,i,n,a,o,s,l){const c=a/2,u=nc(e);let h=0,p=t-r,d=[];for(let t=0;t<e.length-1;t++){const o=e[t],s=e[t+1],f=o.dist(s),m=s.angleTo(o);for(;p+r<h+f;){p+=r;const g=(p-h)/f,y=St(o.x,s.x,g),_=St(o.y,s.y,g);if(y>=0&&y<l&&_>=0&&_<l&&p-c>=0&&p+c<=u){const r=new rc(y,_,m,t);r._round(),i&&!ic(e,r,a,i,n)||d.push(r)}}h+=f}return s||d.length||o||(d=cc(e,h/2,r,i,n,a,o,!0,l)),d}function uc(e,t,r,i,n){const a=[];for(let o=0;o<e.length;o++){const s=e[o];let l;for(let e=0;e<s.length-1;e++){let o=s[e],c=s[e+1];o.x<t&&c.x<t||(o.x<t?o=new S(t,o.y+(t-o.x)/(c.x-o.x)*(c.y-o.y))._round():c.x<t&&(c=new S(t,o.y+(t-o.x)/(c.x-o.x)*(c.y-o.y))._round()),o.y<r&&c.y<r||(o.y<r?o=new S(o.x+(r-o.y)/(c.y-o.y)*(c.x-o.x),r)._round():c.y<r&&(c=new S(o.x+(r-o.y)/(c.y-o.y)*(c.x-o.x),r)._round()),o.x>=i&&c.x>=i||(o.x>=i?o=new S(i,o.y+(i-o.x)/(c.x-o.x)*(c.y-o.y))._round():c.x>=i&&(c=new S(i,o.y+(i-o.x)/(c.x-o.x)*(c.y-o.y))._round()),o.y>=n&&c.y>=n||(o.y>=n?o=new S(o.x+(n-o.y)/(c.y-o.y)*(c.x-o.x),n)._round():c.y>=n&&(c=new S(o.x+(n-o.y)/(c.y-o.y)*(c.x-o.x),n)._round()),l&&o.equals(l[l.length-1])||(l=[o],a.push(l)),l.push(c)))))}}return a}function hc(e,t,r,i){const n=[],a=e.image,o=a.pixelRatio,s=a.paddedRect.w-2,l=a.paddedRect.h-2,c=e.right-e.left,u=e.bottom-e.top,h=a.stretchX||[[0,s]],p=a.stretchY||[[0,l]],d=(e,t)=>e+t[1]-t[0],f=h.reduce(d,0),m=p.reduce(d,0),g=s-f,y=l-m;let _=0,x=f,v=0,b=m,w=0,T=g,E=0,A=y;if(a.content&&i){const e=a.content;_=pc(h,0,e[0]),v=pc(p,0,e[1]),x=pc(h,e[0],e[2]),b=pc(p,e[1],e[3]),w=e[0]-_,E=e[1]-v,T=e[2]-e[0]-x,A=e[3]-e[1]-b}const I=(i,n,s,l)=>{const h=fc(i.stretch-_,x,c,e.left),p=mc(i.fixed-w,T,i.stretch,f),d=fc(n.stretch-v,b,u,e.top),g=mc(n.fixed-E,A,n.stretch,m),y=fc(s.stretch-_,x,c,e.left),I=mc(s.fixed-w,T,s.stretch,f),k=fc(l.stretch-v,b,u,e.top),C=mc(l.fixed-E,A,l.stretch,m),z=new S(h,d),M=new S(y,d),P=new S(y,k),D=new S(h,k),L=new S(p/o,g/o),B=new S(I/o,C/o),R=t*Math.PI/180;if(R){const e=Math.sin(R),t=Math.cos(R),r=[t,-e,e,t];z._matMult(r),M._matMult(r),D._matMult(r),P._matMult(r)}const F=i.stretch+i.fixed,O=n.stretch+n.fixed;return{tl:z,tr:M,bl:D,br:P,tex:{x:a.paddedRect.x+1+F,y:a.paddedRect.y+1+O,w:s.stretch+s.fixed-F,h:l.stretch+l.fixed-O},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:L,pixelOffsetBR:B,minFontScaleX:T/o/c,minFontScaleY:A/o/u,isSDF:r}};if(i&&(a.stretchX||a.stretchY)){const e=dc(h,g,f),t=dc(p,y,m);for(let r=0;r<e.length-1;r++){const i=e[r],a=e[r+1];for(let e=0;e<t.length-1;e++)n.push(I(i,t[e],a,t[e+1]))}}else n.push(I({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:s+1},{fixed:0,stretch:l+1}));return n}function pc(e,t,r){let i=0;for(const n of e)i+=Math.max(t,Math.min(r,n[1]))-Math.max(t,Math.min(r,n[0]));return i}function dc(e,t,r){const i=[{fixed:-1,stretch:0}];for(const[t,r]of e){const e=i[i.length-1];i.push({fixed:t-e.stretch,stretch:e.stretch}),i.push({fixed:t-e.stretch,stretch:e.stretch+(r-t)})}return i.push({fixed:t+1,stretch:r}),i}function fc(e,t,r,i){return e/t*r+i}function mc(e,t,r,i){return e-t*r/i}Ai("Anchor",rc);class gc{constructor(e,t,r,i,n,a,o,s,l,c){if(this.boxStartIndex=e.length,l){let e=a.top,t=a.bottom;const r=a.collisionPadding;r&&(e-=r[1],t+=r[3]);let i=t-e;i>0&&(i=Math.max(10,i),this.circleDiameter=i)}else{let l=a.top*o-s[0],u=a.bottom*o+s[2],h=a.left*o-s[3],p=a.right*o+s[1];const d=a.collisionPadding;if(d&&(h-=d[0]*o,l-=d[1]*o,p+=d[2]*o,u+=d[3]*o),c){const e=new S(h,l),t=new S(p,l),r=new S(h,u),i=new S(p,u),n=c*Math.PI/180;e._rotate(n),t._rotate(n),r._rotate(n),i._rotate(n),h=Math.min(e.x,t.x,r.x,i.x),p=Math.max(e.x,t.x,r.x,i.x),l=Math.min(e.y,t.y,r.y,i.y),u=Math.max(e.y,t.y,r.y,i.y)}e.emplaceBack(t.x,t.y,h,l,p,u,r,i,n)}this.boxEndIndex=e.length}}class yc{constructor(e=[],t=_c){if(this.data=e,this.length=this.data.length,this.compare=t,this.length>0)for(let e=(this.length>>1)-1;e>=0;e--)this._down(e)}push(e){this.data.push(e),this.length++,this._up(this.length-1)}pop(){if(0===this.length)return;const e=this.data[0],t=this.data.pop();return this.length--,this.length>0&&(this.data[0]=t,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:t,compare:r}=this,i=t[e];for(;e>0;){const n=e-1>>1,a=t[n];if(r(i,a)>=0)break;t[e]=a,e=n}t[e]=i}_down(e){const{data:t,compare:r}=this,i=this.length>>1,n=t[e];for(;e<i;){let i=1+(e<<1),a=t[i];const o=i+1;if(o<this.length&&r(t[o],a)<0&&(i=o,a=t[o]),r(a,n)>=0)break;t[e]=a,e=i}t[e]=n}}function _c(e,t){return e<t?-1:e>t?1:0}function xc(e,t=1,r=!1){let i=1/0,n=1/0,a=-1/0,o=-1/0;const s=e[0];for(let e=0;e<s.length;e++){const t=s[e];(!e||t.x<i)&&(i=t.x),(!e||t.y<n)&&(n=t.y),(!e||t.x>a)&&(a=t.x),(!e||t.y>o)&&(o=t.y)}const l=Math.min(a-i,o-n);let c=l/2;const u=new yc([],vc);if(0===l)return new S(i,n);for(let t=i;t<a;t+=l)for(let r=n;r<o;r+=l)u.push(new bc(t+c,r+c,c,e));let h=function(e){let t=0,r=0,i=0;const n=e[0];for(let e=0,a=n.length,o=a-1;e<a;o=e++){const a=n[e],s=n[o],l=a.x*s.y-s.x*a.y;r+=(a.x+s.x)*l,i+=(a.y+s.y)*l,t+=3*l}return new bc(r/t,i/t,0,e)}(e),p=u.length;for(;u.length;){const i=u.pop();(i.d>h.d||!h.d)&&(h=i,r&&console.log("found best %d after %d probes",Math.round(1e4*i.d)/1e4,p)),i.max-h.d<=t||(c=i.h/2,u.push(new bc(i.p.x-c,i.p.y-c,c,e)),u.push(new bc(i.p.x+c,i.p.y-c,c,e)),u.push(new bc(i.p.x-c,i.p.y+c,c,e)),u.push(new bc(i.p.x+c,i.p.y+c,c,e)),p+=4)}return r&&(console.log(`num probes: ${p}`),console.log(`best distance: ${h.d}`)),h.p}function vc(e,t){return t.max-e.max}function bc(e,t,r,i){this.p=new S(e,t),this.h=r,this.d=function(e,t){let r=!1,i=1/0;for(let n=0;n<t.length;n++){const a=t[n];for(let t=0,n=a.length,o=n-1;t<n;o=t++){const n=a[t],s=a[o];n.y>e.y!=s.y>e.y&&e.x<(s.x-n.x)*(e.y-n.y)/(s.y-n.y)+n.x&&(r=!r),i=Math.min(i,ro(e,n,s))}}return(r?1:-1)*Math.sqrt(i)}(this.p,i),this.max=this.d+this.h*Math.SQRT2}const wc=Number.POSITIVE_INFINITY;function Tc(e,t){return t[1]!==wc?function(e,t,r){let i=0,n=0;switch(t=Math.abs(t),r=Math.abs(r),e){case"top-right":case"top-left":case"top":n=r-7;break;case"bottom-right":case"bottom-left":case"bottom":n=7-r}switch(e){case"top-right":case"bottom-right":case"right":i=-t;break;case"top-left":case"bottom-left":case"left":i=t}return[i,n]}(e,t[0],t[1]):function(e,t){let r=0,i=0;t<0&&(t=0);const n=t/Math.sqrt(2);switch(e){case"top-right":case"top-left":i=n-7;break;case"bottom-right":case"bottom-left":i=7-n;break;case"bottom":i=7-t;break;case"top":i=t-7}switch(e){case"top-right":case"bottom-right":r=-n;break;case"top-left":case"bottom-left":r=n;break;case"left":r=t;break;case"right":r=-t}return[r,i]}(e,t[0])}function Ec(e){switch(e){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Sc(t,r,i,n,a,o,s,l,c,u,h){let p=o.textMaxSize.evaluate(r,{});void 0===p&&(p=s);const d=t.layers[0].layout,m=d.get("icon-offset").evaluate(r,{},h),g=kc(i.horizontal),y=s/24,_=t.tilePixelRatio*y,x=t.tilePixelRatio*p/24,v=t.tilePixelRatio*l,b=t.tilePixelRatio*d.get("symbol-spacing"),w=d.get("text-padding")*t.tilePixelRatio,T=function(e,t,r,i=1){const n=e.get("icon-padding").evaluate(t,{},r),a=n&&n.values;return[a[0]*i,a[1]*i,a[2]*i,a[3]*i]}(d,r,h,t.tilePixelRatio),E=d.get("text-max-angle")/180*Math.PI,S="viewport"!==d.get("text-rotation-alignment")&&"point"!==d.get("symbol-placement"),A="map"===d.get("icon-rotation-alignment")&&"point"!==d.get("symbol-placement"),I=d.get("symbol-placement"),k=b/2,C=d.get("icon-text-fit");let z;n&&"none"!==C&&(t.allowVerticalPlacement&&i.vertical&&(z=Ql(n,i.vertical,C,d.get("icon-text-fit-padding"),m,y)),g&&(n=Ql(n,g,C,d.get("icon-text-fit-padding"),m,y)));const M=(l,p)=>{p.x<0||p.x>=Na||p.y<0||p.y>=Na||function(t,r,i,n,a,o,s,l,c,u,h,p,d,m,g,y,_,x,v,b,w,T,E,S,A){const I=t.addToLineVertexArray(r,i);let k,C,z,M,P=0,D=0,L=0,B=0,R=-1,F=-1;const O={};let U=_a.exports(""),V=0,$=0;if(void 0===l._unevaluatedLayout.getValue("text-radial-offset")?[V,$]=l.layout.get("text-offset").evaluate(w,{},S).map((e=>e*ll)):(V=l.layout.get("text-radial-offset").evaluate(w,{},S)*ll,$=wc),t.allowVerticalPlacement&&n.vertical){const e=l.layout.get("text-rotate").evaluate(w,{},S)+90;z=new gc(c,r,u,h,p,n.vertical,d,m,g,e),s&&(M=new gc(c,r,u,h,p,s,_,x,g,e))}if(a){const i=l.layout.get("icon-rotate").evaluate(w,{}),n="none"!==l.layout.get("icon-text-fit"),o=hc(a,i,E,n),d=s?hc(s,i,E,n):void 0;C=new gc(c,r,u,h,p,a,_,x,!1,i),P=4*o.length;const m=t.iconSizeData;let g=null;"source"===m.kind?(g=[ec*l.layout.get("icon-size").evaluate(w,{})],g[0]>Ac&&f(`${t.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):"composite"===m.kind&&(g=[ec*T.compositeIconSizes[0].evaluate(w,{},S),ec*T.compositeIconSizes[1].evaluate(w,{},S)],(g[0]>Ac||g[1]>Ac)&&f(`${t.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),t.addSymbols(t.icon,o,g,b,v,w,e.WritingMode.none,r,I.lineStartIndex,I.lineLength,-1,S),R=t.icon.placedSymbolArray.length-1,d&&(D=4*d.length,t.addSymbols(t.icon,d,g,b,v,w,e.WritingMode.vertical,r,I.lineStartIndex,I.lineLength,-1,S),F=t.icon.placedSymbolArray.length-1)}const N=Object.keys(n.horizontal);for(const i of N){const a=n.horizontal[i];if(!k){U=_a.exports(a.text);const e=l.layout.get("text-rotate").evaluate(w,{},S);k=new gc(c,r,u,h,p,a,d,m,g,e)}const s=1===a.positionedLines.length;if(L+=Ic(t,r,a,o,l,g,w,y,I,n.vertical?e.WritingMode.horizontal:e.WritingMode.horizontalOnly,s?N:[i],O,R,T,S),s)break}n.vertical&&(B+=Ic(t,r,n.vertical,o,l,g,w,y,I,e.WritingMode.vertical,["vertical"],O,F,T,S));const j=k?k.boxStartIndex:t.collisionBoxArray.length,q=k?k.boxEndIndex:t.collisionBoxArray.length,G=z?z.boxStartIndex:t.collisionBoxArray.length,Z=z?z.boxEndIndex:t.collisionBoxArray.length,X=C?C.boxStartIndex:t.collisionBoxArray.length,W=C?C.boxEndIndex:t.collisionBoxArray.length,H=M?M.boxStartIndex:t.collisionBoxArray.length,K=M?M.boxEndIndex:t.collisionBoxArray.length;let Y=-1;const J=(e,t)=>e&&e.circleDiameter?Math.max(e.circleDiameter,t):t;Y=J(k,Y),Y=J(z,Y),Y=J(C,Y),Y=J(M,Y);const Q=Y>-1?1:0;Q&&(Y*=A/ll),t.glyphOffsetArray.length>=Fc.MAX_GLYPHS&&f("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==w.sortKey&&t.addToSortKeyRanges(t.symbolInstances.length,w.sortKey),t.symbolInstances.emplaceBack(r.x,r.y,O.right>=0?O.right:-1,O.center>=0?O.center:-1,O.left>=0?O.left:-1,O.vertical||-1,R,F,U,j,q,G,Z,X,W,H,K,u,L,B,P,D,Q,0,d,V,$,Y)}(t,p,l,i,n,a,z,t.layers[0],t.collisionBoxArray,r.index,r.sourceLayerIndex,t.index,_,[w,w,w,w],S,c,v,T,A,m,r,o,u,h,s)};if("line"===I)for(const e of uc(r.geometry,0,0,Na,Na)){const r=lc(e,b,E,i.vertical||g,n,24,x,t.overscaling,Na);for(const i of r)g&&Cc(t,g.text,k,i)||M(e,i)}else if("line-center"===I){for(const e of r.geometry)if(e.length>1){const t=sc(e,E,i.vertical||g,n,24,x);t&&M(e,t)}}else if("Polygon"===r.type)for(const e of ps(r.geometry,0)){const t=xc(e,16);M(e[0],new rc(t.x,t.y,0))}else if("LineString"===r.type)for(const e of r.geometry)M(e,new rc(e[0].x,e[0].y,0));else if("Point"===r.type)for(const e of r.geometry)for(const t of e)M([t],new rc(t.x,t.y,0))}const Ac=32640;function Ic(e,t,r,i,n,a,o,s,l,c,u,h,p,d,m){const g=function(e,t,r,i,n,a,o,s){const l=i.layout.get("text-rotate").evaluate(a,{})*Math.PI/180,c=[];for(const e of t.positionedLines)for(const i of e.positionedGlyphs){if(!i.rect)continue;const a=i.rect||{};let u=4,h=!0,p=1,d=0;const f=(n||s)&&i.vertical,m=i.metrics.advance*i.scale/2;if(s&&t.verticalizable){const t=(i.scale-1)*ll,r=(ll-i.metrics.width*i.scale)/2;d=e.lineOffset/2-(i.imageName?-r:t)}if(i.imageName){const e=o[i.imageName];h=e.sdf,p=e.pixelRatio,u=1/p}const g=n?[i.x+m,i.y]:[0,0];let y=n?[0,0]:[i.x+m+r[0],i.y+r[1]-d],_=[0,0];f&&(_=y,y=[0,0]);const x=(i.metrics.left-u)*i.scale-m+y[0],v=(-i.metrics.top-u)*i.scale+y[1],b=x+a.w*i.scale/p,w=v+a.h*i.scale/p,T=new S(x,v),E=new S(b,v),A=new S(x,w),I=new S(b,w);if(f){const e=new S(-m,m-Ol),t=-Math.PI/2,r=12-m,n=new S(22-r,-(i.imageName?r:0)),a=new S(..._);T._rotateAround(t,e)._add(n)._add(a),E._rotateAround(t,e)._add(n)._add(a),A._rotateAround(t,e)._add(n)._add(a),I._rotateAround(t,e)._add(n)._add(a)}if(l){const e=Math.sin(l),t=Math.cos(l),r=[t,-e,e,t];T._matMult(r),E._matMult(r),A._matMult(r),I._matMult(r)}const k=new S(0,0),C=new S(0,0);c.push({tl:T,tr:E,bl:A,br:I,tex:a,writingMode:t.writingMode,glyphOffset:g,sectionIndex:i.sectionIndex,isSDF:h,pixelOffsetTL:k,pixelOffsetBR:C,minFontScaleX:0,minFontScaleY:0})}return c}(0,r,s,n,a,o,i,e.allowVerticalPlacement),y=e.textSizeData;let _=null;"source"===y.kind?(_=[ec*n.layout.get("text-size").evaluate(o,{})],_[0]>Ac&&f(`${e.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):"composite"===y.kind&&(_=[ec*d.compositeTextSizes[0].evaluate(o,{},m),ec*d.compositeTextSizes[1].evaluate(o,{},m)],(_[0]>Ac||_[1]>Ac)&&f(`${e.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),e.addSymbols(e.text,g,_,s,a,o,c,t,l.lineStartIndex,l.lineLength,p,m);for(const t of u)h[t]=e.text.placedSymbolArray.length-1;return 4*g.length}function kc(e){for(const t in e)return e[t];return null}function Cc(e,t,r,i){const n=e.compareText;if(t in n){const e=n[t];for(let t=e.length-1;t>=0;t--)if(i.dist(e[t])<r)return!0}else n[t]=[];return n[t].push(i),!1}const zc=ws.VectorTileFeature.types,Mc=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Pc(e,t,r,i,n,a,o,s,l,c,u,h,p){const d=s?Math.min(Ac,Math.round(s[0])):0,f=s?Math.min(Ac,Math.round(s[1])):0;e.emplaceBack(t,r,Math.round(32*i),Math.round(32*n),a,o,(d<<1)+(l?1:0),f,16*c,16*u,256*h,256*p)}function Dc(e,t,r){e.emplaceBack(t.x,t.y,r),e.emplaceBack(t.x,t.y,r),e.emplaceBack(t.x,t.y,r),e.emplaceBack(t.x,t.y,r)}function Lc(e){for(const t of e.sections)if(Ui(t.text))return!0;return!1}class Bc{constructor(e){this.layoutVertexArray=new oa,this.indexArray=new ha,this.programConfigurations=e,this.segments=new ma,this.dynamicLayoutVertexArray=new sa,this.opacityVertexArray=new la,this.placedSymbolArray=new Zn}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length}upload(e,t,r,i){this.isEmpty()||(r&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,tl.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,t),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,rl.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,Mc,!0),this.opacityVertexBuffer.itemSize=1),(r||i)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}Ai("SymbolBuffers",Bc);class Rc{constructor(e,t,r){this.layoutVertexArray=new e,this.layoutAttributes=t,this.indexArray=new r,this.segments=new ma,this.collisionVertexArray=new ua}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,il.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}Ai("CollisionBuffers",Rc);class Fc{constructor(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((e=>e.id)),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=mo([]),this.placementViewportMatrix=mo([]);const r=this.layers[0]._unevaluatedLayout._values;this.textSizeData=tc(this.zoom,r["text-size"]),this.iconSizeData=tc(this.zoom,r["icon-size"]);const i=this.layers[0].layout,n=i.get("symbol-sort-key"),a=i.get("symbol-z-order");this.canOverlap="never"!==Nc(i,"text-overlap","text-allow-overlap")||"never"!==Nc(i,"icon-overlap","icon-allow-overlap")||i.get("text-ignore-placement")||i.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==a&&!n.isConstant(),this.sortFeaturesByY=("viewport-y"===a||"auto"===a&&!this.sortFeaturesByKey)&&this.canOverlap,"point"===i.get("symbol-placement")&&(this.writingModes=i.get("text-writing-mode").map((t=>e.WritingMode[t]))),this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.sourceID=t.sourceID}createArrays(){this.text=new Bc(new Ua(this.layers,this.zoom,(e=>/^text/.test(e)))),this.icon=new Bc(new Ua(this.layers,this.zoom,(e=>/^icon/.test(e)))),this.glyphOffsetArray=new Hn,this.lineVertexArray=new Kn,this.symbolInstances=new Wn}calculateGlyphDependencies(e,t,r,i,n){for(let a=0;a<e.length;a++)if(t[e.charCodeAt(a)]=!0,(r||i)&&n){const r=sl[e.charAt(a)];r&&(t[r.charCodeAt(0)]=!0)}}populate(t,r,i){const n=this.layers[0],a=n.layout,o=a.get("text-font"),s=a.get("text-field"),l=a.get("icon-image"),c=("constant"!==s.value.kind||s.value.value instanceof Fe&&!s.value.value.isEmpty()||s.value.value.toString().length>0)&&("constant"!==o.value.kind||o.value.value.length>0),u="constant"!==l.value.kind||!!l.value.value||Object.keys(l.parameters).length>0,h=a.get("symbol-sort-key");if(this.features=[],!c&&!u)return;const p=r.iconDependencies,d=r.glyphDependencies,f=r.availableImages,m=new Ji(this.zoom);for(const{feature:r,id:s,index:l,sourceLayerIndex:g}of t){const t=n._featureFilter.needGeometry,y=Za(r,t);if(!n._featureFilter.filter(m,y,i))continue;let _,x;if(t||(y.geometry=Ga(r)),c){const e=n.getValueAndResolveTokens("text-field",y,i,f),t=Fe.factory(e);Lc(t)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===Hi()||this.hasRTLText&&Yi.isParsed())&&(_=ol(t,n,y))}if(u){const e=n.getValueAndResolveTokens("icon-image",y,i,f);x=e instanceof Ue?e:Ue.fromString(e)}if(!_&&!x)continue;const v=this.sortFeaturesByKey?h.evaluate(y,{},i):void 0;if(this.features.push({id:s,text:_,icon:x,index:l,sourceLayerIndex:g,geometry:y.geometry,properties:r.properties,type:zc[r.type],sortKey:v}),x&&(p[x.name]=!0),_){const t=o.evaluate(y,{},i).join(","),r="viewport"!==a.get("text-rotation-alignment")&&"point"!==a.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(e.WritingMode.vertical)>=0;for(const e of _.sections)if(e.image)p[e.image.name]=!0;else{const i=Pi(_.toString()),n=e.fontStack||t,a=d[n]=d[n]||{};this.calculateGlyphDependencies(e.text,a,r,this.allowVerticalPlacement,i)}}}"line"===a.get("symbol-placement")&&(this.features=function(e){const t={},r={},i=[];let n=0;function a(t){i.push(e[t]),n++}function o(e,t,n){const a=r[e];return delete r[e],r[t]=a,i[a].geometry[0].pop(),i[a].geometry[0]=i[a].geometry[0].concat(n[0]),a}function s(e,r,n){const a=t[r];return delete t[r],t[e]=a,i[a].geometry[0].shift(),i[a].geometry[0]=n[0].concat(i[a].geometry[0]),a}function l(e,t,r){const i=r?t[0][t[0].length-1]:t[0][0];return`${e}:${i.x}:${i.y}`}for(let c=0;c<e.length;c++){const u=e[c],h=u.geometry,p=u.text?u.text.toString():null;if(!p){a(c);continue}const d=l(p,h),f=l(p,h,!0);if(d in r&&f in t&&r[d]!==t[f]){const e=s(d,f,h),n=o(d,f,i[e].geometry);delete t[d],delete r[f],r[l(p,i[n].geometry,!0)]=n,i[e].geometry=null}else d in r?o(d,f,h):f in t?s(d,f,h):(a(c),t[d]=n-1,r[f]=n-1)}return i.filter((e=>e.geometry))}(this.features)),this.sortFeaturesByKey&&this.features.sort(((e,t)=>e.sortKey-t.sortKey))}update(e,t,r){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(e,t,this.layers,r),this.icon.programConfigurations.updatePaintArrays(e,t,this.layers,r))}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,t){const r=this.lineVertexArray.length;if(void 0!==e.segment){let r=e.dist(t[e.segment+1]),i=e.dist(t[e.segment]);const n={};for(let i=e.segment+1;i<t.length;i++)n[i]={x:t[i].x,y:t[i].y,tileUnitDistanceFromAnchor:r},i<t.length-1&&(r+=t[i+1].dist(t[i]));for(let r=e.segment||0;r>=0;r--)n[r]={x:t[r].x,y:t[r].y,tileUnitDistanceFromAnchor:i},r>0&&(i+=t[r-1].dist(t[r]));for(let e=0;e<t.length;e++){const t=n[e];this.lineVertexArray.emplaceBack(t.x,t.y,t.tileUnitDistanceFromAnchor)}}return{lineStartIndex:r,lineLength:this.lineVertexArray.length-r}}addSymbols(t,r,i,n,a,o,s,l,c,u,h,p){const d=t.indexArray,f=t.layoutVertexArray,m=t.segments.prepareSegment(4*r.length,f,d,this.canOverlap?o.sortKey:void 0),g=this.glyphOffsetArray.length,y=m.vertexLength,_=this.allowVerticalPlacement&&s===e.WritingMode.vertical?Math.PI/2:0,x=o.text&&o.text.sections;for(let e=0;e<r.length;e++){const{tl:n,tr:a,bl:s,br:c,tex:u,pixelOffsetTL:h,pixelOffsetBR:g,minFontScaleX:y,minFontScaleY:v,glyphOffset:b,isSDF:w,sectionIndex:T}=r[e],E=m.vertexLength,S=b[1];Pc(f,l.x,l.y,n.x,S+n.y,u.x,u.y,i,w,h.x,h.y,y,v),Pc(f,l.x,l.y,a.x,S+a.y,u.x+u.w,u.y,i,w,g.x,h.y,y,v),Pc(f,l.x,l.y,s.x,S+s.y,u.x,u.y+u.h,i,w,h.x,g.y,y,v),Pc(f,l.x,l.y,c.x,S+c.y,u.x+u.w,u.y+u.h,i,w,g.x,g.y,y,v),Dc(t.dynamicLayoutVertexArray,l,_),d.emplaceBack(E,E+1,E+2),d.emplaceBack(E+1,E+2,E+3),m.vertexLength+=4,m.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(b[0]),e!==r.length-1&&T===r[e+1].sectionIndex||t.programConfigurations.populatePaintArrays(f.length,o,o.index,{},p,x&&x[T])}t.placedSymbolArray.emplaceBack(l.x,l.y,g,this.glyphOffsetArray.length-g,y,c,u,l.segment,i?i[0]:0,i?i[1]:0,n[0],n[1],s,0,!1,0,h)}_addCollisionDebugVertex(e,t,r,i,n,a){return t.emplaceBack(0,0),e.emplaceBack(r.x,r.y,i,n,Math.round(a.x),Math.round(a.y))}addCollisionDebugVertices(e,t,r,i,n,a,o){const s=n.segments.prepareSegment(4,n.layoutVertexArray,n.indexArray),l=s.vertexLength,c=n.layoutVertexArray,u=n.collisionVertexArray,h=o.anchorX,p=o.anchorY;this._addCollisionDebugVertex(c,u,a,h,p,new S(e,t)),this._addCollisionDebugVertex(c,u,a,h,p,new S(r,t)),this._addCollisionDebugVertex(c,u,a,h,p,new S(r,i)),this._addCollisionDebugVertex(c,u,a,h,p,new S(e,i)),s.vertexLength+=4;const d=n.indexArray;d.emplaceBack(l,l+1),d.emplaceBack(l+1,l+2),d.emplaceBack(l+2,l+3),d.emplaceBack(l+3,l),s.primitiveLength+=4}addDebugCollisionBoxes(e,t,r,i){for(let n=e;n<t;n++){const e=this.collisionBoxArray.get(n);this.addCollisionDebugVertices(e.x1,e.y1,e.x2,e.y2,i?this.textCollisionBox:this.iconCollisionBox,e.anchorPoint,r)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Rc(ca,nl.members,pa),this.iconCollisionBox=new Rc(ca,nl.members,pa);for(let e=0;e<this.symbolInstances.length;e++){const t=this.symbolInstances.get(e);this.addDebugCollisionBoxes(t.textBoxStartIndex,t.textBoxEndIndex,t,!0),this.addDebugCollisionBoxes(t.verticalTextBoxStartIndex,t.verticalTextBoxEndIndex,t,!0),this.addDebugCollisionBoxes(t.iconBoxStartIndex,t.iconBoxEndIndex,t,!1),this.addDebugCollisionBoxes(t.verticalIconBoxStartIndex,t.verticalIconBoxEndIndex,t,!1)}}_deserializeCollisionBoxesForSymbol(e,t,r,i,n,a,o,s,l){const c={};for(let i=t;i<r;i++){const t=e.get(i);c.textBox={x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2,anchorPointX:t.anchorPointX,anchorPointY:t.anchorPointY},c.textFeatureIndex=t.featureIndex;break}for(let t=i;t<n;t++){const r=e.get(t);c.verticalTextBox={x1:r.x1,y1:r.y1,x2:r.x2,y2:r.y2,anchorPointX:r.anchorPointX,anchorPointY:r.anchorPointY},c.verticalTextFeatureIndex=r.featureIndex;break}for(let t=a;t<o;t++){const r=e.get(t);c.iconBox={x1:r.x1,y1:r.y1,x2:r.x2,y2:r.y2,anchorPointX:r.anchorPointX,anchorPointY:r.anchorPointY},c.iconFeatureIndex=r.featureIndex;break}for(let t=s;t<l;t++){const r=e.get(t);c.verticalIconBox={x1:r.x1,y1:r.y1,x2:r.x2,y2:r.y2,anchorPointX:r.anchorPointX,anchorPointY:r.anchorPointY},c.verticalIconFeatureIndex=r.featureIndex;break}return c}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let t=0;t<this.symbolInstances.length;t++){const r=this.symbolInstances.get(t);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,r.textBoxStartIndex,r.textBoxEndIndex,r.verticalTextBoxStartIndex,r.verticalTextBoxEndIndex,r.iconBoxStartIndex,r.iconBoxEndIndex,r.verticalIconBoxStartIndex,r.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(e,t){const r=e.placedSymbolArray.get(t),i=r.vertexStartIndex+4*r.numGlyphs;for(let t=r.vertexStartIndex;t<i;t+=4)e.indexArray.emplaceBack(t,t+1,t+2),e.indexArray.emplaceBack(t+1,t+2,t+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const t=Math.sin(e),r=Math.cos(e),i=[],n=[],a=[];for(let e=0;e<this.symbolInstances.length;++e){a.push(e);const o=this.symbolInstances.get(e);i.push(0|Math.round(t*o.anchorX+r*o.anchorY)),n.push(o.featureIndex)}return a.sort(((e,t)=>i[e]-i[t]||n[t]-n[e])),a}addToSortKeyRanges(e,t){const r=this.sortKeyRanges[this.sortKeyRanges.length-1];r&&r.sortKey===t?r.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:t,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const e of this.symbolInstanceIndexes){const t=this.symbolInstances.get(e);this.featureSortOrder.push(t.featureIndex),[t.rightJustifiedTextSymbolIndex,t.centerJustifiedTextSymbolIndex,t.leftJustifiedTextSymbolIndex].forEach(((e,t,r)=>{e>=0&&r.indexOf(e)===t&&this.addIndicesForPlacedSymbol(this.text,e)})),t.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,t.verticalPlacedTextSymbolIndex),t.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,t.placedIconSymbolIndex),t.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,t.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}Ai("SymbolBucket",Fc,{omit:["layers","collisionBoxArray","features","compareText"]}),Fc.MAX_GLYPHS=65535,Fc.addDynamicAttributes=Dc;const Oc=new dn({"symbol-placement":new ln(ie.layout_symbol["symbol-placement"]),"symbol-spacing":new ln(ie.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new ln(ie.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new cn(ie.layout_symbol["symbol-sort-key"]),"symbol-z-order":new ln(ie.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new ln(ie.layout_symbol["icon-allow-overlap"]),"icon-overlap":new ln(ie.layout_symbol["icon-overlap"]),"icon-ignore-placement":new ln(ie.layout_symbol["icon-ignore-placement"]),"icon-optional":new ln(ie.layout_symbol["icon-optional"]),"icon-rotation-alignment":new ln(ie.layout_symbol["icon-rotation-alignment"]),"icon-size":new cn(ie.layout_symbol["icon-size"]),"icon-text-fit":new ln(ie.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new ln(ie.layout_symbol["icon-text-fit-padding"]),"icon-image":new cn(ie.layout_symbol["icon-image"]),"icon-rotate":new cn(ie.layout_symbol["icon-rotate"]),"icon-padding":new cn(ie.layout_symbol["icon-padding"]),"icon-keep-upright":new ln(ie.layout_symbol["icon-keep-upright"]),"icon-offset":new cn(ie.layout_symbol["icon-offset"]),"icon-anchor":new cn(ie.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new ln(ie.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new ln(ie.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new ln(ie.layout_symbol["text-rotation-alignment"]),"text-field":new cn(ie.layout_symbol["text-field"]),"text-font":new cn(ie.layout_symbol["text-font"]),"text-size":new cn(ie.layout_symbol["text-size"]),"text-max-width":new cn(ie.layout_symbol["text-max-width"]),"text-line-height":new ln(ie.layout_symbol["text-line-height"]),"text-letter-spacing":new cn(ie.layout_symbol["text-letter-spacing"]),"text-justify":new cn(ie.layout_symbol["text-justify"]),"text-radial-offset":new cn(ie.layout_symbol["text-radial-offset"]),"text-variable-anchor":new ln(ie.layout_symbol["text-variable-anchor"]),"text-anchor":new cn(ie.layout_symbol["text-anchor"]),"text-max-angle":new ln(ie.layout_symbol["text-max-angle"]),"text-writing-mode":new ln(ie.layout_symbol["text-writing-mode"]),"text-rotate":new cn(ie.layout_symbol["text-rotate"]),"text-padding":new ln(ie.layout_symbol["text-padding"]),"text-keep-upright":new ln(ie.layout_symbol["text-keep-upright"]),"text-transform":new cn(ie.layout_symbol["text-transform"]),"text-offset":new cn(ie.layout_symbol["text-offset"]),"text-allow-overlap":new ln(ie.layout_symbol["text-allow-overlap"]),"text-overlap":new ln(ie.layout_symbol["text-overlap"]),"text-ignore-placement":new ln(ie.layout_symbol["text-ignore-placement"]),"text-optional":new ln(ie.layout_symbol["text-optional"])});var Uc={paint:new dn({"icon-opacity":new cn(ie.paint_symbol["icon-opacity"]),"icon-color":new cn(ie.paint_symbol["icon-color"]),"icon-halo-color":new cn(ie.paint_symbol["icon-halo-color"]),"icon-halo-width":new cn(ie.paint_symbol["icon-halo-width"]),"icon-halo-blur":new cn(ie.paint_symbol["icon-halo-blur"]),"icon-translate":new ln(ie.paint_symbol["icon-translate"]),"icon-translate-anchor":new ln(ie.paint_symbol["icon-translate-anchor"]),"text-opacity":new cn(ie.paint_symbol["text-opacity"]),"text-color":new cn(ie.paint_symbol["text-color"],{runtimeType:me,getOverride:e=>e.textColor,hasOverride:e=>!!e.textColor}),"text-halo-color":new cn(ie.paint_symbol["text-halo-color"]),"text-halo-width":new cn(ie.paint_symbol["text-halo-width"]),"text-halo-blur":new cn(ie.paint_symbol["text-halo-blur"]),"text-translate":new ln(ie.paint_symbol["text-translate"]),"text-translate-anchor":new ln(ie.paint_symbol["text-translate-anchor"])}),layout:Oc};class Vc{constructor(e){if(void 0===e.property.overrides)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=e.property.overrides?e.property.overrides.runtimeType:he,this.defaultValue=e}evaluate(e){if(e.formattedSection){const t=this.defaultValue.property.overrides;if(t&&t.hasOverride(e.formattedSection))return t.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Ai("FormatSectionOverride",Vc,{omit:["defaultValue"]});class $c extends mn{constructor(e){super(e,Uc)}recalculate(e,t){if(super.recalculate(e,t),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]="map"===this.layout.get("text-rotation-alignment")?"map":"viewport"),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),"point"===this.layout.get("symbol-placement")){const e=this.layout.get("text-writing-mode");if(e){const t=[];for(const r of e)t.indexOf(r)<0&&t.push(r);this.layout._values["text-writing-mode"]=t}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(e,t,r,i){const n=this.layout.get(e).evaluate(t,{},r,i),a=this._unevaluatedLayout._values[e];return a.isDataDriven()||Dr(a.value)||!n?n:function(e,t){return t.replace(/{([^{}]+)}/g,((t,r)=>r in e?String(e[r]):""))}(t.properties,n)}createBucket(e){return new Fc(e)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const e of Uc.paint.overridableProperties){if(!$c.hasPaintOverride(this.layout,e))continue;const t=this.paint.get(e),r=new Vc(t),i=new Pr(r,t.property.specification);let n=null;n="constant"===t.value.kind||"source"===t.value.kind?new Br("source",i):new Rr("composite",i,t.value.zoomStops),this.paint._values[e]=new on(t.property,n,t.parameters)}}_handleOverridablePaintPropertyUpdate(e,t,r){return!(!this.layout||t.isDataDriven()||r.isDataDriven())&&$c.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,t){const r=e.get("text-field"),i=Uc.paint.properties[t];let n=!1;const a=e=>{for(const t of e)if(i.overrides&&i.overrides.hasOverride(t))return void(n=!0)};if("constant"===r.value.kind&&r.value.value instanceof Fe)a(r.value.value.sections);else if("source"===r.value.kind){const e=t=>{n||(t instanceof qe&&Ne(t.value)===xe?a(t.value.sections):t instanceof ur?a(t.sections):t.eachChild(e))},t=r.value;t._styleExpression&&e(t._styleExpression.expression)}return n}}function Nc(e,t,r){let i="never";const n=e.get(t);return n?i=n:e.get(r)&&(i="always"),i}var jc={paint:new dn({"background-color":new ln(ie.paint_background["background-color"]),"background-pattern":new hn(ie.paint_background["background-pattern"]),"background-opacity":new ln(ie.paint_background["background-opacity"])})},qc={paint:new dn({"raster-opacity":new ln(ie.paint_raster["raster-opacity"]),"raster-hue-rotate":new ln(ie.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new ln(ie.paint_raster["raster-brightness-min"]),"raster-brightness-max":new ln(ie.paint_raster["raster-brightness-max"]),"raster-saturation":new ln(ie.paint_raster["raster-saturation"]),"raster-contrast":new ln(ie.paint_raster["raster-contrast"]),"raster-resampling":new ln(ie.paint_raster["raster-resampling"]),"raster-fade-duration":new ln(ie.paint_raster["raster-fade-duration"])})};class Gc extends mn{constructor(e){super(e,{}),this.onAdd=e=>{this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)},this.onRemove=e=>{this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)},this.implementation=e}is3D(){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}const Zc={circle:class extends mn{constructor(e){super(e,uo)}createBucket(e){return new Wa(e)}queryRadius(e){const t=e;return oo("circle-radius",this,t)+oo("circle-stroke-width",this,t)+so(this.paint.get("circle-translate"))}queryIntersectsFeature(e,t,r,i,n,a,o,s){const l=lo(e,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),a.angle,o),c=this.paint.get("circle-radius").evaluate(t,r)+this.paint.get("circle-stroke-width").evaluate(t,r),u="map"===this.paint.get("circle-pitch-alignment"),h=u?l:function(e,t){return e.map((e=>To(e,t)))}(l,s),p=u?c*o:c;for(const e of i)for(const t of e){const e=u?t:To(t,s);let r=p;const i=bo([],[t.x,t.y,0,1],s);if("viewport"===this.paint.get("circle-pitch-scale")&&"map"===this.paint.get("circle-pitch-alignment")?r*=i[3]/a.cameraToCenterDistance:"map"===this.paint.get("circle-pitch-scale")&&"viewport"===this.paint.get("circle-pitch-alignment")&&(r*=a.cameraToCenterDistance/i[3]),Ka(h,e,r))return!0}return!1}},heatmap:class extends mn{constructor(e){super(e,So),this._updateColorRamp()}createBucket(e){return new Eo(e)}_handleSpecialPaintPropertyUpdate(e){"heatmap-color"===e&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Mo({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(){return 0}queryIntersectsFeature(){return!1}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}},hillshade:class extends mn{constructor(e){super(e,Po)}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}},fill:class extends mn{constructor(e){super(e,_s)}recalculate(e,t){super.recalculate(e,t);const r=this.paint._values["fill-outline-color"];"constant"===r.value.kind&&void 0===r.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(e){return new gs(e)}queryRadius(){return so(this.paint.get("fill-translate"))}queryIntersectsFeature(e,t,r,i,n,a,o){return Ya(lo(e,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),a.angle,o),i)}isTileClipped(){return!0}},"fill-extrusion":class extends mn{constructor(e){super(e,Vs)}createBucket(e){return new Fs(e)}queryRadius(){return so(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature(e,t,r,i,n,a,o,s){const l=lo(e,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),a.angle,o),c=this.paint.get("fill-extrusion-height").evaluate(t,r),u=this.paint.get("fill-extrusion-base").evaluate(t,r),h=function(e,t,r,i){const n=[];for(const r of e){const e=[r.x,r.y,0,1];bo(e,e,t),n.push(new S(e[0]/e[3],e[1]/e[3]))}return n}(l,s),p=function(e,t,r,i){const n=[],a=[],o=i[8]*t,s=i[9]*t,l=i[10]*t,c=i[11]*t,u=i[8]*r,h=i[9]*r,p=i[10]*r,d=i[11]*r;for(const t of e){const e=[],r=[];for(const n of t){const t=n.x,a=n.y,f=i[0]*t+i[4]*a+i[12],m=i[1]*t+i[5]*a+i[13],g=i[2]*t+i[6]*a+i[14],y=i[3]*t+i[7]*a+i[15],_=g+l,x=y+c,v=f+u,b=m+h,w=g+p,T=y+d,E=new S((f+o)/x,(m+s)/x);E.z=_/x,e.push(E);const A=new S(v/T,b/T);A.z=w/T,r.push(A)}n.push(e),a.push(r)}return[n,a]}(i,u,c,s);return function(e,t,r){let i=1/0;Ya(r,t)&&(i=Ns(r,t[0]));for(let n=0;n<t.length;n++){const a=t[n],o=e[n];for(let e=0;e<a.length-1;e++){const t=a[e],n=[t,a[e+1],o[e+1],o[e],t];Ha(r,n)&&(i=Math.min(i,Ns(r,n)))}}return i!==1/0&&i}(p[0],p[1],h)}},line:class extends mn{constructor(e){super(e,Js),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(e){"line-gradient"===e&&(this.stepInterpolant=this._transitionablePaint._values["line-gradient"].value.expression._styleExpression.expression instanceof Et,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER)}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(e,t){super.recalculate(e,t),this.paint._values["line-floorwidth"]=Qs.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,e)}createBucket(e){return new Ks(e)}queryRadius(e){const t=e,r=el(oo("line-width",this,t),oo("line-gap-width",this,t)),i=oo("line-offset",this,t);return r/2+Math.abs(i)+so(this.paint.get("line-translate"))}queryIntersectsFeature(e,t,r,i,n,a,o){const s=lo(e,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),a.angle,o),l=o/2*el(this.paint.get("line-width").evaluate(t,r),this.paint.get("line-gap-width").evaluate(t,r)),c=this.paint.get("line-offset").evaluate(t,r);return c&&(i=function(e,t){const r=[];for(let i=0;i<e.length;i++){const n=e[i],a=[];for(let e=0;e<n.length;e++){const r=n[e-1],i=n[e],o=n[e+1],s=0===e?new S(0,0):i.sub(r)._unit()._perp(),l=e===n.length-1?new S(0,0):o.sub(i)._unit()._perp(),c=s._add(l)._unit(),u=c.x*l.x+c.y*l.y;0!==u&&c._mult(1/u),a.push(c._mult(t)._add(i))}r.push(a)}return r}(i,c*o)),function(e,t,r){for(let i=0;i<t.length;i++){const n=t[i];if(e.length>=3)for(let t=0;t<n.length;t++)if(no(e,n[t]))return!0;if(Ja(e,n,r))return!0}return!1}(s,i,l)}isTileClipped(){return!0}},symbol:$c,background:class extends mn{constructor(e){super(e,jc)}},raster:class extends mn{constructor(e){super(e,qc)}}};class Xc{constructor(e){this._callback=e,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){delete this._channel,this._callback=()=>{}}}const Wc=6371008.8;class Hc{constructor(e,t){if(isNaN(e)||isNaN(t))throw new Error(`Invalid LngLat object: (${e}, ${t})`);if(this.lng=+e,this.lat=+t,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Hc(o(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const t=Math.PI/180,r=this.lat*t,i=e.lat*t,n=Math.sin(r)*Math.sin(i)+Math.cos(r)*Math.cos(i)*Math.cos((e.lng-this.lng)*t);return Wc*Math.acos(Math.min(n,1))}toBounds(e=0){const t=360*e/40075017,r=t/Math.cos(Math.PI/180*this.lat);return new Kc(new Hc(this.lng-r,this.lat-t),new Hc(this.lng+r,this.lat+t))}static convert(e){if(e instanceof Hc)return e;if(Array.isArray(e)&&(2===e.length||3===e.length))return new Hc(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&"object"==typeof e&&null!==e)return new Hc(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class Kc{constructor(e,t){e&&(t?this.setSouthWest(e).setNorthEast(t):4===e.length?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]))}setNorthEast(e){return this._ne=e instanceof Hc?new Hc(e.lng,e.lat):Hc.convert(e),this}setSouthWest(e){return this._sw=e instanceof Hc?new Hc(e.lng,e.lat):Hc.convert(e),this}extend(e){const t=this._sw,r=this._ne;let i,n;if(e instanceof Hc)i=e,n=e;else{if(!(e instanceof Kc))return Array.isArray(e)?4===e.length||e.every(Array.isArray)?this.extend(Kc.convert(e)):this.extend(Hc.convert(e)):this;if(i=e._sw,n=e._ne,!i||!n)return this}return t||r?(t.lng=Math.min(i.lng,t.lng),t.lat=Math.min(i.lat,t.lat),r.lng=Math.max(n.lng,r.lng),r.lat=Math.max(n.lat,r.lat)):(this._sw=new Hc(i.lng,i.lat),this._ne=new Hc(n.lng,n.lat)),this}getCenter(){return new Hc((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Hc(this.getWest(),this.getNorth())}getSouthEast(){return new Hc(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:t,lat:r}=Hc.convert(e);let i=this._sw.lng<=t&&t<=this._ne.lng;return this._sw.lng>this._ne.lng&&(i=this._sw.lng>=t&&t>=this._ne.lng),this._sw.lat<=r&&r<=this._ne.lat&&i}static convert(e){return e instanceof Kc?e:e?new Kc(e):e}}const Yc=2*Math.PI*Wc;function Jc(e){return Yc*Math.cos(e*Math.PI/180)}function Qc(e){return(180+e)/360}function eu(e){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e*Math.PI/360)))/360}function tu(e,t){return e/Jc(t)}function ru(e){return 360/Math.PI*Math.atan(Math.exp((180-360*e)*Math.PI/180))-90}class iu{constructor(e,t,r=0){this.x=+e,this.y=+t,this.z=+r}static fromLngLat(e,t=0){const r=Hc.convert(e);return new iu(Qc(r.lng),eu(r.lat),tu(t,r.lat))}toLngLat(){return new Hc(360*this.x-180,ru(this.y))}toAltitude(){return this.z*Jc(ru(this.y))}meterInMercatorCoordinateUnits(){return 1/Yc*(e=ru(this.y),1/Math.cos(e*Math.PI/180));var e}}function nu(e,t,r){var i=2*Math.PI*6378137/256/Math.pow(2,r);return[e*i-2*Math.PI*6378137/2,t*i-2*Math.PI*6378137/2]}class au{constructor(e,t,r){if(e<0||e>25||r<0||r>=Math.pow(2,e)||t<0||t>=Math.pow(2,e))throw new Error(`x=${t}, y=${r}, z=${e} outside of bounds. 0<=x<${Math.pow(2,e)}, 0<=y<${Math.pow(2,e)} 0<=z<=25 `);this.z=e,this.x=t,this.y=r,this.key=lu(0,e,e,t,r)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,t,r){const i=(a=this.y,o=this.z,s=nu(256*(n=this.x),256*(a=Math.pow(2,o)-a-1),o),l=nu(256*(n+1),256*(a+1),o),s[0]+","+s[1]+","+l[0]+","+l[1]);var n,a,o,s,l;const c=function(e,t,r){let i,n="";for(let a=e;a>0;a--)i=1<<a-1,n+=(t&i?1:0)+(r&i?2:0);return n}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===r?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,t>1?"@2x":"").replace(/{quadkey}/g,c).replace(/{bbox-epsg-3857}/g,i)}isChildOf(e){const t=this.z-e.z;return t>0&&e.x===this.x>>t&&e.y===this.y>>t}getTilePoint(e){const t=Math.pow(2,this.z);return new S((e.x*t-this.x)*Na,(e.y*t-this.y)*Na)}toString(){return`${this.z}/${this.x}/${this.y}`}}class ou{constructor(e,t){this.wrap=e,this.canonical=t,this.key=lu(e,t.z,t.z,t.x,t.y)}}class su{constructor(e,t,r,i,n){if(e<r)throw new Error(`overscaledZ should be >= z; overscaledZ = ${e}; z = ${r}`);this.overscaledZ=e,this.wrap=t,this.canonical=new au(r,+i,+n),this.key=lu(t,e,r,i,n)}clone(){return new su(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){if(e>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${e}; overscaledZ = ${this.overscaledZ}`);const t=this.canonical.z-e;return e>this.canonical.z?new su(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new su(e,this.wrap,e,this.canonical.x>>t,this.canonical.y>>t)}calculateScaledKey(e,t){if(e>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${e}; overscaledZ = ${this.overscaledZ}`);const r=this.canonical.z-e;return e>this.canonical.z?lu(this.wrap*+t,e,this.canonical.z,this.canonical.x,this.canonical.y):lu(this.wrap*+t,e,e,this.canonical.x>>r,this.canonical.y>>r)}isChildOf(e){if(e.wrap!==this.wrap)return!1;const t=this.canonical.z-e.canonical.z;return 0===e.overscaledZ||e.overscaledZ<this.overscaledZ&&e.canonical.x===this.canonical.x>>t&&e.canonical.y===this.canonical.y>>t}children(e){if(this.overscaledZ>=e)return[new su(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const t=this.canonical.z+1,r=2*this.canonical.x,i=2*this.canonical.y;return[new su(t,this.wrap,t,r,i),new su(t,this.wrap,t,r+1,i),new su(t,this.wrap,t,r,i+1),new su(t,this.wrap,t,r+1,i+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new su(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new su(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new ou(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(e){return this.canonical.getTilePoint(new iu(e.x-this.wrap,e.y))}}function lu(e,t,r,i,n){(e*=2)<0&&(e=-1*e-1);const a=1<<r;return(a*a*e+a*n+i).toString(36)+r.toString(36)+t.toString(36)}Ai("CanonicalTileID",au),Ai("OverscaledTileID",su,{omit:["posMatrix"]});class cu{constructor(e,t,r){if(this.uid=e,t.height!==t.width)throw new RangeError("DEM tiles must be square");if(r&&"mapbox"!==r&&"terrarium"!==r)return void f(`"${r}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=t.height;const i=this.dim=t.height-2;this.data=new Uint32Array(t.data.buffer),this.encoding=r||"mapbox";for(let e=0;e<i;e++)this.data[this._idx(-1,e)]=this.data[this._idx(0,e)],this.data[this._idx(i,e)]=this.data[this._idx(i-1,e)],this.data[this._idx(e,-1)]=this.data[this._idx(e,0)],this.data[this._idx(e,i)]=this.data[this._idx(e,i-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(i,-1)]=this.data[this._idx(i-1,0)],this.data[this._idx(-1,i)]=this.data[this._idx(0,i-1)],this.data[this._idx(i,i)]=this.data[this._idx(i-1,i-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let e=0;e<i;e++)for(let t=0;t<i;t++){const r=this.get(e,t);r>this.max&&(this.max=r),r<this.min&&(this.min=r)}}get(e,t){const r=new Uint8Array(this.data.buffer),i=4*this._idx(e,t);return("terrarium"===this.encoding?this._unpackTerrarium:this._unpackMapbox)(r[i],r[i+1],r[i+2])}getUnpackVector(){return"terrarium"===this.encoding?[256,1,1/256,32768]:[6553.6,25.6,.1,1e4]}_idx(e,t){if(e<-1||e>=this.dim+1||t<-1||t>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(t+1)*this.stride+(e+1)}_unpackMapbox(e,t,r){return(256*e*256+256*t+r)/10-1e4}_unpackTerrarium(e,t,r){return 256*e+t+r/256-32768}getPixels(){return new zo({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(e,t,r){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let i=t*this.dim,n=t*this.dim+this.dim,a=r*this.dim,o=r*this.dim+this.dim;switch(t){case-1:i=n-1;break;case 1:n=i+1}switch(r){case-1:a=o-1;break;case 1:o=a+1}const s=-t*this.dim,l=-r*this.dim;for(let t=a;t<o;t++)for(let r=i;r<n;r++)this.data[this._idx(r,t)]=e.data[this._idx(r+s,t+l)]}}Ai("DEMData",cu);class uu{constructor(e){this._stringToNumber={},this._numberToString=[];for(let t=0;t<e.length;t++){const r=e[t];this._stringToNumber[r]=t,this._numberToString[t]=r}}encode(e){return this._stringToNumber[e]}decode(e){if(e>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${e} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[e]}}class hu{constructor(e,t,r,i,n){this.type="Feature",this._vectorTileFeature=e,e._z=t,e._x=r,e._y=i,this.properties=e.properties,this.id=n}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={geometry:this.geometry};for(const t in this)"_geometry"!==t&&"_vectorTileFeature"!==t&&(e[t]=this[t]);return e}}class pu{constructor(e,t){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Ei(Na,16,0),this.grid3D=new Ei(Na,16,0),this.featureIndexArray=new Jn,this.promoteId=t}insert(e,t,r,i,n,a){const o=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(r,i,n);const s=a?this.grid3D:this.grid;for(let e=0;e<t.length;e++){const r=t[e],i=[1/0,1/0,-1/0,-1/0];for(let e=0;e<r.length;e++){const t=r[e];i[0]=Math.min(i[0],t.x),i[1]=Math.min(i[1],t.y),i[2]=Math.max(i[2],t.x),i[3]=Math.max(i[3],t.y)}i[0]<Na&&i[1]<Na&&i[2]>=0&&i[3]>=0&&s.insert(o,i[0],i[1],i[2],i[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=new ws.VectorTile(new cl(this.rawTileData)).layers,this.sourceLayerCoder=new uu(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers}query(e,t,r,i){this.loadVTLayers();const n=e.params||{},a=Na/e.tileSize/e.scale,o=Wr(n.filter),s=e.queryGeometry,l=e.queryPadding*a,c=fu(s),u=this.grid.query(c.minX-l,c.minY-l,c.maxX+l,c.maxY+l),h=fu(e.cameraQueryGeometry),p=this.grid3D.query(h.minX-l,h.minY-l,h.maxX+l,h.maxY+l,((t,r,i,n)=>function(e,t,r,i,n){for(const a of e)if(t<=a.x&&r<=a.y&&i>=a.x&&n>=a.y)return!0;const a=[new S(t,r),new S(t,n),new S(i,n),new S(i,r)];if(e.length>2)for(const t of a)if(no(e,t))return!0;for(let t=0;t<e.length-1;t++)if(ao(e[t],e[t+1],a))return!0;return!1}(e.cameraQueryGeometry,t-l,r-l,i+l,n+l)));for(const e of p)u.push(e);u.sort(mu);const d={};let f;for(let l=0;l<u.length;l++){const c=u[l];if(c===f)continue;f=c;const h=this.featureIndexArray.get(c);let p=null;this.loadMatchingFeature(d,h.bucketIndex,h.sourceLayerIndex,h.featureIndex,o,n.layers,n.availableImages,t,r,i,((t,r,i)=>(p||(p=Ga(t)),r.queryIntersectsFeature(s,t,i,p,this.z,e.transform,a,e.pixelPosMatrix))))}return d}loadMatchingFeature(e,t,r,i,n,a,o,l,c,u,h){const p=this.bucketLayerIDs[t];if(a&&!function(e,t){for(let r=0;r<e.length;r++)if(t.indexOf(e[r])>=0)return!0;return!1}(a,p))return;const d=this.sourceLayerCoder.decode(r),f=this.vtLayers[d].feature(i);if(n.needGeometry){const e=Za(f,!0);if(!n.filter(new Ji(this.tileID.overscaledZ),e,this.tileID.canonical))return}else if(!n.filter(new Ji(this.tileID.overscaledZ),f))return;const m=this.getId(f,d);for(let t=0;t<p.length;t++){const r=p[t];if(a&&a.indexOf(r)<0)continue;const n=l[r];if(!n)continue;let d={};m&&u&&(d=u.getState(n.sourceLayer||"_geojsonTileLayer",m));const g=s({},c[r]);g.paint=du(g.paint,n.paint,f,d,o),g.layout=du(g.layout,n.layout,f,d,o);const y=!h||h(f,n,d);if(!y)continue;const _=new hu(f,this.z,this.x,this.y,m);_.layer=g;let x=e[r];void 0===x&&(x=e[r]=[]),x.push({featureIndex:i,feature:_,intersectionZ:y})}}lookupSymbolFeatures(e,t,r,i,n,a,o,s){const l={};this.loadVTLayers();const c=Wr(n);for(const n of e)this.loadMatchingFeature(l,r,i,n,c,a,o,s,t);return l}hasLayer(e){for(const t of this.bucketLayerIDs)for(const r of t)if(e===r)return!0;return!1}getId(e,t){let r=e.id;return this.promoteId&&(r=e.properties["string"==typeof this.promoteId?this.promoteId:this.promoteId[t]],"boolean"==typeof r&&(r=Number(r))),r}}function du(e,t,r,i,n){return u(e,((e,a)=>{const o=t instanceof sn?t.get(a):null;return o&&o.evaluate?o.evaluate(r,i,n):o}))}function fu(e){let t=1/0,r=1/0,i=-1/0,n=-1/0;for(const a of e)t=Math.min(t,a.x),r=Math.min(r,a.y),i=Math.max(i,a.x),n=Math.max(n,a.y);return{minX:t,minY:r,maxX:i,maxY:n}}function mu(e,t){return t-e}var gu;Ai("FeatureIndex",pu,{omit:["rawTileData","sourceLayerCoder"]}),e.PerformanceMarkers=void 0,(gu=e.PerformanceMarkers||(e.PerformanceMarkers={})).create="create",gu.load="load",gu.fullLoad="fullLoad";let yu=null,_u=[];const xu=1e3/30,vu={mark(e){performance.mark(e)},frame(e){const t=e;null!=yu&&_u.push(t-yu),yu=t},clearMetrics(){yu=null,_u=[],performance.clearMeasures("loadTime"),performance.clearMeasures("fullLoadTime");for(const t in e.PerformanceMarkers)performance.clearMarks(e.PerformanceMarkers[t])},getPerformanceMetrics(){performance.measure("loadTime",e.PerformanceMarkers.create,e.PerformanceMarkers.load),performance.measure("fullLoadTime",e.PerformanceMarkers.create,e.PerformanceMarkers.fullLoad);const t=performance.getEntriesByName("loadTime")[0].duration,r=performance.getEntriesByName("fullLoadTime")[0].duration,i=_u.length,n=1/(_u.reduce(((e,t)=>e+t),0)/i/1e3),a=_u.filter((e=>e>xu)).reduce(((e,t)=>e+(t-xu)/xu),0);return{loadTime:t,fullLoadTime:r,fps:n,percentDroppedFrames:a/(i+a)*100}}};e.AJAXError=N,e.ARRAY_TYPE=po,e.Actor=class{constructor(e,t,r){this.target=e,this.parent=t,this.mapId=r,this.callbacks={},this.tasks={},this.taskQueue=[],this.cancelCallbacks={},c(["receive","process"],this),this.invoker=new Xc(this.process),this.target.addEventListener("message",this.receive,!1),this.globalScope=y()?e:window}send(e,t,r,i,n=!1){const a=Math.round(1e18*Math.random()).toString(36).substring(0,10);r&&(this.callbacks[a]=r);const o=w(this.globalScope)?void 0:[];return this.target.postMessage({id:a,type:e,hasCallback:!!r,targetMapId:i,mustQueue:n,sourceMapId:this.mapId,data:ki(t,o)},o),{cancel:()=>{r&&delete this.callbacks[a],this.target.postMessage({id:a,type:"<cancel>",targetMapId:i,sourceMapId:this.mapId})}}}receive(e){const t=e.data,r=t.id;if(r&&(!t.targetMapId||this.mapId===t.targetMapId))if("<cancel>"===t.type){delete this.tasks[r];const e=this.cancelCallbacks[r];delete this.cancelCallbacks[r],e&&e()}else y()||t.mustQueue?(this.tasks[r]=t,this.taskQueue.push(r),this.invoker.trigger()):this.processTask(r,t)}process(){if(!this.taskQueue.length)return;const e=this.taskQueue.shift(),t=this.tasks[e];delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),t&&this.processTask(e,t)}processTask(e,t){if("<response>"===t.type){const r=this.callbacks[e];delete this.callbacks[e],r&&(t.error?r(Ci(t.error)):r(null,Ci(t.data)))}else{let r=!1;const i=w(this.globalScope)?void 0:[],n=t.hasCallback?(t,n)=>{r=!0,delete this.cancelCallbacks[e],this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:t?ki(t):null,data:ki(n,i)},i)}:e=>{r=!0};let a=null;const o=Ci(t.data);if(this.parent[t.type])a=this.parent[t.type](t.sourceMapId,o,n);else if(this.parent.getWorkerSource){const e=t.type.split(".");a=this.parent.getWorkerSource(t.sourceMapId,e[0],o.source)[e[1]](o,n)}else n(new Error(`Could not find function ${t.type}`));!r&&a&&a.cancel&&(this.cancelCallbacks[e]=a.cancel)}}remove(){this.invoker.remove(),this.target.removeEventListener("message",this.receive,!1)}},e.AlphaImage=Co,e.CanonicalTileID=au,e.CollisionBoxArray=qn,e.CollisionCircleLayoutArray=class extends Pn{},e.Color=Le,e.DEMData=cu,e.DataConstantProperty=ln,e.DictionaryCoder=uu,e.EXTENT=Na,e.ErrorEvent=te,e.EvaluationParameters=Ji,e.Event=ee,e.Evented=re,e.FeatureIndex=pu,e.FillBucket=gs,e.FillExtrusionBucket=Fs,e.GeoJSONFeature=hu,e.ImageAtlas=Fl,e.ImagePosition=Rl,e.LineBucket=Ks,e.LineStripIndexArray=class extends $n{},e.LngLat=Hc,e.LngLatBounds=Kc,e.MercatorCoordinate=iu,e.ONE_EM=ll,e.OverscaledTileID=su,e.PerformanceUtils=vu,e.PosArray=Qn,e.Properties=dn,e.QuadTriangleArray=class extends Ln{},e.RGBAImage=zo,e.RasterBoundsArray=class extends wn{},e.RequestPerformance=class{constructor(e){this._marks={start:[e.url,"start"].join("#"),end:[e.url,"end"].join("#"),measure:e.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let e=performance.getEntriesByName(this._marks.measure);return 0===e.length&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),e=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),e}},e.ResourceType=$,e.SegmentVector=ma,e.SymbolBucket=Fc,e.Transitionable=tn,e.TriangleIndexArray=ha,e.Uniform1f=ka,e.Uniform1i=class extends Ia{constructor(e,t){super(e,t),this.current=0}set(e){this.current!==e&&(this.current=e,this.gl.uniform1i(this.location,e))}},e.Uniform2f=class extends Ia{constructor(e,t){super(e,t),this.current=[0,0]}set(e){e[0]===this.current[0]&&e[1]===this.current[1]||(this.current=e,this.gl.uniform2f(this.location,e[0],e[1]))}},e.Uniform3f=class extends Ia{constructor(e,t){super(e,t),this.current=[0,0,0]}set(e){e[0]===this.current[0]&&e[1]===this.current[1]&&e[2]===this.current[2]||(this.current=e,this.gl.uniform3f(this.location,e[0],e[1],e[2]))}},e.Uniform4f=Ca,e.UniformColor=za,e.UniformMatrix4f=class extends Ia{constructor(e,t){super(e,t),this.current=Ma}set(e){if(e[12]!==this.current[12]||e[0]!==this.current[0])return this.current=e,void this.gl.uniformMatrix4fv(this.location,!1,e);for(let t=1;t<16;t++)if(e[t]!==this.current[t]){this.current=e,this.gl.uniformMatrix4fv(this.location,!1,e);break}}},e.UnwrappedTileID=ou,e.ValidationError=ne,e.ZoomHistory=zi,e.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e},e.addDynamicAttributes=Dc,e.asyncAll=function(e,t,r){if(!e.length)return r(null,[]);let i=e.length;const n=new Array(e.length);let a=null;e.forEach(((e,o)=>{t(e,((e,t)=>{e&&(a=e),n[o]=t,0==--i&&r(a,n)}))}))},e.bezier=i,e.bindAll=c,e.cacheEntryPossiblyAdded=function(e){L++,L>P&&(e.getActor().send("enforceCacheSizeLimit",M),L=0)},e.clamp=a,e.clearTileCache=function(e){const t=caches.delete(k);e&&t.catch(e).then((()=>e()))},e.clipLine=uc,e.clone=function(e){var t=new po(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},e.clone$1=p,e.clone$2=function(e){var t=new po(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},e.collisionCircleLayout=al,e.config=I,e.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},e.create=function(){var e=new po(16);return po!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e},e.create$1=fo,e.createExpression=Lr,e.createFilter=Wr,e.createLayout=xn,e.createStyleLayer=function(e){return"custom"===e.type?new Gc(e):new Zc[e.type](e)},e.cross=function(e,t,r){var i=t[0],n=t[1],a=t[2],o=r[0],s=r[1],l=r[2];return e[0]=n*l-a*s,e[1]=a*o-i*l,e[2]=i*s-n*o,e},e.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},e.dot$1=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},e.ease=n,e.emitValidationErrors=Ti,e.enforceCacheSizeLimit=function(e){D(),C&&C.then((t=>{t.keys().then((r=>{for(let i=0;i<r.length-e;i++)t.delete(r[i])}))}))},e.equals=function(e,t){var r=e[0],i=e[1],n=e[2],a=e[3],o=e[4],s=e[5],l=e[6],c=e[7],u=e[8],h=e[9],p=e[10],d=e[11],f=e[12],m=e[13],g=e[14],y=e[15],_=t[0],x=t[1],v=t[2],b=t[3],w=t[4],T=t[5],E=t[6],S=t[7],A=t[8],I=t[9],k=t[10],C=t[11],z=t[12],M=t[13],P=t[14],D=t[15];return Math.abs(r-_)<=ho*Math.max(1,Math.abs(r),Math.abs(_))&&Math.abs(i-x)<=ho*Math.max(1,Math.abs(i),Math.abs(x))&&Math.abs(n-v)<=ho*Math.max(1,Math.abs(n),Math.abs(v))&&Math.abs(a-b)<=ho*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(o-w)<=ho*Math.max(1,Math.abs(o),Math.abs(w))&&Math.abs(s-T)<=ho*Math.max(1,Math.abs(s),Math.abs(T))&&Math.abs(l-E)<=ho*Math.max(1,Math.abs(l),Math.abs(E))&&Math.abs(c-S)<=ho*Math.max(1,Math.abs(c),Math.abs(S))&&Math.abs(u-A)<=ho*Math.max(1,Math.abs(u),Math.abs(A))&&Math.abs(h-I)<=ho*Math.max(1,Math.abs(h),Math.abs(I))&&Math.abs(p-k)<=ho*Math.max(1,Math.abs(p),Math.abs(k))&&Math.abs(d-C)<=ho*Math.max(1,Math.abs(d),Math.abs(C))&&Math.abs(f-z)<=ho*Math.max(1,Math.abs(f),Math.abs(z))&&Math.abs(m-M)<=ho*Math.max(1,Math.abs(m),Math.abs(M))&&Math.abs(g-P)<=ho*Math.max(1,Math.abs(g),Math.abs(P))&&Math.abs(y-D)<=ho*Math.max(1,Math.abs(y),Math.abs(D))},e.evaluateSizeForFeature=function(e,{uSize:t,uSizeT:r},{lowerSize:i,upperSize:n}){return"source"===e.kind?i/ec:"composite"===e.kind?St(i/ec,n/ec,r):t},e.evaluateSizeForZoom=function(e,t){let r=0,i=0;if("constant"===e.kind)i=e.layoutSize;else if("source"!==e.kind){const{interpolationType:n,minZoom:o,maxZoom:s}=e,l=n?a(qt.interpolationFactor(n,t,o,s),0,1):0;"camera"===e.kind?i=St(e.minSize,e.maxSize,l):r=l}return{uSizeT:r,uSize:i}},e.evaluateVariableOffset=Tc,e.evented=Wi,e.exported=E,e.exported$1=B,e.extend=s,e.filterObject=h,e.fromRotation=function(e,t){var r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=0,e[3]=-r,e[4]=i,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},e.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},e.getAnchorAlignment=Kl,e.getAnchorJustification=Ec,e.getArrayBuffer=Z,e.getImage=Y,e.getJSON=function(e,t){return G(s(e,{type:"json"}),t)},e.getOverlapMode=Nc,e.getRTLTextPluginStatus=Hi,e.getReferrer=j,e.getVideo=function(e,t){const r=window.document.createElement("video");r.muted=!0,r.onloadstart=function(){t(null,r)};for(let t=0;t<e.length;t++){const i=window.document.createElement("source");X(e[t])||(r.crossOrigin="Anonymous"),i.src=e[t],r.appendChild(i)}return{cancel:()=>{}}},e.identity=mo,e.invert=function(e,t){var r=t[0],i=t[1],n=t[2],a=t[3],o=t[4],s=t[5],l=t[6],c=t[7],u=t[8],h=t[9],p=t[10],d=t[11],f=t[12],m=t[13],g=t[14],y=t[15],_=r*s-i*o,x=r*l-n*o,v=r*c-a*o,b=i*l-n*s,w=i*c-a*s,T=n*c-a*l,E=u*m-h*f,S=u*g-p*f,A=u*y-d*f,I=h*g-p*m,k=h*y-d*m,C=p*y-d*g,z=_*C-x*k+v*I+b*A-w*S+T*E;return z?(e[0]=(s*C-l*k+c*I)*(z=1/z),e[1]=(n*k-i*C-a*I)*z,e[2]=(m*T-g*w+y*b)*z,e[3]=(p*w-h*T-d*b)*z,e[4]=(l*A-o*C-c*S)*z,e[5]=(r*C-n*A+a*S)*z,e[6]=(g*v-f*T-y*x)*z,e[7]=(u*T-p*v+d*x)*z,e[8]=(o*k-s*A+c*E)*z,e[9]=(i*A-r*k-a*E)*z,e[10]=(f*w-m*v+y*_)*z,e[11]=(h*v-u*w-d*_)*z,e[12]=(s*S-o*I-l*E)*z,e[13]=(r*I-i*S+n*E)*z,e[14]=(m*x-f*b-g*_)*z,e[15]=(u*b-h*x+p*_)*z,e):null},e.isImageBitmap=T,e.isSafari=w,e.isWorker=y,e.keysDifference=function(e,t){const r=[];for(const i in e)i in t||r.push(i);return r},e.lazyLoadRTLTextPlugin=function(){Yi.isLoading()||Yi.isLoaded()||"deferred"!==Hi()||Ki()},e.makeRequest=G,e.mapObject=u,e.mercatorXfromLng=Qc,e.mercatorYfromLat=eu,e.mercatorZfromAltitude=tu,e.mul=_o,e.mul$1=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e[3]=t[3]*r[3],e},e.multiply=go,e.nextPowerOfTwo=function(e){return e<=1?1:Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},e.normalize=function(e,t){var r=t[0],i=t[1],n=t[2],a=r*r+i*i+n*n;return a>0&&(a=1/Math.sqrt(a)),e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*a,e},e.number=St,e.ortho=function(e,t,r,i,n,a,o){var s=1/(t-r),l=1/(i-n),c=1/(a-o);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+r)*s,e[13]=(n+i)*l,e[14]=(o+a)*c,e[15]=1,e},e.parseCacheControl=_,e.parseGlyphPbf=function(e){return new cl(e).readFields(Pl,[])},e.pbf=cl,e.performSymbolLayout=function(t){t.bucket.createArrays(),t.bucket.tilePixelRatio=Na/(512*t.bucket.overscaling),t.bucket.compareText={},t.bucket.iconsNeedLinear=!1;const r=t.bucket.layers[0].layout,i=t.bucket.layers[0]._unevaluatedLayout._values,n={layoutIconSize:i["icon-size"].possiblyEvaluate(new Ji(t.bucket.zoom+1),t.canonical),layoutTextSize:i["text-size"].possiblyEvaluate(new Ji(t.bucket.zoom+1),t.canonical),textMaxSize:i["text-size"].possiblyEvaluate(new Ji(18))};if("composite"===t.bucket.textSizeData.kind){const{minZoom:e,maxZoom:r}=t.bucket.textSizeData;n.compositeTextSizes=[i["text-size"].possiblyEvaluate(new Ji(e),t.canonical),i["text-size"].possiblyEvaluate(new Ji(r),t.canonical)]}if("composite"===t.bucket.iconSizeData.kind){const{minZoom:e,maxZoom:r}=t.bucket.iconSizeData;n.compositeIconSizes=[i["icon-size"].possiblyEvaluate(new Ji(e),t.canonical),i["icon-size"].possiblyEvaluate(new Ji(r),t.canonical)]}const a=r.get("text-line-height")*ll,o="viewport"!==r.get("text-rotation-alignment")&&"point"!==r.get("symbol-placement"),s=r.get("text-keep-upright"),l=r.get("text-size");for(const i of t.bucket.features){const c=r.get("text-font").evaluate(i,{},t.canonical).join(","),u=l.evaluate(i,{},t.canonical),h=n.layoutTextSize.evaluate(i,{},t.canonical),p=n.layoutIconSize.evaluate(i,{},t.canonical),d={horizontal:{},vertical:void 0},m=i.text;let g,y=[0,0];if(m){const n=m.toString(),l=r.get("text-letter-spacing").evaluate(i,{},t.canonical)*ll,p=Di(n)?l:0,f=r.get("text-anchor").evaluate(i,{},t.canonical),g=r.get("text-variable-anchor");if(!g){const e=r.get("text-radial-offset").evaluate(i,{},t.canonical);y=e?Tc(f,[e*ll,wc]):r.get("text-offset").evaluate(i,{},t.canonical).map((e=>e*ll))}let _=o?"center":r.get("text-justify").evaluate(i,{},t.canonical);const x=r.get("symbol-placement"),v="point"===x?r.get("text-max-width").evaluate(i,{},t.canonical)*ll:0,b=()=>{t.bucket.allowVerticalPlacement&&Pi(n)&&(d.vertical=$l(m,t.glyphMap,t.glyphPositions,t.imagePositions,c,v,a,f,"left",p,y,e.WritingMode.vertical,!0,x,h,u))};if(!o&&g){const r="auto"===_?g.map((e=>Ec(e))):[_];let i=!1;for(let n=0;n<r.length;n++){const o=r[n];if(!d.horizontal[o])if(i)d.horizontal[o]=d.horizontal[0];else{const r=$l(m,t.glyphMap,t.glyphPositions,t.imagePositions,c,v,a,"center",o,p,y,e.WritingMode.horizontal,!1,x,h,u);r&&(d.horizontal[o]=r,i=1===r.positionedLines.length)}}b()}else{"auto"===_&&(_=Ec(f));const r=$l(m,t.glyphMap,t.glyphPositions,t.imagePositions,c,v,a,f,_,p,y,e.WritingMode.horizontal,!1,x,h,u);r&&(d.horizontal[_]=r),b(),Pi(n)&&o&&s&&(d.vertical=$l(m,t.glyphMap,t.glyphPositions,t.imagePositions,c,v,a,f,_,p,y,e.WritingMode.vertical,!1,x,h,u))}}let _=!1;if(i.icon&&i.icon.name){const e=t.imageMap[i.icon.name];e&&(g=Jl(t.imagePositions[i.icon.name],r.get("icon-offset").evaluate(i,{},t.canonical),r.get("icon-anchor").evaluate(i,{},t.canonical)),_=!!e.sdf,void 0===t.bucket.sdfIcons?t.bucket.sdfIcons=_:t.bucket.sdfIcons!==_&&f("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(e.pixelRatio!==t.bucket.pixelRatio||0!==r.get("icon-rotate").constantOr(1))&&(t.bucket.iconsNeedLinear=!0))}const x=kc(d.horizontal)||d.vertical;t.bucket.iconsInText=!!x&&x.iconsInText,(x||g)&&Sc(t.bucket,i,d,g,t.imageMap,n,h,p,y,_,t.canonical)}t.showCollisionBoxes&&t.bucket.generateCollisionDebugBuffers()},e.perspective=function(e,t,r,i,n){var a,o=1/Math.tan(t/2);return e[0]=o/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=n&&n!==1/0?(e[10]=(n+i)*(a=1/(i-n)),e[14]=2*n*i*a):(e[10]=-1,e[14]=-2*i),e},e.pick=function(e,t){const r={};for(let i=0;i<t.length;i++){const n=t[i];n in e&&(r[n]=e[n])}return r},e.plugin=Yi,e.pointGeometry=S,e.polygonIntersectsPolygon=Ha,e.potpack=Bl,e.refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"],e.register=Ai,e.registerForPluginStateChange=function(e){return e({pluginStatus:qi,pluginURL:Gi}),Wi.on("pluginStateChange",e),e},e.renderColorRamp=Mo,e.rotateX=function(e,t,r){var i=Math.sin(r),n=Math.cos(r),a=t[4],o=t[5],s=t[6],l=t[7],c=t[8],u=t[9],h=t[10],p=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=a*n+c*i,e[5]=o*n+u*i,e[6]=s*n+h*i,e[7]=l*n+p*i,e[8]=c*n-a*i,e[9]=u*n-o*i,e[10]=h*n-s*i,e[11]=p*n-l*i,e},e.rotateZ=function(e,t,r){var i=Math.sin(r),n=Math.cos(r),a=t[0],o=t[1],s=t[2],l=t[3],c=t[4],u=t[5],h=t[6],p=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=a*n+c*i,e[1]=o*n+u*i,e[2]=s*n+h*i,e[3]=l*n+p*i,e[4]=c*n-a*i,e[5]=u*n-o*i,e[6]=h*n-s*i,e[7]=p*n-l*i,e},e.scale=function(e,t,r){var i=r[0],n=r[1],a=r[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*a,e[9]=t[9]*a,e[10]=t[10]*a,e[11]=t[11]*a,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},e.scale$1=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e},e.setCacheLimits=function(e,t){M=e,P=t},e.setRTLTextPlugin=function(e,t,r=!1){if(qi===Vi||qi===$i||qi===Ni)throw new Error("setRTLTextPlugin cannot be called multiple times.");Gi=E.resolveURL(e),qi=Vi,ji=t,Xi(),r||Ki()},e.spec=ie,e.sphericalToCartesian=function([e,t,r]){return t+=90,t*=Math.PI/180,r*=Math.PI/180,{x:e*Math.cos(t)*Math.sin(r),y:e*Math.sin(t)*Math.sin(r),z:e*Math.cos(r)}},e.sqrLen=function(e){var t=e[0],r=e[1];return t*t+r*r},e.sub=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e},e.toEvaluationFeature=Za,e.transformMat3=function(e,t,r){var i=t[0],n=t[1],a=t[2];return e[0]=i*r[0]+n*r[3]+a*r[6],e[1]=i*r[1]+n*r[4]+a*r[7],e[2]=i*r[2]+n*r[5]+a*r[8],e},e.transformMat4=bo,e.transformMat4$1=function(e,t,r){var i=t[0],n=t[1];return e[0]=r[0]*i+r[4]*n+r[12],e[1]=r[1]*i+r[5]*n+r[13],e},e.translate=function(e,t,r){var i,n,a,o,s,l,c,u,h,p,d,f,m=r[0],g=r[1],y=r[2];return t===e?(e[12]=t[0]*m+t[4]*g+t[8]*y+t[12],e[13]=t[1]*m+t[5]*g+t[9]*y+t[13],e[14]=t[2]*m+t[6]*g+t[10]*y+t[14],e[15]=t[3]*m+t[7]*g+t[11]*y+t[15]):(n=t[1],a=t[2],o=t[3],s=t[4],l=t[5],c=t[6],u=t[7],h=t[8],p=t[9],d=t[10],f=t[11],e[0]=i=t[0],e[1]=n,e[2]=a,e[3]=o,e[4]=s,e[5]=l,e[6]=c,e[7]=u,e[8]=h,e[9]=p,e[10]=d,e[11]=f,e[12]=i*m+s*g+h*y+t[12],e[13]=n*m+l*g+p*y+t[13],e[14]=a*m+c*g+d*y+t[14],e[15]=o*m+u*g+f*y+t[15]),e},e.triggerPluginCompletionEvent=Zi,e.unicodeBlockLookup=Mi,e.uniqueId=function(){return l++},e.validateCustomStyleLayer=function(e){const t=[],r=e.id;return void 0===r&&t.push({message:`layers.${r}: missing required property "id"`}),void 0===e.render&&t.push({message:`layers.${r}: missing required method "render"`}),e.renderingMode&&"2d"!==e.renderingMode&&"3d"!==e.renderingMode&&t.push({message:`layers.${r}: property "renderingMode" must be either "2d" or "3d"`}),t},e.validateLight=vi,e.validateStyle=xi,e.vectorTile=ws,e.warnOnce=f,e.wrap=o})),i(["./shared"],(function(e){function t(e){const r=typeof e;if("number"===r||"boolean"===r||"string"===r||null==e)return JSON.stringify(e);if(Array.isArray(e)){let r="[";for(const i of e)r+=`${t(i)},`;return`${r}]`}const i=Object.keys(e).sort();let n="{";for(let r=0;r<i.length;r++)n+=`${JSON.stringify(i[r])}:${t(e[i[r]])},`;return`${n}}`}function r(r){let i="";for(const n of e.refProperties)i+=`/${t(r[n])}`;return i}class i{constructor(e){this.keyCache={},e&&this.replace(e)}replace(e){this._layerConfigs={},this._layers={},this.update(e,[])}update(t,i){for(const r of t){this._layerConfigs[r.id]=r;const t=this._layers[r.id]=e.createStyleLayer(r);t._featureFilter=e.createFilter(t.filter),this.keyCache[r.id]&&delete this.keyCache[r.id]}for(const e of i)delete this.keyCache[e],delete this._layerConfigs[e],delete this._layers[e];this.familiesBySource={};const n=function(e,t){const i={};for(let n=0;n<e.length;n++){const a=t&&t[e[n].id]||r(e[n]);t&&(t[e[n].id]=a);let o=i[a];o||(o=i[a]=[]),o.push(e[n])}const n=[];for(const e in i)n.push(i[e]);return n}(Object.values(this._layerConfigs),this.keyCache);for(const e of n){const t=e.map((e=>this._layers[e.id])),r=t[0];if("none"===r.visibility)continue;const i=r.source||"";let n=this.familiesBySource[i];n||(n=this.familiesBySource[i]={});const a=r.sourceLayer||"_geojsonTileLayer";let o=n[a];o||(o=n[a]=[]),o.push(t)}}}class n{constructor(t){const r={},i=[];for(const e in t){const n=t[e],a=r[e]={};for(const e in n){const t=n[+e];if(!t||0===t.bitmap.width||0===t.bitmap.height)continue;const r={x:0,y:0,w:t.bitmap.width+2,h:t.bitmap.height+2};i.push(r),a[e]={rect:r,metrics:t.metrics}}}const{w:n,h:a}=e.potpack(i),o=new e.AlphaImage({width:n||1,height:a||1});for(const i in t){const n=t[i];for(const t in n){const a=n[+t];if(!a||0===a.bitmap.width||0===a.bitmap.height)continue;const s=r[i][t].rect;e.AlphaImage.copy(a.bitmap,o,{x:0,y:0},{x:s.x+1,y:s.y+1},a.bitmap)}}this.image=o,this.positions=r}}e.register("GlyphAtlas",n);class a{constructor(t){this.tileID=new e.OverscaledTileID(t.tileID.overscaledZ,t.tileID.wrap,t.tileID.canonical.z,t.tileID.canonical.x,t.tileID.canonical.y),this.uid=t.uid,this.zoom=t.zoom,this.pixelRatio=t.pixelRatio,this.tileSize=t.tileSize,this.source=t.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=t.showCollisionBoxes,this.collectResourceTiming=!!t.collectResourceTiming,this.returnDependencies=!!t.returnDependencies,this.promoteId=t.promoteId}parse(t,r,i,a,s){this.status="parsing",this.data=t,this.collisionBoxArray=new e.CollisionBoxArray;const l=new e.DictionaryCoder(Object.keys(t.layers).sort()),c=new e.FeatureIndex(this.tileID,this.promoteId);c.bucketLayerIDs=[];const u={},h={featureIndex:c,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:i},p=r.familiesBySource[this.source];for(const r in p){const n=t.layers[r];if(!n)continue;1===n.version&&e.warnOnce(`Vector tile source "${this.source}" layer "${r}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const a=l.encode(r),s=[];for(let e=0;e<n.length;e++){const t=n.feature(e),i=c.getId(t,r);s.push({feature:t,id:i,index:e,sourceLayerIndex:a})}for(const t of p[r]){const r=t[0];r.source!==this.source&&e.warnOnce(`layer.source = ${r.source} does not equal this.source = ${this.source}`),r.minzoom&&this.zoom<Math.floor(r.minzoom)||r.maxzoom&&this.zoom>=r.maxzoom||"none"!==r.visibility&&(o(t,this.zoom,i),(u[r.id]=r.createBucket({index:c.bucketLayerIDs.length,layers:t,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:a,sourceID:this.source})).populate(s,h,this.tileID.canonical),c.bucketLayerIDs.push(t.map((e=>e.id))))}}let d,f,m,g;const y=e.mapObject(h.glyphDependencies,(e=>Object.keys(e).map(Number)));Object.keys(y).length?a.send("getGlyphs",{uid:this.uid,stacks:y},((e,t)=>{d||(d=e,f=t,v.call(this))})):f={};const _=Object.keys(h.iconDependencies);_.length?a.send("getImages",{icons:_,source:this.source,tileID:this.tileID,type:"icons"},((e,t)=>{d||(d=e,m=t,v.call(this))})):m={};const x=Object.keys(h.patternDependencies);function v(){if(d)return s(d);if(f&&m&&g){const t=new n(f),r=new e.ImageAtlas(m,g);for(const n in u){const a=u[n];a instanceof e.SymbolBucket?(o(a.layers,this.zoom,i),e.performSymbolLayout({bucket:a,glyphMap:f,glyphPositions:t.positions,imageMap:m,imagePositions:r.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical})):a.hasPattern&&(a instanceof e.LineBucket||a instanceof e.FillBucket||a instanceof e.FillExtrusionBucket)&&(o(a.layers,this.zoom,i),a.addFeatures(h,this.tileID.canonical,r.patternPositions))}this.status="done",s(null,{buckets:Object.values(u).filter((e=>!e.isEmpty())),featureIndex:c,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:t.image,imageAtlas:r,glyphMap:this.returnDependencies?f:null,iconMap:this.returnDependencies?m:null,glyphPositions:this.returnDependencies?t.positions:null})}}x.length?a.send("getImages",{icons:x,source:this.source,tileID:this.tileID,type:"patterns"},((e,t)=>{d||(d=e,g=t,v.call(this))})):g={},v.call(this)}}function o(t,r,i){const n=new e.EvaluationParameters(r);for(const e of t)e.recalculate(n,i)}function s(t,r){const i=e.getArrayBuffer(t.request,((t,i,n,a)=>{t?r(t):i&&r(null,{vectorTile:new e.vectorTile.VectorTile(new e.pbf(i)),rawData:i,cacheControl:n,expires:a})}));return()=>{i.cancel(),r()}}class l{constructor(e,t,r,i){this.actor=e,this.layerIndex=t,this.availableImages=r,this.loadVectorData=i||s,this.loading={},this.loaded={}}loadTile(t,r){const i=t.uid;this.loading||(this.loading={});const n=!!(t&&t.request&&t.request.collectResourceTiming)&&new e.RequestPerformance(t.request),o=this.loading[i]=new a(t);o.abort=this.loadVectorData(t,((t,a)=>{if(delete this.loading[i],t||!a)return o.status="done",this.loaded[i]=o,r(t);const s=a.rawData,l={};a.expires&&(l.expires=a.expires),a.cacheControl&&(l.cacheControl=a.cacheControl);const c={};if(n){const e=n.finish();e&&(c.resourceTiming=JSON.parse(JSON.stringify(e)))}o.vectorTile=a.vectorTile,o.parse(a.vectorTile,this.layerIndex,this.availableImages,this.actor,((t,i)=>{if(t||!i)return r(t);r(null,e.extend({rawTileData:s.slice(0)},i,l,c))})),this.loaded=this.loaded||{},this.loaded[i]=o}))}reloadTile(e,t){const r=this.loaded,i=e.uid,n=this;if(r&&r[i]){const a=r[i];a.showCollisionBoxes=e.showCollisionBoxes;const o=(e,r)=>{const i=a.reloadCallback;i&&(delete a.reloadCallback,a.parse(a.vectorTile,n.layerIndex,this.availableImages,n.actor,i)),t(e,r)};"parsing"===a.status?a.reloadCallback=o:"done"===a.status&&(a.vectorTile?a.parse(a.vectorTile,this.layerIndex,this.availableImages,this.actor,o):o())}}abortTile(e,t){const r=this.loading,i=e.uid;r&&r[i]&&r[i].abort&&(r[i].abort(),delete r[i]),t()}removeTile(e,t){const r=this.loaded,i=e.uid;r&&r[i]&&delete r[i],t()}}class c{constructor(){this.loaded={}}loadTile(t,r){const{uid:i,encoding:n,rawImageData:a}=t,o=e.isImageBitmap(a)?this.getImageData(a):a,s=new e.DEMData(i,o,n);this.loaded=this.loaded||{},this.loaded[i]=s,r(null,s)}getImageData(t){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(t.width,t.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d")),this.offscreenCanvas.width=t.width,this.offscreenCanvas.height=t.height,this.offscreenCanvasContext.drawImage(t,0,0,t.width,t.height);const r=this.offscreenCanvasContext.getImageData(-1,-1,t.width+2,t.height+2);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),new e.RGBAImage({width:r.width,height:r.height},r.data)}removeTile(e){const t=this.loaded,r=e.uid;t&&t[r]&&delete t[r]}}var u=function e(t,r){var i,n=t&&t.type;if("FeatureCollection"===n)for(i=0;i<t.features.length;i++)e(t.features[i],r);else if("GeometryCollection"===n)for(i=0;i<t.geometries.length;i++)e(t.geometries[i],r);else if("Feature"===n)e(t.geometry,r);else if("Polygon"===n)h(t.coordinates,r);else if("MultiPolygon"===n)for(i=0;i<t.coordinates.length;i++)h(t.coordinates[i],r);return t};function h(e,t){if(0!==e.length){p(e[0],t);for(var r=1;r<e.length;r++)p(e[r],!t)}}function p(e,t){for(var r=0,i=0,n=0,a=e.length,o=a-1;n<a;o=n++){var s=(e[n][0]-e[o][0])*(e[o][1]+e[n][1]),l=r+s;i+=Math.abs(r)>=Math.abs(s)?r-l+s:s-l+r,r=l}r+i>=0!=!!t&&e.reverse()}const d=e.vectorTile.VectorTileFeature.prototype.toGeoJSON;class f{constructor(t){this._feature=t,this.extent=e.EXTENT,this.type=t.type,this.properties=t.tags,"id"in t&&!isNaN(t.id)&&(this.id=parseInt(t.id,10))}loadGeometry(){if(1===this._feature.type){const t=[];for(const r of this._feature.geometry)t.push([new e.pointGeometry(r[0],r[1])]);return t}{const t=[];for(const r of this._feature.geometry){const i=[];for(const t of r)i.push(new e.pointGeometry(t[0],t[1]));t.push(i)}return t}}toGeoJSON(e,t,r){return d.call(this,e,t,r)}}class m{constructor(t){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=e.EXTENT,this.length=t.length,this._features=t}feature(e){return new f(this._features[e])}}var g={exports:{}},y=e.pointGeometry,_=e.vectorTile.VectorTileFeature,x=v;function v(e,t){this.options=t||{},this.features=e,this.length=e.length}function b(e,t){this.id="number"==typeof e.id?e.id:void 0,this.type=e.type,this.rawGeometry=1===e.type?[e.geometry]:e.geometry,this.properties=e.tags,this.extent=t||4096}v.prototype.feature=function(e){return new b(this.features[e],this.options.extent)},b.prototype.loadGeometry=function(){var e=this.rawGeometry;this.geometry=[];for(var t=0;t<e.length;t++){for(var r=e[t],i=[],n=0;n<r.length;n++)i.push(new y(r[n][0],r[n][1]));this.geometry.push(i)}return this.geometry},b.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var e=this.geometry,t=1/0,r=-1/0,i=1/0,n=-1/0,a=0;a<e.length;a++)for(var o=e[a],s=0;s<o.length;s++){var l=o[s];t=Math.min(t,l.x),r=Math.max(r,l.x),i=Math.min(i,l.y),n=Math.max(n,l.y)}return[t,i,r,n]},b.prototype.toGeoJSON=_.prototype.toGeoJSON;var w=e.pbf,T=x;function E(e){var t=new w;return function(e,t){for(var r in e.layers)t.writeMessage(3,S,e.layers[r])}(e,t),t.finish()}function S(e,t){var r;t.writeVarintField(15,e.version||1),t.writeStringField(1,e.name||""),t.writeVarintField(5,e.extent||4096);var i={keys:[],values:[],keycache:{},valuecache:{}};for(r=0;r<e.length;r++)i.feature=e.feature(r),t.writeMessage(2,A,i);var n=i.keys;for(r=0;r<n.length;r++)t.writeStringField(3,n[r]);var a=i.values;for(r=0;r<a.length;r++)t.writeMessage(4,M,a[r])}function A(e,t){var r=e.feature;void 0!==r.id&&t.writeVarintField(1,r.id),t.writeMessage(2,I,e),t.writeVarintField(3,r.type),t.writeMessage(4,z,r)}function I(e,t){var r=e.feature,i=e.keys,n=e.values,a=e.keycache,o=e.valuecache;for(var s in r.properties){var l=r.properties[s],c=a[s];if(null!==l){void 0===c&&(i.push(s),a[s]=c=i.length-1),t.writeVarint(c);var u=typeof l;"string"!==u&&"boolean"!==u&&"number"!==u&&(l=JSON.stringify(l));var h=u+":"+l,p=o[h];void 0===p&&(n.push(l),o[h]=p=n.length-1),t.writeVarint(p)}}}function k(e,t){return(t<<3)+(7&e)}function C(e){return e<<1^e>>31}function z(e,t){for(var r=e.loadGeometry(),i=e.type,n=0,a=0,o=r.length,s=0;s<o;s++){var l=r[s],c=1;1===i&&(c=l.length),t.writeVarint(k(1,c));for(var u=3===i?l.length-1:l.length,h=0;h<u;h++){1===h&&1!==i&&t.writeVarint(k(2,u-1));var p=l[h].x-n,d=l[h].y-a;t.writeVarint(C(p)),t.writeVarint(C(d)),n+=p,a+=d}3===i&&t.writeVarint(k(7,1))}}function M(e,t){var r=typeof e;"string"===r?t.writeStringField(1,e):"boolean"===r?t.writeBooleanField(7,e):"number"===r&&(e%1!=0?t.writeDoubleField(3,e):e<0?t.writeSVarintField(6,e):t.writeVarintField(5,e))}function P(e,t,r,i,n,a){if(n-i<=r)return;const o=i+n>>1;D(e,t,o,i,n,a%2),P(e,t,r,i,o-1,a+1),P(e,t,r,o+1,n,a+1)}function D(e,t,r,i,n,a){for(;n>i;){if(n-i>600){const o=n-i+1,s=r-i+1,l=Math.log(o),c=.5*Math.exp(2*l/3),u=.5*Math.sqrt(l*c*(o-c)/o)*(s-o/2<0?-1:1);D(e,t,r,Math.max(i,Math.floor(r-s*c/o+u)),Math.min(n,Math.floor(r+(o-s)*c/o+u)),a)}const o=t[2*r+a];let s=i,l=n;for(L(e,t,i,r),t[2*n+a]>o&&L(e,t,i,n);s<l;){for(L(e,t,s,l),s++,l--;t[2*s+a]<o;)s++;for(;t[2*l+a]>o;)l--}t[2*i+a]===o?L(e,t,i,l):(l++,L(e,t,l,n)),l<=r&&(i=l+1),r<=l&&(n=l-1)}}function L(e,t,r,i){B(e,r,i),B(t,2*r,2*i),B(t,2*r+1,2*i+1)}function B(e,t,r){const i=e[t];e[t]=e[r],e[r]=i}function R(e,t,r,i){const n=e-r,a=t-i;return n*n+a*a}g.exports=E,g.exports.fromVectorTileJs=E,g.exports.fromGeojsonVt=function(e,t){t=t||{};var r={};for(var i in e)r[i]=new T(e[i].features,t),r[i].name=i,r[i].version=t.version,r[i].extent=t.extent;return E({layers:r})},g.exports.GeoJSONWrapper=T;const F=e=>e[0],O=e=>e[1];class U{constructor(e,t=F,r=O,i=64,n=Float64Array){this.nodeSize=i,this.points=e;const a=e.length<65536?Uint16Array:Uint32Array,o=this.ids=new a(e.length),s=this.coords=new n(2*e.length);for(let i=0;i<e.length;i++)o[i]=i,s[2*i]=t(e[i]),s[2*i+1]=r(e[i]);P(o,s,i,0,o.length-1,0)}range(e,t,r,i){return function(e,t,r,i,n,a,o){const s=[0,e.length-1,0],l=[];let c,u;for(;s.length;){const h=s.pop(),p=s.pop(),d=s.pop();if(p-d<=o){for(let o=d;o<=p;o++)c=t[2*o],u=t[2*o+1],c>=r&&c<=n&&u>=i&&u<=a&&l.push(e[o]);continue}const f=Math.floor((d+p)/2);c=t[2*f],u=t[2*f+1],c>=r&&c<=n&&u>=i&&u<=a&&l.push(e[f]);const m=(h+1)%2;(0===h?r<=c:i<=u)&&(s.push(d),s.push(f-1),s.push(m)),(0===h?n>=c:a>=u)&&(s.push(f+1),s.push(p),s.push(m))}return l}(this.ids,this.coords,e,t,r,i,this.nodeSize)}within(e,t,r){return function(e,t,r,i,n,a){const o=[0,e.length-1,0],s=[],l=n*n;for(;o.length;){const c=o.pop(),u=o.pop(),h=o.pop();if(u-h<=a){for(let n=h;n<=u;n++)R(t[2*n],t[2*n+1],r,i)<=l&&s.push(e[n]);continue}const p=Math.floor((h+u)/2),d=t[2*p],f=t[2*p+1];R(d,f,r,i)<=l&&s.push(e[p]);const m=(c+1)%2;(0===c?r-n<=d:i-n<=f)&&(o.push(h),o.push(p-1),o.push(m)),(0===c?r+n>=d:i+n>=f)&&(o.push(p+1),o.push(u),o.push(m))}return s}(this.ids,this.coords,e,t,r,this.nodeSize)}}const V={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:e=>e},$=Math.fround||(N=new Float32Array(1),e=>(N[0]=+e,N[0]));var N;class j{constructor(e){this.options=Y(Object.create(V),e),this.trees=new Array(this.options.maxZoom+1)}load(e){const{log:t,minZoom:r,maxZoom:i,nodeSize:n}=this.options;t&&console.time("total time");const a=`prepare ${e.length} points`;t&&console.time(a),this.points=e;let o=[];for(let t=0;t<e.length;t++)e[t].geometry&&o.push(G(e[t],t));this.trees[i+1]=new U(o,J,Q,n,Float32Array),t&&console.timeEnd(a);for(let e=i;e>=r;e--){const r=+Date.now();o=this._cluster(o,e),this.trees[e]=new U(o,J,Q,n,Float32Array),t&&console.log("z%d: %d clusters in %dms",e,o.length,+Date.now()-r)}return t&&console.timeEnd("total time"),this}getClusters(e,t){let r=((e[0]+180)%360+360)%360-180;const i=Math.max(-90,Math.min(90,e[1]));let n=180===e[2]?180:((e[2]+180)%360+360)%360-180;const a=Math.max(-90,Math.min(90,e[3]));if(e[2]-e[0]>=360)r=-180,n=180;else if(r>n){const e=this.getClusters([r,i,180,a],t),o=this.getClusters([-180,i,n,a],t);return e.concat(o)}const o=this.trees[this._limitZoom(t)],s=o.range(W(r),H(a),W(n),H(i)),l=[];for(const e of s){const t=o.points[e];l.push(t.numPoints?Z(t):this.points[t.index])}return l}getChildren(e){const t=this._getOriginId(e),r=this._getOriginZoom(e),i="No cluster with the specified id.",n=this.trees[r];if(!n)throw new Error(i);const a=n.points[t];if(!a)throw new Error(i);const o=this.options.radius/(this.options.extent*Math.pow(2,r-1)),s=n.within(a.x,a.y,o),l=[];for(const t of s){const r=n.points[t];r.parentId===e&&l.push(r.numPoints?Z(r):this.points[r.index])}if(0===l.length)throw new Error(i);return l}getLeaves(e,t,r){const i=[];return this._appendLeaves(i,e,t=t||10,r=r||0,0),i}getTile(e,t,r){const i=this.trees[this._limitZoom(e)],n=Math.pow(2,e),{extent:a,radius:o}=this.options,s=o/a,l=(r-s)/n,c=(r+1+s)/n,u={features:[]};return this._addTileFeatures(i.range((t-s)/n,l,(t+1+s)/n,c),i.points,t,r,n,u),0===t&&this._addTileFeatures(i.range(1-s/n,l,1,c),i.points,n,r,n,u),t===n-1&&this._addTileFeatures(i.range(0,l,s/n,c),i.points,-1,r,n,u),u.features.length?u:null}getClusterExpansionZoom(e){let t=this._getOriginZoom(e)-1;for(;t<=this.options.maxZoom;){const r=this.getChildren(e);if(t++,1!==r.length)break;e=r[0].properties.cluster_id}return t}_appendLeaves(e,t,r,i,n){const a=this.getChildren(t);for(const t of a){const a=t.properties;if(a&&a.cluster?n+a.point_count<=i?n+=a.point_count:n=this._appendLeaves(e,a.cluster_id,r,i,n):n<i?n++:e.push(t),e.length===r)break}return n}_addTileFeatures(e,t,r,i,n,a){for(const o of e){const e=t[o],s=e.numPoints;let l,c,u;if(s)l=X(e),c=e.x,u=e.y;else{const t=this.points[e.index];l=t.properties,c=W(t.geometry.coordinates[0]),u=H(t.geometry.coordinates[1])}const h={type:1,geometry:[[Math.round(this.options.extent*(c*n-r)),Math.round(this.options.extent*(u*n-i))]],tags:l};let p;s?p=e.id:this.options.generateId?p=e.index:this.points[e.index].id&&(p=this.points[e.index].id),void 0!==p&&(h.id=p),a.features.push(h)}}_limitZoom(e){return Math.max(this.options.minZoom,Math.min(Math.floor(+e),this.options.maxZoom+1))}_cluster(e,t){const r=[],{radius:i,extent:n,reduce:a,minPoints:o}=this.options,s=i/(n*Math.pow(2,t));for(let i=0;i<e.length;i++){const n=e[i];if(n.zoom<=t)continue;n.zoom=t;const l=this.trees[t+1],c=l.within(n.x,n.y,s),u=n.numPoints||1;let h=u;for(const e of c){const r=l.points[e];r.zoom>t&&(h+=r.numPoints||1)}if(h>u&&h>=o){let e=n.x*u,o=n.y*u,s=a&&u>1?this._map(n,!0):null;const p=(i<<5)+(t+1)+this.points.length;for(const r of c){const i=l.points[r];if(i.zoom<=t)continue;i.zoom=t;const c=i.numPoints||1;e+=i.x*c,o+=i.y*c,i.parentId=p,a&&(s||(s=this._map(n,!0)),a(s,this._map(i)))}n.parentId=p,r.push(q(e/h,o/h,p,h,s))}else if(r.push(n),h>1)for(const e of c){const i=l.points[e];i.zoom<=t||(i.zoom=t,r.push(i))}}return r}_getOriginId(e){return e-this.points.length>>5}_getOriginZoom(e){return(e-this.points.length)%32}_map(e,t){if(e.numPoints)return t?Y({},e.properties):e.properties;const r=this.points[e.index].properties,i=this.options.map(r);return t&&i===r?Y({},i):i}}function q(e,t,r,i,n){return{x:$(e),y:$(t),zoom:1/0,id:r,parentId:-1,numPoints:i,properties:n}}function G(e,t){const[r,i]=e.geometry.coordinates;return{x:$(W(r)),y:$(H(i)),zoom:1/0,index:t,parentId:-1}}function Z(e){return{type:"Feature",id:e.id,properties:X(e),geometry:{type:"Point",coordinates:[(t=e.x,360*(t-.5)),K(e.y)]}};var t}function X(e){const t=e.numPoints,r=t>=1e4?`${Math.round(t/1e3)}k`:t>=1e3?Math.round(t/100)/10+"k":t;return Y(Y({},e.properties),{cluster:!0,cluster_id:e.id,point_count:t,point_count_abbreviated:r})}function W(e){return e/360+.5}function H(e){const t=Math.sin(e*Math.PI/180),r=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return r<0?0:r>1?1:r}function K(e){const t=(180-360*e)*Math.PI/180;return 360*Math.atan(Math.exp(t))/Math.PI-90}function Y(e,t){for(const r in t)e[r]=t[r];return e}function J(e){return e.x}function Q(e){return e.y}function ee(e,t,r,i){for(var n,a=i,o=r-t>>1,s=r-t,l=e[t],c=e[t+1],u=e[r],h=e[r+1],p=t+3;p<r;p+=3){var d=te(e[p],e[p+1],l,c,u,h);if(d>a)n=p,a=d;else if(d===a){var f=Math.abs(p-o);f<s&&(n=p,s=f)}}a>i&&(n-t>3&&ee(e,t,n,i),e[n+2]=a,r-n>3&&ee(e,n,r,i))}function te(e,t,r,i,n,a){var o=n-r,s=a-i;if(0!==o||0!==s){var l=((e-r)*o+(t-i)*s)/(o*o+s*s);l>1?(r=n,i=a):l>0&&(r+=o*l,i+=s*l)}return(o=e-r)*o+(s=t-i)*s}function re(e,t,r,i){var n={id:void 0===e?null:e,type:t,geometry:r,tags:i,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(e){var t=e.geometry,r=e.type;if("Point"===r||"MultiPoint"===r||"LineString"===r)ie(e,t);else if("Polygon"===r||"MultiLineString"===r)for(var i=0;i<t.length;i++)ie(e,t[i]);else if("MultiPolygon"===r)for(i=0;i<t.length;i++)for(var n=0;n<t[i].length;n++)ie(e,t[i][n])}(n),n}function ie(e,t){for(var r=0;r<t.length;r+=3)e.minX=Math.min(e.minX,t[r]),e.minY=Math.min(e.minY,t[r+1]),e.maxX=Math.max(e.maxX,t[r]),e.maxY=Math.max(e.maxY,t[r+1])}function ne(e,t,r,i){if(t.geometry){var n=t.geometry.coordinates,a=t.geometry.type,o=Math.pow(r.tolerance/((1<<r.maxZoom)*r.extent),2),s=[],l=t.id;if(r.promoteId?l=t.properties[r.promoteId]:r.generateId&&(l=i||0),"Point"===a)ae(n,s);else if("MultiPoint"===a)for(var c=0;c<n.length;c++)ae(n[c],s);else if("LineString"===a)oe(n,s,o,!1);else if("MultiLineString"===a){if(r.lineMetrics){for(c=0;c<n.length;c++)oe(n[c],s=[],o,!1),e.push(re(l,"LineString",s,t.properties));return}se(n,s,o,!1)}else if("Polygon"===a)se(n,s,o,!0);else{if("MultiPolygon"!==a){if("GeometryCollection"===a){for(c=0;c<t.geometry.geometries.length;c++)ne(e,{id:l,geometry:t.geometry.geometries[c],properties:t.properties},r,i);return}throw new Error("Input data is not a valid GeoJSON object.")}for(c=0;c<n.length;c++){var u=[];se(n[c],u,o,!0),s.push(u)}}e.push(re(l,a,s,t.properties))}}function ae(e,t){t.push(le(e[0])),t.push(ce(e[1])),t.push(0)}function oe(e,t,r,i){for(var n,a,o=0,s=0;s<e.length;s++){var l=le(e[s][0]),c=ce(e[s][1]);t.push(l),t.push(c),t.push(0),s>0&&(o+=i?(n*c-l*a)/2:Math.sqrt(Math.pow(l-n,2)+Math.pow(c-a,2))),n=l,a=c}var u=t.length-3;t[2]=1,ee(t,0,u,r),t[u+2]=1,t.size=Math.abs(o),t.start=0,t.end=t.size}function se(e,t,r,i){for(var n=0;n<e.length;n++){var a=[];oe(e[n],a,r,i),t.push(a)}}function le(e){return e/360+.5}function ce(e){var t=Math.sin(e*Math.PI/180),r=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return r<0?0:r>1?1:r}function ue(e,t,r,i,n,a,o,s){if(i/=t,a>=(r/=t)&&o<i)return e;if(o<r||a>=i)return null;for(var l=[],c=0;c<e.length;c++){var u=e[c],h=u.geometry,p=u.type,d=0===n?u.minX:u.minY,f=0===n?u.maxX:u.maxY;if(d>=r&&f<i)l.push(u);else if(!(f<r||d>=i)){var m=[];if("Point"===p||"MultiPoint"===p)he(h,m,r,i,n);else if("LineString"===p)pe(h,m,r,i,n,!1,s.lineMetrics);else if("MultiLineString"===p)fe(h,m,r,i,n,!1);else if("Polygon"===p)fe(h,m,r,i,n,!0);else if("MultiPolygon"===p)for(var g=0;g<h.length;g++){var y=[];fe(h[g],y,r,i,n,!0),y.length&&m.push(y)}if(m.length){if(s.lineMetrics&&"LineString"===p){for(g=0;g<m.length;g++)l.push(re(u.id,p,m[g],u.tags));continue}"LineString"!==p&&"MultiLineString"!==p||(1===m.length?(p="LineString",m=m[0]):p="MultiLineString"),"Point"!==p&&"MultiPoint"!==p||(p=3===m.length?"Point":"MultiPoint"),l.push(re(u.id,p,m,u.tags))}}}return l.length?l:null}function he(e,t,r,i,n){for(var a=0;a<e.length;a+=3){var o=e[a+n];o>=r&&o<=i&&(t.push(e[a]),t.push(e[a+1]),t.push(e[a+2]))}}function pe(e,t,r,i,n,a,o){for(var s,l,c=de(e),u=0===n?ge:ye,h=e.start,p=0;p<e.length-3;p+=3){var d=e[p],f=e[p+1],m=e[p+2],g=e[p+3],y=e[p+4],_=0===n?d:f,x=0===n?g:y,v=!1;o&&(s=Math.sqrt(Math.pow(d-g,2)+Math.pow(f-y,2))),_<r?x>r&&(l=u(c,d,f,g,y,r),o&&(c.start=h+s*l)):_>i?x<i&&(l=u(c,d,f,g,y,i),o&&(c.start=h+s*l)):me(c,d,f,m),x<r&&_>=r&&(l=u(c,d,f,g,y,r),v=!0),x>i&&_<=i&&(l=u(c,d,f,g,y,i),v=!0),!a&&v&&(o&&(c.end=h+s*l),t.push(c),c=de(e)),o&&(h+=s)}var b=e.length-3;d=e[b],f=e[b+1],m=e[b+2],(_=0===n?d:f)>=r&&_<=i&&me(c,d,f,m),b=c.length-3,a&&b>=3&&(c[b]!==c[0]||c[b+1]!==c[1])&&me(c,c[0],c[1],c[2]),c.length&&t.push(c)}function de(e){var t=[];return t.size=e.size,t.start=e.start,t.end=e.end,t}function fe(e,t,r,i,n,a){for(var o=0;o<e.length;o++)pe(e[o],t,r,i,n,a,!1)}function me(e,t,r,i){e.push(t),e.push(r),e.push(i)}function ge(e,t,r,i,n,a){var o=(a-t)/(i-t);return e.push(a),e.push(r+(n-r)*o),e.push(1),o}function ye(e,t,r,i,n,a){var o=(a-r)/(n-r);return e.push(t+(i-t)*o),e.push(a),e.push(1),o}function _e(e,t){for(var r=[],i=0;i<e.length;i++){var n,a=e[i],o=a.type;if("Point"===o||"MultiPoint"===o||"LineString"===o)n=xe(a.geometry,t);else if("MultiLineString"===o||"Polygon"===o){n=[];for(var s=0;s<a.geometry.length;s++)n.push(xe(a.geometry[s],t))}else if("MultiPolygon"===o)for(n=[],s=0;s<a.geometry.length;s++){for(var l=[],c=0;c<a.geometry[s].length;c++)l.push(xe(a.geometry[s][c],t));n.push(l)}r.push(re(a.id,o,n,a.tags))}return r}function xe(e,t){var r=[];r.size=e.size,void 0!==e.start&&(r.start=e.start,r.end=e.end);for(var i=0;i<e.length;i+=3)r.push(e[i]+t,e[i+1],e[i+2]);return r}function ve(e,t){if(e.transformed)return e;var r,i,n,a=1<<e.z,o=e.x,s=e.y;for(r=0;r<e.features.length;r++){var l=e.features[r],c=l.geometry,u=l.type;if(l.geometry=[],1===u)for(i=0;i<c.length;i+=2)l.geometry.push(be(c[i],c[i+1],t,a,o,s));else for(i=0;i<c.length;i++){var h=[];for(n=0;n<c[i].length;n+=2)h.push(be(c[i][n],c[i][n+1],t,a,o,s));l.geometry.push(h)}}return e.transformed=!0,e}function be(e,t,r,i,n,a){return[Math.round(r*(e*i-n)),Math.round(r*(t*i-a))]}function we(e,t,r,i,n){for(var a=t===n.maxZoom?0:n.tolerance/((1<<t)*n.extent),o={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:r,y:i,z:t,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},s=0;s<e.length;s++){o.numFeatures++,Te(o,e[s],a,n);var l=e[s].minX,c=e[s].minY,u=e[s].maxX,h=e[s].maxY;l<o.minX&&(o.minX=l),c<o.minY&&(o.minY=c),u>o.maxX&&(o.maxX=u),h>o.maxY&&(o.maxY=h)}return o}function Te(e,t,r,i){var n=t.geometry,a=t.type,o=[];if("Point"===a||"MultiPoint"===a)for(var s=0;s<n.length;s+=3)o.push(n[s]),o.push(n[s+1]),e.numPoints++,e.numSimplified++;else if("LineString"===a)Ee(o,n,e,r,!1,!1);else if("MultiLineString"===a||"Polygon"===a)for(s=0;s<n.length;s++)Ee(o,n[s],e,r,"Polygon"===a,0===s);else if("MultiPolygon"===a)for(var l=0;l<n.length;l++){var c=n[l];for(s=0;s<c.length;s++)Ee(o,c[s],e,r,!0,0===s)}if(o.length){var u=t.tags||null;if("LineString"===a&&i.lineMetrics){for(var h in u={},t.tags)u[h]=t.tags[h];u.mapbox_clip_start=n.start/n.size,u.mapbox_clip_end=n.end/n.size}var p={geometry:o,type:"Polygon"===a||"MultiPolygon"===a?3:"LineString"===a||"MultiLineString"===a?2:1,tags:u};null!==t.id&&(p.id=t.id),e.features.push(p)}}function Ee(e,t,r,i,n,a){var o=i*i;if(i>0&&t.size<(n?o:i))r.numPoints+=t.length/3;else{for(var s=[],l=0;l<t.length;l+=3)(0===i||t[l+2]>o)&&(r.numSimplified++,s.push(t[l]),s.push(t[l+1])),r.numPoints++;n&&function(e,t){for(var r=0,i=0,n=e.length,a=n-2;i<n;a=i,i+=2)r+=(e[i]-e[a])*(e[i+1]+e[a+1]);if(r>0===t)for(i=0,n=e.length;i<n/2;i+=2){var o=e[i],s=e[i+1];e[i]=e[n-2-i],e[i+1]=e[n-1-i],e[n-2-i]=o,e[n-1-i]=s}}(s,a),e.push(s)}}function Se(e,t){var r=(t=this.options=function(e,t){for(var r in t)e[r]=t[r];return e}(Object.create(this.options),t)).debug;if(r&&console.time("preprocess data"),t.maxZoom<0||t.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(t.promoteId&&t.generateId)throw new Error("promoteId and generateId cannot be used together.");var i=function(e,t){var r=[];if("FeatureCollection"===e.type)for(var i=0;i<e.features.length;i++)ne(r,e.features[i],t,i);else ne(r,"Feature"===e.type?e:{geometry:e},t);return r}(e,t);this.tiles={},this.tileCoords=[],r&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",t.indexMaxZoom,t.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),i=function(e,t){var r=t.buffer/t.extent,i=e,n=ue(e,1,-1-r,r,0,-1,2,t),a=ue(e,1,1-r,2+r,0,-1,2,t);return(n||a)&&(i=ue(e,1,-r,1+r,0,-1,2,t)||[],n&&(i=_e(n,1).concat(i)),a&&(i=i.concat(_e(a,-1)))),i}(i,t),i.length&&this.splitTile(i,0,0,0),r&&(i.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function Ae(e,t,r){return 32*((1<<e)*r+t)+e}function Ie(e,t){const r=e.tileID.canonical;if(!this._geoJSONIndex)return t(null,null);const i=this._geoJSONIndex.getTile(r.z,r.x,r.y);if(!i)return t(null,null);const n=new m(i.features);let a=g.exports(n);0===a.byteOffset&&a.byteLength===a.buffer.byteLength||(a=new Uint8Array(a)),t(null,{vectorTile:n,rawData:a.buffer})}Se.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},Se.prototype.splitTile=function(e,t,r,i,n,a,o){for(var s=[e,t,r,i],l=this.options,c=l.debug;s.length;){i=s.pop(),r=s.pop(),t=s.pop(),e=s.pop();var u=1<<t,h=Ae(t,r,i),p=this.tiles[h];if(!p&&(c>1&&console.time("creation"),p=this.tiles[h]=we(e,t,r,i,l),this.tileCoords.push({z:t,x:r,y:i}),c)){c>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",t,r,i,p.numFeatures,p.numPoints,p.numSimplified),console.timeEnd("creation"));var d="z"+t;this.stats[d]=(this.stats[d]||0)+1,this.total++}if(p.source=e,n){if(t===l.maxZoom||t===n)continue;var f=1<<n-t;if(r!==Math.floor(a/f)||i!==Math.floor(o/f))continue}else if(t===l.indexMaxZoom||p.numPoints<=l.indexMaxPoints)continue;if(p.source=null,0!==e.length){c>1&&console.time("clipping");var m,g,y,_,x,v,b=.5*l.buffer/l.extent,w=.5-b,T=.5+b,E=1+b;m=g=y=_=null,x=ue(e,u,r-b,r+T,0,p.minX,p.maxX,l),v=ue(e,u,r+w,r+E,0,p.minX,p.maxX,l),e=null,x&&(m=ue(x,u,i-b,i+T,1,p.minY,p.maxY,l),g=ue(x,u,i+w,i+E,1,p.minY,p.maxY,l),x=null),v&&(y=ue(v,u,i-b,i+T,1,p.minY,p.maxY,l),_=ue(v,u,i+w,i+E,1,p.minY,p.maxY,l),v=null),c>1&&console.timeEnd("clipping"),s.push(m||[],t+1,2*r,2*i),s.push(g||[],t+1,2*r,2*i+1),s.push(y||[],t+1,2*r+1,2*i),s.push(_||[],t+1,2*r+1,2*i+1)}}},Se.prototype.getTile=function(e,t,r){var i=this.options,n=i.extent,a=i.debug;if(e<0||e>24)return null;var o=1<<e,s=Ae(e,t=(t%o+o)%o,r);if(this.tiles[s])return ve(this.tiles[s],n);a>1&&console.log("drilling down to z%d-%d-%d",e,t,r);for(var l,c=e,u=t,h=r;!l&&c>0;)c--,u=Math.floor(u/2),h=Math.floor(h/2),l=this.tiles[Ae(c,u,h)];return l&&l.source?(a>1&&console.log("found parent tile z%d-%d-%d",c,u,h),a>1&&console.time("drilling down"),this.splitTile(l.source,c,u,h,e,t,r),a>1&&console.timeEnd("drilling down"),this.tiles[s]?ve(this.tiles[s],n):null):null};class ke extends l{constructor(e,t,r,i){super(e,t,r,Ie),i&&(this.loadGeoJSON=i)}loadData(t,r){var i;null===(i=this._pendingRequest)||void 0===i||i.cancel(),this._pendingCallback&&this._pendingCallback(null,{abandoned:!0});const n=!!(t&&t.request&&t.request.collectResourceTiming)&&new e.RequestPerformance(t.request);this._pendingCallback=r,this._pendingRequest=this.loadGeoJSON(t,((i,a)=>{if(delete this._pendingCallback,delete this._pendingRequest,i||!a)return r(i);if("object"!=typeof a)return r(new Error(`Input data given to '${t.source}' is not a valid GeoJSON object.`));{u(a,!0);try{if(t.filter){const r=e.createExpression(t.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===r.result)throw new Error(r.value.map((e=>`${e.key}: ${e.message}`)).join(", "));const i=a.features.filter((e=>r.value.evaluate({zoom:0},e)));a={type:"FeatureCollection",features:i}}this._geoJSONIndex=t.cluster?new j(function({superclusterOptions:t,clusterProperties:r}){if(!r||!t)return t;const i={},n={},a={accumulated:null,zoom:0},o={properties:null},s=Object.keys(r);for(const t of s){const[a,o]=r[t],s=e.createExpression(o),l=e.createExpression("string"==typeof a?[a,["accumulated"],["get",t]]:a);i[t]=s.value,n[t]=l.value}return t.map=e=>{o.properties=e;const t={};for(const e of s)t[e]=i[e].evaluate(a,o);return t},t.reduce=(e,t)=>{o.properties=t;for(const t of s)a.accumulated=e[t],e[t]=n[t].evaluate(a,o)},t}(t)).load(a.features):function(e,t){return new Se(e,t)}(a,t.geojsonVtOptions)}catch(i){return r(i)}this.loaded={};const o={};if(n){const e=n.finish();e&&(o.resourceTiming={},o.resourceTiming[t.source]=JSON.parse(JSON.stringify(e)))}r(null,o)}}))}reloadTile(e,t){const r=this.loaded;return r&&r[e.uid]?super.reloadTile(e,t):this.loadTile(e,t)}loadGeoJSON(t,r){if(t.request)return e.getJSON(t.request,r);if("string"==typeof t.data)try{r(null,JSON.parse(t.data))}catch(e){r(new Error(`Input data given to '${t.source}' is not a valid GeoJSON object.`))}else r(new Error(`Input data given to '${t.source}' is not a valid GeoJSON object.`));return{cancel:()=>{}}}removeSource(e,t){this._pendingCallback&&this._pendingCallback(null,{abandoned:!0}),t()}getClusterExpansionZoom(e,t){try{t(null,this._geoJSONIndex.getClusterExpansionZoom(e.clusterId))}catch(e){t(e)}}getClusterChildren(e,t){try{t(null,this._geoJSONIndex.getChildren(e.clusterId))}catch(e){t(e)}}getClusterLeaves(e,t){try{t(null,this._geoJSONIndex.getLeaves(e.clusterId,e.limit,e.offset))}catch(e){t(e)}}}class Ce{constructor(t){this.self=t,this.actor=new e.Actor(t,this),this.layerIndexes={},this.availableImages={},this.workerSourceTypes={vector:l,geojson:ke},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(e,t)=>{if(this.workerSourceTypes[e])throw new Error(`Worker source with name "${e}" already registered.`);this.workerSourceTypes[e]=t},this.self.registerRTLTextPlugin=t=>{if(e.plugin.isParsed())throw new Error("RTL text plugin already registered.");e.plugin.applyArabicShaping=t.applyArabicShaping,e.plugin.processBidirectionalText=t.processBidirectionalText,e.plugin.processStyledBidirectionalText=t.processStyledBidirectionalText}}setReferrer(e,t){this.referrer=t}setImages(e,t,r){this.availableImages[e]=t;for(const r in this.workerSources[e]){const i=this.workerSources[e][r];for(const e in i)i[e].availableImages=t}r()}setLayers(e,t,r){this.getLayerIndex(e).replace(t),r()}updateLayers(e,t,r){this.getLayerIndex(e).update(t.layers,t.removedIds),r()}loadTile(e,t,r){this.getWorkerSource(e,t.type,t.source).loadTile(t,r)}loadDEMTile(e,t,r){this.getDEMWorkerSource(e,t.source).loadTile(t,r)}reloadTile(e,t,r){this.getWorkerSource(e,t.type,t.source).reloadTile(t,r)}abortTile(e,t,r){this.getWorkerSource(e,t.type,t.source).abortTile(t,r)}removeTile(e,t,r){this.getWorkerSource(e,t.type,t.source).removeTile(t,r)}removeDEMTile(e,t){this.getDEMWorkerSource(e,t.source).removeTile(t)}removeSource(e,t,r){if(!this.workerSources[e]||!this.workerSources[e][t.type]||!this.workerSources[e][t.type][t.source])return;const i=this.workerSources[e][t.type][t.source];delete this.workerSources[e][t.type][t.source],void 0!==i.removeSource?i.removeSource(t,r):r()}loadWorkerSource(e,t,r){try{this.self.importScripts(t.url),r()}catch(e){r(e.toString())}}syncRTLPluginState(t,r,i){try{e.plugin.setState(r);const t=e.plugin.getPluginURL();if(e.plugin.isLoaded()&&!e.plugin.isParsed()&&null!=t){this.self.importScripts(t);const r=e.plugin.isParsed();i(r?void 0:new Error(`RTL Text Plugin failed to import scripts from ${t}`),r)}}catch(e){i(e.toString())}}getAvailableImages(e){let t=this.availableImages[e];return t||(t=[]),t}getLayerIndex(e){let t=this.layerIndexes[e];return t||(t=this.layerIndexes[e]=new i),t}getWorkerSource(e,t,r){if(this.workerSources[e]||(this.workerSources[e]={}),this.workerSources[e][t]||(this.workerSources[e][t]={}),!this.workerSources[e][t][r]){const i={send:(t,r,i)=>{this.actor.send(t,r,i,e)}};this.workerSources[e][t][r]=new this.workerSourceTypes[t](i,this.getLayerIndex(e),this.getAvailableImages(e))}return this.workerSources[e][t][r]}getDEMWorkerSource(e,t){return this.demWorkerSources[e]||(this.demWorkerSources[e]={}),this.demWorkerSources[e][t]||(this.demWorkerSources[e][t]=new c),this.demWorkerSources[e][t]}enforceCacheSizeLimit(t,r){e.enforceCacheSizeLimit(r)}}return e.isWorker()&&(self.worker=new Ce(self)),Ce})),i(["./shared"],(function(e){var t=r;function r(e){return!function(e){return"undefined"==typeof window||"undefined"==typeof document?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var e,t,r=new Blob([""],{type:"text/javascript"}),i=URL.createObjectURL(r);try{t=new Worker(i),e=!0}catch(t){e=!1}return t&&t.terminate(),URL.revokeObjectURL(i),e}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var e=document.createElement("canvas");e.width=e.height=1;var t=e.getContext("2d");if(!t)return!1;var r=t.getImageData(0,0,1,1);return r&&r.width===e.width}()?(void 0===i[t=e&&e.failIfMajorPerformanceCaveat]&&(i[t]=function(e){var t,i=function(e){var t=document.createElement("canvas"),i=Object.create(r.webGLContextAttributes);return i.failIfMajorPerformanceCaveat=e,t.getContext("webgl",i)||t.getContext("experimental-webgl",i)}(e);if(!i)return!1;try{t=i.createShader(i.VERTEX_SHADER)}catch(e){return!1}return!(!t||i.isContextLost())&&(i.shaderSource(t,"void main() {}"),i.compileShader(t),!0===i.getShaderParameter(t,i.COMPILE_STATUS))}(t)),i[t]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var t}(e)}var i={};function n(e,t){if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!n(e[r],t[r]))return!1;return!0}if("object"==typeof e&&null!==e&&null!==t){if("object"!=typeof t)return!1;if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const r in e)if(!n(e[r],t[r]))return!1;return!0}return e===t}r.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};class a{static testProp(e){if(!a.docStyle)return e[0];for(let t=0;t<e.length;t++)if(e[t]in a.docStyle)return e[t];return e[0]}static create(e,t,r){const i=window.document.createElement(e);return void 0!==t&&(i.className=t),r&&r.appendChild(i),i}static createNS(e,t){return window.document.createElementNS(e,t)}static disableDrag(){a.docStyle&&a.selectProp&&(a.userSelect=a.docStyle[a.selectProp],a.docStyle[a.selectProp]="none")}static enableDrag(){a.docStyle&&a.selectProp&&(a.docStyle[a.selectProp]=a.userSelect)}static setTransform(e,t){e.style[a.transformProp]=t}static addEventListener(e,t,r,i={}){e.addEventListener(t,r,"passive"in i?i:i.capture)}static removeEventListener(e,t,r,i={}){e.removeEventListener(t,r,"passive"in i?i:i.capture)}static suppressClickInternal(e){e.preventDefault(),e.stopPropagation(),window.removeEventListener("click",a.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",a.suppressClickInternal,!0),window.setTimeout((()=>{window.removeEventListener("click",a.suppressClickInternal,!0)}),0)}static mousePos(t,r){const i=t.getBoundingClientRect();return new e.pointGeometry(r.clientX-i.left-t.clientLeft,r.clientY-i.top-t.clientTop)}static touchPos(t,r){const i=t.getBoundingClientRect(),n=[];for(let a=0;a<r.length;a++)n.push(new e.pointGeometry(r[a].clientX-i.left-t.clientLeft,r[a].clientY-i.top-t.clientTop));return n}static mouseButton(e){return e.button}static remove(e){e.parentNode&&e.parentNode.removeChild(e)}}a.docStyle="undefined"!=typeof window&&window.document&&window.document.documentElement.style,a.selectProp=a.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),a.transformProp=a.testProp(["transform","WebkitTransform"]);class o{constructor(e){this._transformRequestFn=e}transformRequest(e,t){return this._transformRequestFn&&this._transformRequestFn(e,t)||{url:e}}normalizeSpriteURL(e,t,r){const i=function(e){const t=e.match(s);if(!t)throw new Error(`Unable to parse URL "${e}"`);return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}(e);return i.path+=`${t}${r}`,function(e){const t=e.params.length?`?${e.params.join("&")}`:"";return`${e.protocol}://${e.authority}${e.path}${t}`}(i)}setTransformRequest(e){this._transformRequestFn=e}}const s=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;class l{constructor(e,t,r,i){this.context=e,this.format=r,this.texture=e.gl.createTexture(),this.update(t,i)}update(t,r,i){const{width:n,height:a}=t,o=!(this.size&&this.size[0]===n&&this.size[1]===a||i),{context:s}=this,{gl:l}=s;if(this.useMipmap=Boolean(r&&r.useMipmap),l.bindTexture(l.TEXTURE_2D,this.texture),s.pixelStoreUnpackFlipY.set(!1),s.pixelStoreUnpack.set(1),s.pixelStoreUnpackPremultiplyAlpha.set(this.format===l.RGBA&&(!r||!1!==r.premultiply)),o)this.size=[n,a],t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||t instanceof ImageData||e.isImageBitmap(t)?l.texImage2D(l.TEXTURE_2D,0,this.format,this.format,l.UNSIGNED_BYTE,t):l.texImage2D(l.TEXTURE_2D,0,this.format,n,a,0,this.format,l.UNSIGNED_BYTE,t.data);else{const{x:r,y:o}=i||{x:0,y:0};t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||t instanceof ImageData||e.isImageBitmap(t)?l.texSubImage2D(l.TEXTURE_2D,0,r,o,l.RGBA,l.UNSIGNED_BYTE,t):l.texSubImage2D(l.TEXTURE_2D,0,r,o,n,a,l.RGBA,l.UNSIGNED_BYTE,t.data)}this.useMipmap&&this.isSizePowerOfTwo()&&l.generateMipmap(l.TEXTURE_2D)}bind(e,t,r){const{context:i}=this,{gl:n}=i;n.bindTexture(n.TEXTURE_2D,this.texture),r!==n.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(r=n.LINEAR),e!==this.filter&&(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,r||e),this.filter=e),t!==this.wrap&&(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,t),this.wrap=t)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}function c(e){const{userImage:t}=e;return!!(t&&t.render&&t.render())&&(e.data.replace(new Uint8Array(t.data.buffer)),!0)}class u extends e.Evented{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new e.RGBAImage({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(e){if(this.loaded!==e&&(this.loaded=e,e)){for(const{ids:e,callback:t}of this.requestors)this._notify(e,t);this.requestors=[]}}getImage(e){return this.images[e]}addImage(e,t){if(this.images[e])throw new Error(`Image id ${e} already exist, use updateImage instead`);this._validate(e,t)&&(this.images[e]=t)}_validate(t,r){let i=!0;return this._validateStretch(r.stretchX,r.data&&r.data.width)||(this.fire(new e.ErrorEvent(new Error(`Image "${t}" has invalid "stretchX" value`))),i=!1),this._validateStretch(r.stretchY,r.data&&r.data.height)||(this.fire(new e.ErrorEvent(new Error(`Image "${t}" has invalid "stretchY" value`))),i=!1),this._validateContent(r.content,r)||(this.fire(new e.ErrorEvent(new Error(`Image "${t}" has invalid "content" value`))),i=!1),i}_validateStretch(e,t){if(!e)return!0;let r=0;for(const i of e){if(i[0]<r||i[1]<i[0]||t<i[1])return!1;r=i[1]}return!0}_validateContent(e,t){return!(e&&(4!==e.length||e[0]<0||t.data.width<e[0]||e[1]<0||t.data.height<e[1]||e[2]<0||t.data.width<e[2]||e[3]<0||t.data.height<e[3]||e[2]<e[0]||e[3]<e[1]))}updateImage(e,t){const r=this.images[e];if(r.data.width!==t.data.width||r.data.height!==t.data.height)throw new Error(`size mismatch between old image (${r.data.width}x${r.data.height}) and new image (${t.data.width}x${t.data.height}).`);t.version=r.version+1,this.images[e]=t,this.updatedImages[e]=!0}removeImage(e){const t=this.images[e];delete this.images[e],delete this.patterns[e],t.userImage&&t.userImage.onRemove&&t.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(e,t){let r=!0;if(!this.isLoaded())for(const t of e)this.images[t]||(r=!1);this.isLoaded()||r?this._notify(e,t):this.requestors.push({ids:e,callback:t})}_notify(t,r){const i={};for(const r of t){this.images[r]||this.fire(new e.Event("styleimagemissing",{id:r}));const t=this.images[r];t?i[r]={data:t.data.clone(),pixelRatio:t.pixelRatio,sdf:t.sdf,version:t.version,stretchX:t.stretchX,stretchY:t.stretchY,content:t.content,hasRenderCallback:Boolean(t.userImage&&t.userImage.render)}:e.warnOnce(`Image "${r}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}r(null,i)}getPixelSize(){const{width:e,height:t}=this.atlasImage;return{width:e,height:t}}getPattern(t){const r=this.patterns[t],i=this.getImage(t);if(!i)return null;if(r&&r.position.version===i.version)return r.position;if(r)r.position.version=i.version;else{const r={w:i.data.width+2,h:i.data.height+2,x:0,y:0},n=new e.ImagePosition(r,i);this.patterns[t]={bin:r,position:n}}return this._updatePatternAtlas(),this.patterns[t].position}bind(e){const t=e.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new l(e,this.atlasImage,t.RGBA),this.atlasTexture.bind(t.LINEAR,t.CLAMP_TO_EDGE)}_updatePatternAtlas(){const t=[];for(const e in this.patterns)t.push(this.patterns[e].bin);const{w:r,h:i}=e.potpack(t),n=this.atlasImage;n.resize({width:r||1,height:i||1});for(const t in this.patterns){const{bin:r}=this.patterns[t],i=r.x+1,a=r.y+1,o=this.images[t].data,s=o.width,l=o.height;e.RGBAImage.copy(o,n,{x:0,y:0},{x:i,y:a},{width:s,height:l}),e.RGBAImage.copy(o,n,{x:0,y:l-1},{x:i,y:a-1},{width:s,height:1}),e.RGBAImage.copy(o,n,{x:0,y:0},{x:i,y:a+l},{width:s,height:1}),e.RGBAImage.copy(o,n,{x:s-1,y:0},{x:i-1,y:a},{width:1,height:l}),e.RGBAImage.copy(o,n,{x:0,y:0},{x:i+s,y:a},{width:1,height:l})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(t){for(const r of t){if(this.callbackDispatchedThisFrame[r])continue;this.callbackDispatchedThisFrame[r]=!0;const t=this.images[r];t||e.warnOnce(`Image with ID: "${r}" was not found`),c(t)&&this.updateImage(r,t)}}}const h=1e20;function p(e,t,r,i,n,a,o,s,l){for(let c=t;c<t+i;c++)d(e,r*a+c,a,n,o,s,l);for(let c=r;c<r+n;c++)d(e,c*a+t,1,i,o,s,l)}function d(e,t,r,i,n,a,o){a[0]=0,o[0]=-h,o[1]=h,n[0]=e[t];for(let s=1,l=0,c=0;s<i;s++){n[s]=e[t+s*r];const i=s*s;do{const e=a[l];c=(n[s]-n[e]+i-e*e)/(s-e)/2}while(c<=o[l]&&--l>-1);l++,a[l]=s,o[l]=c,o[l+1]=h}for(let s=0,l=0;s<i;s++){for(;o[l+1]<s;)l++;const i=a[l],c=s-i;e[t+s*r]=n[i]+c*c}}class f{constructor(e,t){this.requestManager=e,this.localIdeographFontFamily=t,this.entries={}}setURL(e){this.url=e}getGlyphs(t,r){const i=[];for(const e in t)for(const r of t[e])i.push({stack:e,id:r});e.asyncAll(i,(({stack:e,id:t},r)=>{let i=this.entries[e];i||(i=this.entries[e]={glyphs:{},requests:{},ranges:{}});let n=i.glyphs[t];if(void 0!==n)return void r(null,{stack:e,id:t,glyph:n});if(n=this._tinySDF(i,e,t),n)return i.glyphs[t]=n,void r(null,{stack:e,id:t,glyph:n});const a=Math.floor(t/256);if(256*a>65535)return void r(new Error("glyphs > 65535 not supported"));if(i.ranges[a])return void r(null,{stack:e,id:t,glyph:n});let o=i.requests[a];o||(o=i.requests[a]=[],f.loadGlyphRange(e,a,this.url,this.requestManager,((e,t)=>{if(t){for(const e in t)this._doesCharSupportLocalGlyph(+e)||(i.glyphs[+e]=t[+e]);i.ranges[a]=!0}for(const r of o)r(e,t);delete i.requests[a]}))),o.push(((i,n)=>{i?r(i):n&&r(null,{stack:e,id:t,glyph:n[t]||null})}))}),((e,t)=>{if(e)r(e);else if(t){const e={};for(const{stack:r,id:i,glyph:n}of t)(e[r]||(e[r]={}))[i]=n&&{id:n.id,bitmap:n.bitmap.clone(),metrics:n.metrics};r(null,e)}}))}_doesCharSupportLocalGlyph(t){return!!this.localIdeographFontFamily&&(e.unicodeBlockLookup["CJK Unified Ideographs"](t)||e.unicodeBlockLookup["Hangul Syllables"](t)||e.unicodeBlockLookup.Hiragana(t)||e.unicodeBlockLookup.Katakana(t))}_tinySDF(t,r,i){const n=this.localIdeographFontFamily;if(!n)return;if(!this._doesCharSupportLocalGlyph(i))return;let a=t.tinySDF;if(!a){let e="400";/bold/i.test(r)?e="900":/medium/i.test(r)?e="500":/light/i.test(r)&&(e="200"),a=t.tinySDF=new f.TinySDF({fontSize:24,buffer:3,radius:8,cutoff:.25,fontFamily:n,fontWeight:e})}const o=a.draw(String.fromCharCode(i));return{id:i,bitmap:new e.AlphaImage({width:o.width||30,height:o.height||30},o.data),metrics:{width:o.glyphWidth||24,height:o.glyphHeight||24,left:o.glyphLeft||0,top:o.glyphTop-27||-8,advance:o.glyphAdvance||24}}}}f.loadGlyphRange=function(t,r,i,n,a){const o=256*r,s=o+255,l=n.transformRequest(i.replace("{fontstack}",t).replace("{range}",`${o}-${s}`),e.ResourceType.Glyphs);e.getArrayBuffer(l,((t,r)=>{if(t)a(t);else if(r){const t={};for(const i of e.parseGlyphPbf(r))t[i.id]=i;a(null,t)}}))},f.TinySDF=class{constructor({fontSize:e=24,buffer:t=3,radius:r=8,cutoff:i=.25,fontFamily:n="sans-serif",fontWeight:a="normal",fontStyle:o="normal"}={}){this.buffer=t,this.cutoff=i,this.radius=r;const s=this.size=e+4*t,l=this._createCanvas(s),c=this.ctx=l.getContext("2d",{willReadFrequently:!0});c.font=`${o} ${a} ${e}px ${n}`,c.textBaseline="alphabetic",c.textAlign="left",c.fillStyle="black",this.gridOuter=new Float64Array(s*s),this.gridInner=new Float64Array(s*s),this.f=new Float64Array(s),this.z=new Float64Array(s+1),this.v=new Uint16Array(s)}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){const{width:t,actualBoundingBoxAscent:r,actualBoundingBoxDescent:i,actualBoundingBoxLeft:n,actualBoundingBoxRight:a}=this.ctx.measureText(e),o=Math.ceil(r),s=Math.min(this.size-this.buffer,Math.ceil(a-n)),l=Math.min(this.size-this.buffer,o+Math.ceil(i)),c=s+2*this.buffer,u=l+2*this.buffer,d=Math.max(c*u,0),f=new Uint8ClampedArray(d),m={data:f,width:c,height:u,glyphWidth:s,glyphHeight:l,glyphTop:o,glyphLeft:0,glyphAdvance:t};if(0===s||0===l)return m;const{ctx:g,buffer:y,gridInner:_,gridOuter:x}=this;g.clearRect(y,y,s,l),g.fillText(e,y,y+o);const v=g.getImageData(y,y,s,l);x.fill(h,0,d),_.fill(0,0,d);for(let e=0;e<l;e++)for(let t=0;t<s;t++){const r=v.data[4*(e*s+t)+3]/255;if(0===r)continue;const i=(e+y)*c+t+y;if(1===r)x[i]=0,_[i]=h;else{const e=.5-r;x[i]=e>0?e*e:0,_[i]=e<0?e*e:0}}p(x,0,0,c,u,c,this.f,this.v,this.z),p(_,y,y,s,l,c,this.f,this.v,this.z);for(let e=0;e<d;e++){const t=Math.sqrt(x[e])-Math.sqrt(_[e]);f[e]=Math.round(255-255*(t/this.radius+this.cutoff))}return m}};const m=new e.Properties({anchor:new e.DataConstantProperty(e.spec.light.anchor),position:new class{constructor(){this.specification=e.spec.light.position}possiblyEvaluate(t,r){return e.sphericalToCartesian(t.expression.evaluate(r))}interpolate(t,r,i){return{x:e.number(t.x,r.x,i),y:e.number(t.y,r.y,i),z:e.number(t.z,r.z,i)}}},color:new e.DataConstantProperty(e.spec.light.color),intensity:new e.DataConstantProperty(e.spec.light.intensity)}),g="-transition";class y extends e.Evented{constructor(t){super(),this._transitionable=new e.Transitionable(m),this.setLight(t),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,r={}){if(!this._validate(e.validateLight,t,r))for(const e in t){const r=t[e];e.endsWith(g)?this._transitionable.setTransition(e.slice(0,-g.length),r):this._transitionable.setValue(e,r)}}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(t,r,i){return(!i||!1!==i.validate)&&e.emitValidationErrors(this,t.call(e.validateStyle,e.extend({value:r,style:{glyphs:!0,sprite:!0},styleSpec:e.spec})))}}class _{constructor(e,t){this.width=e,this.height=t,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(e,t){const r=e.join(",")+String(t);return this.dashEntry[r]||(this.dashEntry[r]=this.addDash(e,t)),this.dashEntry[r]}getDashRanges(e,t,r){const i=[];let n=e.length%2==1?-e[e.length-1]*r:0,a=e[0]*r,o=!0;i.push({left:n,right:a,isDash:o,zeroLength:0===e[0]});let s=e[0];for(let t=1;t<e.length;t++){o=!o;const l=e[t];n=s*r,s+=l,a=s*r,i.push({left:n,right:a,isDash:o,zeroLength:0===l})}return i}addRoundDash(e,t,r){const i=t/2;for(let t=-r;t<=r;t++){const n=this.width*(this.nextRow+r+t);let a=0,o=e[a];for(let s=0;s<this.width;s++){s/o.right>1&&(o=e[++a]);const l=Math.abs(s-o.left),c=Math.abs(s-o.right),u=Math.min(l,c);let h;const p=t/r*(i+1);if(o.isDash){const e=i-Math.abs(p);h=Math.sqrt(u*u+e*e)}else h=i-Math.sqrt(u*u+p*p);this.data[n+s]=Math.max(0,Math.min(255,h+128))}}}addRegularDash(e){for(let t=e.length-1;t>=0;--t){const r=e[t],i=e[t+1];r.zeroLength?e.splice(t,1):i&&i.isDash===r.isDash&&(i.left=r.left,e.splice(t,1))}const t=e[0],r=e[e.length-1];t.isDash===r.isDash&&(t.left=r.left-this.width,r.right=t.right+this.width);const i=this.width*this.nextRow;let n=0,a=e[n];for(let t=0;t<this.width;t++){t/a.right>1&&(a=e[++n]);const r=Math.abs(t-a.left),o=Math.abs(t-a.right),s=Math.min(r,o);this.data[i+t]=Math.max(0,Math.min(255,(a.isDash?s:-s)+128))}}addDash(t,r){const i=r?7:0,n=2*i+1;if(this.nextRow+n>this.height)return e.warnOnce("LineAtlas out of space"),null;let a=0;for(let e=0;e<t.length;e++)a+=t[e];if(0!==a){const e=this.width/a,n=this.getDashRanges(t,this.width,e);r?this.addRoundDash(n,e,i):this.addRegularDash(n)}const o={y:(this.nextRow+i+.5)/this.height,height:2*i/this.height,width:a};return this.nextRow+=n,this.dirty=!0,o}bind(e){const t=e.gl;this.texture?(t.bindTexture(t.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,t.texSubImage2D(t.TEXTURE_2D,0,0,0,this.width,this.height,t.ALPHA,t.UNSIGNED_BYTE,this.data))):(this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.ALPHA,this.width,this.height,0,t.ALPHA,t.UNSIGNED_BYTE,this.data))}}class x{constructor(t,r){this.workerPool=t,this.actors=[],this.currentActor=0,this.id=e.uniqueId();const i=this.workerPool.acquire(this.id);for(let e=0;e<i.length;e++){const t=new x.Actor(i[e],r,this.id);t.name=`Worker ${e}`,this.actors.push(t)}if(!this.actors.length)throw new Error("No actors found")}broadcast(t,r,i){e.asyncAll(this.actors,((e,i)=>{e.send(t,r,i)}),i=i||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((e=>{e.remove()})),this.actors=[],this.workerPool.release(this.id)}}function v(t,r,i){const n=function(r,n){if(r)return i(r);if(n){const r=e.pick(e.extend(n,t),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);n.vector_layers&&(r.vectorLayers=n.vector_layers,r.vectorLayerIds=r.vectorLayers.map((e=>e.id))),i(null,r)}};return t.url?e.getJSON(r.transformRequest(t.url,e.ResourceType.Source),n):e.exported.frame((()=>n(null,t)))}x.Actor=e.Actor;class b{constructor(t,r,i){this.bounds=e.LngLatBounds.convert(this.validateBounds(t)),this.minzoom=r||0,this.maxzoom=i||24}validateBounds(e){return Array.isArray(e)&&4===e.length?[Math.max(-180,e[0]),Math.max(-90,e[1]),Math.min(180,e[2]),Math.min(90,e[3])]:[-180,-90,180,90]}contains(t){const r=Math.pow(2,t.z),i=Math.floor(e.mercatorXfromLng(this.bounds.getWest())*r),n=Math.floor(e.mercatorYfromLat(this.bounds.getNorth())*r),a=Math.ceil(e.mercatorXfromLng(this.bounds.getEast())*r),o=Math.ceil(e.mercatorYfromLat(this.bounds.getSouth())*r);return t.x>=i&&t.x<a&&t.y>=n&&t.y<o}}class w extends e.Evented{constructor(t,r,i,n){if(super(),this.id=t,this.dispatcher=i,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,e.extend(this,e.pick(r,["url","scheme","tileSize","promoteId"])),this._options=e.extend({type:"vector"},r),this._collectResourceTiming=r.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(n)}load(){this._loaded=!1,this.fire(new e.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=v(this._options,this.map._requestManager,((t,r)=>{this._tileJSONRequest=null,this._loaded=!0,this.map.style.sourceCaches[this.id].clearTiles(),t?this.fire(new e.ErrorEvent(t)):r&&(e.extend(this,r),r.bounds&&(this.tileBounds=new b(r.bounds,this.minzoom,this.maxzoom)),this.fire(new e.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new e.Event("data",{dataType:"source",sourceDataType:"content"})))}))}loaded(){return this._loaded}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}onAdd(e){this.map=e,this.load()}setSourceProperty(e){this._tileJSONRequest&&this._tileJSONRequest.cancel(),e(),this.load()}setTiles(e){return this.setSourceProperty((()=>{this._options.tiles=e})),this}setUrl(e){return this.setSourceProperty((()=>{this.url=e,this._options.url=e})),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return e.extend({},this._options)}loadTile(t,r){const i=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),n={request:this.map._requestManager.transformRequest(i,e.ResourceType.Tile),uid:t.uid,tileID:t.tileID,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};function a(i,n){return delete t.request,t.aborted?r(null):i&&404!==i.status?r(i):(n&&n.resourceTiming&&(t.resourceTiming=n.resourceTiming),this.map._refreshExpiredTiles&&n&&t.setExpiryData(n),t.loadVectorData(n,this.map.painter),e.cacheEntryPossiblyAdded(this.dispatcher),r(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}n.request.collectResourceTiming=this._collectResourceTiming,t.actor&&"expired"!==t.state?"loading"===t.state?t.reloadCallback=r:t.request=t.actor.send("reloadTile",n,a.bind(this)):(t.actor=this.dispatcher.getActor(),t.request=t.actor.send("loadTile",n,a.bind(this)))}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.actor&&e.actor.send("abortTile",{uid:e.uid,type:this.type,source:this.id},void 0)}unloadTile(e){e.unloadVectorData(),e.actor&&e.actor.send("removeTile",{uid:e.uid,type:this.type,source:this.id},void 0)}hasTransition(){return!1}}class T extends e.Evented{constructor(t,r,i,n){super(),this.id=t,this.dispatcher=i,this.setEventedParent(n),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=e.extend({type:"raster"},r),e.extend(this,e.pick(r,["url","scheme","tileSize"]))}load(){this._loaded=!1,this.fire(new e.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=v(this._options,this.map._requestManager,((t,r)=>{this._tileJSONRequest=null,this._loaded=!0,t?this.fire(new e.ErrorEvent(t)):r&&(e.extend(this,r),r.bounds&&(this.tileBounds=new b(r.bounds,this.minzoom,this.maxzoom)),this.fire(new e.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new e.Event("data",{dataType:"source",sourceDataType:"content"})))}))}loaded(){return this._loaded}onAdd(e){this.map=e,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return e.extend({},this._options)}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}loadTile(t,r){const i=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);t.request=e.getImage(this.map._requestManager.transformRequest(i,e.ResourceType.Tile),((i,n,a)=>{if(delete t.request,t.aborted)t.state="unloaded",r(null);else if(i)t.state="errored",r(i);else if(n){this.map._refreshExpiredTiles&&t.setExpiryData(a);const i=this.map.painter.context,o=i.gl;t.texture=this.map.painter.getTileTexture(n.width),t.texture?t.texture.update(n,{useMipmap:!0}):(t.texture=new l(i,n,o.RGBA,{useMipmap:!0}),t.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE,o.LINEAR_MIPMAP_NEAREST),i.extTextureFilterAnisotropic&&o.texParameterf(o.TEXTURE_2D,i.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,i.extTextureFilterAnisotropicMax)),t.state="loaded",e.cacheEntryPossiblyAdded(this.dispatcher),r(null)}}))}abortTile(e,t){e.request&&(e.request.cancel(),delete e.request),t()}unloadTile(e,t){e.texture&&this.map.painter.saveTileTexture(e.texture),t()}hasTransition(){return!1}}let E;class S extends T{constructor(t,r,i,n){super(t,r,i,n),this.type="raster-dem",this.maxzoom=22,this._options=e.extend({type:"raster-dem"},r),this.encoding=r.encoding||"mapbox"}serialize(){return{type:"raster-dem",url:this.url,tileSize:this.tileSize,tiles:this.tiles,bounds:this.bounds,encoding:this.encoding}}loadTile(t,r){const i=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);function n(e,i){e&&(t.state="errored",r(e)),i&&(t.dem=i,t.needsHillshadePrepare=!0,t.needsTerrainPrepare=!0,t.state="loaded",r(null))}t.request=e.getImage(this.map._requestManager.transformRequest(i,e.ResourceType.Tile),function(i,a){if(delete t.request,t.aborted)t.state="unloaded",r(null);else if(i)t.state="errored",r(i);else if(a){this.map._refreshExpiredTiles&&t.setExpiryData(a),delete a.cacheControl,delete a.expires;const r=e.isImageBitmap(a)&&(null==E&&(E="undefined"!=typeof OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof createImageBitmap),E)?a:e.exported.getImageData(a,1),i={uid:t.uid,coord:t.tileID,source:this.id,rawImageData:r,encoding:this.encoding};t.actor&&"expired"!==t.state||(t.actor=this.dispatcher.getActor(),t.actor.send("loadDEMTile",i,n.bind(this)))}}.bind(this)),t.neighboringTiles=this._getNeighboringTiles(t.tileID)}_getNeighboringTiles(t){const r=t.canonical,i=Math.pow(2,r.z),n=(r.x-1+i)%i,a=0===r.x?t.wrap-1:t.wrap,o=(r.x+1+i)%i,s=r.x+1===i?t.wrap+1:t.wrap,l={};return l[new e.OverscaledTileID(t.overscaledZ,a,r.z,n,r.y).key]={backfilled:!1},l[new e.OverscaledTileID(t.overscaledZ,s,r.z,o,r.y).key]={backfilled:!1},r.y>0&&(l[new e.OverscaledTileID(t.overscaledZ,a,r.z,n,r.y-1).key]={backfilled:!1},l[new e.OverscaledTileID(t.overscaledZ,t.wrap,r.z,r.x,r.y-1).key]={backfilled:!1},l[new e.OverscaledTileID(t.overscaledZ,s,r.z,o,r.y-1).key]={backfilled:!1}),r.y+1<i&&(l[new e.OverscaledTileID(t.overscaledZ,a,r.z,n,r.y+1).key]={backfilled:!1},l[new e.OverscaledTileID(t.overscaledZ,t.wrap,r.z,r.x,r.y+1).key]={backfilled:!1},l[new e.OverscaledTileID(t.overscaledZ,s,r.z,o,r.y+1).key]={backfilled:!1}),l}unloadTile(e){e.demTexture&&this.map.painter.saveTileTexture(e.demTexture),e.fbo&&(e.fbo.destroy(),delete e.fbo),e.dem&&delete e.dem,delete e.neighboringTiles,e.state="unloaded",e.actor&&e.actor.send("removeDEMTile",{uid:e.uid,source:this.id})}}class A extends e.Evented{constructor(t,r,i,n){super(),this.id=t,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._pendingLoads=0,this.actor=i.getActor(),this.setEventedParent(n),this._data=r.data,this._options=e.extend({},r),this._collectResourceTiming=r.collectResourceTiming,void 0!==r.maxzoom&&(this.maxzoom=r.maxzoom),r.type&&(this.type=r.type),r.attribution&&(this.attribution=r.attribution),this.promoteId=r.promoteId;const a=e.EXTENT/this.tileSize;this.workerOptions=e.extend({source:this.id,cluster:r.cluster||!1,geojsonVtOptions:{buffer:(void 0!==r.buffer?r.buffer:128)*a,tolerance:(void 0!==r.tolerance?r.tolerance:.375)*a,extent:e.EXTENT,maxZoom:this.maxzoom,lineMetrics:r.lineMetrics||!1,generateId:r.generateId||!1},superclusterOptions:{maxZoom:void 0!==r.clusterMaxZoom?r.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,r.clusterMinPoints||2),extent:e.EXTENT,radius:(r.clusterRadius||50)*a,log:!1,generateId:r.generateId||!1},clusterProperties:r.clusterProperties,filter:r.filter},r.workerOptions)}load(){this._updateWorkerData("metadata")}onAdd(e){this.map=e,this.load()}setData(e){return this._data=e,this._updateWorkerData("content"),this}getClusterExpansionZoom(e,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:e,source:this.id},t),this}getClusterChildren(e,t){return this.actor.send("geojson.getClusterChildren",{clusterId:e,source:this.id},t),this}getClusterLeaves(e,t,r,i){return this.actor.send("geojson.getClusterLeaves",{source:this.id,clusterId:e,limit:t,offset:r},i),this}_updateWorkerData(t){const r=e.extend({},this.workerOptions),i=this._data;"string"==typeof i?(r.request=this.map._requestManager.transformRequest(e.exported.resolveURL(i),e.ResourceType.Source),r.request.collectResourceTiming=this._collectResourceTiming):r.data=JSON.stringify(i),this._pendingLoads++,this.fire(new e.Event("dataloading",{dataType:"source"})),this.actor.send(`${this.type}.loadData`,r,((r,i)=>{if(this._pendingLoads--,this._removed||i&&i.abandoned)return void this.fire(new e.Event("dataabort",{dataType:"source",sourceDataType:t}));let n=null;if(i&&i.resourceTiming&&i.resourceTiming[this.id]&&(n=i.resourceTiming[this.id].slice(0)),r)return void this.fire(new e.ErrorEvent(r));const a={dataType:"source",sourceDataType:t};this._collectResourceTiming&&n&&n.length>0&&e.extend(a,{resourceTiming:n}),this.fire(new e.Event("data",a))}))}loaded(){return 0===this._pendingLoads}loadTile(e,t){const r=e.actor?"reloadTile":"loadTile";e.actor=this.actor;const i={type:this.type,uid:e.uid,tileID:e.tileID,zoom:e.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};e.request=this.actor.send(r,i,((i,n)=>(delete e.request,e.unloadVectorData(),e.aborted?t(null):i?t(i):(e.loadVectorData(n,this.map.painter,"reloadTile"===r),t(null)))))}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.aborted=!0}unloadTile(e){e.unloadVectorData(),this.actor.send("removeTile",{uid:e.uid,type:this.type,source:this.id})}onRemove(){this._removed=!0,this.actor.send("removeSource",{type:this.type,source:this.id})}serialize(){return e.extend({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}}var I=e.createLayout([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class k extends e.Evented{constructor(e,t,r,i){super(),this.id=e,this.dispatcher=r,this.coordinates=t.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(i),this.options=t}load(t,r){this._loaded=!1,this.fire(new e.Event("dataloading",{dataType:"source"})),this.url=this.options.url,e.getImage(this.map._requestManager.transformRequest(this.url,e.ResourceType.Image),((i,n)=>{this._loaded=!0,i?this.fire(new e.ErrorEvent(i)):n&&(this.image=n,t&&(this.coordinates=t),r&&r(),this._finishLoading())}))}loaded(){return this._loaded}updateImage(e){return this.image&&e.url?(this.options.url=e.url,this.load(e.coordinates,(()=>{this.texture=null})),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new e.Event("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}setCoordinates(t){this.coordinates=t;const r=t.map(e.MercatorCoordinate.fromLngLat);this.tileID=function(t){let r=1/0,i=1/0,n=-1/0,a=-1/0;for(const e of t)r=Math.min(r,e.x),i=Math.min(i,e.y),n=Math.max(n,e.x),a=Math.max(a,e.y);const o=Math.max(n-r,a-i),s=Math.max(0,Math.floor(-Math.log(o)/Math.LN2)),l=Math.pow(2,s);return new e.CanonicalTileID(s,Math.floor((r+n)/2*l),Math.floor((i+a)/2*l))}(r),this.minzoom=this.maxzoom=this.tileID.z;const i=r.map((e=>this.tileID.getTilePoint(e)._round()));return this._boundsArray=new e.RasterBoundsArray,this._boundsArray.emplaceBack(i[0].x,i[0].y,0,0),this._boundsArray.emplaceBack(i[1].x,i[1].y,e.EXTENT,0),this._boundsArray.emplaceBack(i[3].x,i[3].y,0,e.EXTENT),this._boundsArray.emplaceBack(i[2].x,i[2].y,e.EXTENT,e.EXTENT),this.boundsBuffer&&(this.boundsBuffer.destroy(),delete this.boundsBuffer),this.fire(new e.Event("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(0===Object.keys(this.tiles).length||!this.image)return;const t=this.map.painter.context,r=t.gl;this.boundsBuffer||(this.boundsBuffer=t.createVertexBuffer(this._boundsArray,I.members)),this.boundsSegments||(this.boundsSegments=e.SegmentVector.simpleSegment(0,0,4,2)),this.texture||(this.texture=new l(t,this.image,r.RGBA),this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE));for(const e in this.tiles){const t=this.tiles[e];"loaded"!==t.state&&(t.state="loaded",t.texture=this.texture)}}loadTile(e,t){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},t(null)):(e.state="errored",t(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class C extends k{constructor(e,t,r,i){super(e,t,r,i),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const t=this.options;this.urls=[];for(const r of t.urls)this.urls.push(this.map._requestManager.transformRequest(r,e.ResourceType.Source).url);e.getVideo(this.urls,((t,r)=>{this._loaded=!0,t?this.fire(new e.ErrorEvent(t)):r&&(this.video=r,this.video.loop=!0,this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(t){if(this.video){const r=this.video.seekable;t<r.start(0)||t>r.end(0)?this.fire(new e.ErrorEvent(new e.ValidationError(`sources.${this.id}`,null,`Playback for this video can be set only between the ${r.start(0)} and ${r.end(0)}-second mark.`))):this.video.currentTime=t}}getVideo(){return this.video}onAdd(e){this.map||(this.map=e,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const t=this.map.painter.context,r=t.gl;this.boundsBuffer||(this.boundsBuffer=t.createVertexBuffer(this._boundsArray,I.members)),this.boundsSegments||(this.boundsSegments=e.SegmentVector.simpleSegment(0,0,4,2)),this.texture?this.video.paused||(this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE),r.texSubImage2D(r.TEXTURE_2D,0,0,0,r.RGBA,r.UNSIGNED_BYTE,this.video)):(this.texture=new l(t,this.video,r.RGBA),this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE));for(const e in this.tiles){const t=this.tiles[e];"loaded"!==t.state&&(t.state="loaded",t.texture=this.texture)}}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class z extends k{constructor(t,r,i,n){super(t,r,i,n),r.coordinates?Array.isArray(r.coordinates)&&4===r.coordinates.length&&!r.coordinates.some((e=>!Array.isArray(e)||2!==e.length||e.some((e=>"number"!=typeof e))))||this.fire(new e.ErrorEvent(new e.ValidationError(`sources.${t}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new e.ErrorEvent(new e.ValidationError(`sources.${t}`,null,'missing required property "coordinates"'))),r.animate&&"boolean"!=typeof r.animate&&this.fire(new e.ErrorEvent(new e.ValidationError(`sources.${t}`,null,'optional "animate" property must be a boolean value'))),r.canvas?"string"==typeof r.canvas||r.canvas instanceof HTMLCanvasElement||this.fire(new e.ErrorEvent(new e.ValidationError(`sources.${t}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new e.ErrorEvent(new e.ValidationError(`sources.${t}`,null,'missing required property "canvas"'))),this.options=r,this.animate=void 0===r.animate||r.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new e.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(e){this.map=e,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let t=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,t=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,t=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const r=this.map.painter.context,i=r.gl;this.boundsBuffer||(this.boundsBuffer=r.createVertexBuffer(this._boundsArray,I.members)),this.boundsSegments||(this.boundsSegments=e.SegmentVector.simpleSegment(0,0,4,2)),this.texture?(t||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new l(r,this.canvas,i.RGBA,{premultiply:!0});for(const e in this.tiles){const t=this.tiles[e];"loaded"!==t.state&&(t.state="loaded",t.texture=this.texture)}}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const e of[this.canvas.width,this.canvas.height])if(isNaN(e)||e<=0)return!0;return!1}}const M={vector:w,raster:T,"raster-dem":S,geojson:A,video:C,image:k,canvas:z};function P(t,r){const i=e.create();return e.translate(i,i,[1,1,0]),e.scale(i,i,[.5*t.width,.5*t.height,1]),e.multiply(i,i,t.calculatePosMatrix(r.toUnwrapped()))}function D(e,t,r,i,n,a){const o=function(e,t,r){if(e)for(const i of e){const e=t[i];if(e&&e.source===r&&"fill-extrusion"===e.type)return!0}else for(const e in t){const i=t[e];if(i.source===r&&"fill-extrusion"===i.type)return!0}return!1}(n&&n.layers,t,e.id),s=a.maxPitchScaleFactor(),l=e.tilesIn(i,s,o);l.sort(L);const c=[];for(const i of l)c.push({wrappedTileID:i.tileID.wrapped().key,queryResults:i.tile.queryRenderedFeatures(t,r,e._state,i.queryGeometry,i.cameraQueryGeometry,i.scale,n,a,s,P(e.transform,i.tileID))});const u=function(e){const t={},r={};for(const i of e){const e=i.queryResults,n=i.wrappedTileID,a=r[n]=r[n]||{};for(const r in e){const i=e[r],n=a[r]=a[r]||{},o=t[r]=t[r]||[];for(const e of i)n[e.featureIndex]||(n[e.featureIndex]=!0,o.push(e))}}return t}(c);for(const t in u)u[t].forEach((t=>{const r=t.feature,i=e.getFeatureState(r.layer["source-layer"],r.id);r.source=r.layer.source,r.layer["source-layer"]&&(r.sourceLayer=r.layer["source-layer"]),r.state=i}));return u}function L(e,t){const r=e.tileID,i=t.tileID;return r.overscaledZ-i.overscaledZ||r.canonical.y-i.canonical.y||r.wrap-i.wrap||r.canonical.x-i.canonical.x}class B{constructor(t,r){this.tileID=t,this.uid=e.uniqueId(),this.uses=0,this.tileSize=r,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.textures=[],this.textureCoords={},this.expiredRequestCount=0,this.state="loading"}registerFadeDuration(t){const r=t+this.timeAdded;r<e.exported.now()||this.fadeEndTime&&r<this.fadeEndTime||(this.fadeEndTime=r)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}clearTextures(e){this.demTexture&&e.saveTileTexture(this.demTexture),this.textures.forEach((t=>e.saveTileTexture(t))),this.demTexture=null,this.textures=[],this.textureCoords={}}loadVectorData(t,r,i){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=function(e,t){const r={};if(!t)return r;for(const i of e){const e=i.layerIds.map((e=>t.getLayer(e))).filter(Boolean);if(0!==e.length){i.layers=e,i.stateDependentLayerIds&&(i.stateDependentLayers=i.stateDependentLayerIds.map((t=>e.filter((e=>e.id===t))[0])));for(const t of e)r[t.id]=i}}return r}(t.buckets,r.style),this.hasSymbolBuckets=!1;for(const t in this.buckets){const r=this.buckets[t];if(r instanceof e.SymbolBucket){if(this.hasSymbolBuckets=!0,!i)break;r.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const t in this.buckets){const r=this.buckets[t];if(r instanceof e.SymbolBucket&&r.hasRTLText){this.hasRTLText=!0,e.lazyLoadRTLTextPlugin();break}}this.queryPadding=0;for(const e in this.buckets){const t=this.buckets[e];this.queryPadding=Math.max(this.queryPadding,r.style.getLayer(e).queryRadius(t))}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage)}else this.collisionBoxArray=new e.CollisionBoxArray}unloadVectorData(){for(const e in this.buckets)this.buckets[e].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(e){return this.buckets[e.id]}upload(e){for(const t in this.buckets){const r=this.buckets[t];r.uploadPending()&&r.upload(e)}const t=e.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new l(e,this.imageAtlas.image,t.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new l(e,this.glyphAtlasImage,t.ALPHA),this.glyphAtlasImage=null)}prepare(e){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(e,this.imageAtlasTexture)}queryRenderedFeatures(e,t,r,i,n,a,o,s,l,c){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:i,cameraQueryGeometry:n,scale:a,tileSize:this.tileSize,pixelPosMatrix:c,transform:s,params:o,queryPadding:this.queryPadding*l},e,t,r):{}}querySourceFeatures(t,r){const i=this.latestFeatureIndex;if(!i||!i.rawTileData)return;const n=i.loadVTLayers(),a=r?r.sourceLayer:"",o=n._geojsonTileLayer||n[a];if(!o)return;const s=e.createFilter(r&&r.filter),{z:l,x:c,y:u}=this.tileID.canonical,h={z:l,x:c,y:u};for(let r=0;r<o.length;r++){const n=o.feature(r);if(s.needGeometry){const t=e.toEvaluationFeature(n,!0);if(!s.filter(new e.EvaluationParameters(this.tileID.overscaledZ),t,this.tileID.canonical))continue}else if(!s.filter(new e.EvaluationParameters(this.tileID.overscaledZ),n))continue;const p=i.getId(n,a),d=new e.GeoJSONFeature(n,l,c,u,p);d.tile=h,t.push(d)}}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const r=this.expirationTime;if(t.cacheControl){const r=e.parseCacheControl(t.cacheControl);r["max-age"]&&(this.expirationTime=Date.now()+1e3*r["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const e=Date.now();let t=!1;if(this.expirationTime>e)t=!1;else if(r)if(this.expirationTime<r)t=!0;else{const i=this.expirationTime-r;i?this.expirationTime=e+Math.max(i,3e4):t=!0}else t=!0;t?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}setFeatureState(e,t){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||0===Object.keys(e).length)return;const r=this.latestFeatureIndex.loadVTLayers();for(const i in this.buckets){if(!t.style.hasLayer(i))continue;const n=this.buckets[i],a=n.layers[0].sourceLayer||"_geojsonTileLayer",o=r[a],s=e[a];if(!o||!s||0===Object.keys(s).length)continue;n.update(s,o,this.imageAtlas&&this.imageAtlas.patternPositions||{});const l=t&&t.style&&t.style.getLayer(i);l&&(this.queryPadding=Math.max(this.queryPadding,l.queryRadius(n)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<e.exported.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=e.exported.now()+t}setDependencies(e,t){const r={};for(const e of t)r[e]=!0;this.dependencies[e]=r}hasDependency(e,t){for(const r of e){const e=this.dependencies[r];if(e)for(const r of t)if(e[r])return!0}return!1}}class R{constructor(e,t){this.max=e,this.onRemove=t,this.reset()}reset(){for(const e in this.data)for(const t of this.data[e])t.timeout&&clearTimeout(t.timeout),this.onRemove(t.value);return this.data={},this.order=[],this}add(e,t,r){const i=e.wrapped().key;void 0===this.data[i]&&(this.data[i]=[]);const n={value:t,timeout:void 0};if(void 0!==r&&(n.timeout=setTimeout((()=>{this.remove(e,n)}),r)),this.data[i].push(n),this.order.push(i),this.order.length>this.max){const e=this._getAndRemoveByKey(this.order[0]);e&&this.onRemove(e)}return this}has(e){return e.wrapped().key in this.data}getAndRemove(e){return this.has(e)?this._getAndRemoveByKey(e.wrapped().key):null}_getAndRemoveByKey(e){const t=this.data[e].shift();return t.timeout&&clearTimeout(t.timeout),0===this.data[e].length&&delete this.data[e],this.order.splice(this.order.indexOf(e),1),t.value}getByKey(e){const t=this.data[e];return t?t[0].value:null}get(e){return this.has(e)?this.data[e.wrapped().key][0].value:null}remove(e,t){if(!this.has(e))return this;const r=e.wrapped().key,i=void 0===t?0:this.data[r].indexOf(t),n=this.data[r][i];return this.data[r].splice(i,1),n.timeout&&clearTimeout(n.timeout),0===this.data[r].length&&delete this.data[r],this.onRemove(n.value),this.order.splice(this.order.indexOf(r),1),this}setMaxSize(e){for(this.max=e;this.order.length>this.max;){const e=this._getAndRemoveByKey(this.order[0]);e&&this.onRemove(e)}return this}filter(e){const t=[];for(const r in this.data)for(const i of this.data[r])e(i.value)||t.push(i);for(const e of t)this.remove(e.value.tileID,e)}}class F{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,r,i){const n=String(r);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][n]=this.stateChanges[t][n]||{},e.extend(this.stateChanges[t][n],i),null===this.deletedStates[t]){this.deletedStates[t]={};for(const e in this.state[t])e!==n&&(this.deletedStates[t][e]=null)}else if(this.deletedStates[t]&&null===this.deletedStates[t][n]){this.deletedStates[t][n]={};for(const e in this.state[t][n])i[e]||(this.deletedStates[t][n][e]=null)}else for(const e in i)this.deletedStates[t]&&this.deletedStates[t][n]&&null===this.deletedStates[t][n][e]&&delete this.deletedStates[t][n][e]}removeFeatureState(e,t,r){if(null===this.deletedStates[e])return;const i=String(t);if(this.deletedStates[e]=this.deletedStates[e]||{},r&&void 0!==t)null!==this.deletedStates[e][i]&&(this.deletedStates[e][i]=this.deletedStates[e][i]||{},this.deletedStates[e][i][r]=null);else if(void 0!==t)if(this.stateChanges[e]&&this.stateChanges[e][i])for(r in this.deletedStates[e][i]={},this.stateChanges[e][i])this.deletedStates[e][i][r]=null;else this.deletedStates[e][i]=null;else this.deletedStates[e]=null}getState(t,r){const i=String(r),n=e.extend({},(this.state[t]||{})[i],(this.stateChanges[t]||{})[i]);if(null===this.deletedStates[t])return{};if(this.deletedStates[t]){const e=this.deletedStates[t][r];if(null===e)return{};for(const t in e)delete n[t]}return n}initializeTileState(e,t){e.setFeatureState(this.state,t)}coalesceChanges(t,r){const i={};for(const t in this.stateChanges){this.state[t]=this.state[t]||{};const r={};for(const i in this.stateChanges[t])this.state[t][i]||(this.state[t][i]={}),e.extend(this.state[t][i],this.stateChanges[t][i]),r[i]=this.state[t][i];i[t]=r}for(const t in this.deletedStates){this.state[t]=this.state[t]||{};const r={};if(null===this.deletedStates[t])for(const e in this.state[t])r[e]={},this.state[t][e]={};else for(const e in this.deletedStates[t]){if(null===this.deletedStates[t][e])this.state[t][e]={};else for(const r of Object.keys(this.deletedStates[t][e]))delete this.state[t][e][r];r[e]=this.state[t][e]}i[t]=i[t]||{},e.extend(i[t],r)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(i).length)for(const e in t)t[e].setFeatureState(i,r)}}class O extends e.Evented{constructor(t,r,i){super(),this.id=t,this.dispatcher=i,this.on("data",(e=>{"source"===e.dataType&&"metadata"===e.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===e.dataType&&"content"===e.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform,this.terrain))})),this.on("dataloading",(()=>{this._sourceErrored=!1})),this.on("error",(()=>{this._sourceErrored=this._source.loaded()})),this._source=function(t,r,i,n){const a=new M[r.type](t,r,i,n);if(a.id!==t)throw new Error(`Expected Source id to be ${t} instead of ${a.id}`);return e.bindAll(["load","abort","unload","serialize","prepare"],a),a}(t,r,i,this),this._tiles={},this._cache=new R(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new F}onAdd(e){this.map=e,this._maxTileCacheSize=e?e._maxTileCacheSize:null,this._source&&this._source.onAdd&&this._source.onAdd(e)}onRemove(e){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(e)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded)return!1;if(!this._source.loaded())return!1;for(const e in this._tiles){const t=this._tiles[e];if("loaded"!==t.state&&"errored"!==t.state)return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(e,t){return this._source.loadTile(e,t)}_unloadTile(e){if(this._source.unloadTile)return this._source.unloadTile(e,(()=>{}))}_abortTile(t){this._source.abortTile&&this._source.abortTile(t,(()=>{})),this._source.fire(new e.Event("dataabort",{tile:t,coord:t.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(e){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const t in this._tiles){const r=this._tiles[t];r.upload(e),r.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map((e=>e.tileID)).sort(U).map((e=>e.key))}getRenderableIds(t){const r=[];for(const e in this._tiles)this._isIdRenderable(e,t)&&r.push(this._tiles[e]);return t?r.sort(((t,r)=>{const i=t.tileID,n=r.tileID,a=new e.pointGeometry(i.canonical.x,i.canonical.y)._rotate(this.transform.angle),o=new e.pointGeometry(n.canonical.x,n.canonical.y)._rotate(this.transform.angle);return i.overscaledZ-n.overscaledZ||o.y-a.y||o.x-a.x})).map((e=>e.tileID.key)):r.map((e=>e.tileID)).sort(U).map((e=>e.key))}hasRenderableParent(e){const t=this.findLoadedParent(e,0);return!!t&&this._isIdRenderable(t.tileID.key)}_isIdRenderable(e,t){return this._tiles[e]&&this._tiles[e].hasData()&&!this._coveredTiles[e]&&(t||!this._tiles[e].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const e in this._tiles)"errored"!==this._tiles[e].state&&this._reloadTile(e,"reloading")}}_reloadTile(e,t){const r=this._tiles[e];r&&("loading"!==r.state&&(r.state=t),this._loadTile(r,this._tileLoaded.bind(this,r,e,t)))}_tileLoaded(t,r,i,n){if(n)return t.state="errored",void(404!==n.status?this._source.fire(new e.ErrorEvent(n,{tile:t})):this.update(this.transform,this.terrain));t.timeAdded=e.exported.now(),"expired"===i&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(r,t),"raster-dem"===this.getSource().type&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),t.aborted||this._source.fire(new e.Event("data",{dataType:"source",tile:t,coord:t.tileID}))}_backfillDEM(e){const t=this.getRenderableIds();for(let i=0;i<t.length;i++){const n=t[i];if(e.neighboringTiles&&e.neighboringTiles[n]){const t=this.getTileByID(n);r(e,t),r(t,e)}}function r(e,t){e.needsHillshadePrepare=!0,e.needsTerrainPrepare=!0;let r=t.tileID.canonical.x-e.tileID.canonical.x;const i=t.tileID.canonical.y-e.tileID.canonical.y,n=Math.pow(2,e.tileID.canonical.z),a=t.tileID.key;0===r&&0===i||Math.abs(i)>1||(Math.abs(r)>1&&(1===Math.abs(r+n)?r+=n:1===Math.abs(r-n)&&(r-=n)),t.dem&&e.dem&&(e.dem.backfillBorder(t.dem,r,i),e.neighboringTiles&&e.neighboringTiles[a]&&(e.neighboringTiles[a].backfilled=!0)))}}getTile(e){return this.getTileByID(e.key)}getTileByID(e){return this._tiles[e]}_retainLoadedChildren(e,t,r,i){for(const n in this._tiles){let a=this._tiles[n];if(i[n]||!a.hasData()||a.tileID.overscaledZ<=t||a.tileID.overscaledZ>r)continue;let o=a.tileID;for(;a&&a.tileID.overscaledZ>t+1;){const e=a.tileID.scaledTo(a.tileID.overscaledZ-1);a=this._tiles[e.key],a&&a.hasData()&&(o=e)}let s=o;for(;s.overscaledZ>t;)if(s=s.scaledTo(s.overscaledZ-1),e[s.key]){i[o.key]=o;break}}}findLoadedParent(e,t){if(e.key in this._loadedParentTiles){const r=this._loadedParentTiles[e.key];return r&&r.tileID.overscaledZ>=t?r:null}for(let r=e.overscaledZ-1;r>=t;r--){const t=e.scaledTo(r),i=this._getLoadedTile(t);if(i)return i}}_getLoadedTile(e){const t=this._tiles[e.key];return t&&t.hasData()?t:this._cache.getByKey(e.wrapped().key)}updateCacheSize(e){const t=Math.ceil(e.width/this._source.tileSize)+1,r=Math.ceil(e.height/this._source.tileSize)+1,i=Math.floor(t*r*5),n="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,i):i;this._cache.setMaxSize(n)}handleWrapJump(e){const t=Math.round((e-(void 0===this._prevLng?e:this._prevLng))/360);if(this._prevLng=e,t){const e={};for(const r in this._tiles){const i=this._tiles[r];i.tileID=i.tileID.unwrapTo(i.tileID.wrap+t),e[i.tileID.key]=i}this._tiles=e;for(const e in this._timers)clearTimeout(this._timers[e]),delete this._timers[e];for(const e in this._tiles)this._setTileReloadTimer(e,this._tiles[e])}}update(t,r){if(this.transform=t,this.terrain=r,!this._sourceLoaded||this._paused)return;let i;this.updateCacheSize(t),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?i=t.getVisibleUnwrappedCoordinates(this._source.tileID).map((t=>new e.OverscaledTileID(t.canonical.z,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y))):(i=t.coveringTiles({tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:r}),this._source.hasTile&&(i=i.filter((e=>this._source.hasTile(e))))):i=[];const n=t.coveringZoomLevel(this._source),a=Math.max(n-O.maxOverzooming,this._source.minzoom),o=Math.max(n+O.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){const e={};for(const t of i)if(t.canonical.z>this._source.minzoom){const r=t.scaledTo(t.canonical.z-1);e[r.key]=r;const i=t.scaledTo(Math.max(this._source.minzoom,Math.min(t.canonical.z,5)));e[i.key]=i}i=i.concat(Object.values(e))}const s=this._updateRetainedTiles(i,n);if(V(this._source.type)){const t={},l={},c=Object.keys(s);for(const r of c){const i=s[r],n=this._tiles[r];if(!n||n.fadeEndTime&&n.fadeEndTime<=e.exported.now())continue;const o=this.findLoadedParent(i,a);o&&(this._addTile(o.tileID),t[o.tileID.key]=o.tileID),l[r]=i}this._retainLoadedChildren(l,n,o,s);for(const e in t)s[e]||(this._coveredTiles[e]=!0,s[e]=t[e]);if(r){const e={},t={};for(const r of i)this._tiles[r.key].hasData()?e[r.key]=r:t[r.key]=r;for(const r in t){const i=t[r].children(this._source.maxzoom);this._tiles[i[0].key]&&this._tiles[i[1].key]&&this._tiles[i[2].key]&&this._tiles[i[3].key]&&(e[i[0].key]=s[i[0].key]=i[0],e[i[1].key]=s[i[1].key]=i[1],e[i[2].key]=s[i[2].key]=i[2],e[i[3].key]=s[i[3].key]=i[3],delete t[r])}for(const r in t){const i=this.findLoadedParent(t[r],this._source.minzoom);if(i){e[i.tileID.key]=s[i.tileID.key]=i.tileID;for(const t in e)e[t].isChildOf(i.tileID)&&delete e[t]}}for(const t in this._tiles)e[t]||(this._coveredTiles[t]=!0)}}for(const e in s)this._tiles[e].clearFadeHold();const l=e.keysDifference(this._tiles,s);for(const e of l){const t=this._tiles[e];t.hasSymbolBuckets&&!t.holdingForFade()?t.setHoldDuration(this.map._fadeDuration):t.hasSymbolBuckets&&!t.symbolFadeFinished()||this._removeTile(e)}this._updateLoadedParentTileCache()}releaseSymbolFadeTiles(){for(const e in this._tiles)this._tiles[e].holdingForFade()&&this._removeTile(e)}_updateRetainedTiles(e,t){const r={},i={},n=Math.max(t-O.maxOverzooming,this._source.minzoom),a=Math.max(t+O.maxUnderzooming,this._source.minzoom),o={};for(const i of e){const e=this._addTile(i);r[i.key]=i,e.hasData()||t<this._source.maxzoom&&(o[i.key]=i)}this._retainLoadedChildren(o,t,a,r);for(const a of e){let e=this._tiles[a.key];if(e.hasData())continue;if(t+1>this._source.maxzoom){const e=a.children(this._source.maxzoom)[0],t=this.getTile(e);if(t&&t.hasData()){r[e.key]=e;continue}}else{const e=a.children(this._source.maxzoom);if(r[e[0].key]&&r[e[1].key]&&r[e[2].key]&&r[e[3].key])continue}let o=e.wasRequested();for(let t=a.overscaledZ-1;t>=n;--t){const n=a.scaledTo(t);if(i[n.key])break;if(i[n.key]=!0,e=this.getTile(n),!e&&o&&(e=this._addTile(n)),e&&(r[n.key]=n,o=e.wasRequested(),e.hasData()))break}}return r}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const e in this._tiles){const t=[];let r,i=this._tiles[e].tileID;for(;i.overscaledZ>0;){if(i.key in this._loadedParentTiles){r=this._loadedParentTiles[i.key];break}t.push(i.key);const e=i.scaledTo(i.overscaledZ-1);if(r=this._getLoadedTile(e),r)break;i=e}for(const e of t)this._loadedParentTiles[e]=r}}_addTile(t){let r=this._tiles[t.key];if(r)return r;r=this._cache.getAndRemove(t),r&&(this._setTileReloadTimer(t.key,r),r.tileID=t,this._state.initializeTileState(r,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,r)));const i=r;return r||(r=new B(t,this._source.tileSize*t.overscaleFactor()),this._loadTile(r,this._tileLoaded.bind(this,r,t.key,r.state))),r.uses++,this._tiles[t.key]=r,i||this._source.fire(new e.Event("dataloading",{tile:r,coord:r.tileID,dataType:"source"})),r}_setTileReloadTimer(e,t){e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);const r=t.getExpiryTimeout();r&&(this._timers[e]=setTimeout((()=>{this._reloadTile(e,"expired"),delete this._timers[e]}),r))}_removeTile(e){const t=this._tiles[e];t&&(t.uses--,delete this._tiles[e],this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),t.uses>0||(t.hasData()&&"reloading"!==t.state?this._cache.add(t.tileID,t,t.getExpiryTimeout()):(t.aborted=!0,this._abortTile(t),this._unloadTile(t))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const e in this._tiles)this._removeTile(e);this._cache.reset()}tilesIn(t,r,i){const n=[],a=this.transform;if(!a)return n;const o=i?a.getCameraQueryGeometry(t):t,s=t.map((e=>a.pointCoordinate(e,this.terrain))),l=o.map((e=>a.pointCoordinate(e,this.terrain))),c=this.getIds();let u=1/0,h=1/0,p=-1/0,d=-1/0;for(const e of l)u=Math.min(u,e.x),h=Math.min(h,e.y),p=Math.max(p,e.x),d=Math.max(d,e.y);for(let t=0;t<c.length;t++){const i=this._tiles[c[t]];if(i.holdingForFade())continue;const o=i.tileID,f=Math.pow(2,a.zoom-i.tileID.overscaledZ),m=r*i.queryPadding*e.EXTENT/i.tileSize/f,g=[o.getTilePoint(new e.MercatorCoordinate(u,h)),o.getTilePoint(new e.MercatorCoordinate(p,d))];if(g[0].x-m<e.EXTENT&&g[0].y-m<e.EXTENT&&g[1].x+m>=0&&g[1].y+m>=0){const e=s.map((e=>o.getTilePoint(e))),t=l.map((e=>o.getTilePoint(e)));n.push({tile:i,tileID:o,queryGeometry:e,cameraQueryGeometry:t,scale:f})}}return n}getVisibleCoordinates(e){const t=this.getRenderableIds(e).map((e=>this._tiles[e].tileID));for(const e of t)e.posMatrix=this.transform.calculatePosMatrix(e.toUnwrapped());return t}hasTransition(){if(this._source.hasTransition())return!0;if(V(this._source.type))for(const t in this._tiles){const r=this._tiles[t];if(void 0!==r.fadeEndTime&&r.fadeEndTime>=e.exported.now())return!0}return!1}setFeatureState(e,t,r){this._state.updateState(e=e||"_geojsonTileLayer",t,r)}removeFeatureState(e,t,r){this._state.removeFeatureState(e=e||"_geojsonTileLayer",t,r)}getFeatureState(e,t){return this._state.getState(e=e||"_geojsonTileLayer",t)}setDependencies(e,t,r){const i=this._tiles[e];i&&i.setDependencies(t,r)}reloadTilesForDependencies(e,t){for(const r in this._tiles)this._tiles[r].hasDependency(e,t)&&this._reloadTile(r,"reloading");this._cache.filter((r=>!r.hasDependency(e,t)))}}function U(e,t){const r=Math.abs(2*e.wrap)-+(e.wrap<0),i=Math.abs(2*t.wrap)-+(t.wrap<0);return e.overscaledZ-t.overscaledZ||i-r||t.canonical.y-e.canonical.y||t.canonical.x-e.canonical.x}function V(e){return"raster"===e||"image"===e||"video"===e}O.maxOverzooming=10,O.maxUnderzooming=3;const $="mapboxgl_preloaded_worker_pool";class N{constructor(){this.active={}}acquire(e){if(!this.workers)for(this.workers=[];this.workers.length<N.workerCount;)this.workers.push(new Worker(bn.workerUrl));return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],0===this.numActive()&&(this.workers.forEach((e=>{e.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[$]}numActive(){return Object.keys(this.active).length}}const j=Math.floor(e.exported.hardwareConcurrency/2);let q;function G(){return q||(q=new N),q}function Z(t,r){const i={};for(const e in t)"ref"!==e&&(i[e]=t[e]);return e.refProperties.forEach((e=>{e in r&&(i[e]=r[e])})),i}function X(e){e=e.slice();const t=Object.create(null);for(let r=0;r<e.length;r++)t[e[r].id]=e[r];for(let r=0;r<e.length;r++)"ref"in e[r]&&(e[r]=Z(e[r],t[e[r].ref]));return e}N.workerCount=Math.max(Math.min(j,6),1);const W={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight"};function H(e,t,r){r.push({command:W.addSource,args:[e,t[e]]})}function K(e,t,r){t.push({command:W.removeSource,args:[e]}),r[e]=!0}function Y(e,t,r,i){K(e,r,i),H(e,t,r)}function J(e,t,r){let i;for(i in e[r])if(Object.prototype.hasOwnProperty.call(e[r],i)&&"data"!==i&&!n(e[r][i],t[r][i]))return!1;for(i in t[r])if(Object.prototype.hasOwnProperty.call(t[r],i)&&"data"!==i&&!n(e[r][i],t[r][i]))return!1;return!0}function Q(e,t,r,i,a,o){let s;for(s in t=t||{},e=e||{})Object.prototype.hasOwnProperty.call(e,s)&&(n(e[s],t[s])||r.push({command:o,args:[i,s,t[s],a]}));for(s in t)Object.prototype.hasOwnProperty.call(t,s)&&!Object.prototype.hasOwnProperty.call(e,s)&&(n(e[s],t[s])||r.push({command:o,args:[i,s,t[s],a]}))}function ee(e){return e.id}function te(e,t){return e[t.id]=t,e}class re{constructor(e,t){this.reset(e,t)}reset(e,t){this.points=e||[],this._distances=[0];for(let e=1;e<this.points.length;e++)this._distances[e]=this._distances[e-1]+this.points[e].dist(this.points[e-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(t||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(1===this.points.length)return this.points[0];t=e.clamp(t,0,1);let r=1,i=this._distances[r];const n=t*this.paddedLength+this.padding;for(;i<n&&r<this._distances.length;)i=this._distances[++r];const a=r-1,o=this._distances[a],s=i-o,l=s>0?(n-o)/s:0;return this.points[a].mult(1-l).add(this.points[r].mult(l))}}function ie(e,t){let r=!0;return"always"===e||"never"!==e&&"never"!==t||(r=!1),r}class ne{constructor(e,t,r){const i=this.boxCells=[],n=this.circleCells=[];this.xCellCount=Math.ceil(e/r),this.yCellCount=Math.ceil(t/r);for(let e=0;e<this.xCellCount*this.yCellCount;e++)i.push([]),n.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=e,this.height=t,this.xScale=this.xCellCount/e,this.yScale=this.yCellCount/t,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(e,t,r,i,n){this._forEachCell(t,r,i,n,this._insertBoxCell,this.boxUid++),this.boxKeys.push(e),this.bboxes.push(t),this.bboxes.push(r),this.bboxes.push(i),this.bboxes.push(n)}insertCircle(e,t,r,i){this._forEachCell(t-i,r-i,t+i,r+i,this._insertCircleCell,this.circleUid++),this.circleKeys.push(e),this.circles.push(t),this.circles.push(r),this.circles.push(i)}_insertBoxCell(e,t,r,i,n,a){this.boxCells[n].push(a)}_insertCircleCell(e,t,r,i,n,a){this.circleCells[n].push(a)}_query(e,t,r,i,n,a,o){if(r<0||e>this.width||i<0||t>this.height)return[];const s=[];if(e<=0&&t<=0&&this.width<=r&&this.height<=i){if(n)return[{key:null,x1:e,y1:t,x2:r,y2:i}];for(let e=0;e<this.boxKeys.length;e++)s.push({key:this.boxKeys[e],x1:this.bboxes[4*e],y1:this.bboxes[4*e+1],x2:this.bboxes[4*e+2],y2:this.bboxes[4*e+3]});for(let e=0;e<this.circleKeys.length;e++){const t=this.circles[3*e],r=this.circles[3*e+1],i=this.circles[3*e+2];s.push({key:this.circleKeys[e],x1:t-i,y1:r-i,x2:t+i,y2:r+i})}}else this._forEachCell(e,t,r,i,this._queryCell,s,{hitTest:n,overlapMode:a,seenUids:{box:{},circle:{}}},o);return s}query(e,t,r,i){return this._query(e,t,r,i,!1,null)}hitTest(e,t,r,i,n,a){return this._query(e,t,r,i,!0,n,a).length>0}hitTestCircle(e,t,r,i,n){const a=e-r,o=e+r,s=t-r,l=t+r;if(o<0||a>this.width||l<0||s>this.height)return!1;const c=[];return this._forEachCell(a,s,o,l,this._queryCellCircle,c,{hitTest:!0,overlapMode:i,circle:{x:e,y:t,radius:r},seenUids:{box:{},circle:{}}},n),c.length>0}_queryCell(e,t,r,i,n,a,o,s){const{seenUids:l,hitTest:c,overlapMode:u}=o,h=this.boxCells[n];if(null!==h){const n=this.bboxes;for(const o of h)if(!l.box[o]){l.box[o]=!0;const h=4*o,p=this.boxKeys[o];if(e<=n[h+2]&&t<=n[h+3]&&r>=n[h+0]&&i>=n[h+1]&&(!s||s(p))&&(!c||!ie(u,p.overlapMode))&&(a.push({key:p,x1:n[h],y1:n[h+1],x2:n[h+2],y2:n[h+3]}),c))return!0}}const p=this.circleCells[n];if(null!==p){const n=this.circles;for(const o of p)if(!l.circle[o]){l.circle[o]=!0;const h=3*o,p=this.circleKeys[o];if(this._circleAndRectCollide(n[h],n[h+1],n[h+2],e,t,r,i)&&(!s||s(p))&&(!c||!ie(u,p.overlapMode))){const e=n[h],t=n[h+1],r=n[h+2];if(a.push({key:p,x1:e-r,y1:t-r,x2:e+r,y2:t+r}),c)return!0}}}return!1}_queryCellCircle(e,t,r,i,n,a,o,s){const{circle:l,seenUids:c,overlapMode:u}=o,h=this.boxCells[n];if(null!==h){const e=this.bboxes;for(const t of h)if(!c.box[t]){c.box[t]=!0;const r=4*t,i=this.boxKeys[t];if(this._circleAndRectCollide(l.x,l.y,l.radius,e[r+0],e[r+1],e[r+2],e[r+3])&&(!s||s(i))&&!ie(u,i.overlapMode))return a.push(!0),!0}}const p=this.circleCells[n];if(null!==p){const e=this.circles;for(const t of p)if(!c.circle[t]){c.circle[t]=!0;const r=3*t,i=this.circleKeys[t];if(this._circlesCollide(e[r],e[r+1],e[r+2],l.x,l.y,l.radius)&&(!s||s(i))&&!ie(u,i.overlapMode))return a.push(!0),!0}}}_forEachCell(e,t,r,i,n,a,o,s){const l=this._convertToXCellCoord(e),c=this._convertToYCellCoord(t),u=this._convertToXCellCoord(r),h=this._convertToYCellCoord(i);for(let p=l;p<=u;p++)for(let l=c;l<=h;l++)if(n.call(this,e,t,r,i,this.xCellCount*l+p,a,o,s))return}_convertToXCellCoord(e){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(e*this.xScale)))}_convertToYCellCoord(e){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(e*this.yScale)))}_circlesCollide(e,t,r,i,n,a){const o=i-e,s=n-t,l=r+a;return l*l>o*o+s*s}_circleAndRectCollide(e,t,r,i,n,a,o){const s=(a-i)/2,l=Math.abs(e-(i+s));if(l>s+r)return!1;const c=(o-n)/2,u=Math.abs(t-(n+c));if(u>c+r)return!1;if(l<=s||u<=c)return!0;const h=l-s,p=u-c;return h*h+p*p<=r*r}}function ae(t,r,i,n,a){const o=e.create();return r?(e.scale(o,o,[1/a,1/a,1]),i||e.rotateZ(o,o,n.angle)):e.multiply(o,n.labelPlaneMatrix,t),o}function oe(t,r,i,n,a){if(r){const r=e.clone(t);return e.scale(r,r,[a,a,1]),i||e.rotateZ(r,r,-n.angle),r}return n.glCoordMatrix}function se(t,r,i){let n;i?(n=[t.x,t.y,i(t.x,t.y),1],e.transformMat4(n,n,r)):(n=[t.x,t.y,0,1],_e(n,n,r));const a=n[3];return{point:new e.pointGeometry(n[0]/a,n[1]/a),signedDistanceFromCamera:a}}function le(e,t){return.5+e/t*.5}function ce(e,t){const r=e[0]/e[3],i=e[1]/e[3];return r>=-t[0]&&r<=t[0]&&i>=-t[1]&&i<=t[1]}function ue(t,r,i,n,a,o,s,l,c,u){const h=n?t.textSizeData:t.iconSizeData,p=e.evaluateSizeForZoom(h,i.transform.zoom),d=[256/i.width*2+1,256/i.height*2+1],f=n?t.text.dynamicLayoutVertexArray:t.icon.dynamicLayoutVertexArray;f.clear();const m=t.lineVertexArray,g=n?t.text.placedSymbolArray:t.icon.placedSymbolArray,y=i.transform.width/i.transform.height;let _=!1;for(let n=0;n<g.length;n++){const x=g.get(n);if(x.hidden||x.writingMode===e.WritingMode.vertical&&!_){ye(x.numGlyphs,f);continue}let v;if(_=!1,u?(v=[x.anchorX,x.anchorY,u(x.anchorX,x.anchorY),1],e.transformMat4(v,v,r)):(v=[x.anchorX,x.anchorY,0,1],_e(v,v,r)),!ce(v,d)){ye(x.numGlyphs,f);continue}const b=le(i.transform.cameraToCenterDistance,v[3]),w=e.evaluateSizeForFeature(h,p,x),T=s?w/b:w*b,E=new e.pointGeometry(x.anchorX,x.anchorY),S=se(E,a,u).point,A={},I=de(x,T,!1,l,r,a,o,t.glyphOffsetArray,m,f,S,E,A,y,c,u);_=I.useVertical,(I.notEnoughRoom||_||I.needsFlipping&&de(x,T,!0,l,r,a,o,t.glyphOffsetArray,m,f,S,E,A,y,c,u).notEnoughRoom)&&ye(x.numGlyphs,f)}n?t.text.dynamicLayoutVertexBuffer.updateData(f):t.icon.dynamicLayoutVertexBuffer.updateData(f)}function he(e,t,r,i,n,a,o,s,l,c,u,h,p){const d=s.glyphStartIndex+s.numGlyphs,f=s.lineStartIndex,m=s.lineStartIndex+s.lineLength,g=t.getoffsetX(s.glyphStartIndex),y=t.getoffsetX(d-1),_=me(e*g,r,i,n,a,o,s.segment,f,m,l,c,u,h,p);if(!_)return null;const x=me(e*y,r,i,n,a,o,s.segment,f,m,l,c,u,h,p);return x?{first:_,last:x}:null}function pe(t,r,i,n){return t===e.WritingMode.horizontal&&Math.abs(i.y-r.y)>Math.abs(i.x-r.x)*n?{useVertical:!0}:(t===e.WritingMode.vertical?r.y<i.y:r.x>i.x)?{needsFlipping:!0}:null}function de(t,r,i,n,a,o,s,l,c,u,h,p,d,f,m,g){const y=r/24,_=t.lineOffsetX*y,x=t.lineOffsetY*y;let v;if(t.numGlyphs>1){const e=t.glyphStartIndex+t.numGlyphs,r=t.lineStartIndex,a=t.lineStartIndex+t.lineLength,u=he(y,l,_,x,i,h,p,t,c,o,d,m,g);if(!u)return{notEnoughRoom:!0};const b=se(u.first.point,s,g).point,w=se(u.last.point,s,g).point;if(n&&!i){const e=pe(t.writingMode,b,w,f);if(e)return e}v=[u.first];for(let n=t.glyphStartIndex+1;n<e-1;n++)v.push(me(y*l.getoffsetX(n),_,x,i,h,p,t.segment,r,a,c,o,d,m,g));v.push(u.last)}else{if(n&&!i){const r=se(p,a,g).point,i=t.lineStartIndex+t.segment+1,n=new e.pointGeometry(c.getx(i),c.gety(i)),o=se(n,a,g),s=o.signedDistanceFromCamera>0?o.point:fe(p,n,r,1,a,g),l=pe(t.writingMode,r,s,f);if(l)return l}const r=me(y*l.getoffsetX(t.glyphStartIndex),_,x,i,h,p,t.segment,t.lineStartIndex,t.lineStartIndex+t.lineLength,c,o,d,m,g);if(!r)return{notEnoughRoom:!0};v=[r]}for(const t of v)e.addDynamicAttributes(u,t.point,t.angle);return{}}function fe(e,t,r,i,n,a){const o=se(e.add(e.sub(t)._unit()),n,a).point,s=r.sub(o);return r.add(s._mult(i/s.mag()))}function me(t,r,i,n,a,o,s,l,c,u,h,p,d,f){const m=n?t-r:t+r;let g=m>0?1:-1,y=0;n&&(g*=-1,y=Math.PI),g<0&&(y+=Math.PI);let _=g>0?l+s:l+s+1,x=a,v=a,b=0,w=0;const T=Math.abs(m),E=[];for(;b+w<=T;){if(_+=g,_<l||_>=c)return null;if(v=x,E.push(x),x=p[_],void 0===x){const t=new e.pointGeometry(u.getx(_),u.gety(_)),r=se(t,h,f);if(r.signedDistanceFromCamera>0)x=p[_]=r.point;else{const r=_-g;x=fe(0===b?o:new e.pointGeometry(u.getx(r),u.gety(r)),t,v,T-b+1,h,f)}}b+=w,w=v.dist(x)}const S=(T-b)/w,A=x.sub(v),I=A.mult(S)._add(v);I._add(A._unit()._perp()._mult(i*g));const k=y+Math.atan2(x.y-v.y,x.x-v.x);return E.push(I),{point:I,angle:d?k:0,path:E}}const ge=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function ye(e,t){for(let r=0;r<e;r++){const e=t.length;t.resize(e+4),t.float32.set(ge,3*e)}}function _e(e,t,r){const i=t[0],n=t[1];return e[0]=r[0]*i+r[4]*n+r[12],e[1]=r[1]*i+r[5]*n+r[13],e[3]=r[3]*i+r[7]*n+r[15],e}const xe=100;class ve{constructor(e,t=new ne(e.width+200,e.height+200,25),r=new ne(e.width+200,e.height+200,25)){this.transform=e,this.grid=t,this.ignoredGrid=r,this.pitchfactor=Math.cos(e._pitch)*e.cameraToCenterDistance,this.screenRightBoundary=e.width+xe,this.screenBottomBoundary=e.height+xe,this.gridRightBoundary=e.width+200,this.gridBottomBoundary=e.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(e,t,r,i,n,a){const o=this.projectAndGetPerspectiveRatio(i,e.anchorPointX,e.anchorPointY,a),s=r*o.perspectiveRatio,l=e.x1*s+o.point.x,c=e.y1*s+o.point.y,u=e.x2*s+o.point.x,h=e.y2*s+o.point.y;return!this.isInsideGrid(l,c,u,h)||"always"!==t&&this.grid.hitTest(l,c,u,h,t,n)||o.perspectiveRatio<this.perspectiveRatioCutoff?{box:[],offscreen:!1}:{box:[l,c,u,h],offscreen:this.isOffscreen(l,c,u,h)}}placeCollisionCircles(t,r,i,n,a,o,s,l,c,u,h,p,d,f){const m=[],g=new e.pointGeometry(r.anchorX,r.anchorY),y=se(g,o,f),_=le(this.transform.cameraToCenterDistance,y.signedDistanceFromCamera),x=(u?a/_:a*_)/e.ONE_EM,v=se(g,s,f).point,b=he(x,n,r.lineOffsetX*x,r.lineOffsetY*x,!1,v,g,r,i,s,{},!1,f);let w=!1,T=!1,E=!0;if(b){const r=.5*p*_+d,i=new e.pointGeometry(-100,-100),n=new e.pointGeometry(this.screenRightBoundary,this.screenBottomBoundary),a=new re,o=b.first,s=b.last;let u=[];for(let e=o.path.length-1;e>=1;e--)u.push(o.path[e]);for(let e=1;e<s.path.length;e++)u.push(s.path[e]);const g=2.5*r;if(l){const e=u.map((e=>se(e,l,f)));u=e.some((e=>e.signedDistanceFromCamera<=0))?[]:e.map((e=>e.point))}let y=[];if(u.length>0){const t=u[0].clone(),r=u[0].clone();for(let e=1;e<u.length;e++)t.x=Math.min(t.x,u[e].x),t.y=Math.min(t.y,u[e].y),r.x=Math.max(r.x,u[e].x),r.y=Math.max(r.y,u[e].y);y=t.x>=i.x&&r.x<=n.x&&t.y>=i.y&&r.y<=n.y?[u]:r.x<i.x||t.x>n.x||r.y<i.y||t.y>n.y?[]:e.clipLine([u],i.x,i.y,n.x,n.y)}for(const e of y){a.reset(e,.25*r);let i=0;i=a.length<=.5*r?1:Math.ceil(a.paddedLength/g)+1;for(let e=0;e<i;e++){const n=e/Math.max(i-1,1),o=a.lerp(n),s=o.x+xe,l=o.y+xe;m.push(s,l,r,0);const u=s-r,p=l-r,d=s+r,f=l+r;if(E=E&&this.isOffscreen(u,p,d,f),T=T||this.isInsideGrid(u,p,d,f),"always"!==t&&this.grid.hitTestCircle(s,l,r,t,h)&&(w=!0,!c))return{circles:[],offscreen:!1,collisionDetected:w}}}}return{circles:!c&&w||!T||_<this.perspectiveRatioCutoff?[]:m,offscreen:E,collisionDetected:w}}queryRenderedSymbols(t){if(0===t.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const r=[];let i=1/0,n=1/0,a=-1/0,o=-1/0;for(const s of t){const t=new e.pointGeometry(s.x+xe,s.y+xe);i=Math.min(i,t.x),n=Math.min(n,t.y),a=Math.max(a,t.x),o=Math.max(o,t.y),r.push(t)}const s=this.grid.query(i,n,a,o).concat(this.ignoredGrid.query(i,n,a,o)),l={},c={};for(const t of s){const i=t.key;if(void 0===l[i.bucketInstanceId]&&(l[i.bucketInstanceId]={}),l[i.bucketInstanceId][i.featureIndex])continue;const n=[new e.pointGeometry(t.x1,t.y1),new e.pointGeometry(t.x2,t.y1),new e.pointGeometry(t.x2,t.y2),new e.pointGeometry(t.x1,t.y2)];e.polygonIntersectsPolygon(r,n)&&(l[i.bucketInstanceId][i.featureIndex]=!0,void 0===c[i.bucketInstanceId]&&(c[i.bucketInstanceId]=[]),c[i.bucketInstanceId].push(i.featureIndex))}return c}insertCollisionBox(e,t,r,i,n,a){(r?this.ignoredGrid:this.grid).insert({bucketInstanceId:i,featureIndex:n,collisionGroupID:a,overlapMode:t},e[0],e[1],e[2],e[3])}insertCollisionCircles(e,t,r,i,n,a){const o=r?this.ignoredGrid:this.grid,s={bucketInstanceId:i,featureIndex:n,collisionGroupID:a,overlapMode:t};for(let t=0;t<e.length;t+=4)o.insertCircle(s,e[t],e[t+1],e[t+2])}projectAndGetPerspectiveRatio(t,r,i,n){let a;return n?(a=[r,i,n(r,i),1],e.transformMat4(a,a,t)):(a=[r,i,0,1],_e(a,a,t)),{point:new e.pointGeometry((a[0]/a[3]+1)/2*this.transform.width+xe,(-a[1]/a[3]+1)/2*this.transform.height+xe),perspectiveRatio:.5+this.transform.cameraToCenterDistance/a[3]*.5}}isOffscreen(e,t,r,i){return r<xe||e>=this.screenRightBoundary||i<xe||t>this.screenBottomBoundary}isInsideGrid(e,t,r,i){return r>=0&&e<this.gridRightBoundary&&i>=0&&t<this.gridBottomBoundary}getViewportMatrix(){const t=e.identity([]);return e.translate(t,t,[-100,-100,0]),t}}function be(t,r,i){return r*(e.EXTENT/(t.tileSize*Math.pow(2,i-t.tileID.overscaledZ)))}class we{constructor(e,t,r,i){this.opacity=e?Math.max(0,Math.min(1,e.opacity+(e.placed?t:-t))):i&&r?1:0,this.placed=r}isHidden(){return 0===this.opacity&&!this.placed}}class Te{constructor(e,t,r,i,n){this.text=new we(e?e.text:null,t,r,n),this.icon=new we(e?e.icon:null,t,i,n)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Ee{constructor(e,t,r){this.text=e,this.icon=t,this.skipFade=r}}class Se{constructor(){this.invProjMatrix=e.create(),this.viewportMatrix=e.create(),this.circles=[]}}class Ae{constructor(e,t,r,i,n){this.bucketInstanceId=e,this.featureIndex=t,this.sourceLayerIndex=r,this.bucketIndex=i,this.tileID=n}}class Ie{constructor(e){this.crossSourceCollisions=e,this.maxGroupID=0,this.collisionGroups={}}get(e){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[e]){const t=++this.maxGroupID;this.collisionGroups[e]={ID:t,predicate:e=>e.collisionGroupID===t}}return this.collisionGroups[e]}}function ke(t,r,i,n,a){const{horizontalAlign:o,verticalAlign:s}=e.getAnchorAlignment(t),l=-(o-.5)*r,c=-(s-.5)*i,u=e.evaluateVariableOffset(t,n);return new e.pointGeometry(l+u[0]*a,c+u[1]*a)}function Ce(t,r,i,n,a,o){const{x1:s,x2:l,y1:c,y2:u,anchorPointX:h,anchorPointY:p}=t,d=new e.pointGeometry(r,i);return n&&d._rotate(a?o:-o),{x1:s+d.x,y1:c+d.y,x2:l+d.x,y2:u+d.y,anchorPointX:h,anchorPointY:p}}class ze{constructor(e,t,r,i,n){this.transform=e.clone(),this.terrain=t,this.collisionIndex=new ve(this.transform),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=r,this.retainedQueryData={},this.collisionGroups=new Ie(i),this.collisionCircleArrays={},this.prevPlacement=n,n&&(n.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,r,i,n){const a=i.getBucket(r),o=i.latestFeatureIndex;if(!a||!o||r.id!==a.layerIds[0])return;const s=i.collisionBoxArray,l=a.layers[0].layout,c=Math.pow(2,this.transform.zoom-i.tileID.overscaledZ),u=i.tileSize/e.EXTENT,h=this.transform.calculatePosMatrix(i.tileID.toUnwrapped()),p="map"===l.get("text-pitch-alignment"),d="map"===l.get("text-rotation-alignment"),f=be(i,1,this.transform.zoom),m=ae(h,p,d,this.transform,f);let g=null;if(p){const t=oe(h,p,d,this.transform,f);g=e.multiply([],this.transform.labelPlaneMatrix,t)}this.retainedQueryData[a.bucketInstanceId]=new Ae(a.bucketInstanceId,o,a.sourceLayerIndex,a.index,i.tileID);const y={bucket:a,layout:l,posMatrix:h,textLabelPlaneMatrix:m,labelToScreenMatrix:g,scale:c,textPixelRatio:u,holdingForFade:i.holdingForFade(),collisionBoxArray:s,partiallyEvaluatedTextSize:e.evaluateSizeForZoom(a.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(a.sourceID)};if(n)for(const e of a.sortKeyRanges){const{sortKey:r,symbolInstanceStart:i,symbolInstanceEnd:n}=e;t.push({sortKey:r,symbolInstanceStart:i,symbolInstanceEnd:n,parameters:y})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:a.symbolInstances.length,parameters:y})}attemptAnchorPlacement(e,t,r,i,n,a,o,s,l,c,u,h,p,d,f,m){const g=[h.textOffset0,h.textOffset1],y=ke(e,r,i,g,n),_=this.collisionIndex.placeCollisionBox(Ce(t,y.x,y.y,a,o,this.transform.angle),u,s,l,c.predicate,m);if((!f||0!==this.collisionIndex.placeCollisionBox(Ce(f,y.x,y.y,a,o,this.transform.angle),u,s,l,c.predicate,m).box.length)&&_.box.length>0){let t;if(this.prevPlacement&&this.prevPlacement.variableOffsets[h.crossTileID]&&this.prevPlacement.placements[h.crossTileID]&&this.prevPlacement.placements[h.crossTileID].text&&(t=this.prevPlacement.variableOffsets[h.crossTileID].anchor),0===h.crossTileID)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[h.crossTileID]={textOffset:g,width:r,height:i,anchor:e,textBoxScale:n,prevAnchor:t},this.markUsedJustification(p,e,h,d),p.allowVerticalPlacement&&(this.markUsedOrientation(p,d,h),this.placedOrientations[h.crossTileID]=d),{shift:y,placedGlyphBoxes:_}}}placeLayerBucketPart(t,r,i){const{bucket:n,layout:a,posMatrix:o,textLabelPlaneMatrix:s,labelToScreenMatrix:l,textPixelRatio:c,holdingForFade:u,collisionBoxArray:h,partiallyEvaluatedTextSize:p,collisionGroup:d}=t.parameters,f=a.get("text-optional"),m=a.get("icon-optional"),g=e.getOverlapMode(a,"text-overlap","text-allow-overlap"),y="always"===g,_=e.getOverlapMode(a,"icon-overlap","icon-allow-overlap"),x="always"===_,v="map"===a.get("text-rotation-alignment"),b="map"===a.get("text-pitch-alignment"),w="none"!==a.get("icon-text-fit"),T="viewport-y"===a.get("symbol-z-order"),E=y&&(x||!n.hasIconData()||m),S=x&&(y||!n.hasTextData()||f);!n.collisionArrays&&h&&n.deserializeCollisionBoxes(h);const A=(t,h)=>{if(r[t.crossTileID])return;if(u)return void(this.placements[t.crossTileID]=new Ee(!1,!1,!1));let x=!1,T=!1,A=!0,I=null,k={box:null,offscreen:null},C={box:null,offscreen:null},z=null,M=null,P=null,D=0,L=0,B=0;h.textFeatureIndex?D=h.textFeatureIndex:t.useRuntimeCollisionCircles&&(D=t.featureIndex),h.verticalTextFeatureIndex&&(L=h.verticalTextFeatureIndex);const R=this.retainedQueryData[n.bucketInstanceId].tileID,F=this.terrain?(e,t)=>this.terrain.getElevation(R,e,t):null;for(const e of["textBox","verticalTextBox","iconBox","verticalIconBox"]){const t=h[e];t&&(t.elevation=F?F(t.anchorPointX,t.anchorPointY):0)}const O=h.textBox;if(O){const r=r=>{let i=e.WritingMode.horizontal;if(n.allowVerticalPlacement&&!r&&this.prevPlacement){const e=this.prevPlacement.placedOrientations[t.crossTileID];e&&(this.placedOrientations[t.crossTileID]=e,i=e,this.markUsedOrientation(n,i,t))}return i},i=(r,i)=>{if(n.allowVerticalPlacement&&t.numVerticalGlyphVertices>0&&h.verticalTextBox){for(const t of n.writingModes)if(t===e.WritingMode.vertical?(k=i(),C=k):k=r(),k&&k.box&&k.box.length)break}else k=r()};if(a.get("text-variable-anchor")){let s=a.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[t.crossTileID]){const e=this.prevPlacement.variableOffsets[t.crossTileID];s.indexOf(e.anchor)>0&&(s=s.filter((t=>t!==e.anchor)),s.unshift(e.anchor))}const l=(e,r,i)=>{const a=e.x2-e.x1,l=e.y2-e.y1,u=t.textBoxScale,h=w&&"never"===_?r:null;let p={box:[],offscreen:!1};const f="never"!==g?2*s.length:s.length;for(let r=0;r<f;++r){const f=this.attemptAnchorPlacement(s[r%s.length],e,a,l,u,v,b,c,o,d,r>=s.length?g:"never",t,n,i,h,F);if(f&&(p=f.placedGlyphBoxes,p&&p.box&&p.box.length)){x=!0,I=f.shift;break}}return p};i((()=>l(O,h.iconBox,e.WritingMode.horizontal)),(()=>{const r=h.verticalTextBox;return n.allowVerticalPlacement&&!(k&&k.box&&k.box.length)&&t.numVerticalGlyphVertices>0&&r?l(r,h.verticalIconBox,e.WritingMode.vertical):{box:null,offscreen:null}})),k&&(x=k.box,A=k.offscreen);const u=r(k&&k.box);if(!x&&this.prevPlacement){const e=this.prevPlacement.variableOffsets[t.crossTileID];e&&(this.variableOffsets[t.crossTileID]=e,this.markUsedJustification(n,e.anchor,t,u))}}else{const a=(e,r)=>{const i=this.collisionIndex.placeCollisionBox(e,g,c,o,d.predicate,F);return i&&i.box&&i.box.length&&(this.markUsedOrientation(n,r,t),this.placedOrientations[t.crossTileID]=r),i};i((()=>a(O,e.WritingMode.horizontal)),(()=>{const r=h.verticalTextBox;return n.allowVerticalPlacement&&t.numVerticalGlyphVertices>0&&r?a(r,e.WritingMode.vertical):{box:null,offscreen:null}})),r(k&&k.box&&k.box.length)}}if(z=k,x=z&&z.box&&z.box.length>0,A=z&&z.offscreen,t.useRuntimeCollisionCircles){const r=n.text.placedSymbolArray.get(t.centerJustifiedTextSymbolIndex),c=e.evaluateSizeForFeature(n.textSizeData,p,r),u=a.get("text-padding");M=this.collisionIndex.placeCollisionCircles(g,r,n.lineVertexArray,n.glyphOffsetArray,c,o,s,l,i,b,d.predicate,t.collisionCircleDiameter,u,F),M.circles.length&&M.collisionDetected&&!i&&e.warnOnce("Collisions detected, but collision boxes are not shown"),x=y||M.circles.length>0&&!M.collisionDetected,A=A&&M.offscreen}if(h.iconFeatureIndex&&(B=h.iconFeatureIndex),h.iconBox){const e=e=>{const t=w&&I?Ce(e,I.x,I.y,v,b,this.transform.angle):e;return this.collisionIndex.placeCollisionBox(t,_,c,o,d.predicate,F)};C&&C.box&&C.box.length&&h.verticalIconBox?(P=e(h.verticalIconBox),T=P.box.length>0):(P=e(h.iconBox),T=P.box.length>0),A=A&&P.offscreen}const U=f||0===t.numHorizontalGlyphVertices&&0===t.numVerticalGlyphVertices,V=m||0===t.numIconVertices;if(U||V?V?U||(T=T&&x):x=T&&x:T=x=T&&x,x&&z&&z.box&&this.collisionIndex.insertCollisionBox(z.box,g,a.get("text-ignore-placement"),n.bucketInstanceId,C&&C.box&&L?L:D,d.ID),T&&P&&this.collisionIndex.insertCollisionBox(P.box,_,a.get("icon-ignore-placement"),n.bucketInstanceId,B,d.ID),M&&(x&&this.collisionIndex.insertCollisionCircles(M.circles,g,a.get("text-ignore-placement"),n.bucketInstanceId,D,d.ID),i)){const e=n.bucketInstanceId;let t=this.collisionCircleArrays[e];void 0===t&&(t=this.collisionCircleArrays[e]=new Se);for(let e=0;e<M.circles.length;e+=4)t.circles.push(M.circles[e+0]),t.circles.push(M.circles[e+1]),t.circles.push(M.circles[e+2]),t.circles.push(M.collisionDetected?1:0)}if(0===t.crossTileID)throw new Error("symbolInstance.crossTileID can't be 0");if(0===n.bucketInstanceId)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[t.crossTileID]=new Ee(x||E,T||S,A||n.justReloaded),r[t.crossTileID]=!0};if(T){if(0!==t.symbolInstanceStart)throw new Error("bucket.bucketInstanceId should be 0");const e=n.getSortedSymbolIndexes(this.transform.angle);for(let t=e.length-1;t>=0;--t){const r=e[t];A(n.symbolInstances.get(r),n.collisionArrays[r])}}else for(let e=t.symbolInstanceStart;e<t.symbolInstanceEnd;e++)A(n.symbolInstances.get(e),n.collisionArrays[e]);if(i&&n.bucketInstanceId in this.collisionCircleArrays){const t=this.collisionCircleArrays[n.bucketInstanceId];e.invert(t.invProjMatrix,o),t.viewportMatrix=this.collisionIndex.getViewportMatrix()}n.justReloaded=!1}markUsedJustification(t,r,i,n){let a;a=n===e.WritingMode.vertical?i.verticalPlacedTextSymbolIndex:{left:i.leftJustifiedTextSymbolIndex,center:i.centerJustifiedTextSymbolIndex,right:i.rightJustifiedTextSymbolIndex}[e.getAnchorJustification(r)];const o=[i.leftJustifiedTextSymbolIndex,i.centerJustifiedTextSymbolIndex,i.rightJustifiedTextSymbolIndex,i.verticalPlacedTextSymbolIndex];for(const e of o)e>=0&&(t.text.placedSymbolArray.get(e).crossTileID=a>=0&&e!==a?0:i.crossTileID)}markUsedOrientation(t,r,i){const n=r===e.WritingMode.horizontal||r===e.WritingMode.horizontalOnly?r:0,a=r===e.WritingMode.vertical?r:0,o=[i.leftJustifiedTextSymbolIndex,i.centerJustifiedTextSymbolIndex,i.rightJustifiedTextSymbolIndex];for(const e of o)t.text.placedSymbolArray.get(e).placedOrientation=n;i.verticalPlacedTextSymbolIndex&&(t.text.placedSymbolArray.get(i.verticalPlacedTextSymbolIndex).placedOrientation=a)}commit(e){this.commitTime=e,this.zoomAtLastRecencyCheck=this.transform.zoom;const t=this.prevPlacement;let r=!1;this.prevZoomAdjustment=t?t.zoomAdjustment(this.transform.zoom):0;const i=t?t.symbolFadeChange(e):1,n=t?t.opacities:{},a=t?t.variableOffsets:{},o=t?t.placedOrientations:{};for(const e in this.placements){const t=this.placements[e],a=n[e];a?(this.opacities[e]=new Te(a,i,t.text,t.icon),r=r||t.text!==a.text.placed||t.icon!==a.icon.placed):(this.opacities[e]=new Te(null,i,t.text,t.icon,t.skipFade),r=r||t.text||t.icon)}for(const e in n){const t=n[e];if(!this.opacities[e]){const n=new Te(t,i,!1,!1);n.isHidden()||(this.opacities[e]=n,r=r||t.text.placed||t.icon.placed)}}for(const e in a)this.variableOffsets[e]||!this.opacities[e]||this.opacities[e].isHidden()||(this.variableOffsets[e]=a[e]);for(const e in o)this.placedOrientations[e]||!this.opacities[e]||this.opacities[e].isHidden()||(this.placedOrientations[e]=o[e]);if(t&&void 0===t.lastPlacementChangeTime)throw new Error("Last placement time for previous placement is not defined");r?this.lastPlacementChangeTime=e:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=t?t.lastPlacementChangeTime:e)}updateLayerOpacities(e,t){const r={};for(const i of t){const t=i.getBucket(e);t&&i.latestFeatureIndex&&e.id===t.layerIds[0]&&this.updateBucketOpacities(t,r,i.collisionBoxArray)}}updateBucketOpacities(t,r,i){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const n=t.layers[0].layout,a=new Te(null,0,!1,!1,!0),o=n.get("text-allow-overlap"),s=n.get("icon-allow-overlap"),l=n.get("text-variable-anchor"),c="map"===n.get("text-rotation-alignment"),u="map"===n.get("text-pitch-alignment"),h="none"!==n.get("icon-text-fit"),p=new Te(null,0,o&&(s||!t.hasIconData()||n.get("icon-optional")),s&&(o||!t.hasTextData()||n.get("text-optional")),!0);!t.collisionArrays&&i&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(i);const d=(e,t,r)=>{for(let i=0;i<t/4;i++)e.opacityVertexArray.emplaceBack(r)};for(let i=0;i<t.symbolInstances.length;i++){const n=t.symbolInstances.get(i),{numHorizontalGlyphVertices:o,numVerticalGlyphVertices:s,crossTileID:f}=n;let m=this.opacities[f];r[f]?m=a:m||(m=p,this.opacities[f]=m),r[f]=!0;const g=n.numIconVertices>0,y=this.placedOrientations[n.crossTileID],_=y===e.WritingMode.vertical,x=y===e.WritingMode.horizontal||y===e.WritingMode.horizontalOnly;if(o>0||s>0){const e=Ue(m.text);d(t.text,o,_?Ve:e),d(t.text,s,x?Ve:e);const r=m.text.isHidden();[n.rightJustifiedTextSymbolIndex,n.centerJustifiedTextSymbolIndex,n.leftJustifiedTextSymbolIndex].forEach((e=>{e>=0&&(t.text.placedSymbolArray.get(e).hidden=r||_?1:0)})),n.verticalPlacedTextSymbolIndex>=0&&(t.text.placedSymbolArray.get(n.verticalPlacedTextSymbolIndex).hidden=r||x?1:0);const i=this.variableOffsets[n.crossTileID];i&&this.markUsedJustification(t,i.anchor,n,y);const a=this.placedOrientations[n.crossTileID];a&&(this.markUsedJustification(t,"left",n,a),this.markUsedOrientation(t,a,n))}if(g){const e=Ue(m.icon),r=!(h&&n.verticalPlacedIconSymbolIndex&&_);n.placedIconSymbolIndex>=0&&(d(t.icon,n.numIconVertices,r?e:Ve),t.icon.placedSymbolArray.get(n.placedIconSymbolIndex).hidden=m.icon.isHidden()),n.verticalPlacedIconSymbolIndex>=0&&(d(t.icon,n.numVerticalIconVertices,r?Ve:e),t.icon.placedSymbolArray.get(n.verticalPlacedIconSymbolIndex).hidden=m.icon.isHidden())}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const r=t.collisionArrays[i];if(r){let i=new e.pointGeometry(0,0);if(r.textBox||r.verticalTextBox){let e=!0;if(l){const t=this.variableOffsets[f];t?(i=ke(t.anchor,t.width,t.height,t.textOffset,t.textBoxScale),c&&i._rotate(u?this.transform.angle:-this.transform.angle)):e=!1}r.textBox&&Me(t.textCollisionBox.collisionVertexArray,m.text.placed,!e||_,i.x,i.y),r.verticalTextBox&&Me(t.textCollisionBox.collisionVertexArray,m.text.placed,!e||x,i.x,i.y)}const n=Boolean(!x&&r.verticalIconBox);r.iconBox&&Me(t.iconCollisionBox.collisionVertexArray,m.icon.placed,n,h?i.x:0,h?i.y:0),r.verticalIconBox&&Me(t.iconCollisionBox.collisionVertexArray,m.icon.placed,!n,h?i.x:0,h?i.y:0)}}}if(t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.text.opacityVertexArray.length!==t.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${t.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${t.text.layoutVertexArray.length}) / 4`);if(t.icon.opacityVertexArray.length!==t.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${t.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${t.icon.layoutVertexArray.length}) / 4`);if(t.bucketInstanceId in this.collisionCircleArrays){const e=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=e.invProjMatrix,t.placementViewportMatrix=e.viewportMatrix,t.collisionCircleArray=e.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(e){return 0===this.fadeDuration?1:(e-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(e){return Math.max(0,(this.transform.zoom-e)/1.5)}hasTransitions(e){return this.stale||e-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(e,t){const r=this.zoomAtLastRecencyCheck===t?1-this.zoomAdjustment(t):1;return this.zoomAtLastRecencyCheck=t,this.commitTime+this.fadeDuration*r>e}setStale(){this.stale=!0}}function Me(e,t,r,i,n){e.emplaceBack(t?1:0,r?1:0,i||0,n||0),e.emplaceBack(t?1:0,r?1:0,i||0,n||0),e.emplaceBack(t?1:0,r?1:0,i||0,n||0),e.emplaceBack(t?1:0,r?1:0,i||0,n||0)}const Pe=Math.pow(2,25),De=Math.pow(2,24),Le=Math.pow(2,17),Be=Math.pow(2,16),Re=Math.pow(2,9),Fe=Math.pow(2,8),Oe=Math.pow(2,1);function Ue(e){if(0===e.opacity&&!e.placed)return 0;if(1===e.opacity&&e.placed)return 4294967295;const t=e.placed?1:0,r=Math.floor(127*e.opacity);return r*Pe+t*De+r*Le+t*Be+r*Re+t*Fe+r*Oe+t}const Ve=0;class $e{constructor(e){this._sortAcrossTiles="viewport-y"!==e.layout.get("symbol-z-order")&&!e.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(e,t,r,i,n){const a=this._bucketParts;for(;this._currentTileIndex<e.length;)if(t.getBucketParts(a,i,e[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,n())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,a.sort(((e,t)=>e.sortKey-t.sortKey)));this._currentPartIndex<a.length;)if(t.placeLayerBucketPart(a[this._currentPartIndex],this._seenCrossTileIDs,r),this._currentPartIndex++,n())return!0;return!1}}class Ne{constructor(e,t,r,i,n,a,o,s){this.placement=new ze(e,t,a,o,s),this._currentPlacementIndex=r.length-1,this._forceFullPlacement=i,this._showCollisionBoxes=n,this._done=!1}isDone(){return this._done}continuePlacement(t,r,i){const n=e.exported.now(),a=()=>{const t=e.exported.now()-n;return!this._forceFullPlacement&&t>2};for(;this._currentPlacementIndex>=0;){const e=r[t[this._currentPlacementIndex]],n=this.placement.collisionIndex.transform.zoom;if("symbol"===e.type&&(!e.minzoom||e.minzoom<=n)&&(!e.maxzoom||e.maxzoom>n)){if(this._inProgressLayer||(this._inProgressLayer=new $e(e)),this._inProgressLayer.continuePlacement(i[e.source],this.placement,this._showCollisionBoxes,e,a))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(e){return this.placement.commit(e),this.placement}}const je=512/e.EXTENT/2;class qe{constructor(e,t,r){this.tileID=e,this.indexedSymbolInstances={},this.bucketInstanceId=r;for(let r=0;r<t.length;r++){const i=t.get(r),n=i.key;this.indexedSymbolInstances[n]||(this.indexedSymbolInstances[n]=[]),this.indexedSymbolInstances[n].push({crossTileID:i.crossTileID,coord:this.getScaledCoordinates(i,e)})}}getScaledCoordinates(t,r){const i=je/Math.pow(2,r.canonical.z-this.tileID.canonical.z);return{x:Math.floor((r.canonical.x*e.EXTENT+t.anchorX)*i),y:Math.floor((r.canonical.y*e.EXTENT+t.anchorY)*i)}}findMatches(e,t,r){const i=this.tileID.canonical.z<t.canonical.z?1:Math.pow(2,this.tileID.canonical.z-t.canonical.z);for(let n=0;n<e.length;n++){const a=e.get(n);if(a.crossTileID)continue;const o=this.indexedSymbolInstances[a.key];if(!o)continue;const s=this.getScaledCoordinates(a,t);for(const e of o)if(Math.abs(e.coord.x-s.x)<=i&&Math.abs(e.coord.y-s.y)<=i&&!r[e.crossTileID]){r[e.crossTileID]=!0,a.crossTileID=e.crossTileID;break}}}}class Ge{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Ze{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(e){const t=Math.round((e-this.lng)/360);if(0!==t)for(const e in this.indexes){const r=this.indexes[e],i={};for(const e in r){const n=r[e];n.tileID=n.tileID.unwrapTo(n.tileID.wrap+t),i[n.tileID.key]=n}this.indexes[e]=i}this.lng=e}addBucket(e,t,r){if(this.indexes[e.overscaledZ]&&this.indexes[e.overscaledZ][e.key]){if(this.indexes[e.overscaledZ][e.key].bucketInstanceId===t.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(e.overscaledZ,this.indexes[e.overscaledZ][e.key])}for(let e=0;e<t.symbolInstances.length;e++)t.symbolInstances.get(e).crossTileID=0;this.usedCrossTileIDs[e.overscaledZ]||(this.usedCrossTileIDs[e.overscaledZ]={});const i=this.usedCrossTileIDs[e.overscaledZ];for(const r in this.indexes){const n=this.indexes[r];if(Number(r)>e.overscaledZ)for(const r in n){const a=n[r];a.tileID.isChildOf(e)&&a.findMatches(t.symbolInstances,e,i)}else{const a=n[e.scaledTo(Number(r)).key];a&&a.findMatches(t.symbolInstances,e,i)}}for(let e=0;e<t.symbolInstances.length;e++){const n=t.symbolInstances.get(e);n.crossTileID||(n.crossTileID=r.generate(),i[n.crossTileID]=!0)}return void 0===this.indexes[e.overscaledZ]&&(this.indexes[e.overscaledZ]={}),this.indexes[e.overscaledZ][e.key]=new qe(e,t.symbolInstances,t.bucketInstanceId),!0}removeBucketCrossTileIDs(e,t){for(const r in t.indexedSymbolInstances)for(const i of t.indexedSymbolInstances[r])delete this.usedCrossTileIDs[e][i.crossTileID]}removeStaleBuckets(e){let t=!1;for(const r in this.indexes){const i=this.indexes[r];for(const n in i)e[i[n].bucketInstanceId]||(this.removeBucketCrossTileIDs(r,i[n]),delete i[n],t=!0)}return t}}class Xe{constructor(){this.layerIndexes={},this.crossTileIDs=new Ge,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(e,t,r){let i=this.layerIndexes[e.id];void 0===i&&(i=this.layerIndexes[e.id]=new Ze);let n=!1;const a={};i.handleWrapJump(r);for(const r of t){const t=r.getBucket(e);t&&e.id===t.layerIds[0]&&(t.bucketInstanceId||(t.bucketInstanceId=++this.maxBucketInstanceId),i.addBucket(r.tileID,t,this.crossTileIDs)&&(n=!0),a[t.bucketInstanceId]=!0)}return i.removeStaleBuckets(a)&&(n=!0),n}pruneUnusedLayers(e){const t={};e.forEach((e=>{t[e]=!0}));for(const e in this.layerIndexes)t[e]||delete this.layerIndexes[e]}}var We=e.createLayout([{name:"a_pos",type:"Int16",components:2}]);class He extends e.Evented{constructor(e){super(),this.sourceCache=e,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.renderHistory=[],this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.deltaZoom=1,this.renderHistorySize=e._cache.max,e.usedForTerrain=!0,e.tileSize=this.tileSize*2**this.deltaZoom}destruct(){this.sourceCache.usedForTerrain=!1,this.sourceCache.tileSize=null;for(const e in this._tiles){const t=this._tiles[e];t.textures.forEach((e=>e.destroy())),t.textures=[]}}update(t,r){this.sourceCache.update(t,r),this._renderableTilesKeys=[];for(const i of t.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:r}))this._renderableTilesKeys.push(i.key),this._tiles[i.key]||(i.posMatrix=new Float64Array(16),e.ortho(i.posMatrix,0,e.EXTENT,0,e.EXTENT,0,1),this._tiles[i.key]=new B(i,this.tileSize))}removeOutdated(e){const t={};this.renderHistory=this.renderHistory.filter(((e,t)=>this.renderHistory.indexOf(e)===t)).slice(0,this.renderHistorySize);for(const e of this._renderableTilesKeys)t[e]=!0;for(const e of this.renderHistory)t[e]=!0;for(const r in this._tiles)t[r]||(this._tiles[r].clearTextures(e),delete this._tiles[r])}getRenderableTiles(){return this._renderableTilesKeys.map((e=>this.getTileByID(e)))}getTileByID(e){return this._tiles[e]}getTerrainCoords(t){const r={};for(const i of this._renderableTilesKeys){const n=this._tiles[i].tileID;if(n.canonical.equals(t.canonical)){const n=t.clone();n.posMatrix=new Float64Array(16),e.ortho(n.posMatrix,0,e.EXTENT,0,e.EXTENT,0,1),r[i]=n}else if(n.canonical.isChildOf(t.canonical)){const a=t.clone();a.posMatrix=new Float64Array(16);const o=n.canonical.z-t.canonical.z,s=n.canonical.x-(n.canonical.x>>o<<o),l=n.canonical.y-(n.canonical.y>>o<<o),c=e.EXTENT>>o;e.ortho(a.posMatrix,0,c,0,c,0,1),e.translate(a.posMatrix,a.posMatrix,[-s*c,-l*c,0]),r[i]=a}else if(t.canonical.isChildOf(n.canonical)){const a=t.clone();a.posMatrix=new Float64Array(16);const o=t.canonical.z-n.canonical.z,s=t.canonical.x-(t.canonical.x>>o<<o),l=t.canonical.y-(t.canonical.y>>o<<o),c=e.EXTENT>>o;e.ortho(a.posMatrix,0,e.EXTENT,0,e.EXTENT,0,1),e.translate(a.posMatrix,a.posMatrix,[s*c,l*c,0]),e.scale(a.posMatrix,a.posMatrix,[1/2**o,1/2**o,0]),r[i]=a}}return r}getSourceTile(e,t){const r=this.sourceCache._source;let i=e.overscaledZ-this.deltaZoom;if(i>r.maxzoom&&(i=r.maxzoom),i<r.minzoom)return null;this._sourceTileCache[e.key]||(this._sourceTileCache[e.key]=e.scaledTo(i).key);let n=this.sourceCache.getTileByID(this._sourceTileCache[e.key]);if((!n||!n.dem)&&t)for(;i>=r.minzoom&&(!n||!n.dem);)n=this.sourceCache.getTileByID(e.scaledTo(i--).key);return n}tilesAfterTime(e=Date.now()){return Object.values(this._tiles).filter((t=>t.timeLoaded>=e))}}class Ke{constructor(e,t,r){this.style=e,this.sourceCache=new He(t),this.options=r,this.exaggeration="number"==typeof r.exaggeration?r.exaggeration:1,this.elevationOffset="number"==typeof r.elevationOffset?r.elevationOffset:450,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024,this.clearRerenderCache()}getDEMElevation(t,r,i,n=e.EXTENT){if(!(r>=0&&r<n&&i>=0&&i<n))return this.elevationOffset;let a=0;const o=this.getTerrainData(t);if(o.tile&&o.tile.dem){const t=e.transformMat4$1([],[r/n*e.EXTENT,i/n*e.EXTENT],o.u_terrain_matrix),s=[t[0]*o.tile.dem.dim,t[1]*o.tile.dem.dim],l=[Math.floor(s[0]),Math.floor(s[1])],c=o.tile.dem.get(l[0],l[1]),u=o.tile.dem.get(l[0],l[1]+1),h=o.tile.dem.get(l[0]+1,l[1]),p=o.tile.dem.get(l[0]+1,l[1]+1);a=e.number(e.number(c,u,s[0]-l[0]),e.number(h,p,s[0]-l[0]),s[1]-l[1])}return a}rememberForRerender(e,t){for(const r in this.sourceCache._tiles){const i=this.sourceCache._tiles[r];(i.tileID.equals(t)||i.tileID.isChildOf(t))&&(e===this.sourceCache.sourceCache.id&&(i.timeLoaded=Date.now()),this._rerender[e]=this._rerender[e]||{},this._rerender[e][i.tileID.key]=!0)}}needsRerender(e,t){return this._rerender[e]&&this._rerender[e][t.key]}clearRerenderCache(){this._rerender={}}getElevation(t,r,i,n=e.EXTENT){return(this.getDEMElevation(t,r,i,n)+this.elevationOffset)*this.exaggeration}getTerrainData(t){if(!this._emptyDemTexture){const t=this.style.map.painter.context,r=new e.RGBAImage({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new l(t,r,t.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new l(t,new e.RGBAImage({width:1,height:1}),t.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(t.gl.NEAREST,t.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=e.identity([])}const r=this.sourceCache.getSourceTile(t,!0);if(r&&r.dem&&(!r.demTexture||r.needsTerrainPrepare)){const e=this.style.map.painter.context;r.demTexture=this.style.map.painter.getTileTexture(r.dem.stride),r.demTexture?r.demTexture.update(r.dem.getPixels(),{premultiply:!1}):r.demTexture=new l(e,r.dem.getPixels(),e.gl.RGBA,{premultiply:!1}),r.demTexture.bind(e.gl.NEAREST,e.gl.CLAMP_TO_EDGE),r.needsTerrainPrepare=!1}const i=r&&r+r.tileID.key+t.key;if(i&&!this._demMatrixCache[i]){const i=this.sourceCache.sourceCache._source.maxzoom;let n=t.canonical.z-r.tileID.canonical.z;t.overscaledZ>t.canonical.z&&(t.canonical.z>=i?n=t.canonical.z-i:e.warnOnce("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const a=t.canonical.x-(t.canonical.x>>n<<n),o=t.canonical.y-(t.canonical.y>>n<<n),s=e.fromScaling(new Float64Array(16),[1/(e.EXTENT<<n),1/(e.EXTENT<<n),0]);e.translate(s,s,[a*e.EXTENT,o*e.EXTENT,0]),this._demMatrixCache[t.key]={matrix:s,coord:t}}return{u_depth:2,u_terrain:3,u_terrain_dim:r&&r.dem&&r.dem.dim||1,u_terrain_matrix:i?this._demMatrixCache[t.key].matrix:this._emptyDemMatrix,u_terrain_unpack:r&&r.dem&&r.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_offset:this.elevationOffset,u_terrain_exaggeration:this.exaggeration,texture:(r&&r.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:r}}getRTTFramebuffer(){const e=this.style.map.painter;if(!this._rttFramebuffer){const t=this.sourceCache.tileSize*this.qualityFactor;this._rttFramebuffer=e.context.createFramebuffer(t,t,!0),this._rttFramebuffer.depthAttachment.set(e.context.createRenderbuffer(e.context.gl.DEPTH_COMPONENT16,t,t))}return this._rttFramebuffer}getFramebuffer(e){const t=this.style.map.painter,r=t.width/devicePixelRatio,i=t.height/devicePixelRatio;return!this._fbo||this._fbo.width===r&&this._fbo.height===i||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new l(t.context,{width:r,height:i,data:null},t.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(t.context.gl.NEAREST,t.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new l(t.context,{width:r,height:i,data:null},t.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(t.context.gl.NEAREST,t.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=t.context.createFramebuffer(r,i,!0),this._fbo.depthAttachment.set(t.context.createRenderbuffer(t.context.gl.DEPTH_COMPONENT16,r,i))),this._fbo.colorAttachment.set("coords"===e?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const t=this.style.map.painter.context;if(this._coordsTexture)return this._coordsTexture;const r=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let e=0,t=0;e<this._coordsTextureSize;e++)for(let i=0;i<this._coordsTextureSize;i++,t+=4)r[t+0]=255&i,r[t+1]=255&e,r[t+2]=i>>8<<4|e>>8,r[t+3]=0;const i=new e.RGBAImage({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(r.buffer)),n=new l(t,i,t.gl.RGBA,{premultiply:!1});return n.bind(t.gl.NEAREST,t.gl.CLAMP_TO_EDGE),this._coordsTexture=n,n}pointCoordinate(t){const r=new Uint8Array(4),i=this.style.map.painter,n=i.context,a=n.gl;n.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),a.readPixels(t.x,i.height/devicePixelRatio-t.y-1,1,1,a.RGBA,a.UNSIGNED_BYTE,r),n.bindFramebuffer.set(null);const o=r[0]+(r[2]>>4<<8),s=r[1]+((15&r[2])<<8),l=this.coordsIndex[255-r[3]],c=l&&this.sourceCache.getTileByID(l);if(!c)return null;const u=this._coordsTextureSize,h=(1<<c.tileID.canonical.z)*u;return new e.MercatorCoordinate((c.tileID.canonical.x*u+o)/h,(c.tileID.canonical.y*u+s)/h,this.getElevation(c.tileID,o,s,u))}getTerrainMesh(){if(this._mesh)return this._mesh;const t=this.style.map.painter.context,r=new e.PosArray,i=new e.TriangleIndexArray,n=this.meshSize,a=e.EXTENT/n,o=n*n;for(let e=0;e<=n;e++)for(let t=0;t<=n;t++)r.emplaceBack(t*a,e*a);for(let e=0;e<o;e+=n+1)for(let t=0;t<n;t++)i.emplaceBack(t+e,n+t+e+1,n+t+e+2),i.emplaceBack(t+e,n+t+e+2,t+e+1);return this._mesh={indexBuffer:t.createIndexBuffer(i),vertexBuffer:t.createVertexBuffer(r,We.members),segments:e.SegmentVector.simpleSegment(0,0,r.length,i.length)},this._mesh}getMinMaxElevation(e){const t=this.getTerrainData(e).tile,r={minElevation:null,maxElevation:null};return t&&t.dem&&(r.minElevation=(t.dem.min+this.elevationOffset)*this.exaggeration,r.maxElevation=(t.dem.max+this.elevationOffset)*this.exaggeration),r}}const Ye=(t,r)=>e.emitValidationErrors(t,r&&r.filter((e=>"source.canvas"!==e.identifier))),Je=e.pick(W,["addLayer","removeLayer","setPaintProperty","setLayoutProperty","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData"]),Qe=e.pick(W,["setCenter","setZoom","setBearing","setPitch"]),et=function(){const t={},r=e.spec.$version;for(const i in e.spec.$root){const n=e.spec.$root[i];if(n.required){let e=null;e="version"===i?r:"array"===n.type?[]:{},null!=e&&(t[i]=e)}}return t}();class tt extends e.Evented{constructor(t,r={}){super(),this.map=t,this.dispatcher=new x(G(),this),this.imageManager=new u,this.imageManager.setEventedParent(this),this.glyphManager=new f(t._requestManager,r.localIdeographFontFamily),this.lineAtlas=new _(256,512),this.crossTileSymbolIndex=new Xe,this._layers={},this._serializedLayers={},this._order=[],this.sourceCaches={},this.zoomHistory=new e.ZoomHistory,this._loaded=!1,this._availableImages=[],this._resetUpdates(),this.dispatcher.broadcast("setReferrer",e.getReferrer());const i=this;this._rtlTextPluginCallback=tt.registerForPluginStateChange((t=>{i.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:t.pluginStatus,pluginURL:t.pluginURL},((t,r)=>{if(e.triggerPluginCompletionEvent(t),r&&r.every((e=>e)))for(const e in i.sourceCaches)i.sourceCaches[e].reload()}))})),this.on("data",(e=>{if("source"!==e.dataType||"metadata"!==e.sourceDataType)return;const t=this.sourceCaches[e.sourceId];if(!t)return;const r=t.getSource();if(r&&r.vectorLayerIds)for(const e in this._layers){const t=this._layers[e];t.source===r.id&&this._validateLayer(t)}}))}loadURL(t,r={}){this.fire(new e.Event("dataloading",{dataType:"style"}));const i="boolean"!=typeof r.validate||r.validate,n=this.map._requestManager.transformRequest(t,e.ResourceType.Style);this._request=e.getJSON(n,((t,r)=>{this._request=null,t?this.fire(new e.ErrorEvent(t)):r&&this._load(r,i)}))}loadJSON(t,r={}){this.fire(new e.Event("dataloading",{dataType:"style"})),this._request=e.exported.frame((()=>{this._request=null,this._load(t,!1!==r.validate)}))}loadEmpty(){this.fire(new e.Event("dataloading",{dataType:"style"})),this._load(et,!1)}_load(t,r){if(r&&Ye(this,e.validateStyle(t)))return;this._loaded=!0,this.stylesheet=t;for(const e in t.sources)this.addSource(e,t.sources[e],{validate:!1});t.sprite?this._loadSprite(t.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(t.glyphs);const i=X(this.stylesheet.layers);this._order=i.map((e=>e.id)),this._layers={},this._serializedLayers={};for(let t of i)t=e.createStyleLayer(t),t.setEventedParent(this,{layer:{id:t.id}}),this._layers[t.id]=t,this._serializedLayers[t.id]=t.serialize();this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order)),this.light=new y(this.stylesheet.light),this.setTerrain(this.stylesheet.terrain),this.fire(new e.Event("data",{dataType:"style"})),this.fire(new e.Event("style.load"))}_loadSprite(t){this._spriteRequest=function(t,r,i,n){let a,o,s;const l=i>1?"@2x":"";let c=e.getJSON(r.transformRequest(r.normalizeSpriteURL(t,l,".json"),e.ResourceType.SpriteJSON),((e,t)=>{c=null,s||(s=e,a=t,h())})),u=e.getImage(r.transformRequest(r.normalizeSpriteURL(t,l,".png"),e.ResourceType.SpriteImage),((e,t)=>{u=null,s||(s=e,o=t,h())}));function h(){if(s)n(s);else if(a&&o){const t=e.exported.getImageData(o),r={};for(const i in a){const{width:n,height:o,x:s,y:l,sdf:c,pixelRatio:u,stretchX:h,stretchY:p,content:d}=a[i],f=new e.RGBAImage({width:n,height:o});e.RGBAImage.copy(t,f,{x:s,y:l},{x:0,y:0},{width:n,height:o}),r[i]={data:f,pixelRatio:u,sdf:c,stretchX:h,stretchY:p,content:d}}n(null,r)}}return{cancel(){c&&(c.cancel(),c=null),u&&(u.cancel(),u=null)}}}(t,this.map._requestManager,this.map.getPixelRatio(),((t,r)=>{if(this._spriteRequest=null,t)this.fire(new e.ErrorEvent(t));else if(r)for(const e in r)this.imageManager.addImage(e,r[e]);this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new e.Event("data",{dataType:"style"}))}))}_validateLayer(t){const r=this.sourceCaches[t.source];if(!r)return;const i=t.sourceLayer;if(!i)return;const n=r.getSource();("geojson"===n.type||n.vectorLayerIds&&-1===n.vectorLayerIds.indexOf(i))&&this.fire(new e.ErrorEvent(new Error(`Source layer "${i}" does not exist on source "${n.id}" as specified by style layer "${t.id}".`)))}loaded(){if(!this._loaded)return!1;if(Object.keys(this._updatedSources).length)return!1;for(const e in this.sourceCaches)if(!this.sourceCaches[e].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeLayers(e){const t=[];for(const r of e){const e=this._layers[r];"custom"!==e.type&&t.push(e.serialize())}return t}hasTransitions(){if(this.light&&this.light.hasTransition())return!0;for(const e in this.sourceCaches)if(this.sourceCaches[e].hasTransition())return!0;for(const e in this._layers)if(this._layers[e].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(t){if(!this._loaded)return;const r=this._changed;if(this._changed){const e=Object.keys(this._updatedLayers),r=Object.keys(this._removedLayers);(e.length||r.length)&&this._updateWorkerLayers(e,r);for(const e in this._updatedSources){const t=this._updatedSources[e];if("reload"===t)this._reloadSource(e);else{if("clear"!==t)throw new Error(`Invalid action ${t}`);this._clearSource(e)}}this._updateTilesForChangedImages();for(const e in this._updatedPaintProps)this._layers[e].updateTransitions(t);this.light.updateTransitions(t),this._resetUpdates()}const i={};for(const e in this.sourceCaches){const t=this.sourceCaches[e];i[e]=t.used,t.used=!1}for(const e of this._order){const r=this._layers[e];r.recalculate(t,this._availableImages),!r.isHidden(t.zoom)&&r.source&&(this.sourceCaches[r.source].used=!0)}for(const t in i){const r=this.sourceCaches[t];i[t]!==r.used&&r.fire(new e.Event("data",{sourceDataType:"visibility",dataType:"source",sourceId:t}))}this.light.recalculate(t),this.z=t.zoom,r&&this.fire(new e.Event("data",{dataType:"style"}))}_updateTilesForChangedImages(){const e=Object.keys(this._changedImages);if(e.length){for(const t in this.sourceCaches)this.sourceCaches[t].reloadTilesForDependencies(["icons","patterns"],e);this._changedImages={}}}_updateWorkerLayers(e,t){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(e),removedIds:t})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={}}setTerrain(t){if(this._checkLoaded(),this._terrainDataCallback&&this.off("data",this._terrainDataCallback),this._terrainfreezeElevationCallback&&this.map.off("freezeElevation",this._terrainfreezeElevationCallback),t){const e=this.sourceCaches[t.source];if(!e)throw new Error(`cannot load terrain, because there exists no source with ID: ${t.source}`);this.terrain=new Ke(this,e,t),this.map.transform.updateElevation(this.terrain),this._terrainfreezeElevationCallback=e=>{e.freeze?this.map.transform.freezeElevation=!0:(this.map.transform.freezeElevation=!1,this.map.transform.recalculateZoom(this.terrain))},this._terrainDataCallback=e=>{e.tile&&(e.sourceId===t.source?(this.map.transform.updateElevation(this.terrain),this.terrain.rememberForRerender(e.sourceId,e.tile.tileID)):"geojson"===e.source.type&&this.terrain.rememberForRerender(e.sourceId,e.tile.tileID))},this.on("data",this._terrainDataCallback),this.map.on("freezeElevation",this._terrainfreezeElevationCallback)}else this.terrain&&this.terrain.sourceCache.destruct(),this.terrain=null,this.map.transform.updateElevation(this.terrain);this.map.fire(new e.Event("terrain",{terrain:t}))}setState(t){if(this._checkLoaded(),Ye(this,e.validateStyle(t)))return!1;(t=e.clone$1(t)).layers=X(t.layers);const r=function(e,t){if(!e)return[{command:W.setStyle,args:[t]}];let r=[];try{if(!n(e.version,t.version))return[{command:W.setStyle,args:[t]}];n(e.center,t.center)||r.push({command:W.setCenter,args:[t.center]}),n(e.zoom,t.zoom)||r.push({command:W.setZoom,args:[t.zoom]}),n(e.bearing,t.bearing)||r.push({command:W.setBearing,args:[t.bearing]}),n(e.pitch,t.pitch)||r.push({command:W.setPitch,args:[t.pitch]}),n(e.sprite,t.sprite)||r.push({command:W.setSprite,args:[t.sprite]}),n(e.glyphs,t.glyphs)||r.push({command:W.setGlyphs,args:[t.glyphs]}),n(e.transition,t.transition)||r.push({command:W.setTransition,args:[t.transition]}),n(e.light,t.light)||r.push({command:W.setLight,args:[t.light]});const i={},a=[];!function(e,t,r,i){let a;for(a in t=t||{},e=e||{})Object.prototype.hasOwnProperty.call(e,a)&&(Object.prototype.hasOwnProperty.call(t,a)||K(a,r,i));for(a in t)Object.prototype.hasOwnProperty.call(t,a)&&(Object.prototype.hasOwnProperty.call(e,a)?n(e[a],t[a])||("geojson"===e[a].type&&"geojson"===t[a].type&&J(e,t,a)?r.push({command:W.setGeoJSONSourceData,args:[a,t[a].data]}):Y(a,t,r,i)):H(a,t,r))}(e.sources,t.sources,a,i);const o=[];e.layers&&e.layers.forEach((e=>{i[e.source]?r.push({command:W.removeLayer,args:[e.id]}):o.push(e)})),r=r.concat(a),function(e,t,r){t=t||[];const i=(e=e||[]).map(ee),a=t.map(ee),o=e.reduce(te,{}),s=t.reduce(te,{}),l=i.slice(),c=Object.create(null);let u,h,p,d,f,m,g;for(u=0,h=0;u<i.length;u++)p=i[u],Object.prototype.hasOwnProperty.call(s,p)?h++:(r.push({command:W.removeLayer,args:[p]}),l.splice(l.indexOf(p,h),1));for(u=0,h=0;u<a.length;u++)p=a[a.length-1-u],l[l.length-1-u]!==p&&(Object.prototype.hasOwnProperty.call(o,p)?(r.push({command:W.removeLayer,args:[p]}),l.splice(l.lastIndexOf(p,l.length-h),1)):h++,m=l[l.length-u],r.push({command:W.addLayer,args:[s[p],m]}),l.splice(l.length-u,0,p),c[p]=!0);for(u=0;u<a.length;u++)if(p=a[u],d=o[p],f=s[p],!c[p]&&!n(d,f))if(n(d.source,f.source)&&n(d["source-layer"],f["source-layer"])&&n(d.type,f.type)){for(g in Q(d.layout,f.layout,r,p,null,W.setLayoutProperty),Q(d.paint,f.paint,r,p,null,W.setPaintProperty),n(d.filter,f.filter)||r.push({command:W.setFilter,args:[p,f.filter]}),n(d.minzoom,f.minzoom)&&n(d.maxzoom,f.maxzoom)||r.push({command:W.setLayerZoomRange,args:[p,f.minzoom,f.maxzoom]}),d)Object.prototype.hasOwnProperty.call(d,g)&&"layout"!==g&&"paint"!==g&&"filter"!==g&&"metadata"!==g&&"minzoom"!==g&&"maxzoom"!==g&&(0===g.indexOf("paint.")?Q(d[g],f[g],r,p,g.slice(6),W.setPaintProperty):n(d[g],f[g])||r.push({command:W.setLayerProperty,args:[p,g,f[g]]}));for(g in f)Object.prototype.hasOwnProperty.call(f,g)&&!Object.prototype.hasOwnProperty.call(d,g)&&"layout"!==g&&"paint"!==g&&"filter"!==g&&"metadata"!==g&&"minzoom"!==g&&"maxzoom"!==g&&(0===g.indexOf("paint.")?Q(d[g],f[g],r,p,g.slice(6),W.setPaintProperty):n(d[g],f[g])||r.push({command:W.setLayerProperty,args:[p,g,f[g]]}))}else r.push({command:W.removeLayer,args:[p]}),m=l[l.lastIndexOf(p)+1],r.push({command:W.addLayer,args:[f,m]})}(o,t.layers,r)}catch(e){console.warn("Unable to compute style diff:",e),r=[{command:W.setStyle,args:[t]}]}return r}(this.serialize(),t).filter((e=>!(e.command in Qe)));if(0===r.length)return!1;const i=r.filter((e=>!(e.command in Je)));if(i.length>0)throw new Error(`Unimplemented: ${i.map((e=>e.command)).join(", ")}.`);return r.forEach((e=>{"setTransition"!==e.command&&this[e.command].apply(this,e.args)})),this.stylesheet=t,!0}addImage(t,r){if(this.getImage(t))return this.fire(new e.ErrorEvent(new Error(`An image named "${t}" already exists.`)));this.imageManager.addImage(t,r),this._afterImageUpdated(t)}updateImage(e,t){this.imageManager.updateImage(e,t)}getImage(e){return this.imageManager.getImage(e)}removeImage(t){if(!this.getImage(t))return this.fire(new e.ErrorEvent(new Error(`An image named "${t}" does not exist.`)));this.imageManager.removeImage(t),this._afterImageUpdated(t)}_afterImageUpdated(t){this._availableImages=this.imageManager.listImages(),this._changedImages[t]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new e.Event("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(t,r,i={}){if(this._checkLoaded(),void 0!==this.sourceCaches[t])throw new Error(`Source "${t}" already exists.`);if(!r.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(r).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(r.type)>=0&&this._validate(e.validateStyle.source,`sources.${t}`,r,null,i))return;this.map&&this.map._collectResourceTiming&&(r.collectResourceTiming=!0);const n=this.sourceCaches[t]=new O(t,r,this.dispatcher);n.style=this,n.setEventedParent(this,(()=>({isSourceLoaded:this.loaded(),source:n.serialize(),sourceId:t}))),n.onAdd(this.map),this._changed=!0}removeSource(t){if(this._checkLoaded(),void 0===this.sourceCaches[t])throw new Error("There is no source with this ID");for(const r in this._layers)if(this._layers[r].source===t)return this.fire(new e.ErrorEvent(new Error(`Source "${t}" cannot be removed while layer "${r}" is using it.`)));const r=this.sourceCaches[t];delete this.sourceCaches[t],delete this._updatedSources[t],r.fire(new e.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:t})),r.setEventedParent(null),r.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(e,t){if(this._checkLoaded(),void 0===this.sourceCaches[e])throw new Error(`There is no source with this ID=${e}`);const r=this.sourceCaches[e].getSource();if("geojson"!==r.type)throw new Error(`geojsonSource.type is ${r.type}, which is !== 'geojson`);r.setData(t),this._changed=!0}getSource(e){return this.sourceCaches[e]&&this.sourceCaches[e].getSource()}addLayer(t,r,i={}){this._checkLoaded();const n=t.id;if(this.getLayer(n))return void this.fire(new e.ErrorEvent(new Error(`Layer "${n}" already exists on this map.`)));let a;if("custom"===t.type){if(Ye(this,e.validateCustomStyleLayer(t)))return;a=e.createStyleLayer(t)}else{if("object"==typeof t.source&&(this.addSource(n,t.source),t=e.clone$1(t),t=e.extend(t,{source:n})),this._validate(e.validateStyle.layer,`layers.${n}`,t,{arrayIndex:-1},i))return;a=e.createStyleLayer(t),this._validateLayer(a),a.setEventedParent(this,{layer:{id:n}}),this._serializedLayers[a.id]=a.serialize()}const o=r?this._order.indexOf(r):this._order.length;if(r&&-1===o)this.fire(new e.ErrorEvent(new Error(`Cannot add layer "${n}" before non-existing layer "${r}".`)));else{if(this._order.splice(o,0,n),this._layerOrderChanged=!0,this._layers[n]=a,this._removedLayers[n]&&a.source&&"custom"!==a.type){const e=this._removedLayers[n];delete this._removedLayers[n],e.type!==a.type?this._updatedSources[a.source]="clear":(this._updatedSources[a.source]="reload",this.sourceCaches[a.source].pause())}this._updateLayer(a),a.onAdd&&a.onAdd(this.map)}}moveLayer(t,r){if(this._checkLoaded(),this._changed=!0,!this._layers[t])return void this.fire(new e.ErrorEvent(new Error(`The layer '${t}' does not exist in the map's style and cannot be moved.`)));if(t===r)return;const i=this._order.indexOf(t);this._order.splice(i,1);const n=r?this._order.indexOf(r):this._order.length;r&&-1===n?this.fire(new e.ErrorEvent(new Error(`Cannot move layer "${t}" before non-existing layer "${r}".`))):(this._order.splice(n,0,t),this._layerOrderChanged=!0)}removeLayer(t){this._checkLoaded();const r=this._layers[t];if(!r)return void this.fire(new e.ErrorEvent(new Error(`Cannot remove non-existing layer "${t}".`)));r.setEventedParent(null);const i=this._order.indexOf(t);this._order.splice(i,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[t]=r,delete this._layers[t],delete this._serializedLayers[t],delete this._updatedLayers[t],delete this._updatedPaintProps[t],r.onRemove&&r.onRemove(this.map)}getLayer(e){return this._layers[e]}hasLayer(e){return e in this._layers}setLayerZoomRange(t,r,i){this._checkLoaded();const n=this.getLayer(t);n?n.minzoom===r&&n.maxzoom===i||(null!=r&&(n.minzoom=r),null!=i&&(n.maxzoom=i),this._updateLayer(n)):this.fire(new e.ErrorEvent(new Error(`Cannot set the zoom range of non-existing layer "${t}".`)))}setFilter(t,r,i={}){this._checkLoaded();const a=this.getLayer(t);if(a){if(!n(a.filter,r))return null==r?(a.filter=void 0,void this._updateLayer(a)):void(this._validate(e.validateStyle.filter,`layers.${a.id}.filter`,r,null,i)||(a.filter=e.clone$1(r),this._updateLayer(a)))}else this.fire(new e.ErrorEvent(new Error(`Cannot filter non-existing layer "${t}".`)))}getFilter(t){return e.clone$1(this.getLayer(t).filter)}setLayoutProperty(t,r,i,a={}){this._checkLoaded();const o=this.getLayer(t);o?n(o.getLayoutProperty(r),i)||(o.setLayoutProperty(r,i,a),this._updateLayer(o)):this.fire(new e.ErrorEvent(new Error(`Cannot style non-existing layer "${t}".`)))}getLayoutProperty(t,r){const i=this.getLayer(t);if(i)return i.getLayoutProperty(r);this.fire(new e.ErrorEvent(new Error(`Cannot get style of non-existing layer "${t}".`)))}setPaintProperty(t,r,i,a={}){this._checkLoaded();const o=this.getLayer(t);o?n(o.getPaintProperty(r),i)||(o.setPaintProperty(r,i,a)&&this._updateLayer(o),this._changed=!0,this._updatedPaintProps[t]=!0):this.fire(new e.ErrorEvent(new Error(`Cannot style non-existing layer "${t}".`)))}getPaintProperty(e,t){return this.getLayer(e).getPaintProperty(t)}setFeatureState(t,r){this._checkLoaded();const i=t.source,n=t.sourceLayer,a=this.sourceCaches[i];if(void 0===a)return void this.fire(new e.ErrorEvent(new Error(`The source '${i}' does not exist in the map's style.`)));const o=a.getSource().type;"geojson"===o&&n?this.fire(new e.ErrorEvent(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):"vector"!==o||n?(void 0===t.id&&this.fire(new e.ErrorEvent(new Error("The feature id parameter must be provided."))),a.setFeatureState(n,t.id,r)):this.fire(new e.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(t,r){this._checkLoaded();const i=t.source,n=this.sourceCaches[i];if(void 0===n)return void this.fire(new e.ErrorEvent(new Error(`The source '${i}' does not exist in the map's style.`)));const a=n.getSource().type,o="vector"===a?t.sourceLayer:void 0;"vector"!==a||o?r&&"string"!=typeof t.id&&"number"!=typeof t.id?this.fire(new e.ErrorEvent(new Error("A feature id is required to remove its specific state property."))):n.removeFeatureState(o,t.id,r):this.fire(new e.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(t){this._checkLoaded();const r=t.source,i=t.sourceLayer,n=this.sourceCaches[r];if(void 0!==n)return"vector"!==n.getSource().type||i?(void 0===t.id&&this.fire(new e.ErrorEvent(new Error("The feature id parameter must be provided."))),n.getFeatureState(i,t.id)):void this.fire(new e.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new e.ErrorEvent(new Error(`The source '${r}' does not exist in the map's style.`)))}getTransition(){return e.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){return e.filterObject({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,light:this.stylesheet.light,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,sources:e.mapObject(this.sourceCaches,(e=>e.serialize())),layers:this._serializeLayers(this._order)},(e=>void 0!==e))}_updateLayer(e){this._updatedLayers[e.id]=!0,e.source&&!this._updatedSources[e.source]&&"raster"!==this.sourceCaches[e.source].getSource().type&&(this._updatedSources[e.source]="reload",this.sourceCaches[e.source].pause()),this._changed=!0}_flattenAndSortRenderedFeatures(e){const t=e=>"fill-extrusion"===this._layers[e].type,r={},i=[];for(let n=this._order.length-1;n>=0;n--){const a=this._order[n];if(t(a)){r[a]=n;for(const t of e){const e=t[a];if(e)for(const t of e)i.push(t)}}}i.sort(((e,t)=>t.intersectionZ-e.intersectionZ));const n=[];for(let a=this._order.length-1;a>=0;a--){const o=this._order[a];if(t(o))for(let e=i.length-1;e>=0;e--){const t=i[e].feature;if(r[t.layer.id]<a)break;n.push(t),i.pop()}else for(const t of e){const e=t[o];if(e)for(const t of e)n.push(t.feature)}}return n}queryRenderedFeatures(t,r,i){r&&r.filter&&this._validate(e.validateStyle.filter,"queryRenderedFeatures.filter",r.filter,null,r);const n={};if(r&&r.layers){if(!Array.isArray(r.layers))return this.fire(new e.ErrorEvent(new Error("parameters.layers must be an Array."))),[];for(const t of r.layers){const r=this._layers[t];if(!r)return this.fire(new e.ErrorEvent(new Error(`The layer '${t}' does not exist in the map's style and cannot be queried for features.`))),[];n[r.source]=!0}}const a=[];r.availableImages=this._availableImages;for(const e in this.sourceCaches)r.layers&&!n[e]||a.push(D(this.sourceCaches[e],this._layers,this._serializedLayers,t,r,i));return this.placement&&a.push(function(e,t,r,i,n,a,o){const s={},l=a.queryRenderedSymbols(i),c=[];for(const e of Object.keys(l).map(Number))c.push(o[e]);c.sort(L);for(const r of c){const i=r.featureIndex.lookupSymbolFeatures(l[r.bucketInstanceId],t,r.bucketIndex,r.sourceLayerIndex,n.filter,n.layers,n.availableImages,e);for(const e in i){const t=s[e]=s[e]||[],n=i[e];n.sort(((e,t)=>{const i=r.featureSortOrder;if(i){const r=i.indexOf(e.featureIndex);return i.indexOf(t.featureIndex)-r}return t.featureIndex-e.featureIndex}));for(const e of n)t.push(e)}}for(const t in s)s[t].forEach((i=>{const n=i.feature,a=r[e[t].source].getFeatureState(n.layer["source-layer"],n.id);n.source=n.layer.source,n.layer["source-layer"]&&(n.sourceLayer=n.layer["source-layer"]),n.state=a}));return s}(this._layers,this._serializedLayers,this.sourceCaches,t,r,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(a)}querySourceFeatures(t,r){r&&r.filter&&this._validate(e.validateStyle.filter,"querySourceFeatures.filter",r.filter,null,r);const i=this.sourceCaches[t];return i?function(e,t){const r=e.getRenderableIds().map((t=>e.getTileByID(t))),i=[],n={};for(let e=0;e<r.length;e++){const a=r[e],o=a.tileID.canonical.key;n[o]||(n[o]=!0,a.querySourceFeatures(i,t))}return i}(i,r):[]}addSourceType(e,t,r){return tt.getSourceType(e)?r(new Error(`A source type called "${e}" already exists.`)):(tt.setSourceType(e,t),t.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:e,url:t.workerSourceURL},r):r(null,null))}getLight(){return this.light.getLight()}setLight(t,r={}){this._checkLoaded();const i=this.light.getLight();let a=!1;for(const e in t)if(!n(t[e],i[e])){a=!0;break}if(!a)return;const o={now:e.exported.now(),transition:e.extend({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(t,r),this.light.updateTransitions(o)}_validate(t,r,i,n,a={}){return(!a||!1!==a.validate)&&Ye(this,t.call(e.validateStyle,e.extend({key:r,style:this.serialize(),value:i,styleSpec:e.spec},n)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),e.evented.off("pluginStateChange",this._rtlTextPluginCallback);for(const e in this._layers)this._layers[e].setEventedParent(null);for(const e in this.sourceCaches){const t=this.sourceCaches[e];t.setEventedParent(null),t.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),this.dispatcher.remove()}_clearSource(e){this.sourceCaches[e].clearTiles()}_reloadSource(e){this.sourceCaches[e].resume(),this.sourceCaches[e].reload()}_updateSources(e){for(const t in this.sourceCaches)this.sourceCaches[t].update(e,this.terrain)}_generateCollisionBoxes(){for(const e in this.sourceCaches)this._reloadSource(e)}_updatePlacement(t,r,i,n,a=!1){let o=!1,s=!1;const l={};for(const e of this._order){const r=this._layers[e];if("symbol"!==r.type)continue;if(!l[r.source]){const e=this.sourceCaches[r.source];l[r.source]=e.getRenderableIds(!0).map((t=>e.getTileByID(t))).sort(((e,t)=>t.tileID.overscaledZ-e.tileID.overscaledZ||(e.tileID.isLessThan(t.tileID)?-1:1)))}const i=this.crossTileSymbolIndex.addLayer(r,l[r.source],t.center.lng);o=o||i}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((a=a||this._layerOrderChanged||0===i)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(e.exported.now(),t.zoom))&&(this.pauseablePlacement=new Ne(t,this.terrain,this._order,a,r,i,n,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,l),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(e.exported.now()),s=!0),o&&this.pauseablePlacement.placement.setStale()),s||o)for(const e of this._order){const t=this._layers[e];"symbol"===t.type&&this.placement.updateLayerOpacities(t,l[t.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(e.exported.now())}_releaseSymbolFadeTiles(){for(const e in this.sourceCaches)this.sourceCaches[e].releaseSymbolFadeTiles()}getImages(e,t,r){this.imageManager.getImages(t.icons,r),this._updateTilesForChangedImages();const i=this.sourceCaches[t.source];i&&i.setDependencies(t.tileID.key,t.type,t.icons)}getGlyphs(e,t,r){this.glyphManager.getGlyphs(t.stacks,r)}getResource(t,r,i){return e.makeRequest(r,i)}}tt.getSourceType=function(e){return M[e]},tt.setSourceType=function(e,t){M[e]=t},tt.registerForPluginStateChange=e.registerForPluginStateChange;var rt="attribute vec2 a_pos;uniform mat4 u_matrix;varying vec2 v_texture_pos;varying float v_depth;void main() {v_texture_pos=a_pos/8192.0;gl_Position=u_matrix*vec4(a_pos,get_elevation(a_pos),1.0);v_depth=gl_Position.z/gl_Position.w;}";const it={prelude:nt("#ifdef GL_ES\nprecision mediump float;\n#else\n#if !defined(lowp)\n#define lowp\n#endif\n#if !defined(mediump)\n#define mediump\n#endif\n#if !defined(highp)\n#define highp\n#endif\n#endif","#ifdef GL_ES\nprecision highp float;\n#else\n#if !defined(lowp)\n#define lowp\n#endif\n#if !defined(mediump)\n#define mediump\n#endif\n#if !defined(highp)\n#define highp\n#endif\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}\n#ifdef TERRAIN3D\nuniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_offset;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;\n#endif\nconst highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {\n#ifdef TERRAIN3D\nhighp float d=unpack(texture2D(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));\n#else\nreturn 1.0;\n#endif\n}float calculate_visibility(vec4 pos) {\n#ifdef TERRAIN3D\nvec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;\n#else\nreturn 1.0;\n#endif\n}float ele(vec2 pos) {\n#ifdef TERRAIN3D\nvec4 rgb=(texture2D(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;\n#else\nreturn 0.0;\n#endif\n}float get_elevation(vec2 pos) {\n#ifdef TERRAIN3D\nvec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return (elevation+u_terrain_offset)*u_terrain_exaggeration;\n#else\nreturn 0.0;\n#endif\n}"),background:nt("uniform vec4 u_color;uniform float u_opacity;void main() {gl_FragColor=u_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),backgroundPattern:nt("uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_mix)*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:nt("varying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));gl_FragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;varying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvoid main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);float ele=get_elevation(circle_center);v_visibility=calculate_visibility(u_matrix*vec4(circle_center,ele,1.0));if (u_pitch_with_map) {vec2 corner_position=circle_center;if (u_scale_with_map) {corner_position+=extrude*(radius+stroke_width)*u_extrude_scale;} else {vec4 projected_center=u_matrix*vec4(circle_center,0,1);corner_position+=extrude*(radius+stroke_width)*u_extrude_scale*(projected_center.w/u_camera_to_center_distance);}gl_Position=u_matrix*vec4(corner_position,ele,1);} else {gl_Position=u_matrix*vec4(circle_center,ele,1);if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);}"),clippingMask:nt("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:nt("uniform highp float u_intensity;varying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;varying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec4 pos=vec4(floor(a_pos*0.5)+extrude,0,1);gl_Position=u_matrix*pos;}"),heatmapTexture:nt("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(0.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:nt("varying float v_placed;varying float v_notUsed;void main() {float alpha=0.5;gl_FragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {gl_FragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {gl_FragColor*=.1;}}","attribute vec2 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_anchor_pos,0,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);gl_Position=u_matrix*vec4(a_pos,get_elevation(a_pos),1.0);gl_Position.xy+=(a_extrude+a_shift)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:nt("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}","attribute vec2 a_pos;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:nt("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}","attribute vec2 a_pos;varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,get_elevation(a_pos),1);}"),fill:nt("#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_FragColor=color*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec2 a_pos;uniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);}"),fillOutline:nt("varying vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=outline_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}"),fillOutlinePattern:nt("uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=mix(color1,color2,u_fade)*alpha*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}"),fillPattern:nt("#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_fade)*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}"),fillExtrusion:nt("varying vec4 v_color;void main() {gl_FragColor=v_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec2 a_pos;attribute vec4 a_normal_ed;\n#ifdef TERRAIN3D\nattribute vec2 a_centroid;\n#endif\nvarying vec4 v_color;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\nvec3 normal=a_normal_ed.xyz;\n#ifdef TERRAIN3D\nfloat baseDelta=10.0;float ele=get_elevation(a_centroid);\n#else\nfloat baseDelta=0.0;float ele=0.0;\n#endif\nbase=max(0.0,ele+base-baseDelta);height=max(0.0,ele+height);float t=mod(normal.x,2.0);gl_Position=u_matrix*vec4(a_pos,t > 0.0 ? height : base,1);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal/16384.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}"),fillExtrusionPattern:nt("uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;\n#pragma mapbox: define lowp float base\n#pragma mapbox: define lowp float height\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float base\n#pragma mapbox: initialize lowp float height\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);gl_FragColor=mixedColor*v_lighting;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec2 a_pos;attribute vec4 a_normal_ed;\n#ifdef TERRAIN3D\nattribute vec2 a_centroid;\n#endif\nvarying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;\n#pragma mapbox: define lowp float base\n#pragma mapbox: define lowp float height\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float base\n#pragma mapbox: initialize lowp float height\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;\n#ifdef TERRAIN3D\nfloat baseDelta=10.0;float ele=get_elevation(a_centroid);\n#else\nfloat baseDelta=0.0;float ele=0.0;\n#endif\nbase=max(0.0,ele+base-baseDelta);height=max(0.0,ele+height);float t=mod(normal.x,2.0);float z=t > 0.0 ? height : base;gl_Position=u_matrix*vec4(a_pos,z,1);vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0\n? a_pos\n: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}"),hillshadePrepare:nt("#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:nt("uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;\n#define PI 3.141592653589793\nvoid main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;}"),line:nt("uniform lowp float u_device_pixel_ratio;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);gl_FragColor=color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","\n#define scale 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp float v_linesofar;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_width2=vec2(outset,inset);}"),lineGradient:nt("uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec2 v_uv;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture2D(u_image,v_uv);gl_FragColor=color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","\n#define scale 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_uv_x;attribute float a_split_index;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec2 v_uv;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_width2=vec2(outset,inset);}"),linePattern:nt("#ifdef GL_ES\nprecision highp float;\n#endif\nuniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);gl_FragColor=color*alpha*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","\n#define scale 0.015873016\n#define LINE_DISTANCE_SCALE 2.0\nattribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}"),lineSDF:nt("uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture2D(u_image,v_tex_a).a;float sdfdist_b=texture2D(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);gl_FragColor=color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","\n#define scale 0.015873016\n#define LINE_DISTANCE_SCALE 2.0\nattribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}"),raster:nt("uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);gl_FragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos0=(((a_texture_pos/8192.0)-0.5)/u_buffer_scale )+0.5;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}"),symbolIcon:nt("uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\nlowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;varying vec2 v_tex;varying float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0),z,1.0);v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}"),symbolSDF:nt("#define SDF_PX 8.0\nuniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;varying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset),z,1.0);float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}"),symbolTextAndIcon:nt("#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nfloat fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nreturn;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;varying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale),z,1.0);float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}"),terrain:nt("uniform sampler2D u_texture;varying vec2 v_texture_pos;void main() {gl_FragColor=texture2D(u_texture,v_texture_pos);}",rt),terrainDepth:nt("varying float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {gl_FragColor=pack(v_depth);}",rt),terrainCoords:nt("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;varying vec2 v_texture_pos;void main() {vec4 rgba=texture2D(u_texture,v_texture_pos);gl_FragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}",rt)};function nt(e,t){const r=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,i=t.match(/attribute ([\w]+) ([\w]+)/g),n=e.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),a=t.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),o=a?a.concat(n):n,s={};return{fragmentSource:e=e.replace(r,((e,t,r,i,n)=>(s[n]=!0,"define"===t?`\n#ifndef HAS_UNIFORM_u_${n}\nvarying ${r} ${i} ${n};\n#else\nuniform ${r} ${i} u_${n};\n#endif\n`:`\n#ifdef HAS_UNIFORM_u_${n}\n    ${r} ${i} ${n} = u_${n};\n#endif\n`))),vertexSource:t=t.replace(r,((e,t,r,i,n)=>{const a="float"===i?"vec2":"vec4",o=n.match(/color/)?"color":a;return s[n]?"define"===t?`\n#ifndef HAS_UNIFORM_u_${n}\nuniform lowp float u_${n}_t;\nattribute ${r} ${a} a_${n};\nvarying ${r} ${i} ${n};\n#else\nuniform ${r} ${i} u_${n};\n#endif\n`:"vec4"===o?`\n#ifndef HAS_UNIFORM_u_${n}\n    ${n} = a_${n};\n#else\n    ${r} ${i} ${n} = u_${n};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${n}\n    ${n} = unpack_mix_${o}(a_${n}, u_${n}_t);\n#else\n    ${r} ${i} ${n} = u_${n};\n#endif\n`:"define"===t?`\n#ifndef HAS_UNIFORM_u_${n}\nuniform lowp float u_${n}_t;\nattribute ${r} ${a} a_${n};\n#else\nuniform ${r} ${i} u_${n};\n#endif\n`:"vec4"===o?`\n#ifndef HAS_UNIFORM_u_${n}\n    ${r} ${i} ${n} = a_${n};\n#else\n    ${r} ${i} ${n} = u_${n};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${n}\n    ${r} ${i} ${n} = unpack_mix_${o}(a_${n}, u_${n}_t);\n#else\n    ${r} ${i} ${n} = u_${n};\n#endif\n`})),staticAttributes:i,staticUniforms:o}}class at{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(e,t,r,i,n,a,o,s,l){this.context=e;let c=this.boundPaintVertexBuffers.length!==i.length;for(let e=0;!c&&e<i.length;e++)this.boundPaintVertexBuffers[e]!==i[e]&&(c=!0);e.extVertexArrayObject&&this.vao&&this.boundProgram===t&&this.boundLayoutVertexBuffer===r&&!c&&this.boundIndexBuffer===n&&this.boundVertexOffset===a&&this.boundDynamicVertexBuffer===o&&this.boundDynamicVertexBuffer2===s&&this.boundDynamicVertexBuffer3===l?(e.bindVertexArrayOES.set(this.vao),o&&o.bind(),n&&n.dynamicDraw&&n.bind(),s&&s.bind(),l&&l.bind()):this.freshBind(t,r,i,n,a,o,s,l)}freshBind(e,t,r,i,n,a,o,s){let l;const c=e.numAttributes,u=this.context,h=u.gl;if(u.extVertexArrayObject)this.vao&&this.destroy(),this.vao=u.extVertexArrayObject.createVertexArrayOES(),u.bindVertexArrayOES.set(this.vao),l=0,this.boundProgram=e,this.boundLayoutVertexBuffer=t,this.boundPaintVertexBuffers=r,this.boundIndexBuffer=i,this.boundVertexOffset=n,this.boundDynamicVertexBuffer=a,this.boundDynamicVertexBuffer2=o,this.boundDynamicVertexBuffer3=s;else{l=u.currentNumAttributes||0;for(let e=c;e<l;e++)h.disableVertexAttribArray(e)}t.enableAttributes(h,e);for(const t of r)t.enableAttributes(h,e);a&&a.enableAttributes(h,e),o&&o.enableAttributes(h,e),s&&s.enableAttributes(h,e),t.bind(),t.setVertexAttribPointers(h,e,n);for(const t of r)t.bind(),t.setVertexAttribPointers(h,e,n);a&&(a.bind(),a.setVertexAttribPointers(h,e,n)),i&&i.bind(),o&&(o.bind(),o.setVertexAttribPointers(h,e,n)),s&&(s.bind(),s.setVertexAttribPointers(h,e,n)),u.currentNumAttributes=c}destroy(){this.vao&&(this.context.extVertexArrayObject.deleteVertexArrayOES(this.vao),this.vao=null)}}function ot(e){const t=[];for(let r=0;r<e.length;r++){if(null===e[r])continue;const i=e[r].split(" ");t.push(i.pop())}return t}class st{constructor(t,r,i,n,a,o,s){const l=t.gl;this.program=l.createProgram();const c=ot(i.staticAttributes),u=n?n.getBinderAttributes():[],h=c.concat(u),p=it.prelude.staticUniforms?ot(it.prelude.staticUniforms):[],d=i.staticUniforms?ot(i.staticUniforms):[],f=n?n.getBinderUniforms():[],m=p.concat(d).concat(f),g=[];for(const e of m)g.indexOf(e)<0&&g.push(e);const y=n?n.defines():[];o&&y.push("#define OVERDRAW_INSPECTOR;"),s&&y.push("#define TERRAIN3D;");const _=y.concat(it.prelude.fragmentSource,i.fragmentSource).join("\n"),x=y.concat(it.prelude.vertexSource,i.vertexSource).join("\n"),v=l.createShader(l.FRAGMENT_SHADER);if(l.isContextLost())return void(this.failedToCreate=!0);l.shaderSource(v,_),l.compileShader(v),l.attachShader(this.program,v);const b=l.createShader(l.VERTEX_SHADER);if(l.isContextLost())return void(this.failedToCreate=!0);l.shaderSource(b,x),l.compileShader(b),l.attachShader(this.program,b),this.attributes={};const w={};this.numAttributes=h.length;for(let e=0;e<this.numAttributes;e++)h[e]&&(l.bindAttribLocation(this.program,e,h[e]),this.attributes[h[e]]=e);l.linkProgram(this.program),l.deleteShader(b),l.deleteShader(v);for(let e=0;e<g.length;e++){const t=g[e];if(t&&!w[t]){const e=l.getUniformLocation(this.program,t);e&&(w[t]=e)}}this.fixedUniforms=a(t,w),this.terrainUniforms=((t,r)=>({u_depth:new e.Uniform1i(t,r.u_depth),u_terrain:new e.Uniform1i(t,r.u_terrain),u_terrain_dim:new e.Uniform1f(t,r.u_terrain_dim),u_terrain_matrix:new e.UniformMatrix4f(t,r.u_terrain_matrix),u_terrain_unpack:new e.Uniform4f(t,r.u_terrain_unpack),u_terrain_offset:new e.Uniform1f(t,r.u_terrain_offset),u_terrain_exaggeration:new e.Uniform1f(t,r.u_terrain_exaggeration)}))(t,w),this.binderUniforms=n?n.getUniforms(t,w):[]}draw(e,t,r,i,n,a,o,s,l,c,u,h,p,d,f,m,g,y){const _=e.gl;if(this.failedToCreate)return;if(e.program.set(this.program),e.setDepthMode(r),e.setStencilMode(i),e.setColorMode(n),e.setCullFace(a),s){e.activeTexture.set(_.TEXTURE2),_.bindTexture(_.TEXTURE_2D,s.depthTexture),e.activeTexture.set(_.TEXTURE3),_.bindTexture(_.TEXTURE_2D,s.texture);for(const e in this.terrainUniforms)this.terrainUniforms[e].set(s[e])}for(const e in this.fixedUniforms)this.fixedUniforms[e].set(o[e]);f&&f.setUniforms(e,this.binderUniforms,p,{zoom:d});let x=0;switch(t){case _.LINES:x=2;break;case _.TRIANGLES:x=3;break;case _.LINE_STRIP:x=1}for(const r of h.get()){const i=r.vaos||(r.vaos={});(i[l]||(i[l]=new at)).bind(e,this,c,f?f.getPaintVertexBuffers():[],u,r.vertexOffset,m,g,y),_.drawElements(t,r.primitiveLength*x,_.UNSIGNED_SHORT,r.primitiveOffset*x*2)}}}function lt(e,t,r){const i=1/be(r,1,t.transform.tileZoom),n=Math.pow(2,r.tileID.overscaledZ),a=r.tileSize*Math.pow(2,t.transform.tileZoom)/n,o=a*(r.tileID.canonical.x+r.tileID.wrap*n),s=a*r.tileID.canonical.y;return{u_image:0,u_texsize:r.imageAtlasTexture.size,u_scale:[i,e.fromScale,e.toScale],u_fade:e.t,u_pixel_coord_upper:[o>>16,s>>16],u_pixel_coord_lower:[65535&o,65535&s]}}const ct=(t,r,i,n)=>{const a=r.style.light,o=a.properties.get("position"),s=[o.x,o.y,o.z],l=e.create$1();"viewport"===a.properties.get("anchor")&&e.fromRotation(l,-r.transform.angle),e.transformMat3(s,s,l);const c=a.properties.get("color");return{u_matrix:t,u_lightpos:s,u_lightintensity:a.properties.get("intensity"),u_lightcolor:[c.r,c.g,c.b],u_vertical_gradient:+i,u_opacity:n}},ut=(t,r,i,n,a,o,s)=>e.extend(ct(t,r,i,n),lt(o,r,s),{u_height_factor:-Math.pow(2,a.overscaledZ)/s.tileSize/8}),ht=e=>({u_matrix:e}),pt=(t,r,i,n)=>e.extend(ht(t),lt(i,r,n)),dt=(e,t)=>({u_matrix:e,u_world:t}),ft=(t,r,i,n,a)=>e.extend(pt(t,r,i,n),{u_world:a}),mt=(e,t,r,i)=>{const n=e.transform;let a,o;if("map"===i.paint.get("circle-pitch-alignment")){const e=be(r,1,n.zoom);a=!0,o=[e,e]}else a=!1,o=n.pixelsToGLUnits;return{u_camera_to_center_distance:n.cameraToCenterDistance,u_scale_with_map:+("map"===i.paint.get("circle-pitch-scale")),u_matrix:e.translatePosMatrix(t.posMatrix,r,i.paint.get("circle-translate"),i.paint.get("circle-translate-anchor")),u_pitch_with_map:+a,u_device_pixel_ratio:e.pixelRatio,u_extrude_scale:o}},gt=(e,t,r)=>{const i=be(r,1,t.zoom),n=Math.pow(2,t.zoom-r.tileID.overscaledZ),a=r.tileID.overscaleFactor();return{u_matrix:e,u_camera_to_center_distance:t.cameraToCenterDistance,u_pixels_to_tile_units:i,u_extrude_scale:[t.pixelsToGLUnits[0]/(i*n),t.pixelsToGLUnits[1]/(i*n)],u_overscale_factor:a}},yt=(e,t,r=1)=>({u_matrix:e,u_color:t,u_overlay:0,u_overlay_scale:r}),_t=e=>({u_matrix:e}),xt=(e,t,r,i)=>({u_matrix:e,u_extrude_scale:be(t,1,r),u_intensity:i});function vt(t,r){const i=Math.pow(2,r.canonical.z),n=r.canonical.y;return[new e.MercatorCoordinate(0,n/i).toLngLat().lat,new e.MercatorCoordinate(0,(n+1)/i).toLngLat().lat]}const bt=(e,t,r,i)=>{const n=e.transform;return{u_matrix:At(e,t,r,i),u_ratio:1/be(t,1,n.zoom),u_device_pixel_ratio:e.pixelRatio,u_units_to_pixels:[1/n.pixelsToGLUnits[0],1/n.pixelsToGLUnits[1]]}},wt=(t,r,i,n,a)=>e.extend(bt(t,r,i,a),{u_image:0,u_image_height:n}),Tt=(e,t,r,i,n)=>{const a=e.transform,o=St(t,a);return{u_matrix:At(e,t,r,n),u_texsize:t.imageAtlasTexture.size,u_ratio:1/be(t,1,a.zoom),u_device_pixel_ratio:e.pixelRatio,u_image:0,u_scale:[o,i.fromScale,i.toScale],u_fade:i.t,u_units_to_pixels:[1/a.pixelsToGLUnits[0],1/a.pixelsToGLUnits[1]]}},Et=(t,r,i,n,a,o)=>{const s=t.lineAtlas,l=St(r,t.transform),c="round"===i.layout.get("line-cap"),u=s.getDash(n.from,c),h=s.getDash(n.to,c),p=u.width*a.fromScale,d=h.width*a.toScale;return e.extend(bt(t,r,i,o),{u_patternscale_a:[l/p,-u.height/2],u_patternscale_b:[l/d,-h.height/2],u_sdfgamma:s.width/(256*Math.min(p,d)*t.pixelRatio)/2,u_image:0,u_tex_y_a:u.y,u_tex_y_b:h.y,u_mix:a.t})};function St(e,t){return 1/be(e,1,t.tileZoom)}function At(e,t,r,i){return e.translatePosMatrix(i?i.posMatrix:t.tileID.posMatrix,t,r.paint.get("line-translate"),r.paint.get("line-translate-anchor"))}const It=(e,t,r,i,n)=>{return{u_matrix:e,u_tl_parent:t,u_scale_parent:r,u_buffer_scale:1,u_fade_t:i.mix,u_opacity:i.opacity*n.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:n.paint.get("raster-brightness-min"),u_brightness_high:n.paint.get("raster-brightness-max"),u_saturation_factor:(o=n.paint.get("raster-saturation"),o>0?1-1/(1.001-o):-o),u_contrast_factor:(a=n.paint.get("raster-contrast"),a>0?1/(1-a):1+a),u_spin_weights:kt(n.paint.get("raster-hue-rotate"))};var a,o};function kt(e){e*=Math.PI/180;const t=Math.sin(e),r=Math.cos(e);return[(2*r+1)/3,(-Math.sqrt(3)*t-r+1)/3,(Math.sqrt(3)*t-r+1)/3]}const Ct=(e,t,r,i,n,a,o,s,l,c)=>{const u=n.transform;return{u_is_size_zoom_constant:+("constant"===e||"source"===e),u_is_size_feature_constant:+("constant"===e||"camera"===e),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:u.cameraToCenterDistance,u_pitch:u.pitch/360*2*Math.PI,u_rotate_symbol:+r,u_aspect_ratio:u.width/u.height,u_fade_change:n.options.fadeDuration?n.symbolFadeChange:1,u_matrix:a,u_label_plane_matrix:o,u_coord_matrix:s,u_is_text:+l,u_pitch_with_map:+i,u_texsize:c,u_texture:0}},zt=(t,r,i,n,a,o,s,l,c,u,h)=>{const p=a.transform;return e.extend(Ct(t,r,i,n,a,o,s,l,c,u),{u_gamma_scale:n?Math.cos(p._pitch)*p.cameraToCenterDistance:1,u_device_pixel_ratio:a.pixelRatio,u_is_halo:+h})},Mt=(t,r,i,n,a,o,s,l,c,u)=>e.extend(zt(t,r,i,n,a,o,s,l,!0,c,!0),{u_texsize_icon:u,u_texture_icon:1}),Pt=(e,t,r)=>({u_matrix:e,u_opacity:t,u_color:r}),Dt=(t,r,i,n,a,o)=>e.extend(function(e,t,r,i){const n=r.imageManager.getPattern(e.from.toString()),a=r.imageManager.getPattern(e.to.toString()),{width:o,height:s}=r.imageManager.getPixelSize(),l=Math.pow(2,i.tileID.overscaledZ),c=i.tileSize*Math.pow(2,r.transform.tileZoom)/l,u=c*(i.tileID.canonical.x+i.tileID.wrap*l),h=c*i.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:n.tl,u_pattern_br_a:n.br,u_pattern_tl_b:a.tl,u_pattern_br_b:a.br,u_texsize:[o,s],u_mix:t.t,u_pattern_size_a:n.displaySize,u_pattern_size_b:a.displaySize,u_scale_a:t.fromScale,u_scale_b:t.toScale,u_tile_units_to_pixels:1/be(i,1,r.transform.tileZoom),u_pixel_coord_upper:[u>>16,h>>16],u_pixel_coord_lower:[65535&u,65535&h]}}(n,o,i,a),{u_matrix:t,u_opacity:r}),Lt={fillExtrusion:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_lightpos:new e.Uniform3f(t,r.u_lightpos),u_lightintensity:new e.Uniform1f(t,r.u_lightintensity),u_lightcolor:new e.Uniform3f(t,r.u_lightcolor),u_vertical_gradient:new e.Uniform1f(t,r.u_vertical_gradient),u_opacity:new e.Uniform1f(t,r.u_opacity)}),fillExtrusionPattern:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_lightpos:new e.Uniform3f(t,r.u_lightpos),u_lightintensity:new e.Uniform1f(t,r.u_lightintensity),u_lightcolor:new e.Uniform3f(t,r.u_lightcolor),u_vertical_gradient:new e.Uniform1f(t,r.u_vertical_gradient),u_height_factor:new e.Uniform1f(t,r.u_height_factor),u_image:new e.Uniform1i(t,r.u_image),u_texsize:new e.Uniform2f(t,r.u_texsize),u_pixel_coord_upper:new e.Uniform2f(t,r.u_pixel_coord_upper),u_pixel_coord_lower:new e.Uniform2f(t,r.u_pixel_coord_lower),u_scale:new e.Uniform3f(t,r.u_scale),u_fade:new e.Uniform1f(t,r.u_fade),u_opacity:new e.Uniform1f(t,r.u_opacity)}),fill:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix)}),fillPattern:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_image:new e.Uniform1i(t,r.u_image),u_texsize:new e.Uniform2f(t,r.u_texsize),u_pixel_coord_upper:new e.Uniform2f(t,r.u_pixel_coord_upper),u_pixel_coord_lower:new e.Uniform2f(t,r.u_pixel_coord_lower),u_scale:new e.Uniform3f(t,r.u_scale),u_fade:new e.Uniform1f(t,r.u_fade)}),fillOutline:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_world:new e.Uniform2f(t,r.u_world)}),fillOutlinePattern:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_world:new e.Uniform2f(t,r.u_world),u_image:new e.Uniform1i(t,r.u_image),u_texsize:new e.Uniform2f(t,r.u_texsize),u_pixel_coord_upper:new e.Uniform2f(t,r.u_pixel_coord_upper),u_pixel_coord_lower:new e.Uniform2f(t,r.u_pixel_coord_lower),u_scale:new e.Uniform3f(t,r.u_scale),u_fade:new e.Uniform1f(t,r.u_fade)}),circle:(t,r)=>({u_camera_to_center_distance:new e.Uniform1f(t,r.u_camera_to_center_distance),u_scale_with_map:new e.Uniform1i(t,r.u_scale_with_map),u_pitch_with_map:new e.Uniform1i(t,r.u_pitch_with_map),u_extrude_scale:new e.Uniform2f(t,r.u_extrude_scale),u_device_pixel_ratio:new e.Uniform1f(t,r.u_device_pixel_ratio),u_matrix:new e.UniformMatrix4f(t,r.u_matrix)}),collisionBox:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_camera_to_center_distance:new e.Uniform1f(t,r.u_camera_to_center_distance),u_pixels_to_tile_units:new e.Uniform1f(t,r.u_pixels_to_tile_units),u_extrude_scale:new e.Uniform2f(t,r.u_extrude_scale),u_overscale_factor:new e.Uniform1f(t,r.u_overscale_factor)}),collisionCircle:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_inv_matrix:new e.UniformMatrix4f(t,r.u_inv_matrix),u_camera_to_center_distance:new e.Uniform1f(t,r.u_camera_to_center_distance),u_viewport_size:new e.Uniform2f(t,r.u_viewport_size)}),debug:(t,r)=>({u_color:new e.UniformColor(t,r.u_color),u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_overlay:new e.Uniform1i(t,r.u_overlay),u_overlay_scale:new e.Uniform1f(t,r.u_overlay_scale)}),clippingMask:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix)}),heatmap:(t,r)=>({u_extrude_scale:new e.Uniform1f(t,r.u_extrude_scale),u_intensity:new e.Uniform1f(t,r.u_intensity),u_matrix:new e.UniformMatrix4f(t,r.u_matrix)}),heatmapTexture:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_world:new e.Uniform2f(t,r.u_world),u_image:new e.Uniform1i(t,r.u_image),u_color_ramp:new e.Uniform1i(t,r.u_color_ramp),u_opacity:new e.Uniform1f(t,r.u_opacity)}),hillshade:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_image:new e.Uniform1i(t,r.u_image),u_latrange:new e.Uniform2f(t,r.u_latrange),u_light:new e.Uniform2f(t,r.u_light),u_shadow:new e.UniformColor(t,r.u_shadow),u_highlight:new e.UniformColor(t,r.u_highlight),u_accent:new e.UniformColor(t,r.u_accent)}),hillshadePrepare:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_image:new e.Uniform1i(t,r.u_image),u_dimension:new e.Uniform2f(t,r.u_dimension),u_zoom:new e.Uniform1f(t,r.u_zoom),u_unpack:new e.Uniform4f(t,r.u_unpack)}),line:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_ratio:new e.Uniform1f(t,r.u_ratio),u_device_pixel_ratio:new e.Uniform1f(t,r.u_device_pixel_ratio),u_units_to_pixels:new e.Uniform2f(t,r.u_units_to_pixels)}),lineGradient:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_ratio:new e.Uniform1f(t,r.u_ratio),u_device_pixel_ratio:new e.Uniform1f(t,r.u_device_pixel_ratio),u_units_to_pixels:new e.Uniform2f(t,r.u_units_to_pixels),u_image:new e.Uniform1i(t,r.u_image),u_image_height:new e.Uniform1f(t,r.u_image_height)}),linePattern:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_texsize:new e.Uniform2f(t,r.u_texsize),u_ratio:new e.Uniform1f(t,r.u_ratio),u_device_pixel_ratio:new e.Uniform1f(t,r.u_device_pixel_ratio),u_image:new e.Uniform1i(t,r.u_image),u_units_to_pixels:new e.Uniform2f(t,r.u_units_to_pixels),u_scale:new e.Uniform3f(t,r.u_scale),u_fade:new e.Uniform1f(t,r.u_fade)}),lineSDF:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_ratio:new e.Uniform1f(t,r.u_ratio),u_device_pixel_ratio:new e.Uniform1f(t,r.u_device_pixel_ratio),u_units_to_pixels:new e.Uniform2f(t,r.u_units_to_pixels),u_patternscale_a:new e.Uniform2f(t,r.u_patternscale_a),u_patternscale_b:new e.Uniform2f(t,r.u_patternscale_b),u_sdfgamma:new e.Uniform1f(t,r.u_sdfgamma),u_image:new e.Uniform1i(t,r.u_image),u_tex_y_a:new e.Uniform1f(t,r.u_tex_y_a),u_tex_y_b:new e.Uniform1f(t,r.u_tex_y_b),u_mix:new e.Uniform1f(t,r.u_mix)}),raster:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_tl_parent:new e.Uniform2f(t,r.u_tl_parent),u_scale_parent:new e.Uniform1f(t,r.u_scale_parent),u_buffer_scale:new e.Uniform1f(t,r.u_buffer_scale),u_fade_t:new e.Uniform1f(t,r.u_fade_t),u_opacity:new e.Uniform1f(t,r.u_opacity),u_image0:new e.Uniform1i(t,r.u_image0),u_image1:new e.Uniform1i(t,r.u_image1),u_brightness_low:new e.Uniform1f(t,r.u_brightness_low),u_brightness_high:new e.Uniform1f(t,r.u_brightness_high),u_saturation_factor:new e.Uniform1f(t,r.u_saturation_factor),u_contrast_factor:new e.Uniform1f(t,r.u_contrast_factor),u_spin_weights:new e.Uniform3f(t,r.u_spin_weights)}),symbolIcon:(t,r)=>({u_is_size_zoom_constant:new e.Uniform1i(t,r.u_is_size_zoom_constant),u_is_size_feature_constant:new e.Uniform1i(t,r.u_is_size_feature_constant),u_size_t:new e.Uniform1f(t,r.u_size_t),u_size:new e.Uniform1f(t,r.u_size),u_camera_to_center_distance:new e.Uniform1f(t,r.u_camera_to_center_distance),u_pitch:new e.Uniform1f(t,r.u_pitch),u_rotate_symbol:new e.Uniform1i(t,r.u_rotate_symbol),u_aspect_ratio:new e.Uniform1f(t,r.u_aspect_ratio),u_fade_change:new e.Uniform1f(t,r.u_fade_change),u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_label_plane_matrix:new e.UniformMatrix4f(t,r.u_label_plane_matrix),u_coord_matrix:new e.UniformMatrix4f(t,r.u_coord_matrix),u_is_text:new e.Uniform1i(t,r.u_is_text),u_pitch_with_map:new e.Uniform1i(t,r.u_pitch_with_map),u_texsize:new e.Uniform2f(t,r.u_texsize),u_texture:new e.Uniform1i(t,r.u_texture)}),symbolSDF:(t,r)=>({u_is_size_zoom_constant:new e.Uniform1i(t,r.u_is_size_zoom_constant),u_is_size_feature_constant:new e.Uniform1i(t,r.u_is_size_feature_constant),u_size_t:new e.Uniform1f(t,r.u_size_t),u_size:new e.Uniform1f(t,r.u_size),u_camera_to_center_distance:new e.Uniform1f(t,r.u_camera_to_center_distance),u_pitch:new e.Uniform1f(t,r.u_pitch),u_rotate_symbol:new e.Uniform1i(t,r.u_rotate_symbol),u_aspect_ratio:new e.Uniform1f(t,r.u_aspect_ratio),u_fade_change:new e.Uniform1f(t,r.u_fade_change),u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_label_plane_matrix:new e.UniformMatrix4f(t,r.u_label_plane_matrix),u_coord_matrix:new e.UniformMatrix4f(t,r.u_coord_matrix),u_is_text:new e.Uniform1i(t,r.u_is_text),u_pitch_with_map:new e.Uniform1i(t,r.u_pitch_with_map),u_texsize:new e.Uniform2f(t,r.u_texsize),u_texture:new e.Uniform1i(t,r.u_texture),u_gamma_scale:new e.Uniform1f(t,r.u_gamma_scale),u_device_pixel_ratio:new e.Uniform1f(t,r.u_device_pixel_ratio),u_is_halo:new e.Uniform1i(t,r.u_is_halo)}),symbolTextAndIcon:(t,r)=>({u_is_size_zoom_constant:new e.Uniform1i(t,r.u_is_size_zoom_constant),u_is_size_feature_constant:new e.Uniform1i(t,r.u_is_size_feature_constant),u_size_t:new e.Uniform1f(t,r.u_size_t),u_size:new e.Uniform1f(t,r.u_size),u_camera_to_center_distance:new e.Uniform1f(t,r.u_camera_to_center_distance),u_pitch:new e.Uniform1f(t,r.u_pitch),u_rotate_symbol:new e.Uniform1i(t,r.u_rotate_symbol),u_aspect_ratio:new e.Uniform1f(t,r.u_aspect_ratio),u_fade_change:new e.Uniform1f(t,r.u_fade_change),u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_label_plane_matrix:new e.UniformMatrix4f(t,r.u_label_plane_matrix),u_coord_matrix:new e.UniformMatrix4f(t,r.u_coord_matrix),u_is_text:new e.Uniform1i(t,r.u_is_text),u_pitch_with_map:new e.Uniform1i(t,r.u_pitch_with_map),u_texsize:new e.Uniform2f(t,r.u_texsize),u_texsize_icon:new e.Uniform2f(t,r.u_texsize_icon),u_texture:new e.Uniform1i(t,r.u_texture),u_texture_icon:new e.Uniform1i(t,r.u_texture_icon),u_gamma_scale:new e.Uniform1f(t,r.u_gamma_scale),u_device_pixel_ratio:new e.Uniform1f(t,r.u_device_pixel_ratio),u_is_halo:new e.Uniform1i(t,r.u_is_halo)}),background:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_opacity:new e.Uniform1f(t,r.u_opacity),u_color:new e.UniformColor(t,r.u_color)}),backgroundPattern:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_opacity:new e.Uniform1f(t,r.u_opacity),u_image:new e.Uniform1i(t,r.u_image),u_pattern_tl_a:new e.Uniform2f(t,r.u_pattern_tl_a),u_pattern_br_a:new e.Uniform2f(t,r.u_pattern_br_a),u_pattern_tl_b:new e.Uniform2f(t,r.u_pattern_tl_b),u_pattern_br_b:new e.Uniform2f(t,r.u_pattern_br_b),u_texsize:new e.Uniform2f(t,r.u_texsize),u_mix:new e.Uniform1f(t,r.u_mix),u_pattern_size_a:new e.Uniform2f(t,r.u_pattern_size_a),u_pattern_size_b:new e.Uniform2f(t,r.u_pattern_size_b),u_scale_a:new e.Uniform1f(t,r.u_scale_a),u_scale_b:new e.Uniform1f(t,r.u_scale_b),u_pixel_coord_upper:new e.Uniform2f(t,r.u_pixel_coord_upper),u_pixel_coord_lower:new e.Uniform2f(t,r.u_pixel_coord_lower),u_tile_units_to_pixels:new e.Uniform1f(t,r.u_tile_units_to_pixels)}),terrain:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_texture:new e.Uniform1i(t,r.u_texture)}),terrainDepth:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix)}),terrainCoords:(t,r)=>({u_matrix:new e.UniformMatrix4f(t,r.u_matrix),u_texture:new e.Uniform1i(t,r.u_texture),u_terrain_coords_id:new e.Uniform1f(t,r.u_terrain_coords_id)})};class Bt{constructor(e,t,r){this.context=e;const i=e.gl;this.buffer=i.createBuffer(),this.dynamicDraw=Boolean(r),this.context.unbindVAO(),e.bindElementBuffer.set(this.buffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.arrayBuffer,this.dynamicDraw?i.DYNAMIC_DRAW:i.STATIC_DRAW),this.dynamicDraw||delete t.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(e){const t=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),t.bufferSubData(t.ELEMENT_ARRAY_BUFFER,0,e.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const Rt={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Ft{constructor(e,t,r,i){this.length=t.length,this.attributes=r,this.itemSize=t.bytesPerElement,this.dynamicDraw=i,this.context=e;const n=e.gl;this.buffer=n.createBuffer(),e.bindVertexBuffer.set(this.buffer),n.bufferData(n.ARRAY_BUFFER,t.arrayBuffer,this.dynamicDraw?n.DYNAMIC_DRAW:n.STATIC_DRAW),this.dynamicDraw||delete t.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(e){if(e.length!==this.length)throw new Error(`Length of new data is ${e.length}, which doesn't match current length of ${this.length}`);const t=this.context.gl;this.bind(),t.bufferSubData(t.ARRAY_BUFFER,0,e.arrayBuffer)}enableAttributes(e,t){for(let r=0;r<this.attributes.length;r++){const i=t.attributes[this.attributes[r].name];void 0!==i&&e.enableVertexAttribArray(i)}}setVertexAttribPointers(e,t,r){for(let i=0;i<this.attributes.length;i++){const n=this.attributes[i],a=t.attributes[n.name];void 0!==a&&e.vertexAttribPointer(a,n.components,e[Rt[n.type]],!1,this.itemSize,n.offset+this.itemSize*(r||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Ot{constructor(e){this.gl=e.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(e){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Ut extends Ot{getDefault(){return e.Color.transparent}set(e){const t=this.current;(e.r!==t.r||e.g!==t.g||e.b!==t.b||e.a!==t.a||this.dirty)&&(this.gl.clearColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class Vt extends Ot{getDefault(){return 1}set(e){(e!==this.current||this.dirty)&&(this.gl.clearDepth(e),this.current=e,this.dirty=!1)}}class $t extends Ot{getDefault(){return 0}set(e){(e!==this.current||this.dirty)&&(this.gl.clearStencil(e),this.current=e,this.dirty=!1)}}class Nt extends Ot{getDefault(){return[!0,!0,!0,!0]}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3]||this.dirty)&&(this.gl.colorMask(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class jt extends Ot{getDefault(){return!0}set(e){(e!==this.current||this.dirty)&&(this.gl.depthMask(e),this.current=e,this.dirty=!1)}}class qt extends Ot{getDefault(){return 255}set(e){(e!==this.current||this.dirty)&&(this.gl.stencilMask(e),this.current=e,this.dirty=!1)}}class Gt extends Ot{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(e){const t=this.current;(e.func!==t.func||e.ref!==t.ref||e.mask!==t.mask||this.dirty)&&(this.gl.stencilFunc(e.func,e.ref,e.mask),this.current=e,this.dirty=!1)}}class Zt extends Ot{getDefault(){const e=this.gl;return[e.KEEP,e.KEEP,e.KEEP]}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||this.dirty)&&(this.gl.stencilOp(e[0],e[1],e[2]),this.current=e,this.dirty=!1)}}class Xt extends Ot{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.current=e,this.dirty=!1}}class Wt extends Ot{getDefault(){return[0,1]}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||this.dirty)&&(this.gl.depthRange(e[0],e[1]),this.current=e,this.dirty=!1)}}class Ht extends Ot{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),this.current=e,this.dirty=!1}}class Kt extends Ot{getDefault(){return this.gl.LESS}set(e){(e!==this.current||this.dirty)&&(this.gl.depthFunc(e),this.current=e,this.dirty=!1)}}class Yt extends Ot{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.BLEND):t.disable(t.BLEND),this.current=e,this.dirty=!1}}class Jt extends Ot{getDefault(){const e=this.gl;return[e.ONE,e.ZERO]}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||this.dirty)&&(this.gl.blendFunc(e[0],e[1]),this.current=e,this.dirty=!1)}}class Qt extends Ot{getDefault(){return e.Color.transparent}set(e){const t=this.current;(e.r!==t.r||e.g!==t.g||e.b!==t.b||e.a!==t.a||this.dirty)&&(this.gl.blendColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class er extends Ot{getDefault(){return this.gl.FUNC_ADD}set(e){(e!==this.current||this.dirty)&&(this.gl.blendEquation(e),this.current=e,this.dirty=!1)}}class tr extends Ot{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE),this.current=e,this.dirty=!1}}class rr extends Ot{getDefault(){return this.gl.BACK}set(e){(e!==this.current||this.dirty)&&(this.gl.cullFace(e),this.current=e,this.dirty=!1)}}class ir extends Ot{getDefault(){return this.gl.CCW}set(e){(e!==this.current||this.dirty)&&(this.gl.frontFace(e),this.current=e,this.dirty=!1)}}class nr extends Ot{getDefault(){return null}set(e){(e!==this.current||this.dirty)&&(this.gl.useProgram(e),this.current=e,this.dirty=!1)}}class ar extends Ot{getDefault(){return this.gl.TEXTURE0}set(e){(e!==this.current||this.dirty)&&(this.gl.activeTexture(e),this.current=e,this.dirty=!1)}}class or extends Ot{getDefault(){const e=this.gl;return[0,0,e.drawingBufferWidth,e.drawingBufferHeight]}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3]||this.dirty)&&(this.gl.viewport(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class sr extends Ot{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e),this.current=e,this.dirty=!1}}class lr extends Ot{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindRenderbuffer(t.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class cr extends Ot{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindTexture(t.TEXTURE_2D,e),this.current=e,this.dirty=!1}}class ur extends Ot{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class hr extends Ot{getDefault(){return null}set(e){const t=this.gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class pr extends Ot{constructor(e){super(e),this.vao=e.extVertexArrayObject}getDefault(){return null}set(e){this.vao&&(e!==this.current||this.dirty)&&(this.vao.bindVertexArrayOES(e),this.current=e,this.dirty=!1)}}class dr extends Ot{getDefault(){return 4}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.pixelStorei(t.UNPACK_ALIGNMENT,e),this.current=e,this.dirty=!1}}class fr extends Ot{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e),this.current=e,this.dirty=!1}}class mr extends Ot{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e),this.current=e,this.dirty=!1}}class gr extends Ot{constructor(e,t){super(e),this.context=e,this.parent=t}getDefault(){return null}}class yr extends gr{setDirty(){this.dirty=!0}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const t=this.gl;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0),this.current=e,this.dirty=!1}}class _r extends gr{set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const t=this.gl;t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class xr{constructor(e,t,r,i){this.context=e,this.width=t,this.height=r;const n=e.gl,a=this.framebuffer=n.createFramebuffer();if(this.colorAttachment=new yr(e,a),i&&(this.depthAttachment=new _r(e,a)),n.checkFramebufferStatus(n.FRAMEBUFFER)!==n.FRAMEBUFFER_COMPLETE)throw new Error("Framebuffer is not complete")}destroy(){const e=this.context.gl,t=this.colorAttachment.get();if(t&&e.deleteTexture(t),this.depthAttachment){const t=this.depthAttachment.get();t&&e.deleteRenderbuffer(t)}e.deleteFramebuffer(this.framebuffer)}}class vr{constructor(e,t,r){this.blendFunction=e,this.blendColor=t,this.mask=r}}vr.Replace=[1,0],vr.disabled=new vr(vr.Replace,e.Color.transparent,[!1,!1,!1,!1]),vr.unblended=new vr(vr.Replace,e.Color.transparent,[!0,!0,!0,!0]),vr.alphaBlended=new vr([1,771],e.Color.transparent,[!0,!0,!0,!0]);class br{constructor(e){this.gl=e,this.extVertexArrayObject=this.gl.getExtension("OES_vertex_array_object"),this.clearColor=new Ut(this),this.clearDepth=new Vt(this),this.clearStencil=new $t(this),this.colorMask=new Nt(this),this.depthMask=new jt(this),this.stencilMask=new qt(this),this.stencilFunc=new Gt(this),this.stencilOp=new Zt(this),this.stencilTest=new Xt(this),this.depthRange=new Wt(this),this.depthTest=new Ht(this),this.depthFunc=new Kt(this),this.blend=new Yt(this),this.blendFunc=new Jt(this),this.blendColor=new Qt(this),this.blendEquation=new er(this),this.cullFace=new tr(this),this.cullFaceSide=new rr(this),this.frontFace=new ir(this),this.program=new nr(this),this.activeTexture=new ar(this),this.viewport=new or(this),this.bindFramebuffer=new sr(this),this.bindRenderbuffer=new lr(this),this.bindTexture=new cr(this),this.bindVertexBuffer=new ur(this),this.bindElementBuffer=new hr(this),this.bindVertexArrayOES=this.extVertexArrayObject&&new pr(this),this.pixelStoreUnpack=new dr(this),this.pixelStoreUnpackPremultiplyAlpha=new fr(this),this.pixelStoreUnpackFlipY=new mr(this),this.extTextureFilterAnisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=e.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureHalfFloat=e.getExtension("OES_texture_half_float"),this.extTextureHalfFloat&&(e.getExtension("OES_texture_half_float_linear"),this.extRenderToTextureHalfFloat=e.getExtension("EXT_color_buffer_half_float")),this.extTimerQuery=e.getExtension("EXT_disjoint_timer_query"),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.extVertexArrayObject&&(this.bindVertexArrayOES.dirty=!0),this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(e,t){return new Bt(this,e,t)}createVertexBuffer(e,t,r){return new Ft(this,e,t,r)}createRenderbuffer(e,t,r){const i=this.gl,n=i.createRenderbuffer();return this.bindRenderbuffer.set(n),i.renderbufferStorage(i.RENDERBUFFER,e,t,r),this.bindRenderbuffer.set(null),n}createFramebuffer(e,t,r){return new xr(this,e,t,r)}clear({color:e,depth:t}){const r=this.gl;let i=0;e&&(i|=r.COLOR_BUFFER_BIT,this.clearColor.set(e),this.colorMask.set([!0,!0,!0,!0])),void 0!==t&&(i|=r.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(t),this.depthMask.set(!0)),r.clear(i)}setCullFace(e){!1===e.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(e.mode),this.frontFace.set(e.frontFace))}setDepthMode(e){e.func!==this.gl.ALWAYS||e.mask?(this.depthTest.set(!0),this.depthFunc.set(e.func),this.depthMask.set(e.mask),this.depthRange.set(e.range)):this.depthTest.set(!1)}setStencilMode(e){e.test.func!==this.gl.ALWAYS||e.mask?(this.stencilTest.set(!0),this.stencilMask.set(e.mask),this.stencilOp.set([e.fail,e.depthFail,e.pass]),this.stencilFunc.set({func:e.test.func,ref:e.ref,mask:e.test.mask})):this.stencilTest.set(!1)}setColorMode(e){n(e.blendFunction,vr.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(e.blendFunction),this.blendColor.set(e.blendColor)),this.colorMask.set(e.mask)}unbindVAO(){this.extVertexArrayObject&&this.bindVertexArrayOES.set(null)}}class wr{constructor(e,t,r){this.func=e,this.mask=t,this.range=r}}wr.ReadOnly=!1,wr.ReadWrite=!0,wr.disabled=new wr(519,wr.ReadOnly,[0,1]);const Tr=7680;class Er{constructor(e,t,r,i,n,a){this.test=e,this.ref=t,this.mask=r,this.fail=i,this.depthFail=n,this.pass=a}}Er.disabled=new Er({func:519,mask:0},0,0,Tr,Tr,Tr);class Sr{constructor(e,t,r){this.enable=e,this.mode=t,this.frontFace=r}}let Ar;function Ir(t,r,i,n,a,o,s){const l=t.context,c=l.gl,u=t.useProgram("collisionBox"),h=[];let p=0,d=0;for(let f=0;f<n.length;f++){const m=n[f],g=r.getTile(m),y=g.getBucket(i);if(!y)continue;let _=m.posMatrix;0===a[0]&&0===a[1]||(_=t.translatePosMatrix(m.posMatrix,g,a,o));const x=s?y.textCollisionBox:y.iconCollisionBox,v=y.collisionCircleArray;if(v.length>0){const r=e.create(),i=_;e.mul(r,y.placementInvProjMatrix,t.transform.glCoordMatrix),e.mul(r,r,y.placementViewportMatrix),h.push({circleArray:v,circleOffset:d,transform:i,invTransform:r,coord:m}),p+=v.length/4,d=p}x&&u.draw(l,c.LINES,wr.disabled,Er.disabled,t.colorModeForRenderPass(),Sr.disabled,gt(_,t.transform,g),t.style.terrain&&t.style.terrain.getTerrainData(m),i.id,x.layoutVertexBuffer,x.indexBuffer,x.segments,null,t.transform.zoom,null,null,x.collisionVertexBuffer)}if(!s||!h.length)return;const f=t.useProgram("collisionCircle"),m=new e.CollisionCircleLayoutArray;m.resize(4*p),m._trim();let g=0;for(const e of h)for(let t=0;t<e.circleArray.length/4;t++){const r=4*t,i=e.circleArray[r+0],n=e.circleArray[r+1],a=e.circleArray[r+2],o=e.circleArray[r+3];m.emplace(g++,i,n,a,o,0),m.emplace(g++,i,n,a,o,1),m.emplace(g++,i,n,a,o,2),m.emplace(g++,i,n,a,o,3)}(!Ar||Ar.length<2*p)&&(Ar=function(t){const r=2*t,i=new e.QuadTriangleArray;i.resize(r),i._trim();for(let e=0;e<r;e++){const t=6*e;i.uint16[t+0]=4*e+0,i.uint16[t+1]=4*e+1,i.uint16[t+2]=4*e+2,i.uint16[t+3]=4*e+2,i.uint16[t+4]=4*e+3,i.uint16[t+5]=4*e+0}return i}(p));const y=l.createIndexBuffer(Ar,!0),_=l.createVertexBuffer(m,e.collisionCircleLayout.members,!0);for(const r of h){const n={u_matrix:r.transform,u_inv_matrix:r.invTransform,u_camera_to_center_distance:(x=t.transform).cameraToCenterDistance,u_viewport_size:[x.width,x.height]};f.draw(l,c.TRIANGLES,wr.disabled,Er.disabled,t.colorModeForRenderPass(),Sr.disabled,n,t.style.terrain&&t.style.terrain.getTerrainData(r.coord),i.id,_,y,e.SegmentVector.simpleSegment(0,2*r.circleOffset,r.circleArray.length,r.circleArray.length/2),null,t.transform.zoom,null,null,null)}var x;_.destroy(),y.destroy()}Sr.disabled=new Sr(!1,1029,2305),Sr.backCCW=new Sr(!0,1029,2305);const kr=e.identity(new Float32Array(16));function Cr(t,r,i,n,a,o){const{horizontalAlign:s,verticalAlign:l}=e.getAnchorAlignment(t),c=-(s-.5)*r,u=-(l-.5)*i,h=e.evaluateVariableOffset(t,n);return new e.pointGeometry((c/a+h[0])*o,(u/a+h[1])*o)}function zr(t,r,i,n,a,o,s,l,c,u,h){const p=t.text.placedSymbolArray,d=t.text.dynamicLayoutVertexArray,f=t.icon.dynamicLayoutVertexArray,m={};d.clear();for(let f=0;f<p.length;f++){const g=p.get(f),y=t.allowVerticalPlacement&&!g.placedOrientation,_=g.hidden||!g.crossTileID||y?null:n[g.crossTileID];if(_){const n=new e.pointGeometry(g.anchorX,g.anchorY),p=se(n,i?s:o,h),f=le(a.cameraToCenterDistance,p.signedDistanceFromCamera);let y=e.evaluateSizeForFeature(t.textSizeData,c,g)*f/e.ONE_EM;i&&(y*=t.tilePixelRatio/l);const{width:x,height:v,anchor:b,textOffset:w,textBoxScale:T}=_,E=Cr(b,x,v,w,T,y),S=i?se(n.add(E),o,h).point:p.point.add(r?E.rotate(-a.angle):E),A=t.allowVerticalPlacement&&g.placedOrientation===e.WritingMode.vertical?Math.PI/2:0;for(let t=0;t<g.numGlyphs;t++)e.addDynamicAttributes(d,S,A);u&&g.associatedIconIndex>=0&&(m[g.associatedIconIndex]={shiftedAnchor:S,angle:A})}else ye(g.numGlyphs,d)}if(u){f.clear();const r=t.icon.placedSymbolArray;for(let t=0;t<r.length;t++){const i=r.get(t);if(i.hidden)ye(i.numGlyphs,f);else{const r=m[t];if(r)for(let t=0;t<i.numGlyphs;t++)e.addDynamicAttributes(f,r.shiftedAnchor,r.angle);else ye(i.numGlyphs,f)}}t.icon.dynamicLayoutVertexBuffer.updateData(f)}t.text.dynamicLayoutVertexBuffer.updateData(d)}function Mr(e,t,r){return r.iconsInText&&t?"symbolTextAndIcon":e?"symbolSDF":"symbolIcon"}function Pr(t,r,i,n,a,o,s,l,c,u,h,p){const d=t.context,f=d.gl,m=t.transform,g="map"===l,y="map"===c,_="viewport"!==l&&"point"!==i.layout.get("symbol-placement"),x=g&&!y&&!_,v=!i.layout.get("symbol-sort-key").isConstant();let b=!1;const w=t.depthModeForSublayer(0,wr.ReadOnly),T=i.layout.get("text-variable-anchor"),E=[];for(const l of n){const n=r.getTile(l),c=n.getBucket(i);if(!c)continue;const h=a?c.text:c.icon;if(!h||!h.segments.get().length)continue;const p=h.programConfigurations.get(i.id),d=a||c.sdfIcons,w=a?c.textSizeData:c.iconSizeData,S=y||0!==m.pitch,A=t.useProgram(Mr(d,a,c),p),I=e.evaluateSizeForZoom(w,m.zoom),k=t.style.terrain&&t.style.terrain.getTerrainData(l);let C,z,M,P,D=[0,0],L=null;if(a){if(z=n.glyphAtlasTexture,M=f.LINEAR,C=n.glyphAtlasTexture.size,c.iconsInText){D=n.imageAtlasTexture.size,L=n.imageAtlasTexture;const e="composite"===w.kind||"camera"===w.kind;P=S||t.options.rotating||t.options.zooming||e?f.LINEAR:f.NEAREST}}else{const e=1!==i.layout.get("icon-size").constantOr(0)||c.iconsNeedLinear;z=n.imageAtlasTexture,M=d||t.options.rotating||t.options.zooming||e||S?f.LINEAR:f.NEAREST,C=n.imageAtlasTexture.size}const B=be(n,1,t.transform.zoom),R=ae(l.posMatrix,y,g,t.transform,B),F=oe(l.posMatrix,y,g,t.transform,B),O=T&&c.hasTextData(),U="none"!==i.layout.get("icon-text-fit")&&O&&c.hasIconData();if(_){const e=t.style.terrain?(e,r)=>t.style.terrain.getElevation(l,e,r):null,r="map"===i.layout.get("text-rotation-alignment");ue(c,l.posMatrix,t,a,R,F,y,u,r,e)}const V=t.translatePosMatrix(l.posMatrix,n,o,s),$=_||a&&T||U?kr:R,N=t.translatePosMatrix(F,n,o,s,!0),j=d&&0!==i.paint.get(a?"text-halo-width":"icon-halo-width").constantOr(1);let q;q=d?c.iconsInText?Mt(w.kind,I,x,y,t,V,$,N,C,D):zt(w.kind,I,x,y,t,V,$,N,a,C,!0):Ct(w.kind,I,x,y,t,V,$,N,a,C);const G={program:A,buffers:h,uniformValues:q,atlasTexture:z,atlasTextureIcon:L,atlasInterpolation:M,atlasInterpolationIcon:P,isSDF:d,hasHalo:j};if(v&&c.canOverlap){b=!0;const t=h.segments.get();for(const r of t)E.push({segments:new e.SegmentVector([r]),sortKey:r.sortKey,state:G,terrainData:k})}else E.push({segments:h.segments,sortKey:0,state:G,terrainData:k})}b&&E.sort(((e,t)=>e.sortKey-t.sortKey));for(const e of E){const r=e.state;if(d.activeTexture.set(f.TEXTURE0),r.atlasTexture.bind(r.atlasInterpolation,f.CLAMP_TO_EDGE),r.atlasTextureIcon&&(d.activeTexture.set(f.TEXTURE1),r.atlasTextureIcon&&r.atlasTextureIcon.bind(r.atlasInterpolationIcon,f.CLAMP_TO_EDGE)),r.isSDF){const n=r.uniformValues;r.hasHalo&&(n.u_is_halo=1,Dr(r.buffers,e.segments,i,t,r.program,w,h,p,n,e.terrainData)),n.u_is_halo=0}Dr(r.buffers,e.segments,i,t,r.program,w,h,p,r.uniformValues,e.terrainData)}}function Dr(e,t,r,i,n,a,o,s,l,c){const u=i.context;n.draw(u,u.gl.TRIANGLES,a,o,s,Sr.disabled,l,c,r.id,e.layoutVertexBuffer,e.indexBuffer,t,r.paint,i.transform.zoom,e.programConfigurations.get(r.id),e.dynamicLayoutVertexBuffer,e.opacityVertexBuffer)}function Lr(e,t,r,i,n,a,o){const s=e.context.gl,l=r.paint.get("fill-pattern"),c=l&&l.constantOr(1),u=r.getCrossfadeParameters();let h,p,d,f,m;o?(p=c&&!r.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",h=s.LINES):(p=c?"fillPattern":"fill",h=s.TRIANGLES);for(const g of i){const i=t.getTile(g);if(c&&!i.patternsLoaded())continue;const y=i.getBucket(r);if(!y)continue;const _=y.programConfigurations.get(r.id),x=e.useProgram(p,_),v=e.style.terrain&&e.style.terrain.getTerrainData(g);c&&(e.context.activeTexture.set(s.TEXTURE0),i.imageAtlasTexture.bind(s.LINEAR,s.CLAMP_TO_EDGE),_.updatePaintBuffers(u));const b=l.constantOr(null);if(b&&i.imageAtlas){const e=i.imageAtlas,t=e.patternPositions[b.to.toString()],r=e.patternPositions[b.from.toString()];t&&r&&_.setConstantPatternPositions(t,r)}const w=v?g:null,T=e.translatePosMatrix(w?w.posMatrix:g.posMatrix,i,r.paint.get("fill-translate"),r.paint.get("fill-translate-anchor"));if(o){f=y.indexBuffer2,m=y.segments2;const t=[s.drawingBufferWidth,s.drawingBufferHeight];d="fillOutlinePattern"===p&&c?ft(T,e,u,i,t):dt(T,t)}else f=y.indexBuffer,m=y.segments,d=c?pt(T,e,u,i):ht(T);x.draw(e.context,h,n,e.stencilModeForClipping(g),a,Sr.disabled,d,v,r.id,y.layoutVertexBuffer,f,m,r.paint,e.transform.zoom,_)}}function Br(e,t,r,i,n,a,o){const s=e.context,l=s.gl,c=r.paint.get("fill-extrusion-pattern"),u=c.constantOr(1),h=r.getCrossfadeParameters(),p=r.paint.get("fill-extrusion-opacity");for(const d of i){const i=t.getTile(d),f=i.getBucket(r);if(!f)continue;const m=e.style.terrain&&e.style.terrain.getTerrainData(d),g=f.programConfigurations.get(r.id),y=e.useProgram(u?"fillExtrusionPattern":"fillExtrusion",g);u&&(e.context.activeTexture.set(l.TEXTURE0),i.imageAtlasTexture.bind(l.LINEAR,l.CLAMP_TO_EDGE),g.updatePaintBuffers(h));const _=c.constantOr(null);if(_&&i.imageAtlas){const e=i.imageAtlas,t=e.patternPositions[_.to.toString()],r=e.patternPositions[_.from.toString()];t&&r&&g.setConstantPatternPositions(t,r)}const x=e.translatePosMatrix(d.posMatrix,i,r.paint.get("fill-extrusion-translate"),r.paint.get("fill-extrusion-translate-anchor")),v=r.paint.get("fill-extrusion-vertical-gradient"),b=u?ut(x,e,v,p,d,h,i):ct(x,e,v,p);y.draw(s,s.gl.TRIANGLES,n,a,o,Sr.backCCW,b,m,r.id,f.layoutVertexBuffer,f.indexBuffer,f.segments,r.paint,e.transform.zoom,g,e.style.terrain&&f.centroidVertexBuffer)}}function Rr(e,t,r,i,n,a,o){const s=e.context,l=s.gl,c=r.fbo;if(!c)return;const u=e.useProgram("hillshade"),h=e.style.terrain&&e.style.terrain.getTerrainData(t);s.activeTexture.set(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,c.colorAttachment.get()),u.draw(s,l.TRIANGLES,n,a,o,Sr.disabled,((e,t,r,i)=>{const n=r.paint.get("hillshade-shadow-color"),a=r.paint.get("hillshade-highlight-color"),o=r.paint.get("hillshade-accent-color");let s=r.paint.get("hillshade-illumination-direction")*(Math.PI/180);"viewport"===r.paint.get("hillshade-illumination-anchor")&&(s-=e.transform.angle);const l=!e.options.moving;return{u_matrix:i?i.posMatrix:e.transform.calculatePosMatrix(t.tileID.toUnwrapped(),l),u_image:0,u_latrange:vt(0,t.tileID),u_light:[r.paint.get("hillshade-exaggeration"),s],u_shadow:n,u_highlight:a,u_accent:o}})(e,r,i,h?t:null),h,i.id,e.rasterBoundsBuffer,e.quadTriangleIndexBuffer,e.rasterBoundsSegments)}function Fr(t,r,i,n,a,o){const s=t.context,c=s.gl,u=r.dem;if(u&&u.data){const h=u.dim,p=u.stride,d=u.getPixels();if(s.activeTexture.set(c.TEXTURE1),s.pixelStoreUnpackPremultiplyAlpha.set(!1),r.demTexture=r.demTexture||t.getTileTexture(p),r.demTexture){const e=r.demTexture;e.update(d,{premultiply:!1}),e.bind(c.NEAREST,c.CLAMP_TO_EDGE)}else r.demTexture=new l(s,d,c.RGBA,{premultiply:!1}),r.demTexture.bind(c.NEAREST,c.CLAMP_TO_EDGE);s.activeTexture.set(c.TEXTURE0);let f=r.fbo;if(!f){const e=new l(s,{width:h,height:h,data:null},c.RGBA);e.bind(c.LINEAR,c.CLAMP_TO_EDGE),f=r.fbo=s.createFramebuffer(h,h,!0),f.colorAttachment.set(e.texture)}s.bindFramebuffer.set(f.framebuffer),s.viewport.set([0,0,h,h]),t.useProgram("hillshadePrepare").draw(s,c.TRIANGLES,n,a,o,Sr.disabled,((t,r)=>{const i=r.stride,n=e.create();return e.ortho(n,0,e.EXTENT,-e.EXTENT,0,0,1),e.translate(n,n,[0,-e.EXTENT,0]),{u_matrix:n,u_image:1,u_dimension:[i,i],u_zoom:t.overscaledZ,u_unpack:r.getUnpackVector()}})(r.tileID,u),null,i.id,t.rasterBoundsBuffer,t.quadTriangleIndexBuffer,t.rasterBoundsSegments),r.needsHillshadePrepare=!1}}function Or(t,r,i,n,a,o){const s=n.paint.get("raster-fade-duration");if(!o&&s>0){const n=e.exported.now(),o=(n-t.timeAdded)/s,l=r?(n-r.timeAdded)/s:-1,c=i.getSource(),u=a.coveringZoomLevel({tileSize:c.tileSize,roundZoom:c.roundZoom}),h=!r||Math.abs(r.tileID.overscaledZ-u)>Math.abs(t.tileID.overscaledZ-u),p=h&&t.refreshedUponExpiration?1:e.clamp(h?o:1-l,0,1);return t.refreshedUponExpiration&&o>=1&&(t.refreshedUponExpiration=!1),r?{opacity:1,mix:1-p}:{opacity:p,mix:0}}return{opacity:1,mix:0}}const Ur=new e.Color(1,0,0,1),Vr=new e.Color(0,1,0,1),$r=new e.Color(0,0,1,1),Nr=new e.Color(1,0,1,1),jr=new e.Color(0,1,1,1);function qr(e,t,r,i){Zr(e,0,t+r/2,e.transform.width,r,i)}function Gr(e,t,r,i){Zr(e,t-r/2,0,r,e.transform.height,i)}function Zr(e,t,r,i,n,a){const o=e.context,s=o.gl;s.enable(s.SCISSOR_TEST),s.scissor(t*e.pixelRatio,r*e.pixelRatio,i*e.pixelRatio,n*e.pixelRatio),o.clear({color:a}),s.disable(s.SCISSOR_TEST)}function Xr(t,r,i){const n=t.context,a=n.gl,o=i.posMatrix,s=t.useProgram("debug"),l=wr.disabled,c=Er.disabled,u=t.colorModeForRenderPass(),h="$debug",p=t.style.terrain&&t.style.terrain.getTerrainData(i);n.activeTexture.set(a.TEXTURE0),t.emptyTexture.bind(a.LINEAR,a.CLAMP_TO_EDGE);const d=r.getTileByID(i.key).latestRawTileData,f=Math.floor((d&&d.byteLength||0)/1024),m=r.getTile(i).tileSize,g=512/Math.min(m,512)*(i.overscaledZ/t.transform.zoom)*.5;let y=i.canonical.toString();i.overscaledZ!==i.canonical.z&&(y+=` => ${i.overscaledZ}`),function(e,t){e.initDebugOverlayCanvas();const r=e.debugOverlayCanvas,i=e.context.gl,n=e.debugOverlayCanvas.getContext("2d");n.clearRect(0,0,r.width,r.height),n.shadowColor="white",n.shadowBlur=2,n.lineWidth=1.5,n.strokeStyle="white",n.textBaseline="top",n.font="bold 36px Open Sans, sans-serif",n.fillText(t,5,5),n.strokeText(t,5,5),e.debugOverlayTexture.update(r),e.debugOverlayTexture.bind(i.LINEAR,i.CLAMP_TO_EDGE)}(t,`${y} ${f}kB`),s.draw(n,a.TRIANGLES,l,c,vr.alphaBlended,Sr.disabled,yt(o,e.Color.transparent,g),null,h,t.debugBuffer,t.quadTriangleIndexBuffer,t.debugSegments),s.draw(n,a.LINE_STRIP,l,c,u,Sr.disabled,yt(o,e.Color.red),p,h,t.debugBuffer,t.tileBorderIndexBuffer,t.debugSegments)}function Wr(e,t,r){const i=e.context,n=i.gl,a=e.colorModeForRenderPass(),o=new wr(n.LEQUAL,wr.ReadWrite,e.depthRangeFor3D),s=e.useProgram("terrain"),l=t.getTerrainMesh(),c=t.getTerrainData(r.tileID);i.bindFramebuffer.set(null),i.viewport.set([0,0,e.width,e.height]),i.activeTexture.set(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,t.getRTTFramebuffer().colorAttachment.get());const u=e.transform.calculatePosMatrix(r.tileID.toUnwrapped());s.draw(i,n.TRIANGLES,o,Er.disabled,a,Sr.backCCW,{u_matrix:u,u_texture:0},c,"terrain",l.vertexBuffer,l.indexBuffer,l.segments)}function Hr(e,t,r,i){const n=e.context,a=r.tileSize*t.qualityFactor;r.textures[i]||(r.textures[i]=e.getTileTexture(a)||new l(n,{width:a,height:a,data:null},n.gl.RGBA),r.textures[i].bind(n.gl.LINEAR,n.gl.CLAMP_TO_EDGE),0===i&&t.sourceCache.renderHistory.unshift(r.tileID.key));const o=t.getRTTFramebuffer();o.colorAttachment.set(r.textures[i].texture),n.bindFramebuffer.set(o.framebuffer),n.viewport.set([0,0,a,a])}class Kr{constructor(e){this._coordsDescendingInv={},this._coordsDescendingInvStr={},this.painter=e,this._renderToTexture={background:!0,fill:!0,line:!0,raster:!0},this._coordsDescendingInv={},this._coordsDescendingInvStr={},this._stacks=[],this._prevType=null,this._rerender={},this._renderableTiles=e.style.terrain.sourceCache.getRenderableTiles(),this._init()}_init(){const e=this.painter.style,t=e.terrain;for(const r in e.sourceCaches){this._coordsDescendingInv[r]={};const i=e.sourceCaches[r].getVisibleCoordinates();for(const e of i){const i=t.sourceCache.getTerrainCoords(e);for(const e in i)this._coordsDescendingInv[r][e]||(this._coordsDescendingInv[r][e]=[]),this._coordsDescendingInv[r][e].push(i[e])}}for(const t of e._order){const r=e._layers[t],i=r.source;if(this._renderToTexture[r.type]&&!this._coordsDescendingInvStr[i]){this._coordsDescendingInvStr[i]={};for(const e in this._coordsDescendingInv[i])this._coordsDescendingInvStr[i][e]=this._coordsDescendingInv[i][e].map((e=>e.key)).sort().join()}}return this._renderableTiles.forEach((e=>{for(const r in this._coordsDescendingInvStr){const i=this._coordsDescendingInvStr[r][e.tileID.key];i&&i!==e.textureCoords[r]&&e.clearTextures(this.painter),t.needsRerender(r,e.tileID)&&e.clearTextures(this.painter)}this._rerender[e.tileID.key]=!e.textures.length})),t.clearRerenderCache(),t.sourceCache.removeOutdated(this.painter),this}renderLayer(t){const r=t.type,i=this.painter,n=i.style._order,a=i.currentLayer,o=a+1===n.length;if(this._renderToTexture[r]&&(this._prevType&&this._renderToTexture[this._prevType]||this._stacks.push([]),this._prevType=r,this._stacks[this._stacks.length-1].push(n[a]),!o))return!0;if(this._renderToTexture[this._prevType]||"hillshade"===r||this._renderToTexture[r]&&o){this._prevType=r;const o=this._stacks.length-1,s=this._stacks[o]||[];for(const t of this._renderableTiles){if(Hr(i,i.style.terrain,t,o),this._rerender[t.tileID.key]){i.context.clear({color:e.Color.transparent});for(let e=0;e<s.length;e++){const r=i.style._layers[s[e]],n=r.source?this._coordsDescendingInv[r.source][t.tileID.key]:[t.tileID];i._renderTileClippingMasks(r,n),i.renderLayer(i,i.style.sourceCaches[r.source],r,n),r.source&&(t.textureCoords[r.source]=this._coordsDescendingInvStr[r.source][t.tileID.key])}}Wr(i,i.style.terrain,t)}if("hillshade"===r){this._stacks.push([n[a]]);for(const r of this._renderableTiles){const n=this._coordsDescendingInv[t.source][r.tileID.key];Hr(i,i.style.terrain,r,this._stacks.length-1),i.context.clear({color:e.Color.transparent}),i._renderTileClippingMasks(t,n),i.renderLayer(i,i.style.sourceCaches[t.source],t,n),Wr(i,i.style.terrain,r)}return!0}return this._renderToTexture[r]}return!1}}const Yr={symbol:function(t,r,i,n,a){if("translucent"!==t.renderPass)return;const o=Er.disabled,s=t.colorModeForRenderPass();i.layout.get("text-variable-anchor")&&function(t,r,i,n,a,o,s){const l=r.transform,c="map"===a,u="map"===o;for(const a of t){const t=n.getTile(a),o=t.getBucket(i);if(!o||!o.text||!o.text.segments.get().length)continue;const h=e.evaluateSizeForZoom(o.textSizeData,l.zoom),p=be(t,1,r.transform.zoom),d=ae(a.posMatrix,u,c,r.transform,p),f="none"!==i.layout.get("icon-text-fit")&&o.hasIconData();if(h){const e=Math.pow(2,l.zoom-t.tileID.overscaledZ);zr(o,c,u,s,l,d,a.posMatrix,e,h,f,r.style.terrain?(e,t)=>r.style.terrain.getElevation(a,e,t):null)}}}(n,t,i,r,i.layout.get("text-rotation-alignment"),i.layout.get("text-pitch-alignment"),a),0!==i.paint.get("icon-opacity").constantOr(1)&&Pr(t,r,i,n,!1,i.paint.get("icon-translate"),i.paint.get("icon-translate-anchor"),i.layout.get("icon-rotation-alignment"),i.layout.get("icon-pitch-alignment"),i.layout.get("icon-keep-upright"),o,s),0!==i.paint.get("text-opacity").constantOr(1)&&Pr(t,r,i,n,!0,i.paint.get("text-translate"),i.paint.get("text-translate-anchor"),i.layout.get("text-rotation-alignment"),i.layout.get("text-pitch-alignment"),i.layout.get("text-keep-upright"),o,s),r.map.showCollisionBoxes&&(Ir(t,r,i,n,i.paint.get("text-translate"),i.paint.get("text-translate-anchor"),!0),Ir(t,r,i,n,i.paint.get("icon-translate"),i.paint.get("icon-translate-anchor"),!1))},circle:function(t,r,i,n){if("translucent"!==t.renderPass)return;const a=i.paint.get("circle-opacity"),o=i.paint.get("circle-stroke-width"),s=i.paint.get("circle-stroke-opacity"),l=!i.layout.get("circle-sort-key").isConstant();if(0===a.constantOr(1)&&(0===o.constantOr(1)||0===s.constantOr(1)))return;const c=t.context,u=c.gl,h=t.depthModeForSublayer(0,wr.ReadOnly),p=Er.disabled,d=t.colorModeForRenderPass(),f=[];for(let a=0;a<n.length;a++){const o=n[a],s=r.getTile(o),c=s.getBucket(i);if(!c)continue;const u=c.programConfigurations.get(i.id),h=t.useProgram("circle",u),p=c.layoutVertexBuffer,d=c.indexBuffer,m=t.style.terrain&&t.style.terrain.getTerrainData(o),g={programConfiguration:u,program:h,layoutVertexBuffer:p,indexBuffer:d,uniformValues:mt(t,o,s,i),terrainData:m};if(l){const t=c.segments.get();for(const r of t)f.push({segments:new e.SegmentVector([r]),sortKey:r.sortKey,state:g})}else f.push({segments:c.segments,sortKey:0,state:g})}l&&f.sort(((e,t)=>e.sortKey-t.sortKey));for(const e of f){const{programConfiguration:r,program:n,layoutVertexBuffer:a,indexBuffer:o,uniformValues:s,terrainData:l}=e.state;n.draw(c,u.TRIANGLES,h,p,d,Sr.disabled,s,l,i.id,a,o,e.segments,i.paint,t.transform.zoom,r)}},heatmap:function(t,r,i,n){if(0!==i.paint.get("heatmap-opacity"))if("offscreen"===t.renderPass){const a=t.context,o=a.gl,s=Er.disabled,l=new vr([o.ONE,o.ONE],e.Color.transparent,[!0,!0,!0,!0]);!function(e,t,r){const i=e.gl;e.activeTexture.set(i.TEXTURE1),e.viewport.set([0,0,t.width/4,t.height/4]);let n=r.heatmapFbo;if(n)i.bindTexture(i.TEXTURE_2D,n.colorAttachment.get()),e.bindFramebuffer.set(n.framebuffer);else{const a=i.createTexture();i.bindTexture(i.TEXTURE_2D,a),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),n=r.heatmapFbo=e.createFramebuffer(t.width/4,t.height/4,!1),function(e,t,r,i){const n=e.gl;n.texImage2D(n.TEXTURE_2D,0,n.RGBA,t.width/4,t.height/4,0,n.RGBA,e.extRenderToTextureHalfFloat?e.extTextureHalfFloat.HALF_FLOAT_OES:n.UNSIGNED_BYTE,null),i.colorAttachment.set(r)}(e,t,a,n)}}(a,t,i),a.clear({color:e.Color.transparent});for(let e=0;e<n.length;e++){const c=n[e];if(r.hasRenderableParent(c))continue;const u=r.getTile(c),h=u.getBucket(i);if(!h)continue;const p=h.programConfigurations.get(i.id),d=t.useProgram("heatmap",p),{zoom:f}=t.transform;d.draw(a,o.TRIANGLES,wr.disabled,s,l,Sr.disabled,xt(c.posMatrix,u,f,i.paint.get("heatmap-intensity")),null,i.id,h.layoutVertexBuffer,h.indexBuffer,h.segments,i.paint,t.transform.zoom,p)}a.viewport.set([0,0,t.width,t.height])}else"translucent"===t.renderPass&&(t.context.setColorMode(t.colorModeForRenderPass()),function(t,r){const i=t.context,n=i.gl,a=r.heatmapFbo;if(!a)return;i.activeTexture.set(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,a.colorAttachment.get()),i.activeTexture.set(n.TEXTURE1);let o=r.colorRampTexture;o||(o=r.colorRampTexture=new l(i,r.colorRamp,n.RGBA)),o.bind(n.LINEAR,n.CLAMP_TO_EDGE),t.useProgram("heatmapTexture").draw(i,n.TRIANGLES,wr.disabled,Er.disabled,t.colorModeForRenderPass(),Sr.disabled,((t,r,i,n)=>{const a=e.create();e.ortho(a,0,t.width,t.height,0,0,1);const o=t.context.gl;return{u_matrix:a,u_world:[o.drawingBufferWidth,o.drawingBufferHeight],u_image:0,u_color_ramp:1,u_opacity:r.paint.get("heatmap-opacity")}})(t,r),null,r.id,t.viewportBuffer,t.quadTriangleIndexBuffer,t.viewportSegments,r.paint,t.transform.zoom)}(t,i))},line:function(t,r,i,n){if("translucent"!==t.renderPass)return;const a=i.paint.get("line-opacity"),o=i.paint.get("line-width");if(0===a.constantOr(1)||0===o.constantOr(1))return;const s=t.depthModeForSublayer(0,wr.ReadOnly),c=t.colorModeForRenderPass(),u=i.paint.get("line-dasharray"),h=i.paint.get("line-pattern"),p=h.constantOr(1),d=i.paint.get("line-gradient"),f=i.getCrossfadeParameters(),m=p?"linePattern":u?"lineSDF":d?"lineGradient":"line",g=t.context,y=g.gl;let _=!0;for(const a of n){const n=r.getTile(a);if(p&&!n.patternsLoaded())continue;const o=n.getBucket(i);if(!o)continue;const x=o.programConfigurations.get(i.id),v=t.context.program.get(),b=t.useProgram(m,x),w=_||b.program!==v,T=t.style.terrain&&t.style.terrain.getTerrainData(a),E=h.constantOr(null);if(E&&n.imageAtlas){const e=n.imageAtlas,t=e.patternPositions[E.to.toString()],r=e.patternPositions[E.from.toString()];t&&r&&x.setConstantPatternPositions(t,r)}const S=T?a:null,A=p?Tt(t,n,i,f,S):u?Et(t,n,i,u,f,S):d?wt(t,n,i,o.lineClipsArray.length,S):bt(t,n,i,S);if(p)g.activeTexture.set(y.TEXTURE0),n.imageAtlasTexture.bind(y.LINEAR,y.CLAMP_TO_EDGE),x.updatePaintBuffers(f);else if(u&&(w||t.lineAtlas.dirty))g.activeTexture.set(y.TEXTURE0),t.lineAtlas.bind(g);else if(d){const n=o.gradients[i.id];let s=n.texture;if(i.gradientVersion!==n.version){let c=256;if(i.stepInterpolant){const i=r.getSource().maxzoom,n=a.canonical.z===i?Math.ceil(1<<t.transform.maxZoom-a.canonical.z):1;c=e.clamp(e.nextPowerOfTwo(o.maxLineLength/e.EXTENT*1024*n),256,g.maxTextureSize)}n.gradient=e.renderColorRamp({expression:i.gradientExpression(),evaluationKey:"lineProgress",resolution:c,image:n.gradient||void 0,clips:o.lineClipsArray}),n.texture?n.texture.update(n.gradient):n.texture=new l(g,n.gradient,y.RGBA),n.version=i.gradientVersion,s=n.texture}g.activeTexture.set(y.TEXTURE0),s.bind(i.stepInterpolant?y.NEAREST:y.LINEAR,y.CLAMP_TO_EDGE)}b.draw(g,y.TRIANGLES,s,t.stencilModeForClipping(a),c,Sr.disabled,A,T,i.id,o.layoutVertexBuffer,o.indexBuffer,o.segments,i.paint,t.transform.zoom,x,o.layoutVertexBuffer2),_=!1}},fill:function(t,r,i,n){const a=i.paint.get("fill-color"),o=i.paint.get("fill-opacity");if(0===o.constantOr(1))return;const s=t.colorModeForRenderPass(),l=i.paint.get("fill-pattern"),c=t.opaquePassEnabledForLayer()&&!l.constantOr(1)&&1===a.constantOr(e.Color.transparent).a&&1===o.constantOr(0)?"opaque":"translucent";if(t.renderPass===c){const e=t.depthModeForSublayer(1,"opaque"===t.renderPass?wr.ReadWrite:wr.ReadOnly);Lr(t,r,i,n,e,s,!1)}if("translucent"===t.renderPass&&i.paint.get("fill-antialias")){const e=t.depthModeForSublayer(i.getPaintProperty("fill-outline-color")?2:0,wr.ReadOnly);Lr(t,r,i,n,e,s,!0)}},"fill-extrusion":function(e,t,r,i){const n=r.paint.get("fill-extrusion-opacity");if(0!==n&&"translucent"===e.renderPass){const a=new wr(e.context.gl.LEQUAL,wr.ReadWrite,e.depthRangeFor3D);if(1!==n||r.paint.get("fill-extrusion-pattern").constantOr(1))Br(e,t,r,i,a,Er.disabled,vr.disabled),Br(e,t,r,i,a,e.stencilModeFor3D(),e.colorModeForRenderPass());else{const n=e.colorModeForRenderPass();Br(e,t,r,i,a,Er.disabled,n)}}},hillshade:function(e,t,r,i){if("offscreen"!==e.renderPass&&"translucent"!==e.renderPass)return;const n=e.context,a=e.depthModeForSublayer(0,wr.ReadOnly),o=e.colorModeForRenderPass(),[s,l]="translucent"===e.renderPass?e.stencilConfigForOverlap(i):[{},i];for(const i of l){const n=t.getTile(i);void 0!==n.needsHillshadePrepare&&n.needsHillshadePrepare&&"offscreen"===e.renderPass?Fr(e,n,r,a,Er.disabled,o):"translucent"===e.renderPass&&Rr(e,i,n,r,a,s[i.overscaledZ],o)}n.viewport.set([0,0,e.width,e.height])},raster:function(e,t,r,i){if("translucent"!==e.renderPass)return;if(0===r.paint.get("raster-opacity"))return;if(!i.length)return;const n=e.context,a=n.gl,o=t.getSource(),s=e.useProgram("raster"),l=e.colorModeForRenderPass(),[c,u]=o instanceof k?[{},i]:e.stencilConfigForOverlap(i),h=u[u.length-1].overscaledZ,p=!e.options.moving;for(const i of u){const u=e.depthModeForSublayer(i.overscaledZ-h,1===r.paint.get("raster-opacity")?wr.ReadWrite:wr.ReadOnly,a.LESS),d=t.getTile(i);d.registerFadeDuration(r.paint.get("raster-fade-duration"));const f=t.findLoadedParent(i,0),m=Or(d,f,t,r,e.transform,e.style.terrain);let g,y;const _="nearest"===r.paint.get("raster-resampling")?a.NEAREST:a.LINEAR;n.activeTexture.set(a.TEXTURE0),d.texture.bind(_,a.CLAMP_TO_EDGE,a.LINEAR_MIPMAP_NEAREST),n.activeTexture.set(a.TEXTURE1),f?(f.texture.bind(_,a.CLAMP_TO_EDGE,a.LINEAR_MIPMAP_NEAREST),g=Math.pow(2,f.tileID.overscaledZ-d.tileID.overscaledZ),y=[d.tileID.canonical.x*g%1,d.tileID.canonical.y*g%1]):d.texture.bind(_,a.CLAMP_TO_EDGE,a.LINEAR_MIPMAP_NEAREST);const x=e.style.terrain&&e.style.terrain.getTerrainData(i),v=x?i:null,b=v?v.posMatrix:e.transform.calculatePosMatrix(i.toUnwrapped(),p),w=It(b,y||[0,0],g||1,m,r);o instanceof k?s.draw(n,a.TRIANGLES,u,Er.disabled,l,Sr.disabled,w,x,r.id,o.boundsBuffer,e.quadTriangleIndexBuffer,o.boundsSegments):s.draw(n,a.TRIANGLES,u,c[i.overscaledZ],l,Sr.disabled,w,x,r.id,e.rasterBoundsBuffer,e.quadTriangleIndexBuffer,e.rasterBoundsSegments)}},background:function(e,t,r,i){const n=r.paint.get("background-color"),a=r.paint.get("background-opacity");if(0===a)return;const o=e.context,s=o.gl,l=e.transform,c=l.tileSize,u=r.paint.get("background-pattern");if(e.isPatternMissing(u))return;const h=!u&&1===n.a&&1===a&&e.opaquePassEnabledForLayer()?"opaque":"translucent";if(e.renderPass!==h)return;const p=Er.disabled,d=e.depthModeForSublayer(0,"opaque"===h?wr.ReadWrite:wr.ReadOnly),f=e.colorModeForRenderPass(),m=e.useProgram(u?"backgroundPattern":"background"),g=i||l.coveringTiles({tileSize:c,terrain:e.style.terrain});u&&(o.activeTexture.set(s.TEXTURE0),e.imageManager.bind(e.context));const y=r.getCrossfadeParameters();for(const t of g){const l=i?t.posMatrix:e.transform.calculatePosMatrix(t.toUnwrapped()),h=u?Dt(l,a,e,u,{tileID:t,tileSize:c},y):Pt(l,a,n),g=e.style.terrain&&e.style.terrain.getTerrainData(t);m.draw(o,s.TRIANGLES,d,p,f,Sr.disabled,h,g,r.id,e.tileExtentBuffer,e.quadTriangleIndexBuffer,e.tileExtentSegments)}},debug:function(e,t,r){for(let i=0;i<r.length;i++)Xr(e,t,r[i])},custom:function(e,t,r){const i=e.context,n=r.implementation;if("offscreen"===e.renderPass){const t=n.prerender;t&&(e.setCustomLayerDefaults(),i.setColorMode(e.colorModeForRenderPass()),t.call(n,i.gl,e.transform.customLayerMatrix()),i.setDirty(),e.setBaseState())}else if("translucent"===e.renderPass){e.setCustomLayerDefaults(),i.setColorMode(e.colorModeForRenderPass()),i.setStencilMode(Er.disabled);const t="3d"===n.renderingMode?new wr(e.context.gl.LEQUAL,wr.ReadWrite,e.depthRangeFor3D):e.depthModeForSublayer(0,wr.ReadOnly);i.setDepthMode(t),n.render(i.gl,e.transform.customLayerMatrix()),i.setDirty(),e.setBaseState(),i.bindFramebuffer.set(null)}}};class Jr{constructor(t,r){this.context=new br(t),this.transform=r,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:e.create(),renderTime:0},this.setup(),this.numSublayers=O.maxUnderzooming+O.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new Xe,this.gpuTimers={}}resize(e,t,r){if(this.width=e*r,this.height=t*r,this.pixelRatio=r,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const e of this.style._order)this.style._layers[e].resize()}setup(){const t=this.context,r=new e.PosArray;r.emplaceBack(0,0),r.emplaceBack(e.EXTENT,0),r.emplaceBack(0,e.EXTENT),r.emplaceBack(e.EXTENT,e.EXTENT),this.tileExtentBuffer=t.createVertexBuffer(r,We.members),this.tileExtentSegments=e.SegmentVector.simpleSegment(0,0,4,2);const i=new e.PosArray;i.emplaceBack(0,0),i.emplaceBack(e.EXTENT,0),i.emplaceBack(0,e.EXTENT),i.emplaceBack(e.EXTENT,e.EXTENT),this.debugBuffer=t.createVertexBuffer(i,We.members),this.debugSegments=e.SegmentVector.simpleSegment(0,0,4,5);const n=new e.RasterBoundsArray;n.emplaceBack(0,0,0,0),n.emplaceBack(e.EXTENT,0,e.EXTENT,0),n.emplaceBack(0,e.EXTENT,0,e.EXTENT),n.emplaceBack(e.EXTENT,e.EXTENT,e.EXTENT,e.EXTENT),this.rasterBoundsBuffer=t.createVertexBuffer(n,I.members),this.rasterBoundsSegments=e.SegmentVector.simpleSegment(0,0,4,2);const a=new e.PosArray;a.emplaceBack(0,0),a.emplaceBack(1,0),a.emplaceBack(0,1),a.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(a,We.members),this.viewportSegments=e.SegmentVector.simpleSegment(0,0,4,2);const o=new e.LineStripIndexArray;o.emplaceBack(0),o.emplaceBack(1),o.emplaceBack(3),o.emplaceBack(2),o.emplaceBack(0),this.tileBorderIndexBuffer=t.createIndexBuffer(o);const s=new e.TriangleIndexArray;s.emplaceBack(0,1,2),s.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(s),this.emptyTexture=new l(t,{width:1,height:1,data:new Uint8Array([0,0,0,0])},t.gl.RGBA);const c=this.context.gl;this.stencilClearMode=new Er({func:c.ALWAYS,mask:0},0,255,c.ZERO,c.ZERO,c.ZERO)}clearStencil(){const t=this.context,r=t.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const i=e.create();e.ortho(i,0,this.width,this.height,0,0,1),e.scale(i,i,[r.drawingBufferWidth,r.drawingBufferHeight,0]),this.useProgram("clippingMask").draw(t,r.TRIANGLES,wr.disabled,this.stencilClearMode,vr.disabled,Sr.disabled,_t(i),null,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(e,t){if(this.currentStencilSource===e.source||!e.isTileClipped()||!t||!t.length)return;this.currentStencilSource=e.source;const r=this.context,i=r.gl;this.nextStencilID+t.length>256&&this.clearStencil(),r.setColorMode(vr.disabled),r.setDepthMode(wr.disabled);const n=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const e of t){const t=this._tileClippingMaskIDs[e.key]=this.nextStencilID++,a=this.style.terrain&&this.style.terrain.getTerrainData(e);n.draw(r,i.TRIANGLES,wr.disabled,new Er({func:i.ALWAYS,mask:0},t,255,i.KEEP,i.KEEP,i.REPLACE),vr.disabled,Sr.disabled,_t(e.posMatrix),a,"$clipping",this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const e=this.nextStencilID++,t=this.context.gl;return new Er({func:t.NOTEQUAL,mask:255},e,255,t.KEEP,t.KEEP,t.REPLACE)}stencilModeForClipping(e){const t=this.context.gl;return new Er({func:t.EQUAL,mask:255},this._tileClippingMaskIDs[e.key],0,t.KEEP,t.KEEP,t.REPLACE)}stencilConfigForOverlap(e){const t=this.context.gl,r=e.sort(((e,t)=>t.overscaledZ-e.overscaledZ)),i=r[r.length-1].overscaledZ,n=r[0].overscaledZ-i+1;if(n>1){this.currentStencilSource=void 0,this.nextStencilID+n>256&&this.clearStencil();const e={};for(let r=0;r<n;r++)e[r+i]=new Er({func:t.GEQUAL,mask:255},r+this.nextStencilID,255,t.KEEP,t.KEEP,t.REPLACE);return this.nextStencilID+=n,[e,r]}return[{[i]:Er.disabled},r]}colorModeForRenderPass(){const t=this.context.gl;if(this._showOverdrawInspector){const r=1/8;return new vr([t.CONSTANT_COLOR,t.ONE],new e.Color(r,r,r,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?vr.unblended:vr.alphaBlended}depthModeForSublayer(e,t,r){if(!this.opaquePassEnabledForLayer())return wr.disabled;const i=1-((1+this.currentLayer)*this.numSublayers+e)*this.depthEpsilon;return new wr(r||this.context.gl.LEQUAL,t,[i,i])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(t,r){this.style=t,this.options=r,this.lineAtlas=t.lineAtlas,this.imageManager=t.imageManager,this.glyphManager=t.glyphManager,this.symbolFadeChange=t.placement.symbolFadeChange(e.exported.now()),this.imageManager.beginFrame();const i=this.style._order,n=this.style.sourceCaches,a=this.style.terrain&&new Kr(this);for(const e in n){const t=n[e];t.used&&t.prepare(this.context)}const o={},s={},l={};for(const e in n){const t=n[e];o[e]=t.getVisibleCoordinates(),s[e]=o[e].slice().reverse(),l[e]=t.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let e=0;e<i.length;e++)if(this.style._layers[i[e]].is3D()){this.opaquePassCutoff=e;break}if(a){this.opaquePassCutoff=0;const t=this.style.terrain.sourceCache.tilesAfterTime(this.terrainFacilitator.renderTime);(this.terrainFacilitator.dirty||!e.equals(this.terrainFacilitator.matrix,this.transform.projMatrix)||t.length)&&(e.copy(this.terrainFacilitator.matrix,this.transform.projMatrix),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,function(t,r){const i=t.context,n=i.gl,a=vr.unblended,o=new wr(n.LEQUAL,wr.ReadWrite,[0,1]),s=r.getTerrainMesh(),l=r.sourceCache.getRenderableTiles(),c=t.useProgram("terrainDepth");i.bindFramebuffer.set(r.getFramebuffer("depth").framebuffer),i.viewport.set([0,0,t.width/devicePixelRatio,t.height/devicePixelRatio]),i.clear({color:e.Color.transparent,depth:1});for(const e of l){const l=r.getTerrainData(e.tileID),u=t.transform.calculatePosMatrix(e.tileID.toUnwrapped());c.draw(i,n.TRIANGLES,o,Er.disabled,a,Sr.backCCW,{u_matrix:u},l,"terrain",s.vertexBuffer,s.indexBuffer,s.segments)}i.bindFramebuffer.set(null),i.viewport.set([0,0,t.width,t.height])}(this,this.style.terrain),function(t,r){const i=t.context,n=i.gl,a=vr.unblended,o=new wr(n.LEQUAL,wr.ReadWrite,[0,1]),s=r.getTerrainMesh(),l=r.getCoordsTexture(),c=r.sourceCache.getRenderableTiles(),u=t.useProgram("terrainCoords");i.bindFramebuffer.set(r.getFramebuffer("coords").framebuffer),i.viewport.set([0,0,t.width/devicePixelRatio,t.height/devicePixelRatio]),i.clear({color:e.Color.transparent,depth:1}),r.coordsIndex=[];for(const e of c){const c=r.getTerrainData(e.tileID);i.activeTexture.set(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,l.texture);const h=t.transform.calculatePosMatrix(e.tileID.toUnwrapped());u.draw(i,n.TRIANGLES,o,Er.disabled,a,Sr.backCCW,{u_matrix:h,u_terrain_coords_id:(255-r.coordsIndex.length)/255,u_texture:0},c,"terrain",s.vertexBuffer,s.indexBuffer,s.segments),r.coordsIndex.push(e.tileID.key)}i.bindFramebuffer.set(null),i.viewport.set([0,0,t.width,t.height])}(this,this.style.terrain))}this.renderPass="offscreen";for(const e of i){const t=this.style._layers[e];if(!t.hasOffscreenPass()||t.isHidden(this.transform.zoom))continue;const r=s[t.source];("custom"===t.type||r.length)&&this.renderLayer(this,n[t.source],t,r)}if(this.context.bindFramebuffer.set(null),this.context.clear({color:r.showOverdrawInspector?e.Color.black:e.Color.transparent,depth:1}),this.clearStencil(),this._showOverdrawInspector=r.showOverdrawInspector,this.depthRangeFor3D=[0,1-(t._order.length+2)*this.numSublayers*this.depthEpsilon],!a)for(this.renderPass="opaque",this.currentLayer=i.length-1;this.currentLayer>=0;this.currentLayer--){const e=this.style._layers[i[this.currentLayer]],t=n[e.source],r=o[e.source];this._renderTileClippingMasks(e,r),this.renderLayer(this,t,e,r)}for(this.renderPass="translucent",this.currentLayer=0;this.currentLayer<i.length;this.currentLayer++){const e=this.style._layers[i[this.currentLayer]],t=n[e.source];if(a&&a.renderLayer(e))continue;const r=("symbol"===e.type?l:s)[e.source];this._renderTileClippingMasks(e,o[e.source]),this.renderLayer(this,t,e,r)}if(this.options.showTileBoundaries){let e,t;Object.values(this.style._layers).forEach((r=>{r.source&&!r.isHidden(this.transform.zoom)&&(r.source!==(t&&t.id)&&(t=this.style.sourceCaches[r.source]),(!e||e.getSource().maxzoom<t.getSource().maxzoom)&&(e=t))})),e&&Yr.debug(this,e,e.getVisibleCoordinates())}this.options.showPadding&&function(e){const t=e.transform.padding;qr(e,e.transform.height-(t.top||0),3,Ur),qr(e,t.bottom||0,3,Vr),Gr(e,t.left||0,3,$r),Gr(e,e.transform.width-(t.right||0),3,Nr);const r=e.transform.centerPoint;!function(e,t,r,i){Zr(e,t-1,r-10,2,20,i),Zr(e,t-10,r-1,20,2,i)}(e,r.x,e.transform.height-r.y,jr)}(this),this.context.setDefault()}renderLayer(e,t,r,i){r.isHidden(this.transform.zoom)||("background"===r.type||"custom"===r.type||(i||[]).length)&&(this.id=r.id,this.gpuTimingStart(r),Yr[r.type](e,t,r,i,this.style.placement.variableOffsets),this.gpuTimingEnd())}gpuTimingStart(e){if(!this.options.gpuTiming)return;const t=this.context.extTimerQuery;let r=this.gpuTimers[e.id];r||(r=this.gpuTimers[e.id]={calls:0,cpuTime:0,query:t.createQueryEXT()}),r.calls++,t.beginQueryEXT(t.TIME_ELAPSED_EXT,r.query)}gpuTimingEnd(){if(!this.options.gpuTiming)return;const e=this.context.extTimerQuery;e.endQueryEXT(e.TIME_ELAPSED_EXT)}collectGpuTimers(){const e=this.gpuTimers;return this.gpuTimers={},e}queryGpuTimers(e){const t={};for(const r in e){const i=e[r],n=this.context.extTimerQuery,a=n.getQueryObjectEXT(i.query,n.QUERY_RESULT_EXT)/1e6;n.deleteQueryEXT(i.query),t[r]=a}return t}translatePosMatrix(t,r,i,n,a){if(!i[0]&&!i[1])return t;const o=a?"map"===n?this.transform.angle:0:"viewport"===n?-this.transform.angle:0;if(o){const e=Math.sin(o),t=Math.cos(o);i=[i[0]*t-i[1]*e,i[0]*e+i[1]*t]}const s=[a?i[0]:be(r,i[0],this.transform.zoom),a?i[1]:be(r,i[1],this.transform.zoom),0],l=new Float32Array(16);return e.translate(l,t,s),l}saveTileTexture(e){const t=this._tileTextures[e.size[0]];t?t.push(e):this._tileTextures[e.size[0]]=[e]}getTileTexture(e){const t=this._tileTextures[e];return t&&t.length>0?t.pop():null}isPatternMissing(e){if(!e)return!1;if(!e.from||!e.to)return!0;const t=this.imageManager.getPattern(e.from.toString()),r=this.imageManager.getPattern(e.to.toString());return!t||!r}useProgram(e,t){this.cache=this.cache||{};const r=e+(t?t.cacheKey:"")+(this._showOverdrawInspector?"/overdraw":"")+(this.style.terrain?"/terrain":"");return this.cache[r]||(this.cache[r]=new st(this.context,e,it[e],t,Lt[e],this._showOverdrawInspector,this.style.terrain)),this.cache[r]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const e=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(e.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new l(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}}class Qr{constructor(e,t){this.points=e,this.planes=t}static fromInvProjectionMatrix(t,r,i){const n=Math.pow(2,i),a=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((i=>{const a=1/(i=e.transformMat4([],i,t))[3]/r*n;return e.mul$1(i,i,[a,a,1/i[3],a])})),o=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((t=>{const r=e.sub([],a[t[0]],a[t[1]]),i=e.sub([],a[t[2]],a[t[1]]),n=e.normalize([],e.cross([],r,i)),o=-e.dot(n,a[t[1]]);return n.concat(o)}));return new Qr(a,o)}}class ei{constructor(t,r){this.min=t,this.max=r,this.center=e.scale$1([],e.add([],this.min,this.max),.5)}quadrant(t){const r=[t%2==0,t<2],i=e.clone$2(this.min),n=e.clone$2(this.max);for(let e=0;e<r.length;e++)i[e]=r[e]?this.min[e]:this.center[e],n[e]=r[e]?this.center[e]:this.max[e];return n[2]=this.max[2],new ei(i,n)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}intersects(t){const r=[[this.min[0],this.min[1],this.min[2],1],[this.max[0],this.min[1],this.min[2],1],[this.max[0],this.max[1],this.min[2],1],[this.min[0],this.max[1],this.min[2],1],[this.min[0],this.min[1],this.max[2],1],[this.max[0],this.min[1],this.max[2],1],[this.max[0],this.max[1],this.max[2],1],[this.min[0],this.max[1],this.max[2],1]];let i=!0;for(let n=0;n<t.planes.length;n++){const a=t.planes[n];let o=0;for(let t=0;t<r.length;t++)e.dot$1(a,r[t])>=0&&o++;if(0===o)return 0;o!==r.length&&(i=!1)}if(i)return 2;for(let e=0;e<3;e++){let r=Number.MAX_VALUE,i=-Number.MAX_VALUE;for(let n=0;n<t.points.length;n++){const a=t.points[n][e]-this.min[e];r=Math.min(r,a),i=Math.max(i,a)}if(i<0||r>this.max[e]-this.min[e])return 0}return 1}}class ti{constructor(e=0,t=0,r=0,i=0){if(isNaN(e)||e<0||isNaN(t)||t<0||isNaN(r)||r<0||isNaN(i)||i<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=e,this.bottom=t,this.left=r,this.right=i}interpolate(t,r,i){return null!=r.top&&null!=t.top&&(this.top=e.number(t.top,r.top,i)),null!=r.bottom&&null!=t.bottom&&(this.bottom=e.number(t.bottom,r.bottom,i)),null!=r.left&&null!=t.left&&(this.left=e.number(t.left,r.left,i)),null!=r.right&&null!=t.right&&(this.right=e.number(t.right,r.right,i)),this}getCenter(t,r){const i=e.clamp((this.left+t-this.right)/2,0,t),n=e.clamp((this.top+r-this.bottom)/2,0,r);return new e.pointGeometry(i,n)}equals(e){return this.top===e.top&&this.bottom===e.bottom&&this.left===e.left&&this.right===e.right}clone(){return new ti(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}class ri{constructor(t,r,i,n,a){this.tileSize=512,this.maxValidLatitude=85.051129,this.freezeElevation=!1,this._renderWorldCopies=void 0===a||!!a,this._minZoom=t||0,this._maxZoom=r||22,this._minPitch=null==i?0:i,this._maxPitch=null==n?60:n,this.setMaxBounds(),this.width=0,this.height=0,this._center=new e.LngLat(0,0),this._elevation=0,this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._unmodified=!0,this._edgeInsets=new ti,this._posMatrixCache={},this._alignedPosMatrixCache={}}clone(){const e=new ri(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies);return e.tileSize=this.tileSize,e.latRange=this.latRange,e.width=this.width,e.height=this.height,e._center=this._center,e._elevation=this._elevation,e.zoom=this.zoom,e.angle=this.angle,e._fov=this._fov,e._pitch=this._pitch,e._unmodified=this._unmodified,e._edgeInsets=this._edgeInsets.clone(),e._calcMatrices(),e}get minZoom(){return this._minZoom}set minZoom(e){this._minZoom!==e&&(this._minZoom=e,this.zoom=Math.max(this.zoom,e))}get maxZoom(){return this._maxZoom}set maxZoom(e){this._maxZoom!==e&&(this._maxZoom=e,this.zoom=Math.min(this.zoom,e))}get minPitch(){return this._minPitch}set minPitch(e){this._minPitch!==e&&(this._minPitch=e,this.pitch=Math.max(this.pitch,e))}get maxPitch(){return this._maxPitch}set maxPitch(e){this._maxPitch!==e&&(this._maxPitch=e,this.pitch=Math.min(this.pitch,e))}get renderWorldCopies(){return this._renderWorldCopies}set renderWorldCopies(e){void 0===e?e=!0:null===e&&(e=!1),this._renderWorldCopies=e}get worldSize(){return this.tileSize*this.scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new e.pointGeometry(this.width,this.height)}get bearing(){return-this.angle/Math.PI*180}set bearing(t){const r=-e.wrap(t,-180,180)*Math.PI/180;var i;this.angle!==r&&(this._unmodified=!1,this.angle=r,this._calcMatrices(),this.rotationMatrix=(i=new e.ARRAY_TYPE(4),e.ARRAY_TYPE!=Float32Array&&(i[1]=0,i[2]=0),i[0]=1,i[3]=1,i),function(e,t,r){var i=t[0],n=t[1],a=t[2],o=t[3],s=Math.sin(r),l=Math.cos(r);e[0]=i*l+a*s,e[1]=n*l+o*s,e[2]=i*-s+a*l,e[3]=n*-s+o*l}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const r=e.clamp(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==r&&(this._unmodified=!1,this._pitch=r,this._calcMatrices())}get fov(){return this._fov/Math.PI*180}set fov(e){e=Math.max(.01,Math.min(60,e)),this._fov!==e&&(this._unmodified=!1,this._fov=e/180*Math.PI,this._calcMatrices())}get zoom(){return this._zoom}set zoom(e){const t=Math.min(Math.max(e,this.minZoom),this.maxZoom);this._zoom!==t&&(this._unmodified=!1,this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom,this._constrain(),this._calcMatrices())}get center(){return this._center}set center(e){e.lat===this._center.lat&&e.lng===this._center.lng||(this._unmodified=!1,this._center=e,this._constrain(),this._calcMatrices())}get elevation(){return this._elevation}set elevation(e){e!==this._elevation&&(this._elevation=e,this._constrain(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}set padding(e){this._edgeInsets.equals(e)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,e,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}isPaddingEqual(e){return this._edgeInsets.equals(e)}interpolatePadding(e,t,r){this._unmodified=!1,this._edgeInsets.interpolate(e,t,r),this._constrain(),this._calcMatrices()}coveringZoomLevel(e){const t=(e.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/e.tileSize));return Math.max(0,t)}getVisibleUnwrappedCoordinates(t){const r=[new e.UnwrappedTileID(0,t)];if(this._renderWorldCopies){const i=this.pointCoordinate(new e.pointGeometry(0,0)),n=this.pointCoordinate(new e.pointGeometry(this.width,0)),a=this.pointCoordinate(new e.pointGeometry(this.width,this.height)),o=this.pointCoordinate(new e.pointGeometry(0,this.height)),s=Math.floor(Math.min(i.x,n.x,a.x,o.x)),l=Math.floor(Math.max(i.x,n.x,a.x,o.x)),c=1;for(let i=s-c;i<=l+c;i++)0!==i&&r.push(new e.UnwrappedTileID(i,t))}return r}coveringTiles(t){var r,i;let n=this.coveringZoomLevel(t);const a=n;if(void 0!==t.minzoom&&n<t.minzoom)return[];void 0!==t.maxzoom&&n>t.maxzoom&&(n=t.maxzoom);const o=this.pointCoordinate(this.getCameraPoint()),s=e.MercatorCoordinate.fromLngLat(this.center),l=Math.pow(2,n),c=[l*o.x,l*o.y,0],u=[l*s.x,l*s.y,0],h=Qr.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,n);let p=t.minzoom||0;!t.terrain&&this.pitch<=60&&this._edgeInsets.top<.1&&(p=n);const d=t.terrain?2/Math.min(this.tileSize,t.tileSize)*this.tileSize:3,f=e=>({aabb:new ei([e*l,0,0],[(e+1)*l,l,0]),zoom:0,x:0,y:0,wrap:e,fullyVisible:!1}),m=[],g=[],y=n,_=t.reparseOverscaled?a:n;if(this._renderWorldCopies)for(let e=1;e<=3;e++)m.push(f(-e)),m.push(f(e));for(m.push(f(0));m.length>0;){const n=m.pop(),a=n.x,o=n.y;let s=n.fullyVisible;if(!s){const e=n.aabb.intersects(h);if(0===e)continue;s=2===e}const l=t.terrain?c:u,f=n.aabb.distanceX(l),x=n.aabb.distanceY(l),v=Math.max(Math.abs(f),Math.abs(x)),b=d+(1<<y-n.zoom)-2;if(n.zoom===y||v>b&&n.zoom>=p){const t=y-n.zoom,r=c[0]-.5-(a<<t),i=c[1]-.5-(o<<t);g.push({tileID:new e.OverscaledTileID(n.zoom===y?_:n.zoom,n.wrap,n.zoom,a,o),distanceSq:e.sqrLen([u[0]-.5-a,u[1]-.5-o]),tileDistanceToCamera:Math.sqrt(r*r+i*i)})}else for(let l=0;l<4;l++){const c=(a<<1)+l%2,u=(o<<1)+(l>>1),h=n.zoom+1;let p=n.aabb.quadrant(l);if(t.terrain){const a=new e.OverscaledTileID(h,n.wrap,h,c,u),o=t.terrain.getMinMaxElevation(a),s=null!==(r=o.minElevation)&&void 0!==r?r:this.elevation,l=null!==(i=o.maxElevation)&&void 0!==i?i:this.elevation;p=new ei([p.min[0],p.min[1],s],[p.max[0],p.max[1],l])}m.push({aabb:p,zoom:h,x:c,y:u,wrap:n.wrap,fullyVisible:s})}}return g.sort(((e,t)=>e.distanceSq-t.distanceSq)).map((e=>e.tileID))}resize(e,t){this.width=e,this.height=t,this.pixelsToGLUnits=[2/e,-2/t],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(e){return Math.pow(2,e)}scaleZoom(e){return Math.log(e)/Math.LN2}project(t){const r=e.clamp(t.lat,-this.maxValidLatitude,this.maxValidLatitude);return new e.pointGeometry(e.mercatorXfromLng(t.lng)*this.worldSize,e.mercatorYfromLat(r)*this.worldSize)}unproject(t){return new e.MercatorCoordinate(t.x/this.worldSize,t.y/this.worldSize).toLngLat()}get point(){return this.project(this.center)}updateElevation(e){this.freezeElevation||(this.elevation=e?this.getElevation(this._center,e):0)}getElevation(t,r){const i=e.MercatorCoordinate.fromLngLat(t),n=(1<<this.tileZoom)*e.EXTENT,a=i.x*n,o=i.y*n,s=Math.floor(a/e.EXTENT),l=Math.floor(o/e.EXTENT),c=new e.OverscaledTileID(this.tileZoom,0,this.tileZoom,s,l);return r.getElevation(c,a%e.EXTENT,o%e.EXTENT,e.EXTENT)}getCameraPosition(){return{lngLat:this.pointLocation(this.getCameraPoint()),altitude:Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter+this.elevation}}recalculateZoom(t){const r=this.pointLocation(this.centerPoint,t),i=this.getElevation(r,t);if(!(this.elevation-i))return;const n=this.getCameraPosition(),a=e.MercatorCoordinate.fromLngLat(n.lngLat,n.altitude),o=e.MercatorCoordinate.fromLngLat(r,i),s=a.x-o.x,l=a.y-o.y,c=a.z-o.z,u=Math.sqrt(s*s+l*l+c*c),h=this.scaleZoom(this.cameraToCenterDistance/u/this.tileSize);this._elevation=i,this._center=r,this.zoom=h}setLocationAtPoint(t,r){const i=this.pointCoordinate(r),n=this.pointCoordinate(this.centerPoint),a=this.locationCoordinate(t),o=new e.MercatorCoordinate(a.x-(i.x-n.x),a.y-(i.y-n.y));this.center=this.coordinateLocation(o),this._renderWorldCopies&&(this.center=this.center.wrap())}locationPoint(e,t){return t?this.coordinatePoint(this.locationCoordinate(e),this.getElevation(e,t),this.pixelMatrix3D):this.coordinatePoint(this.locationCoordinate(e))}pointLocation(e,t){return this.coordinateLocation(this.pointCoordinate(e,t))}locationCoordinate(t){return e.MercatorCoordinate.fromLngLat(t)}coordinateLocation(e){return e&&e.toLngLat()}pointCoordinate(t,r){if(r){const e=r.pointCoordinate(t);if(null!=e)return e}const i=[t.x,t.y,0,1],n=[t.x,t.y,1,1];e.transformMat4(i,i,this.pixelMatrixInverse),e.transformMat4(n,n,this.pixelMatrixInverse);const a=i[3],o=n[3],s=i[1]/a,l=n[1]/o,c=i[2]/a,u=n[2]/o,h=c===u?0:(0-c)/(u-c);return new e.MercatorCoordinate(e.number(i[0]/a,n[0]/o,h)/this.worldSize,e.number(s,l,h)/this.worldSize)}coordinatePoint(t,r=0,i=this.pixelMatrix){const n=[t.x*this.worldSize,t.y*this.worldSize,r,1];return e.transformMat4(n,n,i),new e.pointGeometry(n[0]/n[3],n[1]/n[3])}getBounds(){const t=Math.max(0,this.height/2-this.getHorizon());return(new e.LngLatBounds).extend(this.pointLocation(new e.pointGeometry(0,t))).extend(this.pointLocation(new e.pointGeometry(this.width,t))).extend(this.pointLocation(new e.pointGeometry(this.width,this.height))).extend(this.pointLocation(new e.pointGeometry(0,this.height)))}getMaxBounds(){return this.latRange&&2===this.latRange.length&&this.lngRange&&2===this.lngRange.length?new e.LngLatBounds([this.lngRange[0],this.latRange[0]],[this.lngRange[1],this.latRange[1]]):null}getHorizon(){return Math.tan(Math.PI/2-this._pitch)*this.cameraToCenterDistance*.85}setMaxBounds(e){e?(this.lngRange=[e.getWest(),e.getEast()],this.latRange=[e.getSouth(),e.getNorth()],this._constrain()):(this.lngRange=null,this.latRange=[-this.maxValidLatitude,this.maxValidLatitude])}calculatePosMatrix(t,r=!1){const i=t.key,n=r?this._alignedPosMatrixCache:this._posMatrixCache;if(n[i])return n[i];const a=t.canonical,o=this.worldSize/this.zoomScale(a.z),s=a.x+Math.pow(2,a.z)*t.wrap,l=e.identity(new Float64Array(16));return e.translate(l,l,[s*o,a.y*o,0]),e.scale(l,l,[o/e.EXTENT,o/e.EXTENT,1]),e.multiply(l,r?this.alignedProjMatrix:this.projMatrix,l),n[i]=new Float32Array(l),n[i]}customLayerMatrix(){return this.mercatorMatrix.slice()}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;let t,r,i,n,a=-90,o=90,s=-180,l=180;const c=this.size,u=this._unmodified;if(this.latRange){const r=this.latRange;a=e.mercatorYfromLat(r[1])*this.worldSize,o=e.mercatorYfromLat(r[0])*this.worldSize,t=o-a<c.y?c.y/(o-a):0}if(this.lngRange){const t=this.lngRange;s=e.wrap(e.mercatorXfromLng(t[0])*this.worldSize,0,this.worldSize),l=e.wrap(e.mercatorXfromLng(t[1])*this.worldSize,0,this.worldSize),l<s&&(l+=this.worldSize),r=l-s<c.x?c.x/(l-s):0}const h=this.point,p=Math.max(r||0,t||0);if(p)return this.center=this.unproject(new e.pointGeometry(r?(l+s)/2:h.x,t?(o+a)/2:h.y)),this.zoom+=this.scaleZoom(p),this._unmodified=u,void(this._constraining=!1);if(this.latRange){const e=h.y,t=c.y/2;e-t<a&&(n=a+t),e+t>o&&(n=o-t)}if(this.lngRange){const t=(s+l)/2,r=e.wrap(h.x,t-this.worldSize/2,t+this.worldSize/2),n=c.x/2;r-n<s&&(i=s+n),r+n>l&&(i=l-n)}void 0===i&&void 0===n||(this.center=this.unproject(new e.pointGeometry(void 0!==i?i:h.x,void 0!==n?n:h.y)).wrap()),this._unmodified=u,this._constraining=!1}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,r=this.point.x,i=this.point.y;this.cameraToCenterDistance=.5/Math.tan(this._fov/2)*this.height,this._pixelPerMeter=e.mercatorZfromAltitude(1,this.center.lat)*this.worldSize;let n=e.identity(new Float64Array(16));e.scale(n,n,[this.width/2,-this.height/2,1]),e.translate(n,n,[1,-1,0]),this.labelPlaneMatrix=n,n=e.identity(new Float64Array(16)),e.scale(n,n,[1,-1,1]),e.translate(n,n,[-1,-1,0]),e.scale(n,n,[2/this.width,2/this.height,1]),this.glCoordMatrix=n,this.cameraToSeaLevelDistance=this.cameraToCenterDistance+this._elevation*this._pixelPerMeter/Math.cos(this._pitch);const a=Math.PI/2+this._pitch,o=this._fov*(.5+t.y/this.height),s=Math.sin(o)*this.cameraToSeaLevelDistance/Math.sin(e.clamp(Math.PI-a-o,.01,Math.PI-.01)),l=this.getHorizon(),c=2*Math.atan(l/this.cameraToCenterDistance)*(.5+t.y/(2*l)),u=Math.sin(c)*this.cameraToSeaLevelDistance/Math.sin(e.clamp(Math.PI-a-c,.01,Math.PI-.01)),h=Math.cos(Math.PI/2-this._pitch)*s+this.cameraToSeaLevelDistance,p=Math.cos(Math.PI/2-this._pitch)*u+this.cameraToSeaLevelDistance,d=1.01*Math.min(h,p),f=this.height/50;n=new Float64Array(16),e.perspective(n,this._fov,this.width/this.height,f,d),n[8]=2*-t.x/this.width,n[9]=2*t.y/this.height,e.scale(n,n,[1,-1,1]),e.translate(n,n,[0,0,-this.cameraToCenterDistance]),e.rotateX(n,n,this._pitch),e.rotateZ(n,n,this.angle),e.translate(n,n,[-r,-i,0]),this.mercatorMatrix=e.scale([],n,[this.worldSize,this.worldSize,this.worldSize]),e.scale(n,n,[1,1,this._pixelPerMeter]),this.pixelMatrix=e.multiply(new Float64Array(16),this.labelPlaneMatrix,n),e.translate(n,n,[0,0,-this.elevation]),this.projMatrix=n,this.invProjMatrix=e.invert([],n),this.pixelMatrix3D=e.multiply(new Float64Array(16),this.labelPlaneMatrix,n);const m=this.width%2/2,g=this.height%2/2,y=Math.cos(this.angle),_=Math.sin(this.angle),x=r-Math.round(r)+y*m+_*g,v=i-Math.round(i)+y*g+_*m,b=new Float64Array(n);if(e.translate(b,b,[x>.5?x-1:x,v>.5?v-1:v,0]),this.alignedProjMatrix=b,n=e.invert(new Float64Array(16),this.pixelMatrix),!n)throw new Error("failed to invert matrix");this.pixelMatrixInverse=n,this._posMatrixCache={},this._alignedPosMatrixCache={}}maxPitchScaleFactor(){if(!this.pixelMatrixInverse)return 1;const t=this.pointCoordinate(new e.pointGeometry(0,0)),r=[t.x*this.worldSize,t.y*this.worldSize,0,1];return e.transformMat4(r,r,this.pixelMatrix)[3]/this.cameraToCenterDistance}getCameraPoint(){const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new e.pointGeometry(0,t))}getCameraQueryGeometry(t){const r=this.getCameraPoint();if(1===t.length)return[t[0],r];{let i=r.x,n=r.y,a=r.x,o=r.y;for(const e of t)i=Math.min(i,e.x),n=Math.min(n,e.y),a=Math.max(a,e.x),o=Math.max(o,e.y);return[new e.pointGeometry(i,n),new e.pointGeometry(a,n),new e.pointGeometry(a,o),new e.pointGeometry(i,o),new e.pointGeometry(i,n)]}}}class ii{constructor(t){this._hashName=t&&encodeURIComponent(t),e.bindAll(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=function(e,t){let r=!1,i=null;const n=()=>{i=null,r&&(e(),i=setTimeout(n,300),r=!1)};return()=>(r=!0,i||n(),i)}(this._updateHashUnthrottled.bind(this))}addTo(e){return this._map=e,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),delete this._map,this}getHashString(e){const t=this._map.getCenter(),r=Math.round(100*this._map.getZoom())/100,i=Math.ceil((r*Math.LN2+Math.log(512/360/.5))/Math.LN10),n=Math.pow(10,i),a=Math.round(t.lng*n)/n,o=Math.round(t.lat*n)/n,s=this._map.getBearing(),l=this._map.getPitch();let c="";if(c+=e?`/${a}/${o}/${r}`:`${r}/${o}/${a}`,(s||l)&&(c+="/"+Math.round(10*s)/10),l&&(c+=`/${Math.round(l)}`),this._hashName){const e=this._hashName;let t=!1;const r=window.location.hash.slice(1).split("&").map((r=>{const i=r.split("=")[0];return i===e?(t=!0,`${i}=${c}`):r})).filter((e=>e));return t||r.push(`${e}=${c}`),`#${r.join("&")}`}return`#${c}`}_getCurrentHash(){const e=window.location.hash.replace("#","");if(this._hashName){let t;return e.split("&").map((e=>e.split("="))).forEach((e=>{e[0]===this._hashName&&(t=e)})),(t&&t[1]||"").split("/")}return e.split("/")}_onHashChange(){const e=this._getCurrentHash();if(e.length>=3&&!e.some((e=>isNaN(e)))){const t=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(e[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+e[2],+e[1]],zoom:+e[0],bearing:t,pitch:+(e[4]||0)}),!0}return!1}_updateHashUnthrottled(){const e=window.location.href.replace(/(#.+)?$/,this.getHashString());try{window.history.replaceState(window.history.state,null,e)}catch(e){}}}const ni={linearity:.3,easing:e.bezier(0,0,.3,1)},ai=e.extend({deceleration:2500,maxSpeed:1400},ni),oi=e.extend({deceleration:20,maxSpeed:1400},ni),si=e.extend({deceleration:1e3,maxSpeed:360},ni),li=e.extend({deceleration:1e3,maxSpeed:90},ni);class ci{constructor(e){this._map=e,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:e.exported.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,r=e.exported.now();for(;t.length>0&&r-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const r={zoom:0,bearing:0,pitch:0,pan:new e.pointGeometry(0,0),pinchAround:void 0,around:void 0};for(const{settings:e}of this._inertiaBuffer)r.zoom+=e.zoomDelta||0,r.bearing+=e.bearingDelta||0,r.pitch+=e.pitchDelta||0,e.panDelta&&r.pan._add(e.panDelta),e.around&&(r.around=e.around),e.pinchAround&&(r.pinchAround=e.pinchAround);const i=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,n={};if(r.pan.mag()){const a=hi(r.pan.mag(),i,e.extend({},ai,t||{}));n.offset=r.pan.mult(a.amount/r.pan.mag()),n.center=this._map.transform.center,ui(n,a)}if(r.zoom){const e=hi(r.zoom,i,oi);n.zoom=this._map.transform.zoom+e.amount,ui(n,e)}if(r.bearing){const t=hi(r.bearing,i,si);n.bearing=this._map.transform.bearing+e.clamp(t.amount,-179,179),ui(n,t)}if(r.pitch){const e=hi(r.pitch,i,li);n.pitch=this._map.transform.pitch+e.amount,ui(n,e)}if(n.zoom||n.bearing){const e=void 0===r.pinchAround?r.around:r.pinchAround;n.around=e?this._map.unproject(e):this._map.getCenter()}return this.clear(),e.extend(n,{noMoveStart:!0})}}function ui(e,t){(!e.duration||e.duration<t.duration)&&(e.duration=t.duration,e.easing=t.easing)}function hi(t,r,i){const{maxSpeed:n,linearity:a,deceleration:o}=i,s=e.clamp(t*a/(r/1e3),-n,n),l=Math.abs(s)/(o*a);return{easing:i.easing,duration:1e3*l,amount:s*(l/2)}}class pi extends e.Event{constructor(t,r,i,n={}){const o=a.mousePos(r.getCanvasContainer(),i),s=r.unproject(o);super(t,e.extend({point:o,lngLat:s,originalEvent:i},n)),this._defaultPrevented=!1,this.target=r}preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}}class di extends e.Event{constructor(t,r,i){const n="touchend"===t?i.changedTouches:i.touches,o=a.touchPos(r.getCanvasContainer(),n),s=o.map((e=>r.unproject(e))),l=o.reduce(((e,t,r,i)=>e.add(t.div(i.length))),new e.pointGeometry(0,0));super(t,{points:o,point:l,lngLats:s,lngLat:r.unproject(l),originalEvent:i}),this._defaultPrevented=!1}preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}}class fi extends e.Event{constructor(e,t,r){super(e,{originalEvent:r}),this._defaultPrevented=!1}preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}}class mi{constructor(e,t){this._map=e,this._clickTolerance=t.clickTolerance}reset(){delete this._mousedownPos}wheel(e){return this._firePreventable(new fi(e.type,this._map,e))}mousedown(e,t){return this._mousedownPos=t,this._firePreventable(new pi(e.type,this._map,e))}mouseup(e){this._map.fire(new pi(e.type,this._map,e))}click(e,t){this._mousedownPos&&this._mousedownPos.dist(t)>=this._clickTolerance||this._map.fire(new pi(e.type,this._map,e))}dblclick(e){return this._firePreventable(new pi(e.type,this._map,e))}mouseover(e){this._map.fire(new pi(e.type,this._map,e))}mouseout(e){this._map.fire(new pi(e.type,this._map,e))}touchstart(e){return this._firePreventable(new di(e.type,this._map,e))}touchmove(e){this._map.fire(new di(e.type,this._map,e))}touchend(e){this._map.fire(new di(e.type,this._map,e))}touchcancel(e){this._map.fire(new di(e.type,this._map,e))}_firePreventable(e){if(this._map.fire(e),e.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class gi{constructor(e){this._map=e}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(e){this._map.fire(new pi(e.type,this._map,e))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new pi("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(e){this._delayContextMenu?this._contextMenuEvent=e:this._ignoreContextMenu||this._map.fire(new pi(e.type,this._map,e)),this._map.listens("contextmenu")&&e.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class yi{constructor(e,t){this._map=e,this._el=e.getCanvasContainer(),this._container=e.getContainer(),this._clickTolerance=t.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(e,t){this.isEnabled()&&e.shiftKey&&0===e.button&&(a.disableDrag(),this._startPos=this._lastPos=t,this._active=!0)}mousemoveWindow(e,t){if(!this._active)return;const r=t;if(this._lastPos.equals(r)||!this._box&&r.dist(this._startPos)<this._clickTolerance)return;const i=this._startPos;this._lastPos=r,this._box||(this._box=a.create("div","maplibregl-boxzoom mapboxgl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair","mapboxgl-crosshair"),this._fireEvent("boxzoomstart",e));const n=Math.min(i.x,r.x),o=Math.max(i.x,r.x),s=Math.min(i.y,r.y),l=Math.max(i.y,r.y);a.setTransform(this._box,`translate(${n}px,${s}px)`),this._box.style.width=o-n+"px",this._box.style.height=l-s+"px"}mouseupWindow(t,r){if(!this._active)return;if(0!==t.button)return;const i=this._startPos,n=r;if(this.reset(),a.suppressClick(),i.x!==n.x||i.y!==n.y)return this._map.fire(new e.Event("boxzoomend",{originalEvent:t})),{cameraAnimation:e=>e.fitScreenCoordinates(i,n,this._map.getBearing(),{linear:!0})};this._fireEvent("boxzoomcancel",t)}keydown(e){this._active&&27===e.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",e))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair","mapboxgl-crosshair"),this._box&&(a.remove(this._box),this._box=null),a.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(t,r){return this._map.fire(new e.Event(t,{originalEvent:r}))}}function _i(e,t){if(e.length!==t.length)throw new Error(`The number of touches and points are not equal - touches ${e.length}, points ${t.length}`);const r={};for(let i=0;i<e.length;i++)r[e[i].identifier]=t[i];return r}class xi{constructor(e){this.reset(),this.numTouches=e.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(t,r,i){(this.centroid||i.length>this.numTouches)&&(this.aborted=!0),this.aborted||(void 0===this.startTime&&(this.startTime=t.timeStamp),i.length===this.numTouches&&(this.centroid=function(t){const r=new e.pointGeometry(0,0);for(const e of t)r._add(e);return r.div(t.length)}(r),this.touches=_i(i,r)))}touchmove(e,t,r){if(this.aborted||!this.centroid)return;const i=_i(r,t);for(const e in this.touches){const t=this.touches[e],r=i[e];(!r||r.dist(t)>30)&&(this.aborted=!0)}}touchend(e,t,r){if((!this.centroid||e.timeStamp-this.startTime>500)&&(this.aborted=!0),0===r.length){const e=!this.aborted&&this.centroid;if(this.reset(),e)return e}}}class vi{constructor(e){this.singleTap=new xi(e),this.numTaps=e.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(e,t,r){this.singleTap.touchstart(e,t,r)}touchmove(e,t,r){this.singleTap.touchmove(e,t,r)}touchend(e,t,r){const i=this.singleTap.touchend(e,t,r);if(i){const t=e.timeStamp-this.lastTime<500,r=!this.lastTap||this.lastTap.dist(i)<30;if(t&&r||this.reset(),this.count++,this.lastTime=e.timeStamp,this.lastTap=i,this.count===this.numTaps)return this.reset(),i}}}class bi{constructor(){this._zoomIn=new vi({numTouches:1,numTaps:2}),this._zoomOut=new vi({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(e,t,r){this._zoomIn.touchstart(e,t,r),this._zoomOut.touchstart(e,t,r)}touchmove(e,t,r){this._zoomIn.touchmove(e,t,r),this._zoomOut.touchmove(e,t,r)}touchend(e,t,r){const i=this._zoomIn.touchend(e,t,r),n=this._zoomOut.touchend(e,t,r);return i?(this._active=!0,e.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:t=>t.easeTo({duration:300,zoom:t.getZoom()+1,around:t.unproject(i)},{originalEvent:e})}):n?(this._active=!0,e.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:t=>t.easeTo({duration:300,zoom:t.getZoom()-1,around:t.unproject(n)},{originalEvent:e})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const wi={0:1,2:2};class Ti{constructor(e){this.reset(),this._clickTolerance=e.clickTolerance||1}reset(){this._active=!1,this._moved=!1,delete this._lastPoint,delete this._eventButton}_correctButton(e,t){return!1}_move(e,t){return{}}mousedown(e,t){if(this._lastPoint)return;const r=a.mouseButton(e);this._correctButton(e,r)&&(this._lastPoint=t,this._eventButton=r)}mousemoveWindow(e,t){const r=this._lastPoint;if(r)if(e.preventDefault(),function(e,t){const r=wi[t];return void 0===e.buttons||(e.buttons&r)!==r}(e,this._eventButton))this.reset();else if(this._moved||!(t.dist(r)<this._clickTolerance))return this._moved=!0,this._lastPoint=t,this._move(r,t)}mouseupWindow(e){this._lastPoint&&a.mouseButton(e)===this._eventButton&&(this._moved&&a.suppressClick(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ei extends Ti{mousedown(e,t){super.mousedown(e,t),this._lastPoint&&(this._active=!0)}_correctButton(e,t){return 0===t&&!e.ctrlKey}_move(e,t){return{around:t,panDelta:t.sub(e)}}}class Si extends Ti{_correctButton(e,t){return 0===t&&e.ctrlKey||2===t}_move(e,t){const r=.8*(t.x-e.x);if(r)return this._active=!0,{bearingDelta:r}}contextmenu(e){e.preventDefault()}}class Ai extends Ti{_correctButton(e,t){return 0===t&&e.ctrlKey||2===t}_move(e,t){const r=-.5*(t.y-e.y);if(r)return this._active=!0,{pitchDelta:r}}contextmenu(e){e.preventDefault()}}class Ii{constructor(e,t){this._minTouches=e.cooperativeGestures?2:1,this._clickTolerance=e.clickTolerance||1,this._map=t,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new e.pointGeometry(0,0),setTimeout((()=>{this._cancelCooperativeMessage=!1}),200)}touchstart(e,t,r){return this._calculateTransform(e,t,r)}touchmove(e,t,r){if(this._map._cooperativeGestures&&(2===this._minTouches&&r.length<2&&!this._cancelCooperativeMessage?this._map._onCooperativeGesture(e,!1,r.length):this._cancelCooperativeMessage||(this._cancelCooperativeMessage=!0)),this._active&&!(r.length<this._minTouches))return e.preventDefault(),this._calculateTransform(e,t,r)}touchend(e,t,r){this._calculateTransform(e,t,r),this._active&&r.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,r,i){i.length>0&&(this._active=!0);const n=_i(i,r),a=new e.pointGeometry(0,0),o=new e.pointGeometry(0,0);let s=0;for(const e in n){const t=n[e],r=this._touches[e];r&&(a._add(t),o._add(t.sub(r)),s++,n[e]=t)}if(this._touches=n,s<this._minTouches||!o.mag())return;const l=o.div(s);return this._sum._add(l),this._sum.mag()<this._clickTolerance?void 0:{around:a.div(s),panDelta:l}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ki{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}_start(e){}_move(e,t,r){return{}}touchstart(e,t,r){this._firstTwoTouches||r.length<2||(this._firstTwoTouches=[r[0].identifier,r[1].identifier],this._start([t[0],t[1]]))}touchmove(e,t,r){if(!this._firstTwoTouches)return;e.preventDefault();const[i,n]=this._firstTwoTouches,a=Ci(r,t,i),o=Ci(r,t,n);if(!a||!o)return;const s=this._aroundCenter?null:a.add(o).div(2);return this._move([a,o],s,e)}touchend(e,t,r){if(!this._firstTwoTouches)return;const[i,n]=this._firstTwoTouches,o=Ci(r,t,i),s=Ci(r,t,n);o&&s||(this._active&&a.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(e){this._enabled=!0,this._aroundCenter=!!e&&"center"===e.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Ci(e,t,r){for(let i=0;i<e.length;i++)if(e[i].identifier===r)return t[i]}function zi(e,t){return Math.log(e/t)/Math.LN2}class Mi extends ki{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(e){this._startDistance=this._distance=e[0].dist(e[1])}_move(e,t){const r=this._distance;if(this._distance=e[0].dist(e[1]),this._active||!(Math.abs(zi(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:zi(this._distance,r),pinchAround:t}}}function Pi(e,t){return 180*e.angleWith(t)/Math.PI}class Di extends ki{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(e){this._startVector=this._vector=e[0].sub(e[1]),this._minDiameter=e[0].dist(e[1])}_move(e,t){const r=this._vector;if(this._vector=e[0].sub(e[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:Pi(this._vector,r),pinchAround:t}}_isBelowThreshold(e){this._minDiameter=Math.min(this._minDiameter,e.mag());const t=25/(Math.PI*this._minDiameter)*360,r=Pi(e,this._startVector);return Math.abs(r)<t}}function Li(e){return Math.abs(e.y)>Math.abs(e.x)}class Bi extends ki{constructor(e){super(),this._map=e}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(e,t,r){super.touchstart(e,t,r),this._currentTouchCount=r.length}_start(e){this._lastPoints=e,Li(e[0].sub(e[1]))&&(this._valid=!1)}_move(e,t,r){if(this._map._cooperativeGestures&&this._currentTouchCount<3)return;const i=e[0].sub(this._lastPoints[0]),n=e[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(i,n,r.timeStamp),this._valid?(this._lastPoints=e,this._active=!0,{pitchDelta:(i.y+n.y)/2*-.5}):void 0}gestureBeginsVertically(e,t,r){if(void 0!==this._valid)return this._valid;const i=e.mag()>=2,n=t.mag()>=2;if(!i&&!n)return;if(!i||!n)return void 0===this._firstMove&&(this._firstMove=r),r-this._firstMove<100&&void 0;const a=e.y>0==t.y>0;return Li(e)&&Li(t)&&a}}const Ri={panStep:100,bearingStep:15,pitchStep:10};class Fi{constructor(){const e=Ri;this._panStep=e.panStep,this._bearingStep=e.bearingStep,this._pitchStep=e.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(e){if(e.altKey||e.ctrlKey||e.metaKey)return;let t=0,r=0,i=0,n=0,a=0;switch(e.keyCode){case 61:case 107:case 171:case 187:t=1;break;case 189:case 109:case 173:t=-1;break;case 37:e.shiftKey?r=-1:(e.preventDefault(),n=-1);break;case 39:e.shiftKey?r=1:(e.preventDefault(),n=1);break;case 38:e.shiftKey?i=1:(e.preventDefault(),a=-1);break;case 40:e.shiftKey?i=-1:(e.preventDefault(),a=1);break;default:return}return this._rotationDisabled&&(r=0,i=0),{cameraAnimation:o=>{const s=o.getZoom();o.easeTo({duration:300,easeId:"keyboardHandler",easing:Oi,zoom:t?Math.round(s)+t*(e.shiftKey?2:1):s,bearing:o.getBearing()+r*this._bearingStep,pitch:o.getPitch()+i*this._pitchStep,offset:[-n*this._panStep,-a*this._panStep],center:o.getCenter()},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Oi(e){return e*(2-e)}const Ui=4.000244140625;class Vi{constructor(t,r){this._map=t,this._el=t.getCanvasContainer(),this._handler=r,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,e.bindAll(["_onTimeout"],this)}setZoomRate(e){this._defaultZoomRate=e}setWheelZoomRate(e){this._wheelZoomRate=e}isEnabled(){return!!this._enabled}isActive(){return!!this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(e){this.isEnabled()||(this._enabled=!0,this._aroundCenter=e&&"center"===e.around)}disable(){this.isEnabled()&&(this._enabled=!1)}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!this._map._metaPress)return;t.preventDefault()}let r=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const i=e.exported.now(),n=i-(this._lastWheelEventTime||0);this._lastWheelEventTime=i,0!==r&&r%Ui==0?this._type="wheel":0!==r&&Math.abs(r)<4?this._type="trackpad":n>400?(this._type=null,this._lastValue=r,this._timeout=setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(n*r)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,r+=this._lastValue)),t.shiftKey&&r&&(r/=4),this._type&&(this._lastWheelEvent=t,this._delta-=r,this._active||this._start(t)),t.preventDefault()}_onTimeout(e){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(e)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const r=a.mousePos(this._el,t);this._around=e.LngLat.convert(this._aroundCenter?this._map.getCenter():this._map.unproject(r)),this._aroundPoint=this._map.transform.locationPoint(this._around),this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const t=this._map.transform;if(0!==this._delta){const e="wheel"===this._type&&Math.abs(this._delta)>Ui?this._wheelZoomRate:this._defaultZoomRate;let r=2/(1+Math.exp(-Math.abs(this._delta*e)));this._delta<0&&0!==r&&(r=1/r);const i="number"==typeof this._targetZoom?t.zoomScale(this._targetZoom):t.scale;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(i*r))),"wheel"===this._type&&(this._startZoom=t.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const r="number"==typeof this._targetZoom?this._targetZoom:t.zoom,i=this._startZoom,n=this._easing;let a,o=!1;if("wheel"===this._type&&i&&n){const t=Math.min((e.exported.now()-this._lastWheelEventTime)/200,1),s=n(t);a=e.number(i,r,s),t<1?this._frameId||(this._frameId=!0):o=!0}else a=r,o=!0;return this._active=!0,o&&(this._active=!1,this._finishTimeout=setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200)),{noInertia:!0,needsRenderFrame:!o,zoomDelta:a-t.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let r=e.ease;if(this._prevEase){const t=this._prevEase,i=(e.exported.now()-t.start)/t.duration,n=t.easing(i+.01)-t.easing(i),a=.27/Math.sqrt(n*n+1e-4)*.01,o=Math.sqrt(.0729-a*a);r=e.bezier(a,o,.25,1)}return this._prevEase={start:e.exported.now(),duration:t,easing:r},r}reset(){this._active=!1}}class $i{constructor(e,t){this._clickZoom=e,this._tapZoom=t}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Ni{constructor(){this.reset()}reset(){this._active=!1}dblclick(e,t){return e.preventDefault(),{cameraAnimation:r=>{r.easeTo({duration:300,zoom:r.getZoom()+(e.shiftKey?-1:1),around:r.unproject(t)},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ji{constructor(){this._tap=new vi({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,this._tap.reset()}touchstart(e,t,r){this._swipePoint||(this._tapTime&&e.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?r.length>0&&(this._swipePoint=t[0],this._swipeTouch=r[0].identifier):this._tap.touchstart(e,t,r))}touchmove(e,t,r){if(this._tapTime){if(this._swipePoint){if(r[0].identifier!==this._swipeTouch)return;const i=t[0],n=i.y-this._swipePoint.y;return this._swipePoint=i,e.preventDefault(),this._active=!0,{zoomDelta:n/128}}}else this._tap.touchmove(e,t,r)}touchend(e,t,r){this._tapTime?this._swipePoint&&0===r.length&&this.reset():this._tap.touchend(e,t,r)&&(this._tapTime=e.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class qi{constructor(e,t,r){this._el=e,this._mousePan=t,this._touchPan=r}enable(e){this._inertiaOptions=e||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan","mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan","mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Gi{constructor(e,t,r){this._pitchWithRotate=e.pitchWithRotate,this._mouseRotate=t,this._mousePitch=r}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Zi{constructor(e,t,r,i){this._el=e,this._touchZoom=t,this._touchRotate=r,this._tapDragZoom=i,this._rotationDisabled=!1,this._enabled=!0}enable(e){this._touchZoom.enable(e),this._rotationDisabled||this._touchRotate.enable(e),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate","mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate","mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Xi=e=>e.zoom||e.drag||e.pitch||e.rotate;class Wi extends e.Event{}function Hi(e){return e.panDelta&&e.panDelta.mag()||e.zoomDelta||e.bearingDelta||e.pitchDelta}class Ki{constructor(t,r){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new ci(t),this._bearingSnap=r.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(r),e.bindAll(["handleEvent","handleWindowEvent"],this);const i=this._el;this._listeners=[[i,"touchstart",{passive:!0}],[i,"touchmove",{passive:!1}],[i,"touchend",void 0],[i,"touchcancel",void 0],[i,"mousedown",void 0],[i,"mousemove",void 0],[i,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[i,"mouseover",void 0],[i,"mouseout",void 0],[i,"dblclick",void 0],[i,"click",void 0],[i,"keydown",{capture:!1}],[i,"keyup",void 0],[i,"wheel",{passive:!1}],[i,"contextmenu",void 0],[window,"blur",void 0]];for(const[e,t,r]of this._listeners)a.addEventListener(e,t,e===document?this.handleWindowEvent:this.handleEvent,r)}destroy(){for(const[e,t,r]of this._listeners)a.removeEventListener(e,t,e===document?this.handleWindowEvent:this.handleEvent,r)}_addDefaultHandlers(e){const t=this._map,r=t.getCanvasContainer();this._add("mapEvent",new mi(t,e));const i=t.boxZoom=new yi(t,e);this._add("boxZoom",i);const n=new bi,a=new Ni;t.doubleClickZoom=new $i(a,n),this._add("tapZoom",n),this._add("clickZoom",a);const o=new ji;this._add("tapDragZoom",o);const s=t.touchPitch=new Bi(t);this._add("touchPitch",s);const l=new Si(e),c=new Ai(e);t.dragRotate=new Gi(e,l,c),this._add("mouseRotate",l,["mousePitch"]),this._add("mousePitch",c,["mouseRotate"]);const u=new Ei(e),h=new Ii(e,t);t.dragPan=new qi(r,u,h),this._add("mousePan",u),this._add("touchPan",h,["touchZoom","touchRotate"]);const p=new Di,d=new Mi;t.touchZoomRotate=new Zi(r,d,p,o),this._add("touchRotate",p,["touchPan","touchZoom"]),this._add("touchZoom",d,["touchPan","touchRotate"]);const f=t.scrollZoom=new Vi(t,this);this._add("scrollZoom",f,["mousePan"]);const m=t.keyboard=new Fi;this._add("keyboard",m),this._add("blockableMapEvent",new gi(t));for(const r of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])e.interactive&&e[r]&&t[r].enable(e[r])}_add(e,t,r){this._handlers.push({handlerName:e,handler:t,allowed:r}),this._handlersById[e]=t}stop(e){if(!this._updatingCamera){for(const{handler:e}of this._handlers)e.reset();this._inertia.clear(),this._fireEvents({},{},e),this._changes=[]}}isActive(){for(const{handler:e}of this._handlers)if(e.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return Boolean(Xi(this._eventsInProgress))||this.isZooming()}_blockedByActive(e,t,r){for(const i in e)if(i!==r&&(!t||t.indexOf(i)<0))return!0;return!1}handleWindowEvent(e){this.handleEvent(e,`${e.type}Window`)}_getMapTouches(e){const t=[];for(const r of e)this._el.contains(r.target)&&t.push(r);return t}handleEvent(e,t){if("blur"===e.type)return void this.stop(!0);this._updatingCamera=!0;const r="renderFrame"===e.type?void 0:e,i={needsRenderFrame:!1},n={},o={},s=e.touches,l=s?this._getMapTouches(s):void 0,c=l?a.touchPos(this._el,l):a.mousePos(this._el,e);for(const{handlerName:a,handler:s,allowed:u}of this._handlers){if(!s.isEnabled())continue;let h;this._blockedByActive(o,u,a)?s.reset():s[t||e.type]&&(h=s[t||e.type](e,c,l),this.mergeHandlerResult(i,n,h,a,r),h&&h.needsRenderFrame&&this._triggerRenderFrame()),(h||s.isActive())&&(o[a]=s)}const u={};for(const e in this._previousActiveHandlers)o[e]||(u[e]=r);this._previousActiveHandlers=o,(Object.keys(u).length||Hi(i))&&(this._changes.push([i,n,u]),this._triggerRenderFrame()),(Object.keys(o).length||Hi(i))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:h}=i;h&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],h(this._map))}mergeHandlerResult(t,r,i,n,a){if(!i)return;e.extend(t,i);const o={handlerName:n,originalEvent:i.originalEvent||a};void 0!==i.zoomDelta&&(r.zoom=o),void 0!==i.panDelta&&(r.drag=o),void 0!==i.pitchDelta&&(r.pitch=o),void 0!==i.bearingDelta&&(r.rotate=o)}_applyChanges(){const t={},r={},i={};for(const[n,a,o]of this._changes)n.panDelta&&(t.panDelta=(t.panDelta||new e.pointGeometry(0,0))._add(n.panDelta)),n.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+n.zoomDelta),n.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+n.bearingDelta),n.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+n.pitchDelta),void 0!==n.around&&(t.around=n.around),void 0!==n.pinchAround&&(t.pinchAround=n.pinchAround),n.noInertia&&(t.noInertia=n.noInertia),e.extend(r,a),e.extend(i,o);this._updateMapTransform(t,r,i),this._changes=[]}_updateMapTransform(t,r,i){const n=this._map,a=n.transform,o=n.style&&n.style.terrain;if(!(Hi(t)||o&&this._drag))return this._fireEvents(r,i,!0);let{panDelta:s,zoomDelta:l,bearingDelta:c,pitchDelta:u,around:h,pinchAround:p}=t;void 0!==p&&(h=p),n._stop(!0),h=h||n.transform.centerPoint;const d=a.pointLocation(s?h.sub(s):h);c&&(a.bearing+=c),u&&(a.pitch+=u),l&&(a.zoom+=l),o?r.drag&&!this._drag?(this._drag={center:a.centerPoint,lngLat:a.pointLocation(h),point:h,handlerName:r.drag.handlerName},n.fire(new e.Event("freezeElevation",{freeze:!0}))):this._drag&&i[this._drag.handlerName]?(n.fire(new e.Event("freezeElevation",{freeze:!1})),this._drag=null):r.drag&&this._drag&&(a.center=a.pointLocation(a.centerPoint.sub(s))):a.setLocationAtPoint(d,h),this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(r,i,!0)}_fireEvents(t,r,i){const n=Xi(this._eventsInProgress),a=Xi(t),o={};for(const e in t){const{originalEvent:r}=t[e];this._eventsInProgress[e]||(o[`${e}start`]=r),this._eventsInProgress[e]=t[e]}!n&&a&&this._fireEvent("movestart",a.originalEvent);for(const e in o)this._fireEvent(e,o[e]);a&&this._fireEvent("move",a.originalEvent);for(const e in t){const{originalEvent:r}=t[e];this._fireEvent(e,r)}const s={};let l;for(const e in this._eventsInProgress){const{handlerName:t,originalEvent:i}=this._eventsInProgress[e];this._handlersById[t].isActive()||(delete this._eventsInProgress[e],l=r[t]||i,s[`${e}end`]=l)}for(const e in s)this._fireEvent(e,s[e]);const c=Xi(this._eventsInProgress);if(i&&(n||a)&&!c){this._updatingCamera=!0;const t=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),r=e=>0!==e&&-this._bearingSnap<e&&e<this._bearingSnap;t?(r(t.bearing||this._map.getBearing())&&(t.bearing=0),this._map.easeTo(t,{originalEvent:l})):(this._map.fire(new e.Event("moveend",{originalEvent:l})),r(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,r){this._map.fire(new e.Event(t,r?{originalEvent:r}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((e=>{delete this._frameId,this.handleEvent(new Wi("renderFrame",{timeStamp:e})),this._applyChanges()}))}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const Yi={extend:(t,...r)=>e.extend(t,...r),run(e){e()},logToElement(e,t=!1,r="log"){const i=window.document.getElementById(r);i&&(t&&(i.innerHTML=""),i.innerHTML+=`<br>${e}`)}};class Ji extends e.Evented{constructor(t,r){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=r.bearingSnap,e.bindAll(["_renderFrameCallback"],this)}getCenter(){return new e.LngLat(this.transform.center.lng,this.transform.center.lat)}setCenter(e,t){return this.jumpTo({center:e},t)}panBy(t,r,i){return t=e.pointGeometry.convert(t).mult(-1),this.panTo(this.transform.center,e.extend({offset:t},r),i)}panTo(t,r,i){return this.easeTo(e.extend({center:t},r),i)}getZoom(){return this.transform.zoom}setZoom(e,t){return this.jumpTo({zoom:e},t),this}zoomTo(t,r,i){return this.easeTo(e.extend({zoom:t},r),i)}zoomIn(e,t){return this.zoomTo(this.getZoom()+1,e,t),this}zoomOut(e,t){return this.zoomTo(this.getZoom()-1,e,t),this}getBearing(){return this.transform.bearing}setBearing(e,t){return this.jumpTo({bearing:e},t),this}getPadding(){return this.transform.padding}setPadding(e,t){return this.jumpTo({padding:e},t),this}rotateTo(t,r,i){return this.easeTo(e.extend({bearing:t},r),i)}resetNorth(t,r){return this.rotateTo(0,e.extend({duration:1e3},t),r),this}resetNorthPitch(t,r){return this.easeTo(e.extend({bearing:0,pitch:0,duration:1e3},t),r),this}snapToNorth(e,t){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(e,t):this}getPitch(){return this.transform.pitch}setPitch(e,t){return this.jumpTo({pitch:e},t),this}cameraForBounds(t,r){t=e.LngLatBounds.convert(t);const i=r&&r.bearing||0;return this._cameraForBoxAndBearing(t.getNorthWest(),t.getSouthEast(),i,r)}_cameraForBoxAndBearing(t,r,i,n){const a={top:0,bottom:0,right:0,left:0};if("number"==typeof(n=e.extend({padding:a,offset:[0,0],maxZoom:this.transform.maxZoom},n)).padding){const e=n.padding;n.padding={top:e,bottom:e,right:e,left:e}}n.padding=e.extend(a,n.padding);const o=this.transform,s=o.padding,l=o.project(e.LngLat.convert(t)),c=o.project(e.LngLat.convert(r)),u=l.rotate(-i*Math.PI/180),h=c.rotate(-i*Math.PI/180),p=new e.pointGeometry(Math.max(u.x,h.x),Math.max(u.y,h.y)),d=new e.pointGeometry(Math.min(u.x,h.x),Math.min(u.y,h.y)),f=p.sub(d),m=(o.width-(s.left+s.right+n.padding.left+n.padding.right))/f.x,g=(o.height-(s.top+s.bottom+n.padding.top+n.padding.bottom))/f.y;if(g<0||m<0)return void e.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const y=Math.min(o.scaleZoom(o.scale*Math.min(m,g)),n.maxZoom),_=e.pointGeometry.convert(n.offset),x=new e.pointGeometry((n.padding.left-n.padding.right)/2,(n.padding.top-n.padding.bottom)/2).rotate(i*Math.PI/180),v=_.add(x).mult(o.scale/o.zoomScale(y));return{center:o.unproject(l.add(c).div(2).sub(v)),zoom:y,bearing:i}}fitBounds(e,t,r){return this._fitInternal(this.cameraForBounds(e,t),t,r)}fitScreenCoordinates(t,r,i,n,a){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.pointLocation(e.pointGeometry.convert(t)),this.transform.pointLocation(e.pointGeometry.convert(r)),i,n),n,a)}_fitInternal(t,r,i){return t?(delete(r=e.extend(t,r)).padding,r.linear?this.easeTo(r,i):this.flyTo(r,i)):this}jumpTo(t,r){this.stop();const i=this.transform;let n=!1,a=!1,o=!1;return"zoom"in t&&i.zoom!==+t.zoom&&(n=!0,i.zoom=+t.zoom),void 0!==t.center&&(i.center=e.LngLat.convert(t.center)),"bearing"in t&&i.bearing!==+t.bearing&&(a=!0,i.bearing=+t.bearing),"pitch"in t&&i.pitch!==+t.pitch&&(o=!0,i.pitch=+t.pitch),null==t.padding||i.isPaddingEqual(t.padding)||(i.padding=t.padding),this.fire(new e.Event("movestart",r)).fire(new e.Event("move",r)),n&&this.fire(new e.Event("zoomstart",r)).fire(new e.Event("zoom",r)).fire(new e.Event("zoomend",r)),a&&this.fire(new e.Event("rotatestart",r)).fire(new e.Event("rotate",r)).fire(new e.Event("rotateend",r)),o&&this.fire(new e.Event("pitchstart",r)).fire(new e.Event("pitch",r)).fire(new e.Event("pitchend",r)),this.fire(new e.Event("moveend",r))}calculateCameraOptionsFromTo(t,r,i,n=0){const a=e.MercatorCoordinate.fromLngLat(t,r),o=e.MercatorCoordinate.fromLngLat(i,n),s=o.x-a.x,l=o.y-a.y,c=o.z-a.z,u=Math.hypot(s,l,c);if(0===u)throw new Error("Can't calculate camera options with same From and To");const h=Math.hypot(s,l),p=this.transform.scaleZoom(this.transform.cameraToCenterDistance/u/this.transform.tileSize),d=180*Math.atan2(s,-l)/Math.PI;let f=180*Math.acos(h/u)/Math.PI;return f=c<0?90-f:90+f,{center:o.toLngLat(),zoom:p,pitch:f,bearing:d}}easeTo(t,r){this._stop(!1,t.easeId),(!1===(t=e.extend({offset:[0,0],duration:500,easing:e.ease},t)).animate||!t.essential&&e.exported.prefersReducedMotion)&&(t.duration=0);const i=this.transform,n=this.getZoom(),a=this.getBearing(),o=this.getPitch(),s=this.getPadding(),l="zoom"in t?+t.zoom:n,c="bearing"in t?this._normalizeBearing(t.bearing,a):a,u="pitch"in t?+t.pitch:o,h="padding"in t?t.padding:i.padding,p=e.pointGeometry.convert(t.offset);let d=i.centerPoint.add(p);const f=i.pointLocation(d),m=e.LngLat.convert(t.center||f);this._normalizeCenter(m);const g=i.project(f),y=i.project(m).sub(g),_=i.zoomScale(l-n);let x,v;t.around&&(x=e.LngLat.convert(t.around),v=i.locationPoint(x));const b={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=this._zooming||l!==n,this._rotating=this._rotating||a!==c,this._pitching=this._pitching||u!==o,this._padding=!i.isPaddingEqual(h),this._easeId=t.easeId,this._prepareEase(r,t.noMoveStart,b),this._ease((t=>{if(this._zooming&&(i.zoom=e.number(n,l,t)),this._rotating&&(i.bearing=e.number(a,c,t)),this._pitching&&(i.pitch=e.number(o,u,t)),this._padding&&(i.interpolatePadding(s,h,t),d=i.centerPoint.add(p)),x)i.setLocationAtPoint(x,v);else{const e=i.zoomScale(i.zoom-n),r=l>n?Math.min(2,_):Math.max(.5,_),a=Math.pow(r,1-t),o=i.unproject(g.add(y.mult(t*a)).mult(e));i.setLocationAtPoint(i.renderWorldCopies?o.wrap():o,d)}this._fireMoveEvents(r)}),(e=>{this._afterEase(r,e)}),t),this}_prepareEase(t,r,i={}){this._moving=!0,this.fire(new e.Event("freezeElevation",{freeze:!0})),r||i.moving||this.fire(new e.Event("movestart",t)),this._zooming&&!i.zooming&&this.fire(new e.Event("zoomstart",t)),this._rotating&&!i.rotating&&this.fire(new e.Event("rotatestart",t)),this._pitching&&!i.pitching&&this.fire(new e.Event("pitchstart",t))}_fireMoveEvents(t){this.fire(new e.Event("move",t)),this._zooming&&this.fire(new e.Event("zoom",t)),this._rotating&&this.fire(new e.Event("rotate",t)),this._pitching&&this.fire(new e.Event("pitch",t))}_afterEase(t,r){if(this._easeId&&r&&this._easeId===r)return;delete this._easeId,this.fire(new e.Event("freezeElevation",{freeze:!1}));const i=this._zooming,n=this._rotating,a=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,i&&this.fire(new e.Event("zoomend",t)),n&&this.fire(new e.Event("rotateend",t)),a&&this.fire(new e.Event("pitchend",t)),this.fire(new e.Event("moveend",t))}flyTo(t,r){if(!t.essential&&e.exported.prefersReducedMotion){const i=e.pick(t,["center","zoom","bearing","pitch","around"]);return this.jumpTo(i,r)}this.stop(),t=e.extend({offset:[0,0],speed:1.2,curve:1.42,easing:e.ease},t);const i=this.transform,n=this.getZoom(),a=this.getBearing(),o=this.getPitch(),s=this.getPadding(),l="zoom"in t?e.clamp(+t.zoom,i.minZoom,i.maxZoom):n,c="bearing"in t?this._normalizeBearing(t.bearing,a):a,u="pitch"in t?+t.pitch:o,h="padding"in t?t.padding:i.padding,p=i.zoomScale(l-n),d=e.pointGeometry.convert(t.offset);let f=i.centerPoint.add(d);const m=i.pointLocation(f),g=e.LngLat.convert(t.center||m);this._normalizeCenter(g);const y=i.project(m),_=i.project(g).sub(y);let x=t.curve;const v=Math.max(i.width,i.height),b=v/p,w=_.mag();if("minZoom"in t){const r=e.clamp(Math.min(t.minZoom,n,l),i.minZoom,i.maxZoom),a=v/i.zoomScale(r-n);x=Math.sqrt(a/w*2)}const T=x*x;function E(e){const t=(b*b-v*v+(e?-1:1)*T*T*w*w)/(2*(e?b:v)*T*w);return Math.log(Math.sqrt(t*t+1)-t)}function S(e){return(Math.exp(e)-Math.exp(-e))/2}function A(e){return(Math.exp(e)+Math.exp(-e))/2}const I=E(0);let k=function(e){return A(I)/A(I+x*e)},C=function(e){return v*((A(I)*(S(t=I+x*e)/A(t))-S(I))/T)/w;var t},z=(E(1)-I)/x;if(Math.abs(w)<1e-6||!isFinite(z)){if(Math.abs(v-b)<1e-6)return this.easeTo(t,r);const e=b<v?-1:1;z=Math.abs(Math.log(b/v))/x,C=function(){return 0},k=function(t){return Math.exp(e*x*t)}}return t.duration="duration"in t?+t.duration:1e3*z/("screenSpeed"in t?+t.screenSpeed/x:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0),this._zooming=!0,this._rotating=a!==c,this._pitching=u!==o,this._padding=!i.isPaddingEqual(h),this._prepareEase(r,!1),this._ease((t=>{const p=t*z,m=1/k(p);i.zoom=1===t?l:n+i.scaleZoom(m),this._rotating&&(i.bearing=e.number(a,c,t)),this._pitching&&(i.pitch=e.number(o,u,t)),this._padding&&(i.interpolatePadding(s,h,t),f=i.centerPoint.add(d));const x=1===t?g:i.unproject(y.add(_.mult(C(p))).mult(m));i.setLocationAtPoint(i.renderWorldCopies?x.wrap():x,f),this._fireMoveEvents(r)}),(()=>this._afterEase(r)),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(e,t){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const e=this._onEaseEnd;delete this._onEaseEnd,e.call(this,t)}if(!e){const e=this.handlers;e&&e.stop(!1)}return this}_ease(t,r,i){!1===i.animate||0===i.duration?(t(1),r()):(this._easeStart=e.exported.now(),this._easeOptions=i,this._onEaseFrame=t,this._onEaseEnd=r,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((e.exported.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,r){t=e.wrap(t,-180,180);const i=Math.abs(t-r);return Math.abs(t-360-r)<i&&(t-=360),Math.abs(t+360-r)<i&&(t+=360),t}_normalizeCenter(e){const t=this.transform;if(!t.renderWorldCopies||t.lngRange)return;const r=e.lng-t.center.lng;e.lng+=r>180?-360:r<-180?360:0}}class Qi{constructor(t={}){this.options=t,e.bindAll(["_toggleAttribution","_updateData","_updateCompact","_updateCompactMinimize"],this)}getDefaultPosition(){return"bottom-right"}onAdd(e){return this._map=e,this._compact=this.options&&this.options.compact,this._container=a.create("details","maplibregl-ctrl maplibregl-ctrl-attrib mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=a.create("summary","maplibregl-ctrl-attrib-button mapboxgl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=a.create("div","maplibregl-ctrl-attrib-inner mapboxgl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){a.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(e,t){const r=this._map._getUIString(`AttributionControl.${t}`);e.title=r,e.setAttribute("aria-label",r)}_toggleAttribution(){this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show","mapboxgl-compact-show")):(this._container.classList.add("maplibregl-compact-show","mapboxgl-compact-show"),this._container.removeAttribute("open")))}_updateData(e){!e||"metadata"!==e.sourceDataType&&"visibility"!==e.sourceDataType&&"style"!==e.dataType&&"terrain"!==e.type||this._updateAttributions()}_updateAttributions(){if(!this._map.style)return;let e=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?e=e.concat(this.options.customAttribution.map((e=>"string"!=typeof e?"":e))):"string"==typeof this.options.customAttribution&&e.push(this.options.customAttribution)),this._map.style.stylesheet){const e=this._map.style.stylesheet;this.styleOwner=e.owner,this.styleId=e.id}const t=this._map.style.sourceCaches;for(const r in t){const i=t[r];if(i.used||i.usedForTerrain){const t=i.getSource();t.attribution&&e.indexOf(t.attribution)<0&&e.push(t.attribution)}}e=e.filter((e=>String(e).trim())),e.sort(((e,t)=>e.length-t.length)),e=e.filter(((t,r)=>{for(let i=r+1;i<e.length;i++)if(e[i].indexOf(t)>=0)return!1;return!0}));const r=e.join(" | ");r!==this._attribHTML&&(this._attribHTML=r,e.length?(this._innerContainer.innerHTML=r,this._container.classList.remove("maplibregl-attrib-empty","mapboxgl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty","mapboxgl-attrib-empty"),this._updateCompact(),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640||this._compact?!1===this._compact?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","mapboxgl-compact","maplibregl-compact-show","mapboxgl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show","mapboxgl-compact","mapboxgl-compact-show"))}_updateCompactMinimize(){this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show","mapboxgl-compact-show")}}class en{constructor(t={}){this.options=t,e.bindAll(["_updateCompact"],this)}getDefaultPosition(){return"bottom-left"}onAdd(e){this._map=e,this._compact=this.options&&this.options.compact,this._container=a.create("div","maplibregl-ctrl mapboxgl-ctrl");const t=a.create("a","maplibregl-ctrl-logo mapboxgl-ctrl-logo");return t.target="_blank",t.rel="noopener nofollow",t.href="https://maplibre.org/",t.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),t.setAttribute("rel","noopener nofollow"),this._container.appendChild(t),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){a.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}_updateCompact(){const e=this._container.children;if(e.length){const t=e[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?!1!==this._compact&&t.classList.add("maplibregl-compact","mapboxgl-compact"):t.classList.remove("maplibregl-compact","mapboxgl-compact")}}}class tn{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(e){const t=++this._id;return this._queue.push({callback:e,id:t,cancelled:!1}),t}remove(e){const t=this._currentlyRunning,r=t?this._queue.concat(t):this._queue;for(const t of r)if(t.id===e)return void(t.cancelled=!0)}run(e=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const t=this._currentlyRunning=this._queue;this._queue=[];for(const r of t)if(!r.cancelled&&(r.callback(e),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}const rn={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","TerrainControl.enableTerrain":"Enable terrain","TerrainControl.disableTerrain":"Disable terrain"},nn={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:void 0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,maplibreLogo:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",transformRequest:null,fadeDuration:300,crossSourceCollisions:!0},an={showCompass:!0,showZoom:!0,visualizePitch:!1};class on{constructor(t,r,i=!1){this._clickTolerance=10,this.element=r,this.mouseRotate=new Si({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,i&&(this.mousePitch=new Ai({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),e.bindAll(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),a.addEventListener(r,"mousedown",this.mousedown),a.addEventListener(r,"touchstart",this.touchstart,{passive:!1}),a.addEventListener(r,"touchmove",this.touchmove),a.addEventListener(r,"touchend",this.touchend),a.addEventListener(r,"touchcancel",this.reset)}down(e,t){this.mouseRotate.mousedown(e,t),this.mousePitch&&this.mousePitch.mousedown(e,t),a.disableDrag()}move(e,t){const r=this.map,i=this.mouseRotate.mousemoveWindow(e,t);if(i&&i.bearingDelta&&r.setBearing(r.getBearing()+i.bearingDelta),this.mousePitch){const i=this.mousePitch.mousemoveWindow(e,t);i&&i.pitchDelta&&r.setPitch(r.getPitch()+i.pitchDelta)}}off(){const e=this.element;a.removeEventListener(e,"mousedown",this.mousedown),a.removeEventListener(e,"touchstart",this.touchstart,{passive:!1}),a.removeEventListener(e,"touchmove",this.touchmove),a.removeEventListener(e,"touchend",this.touchend),a.removeEventListener(e,"touchcancel",this.reset),this.offTemp()}offTemp(){a.enableDrag(),a.removeEventListener(window,"mousemove",this.mousemove),a.removeEventListener(window,"mouseup",this.mouseup)}mousedown(t){this.down(e.extend({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),a.mousePos(this.element,t)),a.addEventListener(window,"mousemove",this.mousemove),a.addEventListener(window,"mouseup",this.mouseup)}mousemove(e){this.move(e,a.mousePos(this.element,e))}mouseup(e){this.mouseRotate.mouseupWindow(e),this.mousePitch&&this.mousePitch.mouseupWindow(e),this.offTemp()}touchstart(e){1!==e.targetTouches.length?this.reset():(this._startPos=this._lastPos=a.touchPos(this.element,e.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>e.preventDefault()},this._startPos))}touchmove(e){1!==e.targetTouches.length?this.reset():(this._lastPos=a.touchPos(this.element,e.targetTouches)[0],this.move({preventDefault:()=>e.preventDefault()},this._lastPos))}touchend(e){0===e.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function sn(t,r,i){if(t=new e.LngLat(t.lng,t.lat),r){const n=new e.LngLat(t.lng-360,t.lat),a=new e.LngLat(t.lng+360,t.lat),o=i.locationPoint(t).distSqr(r);i.locationPoint(n).distSqr(r)<o?t=n:i.locationPoint(a).distSqr(r)<o&&(t=a)}for(;Math.abs(t.lng-i.center.lng)>180;){const e=i.locationPoint(t);if(e.x>=0&&e.y>=0&&e.x<=i.width&&e.y<=i.height)break;t.lng>i.center.lng?t.lng-=360:t.lng+=360}return t}const ln={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function cn(e,t,r){const i=e.classList;for(const e in ln)i.remove(`maplibregl-${r}-anchor-${e}`,`mapboxgl-${r}-anchor-${e}`);i.add(`maplibregl-${r}-anchor-${t}`,`mapboxgl-${r}-anchor-${t}`)}class un extends e.Evented{constructor(t,r){if(super(),(t instanceof HTMLElement||r)&&(t=e.extend({element:t},r)),e.bindAll(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress"],this),this._anchor=t&&t.anchor||"center",this._color=t&&t.color||"#3FB1CE",this._scale=t&&t.scale||1,this._draggable=t&&t.draggable||!1,this._clickTolerance=t&&t.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=t&&t.rotation||0,this._rotationAlignment=t&&t.rotationAlignment||"auto",this._pitchAlignment=t&&t.pitchAlignment&&"auto"!==t.pitchAlignment?t.pitchAlignment:this._rotationAlignment,t&&t.element)this._element=t.element,this._offset=e.pointGeometry.convert(t&&t.offset||[0,0]);else{this._defaultMarker=!0,this._element=a.create("div"),this._element.setAttribute("aria-label","Map marker");const r=a.createNS("http://www.w3.org/2000/svg","svg"),i=41,n=27;r.setAttributeNS(null,"display","block"),r.setAttributeNS(null,"height",`${i}px`),r.setAttributeNS(null,"width",`${n}px`),r.setAttributeNS(null,"viewBox",`0 0 ${n} ${i}`);const o=a.createNS("http://www.w3.org/2000/svg","g");o.setAttributeNS(null,"stroke","none"),o.setAttributeNS(null,"stroke-width","1"),o.setAttributeNS(null,"fill","none"),o.setAttributeNS(null,"fill-rule","evenodd");const s=a.createNS("http://www.w3.org/2000/svg","g");s.setAttributeNS(null,"fill-rule","nonzero");const l=a.createNS("http://www.w3.org/2000/svg","g");l.setAttributeNS(null,"transform","translate(3.0, 29.0)"),l.setAttributeNS(null,"fill","#000000");const c=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const e of c){const t=a.createNS("http://www.w3.org/2000/svg","ellipse");t.setAttributeNS(null,"opacity","0.04"),t.setAttributeNS(null,"cx","10.5"),t.setAttributeNS(null,"cy","5.80029008"),t.setAttributeNS(null,"rx",e.rx),t.setAttributeNS(null,"ry",e.ry),l.appendChild(t)}const u=a.createNS("http://www.w3.org/2000/svg","g");u.setAttributeNS(null,"fill",this._color);const h=a.createNS("http://www.w3.org/2000/svg","path");h.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),u.appendChild(h);const p=a.createNS("http://www.w3.org/2000/svg","g");p.setAttributeNS(null,"opacity","0.25"),p.setAttributeNS(null,"fill","#000000");const d=a.createNS("http://www.w3.org/2000/svg","path");d.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),p.appendChild(d);const f=a.createNS("http://www.w3.org/2000/svg","g");f.setAttributeNS(null,"transform","translate(6.0, 7.0)"),f.setAttributeNS(null,"fill","#FFFFFF");const m=a.createNS("http://www.w3.org/2000/svg","g");m.setAttributeNS(null,"transform","translate(8.0, 8.0)");const g=a.createNS("http://www.w3.org/2000/svg","circle");g.setAttributeNS(null,"fill","#000000"),g.setAttributeNS(null,"opacity","0.25"),g.setAttributeNS(null,"cx","5.5"),g.setAttributeNS(null,"cy","5.5"),g.setAttributeNS(null,"r","5.4999962");const y=a.createNS("http://www.w3.org/2000/svg","circle");y.setAttributeNS(null,"fill","#FFFFFF"),y.setAttributeNS(null,"cx","5.5"),y.setAttributeNS(null,"cy","5.5"),y.setAttributeNS(null,"r","5.4999962"),m.appendChild(g),m.appendChild(y),s.appendChild(l),s.appendChild(u),s.appendChild(p),s.appendChild(f),s.appendChild(m),r.appendChild(s),r.setAttributeNS(null,"height",i*this._scale+"px"),r.setAttributeNS(null,"width",n*this._scale+"px"),this._element.appendChild(r),this._offset=e.pointGeometry.convert(t&&t.offset||[0,-14])}this._element.classList.add("maplibregl-marker","mapboxgl-marker"),this._element.addEventListener("dragstart",(e=>{e.preventDefault()})),this._element.addEventListener("mousedown",(e=>{e.preventDefault()})),cn(this._element,this._anchor,"marker"),this._popup=null}addTo(e){return this.remove(),this._map=e,e.getCanvasContainer().appendChild(this._element),e.on("move",this._update),e.on("moveend",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),a.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=e.LngLat.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(e){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),e){if(!("offset"in e.options)){const t=38.1,r=13.5,i=Math.sqrt(Math.pow(r,2)/2);e.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-t],"bottom-left":[i,-1*(t-r+i)],"bottom-right":[-i,-1*(t-r+i)],left:[r,-1*(t-r)],right:[-r,-1*(t-r)]}:this._offset}this._popup=e,this._lngLat&&this._popup.setLngLat(this._lngLat),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}_onKeyPress(e){const t=e.code,r=e.charCode||e.keyCode;"Space"!==t&&"Enter"!==t&&32!==r&&13!==r||this.togglePopup()}_onMapClick(e){const t=e.originalEvent.target,r=this._element;this._popup&&(t===r||r.contains(t))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const e=this._popup;return e?(e.isOpen()?e.remove():e.addTo(this._map),this):this}_update(e){if(!this._map)return;this._map.transform.renderWorldCopies&&(this._lngLat=sn(this._lngLat,this._pos,this._map.transform)),this._pos=this._map.project(this._lngLat)._add(this._offset);let t="";"viewport"===this._rotationAlignment||"auto"===this._rotationAlignment?t=`rotateZ(${this._rotation}deg)`:"map"===this._rotationAlignment&&(t=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let r="";"viewport"===this._pitchAlignment||"auto"===this._pitchAlignment?r="rotateX(0deg)":"map"===this._pitchAlignment&&(r=`rotateX(${this._map.getPitch()}deg)`),e&&"moveend"!==e.type||(this._pos=this._pos.round()),a.setTransform(this._element,`${ln[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${r} ${t}`),this._map.style&&this._map.style.terrain&&!this._opacityTimeout&&(this._opacityTimeout=setTimeout((()=>{const e=this._map.unproject(this._pos),t=40075016.686*Math.abs(Math.cos(this._lngLat.lat*Math.PI/180))/Math.pow(2,this._map.transform.tileZoom+8);this._element.style.opacity=e.distanceTo(this._lngLat)>20*t?"0.2":"1.0",this._opacityTimeout=null}),100))}getOffset(){return this._offset}setOffset(t){return this._offset=e.pointGeometry.convert(t),this._update(),this}_onMove(t){if(!this._isDragging){const e=this._clickTolerance||this._map._clickTolerance;this._isDragging=t.point.dist(this._pointerdownPos)>=e}this._isDragging&&(this._pos=t.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new e.Event("dragstart"))),this.fire(new e.Event("drag")))}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),"active"===this._state&&this.fire(new e.Event("dragend")),this._state="inactive"}_addDragHandler(e){this._element.contains(e.originalEvent.target)&&(e.preventDefault(),this._positionDelta=e.point.sub(this._pos).add(this._offset),this._pointerdownPos=e.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))}setDraggable(e){return this._draggable=!!e,this._map&&(e?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(e){return this._rotation=e||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(e){return this._rotationAlignment=e||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(e){return this._pitchAlignment=e&&"auto"!==e?e:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}}const hn={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let pn,dn=0,fn=!1;const mn={maxWidth:100,unit:"metric"};function gn(e,t,r){const i=r&&r.maxWidth||100,n=e._container.clientHeight/2,a=e.unproject([0,n]),o=e.unproject([i,n]),s=a.distanceTo(o);if(r&&"imperial"===r.unit){const r=3.2808*s;r>5280?yn(t,i,r/5280,e._getUIString("ScaleControl.Miles")):yn(t,i,r,e._getUIString("ScaleControl.Feet"))}else r&&"nautical"===r.unit?yn(t,i,s/1852,e._getUIString("ScaleControl.NauticalMiles")):s>=1e3?yn(t,i,s/1e3,e._getUIString("ScaleControl.Kilometers")):yn(t,i,s,e._getUIString("ScaleControl.Meters"))}function yn(e,t,r,i){const n=function(e){const t=Math.pow(10,`${Math.floor(e)}`.length-1);let r=e/t;return r=r>=10?10:r>=5?5:r>=3?3:r>=2?2:r>=1?1:function(e){const t=Math.pow(10,Math.ceil(-Math.log(e)/Math.LN10));return Math.round(e*t)/t}(r),t*r}(r);e.style.width=t*(n/r)+"px",e.innerHTML=`${n}&nbsp;${i}`}const _n={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},xn=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function vn(t){if(t){if("number"==typeof t){const r=Math.round(Math.sqrt(.5*Math.pow(t,2)));return{center:new e.pointGeometry(0,0),top:new e.pointGeometry(0,t),"top-left":new e.pointGeometry(r,r),"top-right":new e.pointGeometry(-r,r),bottom:new e.pointGeometry(0,-t),"bottom-left":new e.pointGeometry(r,-r),"bottom-right":new e.pointGeometry(-r,-r),left:new e.pointGeometry(t,0),right:new e.pointGeometry(-t,0)}}if(t instanceof e.pointGeometry||Array.isArray(t)){const r=e.pointGeometry.convert(t);return{center:r,top:r,"top-left":r,"top-right":r,bottom:r,"bottom-left":r,"bottom-right":r,left:r,right:r}}return{center:e.pointGeometry.convert(t.center||[0,0]),top:e.pointGeometry.convert(t.top||[0,0]),"top-left":e.pointGeometry.convert(t["top-left"]||[0,0]),"top-right":e.pointGeometry.convert(t["top-right"]||[0,0]),bottom:e.pointGeometry.convert(t.bottom||[0,0]),"bottom-left":e.pointGeometry.convert(t["bottom-left"]||[0,0]),"bottom-right":e.pointGeometry.convert(t["bottom-right"]||[0,0]),left:e.pointGeometry.convert(t.left||[0,0]),right:e.pointGeometry.convert(t.right||[0,0])}}return vn(new e.pointGeometry(0,0))}const bn={supported:t,setRTLTextPlugin:e.setRTLTextPlugin,getRTLTextPluginStatus:e.getRTLTextPluginStatus,Map:class extends Ji{constructor(t){var r;if(e.PerformanceUtils.mark(e.PerformanceMarkers.create),null!=(t=e.extend({},nn,t)).minZoom&&null!=t.maxZoom&&t.minZoom>t.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=t.minPitch&&null!=t.maxPitch&&t.minPitch>t.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=t.minPitch&&t.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=t.maxPitch&&t.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(super(new ri(t.minZoom,t.maxZoom,t.minPitch,t.maxPitch,t.renderWorldCopies),{bearingSnap:t.bearingSnap}),this._interactive=t.interactive,this._cooperativeGestures=t.cooperativeGestures,this._maxTileCacheSize=t.maxTileCacheSize,this._failIfMajorPerformanceCaveat=t.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=t.preserveDrawingBuffer,this._antialias=t.antialias,this._trackResize=t.trackResize,this._bearingSnap=t.bearingSnap,this._refreshExpiredTiles=t.refreshExpiredTiles,this._fadeDuration=t.fadeDuration,this._crossSourceCollisions=t.crossSourceCollisions,this._crossFadingFactor=1,this._collectResourceTiming=t.collectResourceTiming,this._renderTaskQueue=new tn,this._controls=[],this._mapId=e.uniqueId(),this._locale=e.extend({},rn,t.locale),this._clickTolerance=t.clickTolerance,this._pixelRatio=null!==(r=t.pixelRatio)&&void 0!==r?r:devicePixelRatio,this._requestManager=new o(t.transformRequest),"string"==typeof t.container){if(this._container=document.getElementById(t.container),!this._container)throw new Error(`Container '${t.container}' not found.`)}else{if(!(t.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=t.container}if(t.maxBounds&&this.setMaxBounds(t.maxBounds),e.bindAll(["_onWindowOnline","_onWindowResize","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this.on("terrain",(()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)})),"undefined"!=typeof window&&(addEventListener("online",this._onWindowOnline,!1),addEventListener("resize",this._onWindowResize,!1),addEventListener("orientationchange",this._onWindowResize,!1)),this.handlers=new Ki(this,t),this._cooperativeGestures&&this._setupCooperativeGestures(),this._hash=t.hash&&new ii("string"==typeof t.hash&&t.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:t.center,zoom:t.zoom,bearing:t.bearing,pitch:t.pitch}),t.bounds&&(this.resize(),this.fitBounds(t.bounds,e.extend({},t.fitBoundsOptions,{duration:0})))),this.resize(),this._localIdeographFontFamily=t.localIdeographFontFamily,t.style&&this.setStyle(t.style,{localIdeographFontFamily:t.localIdeographFontFamily}),t.attributionControl&&this.addControl(new Qi({customAttribution:t.customAttribution})),t.maplibreLogo&&this.addControl(new en,t.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)})),this.on("data",(t=>{this._update("style"===t.dataType),this.fire(new e.Event(`${t.dataType}data`,t))})),this.on("dataloading",(t=>{this.fire(new e.Event(`${t.dataType}dataloading`,t))})),this.on("dataabort",(t=>{this.fire(new e.Event("sourcedataabort",t))}))}_getMapId(){return this._mapId}addControl(t,r){if(void 0===r&&(r=t.getDefaultPosition?t.getDefaultPosition():"top-right"),!t||!t.onAdd)return this.fire(new e.ErrorEvent(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const i=t.onAdd(this);this._controls.push(t);const n=this._controlPositions[r];return-1!==r.indexOf("bottom")?n.insertBefore(i,n.firstChild):n.appendChild(i),this}removeControl(t){if(!t||!t.onRemove)return this.fire(new e.ErrorEvent(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const r=this._controls.indexOf(t);return r>-1&&this._controls.splice(r,1),t.onRemove(this),this}hasControl(e){return this._controls.indexOf(e)>-1}calculateCameraOptionsFromTo(e,t,r,i){return null==i&&this.style.terrain&&(i=this.transform.getElevation(r,this.style.terrain)),super.calculateCameraOptionsFromTo(e,t,r,i)}resize(t){const r=this._containerDimensions(),i=r[0],n=r[1];this._resizeCanvas(i,n,this.getPixelRatio()),this.transform.resize(i,n),this.painter.resize(i,n,this.getPixelRatio());const a=!this._moving;return a&&(this.stop(),this.fire(new e.Event("movestart",t)).fire(new e.Event("move",t))),this.fire(new e.Event("resize",t)),a&&this.fire(new e.Event("moveend",t)),this}getPixelRatio(){return this._pixelRatio}setPixelRatio(e){const[t,r]=this._containerDimensions();this._pixelRatio=e,this._resizeCanvas(t,r,e),this.painter.resize(t,r,e)}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(t){return this.transform.setMaxBounds(e.LngLatBounds.convert(t)),this._update()}setMinZoom(e){if((e=null==e?-2:e)>=-2&&e<=this.transform.maxZoom)return this.transform.minZoom=e,this._update(),this.getZoom()<e&&this.setZoom(e),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(e){if((e=null==e?22:e)>=this.transform.minZoom)return this.transform.maxZoom=e,this._update(),this.getZoom()>e&&this.setZoom(e),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(e){if((e=null==e?0:e)<0)throw new Error("minPitch must be greater than or equal to 0");if(e>=0&&e<=this.transform.maxPitch)return this.transform.minPitch=e,this._update(),this.getPitch()<e&&this.setPitch(e),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(e){if((e=null==e?60:e)>85)throw new Error("maxPitch must be less than or equal to 85");if(e>=this.transform.minPitch)return this.transform.maxPitch=e,this._update(),this.getPitch()>e&&this.setPitch(e),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(e){return this.transform.renderWorldCopies=e,this._update()}project(t){return this.transform.locationPoint(e.LngLat.convert(t),this.style&&this.style.terrain)}unproject(t){return this.transform.pointLocation(e.pointGeometry.convert(t),this.style&&this.style.terrain)}isMoving(){return this._moving||this.handlers.isMoving()}isZooming(){return this._zooming||this.handlers.isZooming()}isRotating(){return this._rotating||this.handlers.isRotating()}_createDelegatedListener(e,t,r){if("mouseenter"===e||"mouseover"===e){let i=!1;const n=n=>{const a=this.getLayer(t)?this.queryRenderedFeatures(n.point,{layers:[t]}):[];a.length?i||(i=!0,r.call(this,new pi(e,this,n.originalEvent,{features:a}))):i=!1};return{layer:t,listener:r,delegates:{mousemove:n,mouseout:()=>{i=!1}}}}if("mouseleave"===e||"mouseout"===e){let i=!1;const n=n=>{(this.getLayer(t)?this.queryRenderedFeatures(n.point,{layers:[t]}):[]).length?i=!0:i&&(i=!1,r.call(this,new pi(e,this,n.originalEvent)))},a=t=>{i&&(i=!1,r.call(this,new pi(e,this,t.originalEvent)))};return{layer:t,listener:r,delegates:{mousemove:n,mouseout:a}}}{const i=e=>{const i=this.getLayer(t)?this.queryRenderedFeatures(e.point,{layers:[t]}):[];i.length&&(e.features=i,r.call(this,e),delete e.features)};return{layer:t,listener:r,delegates:{[e]:i}}}}on(e,t,r){if(void 0===r)return super.on(e,t);const i=this._createDelegatedListener(e,t,r);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[e]=this._delegatedListeners[e]||[],this._delegatedListeners[e].push(i);for(const e in i.delegates)this.on(e,i.delegates[e]);return this}once(e,t,r){if(void 0===r)return super.once(e,t);const i=this._createDelegatedListener(e,t,r);for(const e in i.delegates)this.once(e,i.delegates[e]);return this}off(e,t,r){return void 0===r?super.off(e,t):(this._delegatedListeners&&this._delegatedListeners[e]&&(i=>{const n=this._delegatedListeners[e];for(let e=0;e<n.length;e++){const i=n[e];if(i.layer===t&&i.listener===r){for(const e in i.delegates)this.off(e,i.delegates[e]);return n.splice(e,1),this}}})(),this)}queryRenderedFeatures(t,r){if(!this.style)return[];let i;if(void 0!==r||void 0===t||t instanceof e.pointGeometry||Array.isArray(t)||(r=t,t=void 0),r=r||{},(t=t||[[0,0],[this.transform.width,this.transform.height]])instanceof e.pointGeometry||"number"==typeof t[0])i=[e.pointGeometry.convert(t)];else{const r=e.pointGeometry.convert(t[0]),n=e.pointGeometry.convert(t[1]);i=[r,new e.pointGeometry(n.x,r.y),n,new e.pointGeometry(r.x,n.y),r]}return this.style.queryRenderedFeatures(i,r,this.transform)}querySourceFeatures(e,t){return this.style.querySourceFeatures(e,t)}setStyle(t,r){return!1!==(r=e.extend({},{localIdeographFontFamily:this._localIdeographFontFamily},r)).diff&&r.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&t?(this._diffStyle(t,r),this):(this._localIdeographFontFamily=r.localIdeographFontFamily,this._updateStyle(t,r))}setTransformRequest(e){return this._requestManager.setTransformRequest(e),this}_getUIString(e){const t=this._locale[e];if(null==t)throw new Error(`Missing UI string '${e}'`);return t}_updateStyle(e,t){return this.style&&(this.style.setEventedParent(null),this.style._remove()),e?(this.style=new tt(this,t||{}),this.style.setEventedParent(this,{style:this.style}),"string"==typeof e?this.style.loadURL(e):this.style.loadJSON(e),this):(delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new tt(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(t,r){if("string"==typeof t){const i=this._requestManager.transformRequest(t,e.ResourceType.Style);e.getJSON(i,((t,i)=>{t?this.fire(new e.ErrorEvent(t)):i&&this._updateDiff(i,r)}))}else"object"==typeof t&&this._updateDiff(t,r)}_updateDiff(t,r){try{this.style.setState(t)&&this._update(!0)}catch(i){e.warnOnce(`Unable to perform style diff: ${i.message||i.error||i}.  Rebuilding the style from scratch.`),this._updateStyle(t,r)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():e.warnOnce("There is no style added to the map.")}addSource(e,t){return this._lazyInitEmptyStyle(),this.style.addSource(e,t),this._update(!0)}isSourceLoaded(t){const r=this.style&&this.style.sourceCaches[t];if(void 0!==r)return r.loaded();this.fire(new e.ErrorEvent(new Error(`There is no source with ID '${t}'`)))}setTerrain(e){return this.style.setTerrain(e),this}getTerrain(){return this.style.terrain&&this.style.terrain.options}areTilesLoaded(){const e=this.style&&this.style.sourceCaches;for(const t in e){const r=e[t]._tiles;for(const e in r){const t=r[e];if("loaded"!==t.state&&"errored"!==t.state)return!1}}return!0}addSourceType(e,t,r){return this._lazyInitEmptyStyle(),this.style.addSourceType(e,t,r)}removeSource(e){return this.style.removeSource(e),this._update(!0)}getSource(e){return this.style.getSource(e)}addImage(t,r,{pixelRatio:i=1,sdf:n=!1,stretchX:a,stretchY:o,content:s}={}){if(this._lazyInitEmptyStyle(),r instanceof HTMLImageElement||e.isImageBitmap(r)){const{width:l,height:c,data:u}=e.exported.getImageData(r);this.style.addImage(t,{data:new e.RGBAImage({width:l,height:c},u),pixelRatio:i,stretchX:a,stretchY:o,content:s,sdf:n,version:0})}else{if(void 0===r.width||void 0===r.height)return this.fire(new e.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:l,height:c,data:u}=r,h=r;this.style.addImage(t,{data:new e.RGBAImage({width:l,height:c},new Uint8Array(u)),pixelRatio:i,stretchX:a,stretchY:o,content:s,sdf:n,version:0,userImage:h}),h.onAdd&&h.onAdd(this,t)}}}updateImage(t,r){const i=this.style.getImage(t);if(!i)return this.fire(new e.ErrorEvent(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const n=r instanceof HTMLImageElement||e.isImageBitmap(r)?e.exported.getImageData(r):r,{width:a,height:o,data:s}=n;if(void 0===a||void 0===o)return this.fire(new e.ErrorEvent(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(a!==i.data.width||o!==i.data.height)return this.fire(new e.ErrorEvent(new Error("The width and height of the updated image must be that same as the previous version of the image")));const l=!(r instanceof HTMLImageElement||e.isImageBitmap(r));i.data.replace(s,l),this.style.updateImage(t,i)}hasImage(t){return t?!!this.style.getImage(t):(this.fire(new e.ErrorEvent(new Error("Missing required image id"))),!1)}removeImage(e){this.style.removeImage(e)}loadImage(t,r){e.getImage(this._requestManager.transformRequest(t,e.ResourceType.Image),r)}listImages(){return this.style.listImages()}addLayer(e,t){return this._lazyInitEmptyStyle(),this.style.addLayer(e,t),this._update(!0)}moveLayer(e,t){return this.style.moveLayer(e,t),this._update(!0)}removeLayer(e){return this.style.removeLayer(e),this._update(!0)}getLayer(e){return this.style.getLayer(e)}setLayerZoomRange(e,t,r){return this.style.setLayerZoomRange(e,t,r),this._update(!0)}setFilter(e,t,r={}){return this.style.setFilter(e,t,r),this._update(!0)}getFilter(e){return this.style.getFilter(e)}setPaintProperty(e,t,r,i={}){return this.style.setPaintProperty(e,t,r,i),this._update(!0)}getPaintProperty(e,t){return this.style.getPaintProperty(e,t)}setLayoutProperty(e,t,r,i={}){return this.style.setLayoutProperty(e,t,r,i),this._update(!0)}getLayoutProperty(e,t){return this.style.getLayoutProperty(e,t)}setLight(e,t={}){return this._lazyInitEmptyStyle(),this.style.setLight(e,t),this._update(!0)}getLight(){return this.style.getLight()}setFeatureState(e,t){return this.style.setFeatureState(e,t),this._update()}removeFeatureState(e,t){return this.style.removeFeatureState(e,t),this._update()}getFeatureState(e){return this.style.getFeatureState(e)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let e=0,t=0;return this._container&&(e=this._container.clientWidth||400,t=this._container.clientHeight||300),[e,t]}_setupContainer(){const e=this._container;e.classList.add("maplibregl-map","mapboxgl-map");const t=this._canvasContainer=a.create("div","maplibregl-canvas-container mapboxgl-canvas-container",e);this._interactive&&t.classList.add("maplibregl-interactive","mapboxgl-interactive"),this._canvas=a.create("canvas","maplibregl-canvas mapboxgl-canvas",t),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label","Map"),this._canvas.setAttribute("role","region");const r=this._containerDimensions();this._resizeCanvas(r[0],r[1],this.getPixelRatio());const i=this._controlContainer=a.create("div","maplibregl-control-container mapboxgl-control-container",e),n=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach((e=>{n[e]=a.create("div",`maplibregl-ctrl-${e} mapboxgl-ctrl-${e}`,i)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_setupCooperativeGestures(){const e=this._container;this._metaPress=!1,this._cooperativeGesturesScreen=a.create("div","maplibregl-cooperative-gesture-screen",e);let t="Control",r="boolean"!=typeof this._cooperativeGestures&&this._cooperativeGestures.windowsHelpText?this._cooperativeGestures.windowsHelpText:"Use Ctrl + scroll to zoom the map";0===navigator.platform.indexOf("Mac")&&(r="boolean"!=typeof this._cooperativeGestures&&this._cooperativeGestures.macHelpText?this._cooperativeGestures.macHelpText:"Use ⌘ + scroll to zoom the map",t="Meta"),this._cooperativeGesturesScreen.innerHTML=`\n            <div class="maplibregl-desktop-message">${r}</div>\n            <div class="maplibregl-mobile-message">${"boolean"!=typeof this._cooperativeGestures&&this._cooperativeGestures.mobileHelpText?this._cooperativeGestures.mobileHelpText:"Use two fingers to move the map"}</div>\n        `,document.addEventListener("keydown",(e=>{e.key===t&&(this._metaPress=!0)})),document.addEventListener("keyup",(e=>{e.key===t&&(this._metaPress=!1)})),this._canvasContainer.addEventListener("wheel",(e=>{this._onCooperativeGesture(e,this._metaPress,1)}),!1),this._canvasContainer.classList.remove("mapboxgl-touch-drag-pan","maplibregl-touch-drag-pan")}_resizeCanvas(e,t,r){this._canvas.width=r*e,this._canvas.height=r*t,this._canvas.style.width=`${e}px`,this._canvas.style.height=`${t}px`}_setupPainter(){const r=e.extend({},t.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),i=this._canvas.getContext("webgl",r)||this._canvas.getContext("experimental-webgl",r);i?(this.painter=new Jr(i,this.transform),e.exported$1.testSupport(i)):this.fire(new e.ErrorEvent(new Error("Failed to initialize WebGL")))}_contextLost(t){t.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new e.Event("webglcontextlost",{originalEvent:t}))}_contextRestored(t){this._setupPainter(),this.resize(),this._update(),this.fire(new e.Event("webglcontextrestored",{originalEvent:t}))}_onMapScroll(e){if(e.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}_onCooperativeGesture(e,t,r){return!t&&r<2&&(this._cooperativeGesturesScreen.classList.add("maplibregl-show"),setTimeout((()=>{this._cooperativeGesturesScreen.classList.remove("maplibregl-show")}),100)),!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(e){return this.style?(this._styleDirty=this._styleDirty||e,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(e){return this._update(),this._renderTaskQueue.add(e)}_cancelRenderFrame(e){this._renderTaskQueue.remove(e)}_render(t){let r,i=0;const n=this.painter.context.extTimerQuery;if(this.listens("gpu-timing-frame")&&(r=n.createQueryEXT(),n.beginQueryEXT(n.TIME_ELAPSED_EXT,r),i=e.exported.now()),this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(t),this._removed)return;let a=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const t=this.transform.zoom,r=e.exported.now();this.style.zoomHistory.update(t,r);const i=new e.EvaluationParameters(t,{now:r,fadeDuration:this._fadeDuration,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),n=i.crossFadingFactor();1===n&&n===this._crossFadingFactor||(a=!0,this._crossFadingFactor=n),this.style.update(i)}if(this.style&&this._sourcesDirty&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.style.terrain&&this.style.terrain.sourceCache.update(this.transform,this.style.terrain),this.transform.updateElevation(this.style.terrain),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,this._fadeDuration,this._crossSourceCollisions),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:this._fadeDuration,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer")}),this.fire(new e.Event("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,e.PerformanceUtils.mark(e.PerformanceMarkers.load),this.fire(new e.Event("load"))),this.style&&(this.style.hasTransitions()||a)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),this.listens("gpu-timing-frame")){const t=e.exported.now()-i;n.endQueryEXT(n.TIME_ELAPSED_EXT,r),setTimeout((()=>{const i=n.getQueryObjectEXT(r,n.QUERY_RESULT_EXT)/1e6;n.deleteQueryEXT(r),this.fire(new e.Event("gpu-timing-frame",{cpuTime:t,gpuTime:i}))}),50)}if(this.listens("gpu-timing-layer")){const t=this.painter.collectGpuTimers();setTimeout((()=>{const r=this.painter.queryGpuTimers(t);this.fire(new e.Event("gpu-timing-layer",{layerTimes:r}))}),50)}const o=this._sourcesDirty||this._styleDirty||this._placementDirty;return o||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new e.Event("idle")),!this._loaded||this._fullyLoaded||o||(this._fullyLoaded=!0,e.PerformanceUtils.mark(e.PerformanceMarkers.fullLoad)),this}redraw(){return this.style&&(this._frame&&(this._frame.cancel(),this._frame=null),this._render(0)),this}remove(){this._hash&&this._hash.remove();for(const e of this._controls)e.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),"undefined"!=typeof window&&(removeEventListener("resize",this._onWindowResize,!1),removeEventListener("orientationchange",this._onWindowResize,!1),removeEventListener("online",this._onWindowOnline,!1));const t=this.painter.context.gl.getExtension("WEBGL_lose_context");t&&t.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),a.remove(this._canvasContainer),a.remove(this._controlContainer),this._cooperativeGestures&&a.remove(this._cooperativeGesturesScreen),this._container.classList.remove("maplibregl-map","mapboxgl-map"),e.PerformanceUtils.clearMetrics(),this._removed=!0,this.fire(new e.Event("remove"))}triggerRepaint(){this.style&&!this._frame&&(this._frame=e.exported.frame((t=>{e.PerformanceUtils.frame(t),this._frame=null,this._render(t)})))}_onWindowOnline(){this._update()}_onWindowResize(e){this._trackResize&&this.resize({originalEvent:e})._update()}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(e){this._showTileBoundaries!==e&&(this._showTileBoundaries=e,this._update())}get showPadding(){return!!this._showPadding}set showPadding(e){this._showPadding!==e&&(this._showPadding=e,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(e){this._showCollisionBoxes!==e&&(this._showCollisionBoxes=e,e?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(e){this._showOverdrawInspector!==e&&(this._showOverdrawInspector=e,this._update())}get repaint(){return!!this._repaint}set repaint(e){this._repaint!==e&&(this._repaint=e,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(e){this._vertices=e,this._update()}_setCacheLimits(t,r){e.setCacheLimits(t,r)}get version(){return"2.4.0"}},NavigationControl:class{constructor(t){this.options=e.extend({},an,t),this._container=a.create("div","maplibregl-ctrl maplibregl-ctrl-group mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(e=>e.preventDefault())),this.options.showZoom&&(e.bindAll(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in mapboxgl-ctrl-zoom-in",(e=>this._map.zoomIn({},{originalEvent:e}))),a.create("span","maplibregl-ctrl-icon mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out mapboxgl-ctrl-zoom-out",(e=>this._map.zoomOut({},{originalEvent:e}))),a.create("span","maplibregl-ctrl-icon mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(e.bindAll(["_rotateCompassArrow"],this),this._compass=this._createButton("maplibregl-ctrl-compass mapboxgl-ctrl-compass",(e=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:e}):this._map.resetNorth({},{originalEvent:e})})),this._compassIcon=a.create("span","maplibregl-ctrl-icon mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const e=this._map.getZoom(),t=e===this._map.getMaxZoom(),r=e===this._map.getMinZoom();this._zoomInButton.disabled=t,this._zoomOutButton.disabled=r,this._zoomInButton.setAttribute("aria-disabled",t.toString()),this._zoomOutButton.setAttribute("aria-disabled",r.toString())}_rotateCompassArrow(){const e=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitch*(Math.PI/180)),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${this._map.transform.angle*(180/Math.PI)}deg)`:`rotate(${this._map.transform.angle*(180/Math.PI)}deg)`;this._compassIcon.style.transform=e}onAdd(e){return this._map=e,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new on(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){a.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(e,t){const r=a.create("button",e,this._container);return r.type="button",r.addEventListener("click",t),r}_setButtonTitle(e,t){const r=this._map._getUIString(`NavigationControl.${t}`);e.title=r,e.setAttribute("aria-label",r)}},GeolocateControl:class extends e.Evented{constructor(t){super(),this.options=e.extend({},hn,t),e.bindAll(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker"],this)}onAdd(e){var t;return this._map=e,this._container=a.create("div","maplibregl-ctrl maplibregl-ctrl-group mapboxgl-ctrl mapboxgl-ctrl-group"),t=this._setupUI,void 0!==pn?t(pn):void 0!==window.navigator.permissions?window.navigator.permissions.query({name:"geolocation"}).then((e=>{pn="denied"!==e.state,t(pn)})):(pn=!!window.navigator.geolocation,t(pn)),this._container}onRemove(){void 0!==this._geolocationWatchID&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),a.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,dn=0,fn=!1}_isOutOfMapMaxBounds(e){const t=this._map.getMaxBounds(),r=e.coords;return t&&(r.longitude<t.getWest()||r.longitude>t.getEast()||r.latitude<t.getSouth()||r.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error","mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error","mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background","mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error","mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_onSuccess(t){if(this._map){if(this._isOutOfMapMaxBounds(t))return this._setErrorState(),this.fire(new e.Event("outofmaxbounds",t)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=t,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error","mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error","mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background","mapboxgl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(t),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(t),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale","mapboxgl-user-location-dot-stale"),this.fire(new e.Event("geolocate",t)),this._finish()}}_updateCamera(t){const r=new e.LngLat(t.coords.longitude,t.coords.latitude),i=t.coords.accuracy,n=this._map.getBearing(),a=e.extend({bearing:n},this.options.fitBoundsOptions);this._map.fitBounds(r.toBounds(i),a,{geolocateSource:!0})}_updateMarker(t){if(t){const r=new e.LngLat(t.coords.longitude,t.coords.latitude);this._accuracyCircleMarker.setLngLat(r).addTo(this._map),this._userLocationDotMarker.setLngLat(r).addTo(this._map),this._accuracy=t.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const e=this._map._container.clientHeight/2,t=this._map.unproject([0,e]),r=this._map.unproject([1,e]),i=t.distanceTo(r),n=Math.ceil(2*this._accuracy/i);this._circleElement.style.width=`${n}px`,this._circleElement.style.height=`${n}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_onError(t){if(this._map){if(this.options.trackUserLocation)if(1===t.code){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error","mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background","mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error","mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const e=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=e,this._geolocateButton.setAttribute("aria-label",e),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===t.code&&fn)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale","mapboxgl-user-location-dot-stale"),this.fire(new e.Event("error",t)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(t){if(this._container.addEventListener("contextmenu",(e=>e.preventDefault())),this._geolocateButton=a.create("button","maplibregl-ctrl-geolocate mapboxgl-ctrl-geolocate",this._container),a.create("span","maplibregl-ctrl-icon mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===t){e.warnOnce("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=t,this._geolocateButton.setAttribute("aria-label",t)}else{const e=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.title=e,this._geolocateButton.setAttribute("aria-label",e)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=a.create("div","maplibregl-user-location-dot mapboxgl-user-location-dot"),this._userLocationDotMarker=new un(this._dotElement),this._circleElement=a.create("div","maplibregl-user-location-accuracy-circle mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new un({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(t=>{t.geolocateSource||"ACTIVE_LOCK"!==this._watchState||t.originalEvent&&"resize"===t.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background","mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active"),this.fire(new e.Event("trackuserlocationend")))}))}trigger(){if(!this._setup)return e.warnOnce("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new e.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":dn--,fn=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error","mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background","mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error","mapboxgl-ctrl-geolocate-background-error"),this.fire(new e.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background","mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new e.Event("trackuserlocationstart"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let e;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),dn++,dn>1?(e={maximumAge:6e5,timeout:0},fn=!0):(e=this.options.positionOptions,fn=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,e)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Qi,LogoControl:en,ScaleControl:class{constructor(t){this.options=e.extend({},mn,t),e.bindAll(["_onMove","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_onMove(){gn(this._map,this._container,this.options)}onAdd(e){return this._map=e,this._container=a.create("div","maplibregl-ctrl maplibregl-ctrl-scale mapboxgl-ctrl mapboxgl-ctrl-scale",e.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){a.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}setUnit(e){this.options.unit=e,gn(this._map,this._container,this.options)}},FullscreenControl:class{constructor(t){this._fullscreen=!1,t&&t.container&&(t.container instanceof HTMLElement?this._container=t.container:e.warnOnce("Full screen control 'container' must be a DOM element.")),e.bindAll(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(t){return this._map=t,this._container||(this._container=this._map.getContainer()),this._controlContainer=a.create("div","maplibregl-ctrl maplibregl-ctrl-group mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",e.warnOnce("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){a.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!!(document.fullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled||document.webkitFullscreenEnabled)}_setupUI(){const e=this._fullscreenButton=a.create("button","maplibregl-ctrl-fullscreen mapboxgl-ctrl-fullscreen",this._controlContainer);a.create("span","maplibregl-ctrl-icon mapboxgl-ctrl-icon",e).setAttribute("aria-hidden","true"),e.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const e=this._getTitle();this._fullscreenButton.setAttribute("aria-label",e),this._fullscreenButton.title=e}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen&&window.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},TerrainControl:class{constructor(t){this.options=t,e.bindAll(["_toggleTerrain","_updateTerrainIcon"],this)}onAdd(e){return this._map=e,this._container=a.create("div","maplibregl-ctrl maplibregl-ctrl-group mapboxgl-ctrl mapboxgl-ctrl-group"),this._terrainButton=a.create("button","maplibregl-ctrl-terrain mapboxgl-ctrl-terrain",this._container),a.create("span","maplibregl-ctrl-icon mapboxgl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){a.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}_toggleTerrain(){this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()}_updateTerrainIcon(){this._terrainButton.classList.remove("maplibregl-ctrl-terrain","mapboxgl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled","mapboxgl-ctrl-terrain-enabled"),this._map.style.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled","mapboxgl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.disableTerrain")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain","mapboxgl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.enableTerrain"))}},Popup:class extends e.Evented{constructor(t){super(),this.options=e.extend(Object.create(_n),t),e.bindAll(["_update","_onClose","remove","_onMouseMove","_onMouseUp","_onDrag"],this)}addTo(t){return this._map&&this.remove(),this._map=t,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer","mapboxgl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer","mapboxgl-track-pointer")):this._map.on("move",this._update),this.fire(new e.Event("open")),this}isOpen(){return!!this._map}remove(){return this._content&&a.remove(this._content),this._container&&(a.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),delete this._map),this.fire(new e.Event("close")),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=e.LngLat.convert(t),this._pos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer","mapboxgl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer","mapboxgl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer","mapboxgl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer","mapboxgl-track-pointer")),this}getElement(){return this._container}setText(e){return this.setDOMContent(document.createTextNode(e))}setHTML(e){const t=document.createDocumentFragment(),r=document.createElement("body");let i;for(r.innerHTML=e;i=r.firstChild,i;)t.appendChild(i);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(e){return this.options.maxWidth=e,this._update(),this}setDOMContent(e){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=a.create("div","maplibregl-popup-content mapboxgl-popup-content",this._container);return this._content.appendChild(e),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(e){this._container&&this._container.classList.add(e)}removeClassName(e){this._container&&this._container.classList.remove(e)}setOffset(e){return this.options.offset=e,this._update(),this}toggleClassName(e){if(this._container)return this._container.classList.toggle(e)}_createCloseButton(){this.options.closeButton&&(this._closeButton=a.create("button","maplibregl-popup-close-button mapboxgl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.setAttribute("aria-label","Close popup"),this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_onMouseUp(e){this._update(e.point)}_onMouseMove(e){this._update(e.point)}_onDrag(e){this._update(e.point)}_update(e){if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(this._container||(this._container=a.create("div","maplibregl-popup mapboxgl-popup",this._map.getContainer()),this._tip=a.create("div","maplibregl-popup-tip mapboxgl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className&&this.options.className.split(" ").forEach((e=>this._container.classList.add(e))),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer","mapboxgl-popup-track-pointer")),this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._map.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=sn(this._lngLat,this._pos,this._map.transform)),this._trackPointer&&!e)return;const t=this._pos=this._trackPointer&&e?e:this._map.project(this._lngLat);let r=this.options.anchor;const i=vn(this.options.offset);if(!r){const e=this._container.offsetWidth,n=this._container.offsetHeight;let a;a=t.y+i.bottom.y<n?["top"]:t.y>this._map.transform.height-n?["bottom"]:[],t.x<e/2?a.push("left"):t.x>this._map.transform.width-e/2&&a.push("right"),r=0===a.length?"bottom":a.join("-")}const n=t.add(i[r]).round();a.setTransform(this._container,`${ln[r]} translate(${n.x}px,${n.y}px)`),cn(this._container,r,"popup")}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const e=this._container.querySelector(xn);e&&e.focus()}_onClose(){this.remove()}},Marker:un,Style:tt,LngLat:e.LngLat,LngLatBounds:e.LngLatBounds,Point:e.pointGeometry,MercatorCoordinate:e.MercatorCoordinate,Evented:e.Evented,AJAXError:e.AJAXError,config:e.config,CanvasSource:z,GeoJSONSource:A,ImageSource:k,RasterDEMTileSource:S,RasterTileSource:T,VectorTileSource:w,VideoSource:C,prewarm:function(){G().acquire($)},clearPrewarmedResources:function(){const e=q;e&&(e.isPreloaded()&&1===e.numActive()?(e.release($),q=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get version(){return"2.4.0"},get workerCount(){return N.workerCount},set workerCount(e){N.workerCount=e},get maxParallelImageRequests(){return e.config.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(t){e.config.MAX_PARALLEL_IMAGE_REQUESTS=t},clearStorage(t){e.clearTileCache(t)},workerUrl:"",addProtocol(t,r){e.config.REGISTERED_PROTOCOLS[t]=r},removeProtocol(t){delete e.config.REGISTERED_PROTOCOLS[t]}};return Yi.extend(bn,{isSafari:e.isSafari,getPerformanceMetrics:e.PerformanceUtils.getPerformanceMetrics}),bn})),r}()})),le=oe((function(e,t){e.exports=function(){var e=function(e){return e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Float32Array||e instanceof Float64Array||e instanceof Uint8ClampedArray},t=function(e,t){for(var r=Object.keys(t),i=0;i<r.length;++i)e[r[i]]=t[r[i]];return e},r="\n";function i(e){return"undefined"!=typeof atob?atob(e):"base64:"+e}function n(e){var t=new Error("(regl) "+e);throw console.error(t),t}function a(e,t){e||n(t)}function o(e){return e?": "+e:""}function s(e,t,r){e in t||n("unknown parameter ("+e+")"+o(r)+". possible values: "+Object.keys(t).join())}function l(t,r){e(t)||n("invalid parameter type"+o(r)+". must be a typed array")}function c(e,t){switch(t){case"number":return"number"==typeof e;case"object":return"object"==typeof e;case"string":return"string"==typeof e;case"boolean":return"boolean"==typeof e;case"function":return"function"==typeof e;case"undefined":return void 0===e;case"symbol":return"symbol"==typeof e}}function u(e,t,r){c(e,t)||n("invalid parameter type"+o(r)+". expected "+t+", got "+typeof e)}function h(e,t){e>=0&&(0|e)===e||n("invalid parameter type, ("+e+")"+o(t)+". must be a nonnegative integer")}function p(e,t,r){t.indexOf(e)<0&&n("invalid value"+o(r)+". must be one of: "+t)}var d=["gl","canvas","container","attributes","pixelRatio","extensions","optionalExtensions","profile","onDone"];function f(e){Object.keys(e).forEach((function(e){d.indexOf(e)<0&&n('invalid regl constructor argument "'+e+'". must be one of '+d)}))}function m(e,t){for(e+="";e.length<t;)e=" "+e;return e}function g(){this.name="unknown",this.lines=[],this.index={},this.hasErrors=!1}function y(e,t){this.number=e,this.line=t,this.errors=[]}function _(e,t,r){this.file=e,this.line=t,this.message=r}function x(){var e=new Error,t=(e.stack||e).toString(),r=/compileProcedure.*\n\s*at.*\((.*)\)/.exec(t);if(r)return r[1];var i=/compileProcedure.*\n\s*at\s+(.*)(\n|$)/.exec(t);return i?i[1]:"unknown"}function v(){var e=new Error,t=(e.stack||e).toString(),r=/at REGLCommand.*\n\s+at.*\((.*)\)/.exec(t);if(r)return r[1];var i=/at REGLCommand.*\n\s+at\s+(.*)\n/.exec(t);return i?i[1]:"unknown"}function b(e,t){var r=e.split("\n"),n=1,a=0,o={unknown:new g,0:new g};o.unknown.name=o[0].name=t||x(),o.unknown.lines.push(new y(0,""));for(var s=0;s<r.length;++s){var l=r[s],c=/^\s*#\s*(\w+)\s+(.+)\s*$/.exec(l);if(c)switch(c[1]){case"line":var u=/(\d+)(\s+\d+)?/.exec(c[2]);u&&(n=0|u[1],u[2]&&((a=0|u[2])in o||(o[a]=new g)));break;case"define":var h=/SHADER_NAME(_B64)?\s+(.*)$/.exec(c[2]);h&&(o[a].name=h[1]?i(h[2]):h[2])}o[a].lines.push(new y(n++,l))}return Object.keys(o).forEach((function(e){var t=o[e];t.lines.forEach((function(e){t.index[e.number]=e}))})),o}function w(e){var t=[];return e.split("\n").forEach((function(e){if(!(e.length<5)){var r=/^ERROR:\s+(\d+):(\d+):\s*(.*)$/.exec(e);r?t.push(new _(0|r[1],0|r[2],r[3].trim())):e.length>0&&t.push(new _("unknown",0,e))}})),t}function T(e,t){t.forEach((function(t){var r=e[t.file];if(r){var i=r.index[t.line];if(i)return i.errors.push(t),void(r.hasErrors=!0)}e.unknown.hasErrors=!0,e.unknown.lines[0].errors.push(t)}))}function E(e,t,i,n,o){if(!e.getShaderParameter(t,e.COMPILE_STATUS)){var s=e.getShaderInfoLog(t),l=n===e.FRAGMENT_SHADER?"fragment":"vertex";M(i,"string",l+" shader source must be a string",o);var c=b(i,o),u=w(s);T(c,u),Object.keys(c).forEach((function(e){var t=c[e];if(t.hasErrors){var i=[""],n=[""];a("file number "+e+": "+t.name+"\n","color:red;text-decoration:underline;font-weight:bold"),t.lines.forEach((function(e){if(e.errors.length>0){a(m(e.number,4)+"|  ","background-color:yellow; font-weight:bold"),a(e.line+r,"color:red; background-color:yellow; font-weight:bold");var t=0;e.errors.forEach((function(i){var n=i.message,o=/^\s*'(.*)'\s*:\s*(.*)$/.exec(n);if(o){var s=o[1];n=o[2],"assign"===s&&(s="="),t=Math.max(e.line.indexOf(s,t),0)}else t=0;a(m("| ",6)),a(m("^^^",t+3)+r,"font-weight:bold"),a(m("| ",6)),a(n+r,"font-weight:bold")})),a(m("| ",6)+r)}else a(m(e.number,4)+"|  "),a(e.line+r,"color:red")})),"undefined"==typeof document||window.chrome?console.log(i.join("")):(n[0]=i.join("%c"),console.log.apply(console,n))}function a(e,t){i.push(e),n.push(t||"")}})),a.raise("Error compiling "+l+" shader, "+c[0].name)}}function S(e,t,i,n,o){if(!e.getProgramParameter(t,e.LINK_STATUS)){var s=e.getProgramInfoLog(t),l=b(i,o),c='Error linking program with vertex shader, "'+b(n,o)[0].name+'", and fragment shader "'+l[0].name+'"';"undefined"!=typeof document?console.log("%c"+c+r+"%c"+s,"color:red;text-decoration:underline;font-weight:bold","color:red"):console.log(c+r+s),a.raise(c)}}function A(e){e._commandRef=x()}function I(e,t,r,i){function n(e){return e?i.id(e):0}function a(e,t){Object.keys(t).forEach((function(t){e[i.id(t)]=!0}))}A(e),e._fragId=n(e.static.frag),e._vertId=n(e.static.vert);var o=e._uniformSet={};a(o,t.static),a(o,t.dynamic);var s=e._attributeSet={};a(s,r.static),a(s,r.dynamic),e._hasCount="count"in e.static||"count"in e.dynamic||"elements"in e.static||"elements"in e.dynamic}function k(e,t){var r=v();n(e+" in command "+(t||x())+("unknown"===r?"":" called from "+r))}function C(e,t,r){e||k(t,r||x())}function z(e,t,r,i){e in t||k("unknown parameter ("+e+")"+o(r)+". possible values: "+Object.keys(t).join(),i||x())}function M(e,t,r,i){c(e,t)||k("invalid parameter type"+o(r)+". expected "+t+", got "+typeof e,i||x())}function P(e){e()}function D(e,t,r){e.texture?p(e.texture._texture.internalformat,t,"unsupported texture format for attachment"):p(e.renderbuffer._renderbuffer.format,r,"unsupported renderbuffer format for attachment")}var L=33071,B=9728,R=9984,F=9985,O=9986,U=9987,V=5121,$=5122,N=5123,j=5124,q=5125,G=5126,Z=32819,X=32820,W=33635,H=34042,K=36193,Y={};function J(e,t){return e===X||e===Z||e===W?2:e===H?4:Y[e]*t}function Q(e){return!(e&e-1||!e)}function ee(e,t,r){var i,n=t.width,o=t.height,s=t.channels;a(n>0&&n<=r.maxTextureSize&&o>0&&o<=r.maxTextureSize,"invalid texture shape"),e.wrapS===L&&e.wrapT===L||a(Q(n)&&Q(o),"incompatible wrap mode for texture, both width and height must be power of 2"),1===t.mipmask?1!==n&&1!==o&&a(e.minFilter!==R&&e.minFilter!==O&&e.minFilter!==F&&e.minFilter!==U,"min filter requires mipmap"):(a(Q(n)&&Q(o),"texture must be a square power of 2 to support mipmapping"),a(t.mipmask===(n<<1)-1,"missing or incomplete mipmap data")),t.type===G&&(r.extensions.indexOf("oes_texture_float_linear")<0&&a(e.minFilter===B&&e.magFilter===B,"filter not supported, must enable oes_texture_float_linear"),a(!e.genMipmaps,"mipmap generation not supported with float textures"));var l=t.images;for(i=0;i<16;++i)if(l[i]){var c=n>>i,u=o>>i;a(t.mipmask&1<<i,"missing mipmap data");var h=l[i];if(a(h.width===c&&h.height===u,"invalid shape for mip images"),a(h.format===t.format&&h.internalformat===t.internalformat&&h.type===t.type,"incompatible type for mip image"),h.compressed);else if(h.data){var p=Math.ceil(J(h.type,s)*c/h.unpackAlignment)*h.unpackAlignment;a(h.data.byteLength===p*u,"invalid data for image, buffer size is inconsistent with image format")}else h.element||h.copy}else e.genMipmaps||a(0==(t.mipmask&1<<i),"extra mipmap data");t.compressed&&a(!e.genMipmaps,"mipmap generation for compressed images not supported")}function te(e,t,r,i){var n=e.width,o=e.height,s=e.channels;a(n>0&&n<=i.maxTextureSize&&o>0&&o<=i.maxTextureSize,"invalid texture shape"),a(n===o,"cube map must be square"),a(t.wrapS===L&&t.wrapT===L,"wrap mode not supported by cube map");for(var l=0;l<r.length;++l){var c=r[l];a(c.width===n&&c.height===o,"inconsistent cube map face shape"),t.genMipmaps&&(a(!c.compressed,"can not generate mipmap for compressed textures"),a(1===c.mipmask,"can not specify mipmaps and generate mipmaps"));for(var u=c.images,h=0;h<16;++h){var p=u[h];if(p){var d=n>>h,f=o>>h;a(c.mipmask&1<<h,"missing mipmap data"),a(p.width===d&&p.height===f,"invalid shape for mip images"),a(p.format===e.format&&p.internalformat===e.internalformat&&p.type===e.type,"incompatible type for mip image"),p.compressed||(p.data?a(p.data.byteLength===d*f*Math.max(J(p.type,s),p.unpackAlignment),"invalid data for image, buffer size is inconsistent with image format"):p.element||p.copy)}}}}Y[5120]=Y[V]=1,Y[$]=Y[N]=Y[K]=Y[W]=Y[Z]=Y[X]=2,Y[j]=Y[q]=Y[G]=Y[H]=4;var re=t(a,{optional:P,raise:n,commandRaise:k,command:C,parameter:s,commandParameter:z,constructor:f,type:u,commandType:M,isTypedArray:l,nni:h,oneOf:p,shaderError:E,linkError:S,callSite:v,saveCommandRef:A,saveDrawInfo:I,framebufferFormat:D,guessCommand:x,texture2D:ee,textureCube:te}),ie=0,ne=0,ae=5,oe=6;function se(e,t){this.id=ie++,this.type=e,this.data=t}function le(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function ce(e){if(0===e.length)return[];var t=e.charAt(0),r=e.charAt(e.length-1);if(e.length>1&&t===r&&('"'===t||"'"===t))return['"'+le(e.substr(1,e.length-2))+'"'];var i=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(e);if(i)return ce(e.substr(0,i.index)).concat(ce(i[1])).concat(ce(e.substr(i.index+i[0].length)));var n=e.split(".");if(1===n.length)return['"'+le(e)+'"'];for(var a=[],o=0;o<n.length;++o)a=a.concat(ce(n[o]));return a}function ue(e){return"["+ce(e).join("][")+"]"}function he(e,t){return new se(e,ue(t+""))}function pe(e){return"function"==typeof e&&!e._reglType||e instanceof se}function de(e,t){return"function"==typeof e?new se(ne,e):"number"==typeof e||"boolean"==typeof e?new se(ae,e):Array.isArray(e)?new se(oe,e.map((function(e,r){return de(e,t+"["+r+"]")}))):e instanceof se?e:void re(!1,"invalid option type in uniform "+t)}var fe={DynamicVariable:se,define:he,isDynamic:pe,unbox:de,accessor:ue},me={next:"function"==typeof requestAnimationFrame?function(e){return requestAnimationFrame(e)}:function(e){return setTimeout(e,16)},cancel:"function"==typeof cancelAnimationFrame?function(e){return cancelAnimationFrame(e)}:clearTimeout},ge="undefined"!=typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date};function ye(){var e={"":0},t=[""];return{id:function(r){var i=e[r];return i||(i=e[r]=t.length,t.push(r),i)},str:function(e){return t[e]}}}function _e(e,r,i){var n,a=document.createElement("canvas");function o(){var t=window.innerWidth,r=window.innerHeight;if(e!==document.body){var n=a.getBoundingClientRect();t=n.right-n.left,r=n.bottom-n.top}a.width=i*t,a.height=i*r}function s(){n?n.disconnect():window.removeEventListener("resize",o),e.removeChild(a)}return t(a.style,{border:0,margin:0,padding:0,top:0,left:0,width:"100%",height:"100%"}),e.appendChild(a),e===document.body&&(a.style.position="absolute",t(e.style,{margin:0,padding:0})),e!==document.body&&"function"==typeof ResizeObserver?(n=new ResizeObserver((function(){setTimeout(o)}))).observe(e):window.addEventListener("resize",o,!1),o(),{canvas:a,onDestroy:s}}function xe(e,t){function r(r){try{return e.getContext(r,t)}catch(e){return null}}return r("webgl")||r("experimental-webgl")||r("webgl-experimental")}function ve(e){return"string"==typeof e.nodeName&&"function"==typeof e.appendChild&&"function"==typeof e.getBoundingClientRect}function be(e){return"function"==typeof e.drawArrays||"function"==typeof e.drawElements}function we(e){return"string"==typeof e?e.split():(re(Array.isArray(e),"invalid extension array"),e)}function Te(e){return"string"==typeof e?(re("undefined"!=typeof document,"not supported outside of DOM"),document.querySelector(e)):e}function Ee(e){var t,r,i,n,a=e||{},o={},s=[],l=[],c="undefined"==typeof window?1:window.devicePixelRatio,u=!1,h=function(e){e&&re.raise(e)},p=function(){};if("string"==typeof a?(re("undefined"!=typeof document,"selector queries only supported in DOM enviroments"),t=document.querySelector(a),re(t,"invalid query string for element")):"object"==typeof a?ve(a)?t=a:be(a)?i=(n=a).canvas:(re.constructor(a),"gl"in a?n=a.gl:"canvas"in a?i=Te(a.canvas):"container"in a&&(r=Te(a.container)),"attributes"in a&&(o=a.attributes,re.type(o,"object","invalid context attributes")),"extensions"in a&&(s=we(a.extensions)),"optionalExtensions"in a&&(l=we(a.optionalExtensions)),"onDone"in a&&(re.type(a.onDone,"function","invalid or missing onDone callback"),h=a.onDone),"profile"in a&&(u=!!a.profile),"pixelRatio"in a&&(c=+a.pixelRatio,re(c>0,"invalid pixel ratio"))):re.raise("invalid arguments to regl"),t&&("canvas"===t.nodeName.toLowerCase()?i=t:r=t),!n){if(!i){re("undefined"!=typeof document,"must manually specify webgl context outside of DOM environments");var d=_e(r||document.body,h,c);if(!d)return null;i=d.canvas,p=d.onDestroy}void 0===o.premultipliedAlpha&&(o.premultipliedAlpha=!0),n=xe(i,o)}return n?{gl:n,canvas:i,container:r,extensions:s,optionalExtensions:l,pixelRatio:c,profile:u,onDone:h,onDestroy:p}:(p(),h("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function Se(e,t){var r={};function i(t){re.type(t,"string","extension name must be string");var i,n=t.toLowerCase();try{i=r[n]=e.getExtension(n)}catch(e){}return!!i}for(var n=0;n<t.extensions.length;++n){var a=t.extensions[n];if(!i(a))return t.onDestroy(),t.onDone('"'+a+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return t.optionalExtensions.forEach(i),{extensions:r,restore:function(){Object.keys(r).forEach((function(e){if(r[e]&&!i(e))throw new Error("(regl): error restoring extension "+e)}))}}}function Ae(e,t){for(var r=Array(e),i=0;i<e;++i)r[i]=t(i);return r}var Ie=5120,ke=5121,Ce=5122,ze=5123,Me=5124,Pe=5125,De=5126;function Le(e){for(var t=16;t<=1<<28;t*=16)if(e<=t)return t;return 0}function Be(e){var t,r;return t=(e>65535)<<4,t|=r=((e>>>=t)>255)<<3,t|=r=((e>>>=r)>15)<<2,(t|=r=((e>>>=r)>3)<<1)|(e>>>=r)>>1}function Re(){var e=Ae(8,(function(){return[]}));function t(t){var r=Le(t),i=e[Be(r)>>2];return i.length>0?i.pop():new ArrayBuffer(r)}function r(t){e[Be(t.byteLength)>>2].push(t)}function i(e,r){var i=null;switch(e){case Ie:i=new Int8Array(t(r),0,r);break;case ke:i=new Uint8Array(t(r),0,r);break;case Ce:i=new Int16Array(t(2*r),0,r);break;case ze:i=new Uint16Array(t(2*r),0,r);break;case Me:i=new Int32Array(t(4*r),0,r);break;case Pe:i=new Uint32Array(t(4*r),0,r);break;case De:i=new Float32Array(t(4*r),0,r);break;default:return null}return i.length!==r?i.subarray(0,r):i}function n(e){r(e.buffer)}return{alloc:t,free:r,allocType:i,freeType:n}}var Fe=Re();Fe.zero=Re();var Oe=3408,Ue=3410,Ve=3411,$e=3412,Ne=3413,je=3414,qe=3415,Ge=33901,Ze=33902,Xe=3379,We=3386,He=34921,Ke=36347,Ye=36348,Je=35661,Qe=35660,et=34930,tt=36349,rt=34076,it=34024,nt=7936,at=7937,ot=7938,st=35724,lt=34047,ct=36063,ut=34852,ht=3553,pt=34067,dt=34069,ft=33984,mt=6408,gt=5126,yt=5121,_t=36160,xt=36053,vt=36064,bt=16384,wt=function(e,t){var r=1;t.ext_texture_filter_anisotropic&&(r=e.getParameter(lt));var i=1,n=1;t.webgl_draw_buffers&&(i=e.getParameter(ut),n=e.getParameter(ct));var a=!!t.oes_texture_float;if(a){var o=e.createTexture();e.bindTexture(ht,o),e.texImage2D(ht,0,mt,1,1,0,mt,gt,null);var s=e.createFramebuffer();if(e.bindFramebuffer(_t,s),e.framebufferTexture2D(_t,vt,ht,o,0),e.bindTexture(ht,null),e.checkFramebufferStatus(_t)!==xt)a=!1;else{e.viewport(0,0,1,1),e.clearColor(1,0,0,1),e.clear(bt);var l=Fe.allocType(gt,4);e.readPixels(0,0,1,1,mt,gt,l),e.getError()?a=!1:(e.deleteFramebuffer(s),e.deleteTexture(o),a=1===l[0]),Fe.freeType(l)}}var c=!0;if("undefined"==typeof navigator||!(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent))){var u=e.createTexture(),h=Fe.allocType(yt,36);e.activeTexture(ft),e.bindTexture(pt,u),e.texImage2D(dt,0,mt,3,3,0,mt,yt,h),Fe.freeType(h),e.bindTexture(pt,null),e.deleteTexture(u),c=!e.getError()}return{colorBits:[e.getParameter(Ue),e.getParameter(Ve),e.getParameter($e),e.getParameter(Ne)],depthBits:e.getParameter(je),stencilBits:e.getParameter(qe),subpixelBits:e.getParameter(Oe),extensions:Object.keys(t).filter((function(e){return!!t[e]})),maxAnisotropic:r,maxDrawbuffers:i,maxColorAttachments:n,pointSizeDims:e.getParameter(Ge),lineWidthDims:e.getParameter(Ze),maxViewportDims:e.getParameter(We),maxCombinedTextureUnits:e.getParameter(Je),maxCubeMapSize:e.getParameter(rt),maxRenderbufferSize:e.getParameter(it),maxTextureUnits:e.getParameter(et),maxTextureSize:e.getParameter(Xe),maxAttributes:e.getParameter(He),maxVertexUniforms:e.getParameter(Ke),maxVertexTextureUnits:e.getParameter(Qe),maxVaryingVectors:e.getParameter(Ye),maxFragmentUniforms:e.getParameter(tt),glsl:e.getParameter(st),renderer:e.getParameter(at),vendor:e.getParameter(nt),version:e.getParameter(ot),readFloat:a,npotTextureCube:c}};function Tt(t){return!!t&&"object"==typeof t&&Array.isArray(t.shape)&&Array.isArray(t.stride)&&"number"==typeof t.offset&&t.shape.length===t.stride.length&&(Array.isArray(t.data)||e(t.data))}var Et=function(e){return Object.keys(e).map((function(t){return e[t]}))},St={shape:Mt,flatten:zt};function At(e,t,r){for(var i=0;i<t;++i)r[i]=e[i]}function It(e,t,r,i){for(var n=0,a=0;a<t;++a)for(var o=e[a],s=0;s<r;++s)i[n++]=o[s]}function kt(e,t,r,i,n,a){for(var o=a,s=0;s<t;++s)for(var l=e[s],c=0;c<r;++c)for(var u=l[c],h=0;h<i;++h)n[o++]=u[h]}function Ct(e,t,r,i,n){for(var a=1,o=r+1;o<t.length;++o)a*=t[o];var s=t[r];if(t.length-r==4){var l=t[r+1],c=t[r+2],u=t[r+3];for(o=0;o<s;++o)kt(e[o],l,c,u,i,n),n+=a}else for(o=0;o<s;++o)Ct(e[o],t,r+1,i,n),n+=a}function zt(e,t,r,i){var n=1;if(t.length)for(var a=0;a<t.length;++a)n*=t[a];else n=0;var o=i||Fe.allocType(r,n);switch(t.length){case 0:break;case 1:At(e,t[0],o);break;case 2:It(e,t[0],t[1],o);break;case 3:kt(e,t[0],t[1],t[2],o,0);break;default:Ct(e,t,0,o,0)}return o}function Mt(e){for(var t=[],r=e;r.length;r=r[0])t.push(r.length);return t}var Pt={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},Dt={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126},Lt={dynamic:35048,stream:35040,static:35044},Bt=St.flatten,Rt=St.shape,Ft=35044,Ot=35040,Ut=5121,Vt=5126,$t=[];function Nt(e){return 0|Pt[Object.prototype.toString.call(e)]}function jt(e,t){for(var r=0;r<t.length;++r)e[r]=t[r]}function qt(e,t,r,i,n,a,o){for(var s=0,l=0;l<r;++l)for(var c=0;c<i;++c)e[s++]=t[n*l+a*c+o]}function Gt(t,r,i,n){var a=0,o={};function s(e){this.id=a++,this.buffer=t.createBuffer(),this.type=e,this.usage=Ft,this.byteLength=0,this.dimension=1,this.dtype=Ut,this.persistentData=null,i.profile&&(this.stats={size:0})}s.prototype.bind=function(){t.bindBuffer(this.type,this.buffer)},s.prototype.destroy=function(){d(this)};var l=[];function c(e,t){var r=l.pop();return r||(r=new s(e)),r.bind(),p(r,t,Ot,0,1,!1),r}function u(e){l.push(e)}function h(e,r,i){e.byteLength=r.byteLength,t.bufferData(e.type,r,i)}function p(t,r,i,n,a,o){var s,l;if(t.usage=i,Array.isArray(r)){if(t.dtype=n||Vt,r.length>0)if(Array.isArray(r[0])){s=Rt(r);for(var c=1,u=1;u<s.length;++u)c*=s[u];t.dimension=c,h(t,l=Bt(r,s,t.dtype),i),o?t.persistentData=l:Fe.freeType(l)}else if("number"==typeof r[0]){t.dimension=a;var p=Fe.allocType(t.dtype,r.length);jt(p,r),h(t,p,i),o?t.persistentData=p:Fe.freeType(p)}else e(r[0])?(t.dimension=r[0].length,t.dtype=n||Nt(r[0])||Vt,h(t,l=Bt(r,[r.length,r[0].length],t.dtype),i),o?t.persistentData=l:Fe.freeType(l)):re.raise("invalid buffer data")}else if(e(r))t.dtype=n||Nt(r),t.dimension=a,h(t,r,i),o&&(t.persistentData=new Uint8Array(new Uint8Array(r.buffer)));else if(Tt(r)){s=r.shape;var d=r.stride,f=r.offset,m=0,g=0,y=0,_=0;1===s.length?(m=s[0],g=1,y=d[0],_=0):2===s.length?(m=s[0],g=s[1],y=d[0],_=d[1]):re.raise("invalid shape"),t.dtype=n||Nt(r.data)||Vt,t.dimension=g;var x=Fe.allocType(t.dtype,m*g);qt(x,r.data,m,g,y,_,f),h(t,x,i),o?t.persistentData=x:Fe.freeType(x)}else r instanceof ArrayBuffer?(t.dtype=Ut,t.dimension=a,h(t,r,i),o&&(t.persistentData=new Uint8Array(new Uint8Array(r)))):re.raise("invalid buffer data")}function d(e){r.bufferCount--,n(e);var i=e.buffer;re(i,"buffer must not be deleted already"),t.deleteBuffer(i),e.buffer=null,delete o[e.id]}function f(n,a,l,c){r.bufferCount++;var u=new s(a);function h(r){var n=Ft,a=null,o=0,s=0,l=1;return Array.isArray(r)||e(r)||Tt(r)||r instanceof ArrayBuffer?a=r:"number"==typeof r?o=0|r:r&&(re.type(r,"object","buffer arguments must be an object, a number or an array"),"data"in r&&(re(null===a||Array.isArray(a)||e(a)||Tt(a),"invalid data for buffer"),a=r.data),"usage"in r&&(re.parameter(r.usage,Lt,"invalid buffer usage"),n=Lt[r.usage]),"type"in r&&(re.parameter(r.type,Dt,"invalid buffer type"),s=Dt[r.type]),"dimension"in r&&(re.type(r.dimension,"number","invalid dimension"),l=0|r.dimension),"length"in r&&(re.nni(o,"buffer length must be a nonnegative integer"),o=0|r.length)),u.bind(),a?p(u,a,n,s,l,c):(o&&t.bufferData(u.type,o,n),u.dtype=s||Ut,u.usage=n,u.dimension=l,u.byteLength=o),i.profile&&(u.stats.size=u.byteLength*$t[u.dtype]),h}function f(e,r){re(r+e.byteLength<=u.byteLength,"invalid buffer subdata call, buffer is too small.  Can't write data of size "+e.byteLength+" starting from offset "+r+" to a buffer of size "+u.byteLength),t.bufferSubData(u.type,r,e)}function m(t,r){var i,n=0|(r||0);if(u.bind(),e(t)||t instanceof ArrayBuffer)f(t,n);else if(Array.isArray(t)){if(t.length>0)if("number"==typeof t[0]){var a=Fe.allocType(u.dtype,t.length);jt(a,t),f(a,n),Fe.freeType(a)}else if(Array.isArray(t[0])||e(t[0])){i=Rt(t);var o=Bt(t,i,u.dtype);f(o,n),Fe.freeType(o)}else re.raise("invalid buffer data")}else if(Tt(t)){i=t.shape;var s=t.stride,l=0,c=0,p=0,d=0;1===i.length?(l=i[0],c=1,p=s[0],d=0):2===i.length?(l=i[0],c=i[1],p=s[0],d=s[1]):re.raise("invalid shape");var m=Array.isArray(t.data)?u.dtype:Nt(t.data),g=Fe.allocType(m,l*c);qt(g,t.data,l,c,p,d,t.offset),f(g,n),Fe.freeType(g)}else re.raise("invalid data for buffer subdata");return h}return o[u.id]=u,l||h(n),h._reglType="buffer",h._buffer=u,h.subdata=m,i.profile&&(h.stats=u.stats),h.destroy=function(){d(u)},h}function m(){Et(o).forEach((function(e){e.buffer=t.createBuffer(),t.bindBuffer(e.type,e.buffer),t.bufferData(e.type,e.persistentData||e.byteLength,e.usage)}))}return i.profile&&(r.getTotalBufferSize=function(){var e=0;return Object.keys(o).forEach((function(t){e+=o[t].stats.size})),e}),{create:f,createStream:c,destroyStream:u,clear:function(){Et(o).forEach(d),l.forEach(d)},getBuffer:function(e){return e&&e._buffer instanceof s?e._buffer:null},restore:m,_initBuffer:p}}$t[5120]=1,$t[5122]=2,$t[5124]=4,$t[5121]=1,$t[5123]=2,$t[5125]=4,$t[5126]=4;var Zt={points:0,point:0,lines:1,line:1,triangles:4,triangle:4,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},Xt=0,Wt=1,Ht=4,Kt=5120,Yt=5121,Jt=5122,Qt=5123,er=5124,tr=5125,rr=34963,ir=35040,nr=35044;function ar(t,r,i,n){var a={},o=0,s={uint8:Yt,uint16:Qt};function l(e){this.id=o++,a[this.id]=this,this.buffer=e,this.primType=Ht,this.vertCount=0,this.type=0}r.oes_element_index_uint&&(s.uint32=tr),l.prototype.bind=function(){this.buffer.bind()};var c=[];function u(e){var t=c.pop();return t||(t=new l(i.create(null,rr,!0,!1)._buffer)),p(t,e,ir,-1,-1,0,0),t}function h(e){c.push(e)}function p(n,a,o,s,l,c,u){var h;if(n.buffer.bind(),a){var p=u;u||e(a)&&(!Tt(a)||e(a.data))||(p=r.oes_element_index_uint?tr:Qt),i._initBuffer(n.buffer,a,o,p,3)}else t.bufferData(rr,c,o),n.buffer.dtype=h||Yt,n.buffer.usage=o,n.buffer.dimension=3,n.buffer.byteLength=c;if(h=u,!u){switch(n.buffer.dtype){case Yt:case Kt:h=Yt;break;case Qt:case Jt:h=Qt;break;case tr:case er:h=tr;break;default:re.raise("unsupported type for element array")}n.buffer.dtype=h}n.type=h,re(h!==tr||!!r.oes_element_index_uint,"32 bit element buffers not supported, enable oes_element_index_uint first");var d=l;d<0&&(d=n.buffer.byteLength,h===Qt?d>>=1:h===tr&&(d>>=2)),n.vertCount=d;var f=s;if(s<0){f=Ht;var m=n.buffer.dimension;1===m&&(f=Xt),2===m&&(f=Wt),3===m&&(f=Ht)}n.primType=f}function d(e){n.elementsCount--,re(null!==e.buffer,"must not double destroy elements"),delete a[e.id],e.buffer.destroy(),e.buffer=null}function f(t,r){var a=i.create(null,rr,!0),o=new l(a._buffer);function c(t){if(t)if("number"==typeof t)a(t),o.primType=Ht,o.vertCount=0|t,o.type=Yt;else{var r=null,i=nr,n=-1,l=-1,u=0,h=0;Array.isArray(t)||e(t)||Tt(t)?r=t:(re.type(t,"object","invalid arguments for elements"),"data"in t&&(r=t.data,re(Array.isArray(r)||e(r)||Tt(r),"invalid data for element buffer")),"usage"in t&&(re.parameter(t.usage,Lt,"invalid element buffer usage"),i=Lt[t.usage]),"primitive"in t&&(re.parameter(t.primitive,Zt,"invalid element buffer primitive"),n=Zt[t.primitive]),"count"in t&&(re("number"==typeof t.count&&t.count>=0,"invalid vertex count for elements"),l=0|t.count),"type"in t&&(re.parameter(t.type,s,"invalid buffer type"),h=s[t.type]),"length"in t?u=0|t.length:(u=l,h===Qt||h===Jt?u*=2:h!==tr&&h!==er||(u*=4))),p(o,r,i,n,l,u,h)}else a(),o.primType=Ht,o.vertCount=0,o.type=Yt;return c}return n.elementsCount++,c(t),c._reglType="elements",c._elements=o,c.subdata=function(e,t){return a.subdata(e,t),c},c.destroy=function(){d(o)},c}return{create:f,createStream:u,destroyStream:h,getElements:function(e){return"function"==typeof e&&e._elements instanceof l?e._elements:null},clear:function(){Et(a).forEach(d)}}}var or=new Float32Array(1),sr=new Uint32Array(or.buffer),lr=5123;function cr(e){for(var t=Fe.allocType(lr,e.length),r=0;r<e.length;++r)if(isNaN(e[r]))t[r]=65535;else if(e[r]===1/0)t[r]=31744;else if(e[r]===-1/0)t[r]=64512;else{or[0]=e[r];var i=sr[0],n=i>>>31<<15,a=(i<<1>>>24)-127,o=i>>13&1023;if(a<-24)t[r]=n;else if(a<-14){var s=-14-a;t[r]=n+(o+1024>>s)}else t[r]=a>15?n+31744:n+(a+15<<10)+o}return t}function ur(t){return Array.isArray(t)||e(t)}var hr=function(e){return!(e&e-1||!e)},pr=34467,dr=3553,fr=34067,mr=34069,gr=6408,yr=6406,_r=6407,xr=6409,vr=6410,br=32854,wr=32855,Tr=36194,Er=32819,Sr=32820,Ar=33635,Ir=34042,kr=6402,Cr=34041,zr=35904,Mr=35906,Pr=36193,Dr=33776,Lr=33777,Br=33778,Rr=33779,Fr=35986,Or=35987,Ur=34798,Vr=35840,$r=35841,Nr=35842,jr=35843,qr=36196,Gr=5121,Zr=5123,Xr=5125,Wr=5126,Hr=10242,Kr=10243,Yr=10497,Jr=33071,Qr=33648,ei=10240,ti=10241,ri=9728,ii=9729,ni=9984,ai=9985,oi=9986,si=9987,li=33170,ci=4352,ui=4353,hi=4354,pi=34046,di=3317,fi=37440,mi=37441,gi=37443,yi=37444,_i=33984,xi=[ni,oi,ai,si],vi=[0,xr,vr,_r,gr],bi={};function wi(e){return"[object "+e+"]"}bi[xr]=bi[yr]=bi[kr]=1,bi[Cr]=bi[vr]=2,bi[_r]=bi[zr]=3,bi[gr]=bi[Mr]=4;var Ti=wi("HTMLCanvasElement"),Ei=wi("OffscreenCanvas"),Si=wi("CanvasRenderingContext2D"),Ai=wi("ImageBitmap"),Ii=wi("HTMLImageElement"),ki=wi("HTMLVideoElement"),Ci=Object.keys(Pt).concat([Ti,Ei,Si,Ai,Ii,ki]),zi=[];zi[Gr]=1,zi[Wr]=4,zi[Pr]=2,zi[Zr]=2,zi[Xr]=4;var Mi=[];function Pi(e){return Array.isArray(e)&&(0===e.length||"number"==typeof e[0])}function Di(e){return!!Array.isArray(e)&&!(0===e.length||!ur(e[0]))}function Li(e){return Object.prototype.toString.call(e)}function Bi(e){return Li(e)===Ti}function Ri(e){return Li(e)===Ei}function Fi(e){return Li(e)===Si}function Oi(e){return Li(e)===Ai}function Ui(e){return Li(e)===Ii}function Vi(e){return Li(e)===ki}function $i(e){if(!e)return!1;var t=Li(e);return Ci.indexOf(t)>=0||Pi(e)||Di(e)||Tt(e)}function Ni(e){return 0|Pt[Object.prototype.toString.call(e)]}function ji(e,t){var r=t.length;switch(e.type){case Gr:case Zr:case Xr:case Wr:var i=Fe.allocType(e.type,r);i.set(t),e.data=i;break;case Pr:e.data=cr(t);break;default:re.raise("unsupported texture type, must specify a typed array")}}function qi(e,t){return Fe.allocType(e.type===Pr?Wr:e.type,t)}function Gi(e,t){e.type===Pr?(e.data=cr(t),Fe.freeType(t)):e.data=t}function Zi(e,t,r,i,n,a){for(var o=e.width,s=e.height,l=e.channels,c=qi(e,o*s*l),u=0,h=0;h<s;++h)for(var p=0;p<o;++p)for(var d=0;d<l;++d)c[u++]=t[r*p+i*h+n*d+a];Gi(e,c)}function Xi(e,t,r,i,n,a){var o;if(o=void 0!==Mi[e]?Mi[e]:bi[e]*zi[t],a&&(o*=6),n){for(var s=0,l=r;l>=1;)s+=o*l*l,l/=2;return s}return o*r*i}function Wi(r,i,n,a,o,s,l){var c={"don't care":ci,"dont care":ci,nice:hi,fast:ui},u={repeat:Yr,clamp:Jr,mirror:Qr},h={nearest:ri,linear:ii},p=t({mipmap:si,"nearest mipmap nearest":ni,"linear mipmap nearest":ai,"nearest mipmap linear":oi,"linear mipmap linear":si},h),d={none:0,browser:yi},f={uint8:Gr,rgba4:Er,rgb565:Ar,"rgb5 a1":Sr},m={alpha:yr,luminance:xr,"luminance alpha":vr,rgb:_r,rgba:gr,rgba4:br,"rgb5 a1":wr,rgb565:Tr},g={};i.ext_srgb&&(m.srgb=zr,m.srgba=Mr),i.oes_texture_float&&(f.float32=f.float=Wr),i.oes_texture_half_float&&(f.float16=f["half float"]=Pr),i.webgl_depth_texture&&(t(m,{depth:kr,"depth stencil":Cr}),t(f,{uint16:Zr,uint32:Xr,"depth stencil":Ir})),i.webgl_compressed_texture_s3tc&&t(g,{"rgb s3tc dxt1":Dr,"rgba s3tc dxt1":Lr,"rgba s3tc dxt3":Br,"rgba s3tc dxt5":Rr}),i.webgl_compressed_texture_atc&&t(g,{"rgb atc":Fr,"rgba atc explicit alpha":Or,"rgba atc interpolated alpha":Ur}),i.webgl_compressed_texture_pvrtc&&t(g,{"rgb pvrtc 4bppv1":Vr,"rgb pvrtc 2bppv1":$r,"rgba pvrtc 4bppv1":Nr,"rgba pvrtc 2bppv1":jr}),i.webgl_compressed_texture_etc1&&(g["rgb etc1"]=qr);var y=Array.prototype.slice.call(r.getParameter(pr));Object.keys(g).forEach((function(e){var t=g[e];y.indexOf(t)>=0&&(m[e]=t)}));var _=Object.keys(m);n.textureFormats=_;var x=[];Object.keys(m).forEach((function(e){var t=m[e];x[t]=e}));var v=[];Object.keys(f).forEach((function(e){var t=f[e];v[t]=e}));var b=[];Object.keys(h).forEach((function(e){var t=h[e];b[t]=e}));var w=[];Object.keys(p).forEach((function(e){var t=p[e];w[t]=e}));var T=[];Object.keys(u).forEach((function(e){var t=u[e];T[t]=e}));var E=_.reduce((function(e,t){var r=m[t];return r===xr||r===yr||r===xr||r===vr||r===kr||r===Cr||i.ext_srgb&&(r===zr||r===Mr)?e[r]=r:r===wr||t.indexOf("rgba")>=0?e[r]=gr:e[r]=_r,e}),{});function S(){this.internalformat=gr,this.format=gr,this.type=Gr,this.compressed=!1,this.premultiplyAlpha=!1,this.flipY=!1,this.unpackAlignment=1,this.colorSpace=yi,this.width=0,this.height=0,this.channels=0}function A(e,t){e.internalformat=t.internalformat,e.format=t.format,e.type=t.type,e.compressed=t.compressed,e.premultiplyAlpha=t.premultiplyAlpha,e.flipY=t.flipY,e.unpackAlignment=t.unpackAlignment,e.colorSpace=t.colorSpace,e.width=t.width,e.height=t.height,e.channels=t.channels}function I(e,t){if("object"==typeof t&&t){if("premultiplyAlpha"in t&&(re.type(t.premultiplyAlpha,"boolean","invalid premultiplyAlpha"),e.premultiplyAlpha=t.premultiplyAlpha),"flipY"in t&&(re.type(t.flipY,"boolean","invalid texture flip"),e.flipY=t.flipY),"alignment"in t&&(re.oneOf(t.alignment,[1,2,4,8],"invalid texture unpack alignment"),e.unpackAlignment=t.alignment),"colorSpace"in t&&(re.parameter(t.colorSpace,d,"invalid colorSpace"),e.colorSpace=d[t.colorSpace]),"type"in t){var r=t.type;re(i.oes_texture_float||!("float"===r||"float32"===r),"you must enable the OES_texture_float extension in order to use floating point textures."),re(i.oes_texture_half_float||!("half float"===r||"float16"===r),"you must enable the OES_texture_half_float extension in order to use 16-bit floating point textures."),re(i.webgl_depth_texture||!("uint16"===r||"uint32"===r||"depth stencil"===r),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),re.parameter(r,f,"invalid texture type"),e.type=f[r]}var a=e.width,o=e.height,s=e.channels,l=!1;"shape"in t?(re(Array.isArray(t.shape)&&t.shape.length>=2,"shape must be an array"),a=t.shape[0],o=t.shape[1],3===t.shape.length&&(s=t.shape[2],re(s>0&&s<=4,"invalid number of channels"),l=!0),re(a>=0&&a<=n.maxTextureSize,"invalid width"),re(o>=0&&o<=n.maxTextureSize,"invalid height")):("radius"in t&&(a=o=t.radius,re(a>=0&&a<=n.maxTextureSize,"invalid radius")),"width"in t&&(a=t.width,re(a>=0&&a<=n.maxTextureSize,"invalid width")),"height"in t&&(o=t.height,re(o>=0&&o<=n.maxTextureSize,"invalid height")),"channels"in t&&(s=t.channels,re(s>0&&s<=4,"invalid number of channels"),l=!0)),e.width=0|a,e.height=0|o,e.channels=0|s;var c=!1;if("format"in t){var u=t.format;re(i.webgl_depth_texture||!("depth"===u||"depth stencil"===u),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),re.parameter(u,m,"invalid texture format");var h=e.internalformat=m[u];e.format=E[h],u in f&&("type"in t||(e.type=f[u])),u in g&&(e.compressed=!0),c=!0}!l&&c?e.channels=bi[e.format]:l&&!c?e.channels!==vi[e.format]&&(e.format=e.internalformat=vi[e.channels]):c&&l&&re(e.channels===bi[e.format],"number of channels inconsistent with specified format")}}function k(e){r.pixelStorei(fi,e.flipY),r.pixelStorei(mi,e.premultiplyAlpha),r.pixelStorei(gi,e.colorSpace),r.pixelStorei(di,e.unpackAlignment)}function C(){S.call(this),this.xOffset=0,this.yOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function z(t,r){var i=null;if($i(r)?i=r:r&&(re.type(r,"object","invalid pixel data type"),I(t,r),"x"in r&&(t.xOffset=0|r.x),"y"in r&&(t.yOffset=0|r.y),$i(r.data)&&(i=r.data)),re(!t.compressed||i instanceof Uint8Array,"compressed texture data must be stored in a uint8array"),r.copy){re(!i,"can not specify copy and data field for the same texture");var a=o.viewportWidth,s=o.viewportHeight;t.width=t.width||a-t.xOffset,t.height=t.height||s-t.yOffset,t.needsCopy=!0,re(t.xOffset>=0&&t.xOffset<a&&t.yOffset>=0&&t.yOffset<s&&t.width>0&&t.width<=a&&t.height>0&&t.height<=s,"copy texture read out of bounds")}else if(i){if(e(i))t.channels=t.channels||4,t.data=i,"type"in r||t.type!==Gr||(t.type=Ni(i));else if(Pi(i))t.channels=t.channels||4,ji(t,i),t.alignment=1,t.needsFree=!0;else if(Tt(i)){var l=i.data;Array.isArray(l)||t.type!==Gr||(t.type=Ni(l));var c,u,h,p,d,f,m=i.shape,g=i.stride;3===m.length?(h=m[2],f=g[2]):(re(2===m.length,"invalid ndarray pixel data, must be 2 or 3D"),h=1,f=1),c=m[0],u=m[1],p=g[0],d=g[1],t.alignment=1,t.width=c,t.height=u,t.channels=h,t.format=t.internalformat=vi[h],t.needsFree=!0,Zi(t,l,p,d,f,i.offset)}else if(Bi(i)||Ri(i)||Fi(i))Bi(i)||Ri(i)?t.element=i:t.element=i.canvas,t.width=t.element.width,t.height=t.element.height,t.channels=4;else if(Oi(i))t.element=i,t.width=i.width,t.height=i.height,t.channels=4;else if(Ui(i))t.element=i,t.width=i.naturalWidth,t.height=i.naturalHeight,t.channels=4;else if(Vi(i))t.element=i,t.width=i.videoWidth,t.height=i.videoHeight,t.channels=4;else if(Di(i)){var y=t.width||i[0].length,_=t.height||i.length,x=t.channels;x=ur(i[0][0])?x||i[0][0].length:x||1;for(var v=St.shape(i),b=1,w=0;w<v.length;++w)b*=v[w];var T=qi(t,b);St.flatten(i,v,"",T),Gi(t,T),t.alignment=1,t.width=y,t.height=_,t.channels=x,t.format=t.internalformat=vi[x],t.needsFree=!0}}else t.width=t.width||1,t.height=t.height||1,t.channels=t.channels||4;t.type===Wr?re(n.extensions.indexOf("oes_texture_float")>=0,"oes_texture_float extension not enabled"):t.type===Pr&&re(n.extensions.indexOf("oes_texture_half_float")>=0,"oes_texture_half_float extension not enabled")}function M(e,t,i){var n=e.element,o=e.data,s=e.internalformat,l=e.format,c=e.type,u=e.width,h=e.height;k(e),n?r.texImage2D(t,i,l,l,c,n):e.compressed?r.compressedTexImage2D(t,i,s,u,h,0,o):e.needsCopy?(a(),r.copyTexImage2D(t,i,l,e.xOffset,e.yOffset,u,h,0)):r.texImage2D(t,i,l,u,h,0,l,c,o||null)}function P(e,t,i,n,o){var s=e.element,l=e.data,c=e.internalformat,u=e.format,h=e.type,p=e.width,d=e.height;k(e),s?r.texSubImage2D(t,o,i,n,u,h,s):e.compressed?r.compressedTexSubImage2D(t,o,i,n,c,p,d,l):e.needsCopy?(a(),r.copyTexSubImage2D(t,o,i,n,e.xOffset,e.yOffset,p,d)):r.texSubImage2D(t,o,i,n,p,d,u,h,l)}var D=[];function L(){return D.pop()||new C}function B(e){e.needsFree&&Fe.freeType(e.data),C.call(e),D.push(e)}function R(){S.call(this),this.genMipmaps=!1,this.mipmapHint=ci,this.mipmask=0,this.images=Array(16)}function F(e,t,r){var i=e.images[0]=L();e.mipmask=1,i.width=e.width=t,i.height=e.height=r,i.channels=e.channels=4}function O(e,t){var r=null;if($i(t))A(r=e.images[0]=L(),e),z(r,t),e.mipmask=1;else if(I(e,t),Array.isArray(t.mipmap))for(var i=t.mipmap,n=0;n<i.length;++n)A(r=e.images[n]=L(),e),r.width>>=n,r.height>>=n,z(r,i[n]),e.mipmask|=1<<n;else A(r=e.images[0]=L(),e),z(r,t),e.mipmask=1;A(e,e.images[0]),!e.compressed||e.internalformat!==Dr&&e.internalformat!==Lr&&e.internalformat!==Br&&e.internalformat!==Rr||re(e.width%4==0&&e.height%4==0,"for compressed texture formats, mipmap level 0 must have width and height that are a multiple of 4")}function U(e,t){for(var r=e.images,i=0;i<r.length;++i){if(!r[i])return;M(r[i],t,i)}}var V=[];function $(){var e=V.pop()||new R;S.call(e),e.mipmask=0;for(var t=0;t<16;++t)e.images[t]=null;return e}function N(e){for(var t=e.images,r=0;r<t.length;++r)t[r]&&B(t[r]),t[r]=null;V.push(e)}function j(){this.minFilter=ri,this.magFilter=ri,this.wrapS=Jr,this.wrapT=Jr,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=ci}function q(e,t){if("min"in t){var r=t.min;re.parameter(r,p),e.minFilter=p[r],xi.indexOf(e.minFilter)>=0&&!("faces"in t)&&(e.genMipmaps=!0)}if("mag"in t){var i=t.mag;re.parameter(i,h),e.magFilter=h[i]}var a=e.wrapS,o=e.wrapT;if("wrap"in t){var s=t.wrap;"string"==typeof s?(re.parameter(s,u),a=o=u[s]):Array.isArray(s)&&(re.parameter(s[0],u),re.parameter(s[1],u),a=u[s[0]],o=u[s[1]])}else{if("wrapS"in t){var l=t.wrapS;re.parameter(l,u),a=u[l]}if("wrapT"in t){var d=t.wrapT;re.parameter(d,u),o=u[d]}}if(e.wrapS=a,e.wrapT=o,"anisotropic"in t){var f=t.anisotropic;re("number"==typeof f&&f>=1&&f<=n.maxAnisotropic,"aniso samples must be between 1 and "),e.anisotropic=t.anisotropic}if("mipmap"in t){var m=!1;switch(typeof t.mipmap){case"string":re.parameter(t.mipmap,c,"invalid mipmap hint"),e.mipmapHint=c[t.mipmap],e.genMipmaps=!0,m=!0;break;case"boolean":m=e.genMipmaps=t.mipmap;break;case"object":re(Array.isArray(t.mipmap),"invalid mipmap type"),e.genMipmaps=!1,m=!0;break;default:re.raise("invalid mipmap type")}m&&!("min"in t)&&(e.minFilter=ni)}}function G(e,t){r.texParameteri(t,ti,e.minFilter),r.texParameteri(t,ei,e.magFilter),r.texParameteri(t,Hr,e.wrapS),r.texParameteri(t,Kr,e.wrapT),i.ext_texture_filter_anisotropic&&r.texParameteri(t,pi,e.anisotropic),e.genMipmaps&&(r.hint(li,e.mipmapHint),r.generateMipmap(t))}var Z=0,X={},W=n.maxTextureUnits,H=Array(W).map((function(){return null}));function K(e){S.call(this),this.mipmask=0,this.internalformat=gr,this.id=Z++,this.refCount=1,this.target=e,this.texture=r.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new j,l.profile&&(this.stats={size:0})}function Y(e){r.activeTexture(_i),r.bindTexture(e.target,e.texture)}function J(){var e=H[0];e?r.bindTexture(e.target,e.texture):r.bindTexture(dr,null)}function Q(e){var t=e.texture;re(t,"must not double destroy texture");var i=e.unit,n=e.target;i>=0&&(r.activeTexture(_i+i),r.bindTexture(n,null),H[i]=null),r.deleteTexture(t),e.texture=null,e.params=null,e.pixels=null,e.refCount=0,delete X[e.id],s.textureCount--}function ee(e,t){var i=new K(dr);function a(e,t){var r=i.texInfo;j.call(r);var o=$();return"number"==typeof e?F(o,0|e,"number"==typeof t?0|t:0|e):e?(re.type(e,"object","invalid arguments to regl.texture"),q(r,e),O(o,e)):F(o,1,1),r.genMipmaps&&(o.mipmask=(o.width<<1)-1),i.mipmask=o.mipmask,A(i,o),re.texture2D(r,o,n),i.internalformat=o.internalformat,a.width=o.width,a.height=o.height,Y(i),U(o,dr),G(r,dr),J(),N(o),l.profile&&(i.stats.size=Xi(i.internalformat,i.type,o.width,o.height,r.genMipmaps,!1)),a.format=x[i.internalformat],a.type=v[i.type],a.mag=b[r.magFilter],a.min=w[r.minFilter],a.wrapS=T[r.wrapS],a.wrapT=T[r.wrapT],a}function o(e,t,r,n){re(!!e,"must specify image data");var o=0|t,s=0|r,l=0|n,c=L();return A(c,i),c.width=0,c.height=0,z(c,e),c.width=c.width||(i.width>>l)-o,c.height=c.height||(i.height>>l)-s,re(i.type===c.type&&i.format===c.format&&i.internalformat===c.internalformat,"incompatible format for texture.subimage"),re(o>=0&&s>=0&&o+c.width<=i.width&&s+c.height<=i.height,"texture.subimage write out of bounds"),re(i.mipmask&1<<l,"missing mipmap data"),re(c.data||c.element||c.needsCopy,"missing image data"),Y(i),P(c,dr,o,s,l),J(),B(c),a}function c(e,t){var n=0|e,o=0|t||n;if(n===i.width&&o===i.height)return a;a.width=i.width=n,a.height=i.height=o,Y(i);for(var s=0;i.mipmask>>s;++s){var c=n>>s,u=o>>s;if(!c||!u)break;r.texImage2D(dr,s,i.format,c,u,0,i.format,i.type,null)}return J(),l.profile&&(i.stats.size=Xi(i.internalformat,i.type,n,o,!1,!1)),a}return X[i.id]=i,s.textureCount++,a(e,t),a.subimage=o,a.resize=c,a._reglType="texture2d",a._texture=i,l.profile&&(a.stats=i.stats),a.destroy=function(){i.decRef()},a}function te(e,t,i,a,o,c){var u=new K(fr);X[u.id]=u,s.cubeCount++;var h=new Array(6);function p(e,t,r,i,a,o){var s,c=u.texInfo;for(j.call(c),s=0;s<6;++s)h[s]=$();if("number"!=typeof e&&e)if("object"==typeof e)if(t)O(h[0],e),O(h[1],t),O(h[2],r),O(h[3],i),O(h[4],a),O(h[5],o);else if(q(c,e),I(u,e),"faces"in e){var d=e.faces;for(re(Array.isArray(d)&&6===d.length,"cube faces must be a length 6 array"),s=0;s<6;++s)re("object"==typeof d[s]&&!!d[s],"invalid input for cube map face"),A(h[s],u),O(h[s],d[s])}else for(s=0;s<6;++s)O(h[s],e);else re.raise("invalid arguments to cube map");else{var f=0|e||1;for(s=0;s<6;++s)F(h[s],f,f)}for(A(u,h[0]),re.optional((function(){n.npotTextureCube||re(hr(u.width)&&hr(u.height),"your browser does not support non power or two texture dimensions")})),c.genMipmaps?u.mipmask=(h[0].width<<1)-1:u.mipmask=h[0].mipmask,re.textureCube(u,c,h,n),u.internalformat=h[0].internalformat,p.width=h[0].width,p.height=h[0].height,Y(u),s=0;s<6;++s)U(h[s],mr+s);for(G(c,fr),J(),l.profile&&(u.stats.size=Xi(u.internalformat,u.type,p.width,p.height,c.genMipmaps,!0)),p.format=x[u.internalformat],p.type=v[u.type],p.mag=b[c.magFilter],p.min=w[c.minFilter],p.wrapS=T[c.wrapS],p.wrapT=T[c.wrapT],s=0;s<6;++s)N(h[s]);return p}function d(e,t,r,i,n){re(!!t,"must specify image data"),re("number"==typeof e&&e===(0|e)&&e>=0&&e<6,"invalid face");var a=0|r,o=0|i,s=0|n,l=L();return A(l,u),l.width=0,l.height=0,z(l,t),l.width=l.width||(u.width>>s)-a,l.height=l.height||(u.height>>s)-o,re(u.type===l.type&&u.format===l.format&&u.internalformat===l.internalformat,"incompatible format for texture.subimage"),re(a>=0&&o>=0&&a+l.width<=u.width&&o+l.height<=u.height,"texture.subimage write out of bounds"),re(u.mipmask&1<<s,"missing mipmap data"),re(l.data||l.element||l.needsCopy,"missing image data"),Y(u),P(l,mr+e,a,o,s),J(),B(l),p}function f(e){var t=0|e;if(t!==u.width){p.width=u.width=t,p.height=u.height=t,Y(u);for(var i=0;i<6;++i)for(var n=0;u.mipmask>>n;++n)r.texImage2D(mr+i,n,u.format,t>>n,t>>n,0,u.format,u.type,null);return J(),l.profile&&(u.stats.size=Xi(u.internalformat,u.type,p.width,p.height,!1,!0)),p}}return p(e,t,i,a,o,c),p.subimage=d,p.resize=f,p._reglType="textureCube",p._texture=u,l.profile&&(p.stats=u.stats),p.destroy=function(){u.decRef()},p}function ie(){for(var e=0;e<W;++e)r.activeTexture(_i+e),r.bindTexture(dr,null),H[e]=null;Et(X).forEach(Q),s.cubeCount=0,s.textureCount=0}function ne(){for(var e=0;e<W;++e){var t=H[e];t&&(t.bindCount=0,t.unit=-1,H[e]=null)}Et(X).forEach((function(e){e.texture=r.createTexture(),r.bindTexture(e.target,e.texture);for(var t=0;t<32;++t)if(0!=(e.mipmask&1<<t))if(e.target===dr)r.texImage2D(dr,t,e.internalformat,e.width>>t,e.height>>t,0,e.internalformat,e.type,null);else for(var i=0;i<6;++i)r.texImage2D(mr+i,t,e.internalformat,e.width>>t,e.height>>t,0,e.internalformat,e.type,null);G(e.texInfo,e.target)}))}function ae(){for(var e=0;e<W;++e){var t=H[e];t&&(t.bindCount=0,t.unit=-1,H[e]=null),r.activeTexture(_i+e),r.bindTexture(dr,null),r.bindTexture(fr,null)}}return t(K.prototype,{bind:function(){var e=this;e.bindCount+=1;var t=e.unit;if(t<0){for(var i=0;i<W;++i){var n=H[i];if(n){if(n.bindCount>0)continue;n.unit=-1}H[i]=e,t=i;break}t>=W&&re.raise("insufficient number of texture units"),l.profile&&s.maxTextureUnits<t+1&&(s.maxTextureUnits=t+1),e.unit=t,r.activeTexture(_i+t),r.bindTexture(e.target,e.texture)}return t},unbind:function(){this.bindCount-=1},decRef:function(){--this.refCount<=0&&Q(this)}}),l.profile&&(s.getTotalTextureSize=function(){var e=0;return Object.keys(X).forEach((function(t){e+=X[t].stats.size})),e}),{create2D:ee,createCube:te,clear:ie,getTexture:function(e){return null},restore:ne,refresh:ae}}Mi[br]=2,Mi[wr]=2,Mi[Tr]=2,Mi[Cr]=4,Mi[Dr]=.5,Mi[Lr]=.5,Mi[Br]=1,Mi[Rr]=1,Mi[Fr]=.5,Mi[Or]=1,Mi[Ur]=1,Mi[Vr]=.5,Mi[$r]=.25,Mi[Nr]=.5,Mi[jr]=.25,Mi[qr]=.5;var Hi=36161,Ki=32854,Yi=32855,Ji=36194,Qi=33189,en=36168,tn=34041,rn=35907,nn=34836,an=34842,on=34843,sn=[];function ln(e,t,r){return sn[e]*t*r}sn[Ki]=2,sn[Yi]=2,sn[Ji]=2,sn[Qi]=2,sn[en]=1,sn[tn]=4,sn[rn]=4,sn[nn]=16,sn[an]=8,sn[on]=6;var cn=function(e,t,r,i,n){var a={rgba4:Ki,rgb565:Ji,"rgb5 a1":Yi,depth:Qi,stencil:en,"depth stencil":tn};t.ext_srgb&&(a.srgba=rn),t.ext_color_buffer_half_float&&(a.rgba16f=an,a.rgb16f=on),t.webgl_color_buffer_float&&(a.rgba32f=nn);var o=[];Object.keys(a).forEach((function(e){var t=a[e];o[t]=e}));var s=0,l={};function c(e){this.id=s++,this.refCount=1,this.renderbuffer=e,this.format=Ki,this.width=0,this.height=0,n.profile&&(this.stats={size:0})}function u(t){var r=t.renderbuffer;re(r,"must not double destroy renderbuffer"),e.bindRenderbuffer(Hi,null),e.deleteRenderbuffer(r),t.renderbuffer=null,t.refCount=0,delete l[t.id],i.renderbufferCount--}function h(t,s){var u=new c(e.createRenderbuffer());function h(t,i){var s=0,l=0,c=Ki;if("object"==typeof t&&t){var p=t;if("shape"in p){var d=p.shape;re(Array.isArray(d)&&d.length>=2,"invalid renderbuffer shape"),s=0|d[0],l=0|d[1]}else"radius"in p&&(s=l=0|p.radius),"width"in p&&(s=0|p.width),"height"in p&&(l=0|p.height);"format"in p&&(re.parameter(p.format,a,"invalid renderbuffer format"),c=a[p.format])}else"number"==typeof t?(s=0|t,l="number"==typeof i?0|i:s):t?re.raise("invalid arguments to renderbuffer constructor"):s=l=1;if(re(s>0&&l>0&&s<=r.maxRenderbufferSize&&l<=r.maxRenderbufferSize,"invalid renderbuffer size"),s!==u.width||l!==u.height||c!==u.format)return h.width=u.width=s,h.height=u.height=l,u.format=c,e.bindRenderbuffer(Hi,u.renderbuffer),e.renderbufferStorage(Hi,c,s,l),re(0===e.getError(),"invalid render buffer format"),n.profile&&(u.stats.size=ln(u.format,u.width,u.height)),h.format=o[u.format],h}function p(t,i){var a=0|t,o=0|i||a;return a===u.width&&o===u.height||(re(a>0&&o>0&&a<=r.maxRenderbufferSize&&o<=r.maxRenderbufferSize,"invalid renderbuffer size"),h.width=u.width=a,h.height=u.height=o,e.bindRenderbuffer(Hi,u.renderbuffer),e.renderbufferStorage(Hi,u.format,a,o),re(0===e.getError(),"invalid render buffer format"),n.profile&&(u.stats.size=ln(u.format,u.width,u.height))),h}return l[u.id]=u,i.renderbufferCount++,h(t,s),h.resize=p,h._reglType="renderbuffer",h._renderbuffer=u,n.profile&&(h.stats=u.stats),h.destroy=function(){u.decRef()},h}function p(){Et(l).forEach((function(t){t.renderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(Hi,t.renderbuffer),e.renderbufferStorage(Hi,t.format,t.width,t.height)})),e.bindRenderbuffer(Hi,null)}return c.prototype.decRef=function(){--this.refCount<=0&&u(this)},n.profile&&(i.getTotalRenderbufferSize=function(){var e=0;return Object.keys(l).forEach((function(t){e+=l[t].stats.size})),e}),{create:h,clear:function(){Et(l).forEach(u)},restore:p}},un=36160,hn=36161,pn=3553,dn=34069,fn=36064,mn=36096,gn=36128,yn=33306,_n=36053,xn=36054,vn=36055,bn=36057,wn=36061,Tn=36193,En=5121,Sn=5126,An=6407,In=6408,kn=6402,Cn=[An,In],zn=[];zn[In]=4,zn[An]=3;var Mn=[];Mn[En]=1,Mn[Sn]=4,Mn[Tn]=2;var Pn=33189,Dn=36168,Ln=34041,Bn=[32854,32855,36194,35907,34842,34843,34836],Rn={};function Fn(e,r,i,n,a,o){var s={cur:null,next:null,dirty:!1,setFBO:null},l=["rgba"],c=["rgba4","rgb565","rgb5 a1"];r.ext_srgb&&c.push("srgba"),r.ext_color_buffer_half_float&&c.push("rgba16f","rgb16f"),r.webgl_color_buffer_float&&c.push("rgba32f");var u=["uint8"];function h(e,t,r){this.target=e,this.texture=t,this.renderbuffer=r;var i=0,n=0;t?(i=t.width,n=t.height):r&&(i=r.width,n=r.height),this.width=i,this.height=n}function p(e){e&&(e.texture&&e.texture._texture.decRef(),e.renderbuffer&&e.renderbuffer._renderbuffer.decRef())}function d(e,t,r){if(e)if(e.texture){var i=e.texture._texture,n=Math.max(1,i.width),a=Math.max(1,i.height);re(n===t&&a===r,"inconsistent width/height for supplied texture"),i.refCount+=1}else{var o=e.renderbuffer._renderbuffer;re(o.width===t&&o.height===r,"inconsistent width/height for renderbuffer"),o.refCount+=1}}function f(t,r){r&&(r.texture?e.framebufferTexture2D(un,t,r.target,r.texture._texture.texture,0):e.framebufferRenderbuffer(un,t,hn,r.renderbuffer._renderbuffer.renderbuffer))}function m(e){var t=pn,r=null,i=null,n=e;"object"==typeof e&&(n=e.data,"target"in e&&(t=0|e.target)),re.type(n,"function","invalid attachment data");var a=n._reglType;return"texture2d"===a?(r=n,re(t===pn)):"textureCube"===a?(r=n,re(t>=dn&&t<dn+6,"invalid cube map target")):"renderbuffer"===a?(i=n,t=hn):re.raise("invalid regl object for attachment"),new h(t,r,i)}function g(e,t,r,i,o){if(r){var s=n.create2D({width:e,height:t,format:i,type:o});return s._texture.refCount=0,new h(pn,s,null)}var l=a.create({width:e,height:t,format:i});return l._renderbuffer.refCount=0,new h(hn,null,l)}function y(e){return e&&(e.texture||e.renderbuffer)}function _(e,t,r){e&&(e.texture?e.texture.resize(t,r):e.renderbuffer&&e.renderbuffer.resize(t,r),e.width=t,e.height=r)}r.oes_texture_half_float&&u.push("half float","float16"),r.oes_texture_float&&u.push("float","float32");var x=0,v={};function b(){this.id=x++,v[this.id]=this,this.framebuffer=e.createFramebuffer(),this.width=0,this.height=0,this.colorAttachments=[],this.depthAttachment=null,this.stencilAttachment=null,this.depthStencilAttachment=null}function w(e){e.colorAttachments.forEach(p),p(e.depthAttachment),p(e.stencilAttachment),p(e.depthStencilAttachment)}function T(t){var r=t.framebuffer;re(r,"must not double destroy framebuffer"),e.deleteFramebuffer(r),t.framebuffer=null,o.framebufferCount--,delete v[t.id]}function E(t){var r;e.bindFramebuffer(un,t.framebuffer);var n=t.colorAttachments;for(r=0;r<n.length;++r)f(fn+r,n[r]);for(r=n.length;r<i.maxColorAttachments;++r)e.framebufferTexture2D(un,fn+r,pn,null,0);e.framebufferTexture2D(un,yn,pn,null,0),e.framebufferTexture2D(un,mn,pn,null,0),e.framebufferTexture2D(un,gn,pn,null,0),f(mn,t.depthAttachment),f(gn,t.stencilAttachment),f(yn,t.depthStencilAttachment);var a=e.checkFramebufferStatus(un);e.isContextLost()||a===_n||re.raise("framebuffer configuration not supported, status = "+Rn[a]),e.bindFramebuffer(un,s.next?s.next.framebuffer:null),s.cur=s.next,e.getError()}function S(e,n){var a=new b;function h(e,t){var n;re(s.next!==a,"can not update framebuffer which is currently in use");var o=0,p=0,f=!0,_=!0,x=null,v=!0,b="rgba",T="uint8",S=1,A=null,I=null,k=null,C=!1;if("number"==typeof e)o=0|e,p=0|t||o;else if(e){re.type(e,"object","invalid arguments for framebuffer");var z=e;if("shape"in z){var M=z.shape;re(Array.isArray(M)&&M.length>=2,"invalid shape for framebuffer"),o=M[0],p=M[1]}else"radius"in z&&(o=p=z.radius),"width"in z&&(o=z.width),"height"in z&&(p=z.height);("color"in z||"colors"in z)&&(x=z.color||z.colors,Array.isArray(x)&&re(1===x.length||r.webgl_draw_buffers,"multiple render targets not supported")),x||("colorCount"in z&&(S=0|z.colorCount,re(S>0,"invalid color buffer count")),"colorTexture"in z&&(v=!!z.colorTexture,b="rgba4"),"colorType"in z&&(T=z.colorType,v?(re(r.oes_texture_float||!("float"===T||"float32"===T),"you must enable OES_texture_float in order to use floating point framebuffer objects"),re(r.oes_texture_half_float||!("half float"===T||"float16"===T),"you must enable OES_texture_half_float in order to use 16-bit floating point framebuffer objects")):"half float"===T||"float16"===T?(re(r.ext_color_buffer_half_float,"you must enable EXT_color_buffer_half_float to use 16-bit render buffers"),b="rgba16f"):"float"!==T&&"float32"!==T||(re(r.webgl_color_buffer_float,"you must enable WEBGL_color_buffer_float in order to use 32-bit floating point renderbuffers"),b="rgba32f"),re.oneOf(T,u,"invalid color type")),"colorFormat"in z&&(b=z.colorFormat,l.indexOf(b)>=0?v=!0:c.indexOf(b)>=0?v=!1:re.optional((function(){v?re.oneOf(z.colorFormat,l,"invalid color format for texture"):re.oneOf(z.colorFormat,c,"invalid color format for renderbuffer")})))),("depthTexture"in z||"depthStencilTexture"in z)&&(C=!(!z.depthTexture&&!z.depthStencilTexture),re(!C||r.webgl_depth_texture,"webgl_depth_texture extension not supported")),"depth"in z&&("boolean"==typeof z.depth?f=z.depth:(A=z.depth,_=!1)),"stencil"in z&&("boolean"==typeof z.stencil?_=z.stencil:(I=z.stencil,f=!1)),"depthStencil"in z&&("boolean"==typeof z.depthStencil?f=_=z.depthStencil:(k=z.depthStencil,f=!1,_=!1))}else o=p=1;var P=null,D=null,L=null,B=null;if(Array.isArray(x))P=x.map(m);else if(x)P=[m(x)];else for(P=new Array(S),n=0;n<S;++n)P[n]=g(o,p,v,b,T);re(r.webgl_draw_buffers||P.length<=1,"you must enable the WEBGL_draw_buffers extension in order to use multiple color buffers."),re(P.length<=i.maxColorAttachments,"too many color attachments, not supported"),o=o||P[0].width,p=p||P[0].height,A?D=m(A):f&&!_&&(D=g(o,p,C,"depth","uint32")),I?L=m(I):_&&!f&&(L=g(o,p,!1,"stencil","uint8")),k?B=m(k):!A&&!I&&_&&f&&(B=g(o,p,C,"depth stencil","depth stencil")),re(!!A+!!I+!!k<=1,"invalid framebuffer configuration, can specify exactly one depth/stencil attachment");var R=null;for(n=0;n<P.length;++n)if(d(P[n],o,p),re(!P[n]||P[n].texture&&Cn.indexOf(P[n].texture._texture.format)>=0||P[n].renderbuffer&&Bn.indexOf(P[n].renderbuffer._renderbuffer.format)>=0,"framebuffer color attachment "+n+" is invalid"),P[n]&&P[n].texture){var F=zn[P[n].texture._texture.format]*Mn[P[n].texture._texture.type];null===R?R=F:re(R===F,"all color attachments much have the same number of bits per pixel.")}return d(D,o,p),re(!D||D.texture&&D.texture._texture.format===kn||D.renderbuffer&&D.renderbuffer._renderbuffer.format===Pn,"invalid depth attachment for framebuffer object"),d(L,o,p),re(!L||L.renderbuffer&&L.renderbuffer._renderbuffer.format===Dn,"invalid stencil attachment for framebuffer object"),d(B,o,p),re(!B||B.texture&&B.texture._texture.format===Ln||B.renderbuffer&&B.renderbuffer._renderbuffer.format===Ln,"invalid depth-stencil attachment for framebuffer object"),w(a),a.width=o,a.height=p,a.colorAttachments=P,a.depthAttachment=D,a.stencilAttachment=L,a.depthStencilAttachment=B,h.color=P.map(y),h.depth=y(D),h.stencil=y(L),h.depthStencil=y(B),h.width=a.width,h.height=a.height,E(a),h}function p(e,t){re(s.next!==a,"can not resize a framebuffer which is currently in use");var r=Math.max(0|e,1),i=Math.max(0|t||r,1);if(r===a.width&&i===a.height)return h;for(var n=a.colorAttachments,o=0;o<n.length;++o)_(n[o],r,i);return _(a.depthAttachment,r,i),_(a.stencilAttachment,r,i),_(a.depthStencilAttachment,r,i),a.width=h.width=r,a.height=h.height=i,E(a),h}return o.framebufferCount++,h(e,n),t(h,{resize:p,_reglType:"framebuffer",_framebuffer:a,destroy:function(){T(a),w(a)},use:function(e){s.setFBO({framebuffer:h},e)}})}function A(e){var a=Array(6);function o(e){var i;re(a.indexOf(s.next)<0,"can not update framebuffer which is currently in use");var c,h={color:null},p=0,d=null,f="rgba",m="uint8",g=1;if("number"==typeof e)p=0|e;else if(e){re.type(e,"object","invalid arguments for framebuffer");var y=e;if("shape"in y){var _=y.shape;re(Array.isArray(_)&&_.length>=2,"invalid shape for framebuffer"),re(_[0]===_[1],"cube framebuffer must be square"),p=_[0]}else"radius"in y&&(p=0|y.radius),"width"in y?(p=0|y.width,"height"in y&&re(y.height===p,"must be square")):"height"in y&&(p=0|y.height);("color"in y||"colors"in y)&&(d=y.color||y.colors,Array.isArray(d)&&re(1===d.length||r.webgl_draw_buffers,"multiple render targets not supported")),d||("colorCount"in y&&(g=0|y.colorCount,re(g>0,"invalid color buffer count")),"colorType"in y&&(re.oneOf(y.colorType,u,"invalid color type"),m=y.colorType),"colorFormat"in y&&(f=y.colorFormat,re.oneOf(y.colorFormat,l,"invalid color format for texture"))),"depth"in y&&(h.depth=y.depth),"stencil"in y&&(h.stencil=y.stencil),"depthStencil"in y&&(h.depthStencil=y.depthStencil)}else p=1;if(d)if(Array.isArray(d))for(c=[],i=0;i<d.length;++i)c[i]=d[i];else c=[d];else{c=Array(g);var x={radius:p,format:f,type:m};for(i=0;i<g;++i)c[i]=n.createCube(x)}for(h.color=Array(c.length),i=0;i<c.length;++i){var v=c[i];re("function"==typeof v&&"textureCube"===v._reglType,"invalid cube map"),p=p||v.width,re(v.width===p&&v.height===p,"invalid cube map shape"),h.color[i]={target:dn,data:c[i]}}for(i=0;i<6;++i){for(var b=0;b<c.length;++b)h.color[b].target=dn+i;i>0&&(h.depth=a[0].depth,h.stencil=a[0].stencil,h.depthStencil=a[0].depthStencil),a[i]?a[i](h):a[i]=S(h)}return t(o,{width:p,height:p,color:c})}function c(e){var t,r=0|e;if(re(r>0&&r<=i.maxCubeMapSize,"invalid radius for cube fbo"),r===o.width)return o;var n=o.color;for(t=0;t<n.length;++t)n[t].resize(r);for(t=0;t<6;++t)a[t].resize(r);return o.width=o.height=r,o}return o(e),t(o,{faces:a,resize:c,_reglType:"framebufferCube",destroy:function(){a.forEach((function(e){e.destroy()}))}})}function I(){s.cur=null,s.next=null,s.dirty=!0,Et(v).forEach((function(t){t.framebuffer=e.createFramebuffer(),E(t)}))}return t(s,{getFramebuffer:function(e){if("function"==typeof e&&"framebuffer"===e._reglType){var t=e._framebuffer;if(t instanceof b)return t}return null},create:S,createCube:A,clear:function(){Et(v).forEach(T)},restore:I})}Rn[_n]="complete",Rn[xn]="incomplete attachment",Rn[bn]="incomplete dimensions",Rn[vn]="incomplete, missing attachment",Rn[wn]="unsupported";var On=5126,Un=34962,Vn=34963,$n=["attributes","elements","offset","count","primitive","instances"];function Nn(){this.state=0,this.x=0,this.y=0,this.z=0,this.w=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=On,this.offset=0,this.stride=0,this.divisor=0}function jn(t,r,i,n,a,o,s){for(var l=i.maxAttributes,c=new Array(l),u=0;u<l;++u)c[u]=new Nn;var h=0,p={},d={Record:Nn,scope:{},state:c,currentVAO:null,targetVAO:null,restore:m()?w:function(){},createVAO:T,getVAO:y,destroyBuffer:f,setVAO:m()?_:x,clear:m()?v:function(){}};function f(e){for(var r=0;r<c.length;++r){var i=c[r];i.buffer===e&&(t.disableVertexAttribArray(r),i.buffer=null)}}function m(){return r.oes_vertex_array_object}function g(){return r.angle_instanced_arrays}function y(e){return"function"==typeof e&&e._vao?e._vao:null}function _(e){if(e!==d.currentVAO){var t=m();e?t.bindVertexArrayOES(e.vao):t.bindVertexArrayOES(null),d.currentVAO=e}}function x(e){if(e!==d.currentVAO){if(e)e.bindAttrs();else{for(var r=g(),i=0;i<c.length;++i){var n=c[i];n.buffer?(t.enableVertexAttribArray(i),n.buffer.bind(),t.vertexAttribPointer(i,n.size,n.type,n.normalized,n.stride,n.offfset),r&&n.divisor&&r.vertexAttribDivisorANGLE(i,n.divisor)):(t.disableVertexAttribArray(i),t.vertexAttrib4f(i,n.x,n.y,n.z,n.w))}s.elements?t.bindBuffer(Vn,s.elements.buffer.buffer):t.bindBuffer(Vn,null)}d.currentVAO=e}}function v(){Et(p).forEach((function(e){e.destroy()}))}function b(){this.id=++h,this.attributes=[],this.elements=null,this.ownsElements=!1,this.count=0,this.offset=0,this.instances=-1,this.primitive=4;var e=m();this.vao=e?e.createVertexArrayOES():null,p[this.id]=this,this.buffers=[]}function w(){m()&&Et(p).forEach((function(e){e.refresh()}))}function T(t){var i=new b;function s(t){var n;if(Array.isArray(t))n=t,i.elements&&i.ownsElements&&i.elements.destroy(),i.elements=null,i.ownsElements=!1,i.offset=0,i.count=0,i.instances=-1,i.primitive=4;else{if(re("object"==typeof t,"invalid arguments for create vao"),re("attributes"in t,"must specify attributes for vao"),t.elements){var c=t.elements;i.ownsElements?"function"==typeof c&&"elements"===c._reglType?(i.elements.destroy(),i.ownsElements=!1):(i.elements(c),i.ownsElements=!1):o.getElements(t.elements)?(i.elements=t.elements,i.ownsElements=!1):(i.elements=o.create(t.elements),i.ownsElements=!0)}else i.elements=null,i.ownsElements=!1;n=t.attributes,i.offset=0,i.count=-1,i.instances=-1,i.primitive=4,i.elements&&(i.count=i.elements._elements.vertCount,i.primitive=i.elements._elements.primType),"offset"in t&&(i.offset=0|t.offset),"count"in t&&(i.count=0|t.count),"instances"in t&&(i.instances=0|t.instances),"primitive"in t&&(re(t.primitive in Zt,"bad primitive type: "+t.primitive),i.primitive=Zt[t.primitive]),re.optional((()=>{for(var e=Object.keys(t),r=0;r<e.length;++r)re($n.indexOf(e[r])>=0,'invalid option for vao: "'+e[r]+'" valid options are '+$n)})),re(Array.isArray(n),"attributes must be an array")}re(n.length<l,"too many attributes"),re(n.length>0,"must specify at least one attribute");var u={},h=i.attributes;h.length=n.length;for(var p=0;p<n.length;++p){var d,f=n[p],m=h[p]=new Nn,g=f.data||f;Array.isArray(g)||e(g)||Tt(g)?(i.buffers[p]&&(d=i.buffers[p],e(g)&&d._buffer.byteLength>=g.byteLength?d.subdata(g):(d.destroy(),i.buffers[p]=null)),i.buffers[p]||(d=i.buffers[p]=a.create(f,Un,!1,!0)),m.buffer=a.getBuffer(d),m.size=0|m.buffer.dimension,m.normalized=!1,m.type=m.buffer.dtype,m.offset=0,m.stride=0,m.divisor=0,m.state=1,u[p]=1):a.getBuffer(f)?(m.buffer=a.getBuffer(f),m.size=0|m.buffer.dimension,m.normalized=!1,m.type=m.buffer.dtype,m.offset=0,m.stride=0,m.divisor=0,m.state=1):a.getBuffer(f.buffer)?(m.buffer=a.getBuffer(f.buffer),m.size=0|(+f.size||m.buffer.dimension),m.normalized=!!f.normalized||!1,"type"in f?(re.parameter(f.type,Dt,"invalid buffer type"),m.type=Dt[f.type]):m.type=m.buffer.dtype,m.offset=0|(f.offset||0),m.stride=0|(f.stride||0),m.divisor=0|(f.divisor||0),m.state=1,re(m.size>=1&&m.size<=4,"size must be between 1 and 4"),re(m.offset>=0,"invalid offset"),re(m.stride>=0&&m.stride<=255,"stride must be between 0 and 255"),re(m.divisor>=0,"divisor must be positive"),re(!m.divisor||!!r.angle_instanced_arrays,"ANGLE_instanced_arrays must be enabled to use divisor")):"x"in f?(re(p>0,"first attribute must not be a constant"),m.x=+f.x||0,m.y=+f.y||0,m.z=+f.z||0,m.w=+f.w||0,m.state=2):re(!1,"invalid attribute spec for location "+p)}for(var y=0;y<i.buffers.length;++y)!u[y]&&i.buffers[y]&&(i.buffers[y].destroy(),i.buffers[y]=null);return i.refresh(),s}return n.vaoCount+=1,s.destroy=function(){for(var e=0;e<i.buffers.length;++e)i.buffers[e]&&i.buffers[e].destroy();i.buffers.length=0,i.ownsElements&&(i.elements.destroy(),i.elements=null,i.ownsElements=!1),i.destroy()},s._vao=i,s._reglType="vao",s(t)}return b.prototype.bindAttrs=function(){for(var e=g(),r=this.attributes,i=0;i<r.length;++i){var n=r[i];n.buffer?(t.enableVertexAttribArray(i),t.bindBuffer(Un,n.buffer.buffer),t.vertexAttribPointer(i,n.size,n.type,n.normalized,n.stride,n.offset),e&&n.divisor&&e.vertexAttribDivisorANGLE(i,n.divisor)):(t.disableVertexAttribArray(i),t.vertexAttrib4f(i,n.x,n.y,n.z,n.w))}for(var a=r.length;a<l;++a)t.disableVertexAttribArray(a);var s=o.getElements(this.elements);s?t.bindBuffer(Vn,s.buffer.buffer):t.bindBuffer(Vn,null)},b.prototype.refresh=function(){var e=m();e&&(e.bindVertexArrayOES(this.vao),this.bindAttrs(),d.currentVAO=null,e.bindVertexArrayOES(null))},b.prototype.destroy=function(){if(this.vao){var e=m();this===d.currentVAO&&(d.currentVAO=null,e.bindVertexArrayOES(null)),e.deleteVertexArrayOES(this.vao),this.vao=null}this.ownsElements&&(this.elements.destroy(),this.elements=null,this.ownsElements=!1),p[this.id]&&(delete p[this.id],n.vaoCount-=1)},d}var qn=35632,Gn=35633,Zn=35718,Xn=35721;function Wn(e,r,i,n){var a={},o={};function s(e,t,r,i){this.name=e,this.id=t,this.location=r,this.info=i}function l(e,t){for(var r=0;r<e.length;++r)if(e[r].id===t.id)return void(e[r].location=t.location);e.push(t)}function c(t,i,n){var s=t===qn?a:o,l=s[i];if(!l){var c=r.str(i);l=e.createShader(t),e.shaderSource(l,c),e.compileShader(l),re.shaderError(e,l,c,t,n),s[i]=l}return l}var u={},h=[],p=0;function d(e,t){this.id=p++,this.fragId=e,this.vertId=t,this.program=null,this.uniforms=[],this.attributes=[],this.refCount=1,n.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function f(t,i,a){var o,u,h=c(qn,t.fragId),p=c(Gn,t.vertId),d=t.program=e.createProgram();if(e.attachShader(d,h),e.attachShader(d,p),a)for(o=0;o<a.length;++o){var f=a[o];e.bindAttribLocation(d,f[0],f[1])}e.linkProgram(d),re.linkError(e,d,r.str(t.fragId),r.str(t.vertId),i);var m=e.getProgramParameter(d,Zn);n.profile&&(t.stats.uniformsCount=m);var g=t.uniforms;for(o=0;o<m;++o)if(u=e.getActiveUniform(d,o)){if(u.size>1)for(var y=0;y<u.size;++y){var _=u.name.replace("[0]","["+y+"]");l(g,new s(_,r.id(_),e.getUniformLocation(d,_),u))}var x=u.name;u.size>1&&(x=x.replace("[0]","")),l(g,new s(x,r.id(x),e.getUniformLocation(d,x),u))}var v=e.getProgramParameter(d,Xn);n.profile&&(t.stats.attributesCount=v);var b=t.attributes;for(o=0;o<v;++o)(u=e.getActiveAttrib(d,o))&&l(b,new s(u.name,r.id(u.name),e.getAttribLocation(d,u.name),u))}function m(){a={},o={};for(var e=0;e<h.length;++e)f(h[e],null,h[e].attributes.map((function(e){return[e.location,e.name]})))}return n.profile&&(i.getMaxUniformsCount=function(){var e=0;return h.forEach((function(t){t.stats.uniformsCount>e&&(e=t.stats.uniformsCount)})),e},i.getMaxAttributesCount=function(){var e=0;return h.forEach((function(t){t.stats.attributesCount>e&&(e=t.stats.attributesCount)})),e}),{clear:function(){var t=e.deleteShader.bind(e);Et(a).forEach(t),a={},Et(o).forEach(t),o={},h.forEach((function(t){e.deleteProgram(t.program)})),h.length=0,u={},i.shaderCount=0},program:function(r,n,s,l){re.command(r>=0,"missing vertex shader",s),re.command(n>=0,"missing fragment shader",s);var c=u[n];c||(c=u[n]={});var p=c[r];if(p&&(p.refCount++,!l))return p;var m=new d(n,r);return i.shaderCount++,f(m,s,l),p||(c[r]=m),h.push(m),t(m,{destroy:function(){if(m.refCount--,m.refCount<=0){e.deleteProgram(m.program);var t=h.indexOf(m);h.splice(t,1),i.shaderCount--}c[m.vertId].refCount<=0&&(e.deleteShader(o[m.vertId]),delete o[m.vertId],delete u[m.fragId][m.vertId]),Object.keys(u[m.fragId]).length||(e.deleteShader(a[m.fragId]),delete a[m.fragId],delete u[m.fragId])}})},restore:m,shader:c,frag:-1,vert:-1}}var Hn=6408,Kn=5121,Yn=3333,Jn=5126;function Qn(t,r,i,n,a,o,s){function l(l){var c;null===r.next?(re(a.preserveDrawingBuffer,'you must create a webgl context with "preserveDrawingBuffer":true in order to read pixels from the drawing buffer'),c=Kn):(re(null!==r.next.colorAttachments[0].texture,"You cannot read from a renderbuffer"),c=r.next.colorAttachments[0].texture._texture.type,re.optional((function(){o.oes_texture_float?(re(c===Kn||c===Jn,"Reading from a framebuffer is only allowed for the types 'uint8' and 'float'"),c===Jn&&re(s.readFloat,"Reading 'float' values is not permitted in your browser. For a fallback, please see: https://www.npmjs.com/package/glsl-read-float")):re(c===Kn,"Reading from a framebuffer is only allowed for the type 'uint8'")})));var u=0,h=0,p=n.framebufferWidth,d=n.framebufferHeight,f=null;e(l)?f=l:l&&(re.type(l,"object","invalid arguments to regl.read()"),u=0|l.x,h=0|l.y,re(u>=0&&u<n.framebufferWidth,"invalid x offset for regl.read"),re(h>=0&&h<n.framebufferHeight,"invalid y offset for regl.read"),p=0|(l.width||n.framebufferWidth-u),d=0|(l.height||n.framebufferHeight-h),f=l.data||null),f&&(c===Kn?re(f instanceof Uint8Array,"buffer must be 'Uint8Array' when reading from a framebuffer of type 'uint8'"):c===Jn&&re(f instanceof Float32Array,"buffer must be 'Float32Array' when reading from a framebuffer of type 'float'")),re(p>0&&p+u<=n.framebufferWidth,"invalid width for read pixels"),re(d>0&&d+h<=n.framebufferHeight,"invalid height for read pixels"),i();var m=p*d*4;return f||(c===Kn?f=new Uint8Array(m):c===Jn&&(f=f||new Float32Array(m))),re.isTypedArray(f,"data buffer for regl.read() must be a typedarray"),re(f.byteLength>=m,"data buffer for regl.read() too small"),t.pixelStorei(Yn,4),t.readPixels(u,h,p,d,Hn,c,f),f}function c(e){var t;return r.setFBO({framebuffer:e.framebuffer},(function(){t=l(e)})),t}function u(e){return e&&"framebuffer"in e?c(e):l(e)}return u}function ea(e){return Array.prototype.slice.call(e)}function ta(e){return ea(e).join("")}function ra(){var e=0,r=[],i=[];function n(t){for(var n=0;n<i.length;++n)if(i[n]===t)return r[n];var a="g"+e++;return r.push(a),i.push(t),a}function a(){var r=[];function i(){r.push.apply(r,ea(arguments))}var n=[];function a(){var t="v"+e++;return n.push(t),arguments.length>0&&(r.push(t,"="),r.push.apply(r,ea(arguments)),r.push(";")),t}return t(i,{def:a,toString:function(){return ta([n.length>0?"var "+n.join(",")+";":"",ta(r)])}})}function o(){var e=a(),r=a(),i=e.toString,n=r.toString;function o(t,i){r(t,i,"=",e.def(t,i),";")}return t((function(){e.apply(e,ea(arguments))}),{def:e.def,entry:e,exit:r,save:o,set:function(t,r,i){o(t,r),e(t,r,"=",i,";")},toString:function(){return i()+n()}})}function s(){var e=ta(arguments),r=o(),i=o(),n=r.toString,a=i.toString;return t(r,{then:function(){return r.apply(r,ea(arguments)),this},else:function(){return i.apply(i,ea(arguments)),this},toString:function(){var t=a();return t&&(t="else{"+t+"}"),ta(["if(",e,"){",n(),"}",t])}})}var l=a(),c={};function u(e,r){var i=[];function n(){var e="a"+i.length;return i.push(e),e}r=r||0;for(var a=0;a<r;++a)n();var s=o(),l=s.toString;return c[e]=t(s,{arg:n,toString:function(){return ta(["function(",i.join(),"){",l(),"}"])}})}function h(){var e=['"use strict";',l,"return {"];Object.keys(c).forEach((function(t){e.push('"',t,'":',c[t].toString(),",")})),e.push("}");var t=ta(e).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n");return Function.apply(null,r.concat(t)).apply(null,i)}return{global:l,link:n,block:a,proc:u,scope:o,cond:s,compile:h}}var ia="xyzw".split(""),na=5121,aa=1,oa=2,sa=0,la=1,ca=2,ua=3,ha=4,pa=5,da=6,fa="dither",ma="blend.enable",ga="blend.color",ya="blend.equation",_a="blend.func",xa="depth.enable",va="depth.func",ba="depth.range",wa="depth.mask",Ta="colorMask",Ea="cull.enable",Sa="cull.face",Aa="frontFace",Ia="lineWidth",ka="polygonOffset.enable",Ca="polygonOffset.offset",za="sample.alpha",Ma="sample.enable",Pa="sample.coverage",Da="stencil.enable",La="stencil.mask",Ba="stencil.func",Ra="stencil.opFront",Fa="stencil.opBack",Oa="scissor.enable",Ua="scissor.box",Va="viewport",$a="profile",Na="framebuffer",ja="vert",qa="frag",Ga="elements",Za="primitive",Xa="count",Wa="offset",Ha="instances",Ka="vao",Ya="Width",Ja="Height",Qa=Na+Ya,eo=Na+Ja,to=Va+Ya,ro=Va+Ja,io="drawingBuffer",no=io+Ya,ao=io+Ja,oo=[_a,ya,Ba,Ra,Fa,Pa,Va,Ua,Ca],so=34962,lo=34963,co=3553,uo=34067,ho=2884,po=3042,fo=3024,mo=2960,go=2929,yo=3089,_o=32823,xo=32926,vo=32928,bo=5126,wo=35664,To=35665,Eo=35666,So=5124,Ao=35667,Io=35668,ko=35669,Co=35670,zo=35671,Mo=35672,Po=35673,Do=35674,Lo=35675,Bo=35676,Ro=35678,Fo=35680,Oo=4,Uo=1028,Vo=1029,$o=2304,No=2305,jo=32775,qo=32776,Go=519,Zo=7680,Xo=0,Wo=1,Ho=32774,Ko=513,Yo=36160,Jo=36064,Qo={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},es=["constant color, constant alpha","one minus constant color, constant alpha","constant color, one minus constant alpha","one minus constant color, one minus constant alpha","constant alpha, constant color","constant alpha, one minus constant color","one minus constant alpha, constant color","one minus constant alpha, one minus constant color"],ts={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},rs={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},is={frag:35632,vert:35633},ns={cw:$o,ccw:No};function as(t){return Array.isArray(t)||e(t)||Tt(t)}function os(e){return e.sort((function(e,t){return e===Va?-1:t===Va?1:e<t?-1:1}))}function ss(e,t,r,i){this.thisDep=e,this.contextDep=t,this.propDep=r,this.append=i}function ls(e){return e&&!(e.thisDep||e.contextDep||e.propDep)}function cs(e){return new ss(!1,!1,!1,e)}function us(e,t){var r=e.type;if(r===sa){var i=e.data.length;return new ss(!0,i>=1,i>=2,t)}if(r===ha){var n=e.data;return new ss(n.thisDep,n.contextDep,n.propDep,t)}if(r===pa)return new ss(!1,!1,!1,t);if(r===da){for(var a=!1,o=!1,s=!1,l=0;l<e.data.length;++l){var c=e.data[l];if(c.type===la)s=!0;else if(c.type===ca)o=!0;else if(c.type===ua)a=!0;else if(c.type===sa){a=!0;var u=c.data;u>=1&&(o=!0),u>=2&&(s=!0)}else c.type===ha&&(a=a||c.data.thisDep,o=o||c.data.contextDep,s=s||c.data.propDep)}return new ss(a,o,s,t)}return new ss(r===ua,r===ca,r===la,t)}var hs=new ss(!1,!1,!1,(function(){}));function ps(e,r,i,n,a,o,s,l,c,u,h,p,d,f,m){var g=u.Record,y={add:32774,subtract:32778,"reverse subtract":32779};i.ext_blend_minmax&&(y.min=jo,y.max=qo);var _=i.angle_instanced_arrays,x=i.webgl_draw_buffers,v=i.oes_vertex_array_object,b={dirty:!0,profile:m.profile},w={},T=[],E={},S={};function A(e){return e.replace(".","_")}function I(e,t,r){var i=A(e);T.push(e),w[i]=b[i]=!!r,E[i]=t}function k(e,t,r){var i=A(e);T.push(e),Array.isArray(r)?(b[i]=r.slice(),w[i]=r.slice()):b[i]=w[i]=r,S[i]=t}I(fa,fo),I(ma,po),k(ga,"blendColor",[0,0,0,0]),k(ya,"blendEquationSeparate",[Ho,Ho]),k(_a,"blendFuncSeparate",[Wo,Xo,Wo,Xo]),I(xa,go,!0),k(va,"depthFunc",Ko),k(ba,"depthRange",[0,1]),k(wa,"depthMask",!0),k(Ta,Ta,[!0,!0,!0,!0]),I(Ea,ho),k(Sa,"cullFace",Vo),k(Aa,Aa,No),k(Ia,Ia,1),I(ka,_o),k(Ca,"polygonOffset",[0,0]),I(za,xo),I(Ma,vo),k(Pa,"sampleCoverage",[1,!1]),I(Da,mo),k(La,"stencilMask",-1),k(Ba,"stencilFunc",[Go,0,-1]),k(Ra,"stencilOpSeparate",[Uo,Zo,Zo,Zo]),k(Fa,"stencilOpSeparate",[Vo,Zo,Zo,Zo]),I(Oa,yo),k(Ua,"scissor",[0,0,e.drawingBufferWidth,e.drawingBufferHeight]),k(Va,Va,[0,0,e.drawingBufferWidth,e.drawingBufferHeight]);var C={gl:e,context:d,strings:r,next:w,current:b,draw:p,elements:o,buffer:a,shader:h,attributes:u.state,vao:u,uniforms:c,framebuffer:l,extensions:i,timer:f,isBufferArgs:as},z={primTypes:Zt,compareFuncs:ts,blendFuncs:Qo,blendEquations:y,stencilOps:rs,glTypes:Dt,orientationType:ns};re.optional((function(){C.isArrayLike=ur})),x&&(z.backBuffer=[Vo],z.drawBuffer=Ae(n.maxDrawbuffers,(function(e){return 0===e?[0]:Ae(e,(function(e){return Jo+e}))})));var M=0;function P(){var e=ra(),t=e.link,i=e.global;e.id=M++,e.batchId="0";var n=t(C),a=e.shared={props:"a0"};Object.keys(C).forEach((function(e){a[e]=i.def(n,".",e)})),re.optional((function(){e.CHECK=t(re),e.commandStr=re.guessCommand(),e.command=t(e.commandStr),e.assert=function(e,r,i){e("if(!(",r,"))",this.CHECK,".commandRaise(",t(i),",",this.command,");")},z.invalidBlendCombinations=es}));var o=e.next={},s=e.current={};Object.keys(S).forEach((function(e){Array.isArray(b[e])&&(o[e]=i.def(a.next,".",e),s[e]=i.def(a.current,".",e))}));var l=e.constants={};Object.keys(z).forEach((function(e){l[e]=i.def(JSON.stringify(z[e]))})),e.invoke=function(r,i){switch(i.type){case sa:var n=["this",a.context,a.props,e.batchId];return r.def(t(i.data),".call(",n.slice(0,Math.max(i.data.length+1,4)),")");case la:return r.def(a.props,i.data);case ca:return r.def(a.context,i.data);case ua:return r.def("this",i.data);case ha:return i.data.append(e,r),i.data.ref;case pa:return i.data.toString();case da:return i.data.map((function(t){return e.invoke(r,t)}))}},e.attribCache={};var c={};return e.scopeAttrib=function(e){var i=r.id(e);if(i in c)return c[i];var n=u.scope[i];return n||(n=u.scope[i]=new g),c[i]=t(n)},e}function D(e){var t,r=e.static,i=e.dynamic;if($a in r){var n=!!r[$a];(t=cs((function(e,t){return n}))).enable=n}else if($a in i){var a=i[$a];t=us(a,(function(e,t){return e.invoke(t,a)}))}return t}function L(e,t){var r=e.static,i=e.dynamic;if(Na in r){var n=r[Na];return n?(n=l.getFramebuffer(n),re.command(n,"invalid framebuffer object"),cs((function(e,t){var r=e.link(n),i=e.shared;t.set(i.framebuffer,".next",r);var a=i.context;return t.set(a,"."+Qa,r+".width"),t.set(a,"."+eo,r+".height"),r}))):cs((function(e,t){var r=e.shared;t.set(r.framebuffer,".next","null");var i=r.context;return t.set(i,"."+Qa,i+"."+no),t.set(i,"."+eo,i+"."+ao),"null"}))}if(Na in i){var a=i[Na];return us(a,(function(e,t){var r=e.invoke(t,a),i=e.shared,n=i.framebuffer,o=t.def(n,".getFramebuffer(",r,")");re.optional((function(){e.assert(t,"!"+r+"||"+o,"invalid framebuffer object")})),t.set(n,".next",o);var s=i.context;return t.set(s,"."+Qa,o+"?"+o+".width:"+s+"."+no),t.set(s,"."+eo,o+"?"+o+".height:"+s+"."+ao),o}))}return null}function B(e,t,r){var i=e.static,n=e.dynamic;function a(e){if(e in i){var a=i[e];re.commandType(a,"object","invalid "+e,r.commandStr);var o,s,l=!0,c=0|a.x,u=0|a.y;return"width"in a?(o=0|a.width,re.command(o>=0,"invalid "+e,r.commandStr)):l=!1,"height"in a?(s=0|a.height,re.command(s>=0,"invalid "+e,r.commandStr)):l=!1,new ss(!l&&t&&t.thisDep,!l&&t&&t.contextDep,!l&&t&&t.propDep,(function(e,t){var r=e.shared.context,i=o;"width"in a||(i=t.def(r,".",Qa,"-",c));var n=s;return"height"in a||(n=t.def(r,".",eo,"-",u)),[c,u,i,n]}))}if(e in n){var h=n[e],p=us(h,(function(t,r){var i=t.invoke(r,h);re.optional((function(){t.assert(r,i+"&&typeof "+i+'==="object"',"invalid "+e)}));var n=t.shared.context,a=r.def(i,".x|0"),o=r.def(i,".y|0"),s=r.def('"width" in ',i,"?",i,".width|0:","(",n,".",Qa,"-",a,")"),l=r.def('"height" in ',i,"?",i,".height|0:","(",n,".",eo,"-",o,")");return re.optional((function(){t.assert(r,s+">=0&&"+l+">=0","invalid "+e)})),[a,o,s,l]}));return t&&(p.thisDep=p.thisDep||t.thisDep,p.contextDep=p.contextDep||t.contextDep,p.propDep=p.propDep||t.propDep),p}return t?new ss(t.thisDep,t.contextDep,t.propDep,(function(e,t){var r=e.shared.context;return[0,0,t.def(r,".",Qa),t.def(r,".",eo)]})):null}var o=a(Va);if(o){var s=o;o=new ss(o.thisDep,o.contextDep,o.propDep,(function(e,t){var r=s.append(e,t),i=e.shared.context;return t.set(i,"."+to,r[2]),t.set(i,"."+ro,r[3]),r}))}return{viewport:o,scissor_box:a(Ua)}}function R(e,t){var r=e.static;if("string"==typeof r[qa]&&"string"==typeof r[ja]){if(Object.keys(t.dynamic).length>0)return null;var i=t.static,n=Object.keys(i);if(n.length>0&&"number"==typeof i[n[0]]){for(var a=[],o=0;o<n.length;++o)re("number"==typeof i[n[o]],"must specify all vertex attribute locations when using vaos"),a.push([0|i[n[o]],n[o]]);return a}}return null}function F(e,t,i){var n=e.static,a=e.dynamic;function o(e){if(e in n){var t=r.id(n[e]);re.optional((function(){h.shader(is[e],t,re.guessCommand())}));var i=cs((function(){return t}));return i.id=t,i}if(e in a){var o=a[e];return us(o,(function(t,r){var i=t.invoke(r,o),n=r.def(t.shared.strings,".id(",i,")");return re.optional((function(){r(t.shared.shader,".shader(",is[e],",",n,",",t.command,");")})),n}))}return null}var s,l=o(qa),c=o(ja),u=null;return ls(l)&&ls(c)?(u=h.program(c.id,l.id,null,i),s=cs((function(e,t){return e.link(u)}))):s=new ss(l&&l.thisDep||c&&c.thisDep,l&&l.contextDep||c&&c.contextDep,l&&l.propDep||c&&c.propDep,(function(e,t){var r,i=e.shared.shader;r=l?l.append(e,t):t.def(i,".",qa);var n=i+".program("+(c?c.append(e,t):t.def(i,".",ja))+","+r;return re.optional((function(){n+=","+e.command})),t.def(n+")")})),{frag:l,vert:c,progVar:s,program:u}}function O(e,t){var r=e.static,i=e.dynamic,n={},a=!1;function s(){if(Ka in r){var e=r[Ka];return null!==e&&null===u.getVAO(e)&&(e=u.createVAO(e)),a=!0,n.vao=e,cs((function(t){var r=u.getVAO(e);return r?t.link(r):"null"}))}if(Ka in i){a=!0;var t=i[Ka];return us(t,(function(e,r){var i=e.invoke(r,t);return r.def(e.shared.vao+".getVAO("+i+")")}))}return null}var l=s(),c=!1;function h(){if(Ga in r){var e=r[Ga];if(n.elements=e,as(e)){var s=n.elements=o.create(e,!0);e=o.getElements(s),c=!0}else e&&(e=o.getElements(e),c=!0,re.command(e,"invalid elements",t.commandStr));var u=cs((function(t,r){if(e){var i=t.link(e);return t.ELEMENTS=i,i}return t.ELEMENTS=null,null}));return u.value=e,u}if(Ga in i){c=!0;var h=i[Ga];return us(h,(function(e,t){var r=e.shared,i=r.isBufferArgs,n=r.elements,a=e.invoke(t,h),o=t.def("null"),s=t.def(i,"(",a,")"),l=e.cond(s).then(o,"=",n,".createStream(",a,");").else(o,"=",n,".getElements(",a,");");return re.optional((function(){e.assert(l.else,"!"+a+"||"+o,"invalid elements")})),t.entry(l),t.exit(e.cond(s).then(n,".destroyStream(",o,");")),e.ELEMENTS=o,o}))}return a?new ss(l.thisDep,l.contextDep,l.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.elements+".getElements("+e.shared.vao+".currentVAO.elements):null")})):null}var p=h();function d(){if(Za in r){var e=r[Za];return n.primitive=e,re.commandParameter(e,Zt,"invalid primitve",t.commandStr),cs((function(t,r){return Zt[e]}))}if(Za in i){var o=i[Za];return us(o,(function(e,t){var r=e.constants.primTypes,i=e.invoke(t,o);return re.optional((function(){e.assert(t,i+" in "+r,"invalid primitive, must be one of "+Object.keys(Zt))})),t.def(r,"[",i,"]")}))}return c?ls(p)?p.value?cs((function(e,t){return t.def(e.ELEMENTS,".primType")})):cs((function(){return Oo})):new ss(p.thisDep,p.contextDep,p.propDep,(function(e,t){var r=e.ELEMENTS;return t.def(r,"?",r,".primType:",Oo)})):a?new ss(l.thisDep,l.contextDep,l.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.primitive:"+Oo)})):null}function f(e,o){if(e in r){var s=0|r[e];return o?n.offset=s:n.instances=s,re.command(!o||s>=0,"invalid "+e,t.commandStr),cs((function(e,t){return o&&(e.OFFSET=s),s}))}if(e in i){var u=i[e];return us(u,(function(t,r){var i=t.invoke(r,u);return o&&(t.OFFSET=i,re.optional((function(){t.assert(r,i+">=0","invalid "+e)}))),i}))}if(o){if(c)return cs((function(e,t){return e.OFFSET=0,0}));if(a)return new ss(l.thisDep,l.contextDep,l.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.offset:0")}))}else if(a)return new ss(l.thisDep,l.contextDep,l.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.instances:-1")}));return null}var m=f(Wa,!0);function g(){if(Xa in r){var e=0|r[Xa];return n.count=e,re.command("number"==typeof e&&e>=0,"invalid vertex count",t.commandStr),cs((function(){return e}))}if(Xa in i){var o=i[Xa];return us(o,(function(e,t){var r=e.invoke(t,o);return re.optional((function(){e.assert(t,"typeof "+r+'==="number"&&'+r+">=0&&"+r+"===("+r+"|0)","invalid vertex count")})),r}))}if(c){if(ls(p)){if(p)return m?new ss(m.thisDep,m.contextDep,m.propDep,(function(e,t){var r=t.def(e.ELEMENTS,".vertCount-",e.OFFSET);return re.optional((function(){e.assert(t,r+">=0","invalid vertex offset/element buffer too small")})),r})):cs((function(e,t){return t.def(e.ELEMENTS,".vertCount")}));var s=cs((function(){return-1}));return re.optional((function(){s.MISSING=!0})),s}var u=new ss(p.thisDep||m.thisDep,p.contextDep||m.contextDep,p.propDep||m.propDep,(function(e,t){var r=e.ELEMENTS;return e.OFFSET?t.def(r,"?",r,".vertCount-",e.OFFSET,":-1"):t.def(r,"?",r,".vertCount:-1")}));return re.optional((function(){u.DYNAMIC=!0})),u}if(a){var h=new ss(l.thisDep,l.contextDep,l.propDep,(function(e,t){return t.def(e.shared.vao,".currentVAO?",e.shared.vao,".currentVAO.count:-1")}));return h}return null}var y=d(),_=g(),x=f(Ha,!1);return{elements:p,primitive:y,count:_,instances:x,offset:m,vao:l,vaoActive:a,elementsActive:c,static:n}}function U(e,t){var r=e.static,i=e.dynamic,a={};return T.forEach((function(e){var o=A(e);function s(t,n){if(e in r){var s=t(r[e]);a[o]=cs((function(){return s}))}else if(e in i){var l=i[e];a[o]=us(l,(function(e,t){return n(e,t,e.invoke(t,l))}))}}switch(e){case Ea:case ma:case fa:case Da:case xa:case Oa:case ka:case za:case Ma:case wa:return s((function(r){return re.commandType(r,"boolean",e,t.commandStr),r}),(function(t,r,i){return re.optional((function(){t.assert(r,"typeof "+i+'==="boolean"',"invalid flag "+e,t.commandStr)})),i}));case va:return s((function(r){return re.commandParameter(r,ts,"invalid "+e,t.commandStr),ts[r]}),(function(t,r,i){var n=t.constants.compareFuncs;return re.optional((function(){t.assert(r,i+" in "+n,"invalid "+e+", must be one of "+Object.keys(ts))})),r.def(n,"[",i,"]")}));case ba:return s((function(e){return re.command(ur(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]&&e[0]<=e[1],"depth range is 2d array",t.commandStr),e}),(function(e,t,r){return re.optional((function(){e.assert(t,e.shared.isArrayLike+"("+r+")&&"+r+".length===2&&typeof "+r+'[0]==="number"&&typeof '+r+'[1]==="number"&&'+r+"[0]<="+r+"[1]","depth range must be a 2d array")})),[t.def("+",r,"[0]"),t.def("+",r,"[1]")]}));case _a:return s((function(e){re.commandType(e,"object","blend.func",t.commandStr);var r="srcRGB"in e?e.srcRGB:e.src,i="srcAlpha"in e?e.srcAlpha:e.src,n="dstRGB"in e?e.dstRGB:e.dst,a="dstAlpha"in e?e.dstAlpha:e.dst;return re.commandParameter(r,Qo,o+".srcRGB",t.commandStr),re.commandParameter(i,Qo,o+".srcAlpha",t.commandStr),re.commandParameter(n,Qo,o+".dstRGB",t.commandStr),re.commandParameter(a,Qo,o+".dstAlpha",t.commandStr),re.command(-1===es.indexOf(r+", "+n),"unallowed blending combination (srcRGB, dstRGB) = ("+r+", "+n+")",t.commandStr),[Qo[r],Qo[n],Qo[i],Qo[a]]}),(function(t,r,i){var n=t.constants.blendFuncs;function a(a,o){var s=r.def('"',a,o,'" in ',i,"?",i,".",a,o,":",i,".",a);return re.optional((function(){t.assert(r,s+" in "+n,"invalid "+e+"."+a+o+", must be one of "+Object.keys(Qo))})),s}re.optional((function(){t.assert(r,i+"&&typeof "+i+'==="object"',"invalid blend func, must be an object")}));var o=a("src","RGB"),s=a("dst","RGB");re.optional((function(){var e=t.constants.invalidBlendCombinations;t.assert(r,e+".indexOf("+o+'+", "+'+s+") === -1 ","unallowed blending combination for (srcRGB, dstRGB)")}));var l=r.def(n,"[",o,"]"),c=r.def(n,"[",a("src","Alpha"),"]");return[l,r.def(n,"[",s,"]"),c,r.def(n,"[",a("dst","Alpha"),"]")]}));case ya:return s((function(r){return"string"==typeof r?(re.commandParameter(r,y,"invalid "+e,t.commandStr),[y[r],y[r]]):"object"==typeof r?(re.commandParameter(r.rgb,y,e+".rgb",t.commandStr),re.commandParameter(r.alpha,y,e+".alpha",t.commandStr),[y[r.rgb],y[r.alpha]]):void re.commandRaise("invalid blend.equation",t.commandStr)}),(function(t,r,i){var n=t.constants.blendEquations,a=r.def(),o=r.def(),s=t.cond("typeof ",i,'==="string"');return re.optional((function(){function r(e,r,i){t.assert(e,i+" in "+n,"invalid "+r+", must be one of "+Object.keys(y))}r(s.then,e,i),t.assert(s.else,i+"&&typeof "+i+'==="object"',"invalid "+e),r(s.else,e+".rgb",i+".rgb"),r(s.else,e+".alpha",i+".alpha")})),s.then(a,"=",o,"=",n,"[",i,"];"),s.else(a,"=",n,"[",i,".rgb];",o,"=",n,"[",i,".alpha];"),r(s),[a,o]}));case ga:return s((function(e){return re.command(ur(e)&&4===e.length,"blend.color must be a 4d array",t.commandStr),Ae(4,(function(t){return+e[t]}))}),(function(e,t,r){return re.optional((function(){e.assert(t,e.shared.isArrayLike+"("+r+")&&"+r+".length===4","blend.color must be a 4d array")})),Ae(4,(function(e){return t.def("+",r,"[",e,"]")}))}));case La:return s((function(e){return re.commandType(e,"number",o,t.commandStr),0|e}),(function(e,t,r){return re.optional((function(){e.assert(t,"typeof "+r+'==="number"',"invalid stencil.mask")})),t.def(r,"|0")}));case Ba:return s((function(r){re.commandType(r,"object",o,t.commandStr);var i=r.cmp||"keep",n=r.ref||0,a="mask"in r?r.mask:-1;return re.commandParameter(i,ts,e+".cmp",t.commandStr),re.commandType(n,"number",e+".ref",t.commandStr),re.commandType(a,"number",e+".mask",t.commandStr),[ts[i],n,a]}),(function(e,t,r){var i=e.constants.compareFuncs;return re.optional((function(){function n(){e.assert(t,Array.prototype.join.call(arguments,""),"invalid stencil.func")}n(r+"&&typeof ",r,'==="object"'),n('!("cmp" in ',r,")||(",r,".cmp in ",i,")")})),[t.def('"cmp" in ',r,"?",i,"[",r,".cmp]",":",Zo),t.def(r,".ref|0"),t.def('"mask" in ',r,"?",r,".mask|0:-1")]}));case Ra:case Fa:return s((function(r){re.commandType(r,"object",o,t.commandStr);var i=r.fail||"keep",n=r.zfail||"keep",a=r.zpass||"keep";return re.commandParameter(i,rs,e+".fail",t.commandStr),re.commandParameter(n,rs,e+".zfail",t.commandStr),re.commandParameter(a,rs,e+".zpass",t.commandStr),[e===Fa?Vo:Uo,rs[i],rs[n],rs[a]]}),(function(t,r,i){var n=t.constants.stencilOps;function a(a){return re.optional((function(){t.assert(r,'!("'+a+'" in '+i+")||("+i+"."+a+" in "+n+")","invalid "+e+"."+a+", must be one of "+Object.keys(rs))})),r.def('"',a,'" in ',i,"?",n,"[",i,".",a,"]:",Zo)}return re.optional((function(){t.assert(r,i+"&&typeof "+i+'==="object"',"invalid "+e)})),[e===Fa?Vo:Uo,a("fail"),a("zfail"),a("zpass")]}));case Ca:return s((function(e){re.commandType(e,"object",o,t.commandStr);var r=0|e.factor,i=0|e.units;return re.commandType(r,"number",o+".factor",t.commandStr),re.commandType(i,"number",o+".units",t.commandStr),[r,i]}),(function(t,r,i){return re.optional((function(){t.assert(r,i+"&&typeof "+i+'==="object"',"invalid "+e)})),[r.def(i,".factor|0"),r.def(i,".units|0")]}));case Sa:return s((function(e){var r=0;return"front"===e?r=Uo:"back"===e&&(r=Vo),re.command(!!r,o,t.commandStr),r}),(function(e,t,r){return re.optional((function(){e.assert(t,r+'==="front"||'+r+'==="back"',"invalid cull.face")})),t.def(r,'==="front"?',Uo,":",Vo)}));case Ia:return s((function(e){return re.command("number"==typeof e&&e>=n.lineWidthDims[0]&&e<=n.lineWidthDims[1],"invalid line width, must be a positive number between "+n.lineWidthDims[0]+" and "+n.lineWidthDims[1],t.commandStr),e}),(function(e,t,r){return re.optional((function(){e.assert(t,"typeof "+r+'==="number"&&'+r+">="+n.lineWidthDims[0]+"&&"+r+"<="+n.lineWidthDims[1],"invalid line width")})),r}));case Aa:return s((function(e){return re.commandParameter(e,ns,o,t.commandStr),ns[e]}),(function(e,t,r){return re.optional((function(){e.assert(t,r+'==="cw"||'+r+'==="ccw"',"invalid frontFace, must be one of cw,ccw")})),t.def(r+'==="cw"?'+$o+":"+No)}));case Ta:return s((function(e){return re.command(ur(e)&&4===e.length,"color.mask must be length 4 array",t.commandStr),e.map((function(e){return!!e}))}),(function(e,t,r){return re.optional((function(){e.assert(t,e.shared.isArrayLike+"("+r+")&&"+r+".length===4","invalid color.mask")})),Ae(4,(function(e){return"!!"+r+"["+e+"]"}))}));case Pa:return s((function(e){re.command("object"==typeof e&&e,o,t.commandStr);var r="value"in e?e.value:1,i=!!e.invert;return re.command("number"==typeof r&&r>=0&&r<=1,"sample.coverage.value must be a number between 0 and 1",t.commandStr),[r,i]}),(function(e,t,r){return re.optional((function(){e.assert(t,r+"&&typeof "+r+'==="object"',"invalid sample.coverage")})),[t.def('"value" in ',r,"?+",r,".value:1"),t.def("!!",r,".invert")]}))}})),a}function V(e,t){var r=e.static,i=e.dynamic,n={};return Object.keys(r).forEach((function(e){var i,a=r[e];if("number"==typeof a||"boolean"==typeof a)i=cs((function(){return a}));else if("function"==typeof a){var o=a._reglType;"texture2d"===o||"textureCube"===o?i=cs((function(e){return e.link(a)})):"framebuffer"===o||"framebufferCube"===o?(re.command(a.color.length>0,'missing color attachment for framebuffer sent to uniform "'+e+'"',t.commandStr),i=cs((function(e){return e.link(a.color[0])}))):re.commandRaise('invalid data for uniform "'+e+'"',t.commandStr)}else ur(a)?i=cs((function(t){var r=t.global.def("[",Ae(a.length,(function(r){return re.command("number"==typeof a[r]||"boolean"==typeof a[r],"invalid uniform "+e,t.commandStr),a[r]})),"]");return r})):re.commandRaise('invalid or missing data for uniform "'+e+'"',t.commandStr);i.value=a,n[e]=i})),Object.keys(i).forEach((function(e){var t=i[e];n[e]=us(t,(function(e,r){return e.invoke(r,t)}))})),n}function $(e,t){var i=e.static,n=e.dynamic,o={};return Object.keys(i).forEach((function(e){var n=i[e],s=r.id(e),l=new g;if(as(n))l.state=aa,l.buffer=a.getBuffer(a.create(n,so,!1,!0)),l.type=0;else{var c=a.getBuffer(n);if(c)l.state=aa,l.buffer=c,l.type=0;else if(re.command("object"==typeof n&&n,"invalid data for attribute "+e,t.commandStr),"constant"in n){var u=n.constant;l.buffer="null",l.state=oa,"number"==typeof u?l.x=u:(re.command(ur(u)&&u.length>0&&u.length<=4,"invalid constant for attribute "+e,t.commandStr),ia.forEach((function(e,t){t<u.length&&(l[e]=u[t])})))}else{c=as(n.buffer)?a.getBuffer(a.create(n.buffer,so,!1,!0)):a.getBuffer(n.buffer),re.command(!!c,'missing buffer for attribute "'+e+'"',t.commandStr);var h=0|n.offset;re.command(h>=0,'invalid offset for attribute "'+e+'"',t.commandStr);var p=0|n.stride;re.command(p>=0&&p<256,'invalid stride for attribute "'+e+'", must be integer betweeen [0, 255]',t.commandStr);var d=0|n.size;re.command(!("size"in n)||d>0&&d<=4,'invalid size for attribute "'+e+'", must be 1,2,3,4',t.commandStr);var f=!!n.normalized,m=0;"type"in n&&(re.commandParameter(n.type,Dt,"invalid type for attribute "+e,t.commandStr),m=Dt[n.type]);var y=0|n.divisor;re.optional((function(){"divisor"in n&&(re.command(0===y||_,'cannot specify divisor for attribute "'+e+'", instancing not supported',t.commandStr),re.command(y>=0,'invalid divisor for attribute "'+e+'"',t.commandStr));var r=t.commandStr,i=["buffer","offset","divisor","normalized","type","size","stride"];Object.keys(n).forEach((function(t){re.command(i.indexOf(t)>=0,'unknown parameter "'+t+'" for attribute pointer "'+e+'" (valid parameters are '+i+")",r)}))})),l.buffer=c,l.state=aa,l.size=d,l.normalized=f,l.type=m||c.dtype,l.offset=h,l.stride=p,l.divisor=y}}o[e]=cs((function(e,t){var r=e.attribCache;if(s in r)return r[s];var i={isStream:!1};return Object.keys(l).forEach((function(e){i[e]=l[e]})),l.buffer&&(i.buffer=e.link(l.buffer),i.type=i.type||i.buffer+".dtype"),r[s]=i,i}))})),Object.keys(n).forEach((function(e){var t=n[e];function r(r,i){var n=r.invoke(i,t),a=r.shared,o=r.constants,s=a.isBufferArgs,l=a.buffer;re.optional((function(){r.assert(i,n+"&&(typeof "+n+'==="object"||typeof '+n+'==="function")&&('+s+"("+n+")||"+l+".getBuffer("+n+")||"+l+".getBuffer("+n+".buffer)||"+s+"("+n+'.buffer)||("constant" in '+n+"&&(typeof "+n+'.constant==="number"||'+a.isArrayLike+"("+n+".constant))))",'invalid dynamic attribute "'+e+'"')}));var c={isStream:i.def(!1)},u=new g;u.state=aa,Object.keys(u).forEach((function(e){c[e]=i.def(""+u[e])}));var h=c.buffer,p=c.type;function d(e){i(c[e],"=",n,".",e,"|0;")}return i("if(",s,"(",n,")){",c.isStream,"=true;",h,"=",l,".createStream(",so,",",n,");",p,"=",h,".dtype;","}else{",h,"=",l,".getBuffer(",n,");","if(",h,"){",p,"=",h,".dtype;",'}else if("constant" in ',n,"){",c.state,"=",oa,";","if(typeof "+n+'.constant === "number"){',c[ia[0]],"=",n,".constant;",ia.slice(1).map((function(e){return c[e]})).join("="),"=0;","}else{",ia.map((function(e,t){return c[e]+"="+n+".constant.length>"+t+"?"+n+".constant["+t+"]:0;"})).join(""),"}}else{","if(",s,"(",n,".buffer)){",h,"=",l,".createStream(",so,",",n,".buffer);","}else{",h,"=",l,".getBuffer(",n,".buffer);","}",p,'="type" in ',n,"?",o.glTypes,"[",n,".type]:",h,".dtype;",c.normalized,"=!!",n,".normalized;"),d("size"),d("offset"),d("stride"),d("divisor"),i("}}"),i.exit("if(",c.isStream,"){",l,".destroyStream(",h,");","}"),c}o[e]=us(t,r)})),o}function N(e){var t=e.static,r=e.dynamic,i={};return Object.keys(t).forEach((function(e){var r=t[e];i[e]=cs((function(e,t){return"number"==typeof r||"boolean"==typeof r?""+r:e.link(r)}))})),Object.keys(r).forEach((function(e){var t=r[e];i[e]=us(t,(function(e,r){return e.invoke(r,t)}))})),i}function j(e,t,r,n,a){var o=e.static,s=e.dynamic;re.optional((function(){var e=[Na,ja,qa,Ga,Za,Wa,Xa,Ha,$a,Ka].concat(T);function t(t){Object.keys(t).forEach((function(t){re.command(e.indexOf(t)>=0,'unknown parameter "'+t+'"',a.commandStr)}))}t(o),t(s)}));var l=R(e,t),c=L(e),h=B(e,c,a),p=O(e,a),d=U(e,a),f=F(e,a,l);function m(e){var t=h[e];t&&(d[e]=t)}m(Va),m(A(Ua));var g=Object.keys(d).length>0,y={framebuffer:c,draw:p,shader:f,state:d,dirty:g,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}};if(y.profile=D(e),y.uniforms=V(r,a),y.drawVAO=y.scopeVAO=p.vao,!y.drawVAO&&f.program&&!l&&i.angle_instanced_arrays&&p.static.elements){var _=!0,x=f.program.attributes.map((function(e){var r=t.static[e];return _=_&&!!r,r}));if(_&&x.length>0){var v=u.getVAO(u.createVAO({attributes:x,elements:p.static.elements}));y.drawVAO=new ss(null,null,null,(function(e,t){return e.link(v)})),y.useVAO=!0}}return l?y.useVAO=!0:y.attributes=$(t,a),y.context=N(n),y}function q(e,t,r){var i=e.shared.context,n=e.scope();Object.keys(r).forEach((function(a){t.save(i,"."+a);var o=r[a].append(e,t);Array.isArray(o)?n(i,".",a,"=[",o.join(),"];"):n(i,".",a,"=",o,";")})),t(n)}function G(e,t,r,i){var n,a=e.shared,o=a.gl,s=a.framebuffer;x&&(n=t.def(a.extensions,".webgl_draw_buffers"));var l,c=e.constants,u=c.drawBuffer,h=c.backBuffer;l=r?r.append(e,t):t.def(s,".next"),i||t("if(",l,"!==",s,".cur){"),t("if(",l,"){",o,".bindFramebuffer(",Yo,",",l,".framebuffer);"),x&&t(n,".drawBuffersWEBGL(",u,"[",l,".colorAttachments.length]);"),t("}else{",o,".bindFramebuffer(",Yo,",null);"),x&&t(n,".drawBuffersWEBGL(",h,");"),t("}",s,".cur=",l,";"),i||t("}")}function Z(e,t,r){var i=e.shared,n=i.gl,a=e.current,o=e.next,s=i.current,l=i.next,c=e.cond(s,".dirty");T.forEach((function(t){var i,u,h=A(t);if(!(h in r.state))if(h in o){i=o[h],u=a[h];var p=Ae(b[h].length,(function(e){return c.def(i,"[",e,"]")}));c(e.cond(p.map((function(e,t){return e+"!=="+u+"["+t+"]"})).join("||")).then(n,".",S[h],"(",p,");",p.map((function(e,t){return u+"["+t+"]="+e})).join(";"),";"))}else{i=c.def(l,".",h);var d=e.cond(i,"!==",s,".",h);c(d),h in E?d(e.cond(i).then(n,".enable(",E[h],");").else(n,".disable(",E[h],");"),s,".",h,"=",i,";"):d(n,".",S[h],"(",i,");",s,".",h,"=",i,";")}})),0===Object.keys(r.state).length&&c(s,".dirty=false;"),t(c)}function X(e,t,r,i){var n=e.shared,a=e.current,o=n.current,s=n.gl;os(Object.keys(r)).forEach((function(n){var l=r[n];if(!i||i(l)){var c=l.append(e,t);if(E[n]){var u=E[n];ls(l)?t(s,c?".enable(":".disable(",u,");"):t(e.cond(c).then(s,".enable(",u,");").else(s,".disable(",u,");")),t(o,".",n,"=",c,";")}else if(ur(c)){var h=a[n];t(s,".",S[n],"(",c,");",c.map((function(e,t){return h+"["+t+"]="+e})).join(";"),";")}else t(s,".",S[n],"(",c,");",o,".",n,"=",c,";")}}))}function W(e,t){_&&(e.instancing=t.def(e.shared.extensions,".angle_instanced_arrays"))}function H(e,t,r,i,n){var a,o,s,l=e.shared,c=e.stats,u=l.current,h=l.timer,p=r.profile;function d(){return"undefined"==typeof performance?"Date.now()":"performance.now()"}function m(e){e(a=t.def(),"=",d(),";"),"string"==typeof n?e(c,".count+=",n,";"):e(c,".count++;"),f&&(i?e(o=t.def(),"=",h,".getNumPendingQueries();"):e(h,".beginQuery(",c,");"))}function g(e){e(c,".cpuTime+=",d(),"-",a,";"),f&&(i?e(h,".pushScopeStats(",o,",",h,".getNumPendingQueries(),",c,");"):e(h,".endQuery();"))}function y(e){var r=t.def(u,".profile");t(u,".profile=",e,";"),t.exit(u,".profile=",r,";")}if(p){if(ls(p))return void(p.enable?(m(t),g(t.exit),y("true")):y("false"));y(s=p.append(e,t))}else s=t.def(u,".profile");var _=e.block();m(_),t("if(",s,"){",_,"}");var x=e.block();g(x),t.exit("if(",s,"){",x,"}")}function K(e,t,r,i,n){var a=e.shared;function o(e){switch(e){case wo:case Ao:case zo:return 2;case To:case Io:case Mo:return 3;case Eo:case ko:case Po:return 4;default:return 1}}function s(r,i,n){var o=a.gl,s=t.def(r,".location"),l=t.def(a.attributes,"[",s,"]"),c=n.state,u=n.buffer,h=[n.x,n.y,n.z,n.w],p=["buffer","normalized","offset","stride"];function d(){t("if(!",l,".buffer){",o,".enableVertexAttribArray(",s,");}");var r,a=n.type;if(r=n.size?t.def(n.size,"||",i):i,t("if(",l,".type!==",a,"||",l,".size!==",r,"||",p.map((function(e){return l+"."+e+"!=="+n[e]})).join("||"),"){",o,".bindBuffer(",so,",",u,".buffer);",o,".vertexAttribPointer(",[s,r,a,n.normalized,n.stride,n.offset],");",l,".type=",a,";",l,".size=",r,";",p.map((function(e){return l+"."+e+"="+n[e]+";"})).join(""),"}"),_){var c=n.divisor;t("if(",l,".divisor!==",c,"){",e.instancing,".vertexAttribDivisorANGLE(",[s,c],");",l,".divisor=",c,";}")}}function f(){t("if(",l,".buffer){",o,".disableVertexAttribArray(",s,");",l,".buffer=null;","}if(",ia.map((function(e,t){return l+"."+e+"!=="+h[t]})).join("||"),"){",o,".vertexAttrib4f(",s,",",h,");",ia.map((function(e,t){return l+"."+e+"="+h[t]+";"})).join(""),"}")}c===aa?d():c===oa?f():(t("if(",c,"===",aa,"){"),d(),t("}else{"),f(),t("}"))}i.forEach((function(i){var a,l=i.name,c=r.attributes[l];if(c){if(!n(c))return;a=c.append(e,t)}else{if(!n(hs))return;var u=e.scopeAttrib(l);re.optional((function(){e.assert(t,u+".state","missing attribute "+l)})),a={},Object.keys(new g).forEach((function(e){a[e]=t.def(u,".",e)}))}s(e.link(i),o(i.info.type),a)}))}function Y(e,t,i,n,a,o){for(var s,l=e.shared,c=l.gl,u={},h=0;h<n.length;++h){var p=n[h],d=p.name,f=p.info.type,m=p.info.size,g=i.uniforms[d];if(m>1){if(!g)continue;var y=d.replace("[0]","");if(u[y])continue;u[y]=1}var _,x=e.link(p)+".location";if(g){if(!a(g))continue;if(ls(g)){var v=g.value;if(re.command(null!=v,'missing uniform "'+d+'"',e.commandStr),f===Ro||f===Fo){re.command("function"==typeof v&&(f===Ro&&("texture2d"===v._reglType||"framebuffer"===v._reglType)||f===Fo&&("textureCube"===v._reglType||"framebufferCube"===v._reglType)),"invalid texture for uniform "+d,e.commandStr);var b=e.link(v._texture||v.color[0]._texture);t(c,".uniform1i(",x,",",b+".bind());"),t.exit(b,".unbind();")}else if(f===Do||f===Lo||f===Bo){re.optional((function(){re.command(ur(v),"invalid matrix for uniform "+d,e.commandStr),re.command(f===Do&&4===v.length||f===Lo&&9===v.length||f===Bo&&16===v.length,"invalid length for matrix uniform "+d,e.commandStr)}));var w=e.global.def("new Float32Array(["+Array.prototype.slice.call(v)+"])"),T=2;f===Lo?T=3:f===Bo&&(T=4),t(c,".uniformMatrix",T,"fv(",x,",false,",w,");")}else{switch(f){case bo:1===m?re.commandType(v,"number","uniform "+d,e.commandStr):re.command(ur(v)&&v.length===m,"uniform "+d,e.commandStr),s="1f";break;case wo:re.command(ur(v)&&v.length&&v.length%2==0&&v.length<=2*m,"uniform "+d,e.commandStr),s="2f";break;case To:re.command(ur(v)&&v.length&&v.length%3==0&&v.length<=3*m,"uniform "+d,e.commandStr),s="3f";break;case Eo:re.command(ur(v)&&v.length&&v.length%4==0&&v.length<=4*m,"uniform "+d,e.commandStr),s="4f";break;case Co:1===m?re.commandType(v,"boolean","uniform "+d,e.commandStr):re.command(ur(v)&&v.length===m,"uniform "+d,e.commandStr),s="1i";break;case So:1===m?re.commandType(v,"number","uniform "+d,e.commandStr):re.command(ur(v)&&v.length===m,"uniform "+d,e.commandStr),s="1i";break;case zo:case Ao:re.command(ur(v)&&v.length&&v.length%2==0&&v.length<=2*m,"uniform "+d,e.commandStr),s="2i";break;case Mo:case Io:re.command(ur(v)&&v.length&&v.length%3==0&&v.length<=3*m,"uniform "+d,e.commandStr),s="3i";break;case Po:case ko:re.command(ur(v)&&v.length&&v.length%4==0&&v.length<=4*m,"uniform "+d,e.commandStr),s="4i"}m>1?(s+="v",v=e.global.def("["+Array.prototype.slice.call(v)+"]")):v=ur(v)?Array.prototype.slice.call(v):v,t(c,".uniform",s,"(",x,",",v,");")}continue}_=g.append(e,t)}else{if(!a(hs))continue;_=t.def(l.uniforms,"[",r.id(d),"]")}f===Ro?(re(!Array.isArray(_),"must specify a scalar prop for textures"),t("if(",_,"&&",_,'._reglType==="framebuffer"){',_,"=",_,".color[0];","}")):f===Fo&&(re(!Array.isArray(_),"must specify a scalar prop for cube maps"),t("if(",_,"&&",_,'._reglType==="framebufferCube"){',_,"=",_,".color[0];","}")),re.optional((function(){function r(r,i){e.assert(t,r,'bad data or missing for uniform "'+d+'".  '+i)}function i(e,t){1===t&&re(!Array.isArray(_),"must not specify an array type for uniform"),r("Array.isArray("+_+") && typeof "+_+'[0]===" '+e+'" || typeof '+_+'==="'+e+'"',"invalid type, expected "+e)}function n(t,i,n){Array.isArray(_)?re(_.length&&_.length%t==0&&_.length<=t*n,"must have length of "+(1===n?"":"n * ")+t):r(l.isArrayLike+"("+_+")&&"+_+".length && "+_+".length % "+t+" === 0 && "+_+".length<="+t*n,"invalid vector, should have length of "+(1===n?"":"n * ")+t,e.commandStr)}function a(t){re(!Array.isArray(_),"must not specify a value type"),r("typeof "+_+'==="function"&&'+_+'._reglType==="texture'+(t===co?"2d":"Cube")+'"',"invalid texture type",e.commandStr)}switch(f){case So:i("number",m);break;case Ao:n(2,"number",m);break;case Io:n(3,"number",m);break;case ko:n(4,"number",m);break;case bo:i("number",m);break;case wo:n(2,"number",m);break;case To:n(3,"number",m);break;case Eo:n(4,"number",m);break;case Co:i("boolean",m);break;case zo:n(2,"boolean",m);break;case Mo:n(3,"boolean",m);break;case Po:n(4,"boolean",m);break;case Do:n(4,"number",m);break;case Lo:n(9,"number",m);break;case Bo:n(16,"number",m);break;case Ro:a(co);break;case Fo:a(uo)}}));var E=1;switch(f){case Ro:case Fo:var S=t.def(_,"._texture");t(c,".uniform1i(",x,",",S,".bind());"),t.exit(S,".unbind();");continue;case So:case Co:s="1i";break;case Ao:case zo:s="2i",E=2;break;case Io:case Mo:s="3i",E=3;break;case ko:case Po:s="4i",E=4;break;case bo:s="1f";break;case wo:s="2f",E=2;break;case To:s="3f",E=3;break;case Eo:s="4f",E=4;break;case Do:s="Matrix2fv";break;case Lo:s="Matrix3fv";break;case Bo:s="Matrix4fv"}if(-1===s.indexOf("Matrix")&&m>1&&(s+="v",E=1),"M"===s.charAt(0)){t(c,".uniform",s,"(",x,",");var A=Math.pow(f-Do+2,2),I=e.global.def("new Float32Array(",A,")");Array.isArray(_)?t("false,(",Ae(A,(function(e){return I+"["+e+"]="+_[e]})),",",I,")"):t("false,(Array.isArray(",_,")||",_," instanceof Float32Array)?",_,":(",Ae(A,(function(e){return I+"["+e+"]="+_+"["+e+"]"})),",",I,")"),t(");")}else if(E>1){for(var k=[],C=[],z=0;z<E;++z)Array.isArray(_)?C.push(_[z]):C.push(t.def(_+"["+z+"]")),o&&k.push(t.def());o&&t("if(!",e.batchId,"||",k.map((function(e,t){return e+"!=="+C[t]})).join("||"),"){",k.map((function(e,t){return e+"="+C[t]+";"})).join("")),t(c,".uniform",s,"(",x,",",C.join(","),");"),o&&t("}")}else{if(re(!Array.isArray(_),"uniform value must not be an array"),o){var M=t.def();t("if(!",e.batchId,"||",M,"!==",_,"){",M,"=",_,";")}t(c,".uniform",s,"(",x,",",_,");"),o&&t("}")}}}function J(e,t,r,i){var n=e.shared,a=n.gl,o=n.draw,s=i.draw;function l(){var l,c=s.elements,u=t;return c?((c.contextDep&&i.contextDynamic||c.propDep)&&(u=r),l=c.append(e,u),s.elementsActive&&u("if("+l+")"+a+".bindBuffer("+lo+","+l+".buffer.buffer);")):(l=u.def(),u(l,"=",o,".",Ga,";","if(",l,"){",a,".bindBuffer(",lo,",",l,".buffer.buffer);}","else if(",n.vao,".currentVAO){",l,"=",e.shared.elements+".getElements("+n.vao,".currentVAO.elements);",v?"":"if("+l+")"+a+".bindBuffer("+lo+","+l+".buffer.buffer);","}")),l}function c(){var n,a=s.count,l=t;return a?((a.contextDep&&i.contextDynamic||a.propDep)&&(l=r),n=a.append(e,l),re.optional((function(){a.MISSING&&e.assert(t,"false","missing vertex count"),a.DYNAMIC&&e.assert(l,n+">=0","missing vertex count")}))):(n=l.def(o,".",Xa),re.optional((function(){e.assert(l,n+">=0","missing vertex count")}))),n}var u=l();function h(n){var a=s[n];return a?a.contextDep&&i.contextDynamic||a.propDep?a.append(e,r):a.append(e,t):t.def(o,".",n)}var p,d,f=h(Za),m=h(Wa),g=c();if("number"==typeof g){if(0===g)return}else r("if(",g,"){"),r.exit("}");_&&(p=h(Ha),d=e.instancing);var y=u+".type",x=s.elements&&ls(s.elements)&&!s.vaoActive;function b(){function e(){r(d,".drawElementsInstancedANGLE(",[f,g,y,m+"<<(("+y+"-"+na+")>>1)",p],");")}function t(){r(d,".drawArraysInstancedANGLE(",[f,m,g,p],");")}u&&"null"!==u?x?e():(r("if(",u,"){"),e(),r("}else{"),t(),r("}")):t()}function w(){function e(){r(a+".drawElements("+[f,g,y,m+"<<(("+y+"-"+na+")>>1)"]+");")}function t(){r(a+".drawArrays("+[f,m,g]+");")}u&&"null"!==u?x?e():(r("if(",u,"){"),e(),r("}else{"),t(),r("}")):t()}_&&("number"!=typeof p||p>=0)?"string"==typeof p?(r("if(",p,">0){"),b(),r("}else if(",p,"<0){"),w(),r("}")):b():w()}function Q(e,t,r,i,n){var a=P(),o=a.proc("body",n);return re.optional((function(){a.commandStr=t.commandStr,a.command=a.link(t.commandStr)})),_&&(a.instancing=o.def(a.shared.extensions,".angle_instanced_arrays")),e(a,o,r,i),a.compile().body}function ee(e,t,r,i){W(e,t),r.useVAO?r.drawVAO?t(e.shared.vao,".setVAO(",r.drawVAO.append(e,t),");"):t(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(t(e.shared.vao,".setVAO(null);"),K(e,t,r,i.attributes,(function(){return!0}))),Y(e,t,r,i.uniforms,(function(){return!0}),!1),J(e,t,t,r)}function te(e,t){var r=e.proc("draw",1);W(e,r),q(e,r,t.context),G(e,r,t.framebuffer),Z(e,r,t),X(e,r,t.state),H(e,r,t,!1,!0);var i=t.shader.progVar.append(e,r);if(r(e.shared.gl,".useProgram(",i,".program);"),t.shader.program)ee(e,r,t,t.shader.program);else{r(e.shared.vao,".setVAO(null);");var n=e.global.def("{}"),a=r.def(i,".id"),o=r.def(n,"[",a,"]");r(e.cond(o).then(o,".call(this,a0);").else(o,"=",n,"[",a,"]=",e.link((function(r){return Q(ee,e,t,r,1)})),"(",i,");",o,".call(this,a0);"))}Object.keys(t.state).length>0&&r(e.shared.current,".dirty=true;"),e.shared.vao&&r(e.shared.vao,".setVAO(null);")}function ie(e,t,r,i){function n(){return!0}e.batchId="a1",W(e,t),K(e,t,r,i.attributes,n),Y(e,t,r,i.uniforms,n,!1),J(e,t,t,r)}function ne(e,t,r,i){W(e,t);var n=r.contextDep,a=t.def(),o="a0",s="a1",l=t.def();e.shared.props=l,e.batchId=a;var c=e.scope(),u=e.scope();function h(e){return e.contextDep&&n||e.propDep}function p(e){return!h(e)}if(t(c.entry,"for(",a,"=0;",a,"<",s,";++",a,"){",l,"=",o,"[",a,"];",u,"}",c.exit),r.needsContext&&q(e,u,r.context),r.needsFramebuffer&&G(e,u,r.framebuffer),X(e,u,r.state,h),r.profile&&h(r.profile)&&H(e,u,r,!1,!0),i)r.useVAO?r.drawVAO?h(r.drawVAO)?u(e.shared.vao,".setVAO(",r.drawVAO.append(e,u),");"):c(e.shared.vao,".setVAO(",r.drawVAO.append(e,c),");"):c(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(c(e.shared.vao,".setVAO(null);"),K(e,c,r,i.attributes,p),K(e,u,r,i.attributes,h)),Y(e,c,r,i.uniforms,p,!1),Y(e,u,r,i.uniforms,h,!0),J(e,c,u,r);else{var d=e.global.def("{}"),f=r.shader.progVar.append(e,u),m=u.def(f,".id"),g=u.def(d,"[",m,"]");u(e.shared.gl,".useProgram(",f,".program);","if(!",g,"){",g,"=",d,"[",m,"]=",e.link((function(t){return Q(ie,e,r,t,2)})),"(",f,");}",g,".call(this,a0[",a,"],",a,");")}}function ae(e,t){var r=e.proc("batch",2);e.batchId="0",W(e,r);var i=!1,n=!0;Object.keys(t.context).forEach((function(e){i=i||t.context[e].propDep})),i||(q(e,r,t.context),n=!1);var a=t.framebuffer,o=!1;function s(e){return e.contextDep&&i||e.propDep}a?(a.propDep?i=o=!0:a.contextDep&&i&&(o=!0),o||G(e,r,a)):G(e,r,null),t.state.viewport&&t.state.viewport.propDep&&(i=!0),Z(e,r,t),X(e,r,t.state,(function(e){return!s(e)})),t.profile&&s(t.profile)||H(e,r,t,!1,"a1"),t.contextDep=i,t.needsContext=n,t.needsFramebuffer=o;var l=t.shader.progVar;if(l.contextDep&&i||l.propDep)ne(e,r,t,null);else{var c=l.append(e,r);if(r(e.shared.gl,".useProgram(",c,".program);"),t.shader.program)ne(e,r,t,t.shader.program);else{r(e.shared.vao,".setVAO(null);");var u=e.global.def("{}"),h=r.def(c,".id"),p=r.def(u,"[",h,"]");r(e.cond(p).then(p,".call(this,a0,a1);").else(p,"=",u,"[",h,"]=",e.link((function(r){return Q(ne,e,t,r,2)})),"(",c,");",p,".call(this,a0,a1);"))}}Object.keys(t.state).length>0&&r(e.shared.current,".dirty=true;"),e.shared.vao&&r(e.shared.vao,".setVAO(null);")}function oe(e,t){var i=e.proc("scope",3);e.batchId="a2";var n=e.shared,a=n.current;function o(r){var a=t.shader[r];a&&i.set(n.shader,"."+r,a.append(e,i))}q(e,i,t.context),t.framebuffer&&t.framebuffer.append(e,i),os(Object.keys(t.state)).forEach((function(r){var a=t.state[r].append(e,i);ur(a)?a.forEach((function(t,n){i.set(e.next[r],"["+n+"]",t)})):i.set(n.next,"."+r,a)})),H(e,i,t,!0,!0),[Ga,Wa,Xa,Ha,Za].forEach((function(r){var a=t.draw[r];a&&i.set(n.draw,"."+r,""+a.append(e,i))})),Object.keys(t.uniforms).forEach((function(a){var o=t.uniforms[a].append(e,i);Array.isArray(o)&&(o="["+o.join()+"]"),i.set(n.uniforms,"["+r.id(a)+"]",o)})),Object.keys(t.attributes).forEach((function(r){var n=t.attributes[r].append(e,i),a=e.scopeAttrib(r);Object.keys(new g).forEach((function(e){i.set(a,"."+e,n[e])}))})),t.scopeVAO&&i.set(n.vao,".targetVAO",t.scopeVAO.append(e,i)),o(ja),o(qa),Object.keys(t.state).length>0&&(i(a,".dirty=true;"),i.exit(a,".dirty=true;")),i("a1(",e.shared.context,",a0,",e.batchId,");")}function se(e){if("object"==typeof e&&!ur(e)){for(var t=Object.keys(e),r=0;r<t.length;++r)if(fe.isDynamic(e[t[r]]))return!0;return!1}}function le(e,t,r){var i=t.static[r];if(i&&se(i)){var n=e.global,a=Object.keys(i),o=!1,s=!1,l=!1,c=e.global.def("{}");a.forEach((function(t){var r=i[t];if(fe.isDynamic(r)){"function"==typeof r&&(r=i[t]=fe.unbox(r));var a=us(r,null);o=o||a.thisDep,l=l||a.propDep,s=s||a.contextDep}else{switch(n(c,".",t,"="),typeof r){case"number":n(r);break;case"string":n('"',r,'"');break;case"object":Array.isArray(r)&&n("[",r.join(),"]");break;default:n(e.link(r))}n(";")}})),t.dynamic[r]=new fe.DynamicVariable(ha,{thisDep:o,contextDep:s,propDep:l,ref:c,append:u}),delete t.static[r]}function u(e,t){a.forEach((function(r){var n=i[r];if(fe.isDynamic(n)){var a=e.invoke(t,n);t(c,".",r,"=",a,";")}}))}}function ce(e,r,i,n,a){var o=P();o.stats=o.link(a),Object.keys(r.static).forEach((function(e){le(o,r,e)})),oo.forEach((function(t){le(o,e,t)}));var s=j(e,r,i,n,o);return te(o,s),oe(o,s),ae(o,s),t(o.compile(),{destroy:function(){s.shader.program.destroy()}})}return{next:w,current:b,procs:function(){var e=P(),t=e.proc("poll"),r=e.proc("refresh"),a=e.block();t(a),r(a);var o,s=e.shared,l=s.gl,c=s.next,u=s.current;a(u,".dirty=false;"),G(e,t),G(e,r,null,!0),_&&(o=e.link(_)),i.oes_vertex_array_object&&r(e.link(i.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var h=0;h<n.maxAttributes;++h){var p=r.def(s.attributes,"[",h,"]"),d=e.cond(p,".buffer");d.then(l,".enableVertexAttribArray(",h,");",l,".bindBuffer(",so,",",p,".buffer.buffer);",l,".vertexAttribPointer(",h,",",p,".size,",p,".type,",p,".normalized,",p,".stride,",p,".offset);").else(l,".disableVertexAttribArray(",h,");",l,".vertexAttrib4f(",h,",",p,".x,",p,".y,",p,".z,",p,".w);",p,".buffer=null;"),r(d),_&&r(o,".vertexAttribDivisorANGLE(",h,",",p,".divisor);")}return r(e.shared.vao,".currentVAO=null;",e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"),Object.keys(E).forEach((function(i){var n=E[i],o=a.def(c,".",i),s=e.block();s("if(",o,"){",l,".enable(",n,")}else{",l,".disable(",n,")}",u,".",i,"=",o,";"),r(s),t("if(",o,"!==",u,".",i,"){",s,"}")})),Object.keys(S).forEach((function(i){var n,o,s=S[i],h=b[i],p=e.block();if(p(l,".",s,"("),ur(h)){var d=h.length;n=e.global.def(c,".",i),o=e.global.def(u,".",i),p(Ae(d,(function(e){return n+"["+e+"]"})),");",Ae(d,(function(e){return o+"["+e+"]="+n+"["+e+"];"})).join("")),t("if(",Ae(d,(function(e){return n+"["+e+"]!=="+o+"["+e+"]"})).join("||"),"){",p,"}")}else n=a.def(c,".",i),o=a.def(u,".",i),p(n,");",u,".",i,"=",n,";"),t("if(",n,"!==",o,"){",p,"}");r(p)})),e.compile()}(),compile:ce}}function ds(){return{vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0}}var fs=34918,ms=34919,gs=35007,ys=function(e,t){if(!t.ext_disjoint_timer_query)return null;var r=[];function i(){return r.pop()||t.ext_disjoint_timer_query.createQueryEXT()}function n(e){r.push(e)}var a=[];function o(e){var r=i();t.ext_disjoint_timer_query.beginQueryEXT(gs,r),a.push(r),d(a.length-1,a.length,e)}function s(){t.ext_disjoint_timer_query.endQueryEXT(gs)}function l(){this.startQueryIndex=-1,this.endQueryIndex=-1,this.sum=0,this.stats=null}var c=[];function u(){return c.pop()||new l}function h(e){c.push(e)}var p=[];function d(e,t,r){var i=u();i.startQueryIndex=e,i.endQueryIndex=t,i.sum=0,i.stats=r,p.push(i)}var f=[],m=[];function g(){var e,r,i=a.length;if(0!==i){m.length=Math.max(m.length,i+1),f.length=Math.max(f.length,i+1),f[0]=0,m[0]=0;var o=0;for(e=0,r=0;r<a.length;++r){var s=a[r];t.ext_disjoint_timer_query.getQueryObjectEXT(s,ms)?(o+=t.ext_disjoint_timer_query.getQueryObjectEXT(s,fs),n(s)):a[e++]=s,f[r+1]=o,m[r+1]=e}for(a.length=e,e=0,r=0;r<p.length;++r){var l=p[r],c=l.startQueryIndex,u=l.endQueryIndex;l.sum+=f[u]-f[c];var d=m[c],g=m[u];g===d?(l.stats.gpuTime+=l.sum/1e6,h(l)):(l.startQueryIndex=d,l.endQueryIndex=g,p[e++]=l)}p.length=e}}return{beginQuery:o,endQuery:s,pushScopeStats:d,update:g,getNumPendingQueries:function(){return a.length},clear:function(){r.push.apply(r,a);for(var e=0;e<r.length;e++)t.ext_disjoint_timer_query.deleteQueryEXT(r[e]);a.length=0,r.length=0},restore:function(){a.length=0,r.length=0}}},_s=16384,xs=256,vs=1024,bs=34962,ws="webglcontextlost",Ts="webglcontextrestored",Es=1,Ss=2,As=3;function Is(e,t){for(var r=0;r<e.length;++r)if(e[r]===t)return r;return-1}function ks(e){var r=Ee(e);if(!r)return null;var i=r.gl,n=i.getContextAttributes(),a=i.isContextLost(),o=Se(i,r);if(!o)return null;var s=ye(),l=ds(),c=o.extensions,u=ys(i,c),h=ge(),p=i.drawingBufferWidth,d=i.drawingBufferHeight,f={tick:0,time:0,viewportWidth:p,viewportHeight:d,framebufferWidth:p,framebufferHeight:d,drawingBufferWidth:p,drawingBufferHeight:d,pixelRatio:r.pixelRatio},m={},g={elements:null,primitive:4,count:-1,offset:0,instances:-1},y=wt(i,c),_=Gt(i,l,r,b),x=ar(i,c,_,l),v=jn(i,c,y,l,_,x,g);function b(e){return v.destroyBuffer(e)}var w=Wn(i,s,l,r),T=Wi(i,c,y,(function(){A.procs.poll()}),f,l,r),E=cn(i,c,y,l,r),S=Fn(i,c,y,T,E,l),A=ps(i,s,c,y,_,x,T,S,m,v,w,g,f,u,r),I=Qn(i,S,A.procs.poll,f,n,c,y),k=A.next,C=i.canvas,z=[],M=[],P=[],D=[r.onDestroy],L=null;function B(){if(0===z.length)return u&&u.update(),void(L=null);L=me.next(B),X();for(var e=z.length-1;e>=0;--e){var t=z[e];t&&t(f,null,0)}i.flush(),u&&u.update()}function R(){!L&&z.length>0&&(L=me.next(B))}function F(){L&&(me.cancel(B),L=null)}function O(e){e.preventDefault(),a=!0,F(),M.forEach((function(e){e()}))}function U(e){i.getError(),a=!1,o.restore(),w.restore(),_.restore(),T.restore(),E.restore(),S.restore(),v.restore(),u&&u.restore(),A.procs.refresh(),R(),P.forEach((function(e){e()}))}function V(){z.length=0,F(),C&&(C.removeEventListener(ws,O),C.removeEventListener(Ts,U)),w.clear(),S.clear(),E.clear(),v.clear(),T.clear(),x.clear(),_.clear(),u&&u.clear(),D.forEach((function(e){e()}))}function $(e){function r(e){var r=t({},e);function i(e){if(e in r){var t=r[e];delete r[e],Object.keys(t).forEach((function(i){r[e+"."+i]=t[i]}))}}return delete r.uniforms,delete r.attributes,delete r.context,delete r.vao,"stencil"in r&&r.stencil.op&&(r.stencil.opBack=r.stencil.opFront=r.stencil.op,delete r.stencil.op),i("blend"),i("depth"),i("cull"),i("stencil"),i("polygonOffset"),i("scissor"),i("sample"),"vao"in e&&(r.vao=e.vao),r}function i(e,t){var r={},i={};return Object.keys(e).forEach((function(n){var a=e[n];if(fe.isDynamic(a))i[n]=fe.unbox(a,n);else{if(t&&Array.isArray(a))for(var o=0;o<a.length;++o)if(fe.isDynamic(a[o]))return void(i[n]=fe.unbox(a,n));r[n]=a}})),{dynamic:i,static:r}}re(!!e,"invalid args to regl({...})"),re.type(e,"object","invalid args to regl({...})");var n=i(e.context||{},!0),o=i(e.uniforms||{},!0),s=i(e.attributes||{},!1),l=i(r(e),!1),c={gpuTime:0,cpuTime:0,count:0},u=A.compile(l,s,o,n,c),h=u.draw,p=u.batch,d=u.scope,f=[];function m(e){for(;f.length<e;)f.push(null);return f}function g(e,t){var r;if(a&&re.raise("context lost"),"function"==typeof e)return d.call(this,null,e,0);if("function"==typeof t)if("number"==typeof e)for(r=0;r<e;++r)d.call(this,null,t,r);else{if(!Array.isArray(e))return d.call(this,e,t,0);for(r=0;r<e.length;++r)d.call(this,e[r],t,r)}else if("number"==typeof e){if(e>0)return p.call(this,m(0|e),0|e)}else{if(!Array.isArray(e))return h.call(this,e);if(e.length)return p.call(this,e,e.length)}}return t(g,{stats:c,destroy:function(){u.destroy()}})}C&&(C.addEventListener(ws,O,!1),C.addEventListener(Ts,U,!1));var N=S.setFBO=$({framebuffer:fe.define.call(null,Es,"framebuffer")});function j(e,t){var r=0;A.procs.poll();var n=t.color;n&&(i.clearColor(+n[0]||0,+n[1]||0,+n[2]||0,+n[3]||0),r|=_s),"depth"in t&&(i.clearDepth(+t.depth),r|=xs),"stencil"in t&&(i.clearStencil(0|t.stencil),r|=vs),re(!!r,"called regl.clear with no buffer specified"),i.clear(r)}function q(e){if(re("object"==typeof e&&e,"regl.clear() takes an object as input"),"framebuffer"in e)if(e.framebuffer&&"framebufferCube"===e.framebuffer_reglType)for(var r=0;r<6;++r)N(t({framebuffer:e.framebuffer.faces[r]},e),j);else N(e,j);else j(null,e)}function G(e){function t(){var t=Is(z,e);function r(){var e=Is(z,r);z[e]=z[z.length-1],z.length-=1,z.length<=0&&F()}re(t>=0,"cannot cancel a frame twice"),z[t]=r}return re.type(e,"function","regl.frame() callback must be a function"),z.push(e),R(),{cancel:t}}function Z(){var e=k.viewport,t=k.scissor_box;e[0]=e[1]=t[0]=t[1]=0,f.viewportWidth=f.framebufferWidth=f.drawingBufferWidth=e[2]=t[2]=i.drawingBufferWidth,f.viewportHeight=f.framebufferHeight=f.drawingBufferHeight=e[3]=t[3]=i.drawingBufferHeight}function X(){f.tick+=1,f.time=H(),Z(),A.procs.poll()}function W(){T.refresh(),Z(),A.procs.refresh(),u&&u.update()}function H(){return(ge()-h)/1e3}function K(e,t){var r;switch(re.type(t,"function","listener callback must be a function"),e){case"frame":return G(t);case"lost":r=M;break;case"restore":r=P;break;case"destroy":r=D;break;default:re.raise("invalid event, must be one of frame,lost,restore,destroy")}return r.push(t),{cancel:function(){for(var e=0;e<r.length;++e)if(r[e]===t)return r[e]=r[r.length-1],void r.pop()}}}W();var Y=t($,{clear:q,prop:fe.define.bind(null,Es),context:fe.define.bind(null,Ss),this:fe.define.bind(null,As),draw:$({}),buffer:function(e){return _.create(e,bs,!1,!1)},elements:function(e){return x.create(e,!1)},texture:T.create2D,cube:T.createCube,renderbuffer:E.create,framebuffer:S.create,framebufferCube:S.createCube,vao:v.createVAO,attributes:n,frame:G,on:K,limits:y,hasExtension:function(e){return y.extensions.indexOf(e.toLowerCase())>=0},read:I,destroy:V,_gl:i,_refresh:W,poll:function(){X(),u&&u.update()},now:H,stats:l});return r.onDone(null,Y),Y}return ks}()})),ce=/\/\*(?!\/)(.|[\r\n]|\n)+?\*\/\n?\n?/gm,ue=/\/\*(?!(\*?\/|\*?\!))(.|[\r\n]|\n)+?\*\/\n?\n?/gm,he=/(^|[^\S\n])(?:\/\/)([\s\S]+?)$/gm,pe=/(^|[^\S\n])(?:\/\/[^!])([\s\S]+?)$/gm;function de(e,t){return e?de.block(de.line(e,t),t):""}de.block=function(e,t){var r=ce;return(t=t||{}).safe&&(r=ue),e?e.replace(r,""):""},de.line=function(e,t){var r=he;return(t=t||{}).safe&&(r=pe),e?e.replace(r,""):""};var fe=de;var me=function(e,t,r){return e*(1-r)+t*r};var ge=function(){var e=[].map.call(arguments,(function(e){return e.trim()})).filter((function(e){return e.length})).join("-");return e.length?1===e.length?e.toLowerCase():/[_.\- ]+/.test(e)?(e=function(e){for(var t=!1,r=0;r<e.length;r++){var i=e.charAt(r);t&&/[a-zA-Z]/.test(i)&&i.toUpperCase()===i?(e=e.substr(0,r)+"-"+e.substr(r),t=!1,r++):t=i.toLowerCase()===i}return e}(e),e.replace(/^[_.\- ]+/,"").toLowerCase().replace(/[_.\- ]+(\w|$)/g,(function(e,t){return t.toUpperCase()}))):e===e.toUpperCase()?e.toLowerCase():e[0]!==e[0].toLowerCase()?e[0].toLowerCase()+e.slice(1):e:""};var ye=function(e){var t=e*e;return e<4/11?7.5625*t:e<8/11?9.075*t-9.9*e+3.4:e<.9?4356/361*t-35442/1805*e+16061/1805:10.8*e*e-20.52*e+10.72};var _e={backInOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)},backIn:function(e){var t=1.70158;return e*e*((t+1)*e-t)},backOut:function(e){var t=1.70158;return--e*e*((t+1)*e+t)+1},bounceInOut:function(e){return e<.5?.5*(1-ye(1-2*e)):.5*ye(2*e-1)+.5},bounceIn:function(e){return 1-ye(1-e)},bounceOut:ye,circInOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)},circIn:function(e){return 1-Math.sqrt(1-e*e)},circOut:function(e){return Math.sqrt(1- --e*e)},cubicInOut:function(e){return e<.5?4*e*e*e:.5*Math.pow(2*e-2,3)+1},cubicIn:function(e){return e*e*e},cubicOut:function(e){var t=e-1;return t*t*t+1},elasticInOut:function(e){return e<.5?.5*Math.sin(13*Math.PI/2*2*e)*Math.pow(2,10*(2*e-1)):.5*Math.sin(-13*Math.PI/2*(2*e-1+1))*Math.pow(2,-10*(2*e-1))+1},elasticIn:function(e){return Math.sin(13*e*Math.PI/2)*Math.pow(2,10*(e-1))},elasticOut:function(e){return Math.sin(-13*(e+1)*Math.PI/2)*Math.pow(2,-10*e)+1},expoInOut:function(e){return 0===e||1===e?e:e<.5?.5*Math.pow(2,20*e-10):-.5*Math.pow(2,10-20*e)+1},expoIn:function(e){return 0===e?e:Math.pow(2,10*(e-1))},expoOut:function(e){return 1===e?e:1-Math.pow(2,-10*e)},linear:function(e){return e},quadInOut:function(e){return(e/=.5)<1?.5*e*e:-.5*(--e*(e-2)-1)},quadIn:function(e){return e*e},quadOut:function(e){return-e*(e-2)},quartInOut:function(e){return e<.5?8*Math.pow(e,4):-8*Math.pow(e-1,4)+1},quartIn:function(e){return Math.pow(e,4)},quartOut:function(e){return Math.pow(e-1,3)*(1-e)+1},quintInOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)},quintIn:function(e){return e*e*e*e*e},quintOut:function(e){return--e*e*e*e*e+1},sineInOut:function(e){return-.5*(Math.cos(Math.PI*e)-1)},sineIn:function(e){var t=Math.cos(e*Math.PI*.5);return Math.abs(t)<1e-14?1:1-t},sineOut:function(e){return Math.sin(e*Math.PI/2)}},xe=[["quad-","quadratic-"],["circ-","circular-"],["expo-","exponential-"],["quart-","quartic-"],["quint-","quintic-"]],ve=function(e){return _e[ge(e)]},be=function(e){return"#define GLSLIFY 1\n#ifndef PI\n#define PI 3.141592653589793\n#endif\n\nfloat backOut_1(float t) {\n  float f = t < 0.5\n    ? 2.0 * t\n    : 1.0 - (2.0 * t - 1.0);\n\n  float g = pow(f, 3.0) - f * sin(f * PI);\n\n  return t < 0.5\n    ? 0.5 * g\n    : 0.5 * (1.0 - g) + 0.5;\n}\n\n#ifndef PI\n#define PI 3.141592653589793\n#endif\n\nfloat backIn(float t) {\n  return pow(t, 3.0) - t * sin(t * PI);\n}\n\n#ifndef PI\n#define PI 3.141592653589793\n#endif\n\nfloat backOut_0(float t) {\n  float f = 1.0 - t;\n  return 1.0 - (pow(f, 3.0) - f * sin(f * PI));\n}\n\n#ifndef PI\n#define PI 3.141592653589793\n#endif\n\nfloat bounceOut(float t) {\n  const float a = 4.0 / 11.0;\n  const float b = 8.0 / 11.0;\n  const float c = 9.0 / 10.0;\n\n  const float ca = 4356.0 / 361.0;\n  const float cb = 35442.0 / 1805.0;\n  const float cc = 16061.0 / 1805.0;\n\n  float t2 = t * t;\n\n  return t < a\n    ? 7.5625 * t2\n    : t < b\n      ? 9.075 * t2 - 9.9 * t + 3.4\n      : t < c\n        ? ca * t2 - cb * t + cc\n        : 10.8 * t * t - 20.52 * t + 10.72;\n}\n\nfloat bounceInOut(float t) {\n  return t < 0.5\n    ? 0.5 * (1.0 - bounceOut(1.0 - t * 2.0))\n    : 0.5 * bounceOut(t * 2.0 - 1.0) + 0.5;\n}\n\nfloat bounceIn(float t) {\n  return 1.0 - bounceOut(1.0 - t);\n}\n\nfloat circularInOut(float t) {\n  return t < 0.5\n    ? 0.5 * (1.0 - sqrt(1.0 - 4.0 * t * t))\n    : 0.5 * (sqrt((3.0 - 2.0 * t) * (2.0 * t - 1.0)) + 1.0);\n}\n\nfloat circularIn(float t) {\n  return 1.0 - sqrt(1.0 - t * t);\n}\n\nfloat circularOut(float t) {\n  return sqrt((2.0 - t) * t);\n}\n\nfloat cubicInOut(float t) {\n  return t < 0.5\n    ? 4.0 * t * t * t\n    : 0.5 * pow(2.0 * t - 2.0, 3.0) + 1.0;\n}\n\nfloat cubicIn(float t) {\n  return t * t * t;\n}\n\nfloat cubicOut(float t) {\n  float f = t - 1.0;\n  return f * f * f + 1.0;\n}\n\n#ifndef HALF_PI\n#define HALF_PI 1.5707963267948966\n#endif\n\nfloat elasticInOut(float t) {\n  return t < 0.5\n    ? 0.5 * sin(+13.0 * HALF_PI * 2.0 * t) * pow(2.0, 10.0 * (2.0 * t - 1.0))\n    : 0.5 * sin(-13.0 * HALF_PI * ((2.0 * t - 1.0) + 1.0)) * pow(2.0, -10.0 * (2.0 * t - 1.0)) + 1.0;\n}\n\n#ifndef HALF_PI\n#define HALF_PI 1.5707963267948966\n#endif\n\nfloat elasticIn(float t) {\n  return sin(13.0 * t * HALF_PI) * pow(2.0, 10.0 * (t - 1.0));\n}\n\n#ifndef HALF_PI\n#define HALF_PI 1.5707963267948966\n#endif\n\nfloat elasticOut(float t) {\n  return sin(-13.0 * (t + 1.0) * HALF_PI) * pow(2.0, -10.0 * t) + 1.0;\n}\n\nfloat exponentialInOut(float t) {\n  return t == 0.0 || t == 1.0\n    ? t\n    : t < 0.5\n      ? +0.5 * pow(2.0, (20.0 * t) - 10.0)\n      : -0.5 * pow(2.0, 10.0 - (t * 20.0)) + 1.0;\n}\n\nfloat exponentialIn(float t) {\n  return t == 0.0 ? t : pow(2.0, 10.0 * (t - 1.0));\n}\n\nfloat exponentialOut(float t) {\n  return t == 1.0 ? t : 1.0 - pow(2.0, -10.0 * t);\n}\n\nfloat linear(float t) {\n  return t;\n}\n\nfloat quadraticInOut(float t) {\n  float p = 2.0 * t * t;\n  return t < 0.5 ? p : -p + (4.0 * t) - 1.0;\n}\n\nfloat quadraticIn(float t) {\n  return t * t;\n}\n\nfloat quadraticOut(float t) {\n  return -t * (t - 2.0);\n}\n\nfloat quarticInOut(float t) {\n  return t < 0.5\n    ? +8.0 * pow(t, 4.0)\n    : -8.0 * pow(t - 1.0, 4.0) + 1.0;\n}\n\nfloat quarticIn(float t) {\n  return pow(t, 4.0);\n}\n\nfloat quarticOut(float t) {\n  return pow(t - 1.0, 3.0) * (1.0 - t) + 1.0;\n}\n\nfloat qinticInOut(float t) {\n  return t < 0.5\n    ? +16.0 * pow(t, 5.0)\n    : -0.5 * pow(2.0 * t - 2.0, 5.0) + 1.0;\n}\n\nfloat qinticIn(float t) {\n  return pow(t, 5.0);\n}\n\nfloat qinticOut(float t) {\n  return 1.0 - (pow(t - 1.0, 5.0));\n}\n\n#ifndef PI\n#define PI 3.141592653589793\n#endif\n\nfloat sineInOut(float t) {\n  return -0.5 * (cos(PI * t) - 1.0);\n}\n\n#ifndef HALF_PI\n#define HALF_PI 1.5707963267948966\n#endif\n\nfloat sineIn(float t) {\n  return sin((t - 1.0) * HALF_PI) + 1.0;\n}\n\n#ifndef HALF_PI\n#define HALF_PI 1.5707963267948966\n#endif\n\nfloat sineOut(float t) {\n  return sin(t * HALF_PI);\n}"},we=function(e){return xe.forEach((function(t){e=e.replace(t[0],t[1])})),ge(e)},Te="_rtb",Ee=function(e,t){return Te+"_"+t+"_previous_"+e},Se=function(e,t){return Te+"_"+t+"_next_"+e},Ae=function(e,t){return Te+"_"+t+"_t_"+e},Ie=function(e,t,r,i){var n=we(i),a=be();t=fe(t);var o=Ee(e,r),s=Se(e,r),l=function(e,t){return Te+"_"+t+"_current_"+e}(e,r),c=Ae(e,r),u=new RegExp(";([^;]*"+e+"[^;]*;)"),h=t.match(u);if(!h||h.length<2)return t;var p=h[1],d=p.replace(e,o)+p.replace(e,s)+("\n"+p.replace(e,l).replace("attribute","").replace("uniform","").trim())+("\nuniform float "+c+";");if(t=t.replace(p,d),u=new RegExp("main\\s*\\(\\s*\\)\\s*{"),(h=t.match(u))&&h.length){var f=l+" = mix("+o+", "+s+", "+n+"("+c+"));";t=t.replace(h[0],h[0]+"\n  "+f)}return u=new RegExp("\\b"+e+"\\b","g"),t=a+"\n"+(t=t.replace(u,l))},ke=function(e,t){this.data=e,this.previousData=e,this.options=Object.assign({},{duration:750,ease:"quad-in-out"},t||{})},Ce=function(e){var t=function(t){if(t.uniforms=t.uniforms||{},t.attributes=t.attributes||{},t.vert=t.vert||"",t.frag=t.frag||"",!t.vert||!t.frag)throw new Error("Must provide vert and frag shaders!");var r={uniforms:[],attributes:[]},i={uniforms:{},attributes:{}},n={uniforms:{},attributes:{}},a={uniforms:{},attributes:{}},o={uniforms:{},attributes:{}},s={uniforms:{},attributes:{}},l=function(e){var t=a[this.type][this.key];if(t<1){var r=ve(this.options.ease)(t),n=this.previousData;this.previousData=this.data.map((function(e,t){return e.map((function(e,i){return me(n[t][i],e,r)}))}))}else this.previousData=this.data;this.data=e,i[this.type][this.key].previous({usage:"dynamic",data:this.previousData}),i[this.type][this.key].next({usage:"dynamic",data:e}),o[this.type][this.key]=!0},c=function(s){Object.keys(t[s]||{}).filter((function(e){return t[s][e]instanceof ke})).map((function(c){r[s].push(c);var u=t[s][c];u.type=s,u.key=c,u.update=l,n[s][c]=u,a[s][c]=1,o[s][c]=!1,i[s][c]={previous:e.buffer({usage:"dynamic",data:u.data}),next:e.buffer({usage:"dynamic",data:u.data})}}))};c("attributes"),c("uniforms");var u=function(e){r[e].forEach((function(r){var l=n[e][r],c=l.options.duration;t.vert=Ie(r,t.vert||"",e,l.options.ease),delete t.attributes[r],t[e][Ee(r,e)]=i[e][r].previous,t[e][Se(r,e)]=i[e][r].next,t.uniforms[Ae(r,e)]=function(t,i,n){o[e][r]&&(a[e][r]=0,s[e][r]=t.time);var l=s[e][r],u=a[e][r];return u<1&&(u=Math.min(1,1e3*(t.time-l)/c)),a[e][r]=u,o[e][r]=!1,u}}))};return u("attributes"),u("uniforms"),e(t)};return t.buffer=function(e,t){return new ke(e,t)},t},ze={},Me={};function Pe(e){return new Function("d","return {"+e.map((function(e,t){return JSON.stringify(e)+": d["+t+'] || ""'})).join(",")+"}")}function De(e){var t=Object.create(null),r=[];return e.forEach((function(e){for(var i in e)i in t||r.push(t[i]=i)})),r}function Le(e,t){var r=e+"",i=r.length;return i<t?new Array(t-i+1).join(0)+r:r}function Be(e){var t,r=e.getUTCHours(),i=e.getUTCMinutes(),n=e.getUTCSeconds(),a=e.getUTCMilliseconds();return isNaN(e)?"Invalid Date":((t=e.getUTCFullYear())<0?"-"+Le(-t,6):t>9999?"+"+Le(t,6):Le(t,4))+"-"+Le(e.getUTCMonth()+1,2)+"-"+Le(e.getUTCDate(),2)+(a?"T"+Le(r,2)+":"+Le(i,2)+":"+Le(n,2)+"."+Le(a,3)+"Z":n?"T"+Le(r,2)+":"+Le(i,2)+":"+Le(n,2)+"Z":i||r?"T"+Le(r,2)+":"+Le(i,2)+"Z":"")}var Re=function(e){var t=new RegExp('["'+e+"\n\r]"),r=e.charCodeAt(0);function i(e,t){var i,n=[],a=e.length,o=0,s=0,l=a<=0,c=!1;function u(){if(l)return Me;if(c)return c=!1,ze;var t,i,n=o;if(34===e.charCodeAt(n)){for(;o++<a&&34!==e.charCodeAt(o)||34===e.charCodeAt(++o););return(t=o)>=a?l=!0:10===(i=e.charCodeAt(o++))?c=!0:13===i&&(c=!0,10===e.charCodeAt(o)&&++o),e.slice(n+1,t-1).replace(/""/g,'"')}for(;o<a;){if(10===(i=e.charCodeAt(t=o++)))c=!0;else if(13===i)c=!0,10===e.charCodeAt(o)&&++o;else if(i!==r)continue;return e.slice(n,t)}return l=!0,e.slice(n,a)}for(10===e.charCodeAt(a-1)&&--a,13===e.charCodeAt(a-1)&&--a;(i=u())!==Me;){for(var h=[];i!==ze&&i!==Me;)h.push(i),i=u();t&&null==(h=t(h,s++))||n.push(h)}return n}function n(t,r){return t.map((function(t){return r.map((function(e){return o(t[e])})).join(e)}))}function a(t){return t.map(o).join(e)}function o(e){return null==e?"":e instanceof Date?Be(e):t.test(e+="")?'"'+e.replace(/"/g,'""')+'"':e}return{parse:function(e,t){var r,n,a=i(e,(function(e,i){if(r)return r(e,i-1);n=e,r=t?function(e,t){var r=Pe(e);return function(i,n){return t(r(i),n,e)}}(e,t):Pe(e)}));return a.columns=n||[],a},parseRows:i,format:function(t,r){return null==r&&(r=De(t)),[r.map(o).join(e)].concat(n(t,r)).join("\n")},formatBody:function(e,t){return null==t&&(t=De(e)),n(e,t).join("\n")},formatRows:function(e){return e.map(a).join("\n")},formatRow:a,formatValue:o}}(","),Fe=Re.parse;function Oe(e){for(var t in e){var r,i,n=e[t].trim();if(n)if("true"===n)n=!0;else if("false"===n)n=!1;else if("NaN"===n)n=NaN;else if(isNaN(r=+n)){if(!(i=n.match(/^([-+]\d{2})?\d{4}(-\d{2}(-\d{2})?)?(T\d{2}:\d{2}(:\d{2}(\.\d{3})?)?(Z|[-+]\d{2}:\d{2})?)?$/)))continue;Ue&&i[4]&&!i[7]&&(n=n.replace(/-/g,"/").replace(/T/," ")),n=new Date(n)}else n=r;else n=null;e[t]=n}return e}const Ue=new Date("2019-01-01T00:00").getHours()||new Date("2019-07-01T00:00").getHours();function Ve(e){return e}function $e(e,t){var r=t.id,i=t.bbox,n=null==t.properties?{}:t.properties,a=function(e,t){var r=function(e){if(null==e)return Ve;var t,r,i=e.scale[0],n=e.scale[1],a=e.translate[0],o=e.translate[1];return function(e,s){s||(t=r=0);var l=2,c=e.length,u=new Array(c);for(u[0]=(t+=e[0])*i+a,u[1]=(r+=e[1])*n+o;l<c;)u[l]=e[l],++l;return u}}(e.transform),i=e.arcs;function n(e,t){t.length&&t.pop();for(var n=i[e<0?~e:e],a=0,o=n.length;a<o;++a)t.push(r(n[a],a));e<0&&function(e,t){for(var r,i=e.length,n=i-t;n<--i;)r=e[n],e[n++]=e[i],e[i]=r}(t,o)}function a(e){return r(e)}function o(e){for(var t=[],r=0,i=e.length;r<i;++r)n(e[r],t);return t.length<2&&t.push(t[0]),t}function s(e){for(var t=o(e);t.length<4;)t.push(t[0]);return t}function l(e){return e.map(s)}function c(e){var t,r=e.type;switch(r){case"GeometryCollection":return{type:r,geometries:e.geometries.map(c)};case"Point":t=a(e.coordinates);break;case"MultiPoint":t=e.coordinates.map(a);break;case"LineString":t=o(e.arcs);break;case"MultiLineString":t=e.arcs.map(o);break;case"Polygon":t=l(e.arcs);break;case"MultiPolygon":t=e.arcs.map(l);break;default:return null}return{type:r,coordinates:t}}return c(t)}(e,t);return null==r&&null==i?{type:"Feature",properties:n,geometry:a}:null==i?{type:"Feature",id:r,properties:n,geometry:a}:{type:"Feature",id:r,bbox:i,properties:n,geometry:a}}var Ne=(e,t,r)=>new Promise(((i,n)=>{var a=e=>{try{s(r.next(e))}catch(e){n(e)}},o=e=>{try{s(r.throw(e))}catch(e){n(e)}},s=e=>e.done?i(e.value):Promise.resolve(e.value).then(a,o);s((r=r.apply(e,t)).next())})),je=Uint8Array,qe=Uint16Array,Ge=Int32Array,Ze=new je([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Xe=new je([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),We=new je([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),He=function(e,t){for(var r=new qe(31),i=0;i<31;++i)r[i]=t+=1<<e[i-1];var n=new Ge(r[30]);for(i=1;i<30;++i)for(var a=r[i];a<r[i+1];++a)n[a]=a-r[i]<<5|i;return{b:r,r:n}},Ke=He(Ze,2),Ye=Ke.b,Je=Ke.r;Ye[28]=258,Je[258]=28;var Qe,et=He(Xe,0).b,tt=new qe(32768);for(nt=0;nt<32768;++nt)Qe=(61680&(Qe=(52428&(Qe=(43690&nt)>>1|(21845&nt)<<1))>>2|(13107&Qe)<<2))>>4|(3855&Qe)<<4,tt[nt]=((65280&Qe)>>8|(255&Qe)<<8)>>1;var rt=function(e,t,r){for(var i=e.length,n=0,a=new qe(t);n<i;++n)e[n]&&++a[e[n]-1];var o,s=new qe(t);for(n=1;n<t;++n)s[n]=s[n-1]+a[n-1]<<1;if(r){o=new qe(1<<t);var l=15-t;for(n=0;n<i;++n)if(e[n])for(var c=n<<4|e[n],u=t-e[n],h=s[e[n]-1]++<<u,p=h|(1<<u)-1;h<=p;++h)o[tt[h]>>l]=c}else for(o=new qe(i),n=0;n<i;++n)e[n]&&(o[n]=tt[s[e[n]-1]++]>>15-e[n]);return o},it=new je(288);for(nt=0;nt<144;++nt)it[nt]=8;for(nt=144;nt<256;++nt)it[nt]=9;for(nt=256;nt<280;++nt)it[nt]=7;for(nt=280;nt<288;++nt)it[nt]=8;var nt,at=new je(32);for(nt=0;nt<32;++nt)at[nt]=5;var ot=rt(it,9,1),st=rt(at,5,1),lt=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},ct=function(e,t,r){var i=t/8|0;return(e[i]|e[i+1]<<8)>>(7&t)&r},ut=function(e,t){var r=t/8|0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>(7&t)},ht=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],pt=function(e,t,r){var i=new Error(t||ht[e]);if(i.code=e,Error.captureStackTrace&&Error.captureStackTrace(i,pt),!r)throw i;return i},dt=function(e,t,r,i){var n=e.length,a=i?i.length:0;if(!n||t.f&&!t.l)return r||new je(0);var o=!r||2!=t.i,s=t.i;r||(r=new je(3*n));var l=function(e){var t=r.length;if(e>t){var i=new je(Math.max(2*t,e));i.set(r),r=i}},c=t.f||0,u=t.p||0,h=t.b||0,p=t.l,d=t.d,f=t.m,m=t.n,g=8*n;do{if(!p){c=ct(e,u,1);var y=ct(e,u+1,3);if(u+=3,!y){var _=e[(C=4+((u+7)/8|0))-4]|e[C-3]<<8,x=C+_;if(x>n){s&&pt(0);break}o&&l(h+_),r.set(e.subarray(C,x),h),t.b=h+=_,t.p=u=8*x,t.f=c;continue}if(1==y)p=ot,d=st,f=9,m=5;else if(2==y){var v=ct(e,u,31)+257,b=ct(e,u+10,15)+4,w=v+ct(e,u+5,31)+1;u+=14;for(var T=new je(w),E=new je(19),S=0;S<b;++S)E[We[S]]=ct(e,u+3*S,7);u+=3*b;var A=lt(E),I=(1<<A)-1,k=rt(E,A,1);for(S=0;S<w;){var C,z=k[ct(e,u,I)];if(u+=15&z,(C=z>>4)<16)T[S++]=C;else{var M=0,P=0;for(16==C?(P=3+ct(e,u,3),u+=2,M=T[S-1]):17==C?(P=3+ct(e,u,7),u+=3):18==C&&(P=11+ct(e,u,127),u+=7);P--;)T[S++]=M}}var D=T.subarray(0,v),L=T.subarray(v);f=lt(D),m=lt(L),p=rt(D,f,1),d=rt(L,m,1)}else pt(1);if(u>g){s&&pt(0);break}}o&&l(h+131072);for(var B=(1<<f)-1,R=(1<<m)-1,F=u;;F=u){var O=(M=p[ut(e,u)&B])>>4;if((u+=15&M)>g){s&&pt(0);break}if(M||pt(2),O<256)r[h++]=O;else{if(256==O){F=u,p=null;break}var U=O-254;if(O>264){var V=Ze[S=O-257];U=ct(e,u,(1<<V)-1)+Ye[S],u+=V}var $=d[ut(e,u)&R],N=$>>4;$||pt(3),u+=15&$;L=et[N];if(N>3){V=Xe[N];L+=ut(e,u)&(1<<V)-1,u+=V}if(u>g){s&&pt(0);break}o&&l(h+131072);var j=h+U;if(h<L){var q=a-L,G=Math.min(L,j);for(q+h<0&&pt(3);h<G;++h)r[h]=i[q+h]}for(;h<j;h+=4)r[h]=r[h-L],r[h+1]=r[h+1-L],r[h+2]=r[h+2-L],r[h+3]=r[h+3-L];h=j}}t.l=p,t.p=F,t.b=h,t.f=c,p&&(c=1,t.m=f,t.d=d,t.n=m)}while(!c);return h==r.length?r:function(e,t,r){(null==t||t<0)&&(t=0),(null==r||r>e.length)&&(r=e.length);var i=new je(r-t);return i.set(e.subarray(t,r)),i}(r,0,h)},ft=new je(0),mt=function(e){31==e[0]&&139==e[1]&&8==e[2]||pt(6,"invalid gzip data");var t=e[3],r=10;4&t&&(r+=2+(e[10]|e[11]<<8));for(var i=(t>>3&1)+(t>>4&1);i>0;i-=!e[r++]);return r+(2&t)},gt=function(e){var t=e.length;return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0},yt=function(e,t){return(8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31)&&pt(6,"invalid zlib data"),(e[1]>>5&1)==+!t&&pt(6,"invalid zlib data: "+(32&e[1]?"need":"unexpected")+" dictionary"),2+(e[1]>>3&4)};function _t(e,t){return 31==e[0]&&139==e[1]&&8==e[2]?function(e,t){var r=mt(e);return r+8>e.length&&pt(6,"invalid gzip data"),dt(e.subarray(r,-8),{i:2},t&&t.out||new je(gt(e)),t&&t.dictionary)}(e,t):8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31?function(e,t){return dt(e,{i:2},t&&t.out,t&&t.dictionary)}(e,t):function(e,t){return dt(e.subarray(yt(e,t&&t.dictionary),-4),{i:2},t&&t.out,t&&t.dictionary)}(e,t)}var xt="undefined"!=typeof TextDecoder&&new TextDecoder;try{xt.decode(ft,{stream:!0}),1}catch(e){}var vt=(e,t)=>e*Math.pow(2,t),bt=(e,t)=>Math.floor(e/Math.pow(2,t)),wt=(e,t)=>vt(e.getUint16(t+1,!0),8)+e.getUint8(t),Tt=(e,t)=>vt(e.getUint32(t+2,!0),16)+e.getUint16(t,!0),Et=(e,t,r,i,n)=>{if(e!=i.getUint8(n))return e-i.getUint8(n);const a=wt(i,n+1);if(t!=a)return t-a;const o=wt(i,n+4);return r!=o?r-o:0},St=(e,t,r,i)=>{const n=At(e,t,r,i);return n?{z:t,x:r,y:i,offset:n[0],length:n[1],is_dir:!1}:null},At=(e,t,r,i)=>{let n=0,a=e.byteLength/17-1;for(;n<=a;){const o=a+n>>1,s=Et(t,r,i,e,17*o);if(s>0)n=o+1;else{if(!(s<0))return[Tt(e,17*o+7),e.getUint32(17*o+13,!0)];a=o-1}}return null},It=(e,t)=>e.is_dir&&!t.is_dir?1:!e.is_dir&&t.is_dir?-1:e.z!==t.z?e.z-t.z:e.x!==t.x?e.x-t.x:e.y-t.y,kt=(e,t)=>{const r=e.getUint8(17*t);return{z:127&r,x:wt(e,17*t+1),y:wt(e,17*t+4),offset:Tt(e,17*t+7),length:e.getUint32(17*t+13,!0),is_dir:r>>7==1}},Ct=e=>{const t=[],r=new DataView(e);for(let e=0;e<r.byteLength/17;e++)t.push(kt(r,e));return zt(t)},zt=e=>{e.sort(It);const t=new ArrayBuffer(17*e.length),r=new Uint8Array(t);for(let t=0;t<e.length;t++){const i=e[t];let n=i.z;i.is_dir&&(n|=128),r[17*t]=n,r[17*t+1]=255&i.x,r[17*t+2]=i.x>>8&255,r[17*t+3]=i.x>>16&255,r[17*t+4]=255&i.y,r[17*t+5]=i.y>>8&255,r[17*t+6]=i.y>>16&255,r[17*t+7]=255&i.offset,r[17*t+8]=255&bt(i.offset,8),r[17*t+9]=255&bt(i.offset,16),r[17*t+10]=255&bt(i.offset,24),r[17*t+11]=255&bt(i.offset,32),r[17*t+12]=255&bt(i.offset,48),r[17*t+13]=255&i.length,r[17*t+14]=i.length>>8&255,r[17*t+15]=i.length>>16&255,r[17*t+16]=i.length>>24&255}return t};var Mt={getHeader:function(e){return Ne(this,null,(function*(){const t=yield e.getBytes(0,512e3),r=new DataView(t.data),i=r.getUint32(4,!0),n=r.getUint16(8,!0),a=new TextDecoder("utf-8"),o=JSON.parse(a.decode(new DataView(t.data,10,i)));let s=0;"gzip"===o.compression&&(s=2);let l=0;"minzoom"in o&&(l=+o.minzoom);let c=0;"maxzoom"in o&&(c=+o.maxzoom);let u=0,h=0,p=0,d=-180,f=-85,m=180,g=85;if(o.bounds){const e=o.bounds.split(",");d=+e[0],f=+e[1],m=+e[2],g=+e[3]}if(o.center){const e=o.center.split(",");u=+e[0],h=+e[1],p=+e[2]}return{specVersion:r.getUint16(2,!0),rootDirectoryOffset:10+i,rootDirectoryLength:17*n,jsonMetadataOffset:10,jsonMetadataLength:i,leafDirectoryOffset:0,leafDirectoryLength:void 0,tileDataOffset:0,tileDataLength:void 0,numAddressedTiles:0,numTileEntries:0,numTileContents:0,clustered:!1,internalCompression:1,tileCompression:s,tileType:1,minZoom:l,maxZoom:c,minLon:d,minLat:f,maxLon:m,maxLat:g,centerZoom:p,centerLon:u,centerLat:h,etag:t.etag}}))},getZxy:function(e,t,r,i,n,a,o){return Ne(this,null,(function*(){let s=yield r.getArrayBuffer(t,e.rootDirectoryOffset,e.rootDirectoryLength,e);1===e.specVersion&&(s=Ct(s));const l=St(new DataView(s),i,n,a);if(l){let e=(yield t.getBytes(l.offset,l.length,o)).data;const r=new DataView(e);return 31==r.getUint8(0)&&139==r.getUint8(1)&&(e=_t(new Uint8Array(e))),{data:e}}const c=((e,t)=>{if(e.byteLength<17)return null;const r=e.byteLength/17,i=kt(e,r-1);if(i.is_dir){const e=i.z,r=t.z-e;return{z:e,x:Math.trunc(t.x/(1<<r)),y:Math.trunc(t.y/(1<<r))}}return null})(new DataView(s),{z:i,x:n,y:a});if(c){const l=((e,t,r,i)=>{const n=At(e,128|t,r,i);return n?{z:t,x:r,y:i,offset:n[0],length:n[1],is_dir:!0}:null})(new DataView(s),c.z,c.x,c.y);if(l){let s=yield r.getArrayBuffer(t,l.offset,l.length,e);1===e.specVersion&&(s=Ct(s));const c=St(new DataView(s),i,n,a);if(c){let e=(yield t.getBytes(c.offset,c.length,o)).data;const r=new DataView(e);return 31==r.getUint8(0)&&139==r.getUint8(1)&&(e=_t(new Uint8Array(e))),{data:e}}}}}))}};function Pt(e,t){return 4294967296*(t>>>0)+(e>>>0)}function Dt(e){const t=e.buf;let r,i;return i=t[e.pos++],r=127&i,i<128?r:(i=t[e.pos++],r|=(127&i)<<7,i<128?r:(i=t[e.pos++],r|=(127&i)<<14,i<128?r:(i=t[e.pos++],r|=(127&i)<<21,i<128?r:(i=t[e.pos],r|=(15&i)<<28,function(e,t){const r=t.buf;let i,n;if(n=r[t.pos++],i=(112&n)>>4,n<128)return Pt(e,i);if(n=r[t.pos++],i|=(127&n)<<3,n<128)return Pt(e,i);if(n=r[t.pos++],i|=(127&n)<<10,n<128)return Pt(e,i);if(n=r[t.pos++],i|=(127&n)<<17,n<128)return Pt(e,i);if(n=r[t.pos++],i|=(127&n)<<24,n<128)return Pt(e,i);if(n=r[t.pos++],i|=(1&n)<<31,n<128)return Pt(e,i);throw new Error("Expected varint not more than 10 bytes")}(r,e)))))}function Lt(e,t,r,i){if(0==i){1==r&&(t[0]=e-1-t[0],t[1]=e-1-t[1]);const i=t[0];t[0]=t[1],t[1]=i}}var Bt=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function Rt(e,t){return Ne(this,null,(function*(){if(1===t||0===t)return e;if(2===t){if(void 0===globalThis.DecompressionStream)return _t(new Uint8Array(e));{let t=new Response(e).body.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(t).arrayBuffer()}}throw Error("Compression method not supported")}))}function Ft(e,t){let r=0,i=e.length-1;for(;r<=i;){const n=i+r>>1,a=t-e[n].tileId;if(a>0)r=n+1;else{if(!(a<0))return e[n];i=n-1}}if(i>=0){if(0===e[i].runLength)return e[i];if(t-e[i].tileId<e[i].runLength)return e[i]}return null}function Ot(e,t){const r=e.getUint32(t+4,!0),i=e.getUint32(t+0,!0);return r*Math.pow(2,32)+i}function Ut(e){const t={buf:new Uint8Array(e),pos:0},r=Dt(t),i=[];let n=0;for(let e=0;e<r;e++){const e=Dt(t);i.push({tileId:n+e,offset:0,length:0,runLength:1}),n+=e}for(let e=0;e<r;e++)i[e].runLength=Dt(t);for(let e=0;e<r;e++)i[e].length=Dt(t);for(let e=0;e<r;e++){const r=Dt(t);i[e].offset=0===r&&e>0?i[e-1].offset+i[e-1].length:r-1}return i}var Vt=class extends Error{};function $t(e,t,r,i){return Ne(this,null,(function*(){const n=yield e.getBytes(0,16384);if(19792!==new DataView(n.data).getUint16(0,!0))throw new Error("Wrong magic number for PMTiles archive");if(function(e){const t=new DataView(e);return 2===t.getUint16(2,!0)?(console.warn("PMTiles spec version 2 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),2):1===t.getUint16(2,!0)?(console.warn("PMTiles spec version 1 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),1):3}(n.data)<3)return[yield Mt.getHeader(e)];const a=n.data.slice(0,127);let o=n.etag;i&&n.etag!=i&&(console.warn("ETag conflict detected; your HTTP server might not support content-based ETag headers. ETags disabled for "+e.getKey()),o=void 0);const s=function(e,t){const r=new DataView(e),i=r.getUint8(7);if(i>3)throw Error(`Archive is spec version ${i} but this library supports up to spec version 3`);return{specVersion:i,rootDirectoryOffset:Ot(r,8),rootDirectoryLength:Ot(r,16),jsonMetadataOffset:Ot(r,24),jsonMetadataLength:Ot(r,32),leafDirectoryOffset:Ot(r,40),leafDirectoryLength:Ot(r,48),tileDataOffset:Ot(r,56),tileDataLength:Ot(r,64),numAddressedTiles:Ot(r,72),numTileEntries:Ot(r,80),numTileContents:Ot(r,88),clustered:1===r.getUint8(96),internalCompression:r.getUint8(97),tileCompression:r.getUint8(98),tileType:r.getUint8(99),minZoom:r.getUint8(100),maxZoom:r.getUint8(101),minLon:r.getInt32(102,!0)/1e7,minLat:r.getInt32(106,!0)/1e7,maxLon:r.getInt32(110,!0)/1e7,maxLat:r.getInt32(114,!0)/1e7,centerZoom:r.getUint8(118),centerLon:r.getInt32(119,!0)/1e7,centerLat:r.getInt32(123,!0)/1e7,etag:t}}(a,o);if(r){const r=n.data.slice(s.rootDirectoryOffset,s.rootDirectoryOffset+s.rootDirectoryLength),i=e.getKey()+"|"+(s.etag||"")+"|"+s.rootDirectoryOffset+"|"+s.rootDirectoryLength,a=Ut(yield t(r,s.internalCompression));return[s,[i,a.length,a]]}return[s,void 0]}))}var Nt=class{constructor(e,t,r){this.source="string"==typeof e?new class{constructor(e){this.url=e}getKey(){return this.url}getBytes(e,t,r){return Ne(this,null,(function*(){let i;r||(i=new AbortController,r=i.signal);let n=yield fetch(this.url,{signal:r,headers:{Range:"bytes="+e+"-"+(e+t-1)}});if(416===n.status&&0===e){const e=n.headers.get("Content-Range");if(!e||!e.startsWith("bytes */"))throw Error("Missing content-length on 416 response");const t=+e.substr(8);n=yield fetch(this.url,{signal:r,headers:{Range:"bytes=0-"+(t-1)}})}if(n.status>=300)throw Error("Bad response code: "+n.status);const a=n.headers.get("Content-Length");if(200===n.status&&(!a||+a>t))throw i&&i.abort(),Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield n.arrayBuffer(),etag:n.headers.get("ETag")||void 0,cacheControl:n.headers.get("Cache-Control")||void 0,expires:n.headers.get("Expires")||void 0}}))}}(e):e,this.decompress=r||Rt,this.cache=t||new class{constructor(e=100,t=!0,r=Rt){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.prefetch=t,this.decompress=r}getHeader(e,t){return Ne(this,null,(function*(){const r=e.getKey();if(this.cache.has(r))return this.cache.get(r).lastUsed=this.counter++,yield this.cache.get(r).data;const i=new Promise(((r,i)=>{$t(e,this.decompress,this.prefetch,t).then((e=>{e[1]&&this.cache.set(e[1][0],{lastUsed:this.counter++,data:Promise.resolve(e[1][2])}),r(e[0]),this.prune()})).catch((e=>{i(e)}))}));return this.cache.set(r,{lastUsed:this.counter++,data:i}),i}))}getDirectory(e,t,r,i){return Ne(this,null,(function*(){const n=e.getKey()+"|"+(i.etag||"")+"|"+t+"|"+r;if(this.cache.has(n))return this.cache.get(n).lastUsed=this.counter++,yield this.cache.get(n).data;const a=new Promise(((n,a)=>{(function(e,t,r,i,n){return Ne(this,null,(function*(){const a=yield e.getBytes(r,i);if(n.etag&&n.etag!==a.etag)throw new Vt(a.etag);const o=Ut(yield t(a.data,n.internalCompression));if(0===o.length)throw new Error("Empty directory is invalid");return o}))})(e,this.decompress,t,r,i).then((e=>{n(e),this.prune()})).catch((e=>{a(e)}))}));return this.cache.set(n,{lastUsed:this.counter++,data:a}),a}))}getArrayBuffer(e,t,r,i){return Ne(this,null,(function*(){const n=e.getKey()+"|"+(i.etag||"")+"|"+t+"|"+r;if(this.cache.has(n))return this.cache.get(n).lastUsed=this.counter++,yield this.cache.get(n).data;const a=new Promise(((a,o)=>{e.getBytes(t,r).then((e=>{if(i.etag&&i.etag!==e.etag)throw new Vt(e.etag);a(e.data),this.cache.has(n),this.prune()})).catch((e=>{o(e)}))}));return this.cache.set(n,{lastUsed:this.counter++,data:a}),a}))}prune(){if(this.cache.size>=this.maxCacheEntries){let e,t=1/0;this.cache.forEach(((r,i)=>{r.lastUsed<t&&(t=r.lastUsed,e=i)})),e&&this.cache.delete(e)}}invalidate(e,t){return Ne(this,null,(function*(){this.cache.delete(e.getKey()),yield this.getHeader(e,t)}))}}}getHeader(){return Ne(this,null,(function*(){return yield this.cache.getHeader(this.source)}))}getZxyAttempt(e,t,r,i){return Ne(this,null,(function*(){const n=function(e,t,r){if(e>26)throw Error("Tile zoom level exceeds max safe number limit (26)");if(t>Math.pow(2,e)-1||r>Math.pow(2,e)-1)throw Error("tile x/y outside zoom level bounds");const i=Bt[e];let n=0,a=0,o=0;const s=[t,r];let l=Math.pow(2,e)/2;for(;l>0;)n=(s[0]&l)>0?1:0,a=(s[1]&l)>0?1:0,o+=l*l*(3*n^a),Lt(l,s,n,a),l/=2;return i+o}(e,t,r),a=yield this.cache.getHeader(this.source);if(a.specVersion<3)return Mt.getZxy(a,this.source,this.cache,e,t,r,i);if(e<a.minZoom||e>a.maxZoom)return;let o=a.rootDirectoryOffset,s=a.rootDirectoryLength;for(let e=0;e<=3;e++){const e=Ft(yield this.cache.getDirectory(this.source,o,s,a),n);if(!e)return;if(e.runLength>0){const t=yield this.source.getBytes(a.tileDataOffset+e.offset,e.length,i);if(a.etag&&a.etag!==t.etag)throw new Vt(t.etag);return{data:yield this.decompress(t.data,a.tileCompression),cacheControl:t.cacheControl,expires:t.expires}}o=a.leafDirectoryOffset+e.offset,s=e.length}throw Error("Maximum directory depth exceeded")}))}getZxy(e,t,r,i){return Ne(this,null,(function*(){try{return yield this.getZxyAttempt(e,t,r,i)}catch(n){if(n instanceof Vt)return this.cache.invalidate(this.source,n.message),yield this.getZxyAttempt(e,t,r,i);throw n}}))}getMetadataAttempt(){return Ne(this,null,(function*(){const e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength);if(e.etag&&e.etag!==t.etag)throw new Vt(t.etag);const r=yield this.decompress(t.data,e.internalCompression),i=new TextDecoder("utf-8");return JSON.parse(i.decode(r))}))}getMetadata(){return Ne(this,null,(function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof Vt)return this.cache.invalidate(this.source,e.message),yield this.getMetadataAttempt();throw e}}))}};const{document:jt}=d;function qt(e){let t;const r=e[20].default,i=l(r,e,e[19],null);return{c(){i&&i.c()},m(e,r){i&&i.m(e,r),t=!0},p(e,n){i&&i.p&&(!t||524288&n)&&h(i,r,e,e[19],t?u(r,e[19],n,null):p(e[19]),null)},i(e){t||(Y(i,e),t=!0)},o(e){J(i,e),t=!1},d(e){i&&i.d(e)}}}function Gt(e){let t,r,i,n,a,o=e[3]&&qt(e);return{c(){t=_("link"),i=v(),n=_("div"),o&&o.c(),T(t,"rel","stylesheet"),T(t,"href",r=e[1]?e[1]:"https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"),T(n,"id",e[0]),T(n,"class","map svelte-1tna482")},m(r,s){f(jt.head,t),m(r,i,s),m(r,n,s),o&&o.m(n,null),e[21](n),a=!0},p(e,[i]){(!a||2&i&&r!==(r=e[1]?e[1]:"https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"))&&T(t,"href",r),e[3]?o?(o.p(e,i),8&i&&Y(o,1)):(o=qt(e),o.c(),Y(o,1),o.m(n,null)):o&&(H(),J(o,1,1,(()=>{o=null})),K()),(!a||1&i)&&T(n,"id",e[0])},i(e){a||(Y(o),a=!0)},o(e){J(o),a=!1},d(r){g(t),r&&g(i),r&&g(n),o&&o.d(),e[21](null)}}}function Zt(e,t,r){let{$$slots:i={},$$scope:n}=t;const a=P();let o,{map:s}=t,{id:l="map"}=t,{location:c={lng:15,lat:45,zoom:1}}=t,{style:u={version:8,sources:{},layers:[{id:"background",type:"background",paint:{"background-color":"lightgrey"}}]}}=t,{css:h=null}=t,{pmtiles:p=!1}=t,{options:d={}}=t,{minzoom:f=0}=t,{maxzoom:m=14}=t,{controls:g=!1}=t,{tabbable:y=!1}=t,{zoom:_=null}=t,{center:x=null}=t,{pitch:v=null}=t,{bearing:b=null}=t,{interactive:w=!0}=t,{attribution:T=!0}=t,E={},S=!1;return D("map",{getMap:()=>s}),c.bounds?E.bounds=c.bounds:c.lng&&c.lat&&(E.center=[+c.lng,+c.lat],c.zoom&&(E.zoom=+c.zoom),c.pitch&&(E.pitch=+c.pitch),c.bearing&&(E.bearing=+c.bearing)),T||(E.attributionControl=!1),E={...E,...d},z((()=>{if(p){let e=new class{constructor(){this.tile=(e,t)=>{if("json"==e.type){const r=e.url.substr(10);let i=this.tiles.get(r);return i||(i=new Nt(r),this.tiles.set(r,i)),i.getHeader().then((r=>{const i={tiles:[e.url+"/{z}/{x}/{y}"],minzoom:r.minZoom,maxzoom:r.maxZoom,bounds:[r.minLon,r.minLat,r.maxLon,r.maxLat]};t(null,i,null,null)})).catch((e=>{t(e,null,null,null)})),{cancel:()=>{}}}{const r=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),i=e.url.match(r);if(!i)throw new Error("Invalid PMTiles protocol URL");const n=i[1];let a=this.tiles.get(n);a||(a=new Nt(n),this.tiles.set(n,a));const o=i[2],s=i[3],l=i[4],c=new AbortController,u=c.signal;let h=()=>{c.abort()};return a.getHeader().then((e=>{a.getZxy(+o,+s,+l,u).then((r=>{r?t(null,new Uint8Array(r.data),r.cacheControl,r.expires):1==e.tileType?t(null,new Uint8Array,null,null):t(null,null,null,null)})).catch((e=>{"AbortError"!==e.name&&t(e,null,null,null)}))})),{cancel:h}}},this.tiles=new Map}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};se.addProtocol("pmtiles",e.tile)}r(4,s=new se.Map({container:o,style:u,minZoom:f,maxZoom:m,interactive:w,...E})),g&&!Array.isArray(g)?s.addControl(new se.NavigationControl({showCompass:!1})):Array.isArray(g)&&g!=["locate"]&&s.addControl(new se.NavigationControl({showCompass:g.includes("compass"),visualizePitch:g.includes("pitch")})),Array.isArray(g)&&g.includes("locate")&&s.addControl(new se.GeolocateControl),s.on("load",(e=>{r(5,_=s.getZoom()),r(6,x=s.getCenter()),r(7,v=s.getPitch()),r(8,b=s.getBearing()),r(3,S=!0),!y&&document.querySelector(`#${l} canvas`)&&(document.querySelector(`#${l} canvas`).tabIndex="-1"),a("load",{event:e})})),s.on("moveend",(()=>{r(5,_=s.getZoom()),r(6,x=s.getCenter()),r(7,v=s.getPitch()),r(8,b=s.getBearing())}))})),M((async()=>{await function(e=1e3){return new Promise((t=>setTimeout(t,e)))}(250),s&&s.remove(),r(4,s=null)})),e.$$set=e=>{"map"in e&&r(4,s=e.map),"id"in e&&r(0,l=e.id),"location"in e&&r(9,c=e.location),"style"in e&&r(10,u=e.style),"css"in e&&r(1,h=e.css),"pmtiles"in e&&r(11,p=e.pmtiles),"options"in e&&r(12,d=e.options),"minzoom"in e&&r(13,f=e.minzoom),"maxzoom"in e&&r(14,m=e.maxzoom),"controls"in e&&r(15,g=e.controls),"tabbable"in e&&r(16,y=e.tabbable),"zoom"in e&&r(5,_=e.zoom),"center"in e&&r(6,x=e.center),"pitch"in e&&r(7,v=e.pitch),"bearing"in e&&r(8,b=e.bearing),"interactive"in e&&r(17,w=e.interactive),"attribution"in e&&r(18,T=e.attribution),"$$scope"in e&&r(19,n=e.$$scope)},e.$$.update=()=>{1024&e.$$.dirty&&function(e){s&&s.setStyle(e),a("style",{style:e})}(u)},[l,h,o,S,s,_,x,v,b,c,u,p,d,f,m,g,y,w,T,n,i,function(e){R[e?"unshift":"push"]((()=>{o=e,r(2,o)}))}]}class Xt extends ae{constructor(e){super(),ne(this,e,Zt,Gt,o,{map:4,id:0,location:9,style:10,css:1,pmtiles:11,options:12,minzoom:13,maxzoom:14,controls:15,tabbable:16,zoom:5,center:6,pitch:7,bearing:8,interactive:17,attribution:18})}}function Wt(e){let t;const r=e[12].default,i=l(r,e,e[11],null);return{c(){i&&i.c()},m(e,r){i&&i.m(e,r),t=!0},p(e,n){i&&i.p&&(!t||2048&n)&&h(i,r,e,e[11],t?u(r,e[11],n,null):p(e[11]),null)},i(e){t||(Y(i,e),t=!0)},o(e){J(i,e),t=!1},d(e){i&&i.d(e)}}}function Ht(e){let t,r,i=e[0]&&Wt(e);return{c(){i&&i.c(),t=b()},m(e,n){i&&i.m(e,n),m(e,t,n),r=!0},p(e,[r]){e[0]?i?(i.p(e,r),1&r&&Y(i,1)):(i=Wt(e),i.c(),Y(i,1),i.m(t.parentNode,t)):i&&(H(),J(i,1,1,(()=>{i=null})),K())},i(e){r||(Y(i),r=!0)},o(e){J(i),r=!1},d(e){i&&i.d(e),e&&g(t)}}}function Kt(e,t,r){let{$$slots:i={},$$scope:n}=t,{id:a}=t,{type:o}=t,{url:s=null}=t,{props:l={}}=t,{data:c=null}=t,{layer:u=null}=t,{promoteId:h=null}=t,{minzoom:p=null}=t,{maxzoom:d=null}=t,{tilesize:f=256}=t,m=!1,g=s;const{getMap:y}=L("map"),_=y();async function x(){await function(e=1e3){return new Promise((t=>setTimeout(t,e)))}(100),_.isSourceLoaded(a)?(r(0,m=!0),console.log(a+" map source loaded!")):(console.log("..."),x())}return D("source",{source:a,layer:u,promoteId:h}),_.getSource(a)&&_.removeSource(a),p&&(l.minzoom=p),d&&(l.maxzoom=d),u&&h?(l.promoteId={},l.promoteId[u]=h):h&&(l.promoteId=h),z((function(){let e;console.log(a+" map source loading..."),"geojson"==o?c?e={type:o,data:c,...l}:s&&(e={type:o,data:s,...l}):"vector"==o?(e={type:o,...l},"pmtiles"===s.slice(0,7)?e.url=s:e.tiles=[s]):("raster"==o||"raster-dem"==o)&&(e={type:o,tiles:[s],tileSize:f,...l}),e&&(console.log(e),_.addSource(a,e),x())})),M((async()=>{if(_&&_.getSource(a)){_.getStyle().layers.filter((e=>e.source==a)).forEach((e=>{_.removeLayer(e.id)})),_.removeSource(a)}})),e.$$set=e=>{"id"in e&&r(2,a=e.id),"type"in e&&r(3,o=e.type),"url"in e&&r(4,s=e.url),"props"in e&&r(1,l=e.props),"data"in e&&r(5,c=e.data),"layer"in e&&r(6,u=e.layer),"promoteId"in e&&r(7,h=e.promoteId),"minzoom"in e&&r(8,p=e.minzoom),"maxzoom"in e&&r(9,d=e.maxzoom),"tilesize"in e&&r(10,f=e.tilesize),"$$scope"in e&&r(11,n=e.$$scope)},e.$$.update=()=>{41&e.$$.dirty&&"geojson"==o&&m&&function(e){let t=_.getSource(a);t&&t.setData(e)}(c),25&e.$$.dirty&&"vector"==o&&m&&function(e){if(e!==g){let t=_.getSource(a);t&&("pmtiles"===e.slice(0,7)?t.setUrl(e):t.setTiles([e])),g=e}}(s),25&e.$$.dirty&&"raster"==o&&m&&function(e){e!==g&&(_.getSource(a).tiles=[e],_.style.sourceCaches[a].clearTiles(),_.style.sourceCaches[a].update(_.transform),_.triggerRepaint(),g=e)}(s)},[m,l,a,o,s,c,u,h,p,d,f,n,i]}class Yt extends ae{constructor(e){super(),ne(this,e,Kt,Ht,o,{id:2,type:3,url:4,props:1,data:5,layer:6,promoteId:7,minzoom:8,maxzoom:9,tilesize:10})}}const Jt=[];const Qt=e=>({hovered:1&e[0]}),er=e=>({hovered:e[0]});function tr(e){let t;const r=e[30].default,i=l(r,e,e[29],er);return{c(){i&&i.c()},m(e,r){i&&i.m(e,r),t=!0},p(e,n){i&&i.p&&(!t||536870913&n[0])&&h(i,r,e,e[29],t?u(r,e[29],n,Qt):p(e[29]),er)},i(e){t||(Y(i,e),t=!0)},o(e){J(i,e),t=!1},d(e){i&&i.d(e)}}}function rr(t,r,i){let n,{$$slots:a={},$$scope:l}=r;const c=P();let{id:u}=r,{type:h}=r,{filter:p=null}=r,{layout:d={}}=r,{paint:f={}}=r,{data:m=null}=r,{colorKey:g="color"}=r,{nameKey:y=null}=r,{valueKey:_=null}=r,{idKey:x=null}=r,{select:v=!1}=r,{clickIgnore:b=!1}=r,{clickCenter:w=!1}=r,{selected:T=null}=r,{hover:E=!1}=r,{hovered:S=null}=r,{highlight:A=!1}=r,{highlightKey:I="highlighted"}=r,{highlighted:k=[]}=r,{order:C=null}=r,{maxzoom:B=null}=r,{minzoom:R=null}=r,{sourceLayer:F=null}=r,{visible:O=!0}=r;const{source:U,layer:V,promoteId:$}=L("source"),{getMap:N}=L("map"),j=N();D("layer",{layer:u});const q=function(t,r=e){let i;const n=new Set;function a(e){if(o(t,e)&&(t=e,i)){const e=!Jt.length;for(const e of n)e[1](),Jt.push(e,t);if(e){for(let e=0;e<Jt.length;e+=2)Jt[e][0](Jt[e+1]);Jt.length=0}}}return{set:a,update:function(e){a(e(t))},subscribe:function(o,s=e){const l=[o,s];return n.add(l),1===n.size&&(i=r(a)||e),o(t),()=>{n.delete(l),0===n.size&&i&&(i(),i=null)}}}}({id:null,feature:null,event:null});s(t,q,(e=>i(32,n=e))),D("hover",q),x=x||$,F=F||V;let G=null,Z=null,X=[];d.visibility=O?"visible":"none";let W={id:u,type:h,source:U,paint:f,layout:d};function H(e,t=g){if(console.log("updating colors..."),y||_)for(const r of e)j.setFeatureState({source:U,sourceLayer:F,id:r[x]},{color:t?r[t]:null,name:y?r[y]:null,value:_?r[_]:null});else for(const r of e)j.setFeatureState({source:U,sourceLayer:F,id:r[x]},{color:r[t]})}return p&&(W.filter=p),F&&(W["source-layer"]=F),B&&(W.maxzoom=B),R&&(W.minzoom=R),z((()=>{j.getLayer(u)&&j.removeLayer(u),j.addLayer(W,C)})),v&&j.on("click",u,(e=>{if(e.features.length>0&&!b){let t=e.features[0];if(i(2,T=t.id),c("select",{id:T,feature:t,event:e}),G&&j.setFeatureState({source:U,sourceLayer:F,id:G},{selected:!1}),j.setFeatureState({source:U,sourceLayer:F,id:T},{selected:!0}),w){let t=centroid(e.features[0].toJSON().geometry);j.flyTo({center:t.geometry.coordinates})}i(26,G=T)}})),E&&(j.on("mousemove",u,(e=>{if(e.features.length>0){S&&j.setFeatureState({source:U,sourceLayer:F,id:S},{hovered:!1});let t=e.features[0];i(0,S=i(27,Z=t.id)),q.set({id:S,feature:t,event:e}),c("hover",n),j.setFeatureState({source:U,sourceLayer:F,id:S},{hovered:!0}),j.getCanvas().style.cursor="pointer"}})),j.on("mouseleave",u,(e=>{S&&j.setFeatureState({source:U,sourceLayer:F,id:S},{hovered:!1}),i(0,S=i(27,Z=null)),q.set({id:null,feature:null,event:e}),c("hover",n),j.getCanvas().style.cursor=""}))),M((async()=>{j&&j.getLayer(u)&&j.removeLayer(u)})),t.$$set=e=>{"id"in e&&i(6,u=e.id),"type"in e&&i(7,h=e.type),"filter"in e&&i(8,p=e.filter),"layout"in e&&i(4,d=e.layout),"paint"in e&&i(9,f=e.paint),"data"in e&&i(10,m=e.data),"colorKey"in e&&i(11,g=e.colorKey),"nameKey"in e&&i(12,y=e.nameKey),"valueKey"in e&&i(13,_=e.valueKey),"idKey"in e&&i(5,x=e.idKey),"select"in e&&i(14,v=e.select),"clickIgnore"in e&&i(15,b=e.clickIgnore),"clickCenter"in e&&i(16,w=e.clickCenter),"selected"in e&&i(2,T=e.selected),"hover"in e&&i(17,E=e.hover),"hovered"in e&&i(0,S=e.hovered),"highlight"in e&&i(18,A=e.highlight),"highlightKey"in e&&i(19,I=e.highlightKey),"highlighted"in e&&i(20,k=e.highlighted),"order"in e&&i(21,C=e.order),"maxzoom"in e&&i(22,B=e.maxzoom),"minzoom"in e&&i(23,R=e.minzoom),"sourceLayer"in e&&i(3,F=e.sourceLayer),"visible"in e&&i(24,O=e.visible),"$$scope"in e&&i(29,l=e.$$scope)},t.$$.update=()=>{if(3072&t.$$.dirty[0]&&m&&H(m,g),256&t.$$.dirty[0]&&function(e){j.getLayer(u)&&j.setFilter(u,e)}(p),512&t.$$.dirty[0]&&function(e){if(j.getLayer(u))for(const t in e)j.setPaintProperty(u,t,e[t])}(f),16777216&t.$$.dirty[0]&&function(e){j.getLayer(u)&&j.setLayoutProperty(u,"visibility",e?"visible":"none")}(O),270270472&t.$$.dirty[0]&&A&&k!=X){if(X[0])for(const e of X){let t={};t[I]=!1,j.setFeatureState({source:U,sourceLayer:F,id:e},t)}if(i(28,X=k),k[0])for(const e of k){let t={};t[I]=!0,j.setFeatureState({source:U,sourceLayer:F,id:e},t)}}67125260&t.$$.dirty[0]&&v&&T!=G&&(G&&j.setFeatureState({source:U,sourceLayer:F,id:G},{selected:!1}),T&&j.setFeatureState({source:U,sourceLayer:F,id:T},{selected:!0}),i(26,G=T)),134348809&t.$$.dirty[0]&&E&&S!=Z&&(Z&&j.setFeatureState({source:U,sourceLayer:F,id:Z},{hovered:!1}),S&&j.setFeatureState({source:U,sourceLayer:F,id:S},{hovered:!0}),i(27,Z=S))},[S,q,T,F,d,x,u,h,p,f,m,g,y,_,v,b,w,E,A,I,k,C,B,R,O,H,G,Z,X,l,a]}class ir extends ae{constructor(e){super(),ne(this,e,rr,tr,o,{id:6,type:7,filter:8,layout:4,paint:9,data:10,colorKey:11,nameKey:12,valueKey:13,idKey:5,select:14,clickIgnore:15,clickCenter:16,selected:2,hover:17,hovered:0,highlight:18,highlightKey:19,highlighted:20,order:21,maxzoom:22,minzoom:23,sourceLayer:3,visible:24,updateColors:25},null,[-1,-1])}get updateColors(){return this.$$.ctx[25]}}function nr(e,t,r){const i=e.slice();return i[16]=t[r],i}function ar(e,t,r){const i=e.slice();return i[19]=t[r],i[21]=r,i}function or(e,t,r){const i=e.slice();return i[19]=t[r],i[21]=r,i}function sr(e,t,r){const i=e.slice();return i[16]=t[r],i[21]=r,i}function lr(e){let t,r=e[9],i=[];for(let t=0;t<r.length;t+=1)i[t]=cr(sr(e,r,t));return{c(){t=_("ul");for(let e=0;e<i.length;e+=1)i[e].c();T(t,"class","legend-block svelte-v05hvd")},m(e,r){m(e,t,r);for(let e=0;e<i.length;e+=1)i[e]&&i[e].m(t,null)},p(e,n){if(576&n){let a;for(r=e[9],a=0;a<r.length;a+=1){const o=sr(e,r,a);i[a]?i[a].p(o,n):(i[a]=cr(o),i[a].c(),i[a].m(t,null))}for(;a<i.length;a+=1)i[a].d(1);i.length=r.length}},d(e){e&&g(t),y(i,e)}}}function cr(e){let t,r,i,n,a,o,s=e[16]+"";return{c(){var l;t=_("li"),r=_("div"),i=v(),n=_("span"),a=x(s),o=v(),T(r,"class","legend-vis "+(0==e[21]?"bar":"marker")+" svelte-v05hvd"),S(r,"height","1rem"),S(r,"width",0==e[21]?"1rem":e[6]+"px"),T(n,"class",(null==(l=0==e[21]?"bold":"brackets")?"":l)+" svelte-v05hvd"),T(t,"class","svelte-v05hvd")},m(e,s){m(e,t,s),f(t,r),f(t,i),f(t,n),f(n,a),f(t,o)},p(e,t){64&t&&S(r,"width",0==e[21]?"1rem":e[6]+"px"),512&t&&s!==(s=e[16]+"")&&E(a,s)},d(e){e&&g(t)}}}function ur(e){let t,r,i,n=e[3](e[19][e[0]])+"";return{c(){t=_("span"),r=x(n),i=x(e[4]),T(t,"class","label "+(0==e[21]?"bold":"sml brackets")+" svelte-v05hvd")},m(e,n){m(e,t,n),f(t,r),f(t,i)},p(e,t){137&t&&n!==(n=e[3](e[19][e[0]])+"")&&E(r,n),16&t&&E(i,e[4])},d(e){e&&g(t)}}}function hr(e){let t,r=`calc(${e[8](e[19][e[0]])}% - ${e[6]/2}px)`,i=`${e[6]}px`;return{c(){t=_("div"),T(t,"class","marker svelte-v05hvd"),S(t,"left",r),S(t,"border-left-width",i)},m(e,r){m(e,t,r)},p(e,n){449&n&&r!==(r=`calc(${e[8](e[19][e[0]])}% - ${e[6]/2}px)`)&&S(t,"left",r),64&n&&i!==(i=`${e[6]}px`)&&S(t,"border-left-width",i)},d(e){e&&g(t)}}}function pr(e){let t,r=`${e[8](e[19][e[0]])}%`;return{c(){t=_("div"),T(t,"class","bar svelte-v05hvd"),S(t,"left","0"),S(t,"width",r),S(t,"background-color","number"==typeof e[19][e[1]]?e[2][e[19][e[1]]]:null)},m(e,r){m(e,t,r)},p(e,i){385&i&&r!==(r=`${e[8](e[19][e[0]])}%`)&&S(t,"width",r),134&i&&S(t,"background-color","number"==typeof e[19][e[1]]?e[2][e[19][e[1]]]:null)},d(e){e&&g(t)}}}function dr(e){let t;let r=function(e,t){return 0==e[21]?pr:hr}(e),i=r(e);return{c(){i.c(),t=b()},m(e,r){i.m(e,r),m(e,t,r)},p(e,t){i.p(e,t)},d(e){i.d(e),e&&g(t)}}}function fr(e){let t,r,i,n,a,o,s=e[10](e[16].label)+"",l=`${e[5]}px`,c=e[16].values,u=[];for(let t=0;t<c.length;t+=1)u[t]=ur(or(e,c,t));let h=e[16].values,p=[];for(let t=0;t<h.length;t+=1)p[t]=dr(ar(e,h,t));return{c(){t=_("div"),r=x(s),i=v();for(let e=0;e<u.length;e+=1)u[e].c();n=v(),a=_("div");for(let e=0;e<p.length;e+=1)p[e].c();o=v(),T(t,"class","label-group svelte-v05hvd"),T(a,"class","bar-group svelte-v05hvd"),S(a,"height",l)},m(e,s){m(e,t,s),f(t,r),f(t,i);for(let e=0;e<u.length;e+=1)u[e]&&u[e].m(t,null);m(e,n,s),m(e,a,s);for(let e=0;e<p.length;e+=1)p[e]&&p[e].m(a,null);f(a,o)},p(e,i){if(128&i&&s!==(s=e[10](e[16].label)+"")&&E(r,s),153&i){let r;for(c=e[16].values,r=0;r<c.length;r+=1){const n=or(e,c,r);u[r]?u[r].p(n,i):(u[r]=ur(n),u[r].c(),u[r].m(t,null))}for(;r<u.length;r+=1)u[r].d(1);u.length=c.length}if(455&i){let t;for(h=e[16].values,t=0;t<h.length;t+=1){const r=ar(e,h,t);p[t]?p[t].p(r,i):(p[t]=dr(r),p[t].c(),p[t].m(a,o))}for(;t<p.length;t+=1)p[t].d(1);p.length=h.length}32&i&&l!==(l=`${e[5]}px`)&&S(a,"height",l)},d(e){e&&g(t),y(u,e),e&&g(n),e&&g(a),y(p,e)}}}function mr(t){let r,i,n=t[9][1]&&lr(t),a=t[7],o=[];for(let e=0;e<a.length;e+=1)o[e]=fr(nr(t,a,e));return{c(){n&&n.c(),r=v();for(let e=0;e<o.length;e+=1)o[e].c();i=b()},m(e,t){n&&n.m(e,t),m(e,r,t);for(let r=0;r<o.length;r+=1)o[r]&&o[r].m(e,t);m(e,i,t)},p(e,[t]){if(e[9][1]?n?n.p(e,t):(n=lr(e),n.c(),n.m(r.parentNode,r)):n&&(n.d(1),n=null),1535&t){let r;for(a=e[7],r=0;r<a.length;r+=1){const n=nr(e,a,r);o[r]?o[r].p(n,t):(o[r]=fr(n),o[r].c(),o[r].m(i.parentNode,i))}for(;r<o.length;r+=1)o[r].d(1);o.length=a.length}},i:e,o:e,d(e){n&&n.d(e),e&&g(r),y(o,e),e&&g(i)}}}function gr(e,t,r){let i,n,a,o,{data:s}=t,{xKey:l="value"}=t,{yKey:c="category"}=t,{zKey:u="group"}=t,{colorKey:h="color"}=t,{colors:p=["white","#888","#444"]}=t,{formatTick:d=(e=>e.toLocaleString())}=t,{suffix:f=""}=t,{barHeight:m=20}=t,{markerWidth:g=3}=t;return e.$$set=e=>{"data"in e&&r(11,s=e.data),"xKey"in e&&r(0,l=e.xKey),"yKey"in e&&r(12,c=e.yKey),"zKey"in e&&r(13,u=e.zKey),"colorKey"in e&&r(1,h=e.colorKey),"colors"in e&&r(2,p=e.colors),"formatTick"in e&&r(3,d=e.formatTick),"suffix"in e&&r(4,f=e.suffix),"barHeight"in e&&r(5,m=e.barHeight),"markerWidth"in e&&r(6,g=e.markerWidth)},e.$$.update=()=>{2049&e.$$.dirty&&r(14,i=[0,Math.max(...s.map((e=>e[l])))]),10240&e.$$.dirty&&r(9,n=s.map((e=>e[u])).filter(((e,t,r)=>r.indexOf(e)===t))),16384&e.$$.dirty&&r(8,a=e=>e/i[1]*100),6144&e.$$.dirty&&r(7,o=function(e,t){let r={};for(const i of e)r[i[t]]||(r[i[t]]={label:i[t],values:[]}),r[i[t]].values.push(i);let i=[];for(const e in r)i.push(r[e]);return i}(s,c))},[l,h,p,d,f,m,g,o,a,n,e=>e.charAt(0).toUpperCase()+e.slice(1),s,c,u,i]}class yr extends ae{constructor(e){super(),ne(this,e,gr,mr,o,{data:11,xKey:0,yKey:12,zKey:13,colorKey:1,colors:2,formatTick:3,suffix:4,barHeight:5,markerWidth:6})}}function _r(e,t,r){const i=e.slice();return i[42]=t[r],i}function xr(e,t,r){const i=e.slice();return i[45]=t[r],i}function vr(t){let r,i,n;return{c(){r=_("button"),r.textContent="Deselect",T(r,"class","btn-link svelte-1egxxhq")},m(e,a){m(e,r,a),i||(n=w(r,"click",t[14]),i=!0)},p:e,d(e){e&&g(r),i=!1,n()}}}function br(e){let t,r;function i(...t){return e[23](e[45],...t)}return t=new yr({props:{data:[{category:"Works from home",value:e[6][e[45]].home,color:0},{category:`Lives within ${e[5][e[45]].areanm}`,value:e[6][e[45]].within,color:0},...[1,2,3,4,5].map(i),{category:"Lives in another location",value:e[6][e[45]].fromother,color:2}]}}),{c(){ee(t.$$.fragment)},m(e,i){te(t,e,i),r=!0},p(r,n){e=r;const a={};108&n[0]&&(a.data=[{category:"Works from home",value:e[6][e[45]].home,color:0},{category:`Lives within ${e[5][e[45]].areanm}`,value:e[6][e[45]].within,color:0},...[1,2,3,4,5].map(i),{category:"Lives in another location",value:e[6][e[45]].fromother,color:2}]),t.$set(a)},i(e){r||(Y(t.$$.fragment,e),r=!0)},o(e){J(t.$$.fragment,e),r=!1},d(e){re(t,e)}}}function wr(e){let t,r;function i(...t){return e[22](e[45],...t)}return t=new yr({props:{data:[{category:"Works from home",value:e[6][e[45]].home,color:0},{category:`Works within ${e[5][e[45]].areanm}`,value:e[6][e[45]].within,color:0},...[1,2,3,4,5].map(i),{category:"Works in another location",value:e[6][e[45]].toother,color:2}]}}),{c(){ee(t.$$.fragment)},m(e,i){te(t,e,i),r=!0},p(r,n){e=r;const a={};108&n[0]&&(a.data=[{category:"Works from home",value:e[6][e[45]].home,color:0},{category:`Works within ${e[5][e[45]].areanm}`,value:e[6][e[45]].within,color:0},...[1,2,3,4,5].map(i),{category:"Works in another location",value:e[6][e[45]].toother,color:2}]),t.$set(a)},i(e){r||(Y(t.$$.fragment,e),r=!0)},o(e){J(t.$$.fragment,e),r=!1},d(e){re(t,e)}}}function Tr(e){let t,r,i,a,o,s,l,c,u,h,p,d,y,b,I,k,C,z,M,P,D,L,B,R,F,O,U,V,$=e[5][e[45]].areanm+"",N=e[6][e[45]].resident.toLocaleString()+"",j=e[6][e[45]].workday.toLocaleString()+"",q=(e[6][e[45]].workday-e[6][e[45]].resident).toLocaleString("en-GB",{signDisplay:"exceptZero"})+"",G=e[45]===e[2]&&vr(e);const Z=[wr,br],X=[];function W(e,t){return"from"===e[9]?0:1}return M=W(e),P=X[M]=Z[M](e),{c(){t=_("div"),r=x($),i=v(),G&&G.c(),a=v(),o=_("button"),s=x("Resident population\n\t\t\t\t"),l=_("div"),c=x(N),u=v(),h=_("button"),p=x("Workday population\n\t\t\t\t"),d=_("div"),y=x(j),b=v(),I=_("div"),k=x(q),C=v(),z=_("div"),P.c(),D=v(),L=_("div"),B=_("label"),R=_("input"),F=x("\n\t\t\t\t\tHighlight points for this area on map"),T(t,"class","big-text svelte-1egxxhq"),S(t,"grid-column","span 2"),T(l,"class","big-text svelte-1egxxhq"),T(o,"class","svelte-1egxxhq"),A(o,"btn-active","from"===e[9]),T(d,"class","big-text svelte-1egxxhq"),T(I,"class","small-text svelte-1egxxhq"),T(h,"class","svelte-1egxxhq"),A(h,"btn-active","to"===e[9]),S(z,"grid-column","span 2"),T(R,"type","checkbox"),S(L,"grid-column","span 2")},m(n,g){m(n,t,g),f(t,r),f(t,i),G&&G.m(t,null),m(n,a,g),m(n,o,g),f(o,s),f(o,l),f(l,c),m(n,u,g),m(n,h,g),f(h,p),f(h,d),f(d,y),f(h,b),f(h,I),f(I,k),m(n,C,g),m(n,z,g),X[M].m(z,null),m(n,D,g),m(n,L,g),f(L,B),f(B,R),R.checked=e[10],f(B,F),O=!0,U||(V=[w(o,"click",e[20]),w(h,"click",e[21]),w(R,"change",e[24]),w(R,"change",e[25])],U=!0)},p(e,i){(!O||44&i[0])&&$!==($=e[5][e[45]].areanm+"")&&E(r,$),e[45]===e[2]?G?G.p(e,i):(G=vr(e),G.c(),G.m(t,null)):G&&(G.d(1),G=null),(!O||76&i[0])&&N!==(N=e[6][e[45]].resident.toLocaleString()+"")&&E(c,N),(!O||512&i[0])&&A(o,"btn-active","from"===e[9]),(!O||76&i[0])&&j!==(j=e[6][e[45]].workday.toLocaleString()+"")&&E(y,j),(!O||76&i[0])&&q!==(q=(e[6][e[45]].workday-e[6][e[45]].resident).toLocaleString("en-GB",{signDisplay:"exceptZero"})+"")&&E(k,q),(!O||512&i[0])&&A(h,"btn-active","to"===e[9]);let n=M;M=W(e),M===n?X[M].p(e,i):(H(),J(X[n],1,1,(()=>{X[n]=null})),K(),P=X[M],P?P.p(e,i):(P=X[M]=Z[M](e),P.c()),Y(P,1),P.m(z,null)),1024&i[0]&&(R.checked=e[10])},i(e){O||(Y(P),O=!0)},o(e){J(P),O=!1},d(e){e&&g(t),G&&G.d(),e&&g(a),e&&g(o),e&&g(u),e&&g(h),e&&g(C),e&&g(z),X[M].d(),e&&g(D),e&&g(L),U=!1,n(V)}}}function Er(e){let t,r,i;return{c(){t=_("div"),t.textContent="2011 Census travel to work data",r=v(),i=_("div"),i.innerHTML="<p>Using this experimental tool, you can:</p> \n\t\t\t\t<ul><li>animate commutes on a map, by clicking &quot;place of work&quot;.</li> \n\t\t\t\t\t<li>see commutes for individual area, by hovering or clicking an area on the map.</li></ul> \n\t\t\t\t<p>Note: The data in this tool is from 2011, not the latest 2021 census.</p>",T(t,"class","big-text svelte-1egxxhq"),S(t,"grid-column","span 2"),S(i,"grid-column","span 2")},m(e,n){m(e,t,n),m(e,r,n),m(e,i,n)},d(e){e&&g(t),e&&g(r),e&&g(i)}}}function Sr(e){let t,r,i=e[0],n=[];for(let t=0;t<i.length;t+=1)n[t]=Ir(_r(e,i,t));const a=e=>J(n[e],1,1,(()=>{n[e]=null}));return{c(){for(let e=0;e<n.length;e+=1)n[e].c();t=b()},m(e,i){for(let t=0;t<n.length;t+=1)n[t]&&n[t].m(e,i);m(e,t,i),r=!0},p(e,r){if(8349&r[0]){let o;for(i=e[0],o=0;o<i.length;o+=1){const a=_r(e,i,o);n[o]?(n[o].p(a,r),Y(n[o],1)):(n[o]=Ir(a),n[o].c(),Y(n[o],1),n[o].m(t.parentNode,t))}for(H(),o=i.length;o<n.length;o+=1)a(o);K()}},i(e){if(!r){for(let e=0;e<i.length;e+=1)Y(n[e]);r=!0}},o(e){n=n.filter(Boolean);for(let e=0;e<n.length;e+=1)J(n[e]);r=!1},d(e){y(n,e),e&&g(t)}}}function Ar(e){let t,r,i,n,a,o,s,l,c,u;function h(t){e[28](t)}let p={id:e[42].key+"-fill",type:"fill",paint:{"fill-color":"rgba(0,0,0,0)"},order:"water",hover:!0,select:!0,selected:e[2],highlight:!0,highlighted:e[4],visible:e[7]===e[42].key};return void 0!==e[3]&&(p.hovered=e[3]),t=new ir({props:p}),R.push((()=>Q(t,"hovered",h))),t.$on("select",e[13]),n=new ir({props:{id:e[42].key+"-line",type:"line",paint:{"line-color":"#555","line-width":.5},order:"place_other",visible:e[7]===e[42].key}}),o=new ir({props:{id:e[42].key+"-highlighted",type:"line",paint:{"line-color":["case",["==",["feature-state","highlighted"],!0],"#aaa","rgba(0,0,0,0)"],"line-width":1},order:"place_other",visible:e[7]===e[42].key}}),l=new ir({props:{id:e[42].key+"-selected",type:"line",paint:{"line-color":["case",["==",["feature-state","selected"],!0],"white",["==",["feature-state","hovered"],!0],"white","rgba(0,0,0,0)"],"line-width":["case",["==",["feature-state","selected"],!0],2.5,1]},order:"place_other",visible:e[7]===e[42].key}}),{c(){ee(t.$$.fragment),i=v(),ee(n.$$.fragment),a=v(),ee(o.$$.fragment),s=v(),ee(l.$$.fragment),c=v()},m(e,r){te(t,e,r),m(e,i,r),te(n,e,r),m(e,a,r),te(o,e,r),m(e,s,r),te(l,e,r),m(e,c,r),u=!0},p(e,i){const a={};1&i[0]&&(a.id=e[42].key+"-fill"),4&i[0]&&(a.selected=e[2]),16&i[0]&&(a.highlighted=e[4]),129&i[0]&&(a.visible=e[7]===e[42].key),!r&&8&i[0]&&(r=!0,a.hovered=e[3],N((()=>r=!1))),t.$set(a);const s={};1&i[0]&&(s.id=e[42].key+"-line"),129&i[0]&&(s.visible=e[7]===e[42].key),n.$set(s);const c={};1&i[0]&&(c.id=e[42].key+"-highlighted"),129&i[0]&&(c.visible=e[7]===e[42].key),o.$set(c);const u={};1&i[0]&&(u.id=e[42].key+"-selected"),129&i[0]&&(u.visible=e[7]===e[42].key),l.$set(u)},i(e){u||(Y(t.$$.fragment,e),Y(n.$$.fragment,e),Y(o.$$.fragment,e),Y(l.$$.fragment,e),u=!0)},o(e){J(t.$$.fragment,e),J(n.$$.fragment,e),J(o.$$.fragment,e),J(l.$$.fragment,e),u=!1},d(e){re(t,e),e&&g(i),re(n,e),e&&g(a),re(o,e),e&&g(s),re(l,e),e&&g(c)}}}function Ir(e){let r,i;const n=[{id:e[42].key},{type:e[42].type},{promoteId:"areacd"},e[42].props];let a={$$slots:{default:[Ar]},$$scope:{ctx:e}};for(let e=0;e<n.length;e+=1)a=t(a,n[e]);return r=new Yt({props:a}),{c(){ee(r.$$.fragment)},m(e,t){te(r,e,t),i=!0},p(e,t){const i=1&t[0]?function(e,t){const r={},i={},n={$$scope:1};let a=e.length;for(;a--;){const o=e[a],s=t[a];if(s){for(const e in o)e in s||(i[e]=1);for(const e in s)n[e]||(r[e]=s[e],n[e]=1);e[a]=s}else for(const e in o)n[e]=1}for(const e in i)e in r||(r[e]=void 0);return r}(n,[{id:e[42].key},{type:e[42].type},n[2],(a=e[42].props,"object"==typeof a&&null!==a?a:{})]):{};var a;157&t[0]|131072&t[1]&&(i.$$scope={dirty:t,ctx:e}),r.$set(i)},i(e){i||(Y(r.$$.fragment,e),i=!0)},o(e){J(r.$$.fragment,e),i=!1},d(e){re(r,e)}}}function kr(e){let t,r,i=e[0][1].props.data&&Sr(e);return{c(){i&&i.c(),t=b()},m(e,n){i&&i.m(e,n),m(e,t,n),r=!0},p(e,r){e[0][1].props.data?i?(i.p(e,r),1&r[0]&&Y(i,1)):(i=Sr(e),i.c(),Y(i,1),i.m(t.parentNode,t)):i&&(H(),J(i,1,1,(()=>{i=null})),K())},i(e){r||(Y(i),r=!0)},o(e){J(i),r=!1},d(e){i&&i.d(e),e&&g(t)}}}function Cr(e){let t,r,i,a,o,s,l,c,u,h,p,d,x,b,E,S,I,k,C,z,M,P,D=e[3]?[e[3]]:e[2]?[e[2]]:[],L=[];for(let t=0;t<D.length;t+=1)L[t]=Tr(xr(e,D,t));const B=e=>J(L[e],1,1,(()=>{L[e]=null}));let F=!e[2]&&!e[3]&&Er();function O(t){e[29](t)}let U={style:"https://bothness.github.io/ons-basemaps/data/style-dark.json",location:{bounds:e[11]},options:{antialias:!0},minzoom:6,controls:!0,$$slots:{default:[kr]},$$scope:{ctx:e}};return void 0!==e[1]&&(U.map=e[1]),k=new Xt({props:U}),R.push((()=>Q(k,"map",O))),k.$on("load",e[12]),{c(){t=_("main"),r=_("div"),i=_("div"),a=_("button"),a.textContent="Local authorities",o=v(),s=_("button"),s.textContent="Neighbourhoods",l=v();for(let e=0;e<L.length;e+=1)L[e].c();c=v(),F&&F.c(),u=v(),h=_("div"),p=_("div"),d=_("button"),d.textContent="Place of residence",x=v(),b=_("button"),b.textContent="Place of work",E=v(),S=_("span"),S.textContent="1 dot = 100 working people",I=v(),ee(k.$$.fragment),T(a,"class","svelte-1egxxhq"),A(a,"btn-active","lad"===e[7]),T(s,"class","svelte-1egxxhq"),A(s,"btn-active","msoa"===e[7]),T(i,"class","grid svelte-1egxxhq"),T(r,"class","info svelte-1egxxhq"),T(d,"class","svelte-1egxxhq"),A(d,"btn-active","from"===e[8]),T(b,"class","svelte-1egxxhq"),A(b,"btn-active","to"===e[8]),T(S,"class","svelte-1egxxhq"),T(p,"class","map-legend svelte-1egxxhq"),T(h,"class","map svelte-1egxxhq"),T(t,"class","container svelte-1egxxhq")},m(n,g){m(n,t,g),f(t,r),f(r,i),f(i,a),f(i,o),f(i,s),f(i,l);for(let e=0;e<L.length;e+=1)L[e]&&L[e].m(i,null);f(i,c),F&&F.m(i,null),f(t,u),f(t,h),f(h,p),f(p,d),f(p,x),f(p,b),f(p,E),f(p,S),f(h,I),te(k,h,null),z=!0,M||(P=[w(a,"click",e[18]),w(s,"click",e[19]),w(d,"click",e[26]),w(b,"click",e[27])],M=!0)},p(e,t){if((!z||128&t[0])&&A(a,"btn-active","lad"===e[7]),(!z||128&t[0])&&A(s,"btn-active","msoa"===e[7]),149100&t[0]){let r;for(D=e[3]?[e[3]]:e[2]?[e[2]]:[],r=0;r<D.length;r+=1){const n=xr(e,D,r);L[r]?(L[r].p(n,t),Y(L[r],1)):(L[r]=Tr(n),L[r].c(),Y(L[r],1),L[r].m(i,c))}for(H(),r=D.length;r<L.length;r+=1)B(r);K()}e[2]||e[3]?F&&(F.d(1),F=null):F||(F=Er(),F.c(),F.m(i,null)),(!z||256&t[0])&&A(d,"btn-active","from"===e[8]),(!z||256&t[0])&&A(b,"btn-active","to"===e[8]);const r={};157&t[0]|131072&t[1]&&(r.$$scope={dirty:t,ctx:e}),!C&&2&t[0]&&(C=!0,r.map=e[1],N((()=>C=!1))),k.$set(r)},i(e){if(!z){for(let e=0;e<D.length;e+=1)Y(L[e]);Y(k.$$.fragment,e),z=!0}},o(e){L=L.filter(Boolean);for(let e=0;e<L.length;e+=1)J(L[e]);J(k.$$.fragment,e),z=!1},d(e){e&&g(t),y(L,e),F&&F.d(),re(k),M=!1,n(P)}}}function zr(e,t,r){const i=[-6.3603,49.8823,1.7637,55.8112],n=[{key:"msoa",type:"vector",props:{url:"https://cdn.ons.gov.uk/maptiles/administrative/msoa/v2/boundaries/{z}/{x}/{y}.pbf",layer:"msoa",maxzoom:12,minzoom:6}},{key:"lad",type:"geojson",props:{}}],a=e=>{const t=se.MercatorCoordinate.fromLngLat({lng:e[0],lat:e[1]});return[t.x,t.y]},o=(s=[5,14],l=[1,8],e=>e<s[0]?l[0]:e>s[1]?l[1]:(e-s[0])*((l[1]-l[0])/(s[1]-s[0]))+l[0]);var s,l;let c,u,h,p,d,f,m,g,y,_,x,v,b,w={},T="lad",E="from",S="from",A=!0;function I(e){const t="string"==typeof e?e:e?.detail?.id;t&&(r(2,u=t),M())}function k(){r(2,u=null),r(4,p=[]),_({data:Array.from({length:w.array.length},(()=>.7))}),c.fitBounds(i)}function C(e){E!==e&&(y.update(w[e]),r(8,E=e))}function z(e){T!==e&&(r(7,T=e),u&&"lad"===e?I(v[u].parentcd):k())}function M(e=S){u&&(_({data:A?w.array.map((t=>t[`${e}_${T}`]===u?1:.1)):Array.from({length:w.array.length},(()=>.7))}),r(4,p=function(e,t,r){return[1,2,3,4,5].map((i=>e[t][`${"to"===r?"from":"to"}${i}cd`]))}(b,u,e)),r(9,S=e),function(e){const t=[Math.min(...e.map((e=>e.xmin))),Math.min(...e.map((e=>e.ymin))),Math.max(...e.map((e=>e.xmax))),Math.max(...e.map((e=>e.ymax)))];c.fitBounds(t,{padding:50})}([v[u],...p.map((e=>v[e]))]))}return[n,c,u,h,p,v,b,T,E,S,A,i,async function(){const e=(t=await(await fetch("./data/lad11_bsc.json")).json(),"string"==typeof(i="lad")&&(i=t.objects[i]),"GeometryCollection"===i.type?{type:"FeatureCollection",features:i.geometries.map((function(e){return $e(t,e)}))}:$e(t,i));var t,i;const s=await(await fetch("./data/lad11_metadata.csv")).text(),l=await(await fetch("./data/msoa11_metadata.csv")).text(),u=[...Fe(await s),...Fe(await l)],h={};u.forEach((e=>h[e.areacd]=e)),r(5,v=h),r(0,n[1].props.data=e,n);const p=await fetch("./data/lad11_data.csv"),T=await fetch("./data/msoa11_data.csv"),E=[...Fe(await p.text(),Oe),...Fe(await T.text(),Oe)],S={};E.forEach((e=>S[e.areacd]=e)),r(6,b=S);const A=await fetch("./data/msoa11_points.csv");w.array=Fe(await A.text(),(e=>({from_msoa:e.from,from_lad:v[e.from]?.parentcd||e.from,to_msoa:e.to,to_lad:v[e.to]?.parentcd||e.to,x1:+e.x1,y1:+e.y1,x2:+e.x2,y2:+e.y2})));const I=w.array.length;w.from=w.array.map((e=>a([e.x1,e.y1]))),w.to=w.array.map((e=>a([e.x2,e.y2]))),c.addLayer({id:"custom_layer",type:"custom",onAdd:(e,t)=>{g=(e=>(f=le(e),m=Ce(f),y=m.buffer(w.from,{duration:5e3,ease:"expo-in-out"}),_=f.buffer(Array.from({length:I},(()=>.7))),{render:m({vert:"\n      uniform mat4 uMatrix;\n      uniform float pointSize;\n      precision lowp float;\n      attribute vec2 position;\n\t\t\tattribute float opacity;\n\t\t\tvarying float fragOpacity;\n\n      void main() {\n        gl_PointSize = pointSize;\n        gl_Position = uMatrix * vec4(position, 0, 1);\n\t\t\t\tfragOpacity = opacity;\n      }\n        ",frag:"\n      precision lowp float;\n\t\t\tvarying float fragOpacity;\n\n      void main() {\n        if (length(gl_PointCoord.xy - 0.5) > 0.5) {\n          discard;\n        }\n        gl_FragColor = vec4(0.145, 0.627, 0.8, fragOpacity);\n      }\n      ",attributes:{position:y,opacity:_},uniforms:{pointSize:f.prop("pointSize")||2,uMatrix:f.prop("uMatrix")},blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:"src alpha",dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"}},depth:{enable:!1},count:I,primitive:"points"})}))(t),f.frame((()=>{e&&d&&e.triggerRepaint()}))},render(e,t){x=t,d=c.getZoom(),g.render({uMatrix:x,pointSize:o(d)})}},"place_suburb")},I,k,C,z,M,()=>z("lad"),()=>z("msoa"),()=>M("from"),()=>M("to"),(e,t)=>({category:`Works in ${v[b[e][`to${t}cd`]].areanm}`,value:b[e][`to${t}`],color:1}),(e,t)=>({category:`Lives in ${v[b[e][`from${t}cd`]].areanm}`,value:b[e][`from${t}`],color:1}),function(){A=this.checked,r(10,A)},()=>M(),()=>C("from"),()=>C("to"),function(e){h=e,r(3,h)},function(e){c=e,r(1,c)}]}return new class extends ae{constructor(e){super(),ne(this,e,zr,Cr,o,{},null,[-1,-1])}}({target:document.body})}();
//# sourceMappingURL=bundle.js.map
